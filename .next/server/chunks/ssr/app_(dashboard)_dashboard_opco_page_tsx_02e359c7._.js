module.exports=[367269,a=>{"use strict";var b=a.i(187924),c=a.i(433217),d=a.i(370025),e=a.i(937927),f=a.i(913216),g=a.i(269240);let h=new class{supabase;constructor(a){this.supabase=a||(0,g.createClient)()}async getConfigurations(a){let{data:b,error:c}=await this.supabase.from("opco_configurations").select("*").eq("organization_id",a).order("opco_name",{ascending:!0});if(c){if("PGRST116"===c.code||"42P01"===c.code||"PGRST301"===c.code||404===c.status||"404"===c.code||c.message?.includes("relation")||c.message?.includes("relationship")||c.message?.includes("does not exist")||c.message?.includes("schema cache"))return console.warn("Table opco_configurations does not exist yet or invalid query:",c?.message),[];throw c}return b||[]}async upsertConfiguration(a){let{data:b,error:c}=await this.supabase.from("opco_configurations").upsert(a,{onConflict:"organization_id,opco_code"}).select().single();if(c)throw c;return b}async getConventions(a,b){let c=this.supabase.from("opco_conventions").select("*").eq("organization_id",a);b?.opcoConfigId&&(c=c.eq("opco_config_id",b.opcoConfigId)),b?.status&&(c=c.eq("status",b.status));let{data:d,error:e}=await c.order("start_date",{ascending:!1});if(e){if("PGRST116"===e.code||"42P01"===e.code||"PGRST301"===e.code||404===e.status||"404"===e.code||e.message?.includes("relation")||e.message?.includes("relationship")||e.message?.includes("does not exist")||e.message?.includes("schema cache"))return console.warn("Table opco_conventions does not exist yet or invalid query:",e?.message),[];throw e}return d||[]}async createConvention(a){a.convention_number||(a.convention_number=`CONV-${Date.now()}-${Math.random().toString(36).substr(2,9).toUpperCase()}`),a.max_funding_amount&&(a.remaining_funding_amount=a.max_funding_amount-(a.used_funding_amount||0));let{data:b,error:c}=await this.supabase.from("opco_conventions").insert(a).select().single();if(c)throw c;return b}async getDeclarations(a,b){let c=this.supabase.from("opco_declarations").select("*").eq("organization_id",a);b?.opcoConfigId&&(c=c.eq("opco_config_id",b.opcoConfigId)),b?.conventionId&&(c=c.eq("convention_id",b.conventionId)),b?.status&&(c=c.eq("status",b.status)),b?.periodStart&&(c=c.gte("declaration_period_end",b.periodStart)),b?.periodEnd&&(c=c.lte("declaration_period_start",b.periodEnd));let{data:d,error:e}=await c.order("declaration_date",{ascending:!1});if(e){if("PGRST116"===e.code||"42P01"===e.code||"PGRST301"===e.code||404===e.status||"404"===e.code||e.message?.includes("relation")||e.message?.includes("relationship")||e.message?.includes("does not exist")||e.message?.includes("schema cache"))return console.warn("Table opco_declarations does not exist yet or invalid query:",e?.message),[];throw e}return d||[]}async createDeclaration(a){let{data:b,error:c}=await this.supabase.from("opco_declarations").insert(a).select().single();if(c)throw c;return b}async submitDeclaration(a){let{error:b}=await this.supabase.from("opco_declarations").update({status:"submitted",submission_date:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("id",a);if(b)throw b}async getDeclarationLines(a){let{data:b,error:c}=await this.supabase.from("opco_declaration_lines").select("*").eq("declaration_id",a).order("start_date",{ascending:!0});if(c)throw c;return b||[]}async addDeclarationLine(a){let{data:b,error:c}=await this.supabase.from("opco_declaration_lines").insert(a).select().single();if(c)throw c;return await this.updateDeclarationTotals(a.declaration_id),b}async updateDeclarationTotals(a){let b=(await this.getDeclarationLines(a)).reduce((a,b)=>({total_trainees:a.total_trainees+1,total_hours:a.total_hours+b.total_hours,total_amount:a.total_amount+b.total_price,requested_funding:a.requested_funding+b.funding_amount}),{total_trainees:0,total_hours:0,total_amount:0,requested_funding:0}),{error:c}=await this.supabase.from("opco_declarations").update({total_trainees:b.total_trainees,total_hours:b.total_hours,total_amount:b.total_amount,requested_funding:b.requested_funding,updated_at:new Date().toISOString()}).eq("id",a);if(c)throw c}async getFundingRequests(a,b){let c=this.supabase.from("opco_funding_requests").select("*").eq("organization_id",a);b?.opcoConfigId&&(c=c.eq("opco_config_id",b.opcoConfigId)),b?.status&&(c=c.eq("status",b.status));let{data:d,error:e}=await c.order("created_at",{ascending:!1});if(e){if("PGRST116"===e.code||"42P01"===e.code||"PGRST301"===e.code||404===e.status||"404"===e.code||e.message?.includes("relation")||e.message?.includes("relationship")||e.message?.includes("does not exist")||e.message?.includes("schema cache"))return console.warn("Table opco_funding_requests does not exist yet or invalid query:",e?.message),[];throw e}return d||[]}async createFundingRequest(a){a.request_number||(a.request_number=`REQ-${Date.now()}-${Math.random().toString(36).substr(2,9).toUpperCase()}`);let{data:b,error:c}=await this.supabase.from("opco_funding_requests").insert(a).select().single();if(c)throw c;return b}async generateActivityDeclaration(a,b,c,d){let e={organization_id:a,opco_config_id:b,declaration_type:"activity",declaration_period_start:c,declaration_period_end:d,declaration_date:new Date().toISOString().split("T")[0],status:"draft",total_trainees:0,total_hours:0,total_amount:0,requested_funding:0,approved_funding:0,paid_funding:0,created_by:(await this.supabase.auth.getUser()).data.user?.id||""};return this.createDeclaration(e)}};var i=a.i(703130),j=a.i(340695),k=a.i(254161),l=a.i(621958),m=a.i(864037),n=a.i(267900),o=a.i(641710),p=a.i(100336),q=a.i(669520),r=a.i(915618),s=a.i(104720),t=a.i(724669),u=a.i(692759),v=a.i(238246),w=a.i(497895);let x={draft:"bg-gray-100 text-gray-800",submitted:"bg-blue-100 text-blue-800",validated:"bg-green-100 text-green-800",rejected:"bg-red-100 text-red-800",paid:"bg-green-100 text-green-800",cancelled:"bg-gray-100 text-gray-800",pending:"bg-yellow-100 text-yellow-800",active:"bg-green-100 text-green-800",suspended:"bg-orange-100 text-orange-800",terminated:"bg-red-100 text-red-800",approved:"bg-green-100 text-green-800",under_review:"bg-yellow-100 text-yellow-800"};function y(){let{user:a}=(0,f.useAuth)(),g=(0,e.useQueryClient)(),{addToast:y}=(0,m.useToast)(),{data:z=[],isLoading:A}=(0,c.useQuery)({queryKey:["opco-conventions",a?.organization_id],queryFn:async()=>{try{return await h.getConventions(a.organization_id)}catch(a){if(a?.code==="PGRST116"||a?.code==="42P01"||a?.code==="PGRST301"||a?.status===404||a?.code==="404"||a?.message?.includes("relation")||a?.message?.includes("relationship")||a?.message?.includes("does not exist")||a?.message?.includes("schema cache"))return[];throw a}},enabled:!!a?.organization_id,retry:!1}),{data:B=[],isLoading:C}=(0,c.useQuery)({queryKey:["opco-declarations",a?.organization_id],queryFn:async()=>{try{return await h.getDeclarations(a.organization_id)}catch(a){if(a?.code==="PGRST116"||a?.code==="42P01"||a?.code==="PGRST301"||a?.status===404||a?.code==="404"||a?.message?.includes("relation")||a?.message?.includes("relationship")||a?.message?.includes("does not exist")||a?.message?.includes("schema cache"))return[];throw a}},enabled:!!a?.organization_id,retry:!1}),{data:D=[],isLoading:E}=(0,c.useQuery)({queryKey:["opco-funding-requests",a?.organization_id],queryFn:async()=>{try{return await h.getFundingRequests(a.organization_id)}catch(a){if(a?.code==="PGRST116"||a?.code==="42P01"||a?.code==="PGRST301"||a?.status===404||a?.code==="404"||a?.message?.includes("relation")||a?.message?.includes("relationship")||a?.message?.includes("does not exist")||a?.message?.includes("schema cache"))return[];throw a}},enabled:!!a?.organization_id,retry:!1}),F={totalConventions:z.length,activeConventions:z.filter(a=>"active"===a.status).length,totalDeclarations:B.length,pendingDeclarations:B.filter(a=>"draft"===a.status||"submitted"===a.status).length,totalFundingRequests:D.length,pendingRequests:D.filter(a=>"draft"===a.status||"submitted"===a.status).length,totalRequestedFunding:B.reduce((a,b)=>a+b.requested_funding,0)+D.reduce((a,b)=>a+b.requested_amount,0),totalPaidFunding:B.reduce((a,b)=>a+b.paid_funding,0)+D.reduce((a,b)=>a+b.paid_amount,0)},G=(0,d.useMutation)({mutationFn:a=>h.submitDeclaration(a),onSuccess:()=>{g.invalidateQueries({queryKey:["opco-declarations"]}),y({title:"Déclaration soumise",description:"La déclaration a été soumise à l'OPCO avec succès.",type:"success"})}});return A||C||E?(0,b.jsx)("div",{className:"container mx-auto py-8 px-4",children:(0,b.jsx)("div",{className:"flex items-center justify-center h-64",children:(0,b.jsx)(q.RefreshCw,{className:"h-8 w-8 animate-spin text-brand-blue"})})}):(0,b.jsxs)("div",{className:"container mx-auto py-8 px-4 max-w-7xl",children:[(0,b.jsxs)("div",{className:"mb-8",children:[(0,b.jsxs)("h1",{className:"text-3xl font-bold mb-2 flex items-center gap-2",children:[(0,b.jsx)(n.Building2,{className:"h-8 w-8 text-brand-blue"}),"OPCO (Opérateurs de Compétences)"]}),(0,b.jsx)("p",{className:"text-muted-foreground",children:"Gérez vos conventions, déclarations et demandes de financement OPCO"})]}),(0,b.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4 mb-8",children:[(0,b.jsx)(i.Card,{children:(0,b.jsx)(i.CardContent,{className:"pt-6",children:(0,b.jsxs)("div",{className:"flex items-center justify-between",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("p",{className:"text-sm text-muted-foreground",children:"Conventions actives"}),(0,b.jsx)("p",{className:"text-2xl font-bold",children:F.activeConventions})]}),(0,b.jsx)(s.FileText,{className:"h-8 w-8 text-blue-500"})]})})}),(0,b.jsx)(i.Card,{children:(0,b.jsx)(i.CardContent,{className:"pt-6",children:(0,b.jsxs)("div",{className:"flex items-center justify-between",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("p",{className:"text-sm text-muted-foreground",children:"Déclarations en attente"}),(0,b.jsx)("p",{className:"text-2xl font-bold",children:F.pendingDeclarations})]}),(0,b.jsx)(o.Clock,{className:"h-8 w-8 text-yellow-500"})]})})}),(0,b.jsx)(i.Card,{children:(0,b.jsx)(i.CardContent,{className:"pt-6",children:(0,b.jsxs)("div",{className:"flex items-center justify-between",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("p",{className:"text-sm text-muted-foreground",children:"Financement demandé"}),(0,b.jsx)("p",{className:"text-2xl font-bold",children:(0,w.formatCurrency)(F.totalRequestedFunding)})]}),(0,b.jsx)(t.TrendingUp,{className:"h-8 w-8 text-green-500"})]})})}),(0,b.jsx)(i.Card,{children:(0,b.jsx)(i.CardContent,{className:"pt-6",children:(0,b.jsxs)("div",{className:"flex items-center justify-between",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("p",{className:"text-sm text-muted-foreground",children:"Financement reçu"}),(0,b.jsx)("p",{className:"text-2xl font-bold",children:(0,w.formatCurrency)(F.totalPaidFunding)})]}),(0,b.jsx)(p.Euro,{className:"h-8 w-8 text-green-500"})]})})})]}),(0,b.jsxs)(l.Tabs,{defaultValue:"declarations",className:"space-y-6",children:[(0,b.jsxs)(l.TabsList,{children:[(0,b.jsx)(l.TabsTrigger,{value:"declarations",children:"Déclarations"}),(0,b.jsx)(l.TabsTrigger,{value:"conventions",children:"Conventions"}),(0,b.jsx)(l.TabsTrigger,{value:"funding",children:"Demandes de financement"})]}),(0,b.jsx)(l.TabsContent,{value:"declarations",children:(0,b.jsxs)(i.Card,{children:[(0,b.jsx)(i.CardHeader,{children:(0,b.jsxs)("div",{className:"flex items-center justify-between",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)(i.CardTitle,{children:"Déclarations OPCO"}),(0,b.jsx)(i.CardDescription,{children:"Déclarations d'activité et demandes de financement"})]}),(0,b.jsx)(j.Button,{asChild:!0,children:(0,b.jsxs)(v.default,{href:"/dashboard/opco/declarations/new",children:[(0,b.jsx)(r.Plus,{className:"h-4 w-4 mr-2"}),"Nouvelle déclaration"]})})]})}),(0,b.jsx)(i.CardContent,{children:0===B.length?(0,b.jsxs)("div",{className:"text-center py-12",children:[(0,b.jsx)(s.FileText,{className:"h-12 w-12 mx-auto text-muted-foreground mb-4"}),(0,b.jsx)("p",{className:"text-muted-foreground mb-4",children:"Aucune déclaration OPCO enregistrée"}),(0,b.jsx)(j.Button,{asChild:!0,children:(0,b.jsxs)(v.default,{href:"/dashboard/opco/declarations/new",children:[(0,b.jsx)(r.Plus,{className:"h-4 w-4 mr-2"}),"Créer une déclaration"]})})]}):(0,b.jsx)("div",{className:"space-y-4",children:B.map(a=>(0,b.jsx)(i.Card,{className:"hover:shadow-md transition-shadow",children:(0,b.jsx)(i.CardContent,{className:"pt-6",children:(0,b.jsxs)("div",{className:"flex items-start justify-between",children:[(0,b.jsxs)("div",{className:"flex-1",children:[(0,b.jsxs)("div",{className:"flex items-center gap-2 mb-2",children:[(0,b.jsxs)("h3",{className:"text-lg font-semibold",children:["Déclaration ",a.declaration_type.replace(/_/g," ")]}),(0,b.jsx)(k.Badge,{className:x[a.status],children:a.status.replace(/_/g," ")})]}),(0,b.jsxs)("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm mb-3",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("p",{className:"text-muted-foreground",children:"Période"}),(0,b.jsxs)("p",{className:"font-medium",children:[(0,w.formatDate)(a.declaration_period_start)," - ",(0,w.formatDate)(a.declaration_period_end)]})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("p",{className:"text-muted-foreground",children:"Stagiaires"}),(0,b.jsx)("p",{className:"font-medium",children:a.total_trainees})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("p",{className:"text-muted-foreground",children:"Heures"}),(0,b.jsxs)("p",{className:"font-medium",children:[a.total_hours,"h"]})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("p",{className:"text-muted-foreground",children:"Financement demandé"}),(0,b.jsx)("p",{className:"font-medium",children:(0,w.formatCurrency)(a.requested_funding)})]})]}),a.opco_reference&&(0,b.jsxs)("p",{className:"text-sm text-muted-foreground",children:["Référence OPCO: ",a.opco_reference]})]}),(0,b.jsxs)("div",{className:"flex gap-2",children:["draft"===a.status&&(0,b.jsxs)(j.Button,{size:"sm",onClick:()=>G.mutate(a.id),disabled:G.isPending,children:[(0,b.jsx)(u.Send,{className:"h-4 w-4 mr-2"}),"Soumettre"]}),(0,b.jsx)(j.Button,{variant:"outline",size:"sm",asChild:!0,children:(0,b.jsx)(v.default,{href:`/dashboard/opco/declarations/${a.id}`,children:"Voir les détails"})})]})]})})},a.id))})})]})}),(0,b.jsx)(l.TabsContent,{value:"conventions",children:(0,b.jsxs)(i.Card,{children:[(0,b.jsx)(i.CardHeader,{children:(0,b.jsxs)("div",{className:"flex items-center justify-between",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)(i.CardTitle,{children:"Conventions OPCO"}),(0,b.jsx)(i.CardDescription,{children:"Conventions signées avec les opérateurs de compétences"})]}),(0,b.jsx)(j.Button,{asChild:!0,children:(0,b.jsxs)(v.default,{href:"/dashboard/opco/conventions/new",children:[(0,b.jsx)(r.Plus,{className:"h-4 w-4 mr-2"}),"Nouvelle convention"]})})]})}),(0,b.jsx)(i.CardContent,{children:0===z.length?(0,b.jsxs)("div",{className:"text-center py-12",children:[(0,b.jsx)(s.FileText,{className:"h-12 w-12 mx-auto text-muted-foreground mb-4"}),(0,b.jsx)("p",{className:"text-muted-foreground mb-4",children:"Aucune convention OPCO enregistrée"}),(0,b.jsx)(j.Button,{asChild:!0,children:(0,b.jsxs)(v.default,{href:"/dashboard/opco/conventions/new",children:[(0,b.jsx)(r.Plus,{className:"h-4 w-4 mr-2"}),"Créer une convention"]})})]}):(0,b.jsx)("div",{className:"space-y-4",children:z.map(a=>(0,b.jsx)(i.Card,{className:"hover:shadow-md transition-shadow",children:(0,b.jsx)(i.CardContent,{className:"pt-6",children:(0,b.jsxs)("div",{className:"flex items-start justify-between",children:[(0,b.jsxs)("div",{className:"flex-1",children:[(0,b.jsxs)("div",{className:"flex items-center gap-2 mb-2",children:[(0,b.jsx)("h3",{className:"text-lg font-semibold",children:a.convention_number}),(0,b.jsx)(k.Badge,{className:x[a.status],children:a.status})]}),(0,b.jsxs)("p",{className:"text-sm text-muted-foreground mb-3",children:["Type: ",a.convention_type.replace(/_/g," ")," | Période: ",(0,w.formatDate)(a.start_date)," - ",a.end_date?(0,w.formatDate)(a.end_date):"En cours"]}),(0,b.jsxs)("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4 text-sm",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("p",{className:"text-muted-foreground",children:"Taux de financement"}),(0,b.jsxs)("p",{className:"font-medium",children:[a.funding_rate,"%"]})]}),a.max_funding_amount&&(0,b.jsxs)(b.Fragment,{children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("p",{className:"text-muted-foreground",children:"Montant max"}),(0,b.jsx)("p",{className:"font-medium",children:(0,w.formatCurrency)(a.max_funding_amount)})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("p",{className:"text-muted-foreground",children:"Restant"}),(0,b.jsx)("p",{className:"font-medium",children:(0,w.formatCurrency)(a.remaining_funding_amount||0)})]})]})]})]}),(0,b.jsx)(j.Button,{variant:"outline",asChild:!0,children:(0,b.jsx)(v.default,{href:`/dashboard/opco/conventions/${a.id}`,children:"Voir les détails"})})]})})},a.id))})})]})}),(0,b.jsx)(l.TabsContent,{value:"funding",children:(0,b.jsxs)(i.Card,{children:[(0,b.jsx)(i.CardHeader,{children:(0,b.jsxs)("div",{className:"flex items-center justify-between",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)(i.CardTitle,{children:"Demandes de financement"}),(0,b.jsx)(i.CardDescription,{children:"Demandes de financement auprès des OPCO"})]}),(0,b.jsx)(j.Button,{asChild:!0,children:(0,b.jsxs)(v.default,{href:"/dashboard/opco/funding/new",children:[(0,b.jsx)(r.Plus,{className:"h-4 w-4 mr-2"}),"Nouvelle demande"]})})]})}),(0,b.jsx)(i.CardContent,{children:0===D.length?(0,b.jsxs)("div",{className:"text-center py-12",children:[(0,b.jsx)(t.TrendingUp,{className:"h-12 w-12 mx-auto text-muted-foreground mb-4"}),(0,b.jsx)("p",{className:"text-muted-foreground mb-4",children:"Aucune demande de financement enregistrée"}),(0,b.jsx)(j.Button,{asChild:!0,children:(0,b.jsxs)(v.default,{href:"/dashboard/opco/funding/new",children:[(0,b.jsx)(r.Plus,{className:"h-4 w-4 mr-2"}),"Créer une demande"]})})]}):(0,b.jsx)("div",{className:"space-y-4",children:D.map(a=>(0,b.jsx)(i.Card,{className:"hover:shadow-md transition-shadow",children:(0,b.jsx)(i.CardContent,{className:"pt-6",children:(0,b.jsxs)("div",{className:"flex items-start justify-between",children:[(0,b.jsxs)("div",{className:"flex-1",children:[(0,b.jsxs)("div",{className:"flex items-center gap-2 mb-2",children:[(0,b.jsx)("h3",{className:"text-lg font-semibold",children:a.title}),(0,b.jsx)(k.Badge,{className:x[a.status],children:a.status.replace(/_/g," ")})]}),(0,b.jsx)("p",{className:"text-sm text-muted-foreground mb-3",children:a.description}),(0,b.jsxs)("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4 text-sm",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("p",{className:"text-muted-foreground",children:"Montant demandé"}),(0,b.jsx)("p",{className:"font-medium",children:(0,w.formatCurrency)(a.requested_amount)})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("p",{className:"text-muted-foreground",children:"Montant approuvé"}),(0,b.jsx)("p",{className:"font-medium",children:(0,w.formatCurrency)(a.approved_amount)})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("p",{className:"text-muted-foreground",children:"Montant payé"}),(0,b.jsx)("p",{className:"font-medium",children:(0,w.formatCurrency)(a.paid_amount)})]})]}),a.request_number&&(0,b.jsxs)("p",{className:"text-sm text-muted-foreground mt-2",children:["N° demande: ",a.request_number]})]}),(0,b.jsx)(j.Button,{variant:"outline",asChild:!0,children:(0,b.jsx)(v.default,{href:`/dashboard/opco/funding/${a.id}`,children:"Voir les détails"})})]})})},a.id))})})]})})]}),(0,b.jsxs)("div",{className:"mt-8 flex gap-4",children:[(0,b.jsx)(j.Button,{variant:"outline",asChild:!0,children:(0,b.jsxs)(v.default,{href:"/dashboard/opco/configuration",children:[(0,b.jsx)(n.Building2,{className:"h-4 w-4 mr-2"}),"Configuration OPCO"]})}),(0,b.jsx)(j.Button,{variant:"outline",asChild:!0,children:(0,b.jsxs)(v.default,{href:"/dashboard/opco/reports",children:[(0,b.jsx)(s.FileText,{className:"h-4 w-4 mr-2"}),"Rapports"]})})]})]})}a.s(["default",()=>y],367269)}];

//# sourceMappingURL=app_%28dashboard%29_dashboard_opco_page_tsx_02e359c7._.js.map