module.exports=[42787,a=>{"use strict";var b=a.i(187924),c=a.i(572131),d=a.i(50944),e=a.i(433217),f=a.i(370025),g=a.i(937927),h=a.i(269240),i=a.i(426099),j=a.i(913216),k=a.i(340695),l=a.i(703130),m=a.i(400210),n=a.i(915618),o=a.i(941675),p=a.i(641710),q=a.i(124987),r=a.i(660246),s=a.i(633508),t=a.i(717371),u=a.i(238246),v=a.i(497895);function w(){let a=(0,d.useParams)();(0,d.useRouter)();let w=a.id,x=(0,h.createClient)(),y=(0,g.useQueryClient)(),{user:z}=(0,j.useAuth)(),[A,B]=(0,c.useState)(!1),[C,D]=(0,c.useState)(null),[E,F]=(0,c.useState)({student_id:"",enrollment_date:new Date().toISOString().split("T")[0],status:"confirmed",payment_status:"pending",total_amount:"",paid_amount:"0"}),{data:G}=(0,e.useQuery)({queryKey:["program",w],queryFn:()=>i.programService.getProgramById(w)}),{data:H,isLoading:I,refetch:J}=(0,e.useQuery)({queryKey:["program-sessions",w],queryFn:async()=>{let{data:a}=await x.from("formations").select("id").eq("program_id",w);if(!a||0===a.length)return[];let b=a.map(a=>a.id),{data:c,error:d}=await x.from("sessions").select("*, formations(*, programs(*))").in("formation_id",b).order("start_date",{ascending:!1});if(d)throw d;return c||[]}}),{data:K}=(0,e.useQuery)({queryKey:["teachers"],queryFn:async()=>{let{data:a,error:b}=await x.from("users").select("id, full_name").eq("role","teacher").eq("is_active",!0);if(b)throw b;return a||[]}}),{data:L}=(0,e.useQuery)({queryKey:["students",z?.organization_id],queryFn:async()=>{if(!z?.organization_id)return[];let{data:a,error:b}=await x.from("students").select("id, first_name, last_name, student_number, email").eq("organization_id",z.organization_id).eq("status","active").order("last_name",{ascending:!0});if(b)throw b;return a||[]},enabled:!!z?.organization_id}),{data:M}=(0,e.useQuery)({queryKey:["enrollments-for-session",C],queryFn:async()=>{if(!C)return[];let{data:a,error:b}=await x.from("enrollments").select("student_id").eq("session_id",C);if(b)throw b;return a||[]},enabled:!!C&&A}),N=L?.filter(a=>!M?.some(b=>b.student_id===a.id))||[],[O,P]=(0,c.useState)(!1),[Q,R]=(0,c.useState)({name:"",start_date:"",end_date:"",start_time:"",end_time:"",teacher_id:"",location:"",capacity_max:""}),S=(0,f.useMutation)({mutationFn:async()=>{throw Error("Cette fonctionnalité doit être utilisée via /dashboard/formations/[id]/sessions")},onSuccess:()=>{P(!1),R({name:"",start_date:"",end_date:"",start_time:"",end_time:"",teacher_id:"",location:"",capacity_max:""}),y.invalidateQueries({queryKey:["program-sessions",w]}),J()},onError:a=>{console.error("Erreur lors de la création de la session:",a)}}),T=(0,f.useMutation)({mutationFn:async()=>{if(!C||!E.student_id)throw Error("Veuillez sélectionner un élève");console.log("Création d'inscription:",{student_id:E.student_id,session_id:C,enrollment_date:E.enrollment_date,status:E.status,payment_status:E.payment_status,total_amount:parseFloat(E.total_amount)||0,paid_amount:parseFloat(E.paid_amount)||0});try{let{data:a,error:b}=await x.from("enrollments").select("id, status, payment_status").eq("student_id",E.student_id).eq("session_id",C).maybeSingle();if(b&&"PGRST116"!==b.code&&console.error("Erreur lors de la vérification de l'inscription:",b),a)throw Error(`Cet \xe9l\xe8ve est d\xe9j\xe0 inscrit \xe0 cette session. (Statut: ${a.status}, Paiement: ${a.payment_status})`);let{data:c,error:d}=await x.from("enrollments").insert({student_id:E.student_id,session_id:C,enrollment_date:E.enrollment_date,status:E.status,payment_status:E.payment_status,total_amount:parseFloat(E.total_amount)||0,paid_amount:parseFloat(E.paid_amount)||0}).select().single();if(d){if("23505"===d.code)throw Error("Cet élève est déjà inscrit à cette session. Veuillez vérifier les inscriptions existantes.");throw console.error("Erreur lors de la création de l'inscription:",{code:d.code,message:d.message,details:d.details,hint:d.hint}),d}return console.log("Inscription créée avec succès:",c),c}catch(a){throw console.error("Erreur dans createEnrollmentMutation:",a),a}},onSuccess:()=>{y.invalidateQueries({queryKey:["program-sessions",w]}),y.invalidateQueries({queryKey:["enrollments-for-session",C]}),y.invalidateQueries({queryKey:["session-enrollments",C]}),y.invalidateQueries({queryKey:["program-enrollments",w]}),J(),B(!1),D(null),F({student_id:"",enrollment_date:new Date().toISOString().split("T")[0],status:"confirmed",payment_status:"pending",total_amount:G?.price?.toString()||"0",paid_amount:"0"})}});return(0,b.jsxs)("div",{className:"space-y-6",children:[(0,b.jsxs)("div",{className:"flex items-center justify-between",children:[(0,b.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,b.jsx)(u.default,{href:`/dashboard/programs/${w}`,children:(0,b.jsx)(k.Button,{variant:"ghost",size:"icon",children:(0,b.jsx)(m.ArrowLeft,{className:"h-4 w-4"})})}),(0,b.jsxs)("div",{children:[(0,b.jsxs)("h1",{className:"text-3xl font-bold text-gray-900",children:["Sessions - ",G?.name]}),(0,b.jsx)("p",{className:"mt-2 text-sm text-gray-600",children:"Gérez les sessions de cette formation"})]})]}),(0,b.jsxs)(k.Button,{onClick:()=>P(!O),children:[(0,b.jsx)(n.Plus,{className:"mr-2 h-4 w-4"}),"Nouvelle session"]})]}),O&&(0,b.jsxs)(l.Card,{children:[(0,b.jsx)(l.CardHeader,{children:(0,b.jsx)(l.CardTitle,{children:"Nouvelle session"})}),(0,b.jsx)(l.CardContent,{children:(0,b.jsxs)("form",{onSubmit:a=>{a.preventDefault(),S.mutate()},className:"space-y-4",children:[(0,b.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Nom de la session *"}),(0,b.jsx)("input",{type:"text",required:!0,value:Q.name,onChange:a=>R({...Q,name:a.target.value}),className:"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target",placeholder:"Ex: Session 1 - Janvier 2024"})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Lieu/Salle"}),(0,b.jsx)("input",{type:"text",value:Q.location,onChange:a=>R({...Q,location:a.target.value}),className:"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target",placeholder:"Ex: Salle A1"})]})]}),(0,b.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Date de début *"}),(0,b.jsx)("input",{type:"date",required:!0,value:Q.start_date,onChange:a=>R({...Q,start_date:a.target.value}),className:"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target"})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Date de fin *"}),(0,b.jsx)("input",{type:"date",required:!0,value:Q.end_date,onChange:a=>R({...Q,end_date:a.target.value}),className:"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target"})]})]}),(0,b.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Heure de début"}),(0,b.jsx)("input",{type:"time",value:Q.start_time,onChange:a=>R({...Q,start_time:a.target.value}),className:"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target"})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Heure de fin"}),(0,b.jsx)("input",{type:"time",value:Q.end_time,onChange:a=>R({...Q,end_time:a.target.value}),className:"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target"})]})]}),(0,b.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Enseignant"}),(0,b.jsxs)("select",{value:Q.teacher_id,onChange:a=>R({...Q,teacher_id:a.target.value}),className:"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target",children:[(0,b.jsx)("option",{value:"",children:"Sélectionner un enseignant"}),K?.map(a=>(0,b.jsx)("option",{value:a.id,children:a.full_name},a.id))]})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Capacité maximale"}),(0,b.jsx)("input",{type:"number",value:Q.capacity_max,onChange:a=>R({...Q,capacity_max:a.target.value}),className:"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target"})]})]}),S.error&&(0,b.jsxs)("div",{className:"bg-destructive/10 text-destructive px-4 py-3 rounded-lg text-sm space-y-1",children:[(0,b.jsx)("p",{className:"font-semibold",children:"Erreur lors de la création de la session :"}),(0,b.jsx)("p",{children:S.error instanceof Error?S.error.message:"Une erreur est survenue lors de la création de la session"}),S.error&&"code"in S.error&&(0,b.jsxs)("p",{className:"text-xs opacity-75",children:["Code d'erreur: ",String(S.error.code)]})]}),(0,b.jsxs)("div",{className:"flex justify-end space-x-4",children:[(0,b.jsx)(k.Button,{type:"button",variant:"outline",onClick:()=>P(!1),children:"Annuler"}),(0,b.jsx)(k.Button,{type:"submit",disabled:S.isPending,children:S.isPending?"Création...":"Créer la session"})]})]})})]}),A&&C&&(0,b.jsxs)(l.Card,{children:[(0,b.jsx)(l.CardHeader,{children:(0,b.jsxs)("div",{className:"flex items-center justify-between",children:[(0,b.jsx)(l.CardTitle,{children:"Inscrire un élève à la session"}),(0,b.jsx)(k.Button,{variant:"ghost",size:"icon",onClick:()=>B(!1),children:(0,b.jsx)(s.X,{className:"h-4 w-4"})})]})}),(0,b.jsx)(l.CardContent,{children:(0,b.jsxs)("form",{onSubmit:a=>{a.preventDefault(),T.mutate()},className:"space-y-6",children:[(0,b.jsxs)("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4",children:[(0,b.jsxs)("p",{className:"text-sm text-blue-800",children:[(0,b.jsx)("strong",{children:"Session:"})," ",H?.find(a=>a.id===C)?.name]}),(0,b.jsx)("p",{className:"text-sm text-blue-700 mt-1",children:H?.find(a=>a.id===C)&&(0,b.jsxs)(b.Fragment,{children:[(0,v.formatDate)(H.find(a=>a.id===C).start_date)," -"," ",(0,v.formatDate)(H.find(a=>a.id===C).end_date)]})})]}),(0,b.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Élève *"}),(0,b.jsxs)("select",{required:!0,value:E.student_id,onChange:a=>F({...E,student_id:a.target.value}),className:"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target",children:[(0,b.jsx)("option",{value:"",children:"Sélectionner un élève"}),N.length>0?N.map(a=>(0,b.jsxs)("option",{value:a.id,children:[a.first_name," ",a.last_name," (",a.student_number,")"]},a.id)):(0,b.jsx)("option",{value:"",disabled:!0,children:"Aucun élève disponible (tous déjà inscrits ou aucun élève actif)"})]})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Date d'inscription *"}),(0,b.jsx)("input",{type:"date",required:!0,value:E.enrollment_date,onChange:a=>F({...E,enrollment_date:a.target.value}),className:"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target"})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Statut *"}),(0,b.jsxs)("select",{required:!0,value:E.status,onChange:a=>F({...E,status:a.target.value}),className:"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target",children:[(0,b.jsx)("option",{value:"pending",children:"En attente"}),(0,b.jsx)("option",{value:"confirmed",children:"Confirmée"}),(0,b.jsx)("option",{value:"completed",children:"Terminée"}),(0,b.jsx)("option",{value:"cancelled",children:"Annulée"}),(0,b.jsx)("option",{value:"failed",children:"Échouée"})]})]}),G&&(0,b.jsxs)("div",{children:[(0,b.jsxs)("label",{className:"block text-sm font-medium mb-2",children:["Montant total (",G.currency||"XOF",") *"]}),(0,b.jsx)("input",{type:"number",required:!0,step:"0.01",min:"0",value:E.total_amount,onChange:a=>F({...E,total_amount:a.target.value}),className:"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target"})]}),G&&(0,b.jsxs)("div",{children:[(0,b.jsxs)("label",{className:"block text-sm font-medium mb-2",children:["Montant payé (",G.currency||"XOF",")"]}),(0,b.jsx)("input",{type:"number",step:"0.01",min:"0",value:E.paid_amount,onChange:a=>{let b=a.target.value,c=parseFloat(E.total_amount)||0,d=parseFloat(b)||0,e="pending";d>=c&&c>0?e="paid":d>0&&(e="partial"),F({...E,paid_amount:b,payment_status:e})},className:"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target"})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Statut de paiement"}),(0,b.jsxs)("select",{value:E.payment_status,onChange:a=>F({...E,payment_status:a.target.value}),className:"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target",children:[(0,b.jsx)("option",{value:"pending",children:"En attente"}),(0,b.jsx)("option",{value:"partial",children:"Partiel"}),(0,b.jsx)("option",{value:"paid",children:"Payé"}),(0,b.jsx)("option",{value:"overdue",children:"En retard"})]})]})]}),T.error&&(0,b.jsxs)("div",{className:"bg-destructive/10 text-destructive px-4 py-3 rounded-lg text-sm space-y-1",children:[(0,b.jsx)("p",{className:"font-semibold",children:"Erreur lors de la création de l'inscription :"}),(0,b.jsx)("p",{children:T.error instanceof Error?T.error.message:"Une erreur est survenue lors de la création de l'inscription"}),T.error&&"code"in T.error&&(0,b.jsxs)("p",{className:"text-xs opacity-75",children:["Code d'erreur: ",String(T.error.code),"42501"===T.error.code&&(0,b.jsxs)("span",{className:"block mt-1",children:["Erreur de sécurité RLS. Assurez-vous d'avoir exécuté le script ",(0,b.jsx)("code",{className:"bg-gray-200 px-1 rounded",children:"supabase/fix_enrollments_rls.sql"})," dans le SQL Editor de Supabase."]}),"23505"===T.error.code&&(0,b.jsx)("span",{className:"block mt-1",children:"❌ Cette inscription existe déjà. Un élève ne peut être inscrit qu'une seule fois à une session."})]})]}),(0,b.jsxs)("div",{className:"flex justify-end space-x-4",children:[(0,b.jsx)(k.Button,{type:"button",variant:"outline",onClick:()=>B(!1),children:"Annuler"}),(0,b.jsx)(k.Button,{type:"submit",disabled:T.isPending,children:T.isPending?"Inscription...":"Inscrire l'élève"})]})]})})]}),(0,b.jsxs)(l.Card,{children:[(0,b.jsx)(l.CardHeader,{children:(0,b.jsx)(l.CardTitle,{children:"Liste des sessions"})}),(0,b.jsx)(l.CardContent,{children:I?(0,b.jsx)("div",{className:"text-center py-12 text-muted-foreground",children:"Chargement..."}):H&&H.length>0?(0,b.jsx)("div",{className:"space-y-4",children:H.map(a=>(0,b.jsx)("div",{className:"p-4 border rounded-lg hover:bg-gray-50 transition-colors",children:(0,b.jsxs)("div",{className:"flex items-start justify-between",children:[(0,b.jsxs)("div",{className:"flex-1",children:[(0,b.jsx)("h3",{className:"font-semibold text-lg",children:a.name}),(0,b.jsxs)("div",{className:"mt-2 grid grid-cols-1 md:grid-cols-3 gap-4 text-sm text-muted-foreground",children:[(0,b.jsxs)("div",{className:"flex items-center",children:[(0,b.jsx)(o.Calendar,{className:"mr-2 h-4 w-4"}),(0,v.formatDate)(a.start_date)," - ",(0,v.formatDate)(a.end_date)]}),a.start_time&&a.end_time&&(0,b.jsxs)("div",{className:"flex items-center",children:[(0,b.jsx)(p.Clock,{className:"mr-2 h-4 w-4"}),a.start_time," - ",a.end_time]}),a.location&&(0,b.jsxs)("div",{className:"flex items-center",children:[(0,b.jsx)(q.MapPin,{className:"mr-2 h-4 w-4"}),a.location]})]}),a.capacity_max&&(0,b.jsxs)("div",{className:"mt-2 flex items-center text-sm text-muted-foreground",children:[(0,b.jsx)(r.Users,{className:"mr-2 h-4 w-4"}),"Capacité: ",a.capacity_max," apprenants"]})]}),(0,b.jsxs)("div",{className:"flex flex-col items-end space-y-2",children:[(0,b.jsx)("span",{className:`px-2 py-1 rounded text-xs ${(a=>{switch(a){case"planned":return"bg-blue-100 text-blue-800";case"ongoing":return"bg-success-bg text-success-primary";case"completed":default:return"bg-gray-100 text-gray-800";case"cancelled":return"bg-red-100 text-red-800"}})(a.status)}`,children:(a=>{switch(a){case"planned":return"Planifiée";case"ongoing":return"En cours";case"completed":return"Terminée";case"cancelled":return"Annulée";default:return a}})(a.status)}),(0,b.jsxs)("div",{className:"flex space-x-2",children:[(0,b.jsxs)(k.Button,{variant:"outline",size:"sm",onClick:()=>{var b;return b=a.id,void(H?.find(a=>a.id===b),D(b),F({student_id:"",enrollment_date:new Date().toISOString().split("T")[0],status:"confirmed",payment_status:"pending",total_amount:G?.formations?.[0]?.price?.toString()||"0",paid_amount:"0"}),B(!0))},children:[(0,b.jsx)(t.UserPlus,{className:"mr-1 h-3 w-3"}),"Inscrire élève"]}),(0,b.jsx)(u.default,{href:`/dashboard/programs/${w}/sessions/${a.id}`,children:(0,b.jsx)(k.Button,{variant:"outline",size:"sm",children:"Voir détails"})})]})]})]})},a.id))}):(0,b.jsx)("div",{className:"text-center py-12 text-muted-foreground",children:"Aucune session créée. Créez-en une pour commencer."})})]})]})}a.s(["default",()=>w])}];

//# sourceMappingURL=app_%28dashboard%29_dashboard_programs_%5Bid%5D_sessions_page_tsx_881165a5._.js.map