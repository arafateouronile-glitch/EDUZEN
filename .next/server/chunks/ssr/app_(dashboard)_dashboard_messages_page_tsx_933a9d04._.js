module.exports=[513989,a=>{"use strict";var b=a.i(187924),c=a.i(572131),d=a.i(50944),e=a.i(433217),f=a.i(370025),g=a.i(937927),h=a.i(913216),i=a.i(805781),j=a.i(269240),k=a.i(703130),l=a.i(205522),m=a.i(340695),n=a.i(965733),o=a.i(587532),p=a.i(563588),q=a.i(660246),r=a.i(915618),s=a.i(436265),t=a.i(526017),u=a.i(781560),v=a.i(238246),w=a.i(497895),x=a.i(864037),y=a.i(676504);function z(){let a=(0,d.useRouter)(),{user:z}=(0,h.useAuth)(),A=(0,j.createClient)(),B=(0,g.useQueryClient)(),{addToast:C}=(0,x.useToast)(),[D,E]=(0,c.useState)(""),[F,G]=(0,c.useState)(!1),[H,I]=(0,c.useState)(""),[J,K]=(0,c.useState)("personal"),[L,M]=(0,c.useState)(""),[N,O]=(0,c.useState)(""),{data:P}=(0,e.useQuery)({queryKey:["conversations",z?.id,z?.organization_id],queryFn:()=>i.messagingService.getConversations(z?.id||"",z?.organization_id||""),enabled:!!z?.id&&!!z?.organization_id}),Q=(0,f.useMutation)({mutationFn:async a=>i.messagingService.deleteConversation(a),onSuccess:()=>{B.invalidateQueries({queryKey:["conversations"]}),C({type:"success",title:"Conversation supprimée",description:"La conversation a été supprimée avec succès."})},onError:a=>{C({type:"error",title:"Erreur",description:"Impossible de supprimer la conversation. Veuillez réessayer."})}}),{data:R,isLoading:S}=(0,e.useQuery)({queryKey:["sessions-for-messages",z?.organization_id],queryFn:async()=>{if(!z?.organization_id)return[];let{data:a,error:b}=await A.from("sessions").select("id, name, start_date, end_date, formations(name)").eq("organization_id",z.organization_id).order("start_date",{ascending:!1}).limit(100);if(b)throw b;return a||[]},enabled:!!z?.organization_id&&F}),{data:T,isLoading:U}=(0,e.useQuery)({queryKey:["session-students",L],queryFn:async()=>{if(!L)return[];let{data:a,error:b}=await A.from("enrollments").select(`
          student_id,
          status,
          students!inner(id, first_name, last_name, student_number, email)
        `).eq("session_id",L);if(b)throw console.error("Erreur récupération inscriptions:",b),b;if(!a||0===a.length)return[];let c=a.filter(a=>{let b=a.status;return"cancelled"!==b&&"rejected"!==b&&"dropped"!==b});return 0===c.length?[]:c.map(a=>({student:a.students,user:null,enrollmentId:a.student_id}))},enabled:!!L&&"personal"===J}),{data:V,isLoading:W}=(0,e.useQuery)({queryKey:["organization-users",z?.organization_id],queryFn:async()=>{if(!z?.organization_id)return[];let{data:a,error:b}=await A.from("users").select("id, full_name, email, avatar_url, role").eq("organization_id",z.organization_id).neq("id",z.id).order("full_name");if(b)throw b;return a||[]},enabled:!!z?.organization_id&&F&&"personal"===J&&!L}),X=(0,f.useMutation)({mutationFn:async({userId:a,studentId:b})=>{if(!z?.id||!z?.organization_id)throw Error("Utilisateur non authentifié");if(!a&&!b)throw Error("Either userId or studentId must be provided");try{return await i.messagingService.createDirectConversation(z.id,a||null,z.organization_id,b||null)}catch(a){throw a}},onSuccess:b=>{B.invalidateQueries({queryKey:["conversations"]}),G(!1),Z(),b?.id&&a.push(`/dashboard/messages/${b.id}`),C({type:"success",title:"Conversation créée",description:"La conversation a été créée avec succès."})},onError:a=>{C({type:"error",title:"Erreur",description:a instanceof Error?a.message:"Une erreur est survenue lors de la création de la conversation."})}}),Y=(0,f.useMutation)({mutationFn:async()=>{if(!z?.id||!z?.organization_id)throw Error("Utilisateur non authentifié");if(!L)throw Error("Veuillez sélectionner une session");let{data:a,error:b}=await A.from("enrollments").select(`
          student_id,
          status,
          students!inner(id, email)
        `).eq("session_id",L);if(b)throw b;let c=(a||[]).filter(a=>{let b=a.status;return"cancelled"!==b&&"rejected"!==b&&"dropped"!==b}).map(a=>a.students?.id).filter(a=>a),d=[];if(c.length>0){let{data:a,error:b}=await A.from("users").select("id").in("id",c).eq("organization_id",z.organization_id);!b&&a&&(d=a.map(a=>a.id).filter(a=>a!==z.id))}let e=c.filter(a=>!d.includes(a)&&a!==z.id),f=[z.id,...d],g=R?.find(a=>a.id===L),h=g?`Session: ${g.name}`:"Groupe de session";return i.messagingService.createGroupConversation(h,f,z.organization_id,z.id,e)},onSuccess:b=>{B.invalidateQueries({queryKey:["conversations"]}),G(!1),Z(),b?.id&&a.push(`/dashboard/messages/${b.id}`),C({type:"success",title:"Conversation de groupe créée",description:"La conversation de groupe a été créée avec succès."})},onError:a=>{C({type:"error",title:"Erreur",description:a instanceof Error?a.message:"Une erreur est survenue lors de la création de la conversation de groupe."})}}),Z=()=>{I(""),K("personal"),M(""),O("")};V?.filter(a=>{if(!H)return!0;let b=H.toLowerCase();return a.full_name?.toLowerCase().includes(b)||a.email?.toLowerCase().includes(b)});let $=a=>{if("group"===a.conversation_type&&a.name)return a.name;if(a.participants){let b=a.participants.find(a=>a.user_id!==z?.id);if(b?.user)return b.user.full_name||b.user.email||"Conversation";if(b?.student)return`${b.student.first_name||""} ${b.student.last_name||""}`.trim()||b.student.email||`Candidat ${b.student.student_number||""}`||"Conversation"}return"Conversation"},_=P?.filter(a=>!D||$(a).toLowerCase().includes(D.toLowerCase()));return(0,b.jsxs)("div",{className:"container mx-auto py-8 px-4 max-w-7xl",children:[(0,b.jsxs)("div",{className:"mb-8",children:[(0,b.jsxs)("div",{className:"flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6 mb-6",children:[(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsxs)("div",{className:"inline-flex items-center gap-3 mb-2",children:[(0,b.jsx)("div",{className:"p-2.5 bg-gradient-to-br from-brand-blue to-brand-cyan rounded-xl shadow-lg",children:(0,b.jsx)(p.MessageSquare,{className:"h-7 w-7 text-white"})}),(0,b.jsx)("h1",{className:"text-3xl lg:text-4xl font-bold bg-gradient-to-r from-brand-blue to-brand-cyan bg-clip-text text-transparent",children:"Messages"})]}),(0,b.jsx)("p",{className:"text-gray-600 text-sm lg:text-base ml-1",children:"Communiquez avec vos collègues et candidats"})]}),(0,b.jsxs)(m.Button,{onClick:()=>G(!0),className:"bg-gradient-to-r from-brand-blue to-brand-cyan hover:from-brand-blue-dark hover:to-brand-cyan shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105",children:[(0,b.jsx)(r.Plus,{className:"h-4 w-4 mr-2"}),"Nouvelle conversation"]})]}),(0,b.jsx)(k.Card,{className:"border-brand-blue/20 bg-gradient-to-br from-brand-blue-ghost/30 to-brand-cyan-ghost/30 backdrop-blur-sm shadow-sm hover:shadow-md transition-all duration-300",children:(0,b.jsx)(k.CardContent,{className:"pt-6",children:(0,b.jsxs)("div",{className:"relative",children:[(0,b.jsx)(o.Search,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-brand-blue"}),(0,b.jsx)(l.Input,{type:"text",placeholder:"Rechercher une conversation...",value:D,onChange:a=>E(a.target.value),className:"pl-10 border-brand-blue/20 focus:border-brand-blue focus:ring-brand-blue"})]})})})]}),(0,b.jsx)("div",{className:"space-y-3",children:_&&_.length>0?_.map(a=>{let c=$(a),d=(a=>{if(a.avatar_url)return a.avatar_url;if("direct"===a.conversation_type&&a.participants){let b=a.participants.find(a=>a.user_id!==z?.id);if(b?.user)return b.user.avatar_url}return null})(a),e=Array.isArray(a.last_message)?a.last_message[0]:a.last_message;return(0,b.jsx)("div",{children:(0,b.jsx)(k.Card,{className:"group border-brand-blue/10 hover:border-brand-blue/30 hover:shadow-lg transition-all duration-300 hover:scale-[1.02] cursor-pointer bg-gradient-to-br from-white to-brand-blue-ghost/20",children:(0,b.jsx)(k.CardContent,{className:"p-5",children:(0,b.jsxs)("div",{className:"flex items-center gap-4",children:[(0,b.jsxs)(v.default,{href:`/dashboard/messages/${a.id}`,className:"flex-1 flex items-center gap-4",children:[(0,b.jsxs)("div",{className:"flex-shrink-0 relative",children:[d?(0,b.jsx)("img",{src:d,alt:c,className:"h-14 w-14 rounded-full object-cover ring-2 ring-brand-blue/20 group-hover:ring-brand-blue/40 transition-all"}):(0,b.jsx)("div",{className:"h-14 w-14 rounded-full bg-gradient-to-br from-brand-blue-ghost to-brand-cyan-ghost flex items-center justify-center ring-2 ring-brand-blue/20 group-hover:ring-brand-blue/40 transition-all",children:"group"===a.conversation_type?(0,b.jsx)(q.Users,{className:"h-7 w-7 text-brand-blue"}):(0,b.jsx)(p.MessageSquare,{className:"h-7 w-7 text-brand-cyan"})}),false]}),(0,b.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,b.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,b.jsx)("h3",{className:"font-semibold text-gray-900 truncate text-lg group-hover:text-brand-blue transition-colors",children:c}),a.last_message_at&&(0,b.jsx)("span",{className:"text-xs text-gray-500 flex-shrink-0 ml-2 font-medium",children:(0,w.formatRelativeTime)(a.last_message_at)})]}),e&&(0,b.jsx)("div",{className:"flex items-center gap-2",children:(0,b.jsxs)("p",{className:"text-sm text-gray-600 truncate",children:[(0,b.jsx)("span",{className:"font-medium text-gray-700",children:e.sender?.full_name||e.sender?.email||(e.student_sender?`${e.student_sender.first_name||""} ${e.student_sender.last_name||""}`.trim()||e.student_sender.email||`Candidat ${e.student_sender.student_number||""}`:"Expéditeur")}),":"," ",e.content]})}),"group"===a.conversation_type&&a.participants&&(0,b.jsxs)("div",{className:"flex items-center gap-1.5 mt-1.5",children:[(0,b.jsx)(q.Users,{className:"h-3.5 w-3.5 text-brand-cyan"}),(0,b.jsxs)("p",{className:"text-xs text-gray-500 font-medium",children:[a.participants.length," participants"]})]})]})]}),(0,b.jsx)("div",{className:"flex-shrink-0",onClick:a=>a.stopPropagation(),children:(0,b.jsxs)(y.DropdownMenu,{children:[(0,b.jsx)(y.DropdownMenuTrigger,{asChild:!0,children:(0,b.jsx)(m.Button,{variant:"ghost",size:"icon",className:"hover:bg-brand-blue-ghost",onClick:a=>a.stopPropagation(),children:(0,b.jsx)(s.MoreVertical,{className:"h-4 w-4"})})}),(0,b.jsx)(y.DropdownMenuContent,{align:"end",children:(0,b.jsxs)(y.DropdownMenuItem,{onClick:b=>{b.preventDefault(),b.stopPropagation(),confirm("Êtes-vous sûr de vouloir supprimer cette conversation ?")&&Q.mutate(a.id)},disabled:Q.isPending,className:"text-destructive focus:text-destructive",children:[(0,b.jsx)(u.Trash2,{className:"mr-2 h-4 w-4"}),"Supprimer"]})})]})})]})})})},a.id)}):(0,b.jsx)(k.Card,{className:"border-brand-blue/20 bg-gradient-to-br from-brand-blue-ghost/30 to-brand-cyan-ghost/30",children:(0,b.jsx)(k.CardContent,{className:"py-16",children:(0,b.jsxs)("div",{className:"text-center space-y-4",children:[(0,b.jsxs)("div",{className:"relative inline-block",children:[(0,b.jsx)("div",{className:"absolute inset-0 flex items-center justify-center",children:(0,b.jsx)("div",{className:"w-24 h-24 bg-gradient-to-br from-brand-blue-ghost to-brand-cyan-ghost rounded-full opacity-50 blur-2xl"})}),(0,b.jsx)("div",{className:"relative p-6 bg-gradient-to-br from-brand-blue-ghost to-brand-cyan-ghost rounded-2xl inline-block",children:(0,b.jsx)(p.MessageSquare,{className:"h-16 w-16 mx-auto text-brand-blue"})})]}),(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)("h3",{className:"text-xl font-semibold text-gray-900",children:D?"Aucune conversation trouvée":"Aucune conversation"}),(0,b.jsx)("p",{className:"text-gray-600",children:D?"Essayez de modifier votre recherche":"Commencez une nouvelle conversation pour échanger avec vos collègues et candidats"})]}),!D&&(0,b.jsxs)(m.Button,{onClick:()=>G(!0),className:"mt-4 bg-gradient-to-r from-brand-blue to-brand-cyan hover:from-brand-blue-dark hover:to-brand-cyan shadow-md hover:shadow-lg transition-all",children:[(0,b.jsx)(r.Plus,{className:"h-4 w-4 mr-2"}),"Créer une conversation"]})]})})})}),(0,b.jsx)(n.Dialog,{open:F,onOpenChange:a=>{G(a),a||Z()},children:(0,b.jsxs)(n.DialogContent,{className:"sm:max-w-[600px]",children:[(0,b.jsxs)(n.DialogHeader,{children:[(0,b.jsx)(n.DialogTitle,{children:"Nouvelle conversation"}),(0,b.jsx)(n.DialogDescription,{children:"Choisissez le type de conversation que vous souhaitez créer"})]}),(0,b.jsxs)("div",{className:"space-y-4 mt-4",children:[(0,b.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,b.jsxs)("button",{type:"button",onClick:()=>{K("personal"),M(""),O("")},className:`group p-5 border-2 rounded-xl transition-all duration-300 ${"personal"===J?"border-brand-blue bg-gradient-to-br from-brand-blue-ghost to-brand-blue-ghost/50 shadow-md scale-105":"border-gray-200 hover:border-brand-blue/40 hover:bg-brand-blue-ghost/30"}`,children:[(0,b.jsx)("div",{className:`p-2.5 rounded-lg mb-3 inline-flex ${"personal"===J?"bg-brand-blue/20":"bg-brand-blue/10 group-hover:bg-brand-blue/20"}`,children:(0,b.jsx)(p.MessageSquare,{className:"h-6 w-6 text-brand-blue"})}),(0,b.jsx)("h3",{className:"font-semibold mb-1 text-gray-900",children:"Message personnel"}),(0,b.jsx)("p",{className:"text-sm text-gray-600",children:"Envoyer un message à un candidat spécifique"})]}),(0,b.jsxs)("button",{type:"button",onClick:()=>{K("group"),O("")},className:`group p-5 border-2 rounded-xl transition-all duration-300 ${"group"===J?"border-brand-cyan bg-gradient-to-br from-brand-cyan-ghost to-brand-cyan-ghost/50 shadow-md scale-105":"border-gray-200 hover:border-brand-cyan/40 hover:bg-brand-cyan-ghost/30"}`,children:[(0,b.jsx)("div",{className:`p-2.5 rounded-lg mb-3 inline-flex ${"group"===J?"bg-brand-cyan/20":"bg-brand-cyan/10 group-hover:bg-brand-cyan/20"}`,children:(0,b.jsx)(q.Users,{className:"h-6 w-6 text-brand-cyan"})}),(0,b.jsx)("h3",{className:"font-semibold mb-1 text-gray-900",children:"Message groupé"}),(0,b.jsx)("p",{className:"text-sm text-gray-600",children:"Envoyer un message à tous les candidats d'une session"})]})]}),(0,b.jsxs)("div",{children:[(0,b.jsxs)("label",{className:"block text-sm font-medium mb-2",children:["Session ","group"===J?"*":"(optionnel)"]}),S?(0,b.jsx)("div",{className:"flex items-center justify-center py-4",children:(0,b.jsx)(t.Loader2,{className:"h-5 w-5 animate-spin text-muted-foreground"})}):(0,b.jsxs)("select",{value:L,onChange:a=>{M(a.target.value),O("")},required:"group"===J,className:"w-full px-4 py-2 rounded-lg border focus:ring-2 focus:ring-brand-blue focus:border-transparent",children:[(0,b.jsx)("option",{value:"",children:"Sélectionner une session"}),R?.map(a=>(0,b.jsxs)("option",{value:a.id,children:[a.name," ",a.formations?.name?`- ${a.formations.name}`:""]},a.id))]})]}),"personal"===J&&L&&(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Candidat *"}),U?(0,b.jsx)("div",{className:"flex items-center justify-center py-4",children:(0,b.jsx)(t.Loader2,{className:"h-5 w-5 animate-spin text-muted-foreground"})}):T&&T.length>0?(0,b.jsx)("div",{className:"max-h-[300px] overflow-y-auto space-y-2 border rounded-lg p-2",children:T.map(a=>{let c=a.student,d=`${c?.first_name||""} ${c?.last_name||""}`.trim()||c?.email||`Candidat ${c?.student_number||""}`,e=c?.email;return(0,b.jsxs)("button",{type:"button",onClick:()=>{let a=c?.id||null;a?X.mutate({userId:void 0,studentId:a}):C({type:"error",title:"Erreur",description:"Impossible de trouver l'identifiant de ce candidat."})},disabled:X.isPending||!c?.id,className:"group w-full flex items-center gap-3 p-3 rounded-xl transition-all duration-300 text-left hover:bg-gradient-to-br hover:from-brand-blue-ghost hover:to-brand-cyan-ghost cursor-pointer border border-transparent hover:border-brand-blue/20 hover:shadow-md",title:"Cliquer pour démarrer une conversation",children:[(0,b.jsx)("div",{className:"h-10 w-10 rounded-full bg-gradient-to-br from-brand-blue-ghost to-brand-cyan-ghost flex items-center justify-center group-hover:scale-110 transition-transform",children:(0,b.jsx)(q.Users,{className:"h-5 w-5 text-brand-blue"})}),(0,b.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,b.jsx)("p",{className:"font-medium truncate text-gray-900 group-hover:text-brand-blue transition-colors",children:d}),e&&(0,b.jsx)("p",{className:"text-sm text-gray-600 truncate",children:e}),c?.student_number&&(0,b.jsxs)("p",{className:"text-xs text-gray-500",children:["N°: ",c.student_number]})]}),X.isPending&&(0,b.jsx)(t.Loader2,{className:"h-4 w-4 animate-spin text-brand-blue"})]},c?.id)})}):(0,b.jsx)("div",{className:"text-center py-4 text-muted-foreground text-sm",children:"Aucun candidat trouvé dans cette session"})]}),"group"===J&&L&&(0,b.jsx)("div",{className:"flex justify-end",children:(0,b.jsx)(m.Button,{onClick:()=>Y.mutate(),disabled:Y.isPending||!L,className:"bg-gradient-to-r from-brand-cyan to-brand-blue hover:from-brand-cyan-dark hover:to-brand-blue-dark shadow-md hover:shadow-lg transition-all",children:Y.isPending?(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(t.Loader2,{className:"mr-2 h-4 w-4 animate-spin"}),"Création..."]}):(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(q.Users,{className:"mr-2 h-4 w-4"}),"Créer la conversation de groupe"]})})}),"personal"===J&&!L&&(0,b.jsxs)(b.Fragment,{children:[(0,b.jsxs)("div",{className:"relative",children:[(0,b.jsx)(o.Search,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),(0,b.jsx)(l.Input,{type:"text",placeholder:"Rechercher un utilisateur...",value:H,onChange:a=>I(a.target.value),className:"pl-10"})]}),(0,b.jsx)("div",{className:"max-h-[300px] overflow-y-auto space-y-2",children:W?(0,b.jsx)("div",{className:"flex items-center justify-center py-8",children:(0,b.jsx)(t.Loader2,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):V&&V.length>0?V.filter(a=>{if(!H)return!0;let b=H.toLowerCase();return a.full_name?.toLowerCase().includes(b)||a.email?.toLowerCase().includes(b)}).map(a=>(0,b.jsxs)("button",{onClick:()=>X.mutate(a.id),disabled:X.isPending,className:"group w-full flex items-center gap-3 p-3 rounded-xl hover:bg-gradient-to-br hover:from-brand-blue-ghost hover:to-brand-cyan-ghost transition-all duration-300 text-left border border-transparent hover:border-brand-blue/20 hover:shadow-md",children:[a.avatar_url?(0,b.jsx)("img",{src:a.avatar_url,alt:a.full_name||a.email,className:"h-10 w-10 rounded-full object-cover ring-2 ring-brand-blue/20 group-hover:ring-brand-blue/40 transition-all"}):(0,b.jsx)("div",{className:"h-10 w-10 rounded-full bg-gradient-to-br from-brand-blue-ghost to-brand-cyan-ghost flex items-center justify-center group-hover:scale-110 transition-transform",children:(0,b.jsx)(q.Users,{className:"h-5 w-5 text-brand-blue"})}),(0,b.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,b.jsx)("p",{className:"font-medium truncate text-gray-900 group-hover:text-brand-blue transition-colors",children:a.full_name||a.email}),a.full_name&&(0,b.jsx)("p",{className:"text-sm text-gray-600 truncate",children:a.email}),a.role&&(0,b.jsx)("p",{className:"text-xs text-gray-500 capitalize",children:a.role})]}),X.isPending&&(0,b.jsx)(t.Loader2,{className:"h-4 w-4 animate-spin text-brand-blue"})]},a.id)):(0,b.jsx)("div",{className:"text-center py-8 text-muted-foreground",children:H?"Aucun utilisateur trouvé":"Aucun utilisateur disponible"})})]})]})]})})]})}a.s(["default",()=>z])}];

//# sourceMappingURL=app_%28dashboard%29_dashboard_messages_page_tsx_933a9d04._.js.map