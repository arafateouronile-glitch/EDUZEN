module.exports=[284505,a=>{"use strict";let b=(0,a.i(170106).default)("Download",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"7 10 12 15 17 10",key:"2ggqvy"}],["line",{x1:"12",x2:"12",y1:"15",y2:"3",key:"1vk2je"}]]);a.s(["Download",()=>b],284505)},177156,a=>{"use strict";let b=(0,a.i(170106).default)("Eye",[["path",{d:"M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z",key:"rwhkz3"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]]);a.s(["Eye",()=>b],177156)},429629,a=>{"use strict";var b=a.i(187924),c=a.i(433217),d=a.i(913216),e=a.i(269240),f=a.i(703130),g=a.i(340695),h=a.i(104720),i=a.i(284505),j=a.i(177156),k=a.i(941675),l=a.i(497895),m=a.i(572131),n=a.i(325383);function o(){let{user:a}=(0,d.useAuth)(),o=(0,e.createClient)(),[p,q]=(0,m.useState)(null),{data:r,isLoading:s}=(0,c.useQuery)({queryKey:["learner-documents",a?.id],queryFn:async()=>{if(!a?.id)return n.logger.info("Portal Documents - No user ID"),[];n.logger.info("Portal Documents - Fetching documents",{userId:(0,n.maskId)(a.id),role:a.role});let b=[];if(a?.role==="parent"){let{data:c}=await o.from("guardians").select("id").eq("user_id",a.id);if(!c||0===c.length)return n.logger.info("Portal Documents - No guardians found"),[];let{data:d}=await o.from("student_guardians").select("student_id").in("guardian_id",c.map(a=>a.id));if(!d||0===d.length)return n.logger.info("Portal Documents - No student guardians found"),[];b=d.map(a=>a.student_id).filter(a=>null!==a),n.logger.info("Portal Documents - Parent student IDs count",{count:b.length})}else a?.role==="student"&&(b=[a.id],n.logger.info("Portal Documents - Student access"));if(0===b.length)return n.logger.info("Portal Documents - No student IDs"),[];let c=o.from("learner_documents").select("*, students(first_name, last_name, student_number)").order("sent_at",{ascending:!1});a?.role==="parent"&&(c=c.in("student_id",b)),n.logger.info("Portal Documents - Querying learner_documents");let{data:d,error:e}=await c;if(e)throw n.logger.error("Portal Documents - Error fetching documents",e,{error:(0,n.sanitizeError)(e)}),e;return n.logger.info("Portal Documents - Documents found",{count:d?.length||0}),d||[]},enabled:!!a?.id}),t=async a=>{let{error:b}=await o.from("learner_documents").update({viewed_at:new Date().toISOString()}).eq("id",a);b&&n.logger.error("Portal Documents - Error marking as viewed",b,{documentId:(0,n.maskId)(a),error:(0,n.sanitizeError)(b)})},u=async a=>{let{error:b}=await o.from("learner_documents").update({downloaded_at:new Date().toISOString()}).eq("id",a);b&&n.logger.error("Portal Documents - Error marking as downloaded",b,{documentId:(0,n.maskId)(a),error:(0,n.sanitizeError)(b)})},v=async a=>{try{let b=await fetch(a.file_url),c=await b.blob(),d=window.URL.createObjectURL(c),e=document.createElement("a");e.href=d,e.download=a.title||"document.pdf",document.body.appendChild(e),e.click(),document.body.removeChild(e),window.URL.revokeObjectURL(d),await u(a.id)}catch(b){n.logger.error("Portal Documents - Error downloading document",b,{documentId:(0,n.maskId)(a.id),error:(0,n.sanitizeError)(b)}),alert("Erreur lors du téléchargement du document")}},w=async a=>{q(a.file_url),window.open(a.file_url,"_blank"),await t(a.id)};return s?(0,b.jsxs)("div",{className:"space-y-6",children:[(0,b.jsx)("div",{className:"flex items-center justify-between",children:(0,b.jsx)("h1",{className:"text-3xl font-bold",children:"Documents"})}),(0,b.jsx)(f.Card,{children:(0,b.jsx)(f.CardContent,{className:"p-6",children:(0,b.jsx)("p",{className:"text-center text-muted-foreground",children:"Chargement..."})})})]}):(0,b.jsxs)("div",{className:"space-y-6",children:[(0,b.jsx)("div",{className:"flex items-center justify-between",children:(0,b.jsx)("h1",{className:"text-3xl font-bold",children:"Documents"})}),r&&r.length>0?(0,b.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:r.map(a=>{var c;return(0,b.jsxs)(f.Card,{className:"hover:shadow-lg transition-shadow",children:[(0,b.jsx)(f.CardHeader,{children:(0,b.jsxs)("div",{className:"flex items-start justify-between",children:[(0,b.jsxs)("div",{className:"flex-1",children:[(0,b.jsx)(f.CardTitle,{className:"text-lg mb-2",children:a.title}),(0,b.jsx)("p",{className:"text-sm text-muted-foreground",children:{convention:"Convention de formation",facture:"Facture",devis:"Devis",attestation:"Attestation",certificat:"Certificat",releve_notes:"Relevé de notes",autre:"Autre"}[(c=a.type)||"autre"]||c||"Document"})]}),(0,b.jsx)(h.FileText,{className:"h-5 w-5 text-primary flex-shrink-0 ml-2"})]})}),(0,b.jsx)(f.CardContent,{children:(0,b.jsxs)("div",{className:"space-y-3",children:[a.students&&(0,b.jsxs)("div",{className:"text-sm",children:[(0,b.jsx)("p",{className:"text-muted-foreground",children:"Apprenant"}),(0,b.jsxs)("p",{className:"font-medium",children:[a.students.first_name," ",a.students.last_name]})]}),(0,b.jsxs)("div",{className:"flex items-center text-sm text-muted-foreground",children:[(0,b.jsx)(k.Calendar,{className:"h-4 w-4 mr-2"}),(0,l.formatDate)(a.sent_at)]}),(0,b.jsxs)("div",{className:"flex gap-2 pt-2",children:[(0,b.jsxs)(g.Button,{variant:"outline",size:"sm",onClick:()=>w(a),className:"flex-1",children:[(0,b.jsx)(j.Eye,{className:"h-4 w-4 mr-2"}),"Voir"]}),(0,b.jsxs)(g.Button,{variant:"default",size:"sm",onClick:()=>v(a),className:"flex-1",children:[(0,b.jsx)(i.Download,{className:"h-4 w-4 mr-2"}),"Télécharger"]})]}),a.description&&(0,b.jsx)("p",{className:"text-sm text-muted-foreground mt-2",children:a.description})]})})]},a.id)})}):(0,b.jsx)(f.Card,{children:(0,b.jsxs)(f.CardContent,{className:"p-12 text-center",children:[(0,b.jsx)(h.FileText,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),(0,b.jsx)("h3",{className:"text-lg font-semibold mb-2",children:"Aucun document"}),(0,b.jsx)("p",{className:"text-muted-foreground",children:"Vous n'avez pas encore de documents disponibles."})]})})]})}a.s(["default",()=>o])}];

//# sourceMappingURL=_ed34a45f._.js.map