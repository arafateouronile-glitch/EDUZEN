module.exports=[641710,a=>{"use strict";let b=(0,a.i(170106).default)("Clock",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["polyline",{points:"12 6 12 12 16 14",key:"68esgv"}]]);a.s(["Clock",()=>b],641710)},992258,a=>{"use strict";let b=(0,a.i(170106).default)("Mail",[["rect",{width:"20",height:"16",x:"2",y:"4",rx:"2",key:"18n3k1"}],["path",{d:"m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7",key:"1ocrg3"}]]);a.s(["Mail",()=>b],992258)},325015,a=>{"use strict";let b=(0,a.i(170106).default)("Play",[["polygon",{points:"5 3 19 12 5 21 5 3",key:"191637"}]]);a.s(["Play",()=>b],325015)},792843,a=>{"use strict";var b=a.i(269240);let c=new class{supabase;constructor(a){this.supabase=a||(0,b.createClient)()}async getAll(a){let{data:b,error:c}=await this.supabase.from("email_templates").select("*").eq("organization_id",a).eq("is_active",!0).order("email_type",{ascending:!0}).order("is_default",{ascending:!1}).order("created_at",{ascending:!1});if(c)throw c;return b||[]}async getByType(a,b){let{data:c,error:d}=await this.supabase.from("email_templates").select("*").eq("organization_id",a).eq("email_type",b).eq("is_active",!0).order("is_default",{ascending:!1}).order("created_at",{ascending:!1});if(d)throw d;return c||[]}async getDefault(a,b){let{data:c,error:d}=await this.supabase.from("email_templates").select("*").eq("organization_id",a).eq("email_type",b).eq("is_default",!0).eq("is_active",!0).maybeSingle();if(d)throw d;return c}async getById(a){let{data:b,error:c}=await this.supabase.from("email_templates").select("*").eq("id",a).maybeSingle();if(c)throw c;return b}async create(a,b){a.is_default&&await this.unsetOtherDefaults(a.organization_id,a.email_type);let{data:c,error:d}=await this.supabase.from("email_templates").insert({...a,created_by:b,available_variables:a.available_variables||[]}).select().single();if(d)throw d;return c}async update(a,b){let c=await this.getById(a);if(!c)throw Error("Modèle non trouvé");b.is_default&&await this.unsetOtherDefaults(c.organization_id,c.email_type,a);let{data:d,error:e}=await this.supabase.from("email_templates").update(b).eq("id",a).select().single();if(e)throw e;return d}async delete(a){let{error:b}=await this.supabase.from("email_templates").update({is_active:!1}).eq("id",a);if(b)throw b}async deletePermanently(a){let{error:b}=await this.supabase.from("email_templates").delete().eq("id",a);if(b)throw b}async unsetOtherDefaults(a,b,c){let d=this.supabase.from("email_templates").update({is_default:!1}).eq("organization_id",a).eq("email_type",b).eq("is_default",!0);c&&(d=d.neq("id",c));let{error:e}=await d;if(e)throw e}replaceVariables(a,b){let c=a;for(let[a,d]of Object.entries(b)){let b=RegExp(`\\{${a}\\}`,"g");c=c.replace(b,d?.toString()||"")}return c}getEmailTypes(){return[{value:"document_generated",label:"Document généré",description:"Email envoyé lors de la génération d'un document",defaultVariables:["student_name","document_title","document_type","organization_name","document_url"]},{value:"invoice_sent",label:"Facture envoyée",description:"Email envoyé lors de l'envoi d'une facture",defaultVariables:["student_name","invoice_number","invoice_amount","due_date","organization_name","invoice_url"]},{value:"payment_reminder",label:"Rappel de paiement",description:"Email de rappel pour un paiement en attente",defaultVariables:["student_name","invoice_number","invoice_amount","due_date","days_overdue","organization_name"]},{value:"enrollment_confirmation",label:"Confirmation d'inscription",description:"Email de confirmation d'inscription à une session",defaultVariables:["student_name","session_name","session_start_date","session_location","organization_name"]},{value:"session_reminder",label:"Rappel de session",description:"Email de rappel avant une session",defaultVariables:["student_name","session_name","session_date","session_time","session_location","organization_name"]},{value:"certificate_issued",label:"Certificat délivré",description:"Email lors de la délivrance d'un certificat",defaultVariables:["student_name","certificate_name","certificate_date","organization_name","certificate_url"]},{value:"notification",label:"Notification générale",description:"Notification générale personnalisée",defaultVariables:["recipient_name","message","organization_name","action_url"]},{value:"custom",label:"Personnalisé",description:"Modèle d'email personnalisé",defaultVariables:[]}]}};a.s(["emailTemplateService",0,c])},308549,a=>{"use strict";let b=(0,a.i(170106).default)("Pause",[["rect",{width:"4",height:"16",x:"6",y:"4",key:"iffhe4"}],["rect",{width:"4",height:"16",x:"14",y:"4",key:"sjin7j"}]]);a.s(["Pause",()=>b],308549)},416117,a=>{"use strict";var b=a.i(269240);let c=new class{supabase;constructor(a){this.supabase=a||(0,b.createClient)()}async getAllSchedules(a,b){let c=this.supabase.from("email_schedules").select("*, email_templates(*)").eq("organization_id",a).order("created_at",{ascending:!1});b?.isActive!==void 0&&(c=c.eq("is_active",b.isActive)),b?.emailType&&(c=c.eq("email_type",b.emailType));let{data:d,error:e}=await c;if(e)throw e;return d||[]}async getScheduleById(a){let{data:b,error:c}=await this.supabase.from("email_schedules").select("*, email_templates(*)").eq("id",a).single();if(c)throw c;return b}async createSchedule(a,b){let{data:c}=await this.supabase.auth.getUser(),d={organization_id:a,name:b.name,email_type:b.email_type,trigger_type:b.trigger_type,target_type:b.target_type,is_active:b.is_active??!0,send_to_students:b.send_to_students??!0,send_to_teachers:b.send_to_teachers??!1,send_to_coordinators:b.send_to_coordinators??!1};void 0!==b.description&&(d.description=b.description||null),void 0!==b.template_id&&(d.template_id=b.template_id||null),void 0!==b.trigger_days&&(d.trigger_days=b.trigger_days??null),void 0!==b.trigger_time&&(d.trigger_time=b.trigger_time||null),void 0!==b.trigger_datetime&&(d.trigger_datetime=b.trigger_datetime||null),void 0!==b.session_status&&(d.session_status=b.session_status||null),void 0!==b.session_id&&(d.session_id=b.session_id||null),void 0!==b.formation_id&&(d.formation_id=b.formation_id||null),void 0!==b.program_id&&(d.program_id=b.program_id||null),void 0!==b.custom_variables&&(d.custom_variables=b.custom_variables||null),void 0!==b.send_document&&(d.send_document=b.send_document??!1),void 0!==b.document_type&&(d.document_type=b.document_type||null),void 0!==b.document_template_id&&(d.document_template_id=b.document_template_id||null),c?.user?.id&&(d.created_by=c.user.id);let{data:e,error:f}=await this.supabase.from("email_schedules").insert(d).select().single();if(f)throw console.error("Error creating email schedule:",f),f;return e}async updateSchedule(a,b){let c={name:b.name,description:b.description,email_type:b.email_type,template_id:b.template_id,trigger_type:b.trigger_type,trigger_days:b.trigger_days,trigger_time:b.trigger_time,trigger_datetime:b.trigger_datetime,target_type:b.target_type,session_status:b.session_status,formation_id:b.formation_id,program_id:b.program_id,is_active:b.is_active,send_to_students:b.send_to_students,send_to_teachers:b.send_to_teachers,send_to_coordinators:b.send_to_coordinators,custom_variables:b.custom_variables,send_document:b.send_document,document_type:b.document_type,document_template_id:b.document_template_id};Object.keys(c).forEach(a=>{void 0===c[a]&&delete c[a]});let{data:d,error:e}=await this.supabase.from("email_schedules").update(c).eq("id",a).select().single();if(e)throw e;return d}async deleteSchedule(a){let{error:b}=await this.supabase.from("email_schedules").delete().eq("id",a);if(b)throw b}async getActiveSchedulesToExecute(){let{data:a,error:b}=await this.supabase.from("email_schedules").select("*, email_templates(*), organizations(*)").eq("is_active",!0);if(b)throw b;return a||[]}async logExecution(a,b,c,d){let e={schedule_id:a,organization_id:b,status:c.status,total_recipients:c.totalRecipients,successful_sends:c.successfulSends,failed_sends:c.failedSends,error_message:c.errorMessage||null,error_details:c.errorDetails||null,trigger_context:d||null},{data:f,error:g}=await this.supabase.from("email_schedule_logs").insert(e).select().single();if(g)throw g;let{data:h}=await this.supabase.from("email_schedules").select("total_sent").eq("id",a).single(),i=(h?.total_sent||0)+c.successfulSends;return await this.supabase.from("email_schedules").update({last_run_at:new Date().toISOString(),last_run_status:c.status,last_run_error:c.errorMessage||null,total_sent:i}).eq("id",a),f}async getScheduleLogs(a,b=50){let{data:c,error:d}=await this.supabase.from("email_schedule_logs").select("*").eq("schedule_id",a).order("executed_at",{ascending:!1}).limit(b);if(d)throw d;return c||[]}};a.s(["emailScheduleService",0,c])},355709,a=>{"use strict";var b=a.i(187924),c=a.i(703130),d=a.i(340695),e=a.i(864037),f=a.i(992258),g=a.i(325015),h=a.i(308549),i=a.i(641710),j=a.i(941675),k=a.i(321161),l=a.i(797063),m=a.i(433217),n=a.i(370025),o=a.i(937927),p=a.i(913216),q=a.i(416117),r=a.i(792843),s=a.i(497895),t=a.i(238246);function u({sessionId:a,sessionData:i}){let{user:j}=(0,p.useAuth)(),s=(0,o.useQueryClient)(),{addToast:u}=(0,e.useToast)(),{data:w,isLoading:x}=(0,m.useQuery)({queryKey:["email-schedules",j?.organization_id,a],queryFn:async()=>{if(!j?.organization_id)throw Error("Organization ID manquant");return(await q.emailScheduleService.getAllSchedules(j.organization_id)).filter(b=>b.session_id===a||!b.session_id&&("session"===b.target_type||"all"===b.target_type))},enabled:!!j?.organization_id&&!!a}),{data:y}=(0,m.useQuery)({queryKey:["email-templates",j?.organization_id],queryFn:async()=>{if(!j?.organization_id)throw Error("Organization ID manquant");return r.emailTemplateService.getAll(j.organization_id)},enabled:!!j?.organization_id}),z=(0,n.useMutation)({mutationFn:async({id:a,isActive:b})=>q.emailScheduleService.updateSchedule(a,{is_active:b}),onSuccess:()=>{s.invalidateQueries({queryKey:["email-schedules"]}),u({title:"Règle mise à jour",description:"Le statut de la règle a été mis à jour.",type:"success"})},onError:a=>{u({title:"Erreur",description:a.message||"Erreur lors de la mise à jour de la règle.",type:"error"})}}),A=w?.filter(a=>a.is_active)||[],B=w?.filter(a=>!a.is_active)||[];return x?(0,b.jsx)(c.Card,{children:(0,b.jsx)(c.CardContent,{className:"py-12 text-center",children:(0,b.jsx)("p",{className:"text-gray-500",children:"Chargement des règles..."})})}):(0,b.jsxs)("div",{className:"space-y-6",children:[(0,b.jsxs)("div",{className:"flex items-center justify-between",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("h2",{className:"text-2xl font-bold text-gray-900",children:"Automatisation d'emails"}),(0,b.jsx)("p",{className:"text-gray-600 mt-1",children:"Activez ou désactivez les règles d'automatisation créées dans les paramètres"})]}),(0,b.jsx)(t.default,{href:"/dashboard/settings/email-schedules",children:(0,b.jsxs)(d.Button,{variant:"outline",className:"border-brand-blue text-brand-blue hover:bg-brand-blue hover:text-white",children:[(0,b.jsx)(k.Settings,{className:"h-4 w-4 mr-2"}),"Gérer les règles"]})})]}),(0,b.jsx)(c.Card,{className:"bg-blue-50 border-blue-200",children:(0,b.jsx)(c.CardContent,{className:"pt-6",children:(0,b.jsxs)("div",{className:"flex items-start gap-3",children:[(0,b.jsx)(l.Info,{className:"h-5 w-5 text-blue-600 mt-0.5"}),(0,b.jsxs)("div",{children:[(0,b.jsx)("p",{className:"text-sm text-blue-900 font-medium mb-1",children:"Gestion des règles d'automatisation"}),(0,b.jsx)("p",{className:"text-sm text-blue-800",children:"Cette page affiche les règles d'automatisation pertinentes pour cette session (règles spécifiques à cette session et règles générales). Les règles doivent être créées dans les paramètres de l'application. Depuis cette page, vous pouvez uniquement activer ou désactiver les règles existantes. Pour créer, modifier ou supprimer une règle, utilisez le bouton \"Gérer les règles\" ci-dessus."})]})]})})}),A.length>0&&(0,b.jsxs)("div",{children:[(0,b.jsxs)("h3",{className:"text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2",children:[(0,b.jsx)(g.Play,{className:"h-5 w-5 text-green-600"}),"Règles actives (",A.length,")"]}),(0,b.jsx)("div",{className:"grid gap-4",children:A.map(a=>{let c=y?.find(b=>b.id===a.template_id);return(0,b.jsx)(v,{schedule:a,template:c,onToggleActive:(a,b)=>{z.mutate({id:a,isActive:b})}},a.id)})})]}),B.length>0&&(0,b.jsxs)("div",{className:"mt-8",children:[(0,b.jsxs)("h3",{className:"text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2",children:[(0,b.jsx)(h.Pause,{className:"h-5 w-5 text-gray-400"}),"Règles inactives (",B.length,")"]}),(0,b.jsx)("div",{className:"grid gap-4",children:B.map(a=>{let c=y?.find(b=>b.id===a.template_id);return(0,b.jsx)(v,{schedule:a,template:c,onToggleActive:(a,b)=>{z.mutate({id:a,isActive:b})}},a.id)})})]}),(!w||0===w.length)&&(0,b.jsx)(c.Card,{children:(0,b.jsxs)(c.CardContent,{className:"py-12 text-center",children:[(0,b.jsx)(f.Mail,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),(0,b.jsx)("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Aucune règle d'automatisation"}),(0,b.jsx)("p",{className:"text-gray-600 mb-6",children:"Créez votre première règle dans les paramètres de l'application."}),(0,b.jsx)(t.default,{href:"/dashboard/settings/email-schedules",children:(0,b.jsxs)(d.Button,{className:"bg-brand-blue hover:bg-brand-blue/90",children:[(0,b.jsx)(k.Settings,{className:"h-4 w-4 mr-2"}),"Créer une règle"]})})]})})]})}function v({schedule:a,template:e,onToggleActive:l}){return(0,b.jsx)(c.Card,{className:(0,s.cn)(!a.is_active&&"opacity-60"),children:(0,b.jsx)(c.CardContent,{className:"p-6",children:(0,b.jsxs)("div",{className:"flex items-start justify-between",children:[(0,b.jsxs)("div",{className:"flex-1",children:[(0,b.jsxs)("div",{className:"flex items-center gap-3 mb-2",children:[(0,b.jsx)("h3",{className:"text-lg font-semibold text-gray-900",children:a.name}),a.is_active?(0,b.jsx)("span",{className:"px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full",children:"Active"}):(0,b.jsx)("span",{className:"px-2 py-1 text-xs font-medium bg-gray-100 text-gray-600 rounded-full",children:"Inactive"})]}),a.description&&(0,b.jsx)("p",{className:"text-gray-600 mb-4",children:a.description}),(0,b.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm",children:[(0,b.jsxs)("div",{className:"flex items-center gap-2 text-gray-600",children:[(0,b.jsx)(f.Mail,{className:"h-4 w-4"}),(0,b.jsxs)("span",{children:["Type: ",(0,b.jsx)("span",{className:"font-medium text-gray-900",children:a.email_type})]})]}),(0,b.jsxs)("div",{className:"flex items-center gap-2 text-gray-600",children:[(0,b.jsx)(i.Clock,{className:"h-4 w-4"}),(0,b.jsxs)("span",{children:["Déclencheur: ",(0,b.jsx)("span",{className:"font-medium text-gray-900",children:a.trigger_type})]})]}),null!==a.trigger_days&&void 0!==a.trigger_days&&(0,b.jsxs)("div",{className:"flex items-center gap-2 text-gray-600",children:[(0,b.jsx)(j.Calendar,{className:"h-4 w-4"}),(0,b.jsxs)("span",{children:[a.trigger_days>0?"+":"",a.trigger_days," jour(s)",a.trigger_time&&` \xe0 ${a.trigger_time}`]})]}),e&&(0,b.jsxs)("div",{className:"flex items-center gap-2 text-gray-600",children:[(0,b.jsx)(k.Settings,{className:"h-4 w-4"}),(0,b.jsxs)("span",{children:["Template: ",e.name]})]})]}),(0,b.jsxs)("div",{className:"mt-4 flex flex-wrap gap-2",children:[a.send_to_students&&(0,b.jsx)("span",{className:"px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded",children:"Étudiants"}),a.send_to_teachers&&(0,b.jsx)("span",{className:"px-2 py-1 text-xs bg-purple-100 text-purple-800 rounded",children:"Enseignants"}),a.send_to_coordinators&&(0,b.jsx)("span",{className:"px-2 py-1 text-xs bg-orange-100 text-orange-800 rounded",children:"Coordinateurs"})]})]}),(0,b.jsx)("div",{className:"flex items-center gap-2 ml-4",children:(0,b.jsx)(d.Button,{variant:"outline",size:"sm",onClick:()=>l(a.id,!a.is_active),title:a.is_active?"Désactiver":"Activer",children:a.is_active?(0,b.jsx)(h.Pause,{className:"h-4 w-4"}):(0,b.jsx)(g.Play,{className:"h-4 w-4"})})})]})})})}a.s(["GestionAutomatisation",()=>u])}];

//# sourceMappingURL=_86b8c24f._.js.map