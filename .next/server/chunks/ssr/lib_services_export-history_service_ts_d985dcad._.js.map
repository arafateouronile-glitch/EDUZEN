{"version":3,"sources":["../../../../lib/services/export-history.service.ts"],"sourcesContent":["/**\n * Service pour gérer l'historique des exports\n *\n * NOTE: La table 'export_history' n'existe pas encore dans Supabase.\n * Les types sont définis manuellement ici jusqu'à ce que la table soit créée\n * et les types régénérés avec: supabase gen types typescript\n */\n\nimport { createClient } from '@/lib/supabase/client'\nimport type { SupabaseClient } from '@supabase/supabase-js'\n\n// Types définis manuellement car la table n'existe pas encore dans database.types.ts\n// TODO: Supprimer ces définitions après avoir créé la table et régénéré les types\nexport type ExportType = 'excel' | 'csv' | 'pdf'\nexport type EntityType = 'students' | 'documents' | 'payments' | 'dashboard_report' | 'attendance_report' | 'other'\n\nexport interface ExportHistory {\n  id: string\n  organization_id: string\n  user_id: string\n  export_type: ExportType\n  entity_type: EntityType\n  filename: string\n  record_count: number\n  file_size_bytes: number | null\n  filters: string | null\n  created_at: string\n}\n\ntype ExportHistoryInsert = Omit<ExportHistory, 'id' | 'created_at'>\n\nexport interface ExportHistoryWithUser extends ExportHistory {\n  users?: {\n    full_name: string | null\n    email: string\n  } | null\n}\n\nexport interface CreateExportHistoryParams {\n  organizationId: string\n  userId: string\n  exportType: ExportType\n  entityType: EntityType\n  filename: string\n  recordCount?: number\n  fileSizeBytes?: number\n  filters?: Record<string, any>\n}\n\nexport class ExportHistoryService {\n  private supabase: SupabaseClient<any>\n\n\n  constructor(supabaseClient?: SupabaseClient<any>) {\n\n    this.supabase = supabaseClient || createClient()\n\n  }\n\n  /**\n   * Enregistre un export dans l'historique\n   * Retourne null si la table n'existe pas (non bloquant)\n   */\n  async create(params: CreateExportHistoryParams): Promise<ExportHistory | null> {\n    try {\n      const { data, error } = await this.supabase\n        .from('export_history')\n        .insert({\n          organization_id: params.organizationId,\n          user_id: params.userId,\n          export_type: params.exportType,\n          entity_type: params.entityType,\n          filename: params.filename,\n          record_count: params.recordCount || 0,\n          file_size_bytes: params.fileSizeBytes,\n          filters: params.filters ? JSON.stringify(params.filters) : null,\n        })\n        .select()\n        .single()\n\n      if (error) {\n        // Si la table n'existe pas, retourner null silencieusement\n        if (error.code === 'PGRST205' || error.message?.includes('Could not find the table')) {\n          return null\n        }\n        throw error\n      }\n      return data\n    } catch (error: any) {\n      // Si la table n'existe pas, retourner null silencieusement\n      if (error?.code === 'PGRST205' || error?.message?.includes('Could not find the table')) {\n        return null\n      }\n      throw error\n    }\n  }\n\n  /**\n   * Récupère l'historique des exports d'une organisation\n   */\n  async getByOrganization(\n    organizationId: string,\n    filters?: {\n      userId?: string\n      exportType?: ExportType\n      entityType?: EntityType\n      page?: number\n      limit?: number\n    }\n  ) {\n    try {\n      const page = filters?.page || 1\n      const limit = filters?.limit || 50\n      const offset = (page - 1) * limit\n\n      let query = this.supabase\n        .from('export_history')\n        .select('*, users(full_name, email)', { count: 'exact' })\n        .eq('organization_id', organizationId)\n        .order('created_at', { ascending: false })\n\n      if (filters?.userId) {\n        query = query.eq('user_id', filters.userId)\n      }\n\n      if (filters?.exportType) {\n        query = query.eq('export_type', filters.exportType)\n      }\n\n      if (filters?.entityType) {\n        query = query.eq('entity_type', filters.entityType)\n      }\n\n      const { data, error, count } = await query.range(offset, offset + limit - 1)\n\n      if (error) {\n        // Si la table n'existe pas encore ou erreur 400/404, retourner un résultat vide\n        if (\n          error.code === 'PGRST116' ||\n          error.code === 'PGRST200' ||\n          error.code === '42P01' ||\n          error.code === 'PGRST301' ||\n          (error as any).status === 400 ||\n          (error as any).status === 404 ||\n          error.code === '400' ||\n          error.code === '404' ||\n          error.message?.includes('relation') ||\n          error.message?.includes('does not exist')\n        ) {\n          return {\n            data: [],\n            total: 0,\n            page,\n            limit,\n            totalPages: 0,\n          }\n        }\n        throw error\n      }\n\n      return {\n        data: (data || []) as ExportHistoryWithUser[],\n        total: count || 0,\n        page,\n        limit,\n        totalPages: Math.ceil((count || 0) / limit),\n      }\n    } catch (error: any) {\n      // Gérer les erreurs de table inexistante\n      if (\n        error?.code === 'PGRST116' ||\n        error?.code === 'PGRST200' ||\n        error?.code === '42P01' ||\n        error?.code === 'PGRST301' ||\n        error?.status === 400 ||\n        error?.status === 404 ||\n        error?.code === '400' ||\n        error?.code === '404' ||\n        error?.message?.includes('relation') ||\n        error?.message?.includes('does not exist')\n      ) {\n        return {\n          data: [],\n          total: 0,\n          page: filters?.page || 1,\n          limit: filters?.limit || 50,\n          totalPages: 0,\n        }\n      }\n      throw error\n    }\n  }\n\n  /**\n   * Récupère les statistiques d'export d'une organisation\n   */\n  async getStats(organizationId: string) {\n    try {\n      const { data, error } = await this.supabase\n        .from('export_history')\n        .select('export_type, entity_type, record_count, file_size_bytes')\n        .eq('organization_id', organizationId)\n\n      if (error) {\n        // Si la table n'existe pas encore ou erreur 400/404, retourner des stats vides\n        if (\n          error.code === 'PGRST116' ||\n          error.code === 'PGRST200' ||\n          error.code === '42P01' ||\n          error.code === 'PGRST301' ||\n          (error as any).status === 400 ||\n          (error as any).status === 404 ||\n          error.code === '400' ||\n          error.code === '404' ||\n          error.message?.includes('relation') ||\n          error.message?.includes('does not exist')\n        ) {\n          return {\n            total: 0,\n            byType: {} as Record<ExportType, number>,\n            byEntity: {} as Record<EntityType, number>,\n            totalRecords: 0,\n            totalSizeBytes: 0,\n          }\n        }\n        throw error\n      }\n\n      const stats = {\n        total: data?.length || 0,\n        byType: {} as Record<ExportType, number>,\n        byEntity: {} as Record<EntityType, number>,\n        totalRecords: 0,\n        totalSizeBytes: 0,\n      }\n\n      data?.forEach((export_) => {\n        stats.byType[export_.export_type as ExportType] =\n          (stats.byType[export_.export_type as ExportType] || 0) + 1\n        stats.byEntity[export_.entity_type as EntityType] =\n          (stats.byEntity[export_.entity_type as EntityType] || 0) + 1\n        stats.totalRecords += export_.record_count || 0\n        stats.totalSizeBytes += export_.file_size_bytes || 0\n      })\n\n      return stats\n    } catch (error: any) {\n      // Gérer les erreurs de table inexistante\n      if (\n        error?.code === 'PGRST116' ||\n        error?.code === 'PGRST200' ||\n        error?.code === '42P01' ||\n        error?.code === 'PGRST301' ||\n        error?.status === 400 ||\n        error?.status === 404 ||\n        error?.code === '400' ||\n        error?.code === '404' ||\n        error?.message?.includes('relation') ||\n        error?.message?.includes('does not exist')\n      ) {\n        return {\n          total: 0,\n          byType: {} as Record<ExportType, number>,\n          byEntity: {} as Record<EntityType, number>,\n          totalRecords: 0,\n          totalSizeBytes: 0,\n        }\n      }\n      throw error\n    }\n  }\n\n  /**\n   * Supprime un export de l'historique\n   */\n  async delete(exportId: string, userId: string): Promise<void> {\n    const { error } = await this.supabase\n      .from('export_history')\n      .delete()\n      .eq('id', exportId)\n      .eq('user_id', userId) // Sécurité : seul le créateur peut supprimer\n\n    if (error) throw error\n  }\n\n  /**\n   * Supprime tous les exports d'un utilisateur\n   */\n  async deleteByUser(userId: string, organizationId: string): Promise<void> {\n    const { error } = await this.supabase\n      .from('export_history')\n      .delete()\n      .eq('user_id', userId)\n      .eq('organization_id', organizationId)\n\n    if (error) throw error\n  }\n}\n\nexport const exportHistoryService = new ExportHistoryService()\n\n"],"names":[],"mappings":"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"}