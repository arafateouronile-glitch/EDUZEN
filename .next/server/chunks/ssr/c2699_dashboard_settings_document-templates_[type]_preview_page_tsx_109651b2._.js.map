{"version":3,"sources":["../../../../app/%28dashboard%29/dashboard/settings/document-templates/%5Btype%5D/preview/page.tsx","../../../../lib/utils/document-generation/variable-mapper.ts"],"sourcesContent":["'use client'\n\nimport { useState, useEffect } from 'react'\nimport { useParams, useRouter, useSearchParams } from 'next/navigation'\nimport { useQuery } from '@tanstack/react-query'\nimport { useAuth } from '@/lib/hooks/use-auth'\nimport { createClient } from '@/lib/supabase/client'\nimport { documentTemplateService } from '@/lib/services/document-template.service'\nimport { studentService } from '@/lib/services/student.service'\nimport { invoiceService } from '@/lib/services/invoice.service'\nimport { paymentService } from '@/lib/services/payment.service'\nimport type { DocumentTemplate, DocumentVariables } from '@/lib/types/document-templates'\nimport {\n  mapStudentToVariables,\n  mapInvoiceToVariables,\n  mapPaymentToVariables,\n  mapSessionToVariables,\n} from '@/lib/utils/document-generation/variable-mapper'\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\nimport { Button } from '@/components/ui/button'\nimport { Label } from '@/components/ui/label'\nimport { GlassCard } from '@/components/ui/glass-card'\nimport { ArrowLeft, Download, Eye, FileDown, User, FileText, CreditCard, Calendar } from 'lucide-react'\nimport Link from 'next/link'\nimport { SkeletonLoader } from '../edit/components/skeleton-loader'\nimport { getDocumentTypeConfig } from '../edit/utils/document-type-config'\nimport type { StudentWithRelations } from '@/lib/types/query-types'\nimport type { TableRow } from '@/lib/types/supabase-helpers'\n\ntype Organization = TableRow<'organizations'>\ntype Invoice = TableRow<'invoices'>\ntype Session = TableRow<'sessions'>\ntype Payment = TableRow<'payments'>\n\nexport default function DocumentTemplatePreviewPage() {\n  const params = useParams()\n  const router = useRouter()\n  const searchParams = useSearchParams()\n  const { user } = useAuth()\n  const supabase = createClient()\n  const documentType = params.type as string\n  const docConfig = getDocumentTypeConfig(documentType as any)\n  const templateIdParam = searchParams.get('template_id')\n\n  const [previewUrl, setPreviewUrl] = useState<string | null>(null)\n  const [dataSource, setDataSource] = useState<'sample' | 'real'>('real')\n  const [selectedStudentId, setSelectedStudentId] = useState<string>('')\n  const [selectedInvoiceId, setSelectedInvoiceId] = useState<string>('')\n  const [selectedPaymentId, setSelectedPaymentId] = useState<string>('')\n  const [selectedSessionId, setSelectedSessionId] = useState<string>('')\n\n  // Charger le template\n  const { data: template, isLoading } = useQuery({\n    queryKey: ['document-template', user?.organization_id, documentType, templateIdParam],\n    queryFn: async () => {\n      if (!user?.organization_id) return null\n      \n      // Si un template_id est fourni, charger ce template spécifique\n      if (templateIdParam) {\n        try {\n          const specificTemplate = await documentTemplateService.getTemplateById(templateIdParam)\n          // Vérifier que le template correspond au type de document\n          if (specificTemplate.type === documentType) {\n            return specificTemplate\n          }\n        } catch (error) {\n          console.error('Erreur lors du chargement du template spécifique:', error)\n          // Continuer avec le chargement du template par défaut\n        }\n      }\n      \n      // Sinon, charger le template par défaut\n      return documentTemplateService.getDefaultTemplate(user.organization_id, documentType as any)\n    },\n    enabled: !!user?.organization_id,\n  })\n\n  // Récupérer l'organisation\n  const { data: organization } = useQuery({\n    queryKey: ['organization', user?.organization_id],\n    queryFn: async () => {\n      if (!user?.organization_id) return null\n      const { data, error } = await supabase\n        .from('organizations')\n        .select('*')\n        .eq('id', user.organization_id)\n        .single()\n      if (error) throw error\n      return data\n    },\n    enabled: !!user?.organization_id,\n  })\n\n  // Récupérer les étudiants\n  const { data: students } = useQuery<{ data: StudentWithRelations[]; total: number; page: number; limit: number; totalPages: number }>({\n    queryKey: ['students', user?.organization_id],\n    queryFn: async () => {\n      if (!user?.organization_id) return { data: [], total: 0, page: 1, limit: 50, totalPages: 0 }\n      return studentService.getAll(user.organization_id)\n    },\n    enabled: !!user?.organization_id && dataSource === 'real',\n  })\n\n  // Récupérer les factures\n  const { data: invoices } = useQuery({\n    queryKey: ['invoices', user?.organization_id],\n    queryFn: async () => {\n      if (!user?.organization_id) return []\n      return invoiceService.getAll(user.organization_id, {})\n    },\n    enabled: !!user?.organization_id && dataSource === 'real',\n  })\n\n  // Récupérer les paiements\n  const { data: payments } = useQuery({\n    queryKey: ['payments', user?.organization_id],\n    queryFn: async () => {\n      if (!user?.organization_id) return []\n      try {\n        // Essayer d'abord avec le service\n        const allPayments = await paymentService.getAll(user.organization_id)\n        return allPayments.slice(0, 50)\n      } catch (error: any) {\n        // Si le service échoue (relations manquantes), essayer une requête simple sans relations\n        const errorCode = error?.code || error?.originalError?.code || error?.status\n        const errorMessage = error?.message || error?.originalError?.message || String(error)\n        const errorDetails = error?.details || error?.hint || ''\n        \n        // Si c'est une erreur de relation ou 400, essayer une requête simple\n        const isRelationError = \n          errorCode === 'PGRST116' || \n          errorCode === '42P01' || \n          errorCode === 'PGRST200' ||\n          errorCode === 'PGRST301' ||\n          errorCode === '400' ||\n          error?.status === 400 ||\n          errorMessage?.toLowerCase().includes('relation') ||\n          errorMessage?.toLowerCase().includes('relationship') ||\n          errorMessage?.toLowerCase().includes('does not exist') ||\n          errorMessage?.toLowerCase().includes('schema cache') ||\n          errorMessage?.toLowerCase().includes('invalid query') ||\n          errorDetails?.toLowerCase().includes('relation') ||\n          errorDetails?.toLowerCase().includes('relationship')\n        \n        if (isRelationError) {\n          console.warn('Relations non disponibles, récupération des paiements sans relations:', {\n            errorCode,\n            errorMessage,\n            errorDetails,\n          })\n          try {\n            // Requête simple sans relations\n            const { data, error: simpleError } = await supabase\n              .from('payments')\n              .select('*')\n              .eq('organization_id', user.organization_id)\n              .order('created_at', { ascending: false })\n              .limit(50)\n            \n            if (simpleError) {\n              console.warn('Erreur lors de la récupération simple des paiements:', simpleError)\n              return []\n            }\n            return data || []\n          } catch (fallbackError: any) {\n            console.warn('Erreur lors de la récupération de fallback des paiements:', fallbackError)\n            return []\n          }\n        }\n        // Pour les autres erreurs, logger et retourner un tableau vide\n        console.error('Erreur lors de la récupération des paiements:', error)\n        return []\n      }\n    },\n    enabled: !!user?.organization_id && dataSource === 'real',\n    retry: false, // Ne pas réessayer automatiquement pour éviter les erreurs répétées\n  })\n\n  // Récupérer les sessions\n  const { data: sessions } = useQuery({\n    queryKey: ['sessions', user?.organization_id],\n    queryFn: async () => {\n      if (!user?.organization_id) return []\n      const { data, error } = await supabase\n        .from('sessions')\n        .select('*, formations(*)')\n        .eq('organization_id', user.organization_id)\n        .order('start_date', { ascending: false })\n        .limit(50)\n      if (error) throw error\n      return data || []\n    },\n    enabled: !!user?.organization_id && dataSource === 'real',\n  })\n\n  // Récupérer l'étudiant sélectionné\n  const { data: selectedStudent } = useQuery({\n    queryKey: ['student', selectedStudentId],\n    queryFn: async () => {\n      if (!selectedStudentId) return null\n      const student = await studentService.getById(selectedStudentId)\n      // Récupérer la session/classe\n      if (student?.class_id) {\n        const { data: session } = await supabase\n          .from('sessions')\n          .select('*, formations(*)')\n          .eq('id', student.class_id)\n          .single()\n        return { ...student, session }\n      }\n      return student\n    },\n    enabled: !!selectedStudentId && dataSource === 'real',\n  })\n\n  // Récupérer la facture sélectionnée\n  const { data: selectedInvoice } = useQuery({\n    queryKey: ['invoice', selectedInvoiceId],\n    queryFn: async () => {\n      if (!selectedInvoiceId) return null\n      const invoice = await invoiceService.getById(selectedInvoiceId)\n      if (invoice?.student_id) {\n        const student = await studentService.getById(invoice.student_id)\n        return { ...invoice, student }\n      }\n      return invoice\n    },\n    enabled: !!selectedInvoiceId && dataSource === 'real',\n  })\n\n  // Générer les variables selon la source de données\n  const getVariables = (): DocumentVariables => {\n    if (dataSource === 'sample') {\n      // Données fictives\n      return {\n        ecole_nom: 'École Moderne de Dakar',\n        ecole_logo: '',\n        ecole_adresse: '123 Avenue de l\\'Education, Dakar, Sénégal',\n        ecole_ville: 'Dakar',\n        ecole_telephone: '+221 77 123 45 67',\n        ecole_email: 'contact@ecolemoderne.sn',\n        ecole_site_web: 'www.ecolemoderne.sn',\n        eleve_nom: 'DIALLO',\n        eleve_prenom: 'Amadou',\n        eleve_numero: 'LYC001',\n        eleve_date_naissance: '15/03/2007',\n        eleve_classe: 'Terminale A',\n        formation_nom: 'Formation en Développement Web',\n        formation_code: 'DEV-WEB-2024',\n        formation_duree: '6 mois',\n        formation_prix: '500 000 XOF',\n        session_nom: 'Session Janvier 2024',\n        session_debut: '01/01/2024',\n        session_fin: '30/06/2024',\n        date_jour: new Date().toLocaleDateString('fr-FR'),\n        date_emission: new Date().toLocaleDateString('fr-FR'),\n        annee_scolaire: '2024-2025',\n        numero_document: '2025-001',\n        date_generation: new Date().toLocaleDateString('fr-FR'),\n        numero_page: 1,\n        total_pages: 1,\n      }\n    }\n\n    // Données réelles\n    if (selectedStudentId && selectedStudent) {\n      return mapStudentToVariables(\n        selectedStudent,\n        organization,\n        (selectedStudent as any).session,\n        (selectedStudent as any).session?.formations\n      )\n    }\n\n    if (selectedInvoiceId && selectedInvoice) {\n      return mapInvoiceToVariables(\n        selectedInvoice,\n        (selectedInvoice as any).student,\n        organization\n      )\n    }\n\n    if (selectedPaymentId && payments) {\n      const payment = payments.find((p: any) => p.id === selectedPaymentId)\n      if (payment) {\n        // Les relations peuvent être dans invoices (array) ou invoice (single), et students (array) ou student (single)\n        const invoice = Array.isArray((payment as any).invoices) \n          ? (payment as any).invoices[0] \n          : (payment as any).invoices || (payment as any).invoice\n        const student = Array.isArray((payment as any).students)\n          ? (payment as any).students[0]\n          : (payment as any).students || (payment as any).student\n        return mapPaymentToVariables(\n          payment,\n          invoice,\n          student,\n          organization\n        )\n      }\n    }\n\n    if (selectedSessionId && sessions) {\n      const session = sessions.find((s: any) => s.id === selectedSessionId)\n      if (session) {\n        return mapSessionToVariables(\n          session,\n          (session as any).formations,\n          organization\n        )\n      }\n    }\n\n    // Par défaut, utiliser le premier étudiant disponible\n    if (students && students.data && students.data.length > 0) {\n      return mapStudentToVariables(students.data[0] as StudentWithRelations, organization)\n    }\n\n    // Fallback: données minimales\n    return {\n      ecole_nom: organization?.name || '',\n      date_jour: new Date().toLocaleDateString('fr-FR'),\n      date_emission: new Date().toLocaleDateString('fr-FR'),\n      numero_document: 'DOC_001',\n      date_generation: new Date().toLocaleDateString('fr-FR'),\n      numero_page: 1,\n      total_pages: 1,\n    }\n  }\n\n  // Générer la prévisualisation\n  useEffect(() => {\n    if (template) {\n      const variables = getVariables()\n      generatePreview(template, variables).then((url) => {\n        setPreviewUrl(url)\n      })\n    }\n  }, [template, dataSource, selectedStudentId, selectedInvoiceId, selectedPaymentId, selectedSessionId, organization, students, invoices, payments, sessions])\n\n  const generatePreview = async (template: DocumentTemplate, variables: DocumentVariables) => {\n    try {\n      // Appeler l'API de génération\n      const response = await fetch('/api/documents/generate', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        credentials: 'include', // Inclure les cookies pour l'authentification\n        body: JSON.stringify({\n          template_id: template.id,\n          format: 'PDF',\n          variables,\n        }),\n      })\n\n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({}))\n        const errorMessage = errorData.error || `Erreur ${response.status}: ${response.statusText}`\n        const errorStack = errorData.stack\n        console.error('Erreur API:', {\n          status: response.status,\n          statusText: response.statusText,\n          error: errorMessage,\n          stack: errorStack,\n          fullError: errorData\n        })\n        throw new Error(errorMessage)\n      }\n\n      const data = await response.json()\n      return data.downloadUrl\n    } catch (error) {\n      console.error('Erreur lors de la génération du preview:', error)\n      const errorMessage = error instanceof Error ? error.message : 'Erreur inconnue'\n      // Afficher l'erreur à l'utilisateur\n      alert(`Erreur lors de la génération: ${errorMessage}`)\n      return null\n    }\n  }\n\n  if (isLoading || !template) {\n    return <SkeletonLoader />\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex items-center gap-4\">\n          <Link href=\"/dashboard/settings/document-templates\">\n            <Button variant=\"outline\" size=\"icon\">\n              <ArrowLeft className=\"h-4 w-4\" />\n            </Button>\n          </Link>\n          <div>\n            <h1 className=\"text-2xl font-bold text-text-primary flex items-center gap-2\">\n              <docConfig.icon className=\"h-6 w-6\" style={{ color: docConfig.color }} />\n              Prévisualisation - {docConfig.name}\n            </h1>\n            <p className=\"text-sm text-text-tertiary mt-1\">\n              Aperçu du document avec données réelles ou fictives\n            </p>\n          </div>\n        </div>\n        <div className=\"flex gap-2\">\n          <Link href={`/dashboard/settings/document-templates/${documentType}/edit`}>\n            <Button variant=\"outline\">\n              Modifier\n            </Button>\n          </Link>\n          {previewUrl && (\n            <a href={previewUrl} download={`${docConfig.name}_preview.pdf`}>\n              <Button variant=\"default\">\n                <Download className=\"h-4 w-4 mr-2\" />\n                Télécharger PDF\n              </Button>\n            </a>\n          )}\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-1 lg:grid-cols-4 gap-6\">\n        {/* Sélecteur de données */}\n        <div className=\"lg:col-span-1\">\n          <GlassCard variant=\"premium\" className=\"p-6\">\n            <h3 className=\"font-semibold text-text-primary mb-4\">Source de données</h3>\n            \n            <div className=\"space-y-4\">\n              <div>\n                <Label>Type de données</Label>\n                <select\n                  value={dataSource}\n                  onChange={(e) => {\n                    setDataSource(e.target.value as 'sample' | 'real')\n                    setSelectedStudentId('')\n                    setSelectedInvoiceId('')\n                    setSelectedPaymentId('')\n                    setSelectedSessionId('')\n                  }}\n                  className=\"w-full mt-1 px-3 py-2 border rounded-lg\"\n                >\n                  <option value=\"real\">Données réelles</option>\n                  <option value=\"sample\">Données fictives</option>\n                </select>\n              </div>\n\n              {dataSource === 'real' && (\n                <>\n                  {/* Sélection étudiant */}\n                  {['attestation_reussite', 'certificat_scolarite', 'releve_notes', 'attestation_entree', 'attestation_assiduite'].includes(documentType) && (\n                    <div>\n                      <Label htmlFor=\"student\" className=\"flex items-center gap-2\">\n                        <User className=\"h-4 w-4\" />\n                        Étudiant\n                      </Label>\n                      <select\n                        id=\"student\"\n                        value={selectedStudentId}\n                        onChange={(e) => {\n                          setSelectedStudentId(e.target.value)\n                          setSelectedInvoiceId('')\n                          setSelectedPaymentId('')\n                          setSelectedSessionId('')\n                        }}\n                        className=\"w-full mt-1 px-3 py-2 border rounded-lg\"\n                      >\n                        <option value=\"\">Sélectionner un étudiant</option>\n                        {students?.data?.map((student: any) => (\n                          <option key={student.id} value={student.id}>\n                            {student.last_name} {student.first_name} ({student.student_number})\n                          </option>\n                        ))}\n                      </select>\n                    </div>\n                  )}\n\n                  {/* Sélection facture */}\n                  {documentType === 'facture' && (\n                    <div>\n                      <Label htmlFor=\"invoice\" className=\"flex items-center gap-2\">\n                        <FileText className=\"h-4 w-4\" />\n                        Facture\n                      </Label>\n                      <select\n                        id=\"invoice\"\n                        value={selectedInvoiceId}\n                        onChange={(e) => {\n                          setSelectedInvoiceId(e.target.value)\n                          setSelectedStudentId('')\n                          setSelectedPaymentId('')\n                          setSelectedSessionId('')\n                        }}\n                        className=\"w-full mt-1 px-3 py-2 border rounded-lg\"\n                      >\n                        <option value=\"\">Sélectionner une facture</option>\n                        {invoices?.map((invoice: any) => (\n                          <option key={invoice.id} value={invoice.id}>\n                            {invoice.invoice_number} - {(invoice.students as any)?.first_name} {(invoice.students as any)?.last_name}\n                          </option>\n                        ))}\n                      </select>\n                    </div>\n                  )}\n\n                  {/* Sélection paiement */}\n                  {documentType === 'recu_paiement' && (\n                    <div>\n                      <Label htmlFor=\"payment\" className=\"flex items-center gap-2\">\n                        <CreditCard className=\"h-4 w-4\" />\n                        Paiement\n                      </Label>\n                      <select\n                        id=\"payment\"\n                        value={selectedPaymentId}\n                        onChange={(e) => {\n                          setSelectedPaymentId(e.target.value)\n                          setSelectedStudentId('')\n                          setSelectedInvoiceId('')\n                          setSelectedSessionId('')\n                        }}\n                        className=\"w-full mt-1 px-3 py-2 border rounded-lg\"\n                      >\n                        <option value=\"\">Sélectionner un paiement</option>\n                        {payments?.map((payment: any) => {\n                          // Gérer les relations qui peuvent être un array ou un objet\n                          const student = Array.isArray(payment.students) \n                            ? payment.students[0] \n                            : payment.students || payment.student\n                          const studentName = student \n                            ? `${student.first_name || ''} ${student.last_name || ''}`.trim()\n                            : 'N/A'\n                          return (\n                            <option key={payment.id} value={payment.id}>\n                              {payment.payment_number || payment.id} - {studentName}\n                            </option>\n                          )\n                        })}\n                      </select>\n                    </div>\n                  )}\n\n                  {/* Sélection session */}\n                  {['certificat_scolarite'].includes(documentType) && (\n                    <div>\n                      <Label htmlFor=\"session\" className=\"flex items-center gap-2\">\n                        <Calendar className=\"h-4 w-4\" />\n                        Session\n                      </Label>\n                      <select\n                        id=\"session\"\n                        value={selectedSessionId}\n                        onChange={(e) => {\n                          setSelectedSessionId(e.target.value)\n                          setSelectedStudentId('')\n                          setSelectedInvoiceId('')\n                          setSelectedPaymentId('')\n                        }}\n                        className=\"w-full mt-1 px-3 py-2 border rounded-lg\"\n                      >\n                        <option value=\"\">Sélectionner une session</option>\n                        {sessions?.map((session: any) => (\n                          <option key={session.id} value={session.id}>\n                            {session.name} - {(session.formations as any)?.name}\n                          </option>\n                        ))}\n                      </select>\n                    </div>\n                  )}\n                </>\n              )}\n            </div>\n          </GlassCard>\n        </div>\n\n        {/* Prévisualisation */}\n        <div className=\"lg:col-span-3\">\n          <Card>\n            <CardHeader>\n              <CardTitle>Aperçu du document</CardTitle>\n            </CardHeader>\n            <CardContent className=\"p-0\">\n              {previewUrl ? (\n                <iframe\n                  src={previewUrl}\n                  className=\"w-full h-[800px] border-0\"\n                  title=\"Prévisualisation du document\"\n                />\n              ) : (\n                <div className=\"flex items-center justify-center h-96 text-text-tertiary\">\n                  <div className=\"text-center\">\n                    <Eye className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n                    <p>Génération de la prévisualisation...</p>\n                  </div>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n    </div>\n  )\n}\n\n\n","import type { DocumentVariables } from '@/lib/types/document-templates'\nimport type { StudentWithRelations } from '@/lib/types/query-types'\nimport type { TableRow } from '@/lib/types/supabase-helpers'\nimport { formatDate } from '@/lib/utils'\n\ntype Organization = TableRow<'organizations'>\ntype Invoice = TableRow<'invoices'>\ntype Payment = TableRow<'payments'>\ntype Session = TableRow<'sessions'>\ntype Formation = TableRow<'formations'>\n\n/**\n * Mappe les données d'un étudiant vers les variables de document\n */\nexport function mapStudentToVariables(\n  student: StudentWithRelations | any,\n  organization?: Organization | null,\n  session?: Session | null,\n  formation?: Formation | null\n): DocumentVariables {\n  const now = new Date()\n  \n  return {\n    // Établissement\n    ecole_nom: organization?.name || '',\n    ecole_logo: organization?.logo_url || '',\n    ecole_adresse: organization?.address || '',\n    ecole_ville: organization?.city || '',\n    ecole_telephone: organization?.phone || '',\n    ecole_email: organization?.email || '',\n    ecole_site_web: (organization as any)?.website || '',\n    ecole_siret: (organization as any)?.siret || '',\n    ecole_code_postal: (organization as any)?.postal_code || '',\n    \n    // Élève\n    eleve_nom: student?.last_name || '',\n    eleve_prenom: student?.first_name || '',\n    eleve_numero: student?.student_number || '',\n    eleve_date_naissance: student?.date_of_birth ? formatDate(student.date_of_birth) : '',\n    eleve_classe: session?.name || '',\n    eleve_photo: student?.photo_url || '',\n    eleve_adresse: student?.address || '',\n    eleve_telephone: student?.phone || '',\n    eleve_email: student?.email || '',\n    \n    // Formation\n    formation_nom: formation?.name || '',\n    formation_code: formation?.code || '',\n    formation_duree: formation?.duration_hours ? `${formation.duration_hours} heures` : '',\n    formation_prix: formation?.price ? `${formation.price} ${formation.currency || 'EUR'}` : '',\n    formation_dates: session ? `${formatDate(session.start_date)} - ${formatDate(session.end_date)}` : '',\n    formation_description: formation?.description || '',\n    formation_objectifs: (formation as any)?.objectives || '',\n    \n    // Session\n    session_nom: session?.name || '',\n    session_debut: session?.start_date ? formatDate(session.start_date) : '',\n    session_fin: session?.end_date ? formatDate(session.end_date) : '',\n    session_lieu: session?.location || '',\n    session_horaires: session?.start_time && session?.end_time \n      ? `${session.start_time} - ${session.end_time}` \n      : '',\n    \n    // Dates\n    date_jour: formatDate(now),\n    date_emission: formatDate(now),\n    date_generation: formatDate(now),\n    annee_actuelle: now.getFullYear().toString(),\n    heure: now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }),\n    \n    // Divers\n    numero_document: `DOC-${now.getTime()}`,\n    numero_page: 1,\n    total_pages: 1,\n  }\n}\n\n/**\n * Mappe les données d'une facture vers les variables de document\n */\nexport function mapInvoiceToVariables(\n  invoice: Invoice | any,\n  student?: StudentWithRelations | any,\n  organization?: Organization | null\n): DocumentVariables {\n  const now = new Date()\n  \n  return {\n    // Établissement\n    ecole_nom: organization?.name || '',\n    ecole_logo: organization?.logo_url || '',\n    ecole_adresse: organization?.address || '',\n    ecole_ville: organization?.city || '',\n    ecole_telephone: organization?.phone || '',\n    ecole_email: organization?.email || '',\n    ecole_siret: (organization as any)?.siret || '',\n    \n    // Élève\n    eleve_nom: student?.last_name || '',\n    eleve_prenom: student?.first_name || '',\n    eleve_numero: student?.student_number || '',\n    eleve_adresse: student?.address || '',\n    \n    // Finances\n    montant: invoice?.total_amount ? `${invoice.total_amount} ${invoice.currency || 'EUR'}` : '',\n    montant_ht: invoice?.amount ? `${invoice.amount} ${invoice.currency || 'EUR'}` : '',\n    montant_ttc: invoice?.total_amount ? `${invoice.total_amount} ${invoice.currency || 'EUR'}` : '',\n    tva: invoice?.tax_amount ? `${invoice.tax_amount} ${invoice.currency || 'EUR'}` : '',\n    taux_tva: invoice?.tax_amount && invoice?.amount \n      ? `${((invoice.tax_amount / invoice.amount) * 100).toFixed(2)}%` \n      : '',\n    numero_facture: invoice?.invoice_number || '',\n    date_echeance: invoice?.due_date ? formatDate(invoice.due_date) : '',\n    \n    // Dates\n    date_jour: formatDate(now),\n    date_emission: invoice?.issue_date ? formatDate(invoice.issue_date) : formatDate(now),\n    date_generation: formatDate(now),\n    \n    // Divers\n    numero_document: invoice?.invoice_number || `DOC-${now.getTime()}`,\n    numero_page: 1,\n    total_pages: 1,\n  }\n}\n\n/**\n * Mappe les données d'un paiement vers les variables de document\n */\nexport function mapPaymentToVariables(\n  payment: Payment | any,\n  invoice?: Invoice | any,\n  student?: StudentWithRelations | any,\n  organization?: Organization | null\n): DocumentVariables {\n  const now = new Date()\n  \n  return {\n    // Établissement\n    ecole_nom: organization?.name || '',\n    ecole_logo: organization?.logo_url || '',\n    ecole_adresse: organization?.address || '',\n    ecole_telephone: organization?.phone || '',\n    ecole_email: organization?.email || '',\n    \n    // Élève\n    eleve_nom: student?.last_name || '',\n    eleve_prenom: student?.first_name || '',\n    eleve_numero: student?.student_number || '',\n    \n    // Finances\n    montant: payment?.amount ? `${payment.amount} ${payment.currency || 'EUR'}` : '',\n    date_paiement: payment?.paid_at ? formatDate(payment.paid_at) : payment?.payment_date ? formatDate(payment.payment_date) : '',\n    mode_paiement: payment?.payment_method || '',\n    numero_facture: invoice?.invoice_number || '',\n    \n    // Dates\n    date_jour: formatDate(now),\n    date_emission: formatDate(now),\n    date_generation: formatDate(now),\n    \n    // Divers\n    numero_document: payment?.payment_number || `DOC-${now.getTime()}`,\n    numero_page: 1,\n    total_pages: 1,\n  }\n}\n\n/**\n * Mappe les données d'une session vers les variables de document\n */\nexport function mapSessionToVariables(\n  session: Session | any,\n  formation?: Formation | any,\n  organization?: Organization | null\n): DocumentVariables {\n  const now = new Date()\n  \n  const variables: any = {\n    // Établissement\n    ecole_nom: organization?.name || '',\n    ecole_logo: organization?.logo_url || '',\n    ecole_adresse: organization?.address || '',\n    ecole_ville: organization?.city || '',\n    ecole_telephone: organization?.phone || '',\n    ecole_email: organization?.email || '',\n    ecole_siret: (organization as any)?.siret || '',\n    ecole_rcs: (organization as any)?.rcs || '',\n    ecole_representant: (organization as any)?.representative_name || '',\n    \n    // Formation\n    formation_nom: formation?.name || '',\n    formation_code: formation?.code || '',\n    formation_duree: formation?.duration_hours ? `${formation.duration_hours} heures` : '',\n    formation_prix: formation?.price ? `${formation.price} ${formation.currency || 'EUR'}` : '',\n    formation_description: formation?.description || '',\n    formation_objectifs: (formation as any)?.objectives || '',\n    \n    // Session\n    session_nom: session?.name || '',\n    session_debut: session?.start_date ? formatDate(session.start_date) : '',\n    session_fin: session?.end_date ? formatDate(session.end_date) : '',\n    session_lieu: session?.location || '',\n    session_horaires: session?.start_time && session?.end_time \n      ? `${session.start_time} - ${session.end_time}` \n      : '',\n    \n    // Dates\n    date_jour: formatDate(now),\n    date_emission: formatDate(now),\n    date_generation: formatDate(now),\n    annee_actuelle: now.getFullYear().toString(),\n    \n    // Divers\n    numero_document: `DOC-${now.getTime()}`,\n    numero_page: 1,\n    total_pages: 1,\n  }\n  return variables as DocumentVariables\n}\n\n/**\n * Fonction générique pour mapper les données vers les variables selon le type de document\n */\nexport function mapDataToVariables(\n  type: 'invoice' | 'quote' | 'certificate' | 'contract' | 'report' | 'other',\n  data: {\n    student?: StudentWithRelations | any\n    invoice?: Invoice | any\n    payment?: Payment | any\n    session?: Session | any | Session[]\n    formation?: Formation | any\n    organization?: Organization | null\n  }\n): DocumentVariables {\n  const { student, invoice, payment, session, formation, organization } = data\n\n  // Déterminer la session (peut être un tableau ou un objet)\n  const sessionObj = Array.isArray(session) ? session[0] : session\n\n  switch (type) {\n    case 'invoice':\n      if (invoice) {\n        return mapInvoiceToVariables(invoice, student, organization)\n      }\n      break\n    case 'certificate':\n      if (student && sessionObj) {\n        return mapStudentToVariables(student, organization, sessionObj, formation)\n      }\n      break\n    case 'contract':\n    case 'report':\n    case 'other':\n      if (student) {\n        return mapStudentToVariables(student, organization, sessionObj, formation)\n      }\n      if (sessionObj) {\n        return mapSessionToVariables(sessionObj, formation, organization)\n      }\n      break\n  }\n\n  // Fallback: retourner des variables vides avec les données de base disponibles\n  const now = new Date()\n  return {\n    ecole_nom: organization?.name || '',\n    ecole_logo: organization?.logo_url || '',\n    ecole_adresse: organization?.address || '',\n    ecole_ville: organization?.city || '',\n    ecole_telephone: organization?.phone || '',\n    ecole_email: organization?.email || '',\n    eleve_nom: student?.last_name || '',\n    eleve_prenom: student?.first_name || '',\n    eleve_numero: student?.student_number || '',\n    date_jour: formatDate(now),\n    date_emission: formatDate(now),\n    date_generation: formatDate(now),\n    annee_actuelle: now.getFullYear().toString(),\n    numero_document: `DOC-${now.getTime()}`,\n    numero_page: 1,\n    total_pages: 1,\n  }\n}\n"],"names":[],"mappings":"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"}