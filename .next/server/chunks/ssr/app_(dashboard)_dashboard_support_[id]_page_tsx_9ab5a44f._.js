module.exports=[552351,a=>{"use strict";var b=a.i(187924),c=a.i(572131),d=a.i(50944),e=a.i(433217),f=a.i(370025),g=a.i(937927),h=a.i(913216),i=a.i(146673),j=a.i(703130),k=a.i(340695),l=a.i(546893),m=a.i(917171),n=a.i(800006),o=a.i(400210),p=a.i(692759),q=a.i(495756),r=a.i(54018),s=a.i(641710),t=a.i(290821),u=a.i(546842),v=a.i(821374),w=a.i(238246),x=a.i(497895);function y(){let a=(0,d.useParams)();(0,d.useRouter)();let y=a.id,{user:z}=(0,h.useAuth)(),A=(0,g.useQueryClient)(),[B,C]=(0,c.useState)(""),D=(0,c.useRef)(null),{data:E}=(0,e.useQuery)({queryKey:["support-ticket",y],queryFn:()=>i.supportService.getTicketById(y),enabled:!!y}),{data:F}=(0,e.useQuery)({queryKey:["support-ticket-messages",y],queryFn:()=>i.supportService.getTicketMessages(y),enabled:!!y,refetchInterval:5e3}),{data:G}=(0,e.useQuery)({queryKey:["support-ticket-notes",y],queryFn:()=>i.supportService.getTicketNotes(y),enabled:!!y&&(z?.role==="admin"||z?.role==="super_admin"||z?.role==="support")}),{data:H}=(0,e.useQuery)({queryKey:["support-ticket-rating",y],queryFn:()=>i.supportService.getTicketRating(y),enabled:!!y&&E?.status==="resolved"}),I=(0,f.useMutation)({mutationFn:async a=>i.supportService.createMessage({ticket_id:y,user_id:z?.id||"",content:a,message_type:"text",is_internal:!1}),onSuccess:()=>{C(""),A.invalidateQueries({queryKey:["support-ticket-messages"]}),A.invalidateQueries({queryKey:["support-ticket"]})}}),J=(0,f.useMutation)({mutationFn:async a=>{let b={status:a};return"resolved"===a?b.resolved_at=new Date().toISOString():"closed"===a&&(b.closed_at=new Date().toISOString()),i.supportService.updateTicket(y,b)},onSuccess:()=>{A.invalidateQueries({queryKey:["support-ticket"]}),A.invalidateQueries({queryKey:["support-tickets"]})}});(0,f.useMutation)({mutationFn:async a=>i.supportService.assignTicket(y,a),onSuccess:()=>{A.invalidateQueries({queryKey:["support-ticket"]})}});let K=(0,f.useMutation)({mutationFn:async a=>i.supportService.createNote({ticket_id:y,user_id:z?.id||"",content:a,is_private:!0}),onSuccess:()=>{A.invalidateQueries({queryKey:["support-ticket-notes"]})}}),L=(0,f.useMutation)({mutationFn:async a=>i.supportService.createRating({ticket_id:y,user_id:z?.id||"",rating:a.rating,comment:a.comment}),onSuccess:()=>{A.invalidateQueries({queryKey:["support-ticket-rating"]})}}),M=z?.role==="admin"||z?.role==="super_admin"||z?.role==="support",N=E?.user_id===z?.id;return((0,c.useEffect)(()=>{D.current?.scrollIntoView({behavior:"smooth"})},[F]),E)?(0,b.jsxs)("div",{className:"container mx-auto py-8 px-4 max-w-7xl",children:[(0,b.jsxs)("div",{className:"mb-6",children:[(0,b.jsx)(w.default,{href:"/dashboard/support",children:(0,b.jsxs)(k.Button,{variant:"ghost",size:"sm",className:"mb-4",children:[(0,b.jsx)(o.ArrowLeft,{className:"h-4 w-4 mr-2"}),"Retour aux tickets"]})}),(0,b.jsxs)("div",{className:"flex items-center justify-between",children:[(0,b.jsxs)("div",{children:[(0,b.jsxs)("div",{className:"flex items-center gap-3 mb-2",children:[(0,b.jsx)("span",{className:"font-mono text-sm text-muted-foreground",children:E.ticket_number}),(0,b.jsx)("h1",{className:"text-3xl font-bold",children:E.subject})]}),(0,b.jsxs)("div",{className:"flex items-center gap-4 text-sm text-muted-foreground",children:[(0,b.jsxs)("div",{className:"flex items-center gap-1",children:[(a=>{switch(a){case"open":return(0,b.jsx)(t.AlertCircle,{className:"h-4 w-4 text-blue-600"});case"in_progress":return(0,b.jsx)(s.Clock,{className:"h-4 w-4 text-yellow-600"});case"waiting_customer":return(0,b.jsx)(s.Clock,{className:"h-4 w-4 text-orange-600"});case"resolved":return(0,b.jsx)(q.CheckCircle,{className:"h-4 w-4 text-green-600"});case"closed":return(0,b.jsx)(r.XCircle,{className:"h-4 w-4 text-gray-600"});default:return null}})(E.status||""),(0,b.jsx)("span",{children:(a=>{switch(a){case"open":return"Ouvert";case"in_progress":return"En cours";case"waiting_customer":return"En attente client";case"resolved":return"Résolu";case"closed":return"Fermé";default:return a}})(E.status||"")})]}),(0,b.jsxs)("span",{children:["Créé le ",(0,x.formatDate)(E.created_at||"")]}),E.category&&(0,b.jsx)("span",{children:E.category.name})]})]}),M&&(0,b.jsx)("div",{className:"flex items-center gap-2",children:(0,b.jsxs)(n.Select,{value:E.status||"",onValueChange:a=>J.mutate(a),children:[(0,b.jsx)(n.SelectTrigger,{className:"w-40",children:(0,b.jsx)(n.SelectValue,{})}),(0,b.jsxs)(n.SelectContent,{children:[(0,b.jsx)(n.SelectItem,{value:"open",children:"Ouvert"}),(0,b.jsx)(n.SelectItem,{value:"in_progress",children:"En cours"}),(0,b.jsx)(n.SelectItem,{value:"waiting_customer",children:"En attente"}),(0,b.jsx)(n.SelectItem,{value:"resolved",children:"Résolu"}),(0,b.jsx)(n.SelectItem,{value:"closed",children:"Fermé"})]})]})})]})]}),(0,b.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[(0,b.jsx)("div",{className:"lg:col-span-2",children:(0,b.jsxs)(j.Card,{className:"h-[600px] flex flex-col",children:[(0,b.jsx)(j.CardHeader,{children:(0,b.jsx)(j.CardTitle,{children:"Conversation"})}),(0,b.jsxs)(j.CardContent,{className:"flex-1 flex flex-col overflow-hidden",children:[(0,b.jsxs)("div",{className:"flex-1 overflow-y-auto space-y-4 mb-4 pr-2",children:[F&&F.length>0?F.map(a=>{let c=a.user_id===z?.id,d=a.user?.role==="admin"||a.user?.role==="super_admin"||a.user?.role==="support";return(0,b.jsx)("div",{className:`flex ${c?"justify-end":"justify-start"}`,children:(0,b.jsxs)("div",{className:`max-w-[80%] rounded-lg p-3 ${c?"bg-primary text-white":d?"bg-blue-50 border border-blue-200":"bg-gray-100"}`,children:[(0,b.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,b.jsx)(u.User,{className:"h-4 w-4"}),(0,b.jsx)("span",{className:"text-sm font-medium",children:a.user?.full_name||a.user?.email||"Utilisateur"}),(0,b.jsx)("span",{className:"text-xs opacity-70",children:(0,x.formatDate)(a.created_at)})]}),(0,b.jsx)("p",{className:"text-sm whitespace-pre-wrap",children:a.content})]})},a.id)}):(0,b.jsx)("div",{className:"text-center text-muted-foreground py-8",children:"Aucun message pour le moment"}),(0,b.jsx)("div",{ref:D})]}),"closed"!==E.status&&(N||M)&&(0,b.jsx)("form",{onSubmit:a=>{a.preventDefault(),B.trim()&&I.mutate(B)},className:"border-t pt-4",children:(0,b.jsxs)("div",{className:"flex gap-2",children:[(0,b.jsx)(l.Textarea,{value:B,onChange:a=>C(a.target.value),placeholder:"Tapez votre message...",rows:3,className:"flex-1"}),(0,b.jsx)(k.Button,{type:"submit",disabled:I.isPending||!B.trim(),children:(0,b.jsx)(p.Send,{className:"h-4 w-4"})})]})})]})]})}),(0,b.jsxs)("div",{className:"space-y-6",children:[(0,b.jsxs)(j.Card,{children:[(0,b.jsx)(j.CardHeader,{children:(0,b.jsx)(j.CardTitle,{children:"Informations"})}),(0,b.jsxs)(j.CardContent,{className:"space-y-4",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)(m.Label,{className:"text-xs text-muted-foreground",children:"Priorité"}),(0,b.jsx)("p",{className:"font-medium",children:E.priority})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)(m.Label,{className:"text-xs text-muted-foreground",children:"Créé par"}),(0,b.jsx)("p",{className:"font-medium",children:E.user?.full_name||E.user?.email||"Utilisateur"})]}),E.assigned_user&&(0,b.jsxs)("div",{children:[(0,b.jsx)(m.Label,{className:"text-xs text-muted-foreground",children:"Assigné à"}),(0,b.jsx)("p",{className:"font-medium",children:E.assigned_user?.full_name||E.assigned_user?.email})]}),E.first_response_at&&(0,b.jsxs)("div",{children:[(0,b.jsx)(m.Label,{className:"text-xs text-muted-foreground",children:"Première réponse"}),(0,b.jsx)("p",{className:"font-medium",children:(0,x.formatDate)(E.first_response_at)})]}),E.resolved_at&&(0,b.jsxs)("div",{children:[(0,b.jsx)(m.Label,{className:"text-xs text-muted-foreground",children:"Résolu le"}),(0,b.jsx)("p",{className:"font-medium",children:(0,x.formatDate)(E.resolved_at)})]})]})]}),(0,b.jsxs)(j.Card,{children:[(0,b.jsx)(j.CardHeader,{children:(0,b.jsx)(j.CardTitle,{children:"Description"})}),(0,b.jsx)(j.CardContent,{children:(0,b.jsx)("p",{className:"text-sm whitespace-pre-wrap",children:E.description})})]}),M&&(0,b.jsxs)(j.Card,{children:[(0,b.jsx)(j.CardHeader,{children:(0,b.jsx)(j.CardTitle,{children:"Notes internes"})}),(0,b.jsxs)(j.CardContent,{children:[G&&G.length>0?(0,b.jsx)("div",{className:"space-y-3 mb-4",children:G.map(a=>(0,b.jsxs)("div",{className:"p-3 bg-gray-50 rounded-lg",children:[(0,b.jsx)("p",{className:"text-sm whitespace-pre-wrap",children:a.content}),(0,b.jsxs)("p",{className:"text-xs text-muted-foreground mt-2",children:["Par ",a.user?.full_name||a.user?.email," le"," ",(0,x.formatDate)(a.created_at)]})]},a.id))}):null,(0,b.jsxs)("form",{onSubmit:a=>{a.preventDefault();let b=new FormData(a.currentTarget).get("note");b.trim()&&(K.mutate(b),a.currentTarget.reset())},children:[(0,b.jsx)(l.Textarea,{name:"note",placeholder:"Ajouter une note interne...",rows:3,className:"mb-2"}),(0,b.jsx)(k.Button,{type:"submit",size:"sm",disabled:K.isPending,children:"Ajouter"})]})]})]}),N&&"resolved"===E.status&&!H&&(0,b.jsxs)(j.Card,{children:[(0,b.jsx)(j.CardHeader,{children:(0,b.jsx)(j.CardTitle,{children:"Évaluer le support"})}),(0,b.jsx)(j.CardContent,{children:(0,b.jsxs)("form",{onSubmit:a=>{a.preventDefault();let b=new FormData(a.currentTarget),c=parseInt(b.get("rating")),d=b.get("comment");L.mutate({rating:c,comment:d})},className:"space-y-4",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)(m.Label,{children:"Note"}),(0,b.jsxs)(n.Select,{children:[(0,b.jsx)(n.SelectTrigger,{children:(0,b.jsx)(n.SelectValue,{placeholder:"Sélectionner une note"})}),(0,b.jsx)(n.SelectContent,{children:[1,2,3,4,5].map(a=>(0,b.jsxs)(n.SelectItem,{value:a.toString(),children:[a," étoile",a>1?"s":""]},a))})]})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)(m.Label,{children:"Commentaire (optionnel)"}),(0,b.jsx)(l.Textarea,{name:"comment",rows:3})]}),(0,b.jsx)(k.Button,{type:"submit",disabled:L.isPending,children:"Envoyer l'évaluation"})]})})]}),H&&(0,b.jsxs)(j.Card,{children:[(0,b.jsx)(j.CardHeader,{children:(0,b.jsx)(j.CardTitle,{children:"Votre évaluation"})}),(0,b.jsxs)(j.CardContent,{children:[(0,b.jsxs)("div",{className:"flex items-center gap-2 mb-2",children:[(0,b.jsx)(v.Star,{className:"h-5 w-5 text-yellow-500 fill-yellow-500"}),(0,b.jsxs)("span",{className:"font-semibold",children:[H.rating," / 5"]})]}),H.comment&&(0,b.jsx)("p",{className:"text-sm text-muted-foreground",children:H.comment})]})]})]})]})]}):(0,b.jsx)("div",{className:"container mx-auto py-8 px-4 max-w-7xl",children:(0,b.jsx)("div",{className:"text-center py-12",children:"Chargement..."})})}a.s(["default",()=>y])}];

//# sourceMappingURL=app_%28dashboard%29_dashboard_support_%5Bid%5D_page_tsx_9ab5a44f._.js.map