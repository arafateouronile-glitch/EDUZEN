module.exports=[584474,a=>{"use strict";var b=a.i(187924),c=a.i(572131),d=a.i(50944),e=a.i(370025),f=a.i(433217),g=a.i(695245),h=a.i(159501),i=a.i(913216),j=a.i(269240),k=a.i(340695),l=a.i(703130),m=a.i(400210),n=a.i(238246),o=a.i(437536);function p(){let a=(0,d.useRouter)(),{user:p,isLoading:q,session:r}=(0,i.useAuth)(),s=(0,j.createClient)(),[t,u]=(0,c.useState)(1),{register:v,handleSubmit:w,formState:{errors:x,isValid:y},setValue:z,trigger:A,watch:B}=(0,g.useForm)({resolver:(0,h.zodResolver)(o.studentSchema),mode:"onChange",defaultValues:{first_name:"",last_name:"",date_of_birth:"",gender:"",email:"",phone:"",address:"",city:"",guardian_first_name:"",guardian_last_name:"",guardian_relationship:"parent",guardian_phone_primary:"",guardian_phone_secondary:"",guardian_email:"",guardian_address:"",class_id:"",enrollment_date:new Date().toISOString().split("T")[0]}}),{data:C}=(0,f.useQuery)({queryKey:["program-sessions-all",p?.organization_id],queryFn:async()=>{if(!p?.organization_id)return[];let{data:a,error:b}=await s.from("sessions").select("id, name, start_date, end_date, formations!inner(id, name, code, organization_id, programs(id, name))").eq("formations.organization_id",p.organization_id).order("start_date",{ascending:!1});if(b)throw b;return a?.map(a=>({id:a.id,name:`${a.name} - ${a.formations.name}${a.formations.programs?` (${a.formations.programs.name})`:""}`,code:a.formations.code,start_date:a.start_date,end_date:a.end_date}))||[]},enabled:!!p?.organization_id&&!q}),D=(0,e.useMutation)({mutationFn:async a=>{if(!p?.organization_id)throw Error("Organization ID manquant");let{data:b,error:c}=await s.from("guardians").insert({organization_id:p.organization_id,first_name:a.guardian_first_name,last_name:a.guardian_last_name,relationship:a.guardian_relationship,phone_primary:a.guardian_phone_primary,phone_secondary:a.guardian_phone_secondary||null,email:a.guardian_email||null,address:a.guardian_address||null}).select().single();if(c)throw c;let{data:d}=await s.from("organizations").select("code").eq("id",p.organization_id).single(),e=d?.code||"EDUZEN",f=new Date().getFullYear().toString().slice(-2),g=`${e}${f}`,{data:h}=await s.from("students").select("student_number").eq("organization_id",p.organization_id).like("student_number",`${g}%`).order("student_number",{ascending:!1}).limit(1).maybeSingle(),i=1;h?.student_number&&(i=(parseInt(h.student_number.slice(-4))||0)+1);let j=`${g}${String(i).padStart(4,"0")}`,{data:k}=await s.from("students").select("id").eq("organization_id",p.organization_id).eq("student_number",j).maybeSingle();if(k){let a=0;for(;a<100;){i++,j=`${g}${String(i).padStart(4,"0")}`;let{data:b}=await s.from("students").select("id").eq("organization_id",p.organization_id).eq("student_number",j).maybeSingle();if(!b)break;a++}if(a>=100)throw Error("Impossible de générer un numéro d'élève unique. Veuillez réessayer.")}let{data:l,error:m}=await s.from("students").insert({organization_id:p.organization_id,student_number:j,first_name:a.first_name,last_name:a.last_name,date_of_birth:a.date_of_birth||null,gender:a.gender||null,email:a.email||null,phone:a.phone||null,address:a.address||null,city:a.city||null,enrollment_date:a.enrollment_date,status:"active"}).select().single();if(m){if(console.error("Student creation error:",m),console.error("Error details:",{code:m.code,message:m.message,details:m.details,hint:m.hint}),"23505"===m.code)throw Error(`Un \xe9l\xe8ve avec le num\xe9ro "${j}" existe d\xe9j\xe0 dans votre organisation. Veuillez r\xe9essayer ou contacter le support.`);throw Error(m.message||"Une erreur est survenue lors de la création de l'élève")}let{error:n}=await s.from("student_guardians").insert({student_id:l.id,guardian_id:b.id,is_primary:!0});if(n)throw console.error("Link guardian error:",n),Error("Erreur lors de la liaison du tuteur à l'élève");if(a.class_id){let{error:b}=await s.from("enrollments").insert({student_id:l.id,session_id:a.class_id,enrollment_date:a.enrollment_date,status:"confirmed",payment_status:"pending",total_amount:0,paid_amount:0});b&&(console.error("Enrollment error:",b),console.warn("L'élève a été créé mais l'inscription à la session a échoué"))}return l},onSuccess:b=>{a.push(`/dashboard/students/${b.id}`)},onError:a=>{console.error("Student creation mutation error:",a)}}),E=async a=>{if(console.log("onSubmit called:",{step:t,data:a}),t<3){let a=[];1===t?a=["first_name","last_name"]:2===t&&(a=["guardian_first_name","guardian_last_name","guardian_phone_primary"]),console.log("Validating fields:",a);let b=await A(a);console.log("Validation result:",{step:t,fieldsToValidate:a,isValidStep:b,errors:x}),b?(console.log("Validation passed, moving to step",t+1),u(t+1)):console.log("Validation failed for step",t,"Errors:",x)}else console.log("Final step, validating all fields"),await A(["first_name","last_name","guardian_first_name","guardian_last_name","guardian_phone_primary","enrollment_date"])?(console.log("All fields valid, creating student"),D.mutate(a)):console.log("Final validation failed, errors:",x)},[F,G]=(0,c.useState)(!1),H=B("first_name"),I=B("last_name"),J=B("enrollment_date"),K=B("guardian_first_name"),L=B("guardian_last_name"),M=B("guardian_phone_primary"),N=async()=>{try{if(1===t){let a=await A(["first_name","last_name"]);return G(a),a}if(2===t){let a=await A(["guardian_first_name","guardian_last_name","guardian_phone_primary"]);return G(a),a}if(3===t){let a=await A(["enrollment_date"]);return G(a),a}return G(!0),!0}catch(a){return console.error("Validation error:",a),G(!1),!1}};return((0,c.useEffect)(()=>{N()},[t,H,I,J,K,L,M]),(0,c.useEffect)(()=>{1===t&&N()},[]),q)?(0,b.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,b.jsx)("p",{children:"Chargement..."})}):p?p.organization_id?(0,b.jsxs)("div",{className:"space-y-6",children:[(0,b.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,b.jsx)(n.default,{href:"/dashboard/students",children:(0,b.jsx)(k.Button,{variant:"ghost",size:"icon",children:(0,b.jsx)(m.ArrowLeft,{className:"h-4 w-4"})})}),(0,b.jsxs)("div",{children:[(0,b.jsx)("h1",{className:"text-3xl font-bold text-gray-900",children:"Nouvel élève"}),(0,b.jsx)("p",{className:"mt-2 text-sm text-gray-600",children:"Inscrivez un nouvel élève en quelques étapes"})]})]}),(0,b.jsxs)("div",{className:"flex items-center space-x-2",children:[[1,2,3].map(a=>(0,b.jsxs)("div",{className:"flex-1 flex items-center",children:[(0,b.jsx)("div",{className:`flex-1 h-2 rounded ${t>=a?"bg-primary":"bg-gray-200"}`}),a<3&&(0,b.jsx)("div",{className:`w-2 h-2 rounded-full ${t>a?"bg-primary":"bg-gray-200"}`})]},a)),(0,b.jsxs)("div",{className:"ml-4 text-sm text-muted-foreground",children:["Étape ",t," sur 3"]})]}),(0,b.jsxs)(l.Card,{children:[(0,b.jsx)(l.CardHeader,{children:(0,b.jsxs)(l.CardTitle,{children:[1===t&&"Informations personnelles",2===t&&"Informations du tuteur",3===t&&"Informations académiques"]})}),(0,b.jsx)(l.CardContent,{children:(0,b.jsxs)("form",{onSubmit:w(E),className:"space-y-6",children:[1===t&&(0,b.jsxs)(b.Fragment,{children:[(0,b.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Prénom *"}),(0,b.jsx)("input",{type:"text",required:!0,...v("first_name"),className:"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target"}),x.first_name&&(0,b.jsx)("p",{className:"text-red-500 text-sm mt-1",children:x.first_name.message})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Nom *"}),(0,b.jsx)("input",{type:"text",required:!0,...v("last_name"),className:"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target"}),x.last_name&&(0,b.jsx)("p",{className:"text-red-500 text-sm mt-1",children:x.last_name.message})]})]}),(0,b.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Date de naissance"}),(0,b.jsx)("input",{type:"date",...v("date_of_birth"),className:"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target"}),x.date_of_birth&&(0,b.jsx)("p",{className:"text-red-500 text-sm mt-1",children:x.date_of_birth.message})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Genre"}),(0,b.jsxs)("select",{...v("gender"),className:"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target",children:[(0,b.jsx)("option",{value:"",children:"Sélectionner"}),(0,b.jsx)("option",{value:"male",children:"Masculin"}),(0,b.jsx)("option",{value:"female",children:"Féminin"}),(0,b.jsx)("option",{value:"other",children:"Autre"})]})]})]}),(0,b.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Email"}),(0,b.jsx)("input",{type:"email",...v("email"),className:"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target"}),x.email&&(0,b.jsx)("p",{className:"text-red-500 text-sm mt-1",children:x.email.message})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Téléphone"}),(0,b.jsx)("input",{type:"tel",...v("phone"),className:"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target"}),x.phone&&(0,b.jsx)("p",{className:"text-red-500 text-sm mt-1",children:x.phone.message})]})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Adresse"}),(0,b.jsx)("input",{type:"text",...v("address"),className:"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target"}),x.address&&(0,b.jsx)("p",{className:"text-red-500 text-sm mt-1",children:x.address.message})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Ville"}),(0,b.jsx)("input",{type:"text",...v("city"),className:"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target"}),x.city&&(0,b.jsx)("p",{className:"text-red-500 text-sm mt-1",children:x.city.message})]})]}),2===t&&(0,b.jsxs)(b.Fragment,{children:[(0,b.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Prénom du tuteur *"}),(0,b.jsx)("input",{type:"text",required:!0,...v("guardian_first_name"),className:"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target"}),x.guardian_first_name&&(0,b.jsx)("p",{className:"text-red-500 text-sm mt-1",children:x.guardian_first_name.message})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Nom du tuteur *"}),(0,b.jsx)("input",{type:"text",required:!0,...v("guardian_last_name"),className:"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target"}),x.guardian_last_name&&(0,b.jsx)("p",{className:"text-red-500 text-sm mt-1",children:x.guardian_last_name.message})]})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Lien de parenté *"}),(0,b.jsxs)("select",{required:!0,...v("guardian_relationship"),className:"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target",children:[(0,b.jsx)("option",{value:"parent",children:"Parent"}),(0,b.jsx)("option",{value:"father",children:"Père"}),(0,b.jsx)("option",{value:"mother",children:"Mère"}),(0,b.jsx)("option",{value:"guardian",children:"Tuteur"}),(0,b.jsx)("option",{value:"other",children:"Autre"})]})]}),(0,b.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Téléphone principal *"}),(0,b.jsx)("input",{type:"tel",required:!0,...v("guardian_phone_primary"),className:"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target"}),x.guardian_phone_primary&&(0,b.jsx)("p",{className:"text-red-500 text-sm mt-1",children:x.guardian_phone_primary.message})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Téléphone secondaire"}),(0,b.jsx)("input",{type:"tel",...v("guardian_phone_secondary"),className:"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target"}),x.guardian_phone_secondary&&(0,b.jsx)("p",{className:"text-red-500 text-sm mt-1",children:x.guardian_phone_secondary.message})]})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Email du tuteur"}),(0,b.jsx)("input",{type:"email",...v("guardian_email"),className:"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target"}),x.guardian_email&&(0,b.jsx)("p",{className:"text-red-500 text-sm mt-1",children:x.guardian_email.message})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Adresse du tuteur"}),(0,b.jsx)("input",{type:"text",...v("guardian_address"),className:"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target"}),x.guardian_address&&(0,b.jsx)("p",{className:"text-red-500 text-sm mt-1",children:x.guardian_address.message})]})]}),3===t&&(0,b.jsxs)(b.Fragment,{children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Session"}),(0,b.jsxs)("select",{...v("class_id"),className:"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target",children:[(0,b.jsx)("option",{value:"",children:"Sélectionner une session"}),C?.map(a=>(0,b.jsx)("option",{value:a.id,children:a.name},a.id))]})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Date d'inscription"}),(0,b.jsx)("input",{type:"date",required:!0,...v("enrollment_date"),className:"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target"}),x.enrollment_date&&(0,b.jsx)("p",{className:"text-red-500 text-sm mt-1",children:x.enrollment_date.message})]})]}),(0,b.jsxs)("div",{className:"flex justify-between pt-4",children:[t>1&&(0,b.jsx)(k.Button,{type:"button",variant:"outline",onClick:()=>u(t-1),children:"Précédent"}),(0,b.jsx)("div",{className:"ml-auto",children:(0,b.jsx)(k.Button,{type:"button",onClick:async a=>{if(a.preventDefault(),console.log("Button clicked manually, step:",t),console.log("Current form data:",B()),1===t){let a=await A(["first_name","last_name"]);console.log("Step 1 validation:",a,"Errors:",x),a&&(console.log("Moving to step 2"),u(2))}else if(2===t){let a=await A(["guardian_first_name","guardian_last_name","guardian_phone_primary"]);console.log("Step 2 validation:",a,"Errors:",x),a&&(console.log("Moving to step 3"),u(3))}else await w(E)(a)},disabled:D.isPending,children:t<3?"Suivant":D.isPending?"Création...":"Créer l'élève"})})]}),D.error&&(0,b.jsxs)("div",{className:"bg-destructive/10 text-destructive px-4 py-3 rounded-lg text-sm space-y-1",children:[(0,b.jsx)("p",{className:"font-semibold",children:"Erreur lors de la création de l'élève :"}),(0,b.jsx)("p",{children:D.error instanceof Error?D.error.message:"Une erreur est survenue"}),D.error&&"code"in D.error&&(0,b.jsxs)("p",{className:"text-xs opacity-75",children:["Code d'erreur: ",String(D.error.code),"23505"===D.error.code&&(0,b.jsx)("span",{className:"block mt-1",children:"❌ Un élève avec ce numéro existe déjà. Le système va générer automatiquement un numéro unique lors de la prochaine tentative."})]})]})]})})]})]}):(0,b.jsx)("div",{className:"space-y-6",children:(0,b.jsxs)("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:[(0,b.jsx)("h2",{className:"text-lg font-semibold text-red-800 mb-2",children:"Organization ID manquant"}),(0,b.jsx)("p",{className:"text-red-700 mb-4",children:"Votre compte n'est pas associé à une organisation. Suivez les étapes ci-dessous pour corriger cela."}),(0,b.jsxs)("div",{className:"mt-4 space-y-2",children:[(0,b.jsxs)("p",{className:"text-sm text-red-600",children:["User ID : ",p.id||"Non défini"]}),(0,b.jsxs)("p",{className:"text-sm text-red-600",children:["Email : ",p.email||"Non défini"]}),(0,b.jsxs)("div",{className:"mt-4 p-3 bg-gray-50 rounded",children:[(0,b.jsx)("p",{className:"text-sm font-semibold mb-2",children:"Pour corriger :"}),(0,b.jsxs)("ol",{className:"text-sm text-gray-700 list-decimal list-inside space-y-1",children:[(0,b.jsx)("li",{children:"Allez dans le SQL Editor de Supabase"}),(0,b.jsxs)("li",{children:["Exécutez le script dans ",(0,b.jsx)("code",{className:"bg-gray-200 px-1 rounded",children:"supabase/fix_missing_organization.sql"})]}),(0,b.jsxs)("li",{children:["Ou créez un nouveau compte via ",(0,b.jsx)(n.default,{href:"/auth/register",className:"text-primary underline",children:"/auth/register"})]})]})]})]})]})}):(0,b.jsx)("div",{className:"space-y-6",children:(0,b.jsxs)("div",{className:"bg-warning-bg border border-warning-border rounded-lg p-4",children:[(0,b.jsx)("h2",{className:"text-lg font-semibold text-warning-primary mb-2",children:"Utilisateur non trouvé"}),(0,b.jsx)("p",{className:"text-warning-primary mb-4",children:"Votre compte n'existe pas encore dans la base de données. Cela peut arriver si votre compte a été créé récemment."}),(0,b.jsxs)("div",{className:"mt-4 space-y-2",children:[(0,b.jsxs)("p",{className:"text-sm text-warning-primary",children:["Session ID : ",r?.user?.id||"Non défini"]}),(0,b.jsxs)("p",{className:"text-sm text-warning-primary",children:["Email de session : ",r?.user?.email||"Non défini"]}),(0,b.jsxs)("p",{className:"text-sm text-warning-primary mt-4",children:[(0,b.jsx)("strong",{children:"Solution :"})," Déconnectez-vous et créez un nouveau compte via ",(0,b.jsx)(n.default,{href:"/auth/register",className:"text-primary underline",children:"/auth/register"})]})]})]})})}a.s(["default",()=>p])}];

//# sourceMappingURL=app_%28dashboard%29_dashboard_students_new_page_tsx_8c2aea3e._.js.map