{"version":3,"sources":["../../../../app/%28dashboard%29/dashboard/documents/generate/page.tsx"],"sourcesContent":["'use client'\n\nimport { useState, useEffect } from 'react'\nimport { useRouter } from 'next/navigation'\nimport { useQuery, useMutation, useQueryClient } from '@tanstack/react-query'\nimport { useAuth } from '@/lib/hooks/use-auth'\nimport { createClient } from '@/lib/supabase/client'\nimport { documentService } from '@/lib/services/document.service'\nimport { programService } from '@/lib/services/program.service'\nimport { generatePDFFromHTML, generateSimplePDF, generatePDFBlobFromHTML } from '@/lib/utils/pdf-generator'\nimport { generateHTML } from '@/lib/utils/document-generation/html-generator'\nimport { extractDocumentVariables, mapDocumentTypeToTemplateType } from '@/lib/utils/document-generation/variable-extractor'\nimport { documentTemplateService } from '@/lib/services/document-template.service'\nimport { emailTemplateService } from '@/lib/services/email-template.service'\nimport { TemplateSelector } from '@/components/document-editor/template-selector'\nimport { Button } from '@/components/ui/button'\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from '@/components/ui/select'\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from '@/components/ui/dialog'\nimport { \n  ArrowLeft, Download, FileText, Receipt, FileCheck, Calendar, \n  ClipboardList, Award, GraduationCap, BookOpen, UserCheck, \n  Shield, Scale, Book, CheckCircle, Mail, Send, X, CheckCircle2\n} from 'lucide-react'\nimport Link from 'next/link'\nimport type { StudentWithRelations, SessionWithRelations, InvoiceWithRelations } from '@/lib/types/query-types'\nimport type { TableRow } from '@/lib/types/supabase-helpers'\nimport type { DocumentType } from '@/lib/types/document-templates'\n\ntype Organization = TableRow<'organizations'>\ntype Student = TableRow<'students'>\ntype Session = TableRow<'sessions'>\ntype Invoice = TableRow<'invoices'>\n\nexport default function GenerateDocumentPage() {\n  const router = useRouter()\n  const { user } = useAuth()\n  const supabase = createClient()\n\n  const [documentType, setDocumentType] = useState<DocumentType | ''>('')\n  const [selectedStudentId, setSelectedStudentId] = useState<string>('')\n  const [selectedInvoiceId, setSelectedInvoiceId] = useState<string>('')\n  const [selectedPaymentId, setSelectedPaymentId] = useState<string>('')\n  const [selectedSessionId, setSelectedSessionId] = useState<string>('')\n  const [selectedProgramId, setSelectedProgramId] = useState<string>('')\n  const [selectedTemplateId, setSelectedTemplateId] = useState<string>('')\n  const [language, setLanguage] = useState<'fr' | 'en'>('fr')\n  const [exportFormat, setExportFormat] = useState<'pdf' | 'word'>('pdf')\n  const [isGenerating, setIsGenerating] = useState(false)\n  const [showShareConfirmation, setShowShareConfirmation] = useState(false)\n  const [pendingDocumentData, setPendingDocumentData] = useState<any>(null)\n  const [userRole, setUserRole] = useState<string | null>(null)\n  const [generatedDocument, setGeneratedDocument] = useState<{\n    fileUrl: string\n    filename: string\n    title: string\n    studentId?: string\n    student?: StudentWithRelations\n  } | null>(null)\n  const [showEmailModal, setShowEmailModal] = useState(false)\n  const [emailForm, setEmailForm] = useState({\n    to: '',\n    subject: '',\n    message: '',\n  })\n  const [selectedEmailTemplateId, setSelectedEmailTemplateId] = useState<string>('')\n  const [sendingEmail, setSendingEmail] = useState(false)\n  const queryClient = useQueryClient()\n\n  // Récupérer les élèves - Filtrés par session si une session est sélectionnée\n  const { data: students } = useQuery<Array<{ id: string; first_name?: string; last_name?: string; student_number?: string; [key: string]: any }>>({\n    queryKey: ['students', user?.organization_id, selectedSessionId],\n    queryFn: async () => {\n      if (!user?.organization_id) return []\n      \n      // Si une session est sélectionnée, récupérer les étudiants de cette session\n      if (selectedSessionId) {\n        // Récupérer les inscriptions à la session depuis la table enrollments\n        const { data: enrollments, error: enrollmentsError } = await supabase\n          .from('enrollments')\n          .select('student_id')\n          .eq('session_id', selectedSessionId)\n          .in('status', ['confirmed', 'completed', 'active'])\n        \n        if (enrollmentsError) {\n          console.warn('Erreur lors de la récupération des inscriptions:', enrollmentsError)\n          // Continuer avec tous les étudiants si erreur\n        } else if (enrollments && enrollments.length > 0) {\n          const studentIds = (enrollments as Array<{ student_id: string }>).map(e => e.student_id).filter(Boolean)\n          if (studentIds.length > 0) {\n            const { data, error } = await supabase\n              .from('students')\n              .select('id, first_name, last_name, student_number, date_of_birth, photo_url, class_id, classes(name)')\n              .eq('organization_id', user.organization_id)\n              .eq('status', 'active')\n              .in('id', studentIds)\n              .order('last_name')\n            if (error) throw error\n            return data || []\n          }\n        }\n      }\n      \n      // Sinon, récupérer tous les étudiants actifs\n      const { data, error } = await supabase\n        .from('students')\n        .select('id, first_name, last_name, student_number, date_of_birth, photo_url, class_id, classes(name)')\n        .eq('organization_id', user.organization_id)\n        .eq('status', 'active')\n        .order('last_name')\n      if (error) throw error\n      return data || []\n    },\n    enabled: !!user?.organization_id,\n  })\n\n      // Récupérer les factures\n  const { data: invoices } = useQuery({\n    queryKey: ['invoices', user?.organization_id],\n    queryFn: async () => {\n      if (!user?.organization_id) return []\n      \n      // Essayer d'abord avec la jointure complète\n      let query = supabase\n        .from('invoices')\n        .select('id, invoice_number, student_id, issue_date, due_date, amount, tax_amount, total_amount, currency, items, students(first_name, last_name, student_number)')\n        .eq('organization_id', user.organization_id)\n        .order('created_at', { ascending: false })\n        .limit(100)\n      \n      const { data, error } = await query\n      \n      // Si erreur 400, réessayer sans la jointure students\n      if (error && (error.code === 'PGRST116' || error.message?.includes('400') || error.message?.includes('relationship'))) {\n        console.warn('Erreur récupération factures avec jointure, réessai sans jointure:', error)\n        const { data: invoicesData, error: invoicesError } = await supabase\n          .from('invoices')\n          .select('id, invoice_number, student_id, issue_date, due_date, amount, tax_amount, total_amount, currency, items')\n          .eq('organization_id', user.organization_id)\n          .order('created_at', { ascending: false })\n          .limit(100)\n        \n        if (invoicesError) {\n          console.error('Erreur récupération factures:', invoicesError)\n          return []\n        }\n        \n        // Enrichir avec les données des étudiants si possible\n        if (invoicesData && invoicesData.length > 0) {\n          const studentIds = (invoicesData as Array<{ student_id: string }>).map(inv => inv.student_id).filter(Boolean)\n          if (studentIds.length > 0) {\n            const { data: studentsData } = await supabase\n              .from('students')\n              .select('id, first_name, last_name, student_number')\n              .in('id', studentIds)\n            \n            if (studentsData) {\n              const studentsMap = new Map((studentsData as Array<{ id: string; [key: string]: any }>).map(s => [s.id, s]))\n              return (invoicesData as Array<{ id: string; student_id?: string; [key: string]: any }>).map(inv => ({\n                ...inv,\n                students: inv.student_id ? studentsMap.get(inv.student_id) || null : null\n              })) as Array<{ id: string; students?: { id: string; [key: string]: any } | null; student_id?: string; [key: string]: any }>\n            }\n          }\n        }\n        \n        return (invoicesData || []) as Array<{ id: string; students?: { id: string; [key: string]: any } | null; student_id?: string; [key: string]: any }>\n      }\n      \n      if (error) {\n        console.error('Erreur récupération factures:', error)\n        return []\n      }\n      \n      return (data || []) as Array<{ id: string; students?: { id: string; [key: string]: any } | null; student_id?: string; [key: string]: any }>\n    },\n    enabled: !!user?.organization_id && (documentType === 'facture' || documentType === 'devis'),\n  })\n\n  // Récupérer le rôle de l'utilisateur\n  const { data: currentUser } = useQuery({\n    queryKey: ['current-user', user?.id],\n    queryFn: async () => {\n      if (!user?.id) return null\n      const { data, error } = await supabase\n        .from('users')\n        .select('role')\n        .eq('id', user.id)\n        .single()\n      if (error) throw error\n      return data\n    },\n    enabled: !!user?.id,\n  })\n\n  // Mettre à jour le rôle utilisateur quand les données changent\n  useEffect(() => {\n    if (currentUser) {\n      setUserRole((currentUser as any).role)\n    }\n  }, [currentUser])\n\n  // Récupérer l'organisation\n  const { data: organization } = useQuery<{ id: string; [key: string]: any } | null>({\n    queryKey: ['organization', user?.organization_id],\n    queryFn: async () => {\n      if (!user?.organization_id) return null\n      const { data, error } = await supabase\n        .from('organizations')\n        .select('*')\n        .eq('id', user.organization_id)\n        .single()\n      if (error) throw error\n      return data as { id: string; [key: string]: any } | null\n    },\n    enabled: !!user?.organization_id,\n  })\n\n  // Récupérer les programmes - Disponible pour le type \"programme\"\n  const { data: programs } = useQuery({\n    queryKey: ['programs', user?.organization_id],\n    queryFn: async () => {\n      if (!user?.organization_id) return []\n      return programService.getAllPrograms(user.organization_id, { isActive: true })\n    },\n    enabled: !!user?.organization_id && documentType === 'programme',\n  })\n\n  // Récupérer un programme avec ses formations - Pour le programme sélectionné\n  const { data: selectedProgram } = useQuery({\n    queryKey: ['program', selectedProgramId],\n    queryFn: async () => {\n      if (!selectedProgramId) return null\n      return programService.getProgramById(selectedProgramId)\n    },\n    enabled: !!selectedProgramId && documentType === 'programme',\n  })\n\n  // Récupérer les sessions - Toujours disponible pour tous les types de documents\n  const { data: sessions } = useQuery<Array<{ id: string; [key: string]: any }>>({\n    queryKey: ['sessions', user?.organization_id],\n    queryFn: async () => {\n      if (!user?.organization_id) return []\n      const { data, error } = await supabase\n        .from('sessions')\n        .select('id, name, formation_id, formations(name, duration_hours, programs(name)), start_date, end_date')\n        .eq('formations.organization_id', user.organization_id)\n        .order('start_date', { ascending: false })\n        .limit(50)\n      if (error) throw error\n      return (data || []) as Array<{ id: string; [key: string]: any }>\n    },\n    enabled: !!user?.organization_id && !!documentType,\n  })\n  \n  // Réinitialiser l'apprenant sélectionné quand la session change\n  useEffect(() => {\n    if (selectedSessionId && selectedStudentId) {\n      // Vérifier si l'apprenant sélectionné est toujours dans la liste filtrée\n      const studentStillAvailable = (students as Array<{ id: string; [key: string]: any }> | undefined)?.some(s => s.id === selectedStudentId)\n      if (!studentStillAvailable) {\n        setSelectedStudentId('')\n      }\n    }\n  }, [selectedSessionId, students, selectedStudentId])\n\n  // Récupérer l'année académique actuelle\n  const { data: academicYear } = useQuery({\n    queryKey: ['academic-year', user?.organization_id],\n    queryFn: async () => {\n      if (!user?.organization_id) return null\n      const { data, error } = await supabase\n        .from('academic_years')\n        .select('*')\n        .eq('organization_id', user.organization_id)\n        .eq('is_current', true)\n        .maybeSingle()\n      if (error) {\n        console.warn('Erreur lors de la récupération de l\\'année académique:', error)\n        return null\n      }\n      return data || null\n    },\n    enabled: !!user?.organization_id,\n  })\n\n  // Récupérer le template sélectionné\n  const { data: selectedTemplate } = useQuery({\n    queryKey: ['document-template', selectedTemplateId],\n    queryFn: async () => {\n      if (!selectedTemplateId) return null\n      return documentTemplateService.getTemplateById(selectedTemplateId)\n    },\n    enabled: !!selectedTemplateId,\n  })\n\n\n  const handleGenerate = async () => {\n    if (!documentType || !organization) return\n    if (!selectedTemplateId || !selectedTemplate) {\n      alert('Veuillez sélectionner un modèle de document')\n      return\n    }\n\n    setIsGenerating(true)\n\n    try {\n      // Extraire les données nécessaires\n      let student: StudentWithRelations | undefined\n      let session: SessionWithRelations | undefined\n      let invoice: InvoiceWithRelations | undefined\n      let program: any = null\n\n      if (selectedStudentId) {\n        student = (students as StudentWithRelations[])?.find((s) => s.id === selectedStudentId)\n      }\n\n      if (selectedSessionId) {\n        session = sessions?.find((s) => s.id === selectedSessionId) as SessionWithRelations | undefined\n      }\n\n      if (selectedProgramId && selectedProgram) {\n        program = selectedProgram\n      }\n\n      if (selectedInvoiceId) {\n        invoice = invoices?.find((i) => i.id === selectedInvoiceId) as InvoiceWithRelations | undefined\n        // Si une facture est sélectionnée, extraire l'étudiant depuis la facture si disponible\n        if (invoice && (invoice as any).students && !student) {\n          student = (invoice as any).students as StudentWithRelations\n        }\n      }\n\n      // Extraire les variables\n      const variables = extractDocumentVariables({\n        student,\n        organization: organization as Organization,\n        session,\n        invoice,\n        program,\n        academicYear,\n        language,\n        issueDate: new Date().toISOString(),\n      })\n      \n      console.log('[Generate] Variables extraites:', {\n        hasStudent: !!student,\n        studentName: student ? `${student.first_name} ${student.last_name}` : 'N/A',\n        hasInvoice: !!invoice,\n        invoiceNumber: invoice?.invoice_number,\n        hasSession: !!session,\n        sessionName: session?.name,\n        variablesCount: Object.keys(variables).length,\n        sampleVariables: {\n          eleve_nom: variables.eleve_nom,\n          eleve_prenom: variables.eleve_prenom,\n          numero_facture: variables.numero_facture,\n          formation_nom: variables.formation_nom,\n          session_nom: variables.session_nom,\n        },\n      })\n\n      // Générer le nom de fichier selon le format\n      const fileExtension = exportFormat === 'word' ? '.docx' : '.pdf'\n      let filename = `document${fileExtension}`\n      if (student) {\n        filename = `${documentType}_${student.last_name}_${student.first_name}${fileExtension}`\n      } else if (invoice) {\n        filename = `facture_${invoice.invoice_number}${fileExtension}`\n      } else {\n        filename = `${documentType}_${Date.now()}${fileExtension}`\n      }\n\n      // Utiliser l'API pour générer le document (PDF ou Word)\n      let documentBlob: Blob | null = null\n      \n      let apiEndpoint: string\n      let requestBody: any\n      \n      if (exportFormat === 'word') {\n        // Génération Word automatique (convertit HTML en DOCX automatiquement)\n        // Plus besoin d'uploader un template DOCX manuellement !\n        apiEndpoint = '/api/documents/generate-docx'\n        requestBody = {\n          templateId: selectedTemplateId,\n          variables: variables,\n          filename: filename,\n        }\n        console.log('[Generate] Génération Word automatique depuis template HTML')\n      } else {\n        // PDF : utiliser le générateur PDF standard\n        apiEndpoint = '/api/documents/generate-pdf'\n        requestBody = {\n          template: selectedTemplate,\n          variables: variables,\n          documentId: undefined,\n          organizationId: organization?.id,\n        }\n      }\n      \n      const contentType = exportFormat === 'word' ? 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' : 'application/pdf'\n      \n      try {\n        const response = await fetch(apiEndpoint, {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json',\n          },\n          body: JSON.stringify(requestBody),\n        })\n\n        if (!response.ok) {\n          // Vérifier si la réponse est du JSON ou du HTML\n          const responseContentType = response.headers.get('content-type')\n          if (responseContentType && responseContentType.includes('application/json')) {\n            const errorData = await response.json()\n            // Logger les détails complets de l'erreur pour déboguer\n            console.error(`[Generate ${exportFormat.toUpperCase()}] Erreur détaillée:`, errorData)\n            if (errorData.templateInfo) {\n              console.error(`[Generate ${exportFormat.toUpperCase()}] Template info:`, errorData.templateInfo)\n            }\n            if (errorData.stack) {\n              console.error(`[Generate ${exportFormat.toUpperCase()}] Stack trace:`, errorData.stack)\n            }\n            throw new Error(errorData.error || errorData.message || errorData.details || `Erreur lors de la génération du ${exportFormat === 'word' ? 'document Word' : 'PDF'}`)\n          } else {\n            // Si c'est du HTML (page d'erreur Next.js), lire le texte\n            const errorText = await response.text()\n            console.error('Erreur HTML reçue:', errorText.substring(0, 500))\n            throw new Error(`Erreur serveur (${response.status}): ${response.statusText}`)\n          }\n        }\n\n        // Télécharger le document (PDF ou Word)\n        documentBlob = await response.blob()\n        const url = URL.createObjectURL(documentBlob)\n        const link = document.createElement('a')\n        link.href = url\n        link.download = filename\n        document.body.appendChild(link)\n        link.click()\n        document.body.removeChild(link)\n        URL.revokeObjectURL(url)\n        \n        // Sauvegarder le document dans la base de données\n        if (documentBlob && user?.organization_id && selectedTemplate) {\n          try {\n            // Déterminer l'ID de l'étudiant pour le document généré (avant l'upload)\n            const invoiceStudentId = invoice?.student_id || (invoice as any)?.students?.id\n            \n            // 1. Uploader le document (PDF ou Word) dans Supabase Storage\n            const storagePath = `documents/${user.organization_id}/${Date.now()}_${filename}`\n            const { data: uploadData, error: uploadError } = await supabase.storage\n              .from('documents')\n              .upload(storagePath, documentBlob, {\n                cacheControl: '3600',\n                upsert: false,\n                contentType: contentType,\n              })\n            \n            if (uploadError) {\n              console.error('Erreur lors de l\\'upload du document:', uploadError)\n              // Même si l'upload échoue, on stocke le blob URL pour permettre le téléchargement\n              const tempUrl = URL.createObjectURL(documentBlob)\n              const docData = {\n                fileUrl: tempUrl,\n                filename: filename,\n                title: selectedTemplate.name || filename,\n                studentId: student?.id || invoiceStudentId,\n                student: student || (invoiceStudentId ? (invoice as any)?.students : undefined),\n              }\n              setGeneratedDocument(docData)\n              console.log('[Generate] Document généré stocké (upload échoué):', docData)\n            } else if (uploadData) {\n              // 2. Obtenir l'URL publique\n              const { data: urlData } = supabase.storage\n                .from('documents')\n                .getPublicUrl(storagePath)\n              \n              // Stocker les informations du document généré pour les actions AVANT la sauvegarde\n              const docData = {\n                fileUrl: urlData.publicUrl,\n                filename: filename,\n                title: selectedTemplate.name || filename,\n                studentId: student?.id || invoiceStudentId,\n                student: student || (invoiceStudentId ? (invoice as any)?.students : undefined),\n              }\n              setGeneratedDocument(docData)\n              console.log('[Generate] Document généré stocké (upload réussi):', docData)\n              \n              // 3. Sauvegarder dans generated_documents\n              const documentData: any = {\n                organization_id: user.organization_id,\n                template_id: selectedTemplate.id,\n                type: mapDocumentTypeToTemplateType(documentType) as any,\n                file_name: filename,\n                file_url: urlData.publicUrl,\n                format: exportFormat,\n                page_count: exportFormat === 'pdf' ? 1 : undefined, // Le nombre de pages sera calculé par Puppeteer pour PDF\n                metadata: {\n                  student: student ? {\n                    id: student.id,\n                    name: `${student.first_name} ${student.last_name}`,\n                  } : null,\n                  session: session ? {\n                    id: session.id,\n                    name: session.name,\n                  } : null,\n                  invoice: invoice ? {\n                    id: invoice.id,\n                    invoice_number: invoice.invoice_number,\n                  } : null,\n                  language,\n                  generated_at: new Date().toISOString(),\n                },\n                generated_by: user.id,\n              }\n              \n              // Déterminer si le document concerne un apprenant\n              // Les factures ont un student_id, donc elles concernent toujours un apprenant\n              // invoiceStudentId déjà déclaré plus haut dans le bloc try\n              const documentConcernsStudent = !!(student || invoiceStudentId || session)\n              \n              // Définir related_entity_type et related_entity_id pour rendre le document accessible à l'apprenant\n              // Priorité: student > invoice.student_id > session\n              if (student) {\n                documentData.related_entity_type = 'student'\n                documentData.related_entity_id = student.id\n              } else if (invoiceStudentId) {\n                // Les factures concernent un étudiant, donc on lie directement à l'étudiant\n                documentData.related_entity_type = 'student'\n                documentData.related_entity_id = invoiceStudentId\n              } else if (session) {\n                // Les sessions sont accessibles via les enrollments (géré par RLS)\n                documentData.related_entity_type = 'session'\n                documentData.related_entity_id = session.id\n              }\n              \n              // Vérifier si le document doit être partagé avec l'apprenant\n              const documentTypeMapped = mapDocumentTypeToTemplateType(documentType)\n              const isTranscript = documentTypeMapped === 'releve_notes'\n              const userCanShare = userRole && \n                ['super_admin', 'admin', 'comptable', 'secretaire'].includes(userRole)\n              \n              // Si le document concerne un apprenant et que l'utilisateur a le droit de partager\n              if (documentConcernsStudent && userCanShare) {\n                // Pour les relevés de notes, demander confirmation\n                if (isTranscript) {\n                  setPendingDocumentData(documentData)\n                  setShowShareConfirmation(true)\n                  return // Ne pas sauvegarder maintenant, attendre la confirmation\n                } else {\n                  // Pour les autres documents, partager automatiquement\n                  // Le document sera automatiquement visible par l'apprenant via RLS grâce à related_entity_type et related_entity_id\n                  console.log('Document partagé automatiquement avec l\\'apprenant')\n                }\n              } else if (!documentConcernsStudent) {\n                // Si le document ne concerne pas un apprenant, ne pas définir related_entity_type/id\n                // Cela signifie que le document ne sera pas accessible aux apprenants\n                delete documentData.related_entity_type\n                delete documentData.related_entity_id\n              } else if (!userCanShare) {\n                // Si l'utilisateur n'a pas le droit de partager, ne pas définir related_entity_type/id\n                delete documentData.related_entity_type\n                delete documentData.related_entity_id\n              }\n              \n              // Sauvegarder le document\n              const { error: saveError } = await supabase\n                .from('generated_documents')\n                .insert(documentData)\n\n              if (saveError) {\n                console.error('Erreur lors de la sauvegarde du document:', saveError)\n              } else {\n                console.log('Document sauvegardé avec succès dans generated_documents')\n              }\n            }\n          } catch (saveError) {\n            console.error('Erreur lors de la sauvegarde du document:', saveError)\n            // Ne pas bloquer l'utilisateur si la sauvegarde échoue\n          }\n        }\n      } catch (error) {\n        console.error('Erreur lors de la génération du PDF:', error)\n        alert('Une erreur est survenue lors de la génération du document')\n      } finally {\n        setIsGenerating(false)\n      }\n    } catch (error) {\n      console.error('Erreur lors de la génération du document:', error)\n      alert('Une erreur est survenue lors de la génération du document')\n      setIsGenerating(false)\n    }\n  }\n\n  // Gérer la confirmation de partage pour les relevés de notes\n  const handleShareConfirmation = async (shouldShare: boolean) => {\n    if (!pendingDocumentData) return\n\n    setShowShareConfirmation(false)\n\n    // Si l'utilisateur choisit de ne pas partager, retirer la relation avec l'étudiant\n    const documentDataToSave = { ...pendingDocumentData }\n    if (!shouldShare) {\n      // Ne pas partager : retirer related_entity_type et related_entity_id pour l'étudiant\n      // Mais garder l'information dans les métadonnées pour référence\n      delete documentDataToSave.related_entity_type\n      delete documentDataToSave.related_entity_id\n      console.log('Document non partagé avec l\\'apprenant (relevé de notes)')\n    } else {\n      console.log('Document partagé avec l\\'apprenant')\n    }\n\n    // Sauvegarder le document\n    const { error: saveError } = await supabase\n      .from('generated_documents')\n      .insert(documentDataToSave)\n    \n    if (saveError) {\n      console.error('Erreur lors de la sauvegarde du document:', saveError)\n      alert('Erreur lors de la sauvegarde du document')\n    } else {\n      console.log('Document sauvegardé avec succès dans generated_documents')\n    }\n\n    setPendingDocumentData(null)\n    setIsGenerating(false)\n  }\n\n  // Réinitialiser le template sélectionné quand le type de document change\n  useEffect(() => {\n    setSelectedTemplateId('')\n    setGeneratedDocument(null)\n  }, [documentType])\n\n  // Fonction pour télécharger le document\n  const handleDownload = () => {\n    if (!generatedDocument) return\n    const link = document.createElement('a')\n    link.href = generatedDocument.fileUrl\n    link.download = generatedDocument.filename\n    document.body.appendChild(link)\n    link.click()\n    document.body.removeChild(link)\n  }\n\n  // Fonction pour ouvrir le modal d'envoi par email\n  const handleOpenEmailModal = async () => {\n    if (!generatedDocument) return\n    \n    let studentEmails: string[] = []\n    \n    // Récupérer l'email de l'étudiant depuis sa fiche\n    if (generatedDocument.studentId) {\n      const { data: studentData, error: studentError } = await supabase\n        .from('students')\n        .select('email, first_name, last_name')\n        .eq('id', generatedDocument.studentId)\n        .single()\n      \n      if (!studentError && studentData) {\n        // Ajouter l'email de l'étudiant s'il est renseigné\n        const student = studentData as { email?: string; first_name?: string; last_name?: string }\n        if (student.email) {\n          studentEmails.push(student.email)\n        }\n        \n        // Récupérer les emails des tuteurs/guardians\n        const { data: guardiansData, error: guardiansError } = await supabase\n          .from('student_guardians')\n          .select('*, guardians(email)')\n          .eq('student_id', generatedDocument.studentId)\n        \n        if (!guardiansError && guardiansData) {\n          guardiansData.forEach((sg: any) => {\n            if (sg.guardians?.email) {\n              studentEmails.push(sg.guardians.email)\n            }\n          })\n        }\n        \n        // Dédupliquer les emails\n        studentEmails = [...new Set(studentEmails)]\n        \n        const subject = `${generatedDocument.title}`\n        const studentName = `${student.first_name || ''} ${student.last_name || ''}`.trim()\n        const message = `Bonjour ${studentName || 'Madame, Monsieur'},\\n\\nVeuillez trouver ci-joint votre document.\\n\\nCordialement,\\nL'équipe EDUZEN`\n\n        setEmailForm({\n          to: studentEmails.join(', '), // Joindre plusieurs emails avec des virgules\n          subject,\n          message,\n        })\n      } else {\n        // Fallback si l'étudiant n'est pas trouvé\n        const studentEmail = generatedDocument.student?.email || ''\n        const subject = `${generatedDocument.title}`\n        const message = `Bonjour ${generatedDocument.student?.first_name || ''} ${generatedDocument.student?.last_name || ''},\\n\\nVeuillez trouver ci-joint votre document.\\n\\nCordialement,\\nL'équipe EDUZEN`\n\n        setEmailForm({\n          to: studentEmail,\n          subject,\n          message,\n        })\n      }\n    } else {\n      // Si pas d'étudiant associé, laisser vide\n      setEmailForm({\n        to: '',\n        subject: generatedDocument.title,\n        message: 'Bonjour,\\n\\nVeuillez trouver ci-joint votre document.\\n\\nCordialement,\\nL\\'équipe EDUZEN',\n      })\n    }\n    \n    setShowEmailModal(true)\n  }\n\n  // Fonction pour envoyer le document par email\n  const handleSendEmail = async () => {\n    if (!generatedDocument || !emailForm.to) {\n      alert('Veuillez renseigner l\\'adresse email du destinataire')\n      return\n    }\n\n    setSendingEmail(true)\n    try {\n      const response = await fetch('/api/send-email', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          to: emailForm.to,\n          subject: emailForm.subject,\n          message: emailForm.message,\n          attachmentUrl: generatedDocument.fileUrl,\n          attachmentName: generatedDocument.filename,\n        }),\n      })\n\n      if (!response.ok) throw new Error('Erreur lors de l\\'envoi de l\\'email')\n\n      alert('Email envoyé avec succès !')\n      setShowEmailModal(false)\n      setEmailForm({ to: '', subject: '', message: '' })\n    } catch (error) {\n      console.error('Erreur lors de l\\'envoi de l\\'email:', error)\n      alert('Erreur lors de l\\'envoi de l\\'email')\n    } finally {\n      setSendingEmail(false)\n    }\n  }\n\n  // Mutation pour envoyer le document vers l'espace apprenant\n  const sendToLearnerSpaceMutation = useMutation({\n    mutationFn: async () => {\n      if (!generatedDocument || !generatedDocument.studentId) {\n        throw new Error('Ce document n\\'est pas lié à un étudiant')\n      }\n\n      if (!user?.organization_id) {\n        throw new Error('Organisation ID manquant')\n      }\n\n      let fileUrl = generatedDocument.fileUrl\n\n      // Si l'URL est une blob URL (temporaire), il faut ré-uploader le fichier\n      if (fileUrl.startsWith('blob:') || fileUrl.startsWith('data:')) {\n        // Télécharger le fichier depuis l'URL pour l'uploader\n        const fileResponse = await fetch(generatedDocument.fileUrl)\n        if (!fileResponse.ok) {\n          throw new Error('Impossible de télécharger le fichier')\n        }\n        const fileBlob = await fileResponse.blob()\n        const file = new File([fileBlob], generatedDocument.filename, { type: 'application/pdf' })\n\n        // Uploader le fichier dans Supabase Storage\n        const storagePath = `learner_documents/${user.organization_id}/${generatedDocument.studentId}/${Date.now()}_${generatedDocument.filename}`\n        const { data: uploadData, error: uploadError } = await supabase.storage\n          .from('documents')\n          .upload(storagePath, file, {\n            cacheControl: '3600',\n            upsert: false,\n            contentType: 'application/pdf',\n          })\n\n        if (uploadError) throw uploadError\n\n        // Obtenir l'URL publique\n        const { data: urlData } = supabase.storage\n          .from('documents')\n          .getPublicUrl(storagePath)\n        \n        fileUrl = urlData.publicUrl\n      }\n\n      // Mapper le type de document pour learner_documents\n      const documentTypeMapped = mapDocumentTypeToTemplateType(documentType)\n\n      // Créer une entrée dans learner_documents\n      const { error } = await supabase\n        .from('learner_documents')\n        .insert({\n          student_id: generatedDocument.studentId,\n          title: generatedDocument.title,\n          file_url: fileUrl,\n          type: documentTypeMapped || documentType || 'other',\n          organization_id: user.organization_id,\n          sent_at: new Date().toISOString(),\n          sent_by: user.id,\n        } as any)\n\n      if (error) {\n        console.error('Erreur lors de l\\'insertion dans learner_documents:', error)\n        throw error\n      }\n    },\n    onSuccess: () => {\n      alert('Document envoyé dans l\\'espace apprenant avec succès !')\n      queryClient.invalidateQueries({ queryKey: ['learner-documents'] })\n    },\n    onError: (error: any) => {\n      console.error('Erreur lors de l\\'envoi vers l\\'espace apprenant:', error)\n      alert(error.message || 'Erreur lors de l\\'envoi vers l\\'espace apprenant')\n    },\n  })\n\n  // Configuration des types de documents disponibles (même que dans la page des modèles)\n  const DOCUMENT_TYPES: Array<{\n    type: DocumentType\n    name: string\n    description: string\n    icon: React.ElementType\n    color: string\n    requiresStudent?: boolean\n    requiresSession?: boolean\n    requiresInvoice?: boolean\n  }> = [\n    {\n      type: 'convention',\n      name: 'Convention de formation',\n      description: 'Contrat entre l\\'établissement et l\\'apprenant',\n      icon: FileText,\n      color: '#335ACF',\n      requiresStudent: true,\n    },\n    {\n      type: 'facture',\n      name: 'Facture',\n      description: 'Document comptable de facturation',\n      icon: Receipt,\n      color: '#335ACF',\n      requiresInvoice: true,\n    },\n    {\n      type: 'devis',\n      name: 'Devis',\n      description: 'Estimation de prix avant formation',\n      icon: FileCheck,\n      color: '#34B9EE',\n      requiresInvoice: true,\n    },\n    {\n      type: 'convocation',\n      name: 'Convocation',\n      description: 'Invitation à une session ou examen',\n      icon: Calendar,\n      color: '#335ACF',\n      requiresSession: true,\n    },\n    {\n      type: 'contrat',\n      name: 'Contrat de scolarité',\n      description: 'Accord de scolarisation officiel',\n      icon: ClipboardList,\n      color: '#335ACF',\n      requiresStudent: true,\n    },\n    {\n      type: 'attestation_reussite',\n      name: 'Attestation de réussite',\n      description: 'Certificat de réussite à une formation',\n      icon: Award,\n      color: '#335ACF',\n      requiresStudent: true,\n      requiresSession: true,\n    },\n    {\n      type: 'certificat_scolarite',\n      name: 'Certificat de scolarité',\n      description: 'Justificatif d\\'inscription dans l\\'établissement',\n      icon: GraduationCap,\n      color: '#335ACF',\n      requiresStudent: true,\n    },\n    {\n      type: 'releve_notes',\n      name: 'Relevé de notes',\n      description: 'Bulletin de notes et appréciations',\n      icon: BookOpen,\n      color: '#34B9EE',\n      requiresStudent: true,\n      requiresSession: true,\n    },\n    {\n      type: 'attestation_entree',\n      name: 'Attestation d\\'entrée en formation',\n      description: 'Certificat d\\'inscription à une formation',\n      icon: UserCheck,\n      color: '#335ACF',\n      requiresStudent: true,\n      requiresSession: true,\n    },\n    {\n      type: 'reglement_interieur',\n      name: 'Règlement intérieur',\n      description: 'Règles et procédures de l\\'établissement',\n      icon: Shield,\n      color: '#335ACF',\n    },\n    {\n      type: 'cgv',\n      name: 'Conditions Générales de Vente',\n      description: 'CGV et conditions d\\'utilisation',\n      icon: Scale,\n      color: '#34B9EE',\n    },\n    {\n      type: 'programme',\n      name: 'Programme de formation',\n      description: 'Détails du contenu pédagogique',\n      icon: Book,\n      color: '#335ACF',\n    },\n    {\n      type: 'attestation_assiduite',\n      name: 'Attestation d\\'assiduité',\n      description: 'Justificatif de présence aux cours',\n      icon: CheckCircle,\n      color: '#335ACF',\n      requiresStudent: true,\n      requiresSession: true,\n    },\n  ]\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center space-x-4\">\n        <Link href=\"/dashboard/documents\">\n          <Button variant=\"ghost\" size=\"icon\">\n            <ArrowLeft className=\"h-4 w-4\" />\n          </Button>\n        </Link>\n        <div>\n          <h1 className=\"text-3xl font-bold text-gray-900\">Générer un document</h1>\n          <p className=\"mt-2 text-sm text-gray-600\">\n            Créez et téléchargez vos documents PDF\n          </p>\n        </div>\n      </div>\n\n      <div className=\"space-y-6\">\n        {/* Formulaire */}\n        <div className=\"space-y-6\">\n          <Card>\n            <CardHeader>\n              <CardTitle>Type de document</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4\">\n                {DOCUMENT_TYPES.map((type) => {\n                  const Icon = type.icon\n                  return (\n                    <button\n                      key={type.type}\n                      type=\"button\"\n                      onClick={() => setDocumentType(type.type)}\n                      className={`p-4 border-2 rounded-lg text-left transition-colors ${\n                        documentType === type.type\n                          ? 'border-primary bg-primary/5'\n                          : 'border-gray-200 hover:border-gray-300'\n                      }`}\n                    >\n                      <div className=\"flex items-center gap-3 mb-2\">\n                        <div\n                          className=\"p-2 rounded-lg\"\n                          style={{ backgroundColor: `${type.color}15` }}\n                        >\n                          <Icon className=\"h-5 w-5\" style={{ color: type.color }} />\n                        </div>\n                        <div className=\"font-medium text-sm\">{type.name}</div>\n                      </div>\n                      <div className=\"text-xs text-gray-600\">{type.description}</div>\n                    </button>\n                  )\n                })}\n              </div>\n            </CardContent>\n          </Card>\n\n          {documentType && (\n            <>\n              {/* Sélecteur de template */}\n              <TemplateSelector\n                documentType={documentType}\n                selectedTemplateId={selectedTemplateId}\n                onTemplateSelect={setSelectedTemplateId}\n                onCreateNew={() => {\n                  router.push(`/dashboard/settings/document-templates/${documentType}/edit`)\n                }}\n                onDuplicate={async (templateId) => {\n                  try {\n                    const duplicated = await documentTemplateService.duplicateTemplate(templateId)\n                    setSelectedTemplateId(duplicated.id)\n                    alert('Modèle dupliqué avec succès')\n                  } catch (error) {\n                    console.error('Erreur lors de la duplication:', error)\n                    alert('Erreur lors de la duplication du modèle')\n                  }\n                }}\n              />\n\n              {/* Sélection du programme - Pour le type \"programme\" */}\n              {documentType === 'programme' && (\n                <Card>\n                  <CardHeader>\n                    <CardTitle>Programme</CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <select\n                      value={selectedProgramId}\n                      onChange={(e) => setSelectedProgramId(e.target.value)}\n                      className=\"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target\"\n                      required\n                    >\n                      <option value=\"\">Sélectionner un programme</option>\n                      {programs?.map((program: any) => (\n                        <option key={program.id} value={program.id}>\n                          {program.name} {program.code ? `(${program.code})` : ''}\n                        </option>\n                      ))}\n                    </select>\n                  </CardContent>\n                </Card>\n              )}\n\n              {/* Sélection de la session - TOUJOURS EN PREMIER et OBLIGATOIRE */}\n              <Card>\n                <CardHeader>\n                  <CardTitle>Session de formation <span className=\"text-red-500\">*</span></CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <select\n                    value={selectedSessionId}\n                    onChange={(e) => {\n                      setSelectedSessionId(e.target.value)\n                      // Réinitialiser l'apprenant quand la session change\n                      setSelectedStudentId('')\n                    }}\n                    className=\"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target\"\n                    required\n                  >\n                    <option value=\"\">Sélectionner une session</option>\n                    {sessions?.map((session) => (\n                      <option key={session.id} value={session.id}>\n                        {session.name} - {(session as SessionWithRelations).formations?.programs?.name}\n                      </option>\n                    ))}\n                  </select>\n                  <p className=\"text-sm text-gray-500 mt-2\">\n                    La sélection de la session est obligatoire pour récupérer toutes les données personnalisées.\n                  </p>\n                </CardContent>\n              </Card>\n\n              {/* Sélection de l'apprenant - DISPONIBLE APRÈS LA SESSION */}\n              {DOCUMENT_TYPES.find(dt => dt.type === documentType)?.requiresStudent && (\n                <Card>\n                  <CardHeader>\n                    <CardTitle>Apprenant <span className=\"text-red-500\">*</span></CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <select\n                      value={selectedStudentId}\n                      onChange={(e) => setSelectedStudentId(e.target.value)}\n                      className=\"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target\"\n                      required={DOCUMENT_TYPES.find(dt => dt.type === documentType)?.requiresStudent}\n                      disabled={!selectedSessionId}\n                    >\n                      <option value=\"\">\n                        {!selectedSessionId \n                          ? 'Veuillez d\\'abord sélectionner une session' \n                          : 'Sélectionner un apprenant'}\n                      </option>\n                      {selectedSessionId && students?.map((student: any) => (\n                        <option key={student.id} value={student.id}>\n                          {student.last_name} {student.first_name} ({student.student_number})\n                        </option>\n                      ))}\n                    </select>\n                    {selectedSessionId && students && students.length === 0 && (\n                      <p className=\"text-sm text-amber-600 mt-2\">\n                        Aucun apprenant inscrit à cette session.\n                      </p>\n                    )}\n                  </CardContent>\n                </Card>\n              )}\n\n              {/* Sélection de la facture - Pour facture et devis */}\n              {(documentType === 'facture' || documentType === 'devis') && (\n                <Card>\n                  <CardHeader>\n                    <CardTitle>{documentType === 'facture' ? 'Facture' : 'Devis'}</CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <select\n                      value={selectedInvoiceId}\n                      onChange={(e) => setSelectedInvoiceId(e.target.value)}\n                      className=\"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target\"\n                      required\n                    >\n                      <option value=\"\">Sélectionner une {documentType === 'facture' ? 'facture' : 'devis'}</option>\n                      {invoices?.map((invoice: any) => (\n                        <option key={invoice.id} value={invoice.id}>\n                          {invoice.invoice_number} - {invoice.students?.first_name}{' '}\n                          {invoice.students?.last_name}\n                        </option>\n                      ))}\n                    </select>\n                  </CardContent>\n                </Card>\n              )}\n\n              <Card>\n                <CardHeader>\n                  <CardTitle>Options</CardTitle>\n                </CardHeader>\n                <CardContent className=\"space-y-4\">\n                  <div>\n                    <label className=\"block text-sm font-medium mb-2\">Langue</label>\n                    <select\n                      value={language}\n                      onChange={(e) => setLanguage(e.target.value as 'fr' | 'en')}\n                      className=\"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target\"\n                    >\n                      <option value=\"fr\">Français</option>\n                      <option value=\"en\">English</option>\n                    </select>\n                  </div>\n                  <div>\n                    <label className=\"block text-sm font-medium mb-2\">Format d'export</label>\n                    <Select value={exportFormat} onValueChange={(value) => setExportFormat(value as 'pdf' | 'word')}>\n                      <SelectTrigger className=\"w-full\">\n                        <SelectValue placeholder=\"Sélectionner un format\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"pdf\">\n                          <div className=\"flex items-center gap-2\">\n                            <FileText className=\"h-4 w-4 text-red-600\" />\n                            <span>PDF (.pdf)</span>\n                          </div>\n                        </SelectItem>\n                        <SelectItem value=\"word\">\n                          <div className=\"flex items-center gap-2\">\n                            <FileText className=\"h-4 w-4 text-blue-600\" />\n                            <span>Word (.docx)</span>\n                          </div>\n                        </SelectItem>\n                      </SelectContent>\n                    </Select>\n                  </div>\n                </CardContent>\n              </Card>\n\n              <div className=\"flex justify-end space-x-4\">\n                <Link href=\"/dashboard/documents\">\n                  <Button variant=\"outline\">Annuler</Button>\n                </Link>\n                <Button\n                  onClick={handleGenerate}\n                  disabled={\n                    isGenerating ||\n                    !selectedTemplateId ||\n                    !selectedSessionId || // Session toujours obligatoire\n                    (DOCUMENT_TYPES.find(dt => dt.type === documentType)?.requiresStudent && !selectedStudentId) ||\n                    (DOCUMENT_TYPES.find(dt => dt.type === documentType)?.requiresInvoice && !selectedInvoiceId) ||\n                    (documentType === 'programme' && !selectedProgramId)\n                  }\n                >\n                  <Download className=\"mr-2 h-4 w-4\" />\n                  {isGenerating ? 'Génération...' : 'Générer et télécharger'}\n                </Button>\n              </div>\n\n              {/* Carte avec les actions après génération */}\n              {generatedDocument && !isGenerating && (\n                <Card className=\"border-2 border-green-200 bg-green-50/50\">\n                  <CardHeader>\n                    <div className=\"flex items-center gap-3\">\n                      <div className=\"p-2 bg-green-100 rounded-lg\">\n                        <CheckCircle2 className=\"h-5 w-5 text-green-600\" />\n                      </div>\n                      <div className=\"flex-1\">\n                        <CardTitle className=\"text-green-900\">Document généré avec succès !</CardTitle>\n                        <p className=\"text-sm text-green-700 mt-1\">{generatedDocument.title}</p>\n                      </div>\n                    </div>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"flex flex-wrap gap-3\">\n                      <Button\n                        onClick={handleDownload}\n                        variant=\"outline\"\n                        className=\"border-green-300 text-green-700 hover:bg-green-100\"\n                      >\n                        <Download className=\"mr-2 h-4 w-4\" />\n                        Télécharger à nouveau\n                      </Button>\n                      <Button\n                        onClick={handleOpenEmailModal}\n                        variant=\"outline\"\n                        className=\"border-blue-300 text-blue-700 hover:bg-blue-100\"\n                      >\n                        <Mail className=\"mr-2 h-4 w-4\" />\n                        Envoyer par email\n                      </Button>\n                      {generatedDocument.studentId && (\n                        <Button\n                          onClick={() => sendToLearnerSpaceMutation.mutate()}\n                          disabled={sendToLearnerSpaceMutation.isPending}\n                          variant=\"outline\"\n                          className=\"border-purple-300 text-purple-700 hover:bg-purple-100\"\n                        >\n                          <Send className=\"mr-2 h-4 w-4\" />\n                          {sendToLearnerSpaceMutation.isPending ? 'Envoi...' : 'Espace apprenant'}\n                        </Button>\n                      )}\n                      <Button\n                        onClick={() => setGeneratedDocument(null)}\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        className=\"ml-auto\"\n                      >\n                        <X className=\"h-4 w-4\" />\n                      </Button>\n                    </div>\n                  </CardContent>\n                </Card>\n              )}\n            </>\n          )}\n        </div>\n      </div>\n\n      {/* Modal d'envoi par email */}\n      <Dialog open={showEmailModal} onOpenChange={setShowEmailModal}>\n        <DialogContent className=\"max-w-2xl\">\n          <DialogHeader>\n            <DialogTitle>Envoyer par email</DialogTitle>\n            <DialogDescription>{generatedDocument?.title}</DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium\">Destinataire *</label>\n              <input\n                type=\"text\"\n                value={emailForm.to}\n                onChange={(e) => setEmailForm((prev) => ({ ...prev, to: e.target.value }))}\n                className=\"w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary\"\n                placeholder=\"email@example.com, email2@example.com\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium\">Objet *</label>\n              <input\n                type=\"text\"\n                value={emailForm.subject}\n                onChange={(e) => setEmailForm((prev) => ({ ...prev, subject: e.target.value }))}\n                className=\"w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary\"\n                placeholder=\"Objet de l'email\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium\">Message</label>\n              <textarea\n                value={emailForm.message}\n                onChange={(e) => setEmailForm((prev) => ({ ...prev, message: e.target.value }))}\n                rows={6}\n                className=\"w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary resize-none\"\n                placeholder=\"Votre message...\"\n              />\n            </div>\n            {generatedDocument?.fileUrl && (\n              <div className=\"p-4 bg-gray-50 rounded-lg\">\n                <div className=\"flex items-center gap-3\">\n                  <FileText className=\"h-5 w-5 text-gray-400\" />\n                  <div className=\"flex-1\">\n                    <p className=\"text-sm font-medium text-gray-900\">Pièce jointe</p>\n                    <p className=\"text-xs text-gray-500\">{generatedDocument.filename}</p>\n                  </div>\n                </div>\n              </div>\n            )}\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowEmailModal(false)}>\n              Annuler\n            </Button>\n            <Button\n              onClick={handleSendEmail}\n              disabled={sendingEmail || !emailForm.to || !emailForm.subject}\n            >\n              {sendingEmail ? 'Envoi...' : 'Envoyer'}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Dialogue de confirmation pour le partage des relevés de notes */}\n      <Dialog \n        open={showShareConfirmation} \n        onOpenChange={(open) => {\n          if (!open && showShareConfirmation) {\n            // Si le dialogue est fermé sans choix explicite, ne pas partager\n            handleShareConfirmation(false)\n          } else {\n            setShowShareConfirmation(open)\n          }\n        }}\n      >\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Partager le relevé de notes avec l'apprenant ?</DialogTitle>\n            <DialogDescription>\n              Souhaitez-vous que ce relevé de notes soit visible dans l'espace personnel de l'apprenant ?\n              <br />\n              <br />\n              Si vous choisissez \"Non\", le document sera sauvegardé mais ne sera pas accessible par l'apprenant.\n            </DialogDescription>\n          </DialogHeader>\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => handleShareConfirmation(false)}\n            >\n              Non, ne pas partager\n            </Button>\n            <Button\n              onClick={() => handleShareConfirmation(true)}\n            >\n              Oui, partager avec l'apprenant\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  )\n}\n\n"],"names":[],"mappings":"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"}