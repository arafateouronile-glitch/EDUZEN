module.exports=[345430,a=>{"use strict";var b=a.i(187924),c=a.i(572131),d=a.i(50944),e=a.i(433217),f=a.i(370025),g=a.i(937927),h=a.i(913216),i=a.i(269240),j=a.i(703130),k=a.i(340695),l=a.i(205522),m=a.i(917171),n=a.i(546893),o=a.i(280281),p=a.i(254161),q=a.i(864037),r=a.i(400210),s=a.i(114548),t=a.i(111269),u=a.i(546842),v=a.i(941675),w=a.i(821374),x=a.i(104720),y=a.i(773320),z=a.i(238246);a.i(460355);var A=a.i(346271),B=a.i(497895);function C(){let a=(0,d.useParams)();(0,d.useRouter)();let{user:C}=(0,h.useAuth)(),D=(0,i.createClient)(),E=(0,g.useQueryClient)(),{addToast:F}=(0,q.useToast)(),G=a.id,[H,I]=(0,c.useState)({}),[J,K]=(0,c.useState)(""),[L,M]=(0,c.useState)(!1),[N,O]=(0,c.useState)(!1),{data:P,isLoading:Q}=(0,e.useQuery)({queryKey:["portfolio",G],queryFn:async()=>{let{data:a,error:b}=await D.from("learning_portfolios").select(`
          *,
          template:learning_portfolio_templates(*),
          student:students(id, first_name, last_name, email, phone, photo_url),
          session:sessions(id, name, start_date, end_date, formations(id, name))
        `).eq("id",G).single();if(b)throw b;return a},enabled:!!G}),{data:R}=(0,e.useQuery)({queryKey:["portfolio-entries",G],queryFn:async()=>{let{data:a,error:b}=await D.from("learning_portfolio_entries").select("*").eq("portfolio_id",G);return b?(console.log("Erreur ou table inexistante:",b),[]):a||[]},enabled:!!G});(0,c.useEffect)(()=>{P&&(K(P.teacher_notes||""),M(P.is_visible_to_student||!1),P.content&&I(P.content))},[P]),(0,c.useEffect)(()=>{if(R&&R.length>0){let a={};R.forEach(b=>{let c=`${b.section_id}.${b.field_id}`;a[c]=b.value,b.teacher_comment&&(a[`${c}_comment`]=b.teacher_comment)}),I(b=>({...b,...a}))}},[R]);let S=(0,f.useMutation)({mutationFn:async a=>{let{error:b}=await D.from("learning_portfolios").update({content:a.content,status:a.status,teacher_notes:J,is_visible_to_student:L,last_modified_by:C?.id,..."completed"===a.status?{completed_at:new Date().toISOString()}:{}}).eq("id",G);if(b)throw b;let c=[],d=P?.template;if(d?.template_structure?.forEach(b=>{b.fields?.forEach(d=>{let e=`${b.id}.${d.id}`,f=a.content[e];void 0!==f&&c.push({portfolio_id:G,section_id:b.id,field_id:d.id,value:f,teacher_comment:a.content[`${e}_comment`]||null,evaluated_by:C?.id,evaluated_at:new Date().toISOString()})})}),c.length>0){let{error:a}=await D.from("learning_portfolio_entries").upsert(c,{onConflict:"portfolio_id,section_id,field_id"});a&&console.error("Erreur sauvegarde entrées:",a)}},onSuccess:()=>{E.invalidateQueries({queryKey:["portfolio",G]}),E.invalidateQueries({queryKey:["portfolio-entries",G]}),F({type:"success",title:"Livret sauvegardé",description:"Les modifications ont été enregistrées."})},onError:a=>{F({type:"error",title:"Erreur",description:a.message||"Impossible de sauvegarder."})}}),T=(a="in_progress")=>{S.mutate({content:H,status:a})},U=()=>{confirm("Êtes-vous sûr de vouloir valider ce livret ? Il sera visible par l'apprenant.")&&(S.mutate({content:H,status:"validated"}),M(!0))},V=(a,b,c)=>{let d=`${a}.${b}`;I(a=>({...a,[d]:c}))};if(Q)return(0,b.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,b.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-brand-blue"})});if(!P)return(0,b.jsx)("div",{className:"container mx-auto py-8 px-4",children:(0,b.jsx)(j.Card,{children:(0,b.jsxs)(j.CardContent,{className:"py-12 text-center",children:[(0,b.jsx)(x.FileText,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),(0,b.jsx)("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Livret non trouvé"}),(0,b.jsx)(z.default,{href:"/dashboard/evaluations/portfolios",children:(0,b.jsx)(k.Button,{children:"Retour à la liste"})})]})})});let W=P.template,X=P.student;return(0,b.jsxs)("div",{className:"container mx-auto py-8 px-4 max-w-5xl",children:[(0,b.jsx)(A.motion.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"mb-8",children:(0,b.jsxs)("div",{className:"flex items-center gap-4 mb-4",children:[(0,b.jsx)(z.default,{href:"/dashboard/evaluations/portfolios",children:(0,b.jsx)(k.Button,{variant:"ghost",size:"icon",children:(0,b.jsx)(r.ArrowLeft,{className:"h-5 w-5"})})}),(0,b.jsxs)("div",{className:"flex-1",children:[(0,b.jsx)("h1",{className:"text-2xl font-bold text-gray-900 flex items-center gap-3",children:W?.name||"Livret d'apprentissage"}),(0,b.jsxs)("div",{className:"flex items-center gap-4 text-sm text-gray-600 mt-1",children:[(0,b.jsxs)("span",{className:"flex items-center gap-1",children:[(0,b.jsx)(u.User,{className:"h-4 w-4"}),X?.first_name," ",X?.last_name]}),P.session&&(0,b.jsxs)("span",{className:"flex items-center gap-1",children:[(0,b.jsx)(v.Calendar,{className:"h-4 w-4"}),P.session.name]}),(0,b.jsxs)(p.Badge,{variant:"validated"===P.status?"default":"secondary",children:["draft"===P.status&&"Brouillon","in_progress"===P.status&&"En cours","completed"===P.status&&"Terminé","validated"===P.status&&"Validé"]})]})]}),(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsxs)(k.Button,{variant:"outline",onClick:()=>T("in_progress"),disabled:S.isPending,children:[(0,b.jsx)(s.Save,{className:"h-4 w-4 mr-2"}),"Sauvegarder"]}),(0,b.jsxs)(k.Button,{onClick:U,disabled:S.isPending,children:[(0,b.jsx)(t.CheckCircle2,{className:"h-4 w-4 mr-2"}),"Valider"]})]})]})}),(0,b.jsx)(j.Card,{className:"mb-6",style:{borderLeftColor:W?.primary_color,borderLeftWidth:4},children:(0,b.jsx)(j.CardContent,{className:"py-4",children:(0,b.jsxs)("div",{className:"flex items-center gap-4",children:[(0,b.jsx)("div",{className:"w-14 h-14 rounded-full flex items-center justify-center text-white text-lg font-medium",style:{backgroundColor:W?.primary_color||"#335ACF"},children:X?.photo_url?(0,b.jsx)("img",{src:X.photo_url,alt:"",className:"w-14 h-14 rounded-full object-cover"}):`${X?.first_name?.[0]}${X?.last_name?.[0]}`}),(0,b.jsxs)("div",{className:"flex-1",children:[(0,b.jsxs)("h3",{className:"font-semibold text-gray-900",children:[X?.first_name," ",X?.last_name]}),(0,b.jsx)("p",{className:"text-sm text-gray-600",children:X?.email}),P.session?.formations&&(0,b.jsx)("p",{className:"text-sm text-gray-500",children:P.session.formations.name})]}),(0,b.jsxs)("div",{className:"text-right",children:[(0,b.jsx)("p",{className:"text-sm text-gray-600",children:"Progression"}),(0,b.jsxs)("p",{className:"text-2xl font-bold",style:{color:W?.primary_color},children:[Math.round(P.progress_percentage||0),"%"]})]})]})})}),(0,b.jsx)("div",{className:"space-y-6",children:W?.template_structure?.map((a,c)=>(0,b.jsx)(A.motion.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.1*c},children:(0,b.jsxs)(j.Card,{children:[(0,b.jsxs)(j.CardHeader,{style:{borderBottomColor:W?.primary_color,borderBottomWidth:2},children:[(0,b.jsxs)(j.CardTitle,{className:"flex items-center gap-2",children:[(0,b.jsx)("span",{className:"w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-medium",style:{backgroundColor:W?.primary_color},children:c+1}),a.title]}),a.description&&(0,b.jsx)(j.CardDescription,{children:a.description})]}),(0,b.jsx)(j.CardContent,{className:"pt-6",children:(0,b.jsx)("div",{className:"space-y-6",children:a.fields?.map(c=>(0,b.jsxs)("div",{children:[(0,b.jsxs)(m.Label,{className:"flex items-center gap-2 mb-2",children:[c.label,c.required&&(0,b.jsx)("span",{className:"text-red-500",children:"*"})]}),((a,c)=>{var d,e;let f=(d=a.id,e=c.id,H[`${d}.${e}`]);switch(a.id,c.id,c.type){case"text":return(0,b.jsx)(l.Input,{value:f||"",onChange:b=>V(a.id,c.id,b.target.value),placeholder:c.placeholder||""});case"textarea":return(0,b.jsx)(n.Textarea,{value:f||"",onChange:b=>V(a.id,c.id,b.target.value),placeholder:c.placeholder||"",rows:4});case"number":return(0,b.jsx)(l.Input,{type:"number",value:f||"",onChange:b=>V(a.id,c.id,parseFloat(b.target.value)),min:c.min,max:c.max});case"select":return(0,b.jsxs)("select",{value:f||"",onChange:b=>V(a.id,c.id,b.target.value),className:"w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-brand-blue",children:[(0,b.jsx)("option",{value:"",children:"Sélectionner..."}),c.options?.map(a=>(0,b.jsx)("option",{value:a,children:a},a))]});case"checkbox":return(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)("input",{type:"checkbox",checked:f||!1,onChange:b=>V(a.id,c.id,b.target.checked),className:"rounded"}),(0,b.jsx)("span",{className:"text-sm text-gray-600",children:c.description||"Oui"})]});case"date":return(0,b.jsx)(l.Input,{type:"date",value:f||"",onChange:b=>V(a.id,c.id,b.target.value)});case"rating":let g=c.max||5,h=c.min||1;return(0,b.jsxs)("div",{className:"flex items-center gap-1",children:[Array.from({length:g-h+1},(a,b)=>b+h).map(d=>(0,b.jsx)("button",{type:"button",onClick:()=>V(a.id,c.id,d),className:(0,B.cn)("p-1 rounded transition-colors",(f||0)>=d?"text-yellow-500":"text-gray-300 hover:text-yellow-400"),children:(0,b.jsx)(w.Star,{className:"h-6 w-6 fill-current"})},d)),(0,b.jsx)("span",{className:"ml-2 text-sm text-gray-600",children:f?`${f}/${g}`:"Non noté"})]});case"competency":let i=c.competencyLevels||["Non acquis","En cours","Acquis","Maîtrisé"];return(0,b.jsx)("div",{className:"flex flex-wrap gap-2",children:i.map((d,e)=>(0,b.jsx)("button",{type:"button",onClick:()=>V(a.id,c.id,d),className:(0,B.cn)("px-3 py-1.5 rounded-full text-sm font-medium transition-all",f===d?"bg-brand-blue text-white":"bg-gray-100 text-gray-600 hover:bg-gray-200"),children:d},d))});case"file":return(0,b.jsxs)("div",{className:"border-2 border-dashed rounded-lg p-4 text-center",children:[(0,b.jsx)(y.Upload,{className:"h-8 w-8 mx-auto text-gray-400 mb-2"}),(0,b.jsx)("p",{className:"text-sm text-gray-600",children:"Glissez un fichier ici ou cliquez pour sélectionner"}),(0,b.jsx)("input",{type:"file",className:"hidden",onChange:b=>{let d=b.target.files?.[0];d&&V(a.id,c.id,{name:d.name,size:d.size})}})]});default:return(0,b.jsx)(l.Input,{value:f||"",onChange:b=>V(a.id,c.id,b.target.value)})}})(a,c),("competency"===c.type||"rating"===c.type)&&(0,b.jsx)("div",{className:"mt-2",children:(0,b.jsx)(l.Input,{placeholder:"Commentaire (optionnel)",value:H[`${a.id}.${c.id}_comment`]||"",onChange:b=>{let d=`${a.id}.${c.id}_comment`;I(a=>({...a,[d]:b.target.value}))},className:"text-sm"})})]},c.id))})})]})},a.id))}),(0,b.jsxs)(j.Card,{className:"mt-6",children:[(0,b.jsx)(j.CardHeader,{children:(0,b.jsx)(j.CardTitle,{children:"Notes et options"})}),(0,b.jsxs)(j.CardContent,{className:"space-y-4",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)(m.Label,{children:"Notes du formateur"}),(0,b.jsx)(n.Textarea,{value:J,onChange:a=>K(a.target.value),placeholder:"Notes internes (non visibles par l'apprenant)...",rows:4})]}),(0,b.jsxs)("div",{className:"flex items-center justify-between p-4 bg-gray-50 rounded-lg",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("p",{className:"font-medium text-gray-900",children:"Visibilité apprenant"}),(0,b.jsx)("p",{className:"text-sm text-gray-600",children:"Permettre à l'apprenant de consulter et télécharger son livret"})]}),(0,b.jsx)(o.Switch,{checked:L,onCheckedChange:M})]})]})]}),(0,b.jsxs)("div",{className:"mt-6 flex justify-between",children:[(0,b.jsx)(z.default,{href:"/dashboard/evaluations/portfolios",children:(0,b.jsxs)(k.Button,{variant:"outline",children:[(0,b.jsx)(r.ArrowLeft,{className:"h-4 w-4 mr-2"}),"Retour"]})}),(0,b.jsxs)("div",{className:"flex gap-3",children:[(0,b.jsxs)(k.Button,{variant:"outline",onClick:()=>T("in_progress"),disabled:S.isPending,children:[(0,b.jsx)(s.Save,{className:"h-4 w-4 mr-2"}),"Sauvegarder"]}),(0,b.jsxs)(k.Button,{onClick:U,disabled:S.isPending,children:[(0,b.jsx)(t.CheckCircle2,{className:"h-4 w-4 mr-2"}),"Valider et rendre visible"]})]})]})]})}a.s(["default",()=>C])}];

//# sourceMappingURL=app_%28dashboard%29_dashboard_evaluations_portfolios_%5Bid%5D_page_tsx_c6d3d413._.js.map