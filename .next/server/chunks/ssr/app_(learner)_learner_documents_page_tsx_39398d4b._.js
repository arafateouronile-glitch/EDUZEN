module.exports=[872891,a=>{"use strict";var b=a.i(187924),c=a.i(433217),d=a.i(572131),e=a.i(323625),f=a.i(727163),g=a.i(219897),h=a.i(340695),i=a.i(254161),j=a.i(205522);a.i(460355);var k=a.i(346271),l=a.i(104720),m=a.i(284505),n=a.i(177156),o=a.i(587532),p=a.i(941675),q=a.i(93518),r=a.i(911300),s=a.i(87466),t=a.i(992258),u=a.i(501199),v=a.i(492596),w=a.i(497895),x=a.i(325383);let y=[{id:"all",label:"Tous",icon:v.Folder},{id:"convocation",label:"Convocations",icon:t.Mail},{id:"convention",label:"Conventions",icon:s.FileCheck},{id:"attestation",label:"Attestations",icon:r.ClipboardList},{id:"certificate",label:"Certificats",icon:q.Award},{id:"invoice",label:"Factures",icon:u.Receipt}];function z(){let{student:a,studentId:v}=(0,e.useLearnerContext)(),z=(0,d.useMemo)(()=>v?(0,f.createLearnerClient)(v):null,[v]),[A,B]=(0,d.useState)(""),[C,D]=(0,d.useState)("all"),E=async a=>{try{if(!a.file_url){x.logger.error("No file URL for document",{documentId:a.id?(0,x.maskId)(a.id):"unknown"}),alert("URL du fichier non disponible");return}let b=await fetch(a.file_url);if(!b.ok)throw Error(`Erreur HTTP: ${b.status}`);let c=await b.blob(),d=window.URL.createObjectURL(c),e=document.createElement("a");if(e.href=d,e.download=a.name||"document.pdf",document.body.appendChild(e),e.click(),document.body.removeChild(e),window.URL.revokeObjectURL(d),"learner_documents"===a.source&&a.id)try{await z?.from("learner_documents").update({downloaded_at:new Date().toISOString()}).eq("id",a.id)}catch(b){x.logger.error("Error marking as downloaded",b,{documentId:a.id?(0,x.maskId)(a.id):void 0,error:(0,x.sanitizeError)(b)})}}catch(b){x.logger.error("Erreur lors du téléchargement",b,{documentId:a.id?(0,x.maskId)(a.id):void 0,error:(0,x.sanitizeError)(b)}),alert("Erreur lors du téléchargement du document")}},{data:F,isLoading:G}=(0,c.useQuery)({queryKey:["learner-documents-all",v],queryFn:async()=>{if(!v||!z)return[];try{x.logger.info("Fetching documents",{studentId:(0,x.maskId)(v)});let{data:a,error:b}=await z.from("learner_documents").select("*").order("sent_at",{ascending:!1});x.logger.info("Fetched learner_documents",{studentId:(0,x.maskId)(v),count:a?.length||0,hasError:!!b});let{data:c,error:d}=await z.from("generated_documents").select("*").order("created_at",{ascending:!1});x.logger.info("Fetched generated_documents",{studentId:(0,x.maskId)(v),count:c?.length||0,hasError:!!d});let{data:e,error:f}=await z.from("documents").select("*").order("created_at",{ascending:!1});x.logger.info("Fetched documents",{studentId:(0,x.maskId)(v),count:e?.length||0,hasError:!!f});let g=[],h=a=>{if(!a)return"other";let b=a.toLowerCase();return b.includes("convocation")?"convocation":b.includes("convention")?"convention":b.includes("attestation")?"attestation":b.includes("certificat")||b.includes("certificate")?"certificate":b.includes("facture")||b.includes("invoice")?"invoice":b.includes("releve")||b.includes("relevé")?"attestation":["convocation","convention","attestation","certificate","invoice"].includes(b)?b:"other"};return!b&&a&&a.forEach(a=>{g.push({id:a.id,name:a.title||`Document ${a.type}`,type:h(a.type),original_type:a.type,file_url:a.file_url,created_at:a.sent_at||a.created_at,metadata:a.description?{description:a.description}:null,format:"pdf",source:"learner_documents"})}),!d&&c&&c.forEach(a=>{g.push({id:a.id,name:a.file_name||`Document ${a.type}`,type:h(a.type),original_type:a.type,file_url:a.file_url,created_at:a.created_at,metadata:a.metadata,format:a.format,source:"generated_documents"})}),!f&&e&&e.forEach(a=>{g.push({id:a.id,name:a.name||a.title||`Document ${a.type}`,type:h(a.type),original_type:a.type,file_url:a.file_url||a.url,created_at:a.created_at,metadata:a.metadata,format:a.format||"pdf",source:"documents"})}),g.sort((a,b)=>{let c=new Date(a.created_at||0).getTime();return new Date(b.created_at||0).getTime()-c}),b&&console.error("[Documents] Error fetching learner_documents:",{code:b.code,message:b.message,details:b.details,hint:b.hint}),d&&console.error("[Documents] Error fetching generated_documents:",{code:d.code,message:d.message,details:d.details,hint:d.hint}),f&&console.error("[Documents] Error fetching documents:",{code:f.code,message:f.message,details:f.details,hint:f.hint}),console.log("[Documents] Total documents found:",g.length),console.log("[Documents] Final documents:",g),g}catch(a){return console.error("Unexpected error fetching documents:",a),[]}},enabled:!!v&&!!z,refetchOnWindowFocus:!0,refetchOnMount:!0}),{data:H}=(0,c.useQuery)({queryKey:["learner-certificates-all",v],queryFn:async()=>{if(!v||!z)return[];try{let{data:a,error:b}=await z.from("course_certificates").select("*").order("issued_at",{ascending:!1});if(b){if("42501"===b.code||"PGRST116"===b.code||"42P01"===b.code||"PGRST301"===b.code||"400"===b.code||b.message?.includes("permission denied")||b.message?.includes("does not exist"))return console.warn("Certificates may not be accessible (RLS or missing):",b.message),[];return console.warn("Error fetching certificates:",b),[]}if(!a||0===a.length)return[];let c=[...new Set((a||[]).map(a=>a.course_id).filter(Boolean))];if(c.length>0){let{data:b}=await z.from("courses").select("id, title, description").in("id",c);if(b)return(a||[]).map(a=>({...a,courses:b.find(b=>b.id===a.course_id)||null}))}return a||[]}catch(a){return console.error("Unexpected error fetching certificates:",a),[]}},enabled:!!v&&!!z,refetchOnWindowFocus:!0,refetchOnMount:!0}),I=[...(F||[]).map(a=>({...a,source:"document"})),...(H||[]).map(a=>({id:a.id,name:`Certificat - ${a.courses?.title||"Formation"}`,type:"certificate",created_at:a.issued_at,file_url:a.certificate_url,source:"certificate",certificate_number:a.certificate_number}))].filter(a=>{let b=a.name?.toLowerCase().includes(A.toLowerCase()),c="all"===C||a.type===C;return b&&c}),J={hidden:{opacity:0,y:20},visible:{opacity:1,y:0,transition:{duration:.3}}};return(0,b.jsxs)(k.motion.div,{className:"space-y-6 pb-24 lg:pb-8",variants:{hidden:{opacity:0},visible:{opacity:1,transition:{staggerChildren:.05}}},initial:"hidden",animate:"visible",children:[(0,b.jsx)(k.motion.div,{variants:J,children:(0,b.jsxs)("div",{className:"flex items-center gap-3 mb-2",children:[(0,b.jsx)("div",{className:"p-2 bg-green-100 rounded-xl",children:(0,b.jsx)(l.FileText,{className:"h-8 w-8 text-green-600"})}),(0,b.jsxs)("div",{children:[(0,b.jsx)("h1",{className:"text-2xl md:text-3xl font-bold text-gray-900",children:"Mes documents"}),(0,b.jsx)("p",{className:"text-gray-500",children:"Accédez à tous vos documents de formation"})]})]})}),(0,b.jsx)(k.motion.div,{variants:J,children:(0,b.jsx)(g.GlassCard,{className:"p-4",children:(0,b.jsxs)("div",{className:"flex flex-col md:flex-row gap-4",children:[(0,b.jsxs)("div",{className:"relative flex-1",children:[(0,b.jsx)(o.Search,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400"}),(0,b.jsx)(j.Input,{type:"search",placeholder:"Rechercher un document...",value:A,onChange:a=>B(a.target.value),className:"pl-10"})]}),(0,b.jsx)("div",{className:"flex gap-2 overflow-x-auto pb-2 md:pb-0",children:y.map(a=>(0,b.jsxs)(h.Button,{variant:C===a.id?"default":"outline",size:"sm",onClick:()=>D(a.id),className:`whitespace-nowrap ${C===a.id?"bg-brand-blue":""}`,children:[(0,b.jsx)(a.icon,{className:"h-4 w-4 mr-1"}),a.label]},a.id))})]})})}),(0,b.jsx)(k.motion.div,{variants:J,children:G?(0,b.jsx)("div",{className:"grid gap-4",children:[1,2,3].map(a=>(0,b.jsx)("div",{className:"h-24 bg-gray-100 rounded-2xl animate-pulse"},a))}):I.length>0?(0,b.jsx)("div",{className:"grid gap-4",children:I.map((a,c)=>{var d;let e;return(0,b.jsx)(k.motion.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.05*c},children:(0,b.jsx)(g.GlassCard,{className:"p-4 hover:shadow-lg transition-all duration-300 group",children:(0,b.jsxs)("div",{className:"flex items-center gap-4",children:[(0,b.jsx)("div",{className:`p-3 rounded-xl ${"certificate"===a.type?"bg-amber-50":"convocation"===a.type?"bg-blue-50":"convention"===a.type?"bg-purple-50":"attestation"===a.type?"bg-green-50":"bg-gray-50"}`,children:(a=>{switch(a){case"convocation":return(0,b.jsx)(t.Mail,{className:"h-5 w-5 text-blue-600"});case"convention":return(0,b.jsx)(s.FileCheck,{className:"h-5 w-5 text-purple-600"});case"attestation":return(0,b.jsx)(r.ClipboardList,{className:"h-5 w-5 text-green-600"});case"certificate":return(0,b.jsx)(q.Award,{className:"h-5 w-5 text-amber-600"});case"invoice":return(0,b.jsx)(u.Receipt,{className:"h-5 w-5 text-gray-600"});default:return(0,b.jsx)(l.FileText,{className:"h-5 w-5 text-gray-600"})}})(a.type)}),(0,b.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,b.jsxs)("div",{className:"flex items-start justify-between gap-2",children:[(0,b.jsx)("h3",{className:"font-semibold text-gray-900 truncate",children:a.name}),(d=a.type,e={convocation:"bg-blue-100 text-blue-700",convention:"bg-purple-100 text-purple-700",attestation:"bg-green-100 text-green-700",certificate:"bg-amber-100 text-amber-700",invoice:"bg-gray-100 text-gray-700"},(0,b.jsx)(i.Badge,{className:`${e[d]||"bg-gray-100 text-gray-700"} hover:${e[d]}`,children:{convocation:"Convocation",convention:"Convention",attestation:"Attestation",certificate:"Certificat",invoice:"Facture"}[d]||d}))]}),(0,b.jsxs)("div",{className:"flex items-center gap-3 mt-1 text-sm text-gray-500",children:[(0,b.jsxs)("span",{className:"flex items-center gap-1",children:[(0,b.jsx)(p.Calendar,{className:"h-4 w-4"}),a.created_at&&(0,w.formatDate)(a.created_at)]}),a.sessions?.formations?.name&&(0,b.jsx)("span",{className:"truncate",children:a.sessions.formations.name}),a.certificate_number&&(0,b.jsxs)("span",{className:"font-mono text-xs",children:["N° ",a.certificate_number]})]})]}),(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)(h.Button,{variant:"ghost",size:"icon",className:"opacity-0 group-hover:opacity-100 transition-opacity",onClick:()=>{a.file_url?(window.open(a.file_url,"_blank"),"learner_documents"===a.source&&a.id&&z&&z.from("learner_documents").update({viewed_at:new Date().toISOString()}).eq("id",a.id).then(({error:b})=>{b&&x.logger.error("Error marking as viewed",b,{documentId:(0,x.maskId)(a.id),error:(0,x.sanitizeError)(b)})})):alert("URL du fichier non disponible")},children:(0,b.jsx)(n.Eye,{className:"h-4 w-4"})}),(0,b.jsxs)(h.Button,{variant:"outline",size:"sm",className:"group-hover:border-brand-blue group-hover:text-brand-blue",onClick:()=>E(a),children:[(0,b.jsx)(m.Download,{className:"h-4 w-4 mr-2"}),"Télécharger"]})]})]})})},a.id)})}):(0,b.jsxs)(g.GlassCard,{className:"p-12 text-center",children:[(0,b.jsx)(l.FileText,{className:"h-16 w-16 text-gray-300 mx-auto mb-4"}),(0,b.jsx)("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Aucun document trouvé"}),(0,b.jsx)("p",{className:"text-gray-500",children:A||"all"!==C?"Essayez de modifier vos filtres de recherche":"Vos documents apparaîtront ici une fois générés"})]})}),(0,b.jsxs)(k.motion.div,{variants:J,className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[(0,b.jsxs)(g.GlassCard,{className:"p-4 text-center",children:[(0,b.jsx)(t.Mail,{className:"h-6 w-6 text-blue-600 mx-auto mb-2"}),(0,b.jsx)("div",{className:"text-xl font-bold text-gray-900",children:F?.filter(a=>"convocation"===a.type).length||0}),(0,b.jsx)("p",{className:"text-xs text-gray-500",children:"Convocations"})]}),(0,b.jsxs)(g.GlassCard,{className:"p-4 text-center",children:[(0,b.jsx)(r.ClipboardList,{className:"h-6 w-6 text-green-600 mx-auto mb-2"}),(0,b.jsx)("div",{className:"text-xl font-bold text-gray-900",children:F?.filter(a=>"attestation"===a.type).length||0}),(0,b.jsx)("p",{className:"text-xs text-gray-500",children:"Attestations"})]}),(0,b.jsxs)(g.GlassCard,{className:"p-4 text-center",children:[(0,b.jsx)(q.Award,{className:"h-6 w-6 text-amber-600 mx-auto mb-2"}),(0,b.jsx)("div",{className:"text-xl font-bold text-gray-900",children:H?.length||0}),(0,b.jsx)("p",{className:"text-xs text-gray-500",children:"Certificats"})]}),(0,b.jsxs)(g.GlassCard,{className:"p-4 text-center",children:[(0,b.jsx)(u.Receipt,{className:"h-6 w-6 text-gray-600 mx-auto mb-2"}),(0,b.jsx)("div",{className:"text-xl font-bold text-gray-900",children:F?.filter(a=>"invoice"===a.type).length||0}),(0,b.jsx)("p",{className:"text-xs text-gray-500",children:"Factures"})]})]})]})}a.s(["default",()=>z])}];

//# sourceMappingURL=app_%28learner%29_learner_documents_page_tsx_39398d4b._.js.map