module.exports=[400210,a=>{"use strict";let b=(0,a.i(170106).default)("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]]);a.s(["ArrowLeft",()=>b],400210)},114548,a=>{"use strict";let b=(0,a.i(170106).default)("Save",[["path",{d:"M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z",key:"1owoqh"}],["polyline",{points:"17 21 17 13 7 13 7 21",key:"1md35c"}],["polyline",{points:"7 3 7 8 15 8",key:"8nz8an"}]]);a.s(["Save",()=>b],114548)},992258,a=>{"use strict";let b=(0,a.i(170106).default)("Mail",[["rect",{width:"20",height:"16",x:"2",y:"4",rx:"2",key:"18n3k1"}],["path",{d:"m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7",key:"1ocrg3"}]]);a.s(["Mail",()=>b],992258)},773320,a=>{"use strict";let b=(0,a.i(170106).default)("Upload",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"17 8 12 3 7 8",key:"t8dd8p"}],["line",{x1:"12",x2:"12",y1:"3",y2:"15",key:"widbto"}]]);a.s(["Upload",()=>b],773320)},452218,571907,a=>{"use strict";var b,c,d=a.i(325383),e=((b={}).AUTH_REQUIRED="AUTH_1001",b.AUTH_INVALID_CREDENTIALS="AUTH_1002",b.AUTH_SESSION_EXPIRED="AUTH_1003",b.AUTH_INSUFFICIENT_PERMISSIONS="AUTH_1004",b.AUTH_2FA_REQUIRED="AUTH_1005",b.AUTH_2FA_INVALID="AUTH_1006",b.VALIDATION_ERROR="VALID_2001",b.VALIDATION_REQUIRED_FIELD="VALID_2002",b.VALIDATION_INVALID_FORMAT="VALID_2003",b.VALIDATION_UNIQUE_CONSTRAINT="VALID_2004",b.DB_CONNECTION_ERROR="DB_3001",b.DB_QUERY_ERROR="DB_3002",b.DB_NOT_FOUND="DB_3003",b.DB_CONSTRAINT_VIOLATION="DB_3004",b.DB_FOREIGN_KEY_CONSTRAINT="DB_3006",b.DB_RLS_POLICY_VIOLATION="DB_3005",b.NETWORK_ERROR="NET_4001",b.API_TIMEOUT="NET_4002",b.API_RATE_LIMIT="NET_4003",b.API_SERVER_ERROR="NET_4004",b.API_NOT_FOUND="NET_4005",b.API_BAD_REQUEST="NET_4006",b.BUSINESS_LOGIC_ERROR="BIZ_5001",b.RESOURCE_LOCKED="BIZ_5002",b.OPERATION_NOT_ALLOWED="BIZ_5003",b.QUOTA_EXCEEDED="BIZ_5004",b.INTERNAL_ERROR="SYS_6001",b.CONFIGURATION_ERROR="SYS_6002",b.SERVICE_UNAVAILABLE="SYS_6003",b);(c={}).LOW="low",c.MEDIUM="medium",c.HIGH="high",c.CRITICAL="critical";class f extends Error{code;severity;userMessage;retryable;context;originalError;constructor(a,b="SYS_6001",c="medium",d={},e){super(a),this.name="AppError",this.code=b,this.severity=c,this.userMessage=d.userMessage||this.getDefaultUserMessage(b),this.retryable=d.retryable??this.isRetryable(b),this.context={...d,code:b,severity:c,timestamp:new Date().toISOString()},this.originalError=e,Error.captureStackTrace&&Error.captureStackTrace(this,f)}getDefaultUserMessage(a){return({AUTH_1001:"Vous devez être connecté pour effectuer cette action.",AUTH_1002:"Email ou mot de passe incorrect.",AUTH_1003:"Votre session a expiré. Veuillez vous reconnecter.",AUTH_1004:"Vous n'avez pas les permissions nécessaires.",AUTH_1005:"Authentification à deux facteurs requise.",AUTH_1006:"Code d'authentification invalide.",VALID_2001:"Les données fournies ne sont pas valides.",VALID_2002:"Certains champs obligatoires sont manquants.",VALID_2003:"Le format des données est incorrect.",VALID_2004:"Cette valeur existe déjà.",DB_3001:"Impossible de se connecter à la base de données.",DB_3002:"Erreur lors de l'exécution de la requête.",DB_3003:"Ressource introuvable.",DB_3004:"Cette opération viole une contrainte de la base de données.",DB_3006:"Cette opération viole une contrainte de clé étrangère.",DB_3005:"Vous n'avez pas accès à cette ressource.",NET_4001:"Erreur de connexion réseau. Vérifiez votre connexion internet.",NET_4002:"La requête a pris trop de temps. Veuillez réessayer.",NET_4003:"Trop de requêtes. Veuillez patienter quelques instants.",NET_4004:"Erreur serveur. Veuillez réessayer plus tard.",NET_4005:"Ressource introuvable.",NET_4006:"Requête invalide.",BIZ_5001:"Cette opération n'est pas autorisée dans le contexte actuel.",BIZ_5002:"Cette ressource est actuellement verrouillée.",BIZ_5003:"Cette opération n'est pas autorisée.",BIZ_5004:"Vous avez atteint la limite autorisée.",SYS_6001:"Une erreur interne est survenue. Veuillez réessayer.",SYS_6002:"Erreur de configuration du système.",SYS_6003:"Service temporairement indisponible."})[a]||"Une erreur inattendue est survenue."}isRetryable(a){return["NET_4001","NET_4002","NET_4004","DB_3001","SYS_6003"].includes(a)}toJSON(){return{name:this.name,message:this.message,code:this.code,severity:this.severity,userMessage:this.userMessage,retryable:this.retryable,context:this.context,stack:this.stack,originalError:this.originalError instanceof Error?{name:this.originalError.name,message:this.originalError.message,stack:this.originalError.stack}:this.originalError}}}let g=new class{handleError(a,b={}){if(a instanceof f)return this.logError(a),a;if(a instanceof Error)return this.handleStandardError(a,b);if(this.isSupabaseError(a))return this.handleSupabaseError(a,b);let c=new f("Une erreur inattendue est survenue.","SYS_6001","high",b,a);return this.logError(c),c}handleStandardError(a,b){let c=a.message.toLowerCase(),d="SYS_6001",e="medium";c.includes("network")||c.includes("fetch")?(d="NET_4001",e="medium"):c.includes("timeout")?(d="NET_4002",e="medium"):c.includes("unauthorized")||c.includes("401")?(d="AUTH_1001",e="high"):c.includes("forbidden")||c.includes("403")?(d="AUTH_1004",e="high"):c.includes("not found")||c.includes("404")?(d="DB_3003",e="low"):(c.includes("validation")||c.includes("invalid"))&&(d="VALID_2001",e="low");let g=new f(a.message,d,e,b,a);return this.logError(g),g}handleSupabaseError(a,b){let c=a.code||a.status,d=a.message||"Erreur Supabase",e=b.code||"DB_3002",g="medium";if(!b.code)switch(c){case"PGRST116":case"42P01":e="DB_3003",g="low";break;case"42501":e="DB_3005",g="high";break;case"23505":e="VALID_2004",g="low";break;case"23503":e="DB_3004",g="medium";break;case"PGRST301":case"400":e="NET_4006",g="low";break;case"401":e="AUTH_1001",g="high";break;case"403":e="AUTH_1004",g="high";break;case"404":e="NET_4005",g="low";break;case"500":e="NET_4004",g="high"}"DB_3006"===e&&(g="medium");let h=new f(d,e,g,b,a);return this.logError(h),h}isSupabaseError(a){return a&&(a.code||a.status||a.message)&&("string"==typeof a.code||"number"==typeof a.status)}logError(a){let b={...a.context,code:a.code,severity:a.severity,retryable:a.retryable};switch(a.severity){case"critical":case"high":d.logger.error(a.message,a.originalError||a,b);break;case"medium":d.logger.warn(a.message,b);break;case"low":d.logger.info(`Error: ${a.message}`,b)}}createValidationError(a,b){return new f(a,"VALID_2001","low",{field:b,userMessage:a})}createAuthError(a,b){return new f(b||"Erreur d'authentification",a,"high")}createDatabaseError(a,b){return new f(a,"DB_3002","medium",{},b)}createNotFoundError(a,b){return new f(a,"DB_3003","low",b)}};a.s(["AppError",()=>f,"ErrorCode",()=>e,"errorHandler",0,g],571907),a.s([],452218)},692759,a=>{"use strict";let b=(0,a.i(170106).default)("Send",[["path",{d:"m22 2-7 20-4-9-9-4Z",key:"1q3vgg"}],["path",{d:"M22 2 11 13",key:"nzbqef"}]]);a.s(["Send",()=>b],692759)},887682,a=>{"use strict";var b=a.i(187924),c=a.i(572131),d=a.i(497895);a.i(460355);var e=a.i(346271),f=a.i(262036),g=a.i(405784),h=a.i(290821);c.forwardRef(({className:a,label:i,error:j,helperText:k,variant:l="default",leftIcon:m,id:n,options:o,placeholder:p,value:q,...r},s)=>{let[t,u]=c.useState(!1),[v,w]=c.useState(!1),x=n||`select-${Math.random().toString(36).substr(2,9)}`,y=(0,d.cn)("flex w-full rounded-lg font-medium transition-all duration-300","appearance-none cursor-pointer","focus:outline-none focus:ring-2 focus:ring-primary/20","disabled:cursor-not-allowed disabled:opacity-50",{"border-2 border-input bg-background px-4 py-3 pr-11":"default"===l,"focus:border-primary focus:bg-white":"default"===l&&!j,"border-destructive focus:border-destructive focus:ring-destructive/20":j,"border-2 border-input bg-transparent px-4 py-3 pr-11":"outlined"===l,"focus:border-primary focus:shadow-md focus:shadow-primary/10":"outlined"===l&&!j,"border-0 border-b-2 border-input bg-muted/50 px-4 py-3 pr-11 rounded-b-none":"filled"===l,"focus:bg-muted focus:border-primary":"filled"===l&&!j,"focus:border-destructive bg-destructive/5":"filled"===l&&j},m&&"pl-11",a);return(0,b.jsxs)("div",{className:"w-full space-y-1.5",children:[i&&(0,b.jsxs)(e.motion.label,{htmlFor:x,initial:!1,animate:{color:j?"#EF4444":t?"rgb(37, 99, 235)":"rgb(107, 114, 128)"},className:(0,d.cn)("block text-sm font-medium transition-colors duration-200",j&&"text-destructive"),children:[i,r.required&&(0,b.jsx)("span",{className:"text-destructive ml-1",children:"*"})]}),(0,b.jsxs)("div",{className:"relative",children:[m&&(0,b.jsx)("div",{className:"absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground pointer-events-none z-10",children:m}),(0,b.jsxs)(e.motion.select,{ref:s,id:x,value:q,...r,onFocus:a=>{u(!0),r.onFocus?.(a)},onBlur:a=>{u(!1),w(!1),r.onBlur?.(a)},onMouseDown:()=>w(!v),className:y,animate:{scale:t?1.01:1,borderColor:j?"#EF4444":t?"rgb(37, 99, 235)":"rgb(226, 232, 240)"},transition:{duration:.2},children:[p&&(0,b.jsx)("option",{value:"",disabled:!0,children:p}),(o||[]).map(a=>(0,b.jsx)("option",{value:a.value,disabled:a.disabled,children:a.label},a.value))]}),(0,b.jsx)(e.motion.div,{className:"absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-muted-foreground",animate:{rotate:180*!!v},transition:{duration:.2},children:(0,b.jsx)(g.ChevronDown,{className:"h-5 w-5"})}),j&&(0,b.jsx)(e.motion.div,{className:"absolute right-11 top-1/2 -translate-y-1/2 pointer-events-none",initial:{scale:0,opacity:0},animate:{scale:1,opacity:1},transition:{type:"spring",stiffness:500,damping:30},children:(0,b.jsx)(h.AlertCircle,{className:"h-5 w-5 text-destructive"})})]}),(0,b.jsx)(f.AnimatePresence,{mode:"wait",children:(j||k)&&(0,b.jsx)(e.motion.p,{initial:{opacity:0,y:-5},animate:{opacity:1,y:0},exit:{opacity:0,y:-5},transition:{duration:.2},className:(0,d.cn)("text-xs transition-colors duration-200",j?"text-destructive":"text-muted-foreground"),children:j||k})})]})}).displayName="SelectNative";let i=c.createContext({}),j=c.forwardRef(({value:a,onValueChange:d,children:e},f)=>{let[g,h]=c.useState(!1);return(0,b.jsx)(i.Provider,{value:{value:a,onValueChange:d,open:g,setOpen:h},children:(0,b.jsx)("div",{className:"relative",ref:f,children:e})})});j.displayName="SelectRoot";let k=c.forwardRef(({children:a,className:e,...f},h)=>{let{open:j,setOpen:k}=c.useContext(i);return(0,b.jsxs)("button",{ref:h,type:"button",className:(0,d.cn)("flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",e),onClick:()=>k?.(!j),...f,children:[a,(0,b.jsx)(g.ChevronDown,{className:(0,d.cn)("h-4 w-4 opacity-50 transition-transform",j&&"rotate-180")})]})});k.displayName="SelectTrigger";let l=c.forwardRef(({placeholder:a},d)=>{let{value:e}=c.useContext(i);return(0,b.jsx)("span",{ref:d,children:e||a})});l.displayName="SelectValue";let m=c.forwardRef(({children:a},d)=>{let e=c.useContext(i);return e?.open&&a?(0,b.jsx)("div",{ref:d,className:"absolute top-full left-0 z-50 mt-1 min-w-[8rem] overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-md",children:(0,b.jsx)("div",{className:"p-1",children:a})}):null});m.displayName="SelectContent";let n=c.forwardRef(({value:a,children:e,className:f,...g},h)=>{let{value:j,onValueChange:k,setOpen:l}=c.useContext(i),m=j===a;return(0,b.jsx)("div",{ref:h,role:"option","aria-selected":m,className:(0,d.cn)("relative flex w-full cursor-pointer select-none items-center rounded-sm py-1.5 px-2 text-sm outline-none hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground",m&&"bg-accent text-accent-foreground",f),onClick:()=>{k?.(a),l?.(!1)},...g,children:e})});n.displayName="SelectItem",a.s(["Select",0,j,"SelectContent",0,m,"SelectItem",0,n,"SelectRoot",0,j,"SelectTrigger",0,k,"SelectValue",0,l])},482520,(a,b,c)=>{"use strict";b.exports="SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED"},324560,(a,b,c)=>{"use strict";var d=a.r(482520);function e(){}function f(){}f.resetWarningCache=e,b.exports=function(){function a(a,b,c,e,f,g){if(g!==d){var h=Error("Calling PropTypes validators directly is not supported by the `prop-types` package. Use PropTypes.checkPropTypes() to call them. Read more at http://fb.me/use-check-prop-types");throw h.name="Invariant Violation",h}}function b(){return a}a.isRequired=a;var c={array:a,bigint:a,bool:a,func:a,number:a,object:a,string:a,symbol:a,any:a,arrayOf:b,element:a,elementType:a,instanceOf:b,node:a,objectOf:b,oneOf:b,oneOfType:b,shape:b,exact:b,checkPropTypes:f,resetWarningCache:e};return c.PropTypes=c,c}},341212,(a,b,c)=>{b.exports=a.r(324560)()},163584,a=>{"use strict";var b=a.i(269240);a.i(452218);var c=a.i(571907),d=a.i(325383);let e=new class{supabase;constructor(a){this.supabase=a||(0,b.createClient)()}async getAll(a,b){try{let d=b?.page||1,e=b?.limit||50,f=(d-1)*e,g=this.supabase.from("documents").select("*, students(*)",{count:"exact"}).eq("organization_id",a);b?.studentId&&(g=g.eq("student_id",b.studentId)),b?.type&&(g=g.eq("type",b.type));let{data:h,error:i,count:j}=await g.order("created_at",{ascending:!1}).range(f,f+e-1);if(i)throw c.errorHandler.handleError(i,{operation:"getAll",organizationId:a,filters:b});return{data:h||[],total:j||0,page:d,limit:e,totalPages:Math.ceil((j||0)/e)}}catch(d){if(d instanceof c.AppError)throw d;throw c.errorHandler.handleError(d,{operation:"getAll",organizationId:a,filters:b})}}async getById(a){try{let{data:b,error:d}=await this.supabase.from("documents").select("*, students(*)").eq("id",a).single();if(d){if("PGRST116"===d.code)throw c.errorHandler.handleError(d,{code:c.ErrorCode.DB_NOT_FOUND,operation:"getById",id:a});throw c.errorHandler.handleError(d,{operation:"getById",id:a})}if(!b)throw c.errorHandler.createNotFoundError(`Document avec l'ID ${a} introuvable`,{id:a});return b}catch(b){if(b instanceof c.AppError)throw b;throw c.errorHandler.handleError(b,{operation:"getById",id:a})}}async create(a){try{if(!a.title)throw c.errorHandler.createValidationError("Le titre est obligatoire","title");if(!a.file_url)throw c.errorHandler.createValidationError("L'URL du fichier est obligatoire","file_url");let{data:b,error:e}=await this.supabase.from("documents").insert(a).select().single();if(e){if("23505"===e.code)throw c.errorHandler.handleError(e,{code:c.ErrorCode.VALIDATION_UNIQUE_CONSTRAINT,operation:"create",field:"title"});throw c.errorHandler.handleError(e,{operation:"create",document:a})}return d.logger.info("Document created successfully",{id:b?.id,organizationId:a.organization_id||void 0}),b}catch(b){if(b instanceof c.AppError)throw b;throw c.errorHandler.handleError(b,{operation:"create",document:a})}}async uploadFile(a,b){try{if(!a)throw c.errorHandler.createValidationError("Le fichier est obligatoire","file");if(!b)throw c.errorHandler.createValidationError("Le chemin est obligatoire","path");let{data:e,error:f}=await this.supabase.storage.from("documents").upload(b,a,{cacheControl:"3600",upsert:!1});if(f){if(f.message?.includes("already exists"))throw c.errorHandler.handleError(f,{code:c.ErrorCode.VALIDATION_UNIQUE_CONSTRAINT,operation:"uploadFile",path:b});throw c.errorHandler.handleError(f,{operation:"uploadFile",path:b,fileName:a.name})}return d.logger.info("File uploaded successfully",{path:b,fileName:a.name,size:a.size}),e}catch(d){if(d instanceof c.AppError)throw d;throw c.errorHandler.handleError(d,{operation:"uploadFile",path:b,fileName:a?.name})}}async getPublicUrl(a){let{data:b}=this.supabase.storage.from("documents").getPublicUrl(a);return b.publicUrl}async delete(a){try{if(!a)throw c.errorHandler.createValidationError("L'ID du document est obligatoire","id");let{error:b}=await this.supabase.from("documents").delete().eq("id",a);if(b){if("23503"===b.code)throw c.errorHandler.handleError(b,{code:c.ErrorCode.DB_FOREIGN_KEY_CONSTRAINT,operation:"delete",id:a});throw c.errorHandler.handleError(b,{operation:"delete",id:a})}d.logger.info("Document deleted successfully",{id:a})}catch(b){if(b instanceof c.AppError)throw b;throw c.errorHandler.handleError(b,{operation:"delete",id:a})}}};a.s(["documentService",0,e])},787654,a=>{"use strict";let b=(0,a.i(170106).default)("RotateCcw",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]]);a.s(["RotateCcw",()=>b],787654)},46143,a=>{"use strict";var b=a.i(187924),c=a.i(572131),d=a.i(497895),e=a.i(533441);let f=c.forwardRef(({className:a,checked:c,onCheckedChange:f,...g},h)=>(0,b.jsxs)("div",{className:"relative inline-flex items-center",children:[(0,b.jsx)("input",{type:"checkbox",ref:h,checked:c,onChange:a=>f?.(a.target.checked),className:(0,d.cn)("peer h-4 w-4 shrink-0 rounded border border-gray-300","focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-blue focus-visible:ring-offset-2","disabled:cursor-not-allowed disabled:opacity-50","cursor-pointer",c&&"border-brand-blue bg-brand-blue",a),...g}),c&&(0,b.jsx)(e.Check,{className:"absolute h-3 w-3 text-white pointer-events-none left-0.5 top-0.5"})]}));f.displayName="Checkbox",a.s(["Checkbox",()=>f])},265602,a=>{"use strict";var b=a.i(187924),c=a.i(572131),d=a.i(400187),e=a.i(497895);let f=(0,d.cva)("relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground",{variants:{variant:{default:"bg-background text-foreground",destructive:"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive"}},defaultVariants:{variant:"default"}}),g=c.forwardRef(({className:a,variant:c,...d},g)=>(0,b.jsx)("div",{ref:g,role:"alert",className:(0,e.cn)(f({variant:c}),a),...d}));g.displayName="Alert",c.forwardRef(({className:a,...c},d)=>(0,b.jsx)("h5",{ref:d,className:(0,e.cn)("mb-1 font-medium leading-none tracking-tight",a),...c})).displayName="AlertTitle";let h=c.forwardRef(({className:a,...c},d)=>(0,b.jsx)("div",{ref:d,className:(0,e.cn)("text-sm [&_p]:leading-relaxed",a),...c}));h.displayName="AlertDescription",a.s(["Alert",()=>g,"AlertDescription",()=>h])},553817,a=>{"use strict";var b=a.i(269240);a.i(452218);var c=a.i(571907),d=a.i(325383);let e=new class{supabase;constructor(a){this.supabase=a||(0,b.createClient)()}async getSignaturesByDocument(a){try{let{data:b,error:c}=await this.supabase.from("document_signatures").select(`
          *,
          signer:users!document_signatures_signer_id_fkey(id, full_name, email, role)
        `).eq("document_id",a).eq("status","signed").order("signed_at",{ascending:!0});if(c)throw c;return b||[]}catch(b){if(b instanceof c.AppError)throw b;throw c.errorHandler.handleError(b,{operation:"getSignaturesByDocument",documentId:a})}}async getSignatureById(a){try{let{data:b,error:d}=await this.supabase.from("document_signatures").select(`
          *,
          signer:users!document_signatures_signer_id_fkey(id, full_name, email, role),
          document:documents(id, title, organization_id)
        `).eq("id",a).single();if(d){if("PGRST116"===d.code)throw c.errorHandler.createNotFoundError(`Signature avec l'ID ${a} introuvable`,{signatureId:a});throw d}return b}catch(b){if(b instanceof c.AppError)throw b;throw c.errorHandler.handleError(b,{operation:"getSignatureById",signatureId:a})}}async getSignaturesByUser(a,b){try{let{data:c,error:d}=await this.supabase.from("document_signatures").select(`
          *,
          document:documents(id, title, type, organization_id)
        `).eq("signer_id",a).eq("organization_id",b).order("signed_at",{ascending:!1});if(d)throw d;return c||[]}catch(d){if(d instanceof c.AppError)throw d;throw c.errorHandler.handleError(d,{operation:"getSignaturesByUser",userId:a,organizationId:b})}}async getSignaturesBySession(a,b){try{let{data:c,error:d}=await this.supabase.from("enrollments").select("student_id").eq("session_id",a).in("status",["confirmed","completed","active"]);if(d)throw d;if(!c||0===c.length)return[];let e=c.map(a=>a.student_id).filter(Boolean),{data:f,error:g}=await this.supabase.from("documents").select("id").eq("organization_id",b).in("student_id",e);if(g)throw g;if(!f||0===f.length)return[];let h=f.map(a=>a.id),{data:i,error:j}=await this.supabase.from("document_signatures").select(`
          *,
          signer:users!document_signatures_signer_id_fkey(id, full_name, email, role),
          document:documents(id, title, type, student_id, students(id, first_name, last_name))
        `).in("document_id",h).eq("organization_id",b).order("signed_at",{ascending:!1});if(j)throw j;return i||[]}catch(d){if(d instanceof c.AppError)throw d;throw c.errorHandler.handleError(d,{operation:"getSignaturesBySession",sessionId:a,organizationId:b})}}async createSignature(a){try{let{data:b}=await this.supabase.auth.getUser();if(!b.user)throw c.errorHandler.createAuthError(c.ErrorCode.AUTH_REQUIRED,"Utilisateur non authentifié");let e=this.generateValidationCode(),f={document_id:a.documentId,organization_id:a.organizationId,signer_id:a.signerId,signature_data:a.signatureData,signature_type:a.signatureType||"handwritten",signer_name:a.signerName||b.user.user_metadata?.full_name||"Utilisateur",signer_email:a.signerEmail||b.user.email||null,signer_role:a.signerRole||null,position_x:a.positionX||null,position_y:a.positionY||null,width:a.width||200,height:a.height||80,page_number:a.pageNumber||1,status:"signed",is_valid:!0,validation_code:e,comment:a.comment||null,ip_address:null,user_agent:null},{data:g,error:h}=await this.supabase.from("document_signatures").insert(f).select(`
          *,
          signer:users!document_signatures_signer_id_fkey(id, full_name, email, role)
        `).single();if(h)throw h;return d.logger.info("Signature créée",{signatureId:g.id,documentId:a.documentId,signerId:a.signerId}),g}catch(b){if(b instanceof c.AppError)throw b;throw c.errorHandler.handleError(b,{operation:"createSignature",documentId:a.documentId,signerId:a.signerId})}}async updateSignature(a,b){try{let{data:d,error:e}=await this.supabase.from("document_signatures").update(b).eq("id",a).select().single();if(e){if("PGRST116"===e.code)throw c.errorHandler.createNotFoundError(`Signature avec l'ID ${a} introuvable`,{signatureId:a});throw e}return d}catch(b){if(b instanceof c.AppError)throw b;throw c.errorHandler.handleError(b,{operation:"updateSignature",signatureId:a})}}async revokeSignature(a,b){try{return this.updateSignature(a,{status:"revoked",is_valid:!1,comment:b||"Signature révoquée"})}catch(b){if(b instanceof c.AppError)throw b;throw c.errorHandler.handleError(b,{operation:"revokeSignature",signatureId:a})}}async deleteSignature(a){try{let{error:b}=await this.supabase.from("document_signatures").delete().eq("id",a);if(b)throw b;d.logger.info("Signature supprimée",{signatureId:a})}catch(b){if(b instanceof c.AppError)throw b;throw c.errorHandler.handleError(b,{operation:"deleteSignature",signatureId:a})}}async hasSignatures(a){try{let{count:b,error:c}=await this.supabase.from("document_signatures").select("*",{count:"exact",head:!0}).eq("document_id",a).eq("status","signed");if(c)throw c;return(b||0)>0}catch(b){if(b instanceof c.AppError)throw b;throw c.errorHandler.handleError(b,{operation:"hasSignatures",documentId:a})}}generateValidationCode(){let a=Date.now(),b=Math.random().toString(36).substring(2,15);return`${a}-${b}`}async validateSignature(a,b){try{let c=await this.getSignatureById(a);return c.validation_code===b&&!0===c.is_valid}catch(a){return!1}}};a.s(["signatureService",0,e])},102348,a=>{"use strict";var b=a.i(187924),c=a.i(572131),d=a.i(50944),e=a.i(433217),f=a.i(370025),g=a.i(937927),h=a.i(913216),i=a.i(163584),j=a.i(553817);a.i(406878);var k=a.i(140807),l=a.i(340695),m=a.i(703130),n=a.i(917171),o=a.i(546893),p=a.i(864037),q=a.i(400210),r=a.i(114548),s=a.i(633508),t=a.i(238246),u=a.i(497895);function v(){let a=(0,d.useParams)(),v=(0,d.useRouter)(),{user:w}=(0,h.useAuth)(),x=(0,g.useQueryClient)(),{addToast:y}=(0,p.useToast)(),z=a.id,[A,B]=(0,c.useState)(null),[C,D]=(0,c.useState)(""),{data:E,isLoading:F}=(0,e.useQuery)({queryKey:["document",z],queryFn:()=>i.documentService.getById(z),enabled:!!z}),{data:G}=(0,e.useQuery)({queryKey:["document-signatures",z],queryFn:()=>j.signatureService.getSignaturesByDocument(z),enabled:!!z}),H=(0,f.useMutation)({mutationFn:async()=>{if(!A||!w?.organization_id||!w?.id)throw Error("Signature requise");return j.signatureService.createSignature({documentId:z,organizationId:w.organization_id,signerId:w.id,signatureData:A,signerName:w.full_name||w.email||"Utilisateur",signerEmail:w.email||void 0,signerRole:w.role||void 0,comment:C||void 0})},onSuccess:()=>{x.invalidateQueries({queryKey:["document-signatures",z]}),x.invalidateQueries({queryKey:["document",z]}),y({title:"Signature enregistrée",description:"Votre signature a été enregistrée avec succès.",type:"success"}),v.push(`/dashboard/documents/${z}`)},onError:a=>{y({type:"error",title:"Erreur",description:a.message||"Une erreur est survenue lors de l'enregistrement de la signature."})}});if(F)return(0,b.jsx)("div",{className:"container mx-auto py-8 px-4 max-w-4xl",children:(0,b.jsx)("div",{className:"text-center py-12",children:"Chargement..."})});if(!E)return(0,b.jsx)("div",{className:"container mx-auto py-8 px-4 max-w-4xl",children:(0,b.jsx)(m.Card,{children:(0,b.jsxs)(m.CardContent,{className:"pt-6 text-center",children:[(0,b.jsx)("p",{className:"text-muted-foreground",children:"Document introuvable"}),(0,b.jsx)(t.default,{href:"/dashboard/documents",children:(0,b.jsx)(l.Button,{variant:"outline",className:"mt-4",children:"Retour aux documents"})})]})})});let I=G?.some(a=>a.signer_id===w?.id&&"signed"===a.status);return(0,b.jsxs)("div",{className:"container mx-auto py-8 px-4 max-w-4xl",children:[(0,b.jsxs)("div",{className:"mb-6",children:[(0,b.jsx)(t.default,{href:`/dashboard/documents/${z}`,children:(0,b.jsxs)(l.Button,{variant:"ghost",size:"sm",className:"mb-4",children:[(0,b.jsx)(q.ArrowLeft,{className:"h-4 w-4 mr-2"}),"Retour au document"]})}),(0,b.jsx)("h1",{className:"text-3xl font-bold mb-2",children:"Signer le document"}),(0,b.jsx)("p",{className:"text-muted-foreground",children:E.title||"Document sans titre"})]}),(0,b.jsxs)(m.Card,{className:"mb-6",children:[(0,b.jsx)(m.CardHeader,{children:(0,b.jsx)(m.CardTitle,{children:"Informations du document"})}),(0,b.jsxs)(m.CardContent,{className:"space-y-2",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)(n.Label,{className:"text-sm text-muted-foreground",children:"Type"}),(0,b.jsx)("p",{className:"font-medium",children:E.type||"Non spécifié"})]}),E.created_at&&(0,b.jsxs)("div",{children:[(0,b.jsx)(n.Label,{className:"text-sm text-muted-foreground",children:"Date de création"}),(0,b.jsx)("p",{className:"font-medium",children:(0,u.formatDate)(E.created_at)})]})]})]}),G&&G.length>0&&(0,b.jsxs)(m.Card,{className:"mb-6",children:[(0,b.jsxs)(m.CardHeader,{children:[(0,b.jsx)(m.CardTitle,{children:"Signatures existantes"}),(0,b.jsxs)(m.CardDescription,{children:[G.length," signature(s) déjà enregistrée(s)"]})]}),(0,b.jsx)(m.CardContent,{children:(0,b.jsx)("div",{className:"space-y-3",children:G.map(a=>(0,b.jsxs)("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[(0,b.jsxs)("div",{className:"flex items-center gap-4",children:[(0,b.jsx)("div",{className:"w-32 h-16 border rounded bg-white p-2",children:(0,b.jsx)("img",{src:a.signature_data,alt:"Signature",className:"w-full h-full object-contain"})}),(0,b.jsxs)("div",{children:[(0,b.jsx)("p",{className:"font-medium",children:a.signer_name||a.signer?.full_name||"Signataire"}),(0,b.jsx)("p",{className:"text-sm text-muted-foreground",children:a.signer_role||a.signer?.role||"Rôle non spécifié"}),a.signed_at&&(0,b.jsx)("p",{className:"text-xs text-muted-foreground",children:(0,u.formatDate)(a.signed_at)})]})]}),a.signer_id===w?.id&&(0,b.jsx)("span",{className:"text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded",children:"Votre signature"})]},a.id))})})]}),I?(0,b.jsx)(m.Card,{children:(0,b.jsxs)(m.CardContent,{className:"pt-6 text-center",children:[(0,b.jsx)("p",{className:"text-muted-foreground mb-4",children:"Vous avez déjà signé ce document."}),(0,b.jsx)(t.default,{href:`/dashboard/documents/${z}`,children:(0,b.jsx)(l.Button,{variant:"outline",children:"Retour au document"})})]})}):(0,b.jsxs)(b.Fragment,{children:[(0,b.jsxs)(m.Card,{className:"mb-6",children:[(0,b.jsxs)(m.CardHeader,{children:[(0,b.jsx)(m.CardTitle,{children:"Votre signature"}),(0,b.jsx)(m.CardDescription,{children:"Signez dans la zone ci-dessous. Vous pouvez également importer une image de signature."})]}),(0,b.jsx)(m.CardContent,{children:(0,b.jsx)(k.SignaturePad,{onSave:a=>B(a),onClear:()=>B(null),width:600,height:200})})]}),(0,b.jsxs)(m.Card,{className:"mb-6",children:[(0,b.jsx)(m.CardHeader,{children:(0,b.jsx)(m.CardTitle,{children:"Commentaire (optionnel)"})}),(0,b.jsx)(m.CardContent,{children:(0,b.jsx)(o.Textarea,{value:C,onChange:a=>D(a.target.value),placeholder:"Ajouter un commentaire à votre signature...",rows:3})})]}),(0,b.jsxs)("div",{className:"flex gap-4 justify-end",children:[(0,b.jsx)(t.default,{href:`/dashboard/documents/${z}`,children:(0,b.jsxs)(l.Button,{variant:"outline",children:[(0,b.jsx)(s.X,{className:"h-4 w-4 mr-2"}),"Annuler"]})}),(0,b.jsxs)(l.Button,{onClick:()=>H.mutate(),disabled:!A||H.isPending,children:[(0,b.jsx)(r.Save,{className:"h-4 w-4 mr-2"}),H.isPending?"Enregistrement...":"Enregistrer la signature"]})]})]})]})}a.s(["default",()=>v])}];

//# sourceMappingURL=_7b66bf59._.js.map