module.exports=[440955,a=>{"use strict";var b=a.i(187924),c=a.i(572131),d=a.i(50944),e=a.i(433217),f=a.i(370025),g=a.i(937927),h=a.i(269240),i=a.i(952498),j=a.i(555074),k=a.i(553817),l=a.i(913216),m=a.i(340695),n=a.i(917171),o=a.i(124987);let p=(0,a.i(170106).default)("Navigation",[["polygon",{points:"3 11 22 2 13 21 11 13 3 11",key:"1ltx0t"}]]);var q=a.i(290821),r=a.i(495756);function s({onLocationChange:a,required:d=!1,sessionLocation:e}){let[f,g]=(0,c.useState)(null),[h,i]=(0,c.useState)(""),[j,k]=(0,c.useState)(!1),[l,s]=(0,c.useState)(null),[t,u]=(0,c.useState)(null);(0,c.useEffect)(()=>{d&&v()},[d]),(0,c.useEffect)(()=>{if(f&&e?.latitude&&e?.longitude){let a=w(e.latitude,e.longitude,f.latitude,f.longitude);u(a),e.radius&&a>e.radius?s(`Vous \xeates trop loin (${Math.round(a)}m, maximum: ${e.radius}m)`):s(null)}},[f,e]);let v=async()=>{if(k(!0),s(null),!navigator.geolocation){s("Géolocalisation non supportée par votre navigateur"),k(!1);return}navigator.geolocation.getCurrentPosition(async b=>{let c={latitude:b.coords.latitude,longitude:b.coords.longitude,accuracy:b.coords.accuracy};g(c);try{let b=await fetch(`/api/geolocation/reverse-geocode?latitude=${c.latitude}&longitude=${c.longitude}`);if(b.ok){let d=await b.json();i(d.address||""),a?.({...c,address:d.address})}else a?.(c)}catch(b){a?.(c)}k(!1)},a=>{s(`Erreur de g\xe9olocalisation: ${a.message}`),k(!1)},{enableHighAccuracy:!0,timeout:1e4,maximumAge:0})},w=(a,b,c,d)=>{let e=a*Math.PI/180,f=c*Math.PI/180,g=(c-a)*Math.PI/180,h=(d-b)*Math.PI/180,i=Math.sin(g/2)*Math.sin(g/2)+Math.cos(e)*Math.cos(f)*Math.sin(h/2)*Math.sin(h/2);return 2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i))*6371e3};return(0,b.jsxs)("div",{className:"space-y-4",children:[(0,b.jsxs)("div",{className:"flex items-center justify-between",children:[(0,b.jsxs)(n.Label,{children:["Géolocalisation ",d&&"*"]}),f&&(0,b.jsxs)("div",{className:"flex items-center space-x-2 text-sm text-green-600",children:[(0,b.jsx)(r.CheckCircle,{className:"h-4 w-4"}),(0,b.jsx)("span",{children:"Localisation capturée"})]})]}),f?(0,b.jsxs)("div",{className:"space-y-2 p-4 bg-gray-50 rounded-lg",children:[(0,b.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,b.jsx)(o.MapPin,{className:"h-4 w-4 text-primary"}),(0,b.jsxs)("div",{className:"flex-1",children:[(0,b.jsx)("p",{className:"text-sm font-medium",children:h||`${f.latitude.toFixed(6)}, ${f.longitude.toFixed(6)}`}),(0,b.jsxs)("p",{className:"text-xs text-muted-foreground",children:["Précision: ",Math.round(f.accuracy),"m",null!==t&&e&&(0,b.jsxs)("span",{className:"ml-2",children:["• Distance: ",Math.round(t),"m",e.radius&&(0,b.jsxs)("span",{className:t>e.radius?"text-red-600":"text-green-600",children:[" ","(",t>e.radius?"hors zone":"dans la zone",")"]})]})]})]})]}),l&&(0,b.jsxs)("div",{className:"flex items-center space-x-2 text-sm text-red-600",children:[(0,b.jsx)(q.AlertCircle,{className:"h-4 w-4"}),(0,b.jsx)("span",{children:l})]}),(0,b.jsxs)(m.Button,{variant:"outline",size:"sm",onClick:v,disabled:j,children:[(0,b.jsx)(p,{className:"h-4 w-4 mr-2"}),j?"Mise à jour...":"Mettre à jour la localisation"]})]}):(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsxs)(m.Button,{variant:"outline",onClick:v,disabled:j,className:"w-full",children:[(0,b.jsx)(p,{className:"h-4 w-4 mr-2"}),j?"Récupération de la localisation...":"Capturer ma localisation"]}),l&&(0,b.jsxs)("div",{className:"flex items-center space-x-2 text-sm text-red-600",children:[(0,b.jsx)(q.AlertCircle,{className:"h-4 w-4"}),(0,b.jsx)("span",{children:l})]})]})]})}var t=a.i(703130),u=a.i(400210),v=a.i(114548),w=a.i(54018),x=a.i(641710),y=a.i(238246),z=a.i(497895),A=a.i(823292);function B(){let a=(0,d.useParams)(),k=(0,d.useSearchParams)();(0,d.useRouter)();let n=a.sessionId,o=k.get("date")||new Date().toISOString().split("T")[0],p=k.get("slotId")||"",{user:B}=(0,l.useAuth)(),D=(0,h.createClient)(),E=(0,g.useQueryClient)(),{data:F}=(0,e.useQuery)({queryKey:["session-slot",p],queryFn:async()=>{if(!p)return null;let{data:a,error:b}=await D.from("session_slots").select("*").eq("id",p).single();return b?(console.warn("Erreur récupération séance:",b),null):a},enabled:!!p}),{data:G}=(0,e.useQuery)({queryKey:["session",n],queryFn:async()=>await j.sessionService.getSessionById(n)}),{data:H}=(0,e.useQuery)({queryKey:["session-enrollments",n],queryFn:async()=>{let{data:a,error:b}=await D.from("enrollments").select("*, students(*)").eq("session_id",n).in("status",["confirmed","completed"]).order("students(last_name)",{ascending:!0});if(b)throw b;return a||[]}}),{data:I,refetch:J}=(0,e.useQuery)({queryKey:["attendance-session",n,o],queryFn:()=>i.attendanceService.getBySessionAndDate(n,o)}),[K,L]=(0,c.useState)({});(0,c.useEffect)(()=>{if(I&&H){let a={};I.forEach(b=>{a[b.student_id]={status:b.status,lateMinutes:b.late_minutes,notes:b.notes||""}}),H.forEach(b=>{let c=b.student_id;a[c]||(a[c]={status:"present",lateMinutes:0,notes:""})}),L(a)}else if(H){let a={};H.forEach(b=>{a[b.student_id]={status:"present",lateMinutes:0,notes:""}}),L(a)}},[I,H]);let M=(a,b,c)=>{L(d=>({...d,[a]:{...d[a],[b]:c}}))},N=(0,f.useMutation)({mutationFn:async()=>{if(!B?.organization_id||!H)throw Error("Données manquantes");let a=H.map(a=>({student_id:a.student_id,session_id:n,date:o,status:K[a.student_id]?.status||"present",late_minutes:K[a.student_id]?.lateMinutes||0,teacher_id:B.id,notes:K[a.student_id]?.notes||void 0}));return i.attendanceService.markMultiple(B.organization_id,a)},onSuccess:()=>{J(),E.invalidateQueries({queryKey:["recent-attendance"]}),E.invalidateQueries({queryKey:["attendance-stats"]}),E.invalidateQueries({queryKey:["attendance-period-stats"]}),E.invalidateQueries({queryKey:["attendance"]}),E.invalidateQueries({queryKey:["monthly-attendance-report"]}),E.invalidateQueries({queryKey:["yearly-attendance-report"]}),A.toast.success("Émargement enregistré avec succès",{description:`${Object.keys(K).length} pr\xe9sences enregistr\xe9es pour le ${(0,z.formatDate)(o)}`})},onError:a=>{A.toast.error("Erreur lors de l'enregistrement",{description:a.message})}}),O=H?.map(a=>a.students).filter(Boolean)||[],P=O.length>0?{total:O.length,present:Object.values(K).filter(a=>"present"===a.status).length,absent:Object.values(K).filter(a=>"absent"===a.status).length,late:Object.values(K).filter(a=>"late"===a.status).length,excused:Object.values(K).filter(a=>"excused"===a.status).length}:null;return(0,b.jsxs)("div",{className:"space-y-6",children:[(0,b.jsxs)("div",{className:"flex items-center justify-between",children:[(0,b.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,b.jsx)(y.default,{href:"/dashboard/attendance",children:(0,b.jsx)(m.Button,{variant:"ghost",size:"icon",children:(0,b.jsx)(u.ArrowLeft,{className:"h-4 w-4"})})}),(0,b.jsxs)("div",{children:[(0,b.jsxs)("h1",{className:"text-3xl font-bold text-gray-900",children:["Émargement - ",G?.name||"Session"]}),(0,b.jsxs)("p",{className:"mt-2 text-sm text-gray-600",children:[(0,z.formatDate)(o),F&&(0,b.jsxs)("span",{className:"ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-brand-blue-ghost text-brand-blue",children:["morning"===F.time_slot?"Matin":"afternoon"===F.time_slot?"Après-midi":"Journée complète"," • ",F.start_time," - ",F.end_time]}),G?.location&&` - ${G.location}`,F?.location&&!G?.location&&` - ${F.location}`]})]})]}),(0,b.jsxs)(m.Button,{onClick:()=>N.mutate(),disabled:N.isPending,children:[(0,b.jsx)(v.Save,{className:"mr-2 h-4 w-4"}),N.isPending?"Enregistrement...":"Enregistrer"]})]}),P&&(0,b.jsxs)("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-4",children:[(0,b.jsx)(t.Card,{children:(0,b.jsx)(t.CardContent,{className:"pt-6",children:(0,b.jsxs)("div",{className:"text-center",children:[(0,b.jsx)("div",{className:"text-2xl font-bold",children:P.total}),(0,b.jsx)("div",{className:"text-sm text-muted-foreground",children:"Total"})]})})}),(0,b.jsx)(t.Card,{children:(0,b.jsx)(t.CardContent,{className:"pt-6",children:(0,b.jsxs)("div",{className:"text-center",children:[(0,b.jsx)("div",{className:"text-2xl font-bold text-success-primary",children:P.present}),(0,b.jsx)("div",{className:"text-sm text-muted-foreground",children:"Présents"})]})})}),(0,b.jsx)(t.Card,{children:(0,b.jsx)(t.CardContent,{className:"pt-6",children:(0,b.jsxs)("div",{className:"text-center",children:[(0,b.jsx)("div",{className:"text-2xl font-bold text-red-600",children:P.absent}),(0,b.jsx)("div",{className:"text-sm text-muted-foreground",children:"Absents"})]})})}),(0,b.jsx)(t.Card,{children:(0,b.jsx)(t.CardContent,{className:"pt-6",children:(0,b.jsxs)("div",{className:"text-center",children:[(0,b.jsx)("div",{className:"text-2xl font-bold text-warning-primary",children:P.late}),(0,b.jsx)("div",{className:"text-sm text-muted-foreground",children:"En retard"})]})})}),(0,b.jsx)(t.Card,{children:(0,b.jsx)(t.CardContent,{className:"pt-6",children:(0,b.jsxs)("div",{className:"text-center",children:[(0,b.jsx)("div",{className:"text-2xl font-bold text-blue-600",children:P.excused}),(0,b.jsx)("div",{className:"text-sm text-muted-foreground",children:"Justifiés"})]})})})]}),(0,b.jsxs)(t.Card,{children:[(0,b.jsx)(t.CardHeader,{children:(0,b.jsx)(t.CardTitle,{children:"Liste des participants"})}),(0,b.jsx)(t.CardContent,{children:O.length>0?(0,b.jsx)("div",{className:"space-y-4",children:O.map(a=>{let c=K[a.id]||{status:"present",lateMinutes:0,notes:""};return(0,b.jsxs)("div",{className:"flex items-center space-x-4 p-4 border rounded-lg hover:bg-gray-50 transition-colors",children:[(0,b.jsx)("div",{className:"flex-shrink-0",children:a.photo_url?(0,b.jsx)("img",{src:a.photo_url,alt:`${a.first_name} ${a.last_name}`,className:"h-12 w-12 rounded-full object-cover"}):(0,b.jsxs)("div",{className:"h-12 w-12 rounded-full bg-primary text-white flex items-center justify-center font-semibold",children:[a.first_name.charAt(0),a.last_name.charAt(0)]})}),(0,b.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,b.jsxs)("h3",{className:"font-semibold truncate",children:[a.first_name," ",a.last_name]}),(0,b.jsx)("p",{className:"text-sm text-muted-foreground",children:a.student_number}),G?.require_location_for_attendance&&(0,b.jsx)("div",{className:"mt-2",children:(0,b.jsx)(s,{required:!1,sessionLocation:G?.latitude&&G?.longitude?{latitude:G.latitude,longitude:G.longitude,radius:G.allowed_attendance_radius_meters||void 0}:void 0,onLocationChange:b=>{M(a.id,"latitude",b.latitude),M(a.id,"longitude",b.longitude),M(a.id,"location_accuracy",b.accuracy)}})})]}),(0,b.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,b.jsx)("div",{className:"flex space-x-2",children:["present","absent","late","excused"].map(d=>(0,b.jsx)("button",{type:"button",onClick:()=>M(a.id,"status",d),className:`p-2 rounded-lg transition-colors min-touch-target touch-manipulation ${c.status===d?"bg-primary text-white":"bg-gray-100 hover:bg-gray-200"}`,title:(a=>{switch(a){case"present":return"Présent";case"absent":return"Absent";case"late":return"En retard";case"excused":return"Justifié"}})(d),children:(a=>{switch(a){case"present":return(0,b.jsx)(r.CheckCircle,{className:"h-5 w-5 text-success-primary"});case"absent":return(0,b.jsx)(w.XCircle,{className:"h-5 w-5 text-red-600"});case"late":return(0,b.jsx)(x.Clock,{className:"h-5 w-5 text-warning-primary"});case"excused":return(0,b.jsx)(q.AlertCircle,{className:"h-5 w-5 text-blue-600"})}})(d)},d))}),"late"===c.status&&(0,b.jsxs)("div",{className:"w-20",children:[(0,b.jsx)("input",{type:"number",min:"0",value:c.lateMinutes||0,onChange:b=>M(a.id,"lateMinutes",parseInt(b.target.value)||0),className:"w-full px-2 py-1 text-sm border rounded focus:ring-2 focus:ring-primary focus:border-transparent",placeholder:"min"}),(0,b.jsx)("p",{className:"text-xs text-muted-foreground text-center mt-1",children:"min"})]}),(0,b.jsx)("div",{className:"w-32",children:(0,b.jsx)("input",{type:"text",value:c.notes||"",onChange:b=>M(a.id,"notes",b.target.value),className:"w-full px-2 py-1 text-sm border rounded focus:ring-2 focus:ring-primary focus:border-transparent",placeholder:"Notes..."})})]})]},a.id)})}):(0,b.jsx)("div",{className:"text-center py-12 text-muted-foreground",children:"Aucun participant inscrit à cette session"})})]}),N.error&&(0,b.jsx)("div",{className:"bg-destructive/10 text-destructive px-4 py-3 rounded-lg text-sm",children:N.error instanceof Error?N.error.message:"Une erreur est survenue lors de l'enregistrement"}),n&&B?.organization_id&&(0,b.jsx)(C,{sessionId:n,organizationId:B.organization_id})]})}function C({sessionId:a,organizationId:c}){let{data:d,isLoading:f}=(0,e.useQuery)({queryKey:["session-signatures",a,c],queryFn:()=>k.signatureService.getSignaturesBySession(a,c),enabled:!!a&&!!c});return f?(0,b.jsxs)(t.Card,{className:"mt-6",children:[(0,b.jsx)(t.CardHeader,{children:(0,b.jsx)(t.CardTitle,{children:"Historique des signatures"})}),(0,b.jsx)(t.CardContent,{children:(0,b.jsx)("div",{className:"text-center py-8 text-muted-foreground",children:"Chargement..."})})]}):d&&0!==d.length?(0,b.jsxs)(t.Card,{className:"mt-6",children:[(0,b.jsxs)(t.CardHeader,{children:[(0,b.jsx)(t.CardTitle,{children:"Historique des signatures"}),(0,b.jsxs)("p",{className:"text-sm text-muted-foreground",children:["Signatures des documents liés aux étudiants de cette session (",d.length," signature(s))"]})]}),(0,b.jsx)(t.CardContent,{children:(0,b.jsx)("div",{className:"space-y-4",children:d.map(a=>(0,b.jsxs)("div",{className:"flex items-start gap-4 p-4 border rounded-lg hover:bg-muted/50 transition-colors",children:[(0,b.jsx)("div",{className:"flex-shrink-0 w-24 h-16 border rounded bg-white p-1.5 flex items-center justify-center",children:(0,b.jsx)("img",{src:a.signature_data,alt:`Signature de ${a.signer_name}`,className:"max-w-full max-h-full object-contain"})}),(0,b.jsx)("div",{className:"flex-1 min-w-0",children:(0,b.jsx)("div",{className:"flex items-start justify-between gap-4",children:(0,b.jsxs)("div",{className:"flex-1",children:[(0,b.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,b.jsx)("p",{className:"font-semibold",children:a.signer_name||a.signer?.full_name||"Signataire inconnu"}),"signed"===a.status&&a.is_valid&&(0,b.jsx)(r.CheckCircle,{className:"h-4 w-4 text-green-600"})]}),(0,b.jsx)("p",{className:"text-sm text-muted-foreground",children:a.signer_role||a.signer?.role||"Rôle non spécifié"}),a.document&&(0,b.jsxs)("p",{className:"text-sm font-medium mt-1",children:["Document : ",a.document.title||"Sans titre"]}),a.document?.students&&(0,b.jsxs)("p",{className:"text-xs text-muted-foreground mt-1",children:["Étudiant : ",a.document.students.first_name," ",a.document.students.last_name]}),(0,b.jsxs)("p",{className:"text-xs text-muted-foreground mt-2",children:["Signé le ",(0,z.formatDate)(a.signed_at)]}),a.comment&&(0,b.jsxs)("p",{className:"text-sm text-muted-foreground mt-2 italic border-l-2 border-muted pl-2",children:['"',a.comment,'"']})]})})})]},a.id))})})]}):null}a.s(["default",()=>B],440955)}];

//# sourceMappingURL=app_%28dashboard%29_dashboard_attendance_session_%5BsessionId%5D_page_tsx_4595de35._.js.map