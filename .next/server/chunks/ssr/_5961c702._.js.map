{"version":3,"sources":["../../../../lib/hooks/use-auth.ts","../../../../app/auth/register/page.tsx"],"sourcesContent":["'use client'\n\nimport { useQuery, useMutation, useQueryClient } from '@tanstack/react-query'\nimport { useRouter } from 'next/navigation'\nimport { createClient } from '@/lib/supabase/client'\nimport { User } from '@supabase/supabase-js'\nimport { Database } from '@/types/database.types'\nimport { useEffect } from 'react'\nimport type { TableRow } from '@/lib/types/supabase-helpers'\nimport { logger } from '@/lib/utils/logger'\n\ntype UserRow = Database['public']['Tables']['users']['Row'] | null\ntype Organization = TableRow<'organizations'>\n\nexport function useAuth() {\n  const supabase = createClient()\n  const router = useRouter()\n  const queryClient = useQueryClient()\n\n  // Récupérer la session actuelle\n  const { data: session, isLoading: sessionLoading } = useQuery({\n    queryKey: ['session'],\n    queryFn: async () => {\n      try {\n        // Timeout de 3 secondes pour éviter les blocages\n        const timeoutPromise = new Promise<null>((_, reject) => {\n          setTimeout(() => reject(new Error('Session timeout')), 3000)\n        })\n\n        const sessionPromise = supabase.auth.getSession().then(({ data: { session }, error }) => {\n          if (error) {\n            logger.error('Session error', error as Error)\n            return null\n          }\n          return session\n        })\n\n        return await Promise.race([sessionPromise, timeoutPromise])\n      } catch (error) {\n        // En cas d'erreur ou de timeout, retourner null pour ne pas bloquer\n        return null\n      }\n    },\n    retry: false,\n    refetchOnWindowFocus: false,\n    refetchOnMount: false,\n    staleTime: 1000 * 60 * 5, // Cache pendant 5 minutes\n  })\n\n  // Récupérer l'utilisateur depuis la table users\n  const { data: user, isLoading: userLoading } = useQuery<UserRow>({\n    queryKey: ['user', session?.user?.id],\n    queryFn: async (): Promise<UserRow> => {\n      if (!session?.user?.id) {\n        return null\n      }\n      \n      try {\n        // Timeout de 3 secondes pour éviter les blocages\n        const timeoutPromise = new Promise<UserRow>((_, reject) => {\n          setTimeout(() => reject(new Error('User fetch timeout')), 3000)\n        })\n\n        const userPromise = supabase\n          .from('users')\n          .select('id, organization_id, email, full_name, phone, avatar_url, role, permissions, is_active, last_login_at, created_at, updated_at')\n          .eq('id', session.user.id)\n          .maybeSingle()\n          .then(async ({ data, error }) => {\n            if (error) {\n              // Si l'utilisateur n'existe pas, retourner null sans erreur\n              if (error.code === 'PGRST116' || error.message?.includes('No rows')) {\n                return null\n              }\n              return null\n            }\n\n            // Si l'utilisateur n'existe pas dans public.users mais qu'il y a une session,\n            // synchroniser automatiquement depuis auth.users\n            if (!data && session?.user?.id) {\n              logger.info('User not found in public.users, attempting to sync from auth.users...')\n              \n              try {\n                // Appeler la fonction RPC pour synchroniser\n                const { data: syncResult, error: syncError } = await supabase.rpc(\n                  'sync_user_from_auth',\n                  { user_id: session.user.id }\n                )\n\n                if (syncError) {\n                  logger.error('Error syncing user:', syncError)\n                  // Ne pas throw, on continue avec null pour éviter de bloquer l'app\n                } else if ((syncResult as any)?.success) {\n                  logger.info('User synced successfully, refetching...', { syncResult })\n                  \n                  // Attendre un peu pour s'assurer que l'utilisateur est disponible\n                  await new Promise(resolve => setTimeout(resolve, 100))\n                  \n                  // Refetch l'utilisateur après synchronisation\n                  const { data: syncedUser, error: refetchError } = await supabase\n                    .from('users')\n                    .select('id, organization_id, email, full_name, phone, avatar_url, role, permissions, is_active, last_login_at, created_at, updated_at')\n                    .eq('id', session.user.id)\n                    .maybeSingle()\n                  \n                  if (refetchError) {\n                    logger.error('Error refetching synced user:', refetchError)\n                    // Invalider le cache pour forcer un nouveau fetch\n                    queryClient.invalidateQueries({ queryKey: ['user', session.user.id] })\n                    return null\n                  } else if (syncedUser) {\n                    logger.info('Synced user retrieved successfully:', { id: syncedUser.id, email: syncedUser.email, hasOrg: !!syncedUser.organization_id })\n                    // Retourner l'utilisateur synchronisé - React Query mettra à jour le cache automatiquement\n                    return syncedUser\n                  } else {\n                    logger.warn('User sync succeeded but refetch returned null - invalidating cache and retrying...')\n                    // Si le refetch retourne null, invalider le cache et laisser React Query refetch\n                    queryClient.invalidateQueries({ queryKey: ['user', session.user.id] })\n                    return null\n                  }\n                }\n              } catch (syncException) {\n                logger.error('Exception during user sync:', syncException)\n              }\n              \n              // Si la synchronisation a échoué, retourner null\n              return null\n            }\n\n            if (!data) {\n              return null\n            }\n\n            // Vérifier que l'utilisateur a un organization_id\n            if (!data.organization_id) {\n              logger.warn('User exists but has no organization_id')\n            }\n\n            return data\n          })\n\n        return (await Promise.race([userPromise, timeoutPromise])) as UserRow\n      } catch (err) {\n        // En cas d'erreur ou de timeout, retourner null pour ne pas bloquer\n        return null\n      }\n    },\n    enabled: !!session?.user?.id && !sessionLoading,\n    retry: false,\n    refetchOnWindowFocus: false,\n    refetchOnMount: false,\n    staleTime: 1000 * 60 * 5, // Cache pendant 5 minutes\n  })\n\n  // Connexion\n  const loginMutation = useMutation({\n    mutationFn: async ({ email, password }: { email: string; password: string }) => {\n      const { data, error } = await supabase.auth.signInWithPassword({\n        email,\n        password,\n      })\n      if (error) throw error\n      return data\n    },\n    onSuccess: async () => {\n      // Invalider les queries pour forcer le rechargement\n      queryClient.invalidateQueries({ queryKey: ['session'] })\n      queryClient.invalidateQueries({ queryKey: ['user'] })\n      \n      // Attendre un peu pour que la session soit mise à jour\n      await new Promise(resolve => setTimeout(resolve, 300))\n      \n      // Rediriger vers le dashboard (le dashboard détectera automatiquement le rôle)\n      router.push('/dashboard')\n    },\n  })\n\n  // Inscription\n  const registerMutation = useMutation({\n    mutationFn: async ({\n      email,\n      password,\n      fullName,\n      organizationName,\n    }: {\n      email: string\n      password: string\n      fullName: string\n      organizationName: string\n    }) => {\n      // 1. Créer l'utilisateur dans auth\n      const { data: authData, error: authError } = await supabase.auth.signUp({\n        email,\n        password,\n      })\n      if (authError) {\n        logger.error('Auth signup error', new Error(authError.message), {\n          status: authError.status,\n        })\n        \n        // Gérer l'erreur de rate limiting\n        if (authError.status === 429 || authError.message?.includes('2 seconds')) {\n          throw new Error('Trop de tentatives. Veuillez attendre quelques secondes avant de réessayer.')\n        }\n        \n        throw new Error(authError.message || 'Erreur lors de la création du compte')\n      }\n      if (!authData.user) throw new Error('Erreur lors de la création du compte')\n\n      // Avec Supabase, signUp peut retourner null pour la session si l'email nécessite une confirmation\n      // On essaie de récupérer la session de plusieurs façons\n      let currentSession = authData.session\n      \n      // Si pas de session immédiatement, attendre un peu et réessayer\n      if (!currentSession) {\n        await new Promise(resolve => setTimeout(resolve, 1000))\n        \n        // Essayer de récupérer la session\n        const { data: { session: newSession } } = await supabase.auth.getSession()\n        currentSession = newSession\n      }\n\n      // Si toujours pas de session, essayer refreshSession\n      if (!currentSession && authData.user) {\n        const { data: { session: refreshedSession } } = await supabase.auth.refreshSession()\n        currentSession = refreshedSession\n      }\n\n      // Si toujours pas de session, attendre encore et réessayer\n      if (!currentSession) {\n        await new Promise(resolve => setTimeout(resolve, 2000))\n        \n        const { data: { session: retrySession } } = await supabase.auth.getSession()\n        if (retrySession) {\n          currentSession = retrySession\n        }\n      }\n\n      // Si toujours pas de session, mais qu'on a un user, on continue quand même\n      // (certaines configurations Supabase nécessitent une confirmation email)\n      if (!currentSession && !authData.user) {\n        throw new Error('Erreur : la session n\\'a pas pu être établie. Vérifiez votre email pour confirmer votre compte si nécessaire.')\n      }\n\n      // Utiliser l'ID utilisateur (de la session ou de authData)\n      const userId = currentSession?.user?.id || authData.user.id\n\n      // 2. Créer l'organisation en utilisant la fonction SQL (bypass RLS)\n      const orgCode = organizationName.toUpperCase().replace(/\\s+/g, '').slice(0, 6)\n      \n      // Essayer d'abord avec la fonction SQL (si elle existe)\n      let orgId: string | null = null\n      let funcError: any = null\n      \n      // Utiliser userId au lieu de vérifier la session (on a déjà userId ci-dessus)\n      if (!userId) {\n        throw new Error('Erreur : impossible d\\'obtenir l\\'ID utilisateur')\n      }\n      \n      // Essayer d'abord avec la fonction SQL\n      try {\n        // Appeler la fonction avec user_id en paramètre pour contourner le problème de session\n        const { data: funcResult, error: rpcError } = await supabase.rpc(\n          'create_organization_for_user',\n          {\n            org_name: organizationName,\n            org_code: orgCode,\n            org_type: 'primary',\n            org_country: 'SN',\n            org_currency: 'XOF',\n            org_language: 'fr',\n            org_timezone: 'Africa/Dakar',\n            user_id: userId,\n          }\n        )\n        \n        if (rpcError) {\n          funcError = rpcError\n          \n          // Si l'erreur est \"User must be authenticated\", essayer sans user_id\n          if (rpcError.code === 'P0001' && rpcError.message?.includes('User must be authenticated')) {\n            const retryResult = await supabase.rpc(\n              'create_organization_for_user',\n              {\n                org_name: organizationName,\n                org_code: orgCode,\n                org_type: 'primary',\n                org_country: 'SN',\n                org_currency: 'XOF',\n                org_language: 'fr',\n                org_timezone: 'Africa/Dakar',\n              }\n            )\n            \n            if (retryResult.error) {\n              funcError = retryResult.error\n            } else if (retryResult.data) {\n              orgId = retryResult.data as string\n            }\n          }\n        } else if (funcResult) {\n          orgId = funcResult as string\n        }\n      } catch (funcErr) {\n        funcError = funcErr\n      }\n\n      // Si la fonction n'a pas fonctionné, essayer l'insertion directe\n      let org: any = null\n      if (!orgId) {\n        const { data: orgData, error: orgError } = await supabase\n        .from('organizations')\n        .insert({\n            name: organizationName,\n            code: orgCode,\n            type: 'primary' as const,\n            country: 'SN',\n            currency: 'XOF',\n            language: 'fr',\n            timezone: 'Africa/Dakar',\n            subscription_tier: 'free' as const,\n            subscription_status: 'active' as const,\n            settings: {} as Organization['settings'],\n          })\n          .select('id, name, code')\n          .single()\n\n        if (orgError) {\n          console.error('Organization creation error:', orgError)\n          console.error('Error details:', {\n            code: orgError.code,\n            message: orgError.message,\n            details: orgError.details,\n            hint: orgError.hint,\n          })\n          \n          // Si c'est une erreur RLS, donner des instructions plus claires\n          if (orgError.code === '42501') {\n            throw new Error(\n              'Erreur de sécurité (RLS) : Impossible de créer l\\'organisation. ' +\n              'Les politiques RLS bloquent la création. ' +\n              'INSTRUCTIONS : ' +\n              '1. Exécutez le script supabase/create_organization_function.sql dans Supabase SQL Editor ' +\n              '2. OU exécutez le script supabase/fix_rls_urgent.sql pour corriger les politiques RLS ' +\n              '3. Attendez quelques secondes puis réessayez'\n            )\n          }\n          \n          throw new Error(`Impossible de créer l'organisation : ${orgError.message}`)\n        }\n        \n        org = orgData\n        orgId = orgData?.id\n      } else {\n        // L'organisation a été créée par la fonction SQL, on utilise directement orgId\n        // Pas besoin de récupérer l'organisation car RLS peut bloquer\n        // On créera un objet minimal avec les données qu'on a\n        org = {\n          id: orgId,\n          name: organizationName,\n          code: orgCode,\n        }\n      }\n\n      if (!orgId) {\n        throw new Error('Erreur : l\\'organisation n\\'a pas été créée correctement')\n      }\n      \n      // Utiliser orgId au lieu de org.id\n      const finalOrgId = orgId || org?.id\n      if (!finalOrgId) {\n        throw new Error('Erreur : impossible d\\'obtenir l\\'ID de l\\'organisation')\n      }\n\n      // 3. Créer l'utilisateur dans la table users en utilisant une fonction SQL (bypass RLS)\n      let createdUser: any = null\n      let userError: any = null\n      \n      try {\n        // Essayer d'abord avec la fonction SQL\n        const { data: createdUserId, error: rpcUserError } = await (supabase.rpc as any)(\n          'create_user_for_organization',\n          {\n            user_id: userId,\n            user_email: email,\n            user_full_name: fullName,\n            organization_id: finalOrgId,\n          }\n        )\n        \n        if (rpcUserError) {\n          userError = rpcUserError\n          \n          // Si la fonction n'existe pas, essayer l'insertion directe\n          if (rpcUserError.code === '42883') {\n            \n            const { data: userData, error: directUserError } = await supabase\n              .from('users')\n              .insert({\n                id: userId,\n                organization_id: finalOrgId,\n                email,\n                full_name: fullName,\n                role: 'admin',\n                is_active: true,\n              })\n              .select('id, organization_id, email, full_name, role')\n        .single()\n\n            if (directUserError) {\n              userError = directUserError\n            } else {\n              createdUser = userData\n            }\n          }\n        } else if (createdUserId) {\n          // L'utilisateur a été créé, créer un objet minimal\n          createdUser = {\n            id: createdUserId,\n            organization_id: finalOrgId,\n            email,\n            full_name: fullName,\n            role: 'admin',\n          }\n        }\n      } catch (userErr) {\n        userError = userErr\n      }\n\n      if (userError) {\n        // Si l'erreur est RLS, donner des instructions\n        if (userError.code === '42501') {\n          throw new Error(\n            'Erreur RLS lors de la création de l\\'utilisateur. ' +\n            'Exécutez le script supabase/create_user_function.sql dans Supabase SQL Editor, ' +\n            'ou utilisez supabase/fix_existing_user.sql pour créer l\\'utilisateur manuellement.'\n          )\n        }\n        \n        throw userError\n      }\n\n      if (!createdUser) {\n        throw new Error('Erreur : l\\'utilisateur n\\'a pas été créé')\n      }\n\n      if (!createdUser?.organization_id) {\n        throw new Error('Erreur : l\\'utilisateur n\\'a pas d\\'organization_id')\n      }\n\n      // 4. Invalider les queries pour forcer le rechargement\n      queryClient.invalidateQueries({ queryKey: ['user', userId] })\n      queryClient.invalidateQueries({ queryKey: ['session'] })\n\n      // Si on n'a pas de session, attendre un peu et réessayer une dernière fois\n      if (!currentSession) {\n        await new Promise(resolve => setTimeout(resolve, 1000))\n        const { data: { session: finalSession } } = await supabase.auth.getSession()\n        if (finalSession) {\n          return { ...authData, session: finalSession }\n        }\n      }\n\n      return authData\n    },\n    onSuccess: async (authData) => {\n      // Attendre un peu pour que la session soit mise à jour\n      await new Promise(resolve => setTimeout(resolve, 1500))\n      \n      // Vérifier que la session existe avant de rediriger\n      const supabase = createClient()\n      const { data: { session } } = await supabase.auth.getSession()\n      \n      queryClient.invalidateQueries({ queryKey: ['session'] })\n      if (authData.user) {\n        queryClient.invalidateQueries({ queryKey: ['user', authData.user.id] })\n      }\n      \n      if (session) {\n        router.push('/dashboard')\n      } else {\n        // Si pas de session, peut-être que l'email nécessite une confirmation\n        router.push('/auth/login?message=confirm-email')\n      }\n    },\n  })\n\n  // Déconnexion\n  const logoutMutation = useMutation({\n    mutationFn: async () => {\n      const { error } = await supabase.auth.signOut()\n      if (error) throw error\n    },\n    onSuccess: () => {\n      queryClient.clear()\n      router.push('/')\n    },\n  })\n\n  // Écouter les changements de session\n  useEffect(() => {\n    const {\n      data: { subscription },\n    } = supabase.auth.onAuthStateChange((_event, session) => {\n      queryClient.setQueryData(['session'], session)\n      if (!session) {\n        queryClient.clear()\n      }\n    })\n\n    return () => subscription.unsubscribe()\n  }, [supabase, queryClient])\n\n  const isLoading = sessionLoading || userLoading\n\n  return {\n    session,\n    user,\n    isLoading,\n    isAuthenticated: !!session,\n    login: loginMutation.mutate,\n    register: registerMutation.mutate,\n    logout: logoutMutation.mutate,\n    isLoggingIn: loginMutation.isPending,\n    isRegistering: registerMutation.isPending,\n    isLoggingOut: logoutMutation.isPending,\n    loginError: loginMutation.error,\n    registerError: registerMutation.error,\n  }\n}\n\n","'use client'\n\nimport { useState } from 'react'\nimport Link from 'next/link'\nimport { useAuth } from '@/lib/hooks/use-auth'\nimport { Button } from '@/components/ui/button'\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'\n\nexport default function RegisterPage() {\n  const { register, isRegistering, registerError } = useAuth()\n  const [formData, setFormData] = useState({\n    organizationName: '',\n    fullName: '',\n    email: '',\n    password: '',\n    confirmPassword: '',\n  })\n  const [error, setError] = useState<string | null>(null)\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault()\n    setError(null)\n\n    // Validation\n    if (formData.password !== formData.confirmPassword) {\n      setError('Les mots de passe ne correspondent pas')\n      return\n    }\n\n    if (formData.password.length < 8) {\n      setError('Le mot de passe doit contenir au moins 8 caractères')\n      return\n    }\n\n    try {\n      register({\n        email: formData.email,\n        password: formData.password,\n        fullName: formData.fullName,\n        organizationName: formData.organizationName,\n      })\n    } catch (err) {\n      setError(err instanceof Error ? err.message : 'Une erreur est survenue')\n    }\n  }\n\n  return (\n    <div className=\"min-h-screen flex items-center justify-center bg-gradient-to-b from-blue-50 to-white px-4 py-8\">\n      <Card className=\"w-full max-w-md\">\n        <CardHeader className=\"text-center\">\n          <CardTitle className=\"text-3xl font-bold text-primary\">eduzen</CardTitle>\n          <CardDescription className=\"text-lg\">\n            Créez votre établissement\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <form onSubmit={handleSubmit} className=\"space-y-4\">\n            <div>\n              <label htmlFor=\"organizationName\" className=\"block text-sm font-medium mb-2\">\n                Nom de l'établissement *\n              </label>\n              <input\n                id=\"organizationName\"\n                type=\"text\"\n                value={formData.organizationName}\n                onChange={(e) => setFormData({ ...formData, organizationName: e.target.value })}\n                required\n                className=\"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target\"\n                placeholder=\"Lycée Moderne\"\n              />\n            </div>\n\n            <div>\n              <label htmlFor=\"fullName\" className=\"block text-sm font-medium mb-2\">\n                Votre nom complet *\n              </label>\n              <input\n                id=\"fullName\"\n                type=\"text\"\n                value={formData.fullName}\n                onChange={(e) => setFormData({ ...formData, fullName: e.target.value })}\n                required\n                className=\"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target\"\n                placeholder=\"Jean Dupont\"\n              />\n            </div>\n\n            <div>\n              <label htmlFor=\"email\" className=\"block text-sm font-medium mb-2\">\n                Email *\n              </label>\n              <input\n                id=\"email\"\n                type=\"email\"\n                value={formData.email}\n                onChange={(e) => setFormData({ ...formData, email: e.target.value })}\n                required\n                className=\"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target\"\n                placeholder=\"votre@email.com\"\n                autoComplete=\"email\"\n              />\n            </div>\n\n            <div>\n              <label htmlFor=\"password\" className=\"block text-sm font-medium mb-2\">\n                Mot de passe *\n              </label>\n              <input\n                id=\"password\"\n                type=\"password\"\n                value={formData.password}\n                onChange={(e) => setFormData({ ...formData, password: e.target.value })}\n                required\n                minLength={8}\n                className=\"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target\"\n                placeholder=\"Au moins 8 caractères\"\n                autoComplete=\"new-password\"\n              />\n            </div>\n\n            <div>\n              <label htmlFor=\"confirmPassword\" className=\"block text-sm font-medium mb-2\">\n                Confirmer le mot de passe *\n              </label>\n              <input\n                id=\"confirmPassword\"\n                type=\"password\"\n                value={formData.confirmPassword}\n                onChange={(e) => setFormData({ ...formData, confirmPassword: e.target.value })}\n                required\n                className=\"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target\"\n                placeholder=\"••••••••\"\n                autoComplete=\"new-password\"\n              />\n            </div>\n\n            {(error || registerError) && (\n              <div className=\"bg-destructive/10 text-destructive px-4 py-3 rounded-lg text-sm\">\n                {error || (registerError instanceof Error ? registerError.message : 'Une erreur est survenue')}\n              </div>\n            )}\n\n            <Button\n              type=\"submit\"\n              className=\"w-full\"\n              disabled={isRegistering}\n            >\n              {isRegistering ? 'Création...' : 'Créer mon compte'}\n            </Button>\n          </form>\n\n          <div className=\"mt-6 text-center text-sm\">\n            <span className=\"text-muted-foreground\">Déjà un compte ? </span>\n            <Link href=\"/auth/login\" className=\"text-primary font-semibold hover:underline\">\n              Se connecter\n            </Link>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  )\n}\n\n"],"names":[],"mappings":"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"}