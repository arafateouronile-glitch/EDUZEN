module.exports=[879102,a=>{"use strict";var b=a.i(187924),c=a.i(572131),d=a.i(433217),e=a.i(370025),f=a.i(937927),g=a.i(913216),h=a.i(269240);let i=new class{supabase;constructor(a){this.supabase=a||(0,h.createClient)()}async getAll(a,b){let c=this.supabase.from("sites").select("*").eq("organization_id",a);b?.isActive!==void 0&&(c=c.eq("is_active",b.isActive)),b?.type&&(c=c.eq("type",b.type)),b?.search&&(c=c.or(`name.ilike.%${b.search}%,city.ilike.%${b.search}%,code.ilike.%${b.search}%`));let{data:d,error:e}=await c.order("is_headquarters",{ascending:!1}).order("name",{ascending:!0});if(e)throw e;return d||[]}async getById(a){let{data:b,error:c}=await this.supabase.from("sites").select("*").eq("id",a).single();if(c)throw c;return b}async getHeadquarters(a){let{data:b,error:c}=await this.supabase.from("sites").select("*").eq("organization_id",a).eq("is_headquarters",!0).eq("is_active",!0).maybeSingle();if(c)throw c;return b}async create(a){if(a.is_headquarters){let b=await this.getHeadquarters(a.organization_id);if(b&&b.id!==a.id)throw Error("Il existe dÃ©jÃ  un siÃ¨ge principal. DÃ©signez d'abord le nouveau siÃ¨ge comme non-siÃ¨ge.")}let{data:b,error:c}=await this.supabase.from("sites").insert(a).select().single();if(c)throw c;return b}async update(a,b){if(b.is_headquarters){let b=await this.getById(a);if(b.organization_id){let c=await this.getHeadquarters(b.organization_id);c&&c.id!==a&&await this.supabase.from("sites").update({is_headquarters:!1}).eq("id",c.id)}}let{data:c,error:d}=await this.supabase.from("sites").update(b).eq("id",a).select().single();if(d)throw d;return c}async delete(a){let{error:b}=await this.supabase.from("sites").update({is_active:!1}).eq("id",a);if(b)throw b}async getPublicSites(a){let{data:b,error:c}=await this.supabase.from("sites").select("*").eq("organization_id",a).eq("is_active",!0).order("is_headquarters",{ascending:!1}).order("name",{ascending:!0});if(c)throw c;return b||[]}calculateDistance(a,b,c,d){let e=this.toRad(c-a),f=this.toRad(d-b),g=Math.sin(e/2)*Math.sin(e/2)+Math.cos(this.toRad(a))*Math.cos(this.toRad(c))*Math.sin(f/2)*Math.sin(f/2);return 2*Math.atan2(Math.sqrt(g),Math.sqrt(1-g))*6371}toRad(a){return Math.PI/180*a}async findNearestSites(a,b,c,d=5){return(await this.getPublicSites(a)).filter(a=>a.latitude&&a.longitude).map(a=>({...a,distance:this.calculateDistance(b,c,Number(a.latitude),Number(a.longitude))})).sort((a,b)=>(a.distance||0)-(b.distance||0)).slice(0,d)}};var j=a.i(340695),k=a.i(703130),l=a.i(965733),m=a.i(205522),n=a.i(917171),o=a.i(546893),p=a.i(280281),q=a.i(864037),r=a.i(915618),s=a.i(124987),t=a.i(267900),u=a.i(683245),v=a.i(781560),w=a.i(495756),x=a.i(54018),y=a.i(491829);function z(){return(0,b.jsx)(y.RoleGuard,{allowedRoles:y.FORMATION_MANAGEMENT_ROLES,children:(0,b.jsx)(A,{})})}function A(){let{user:a}=(0,g.useAuth)(),h=(0,f.useQueryClient)(),{addToast:l}=(0,q.useToast)(),[m,n]=(0,c.useState)(!1),[o,p]=(0,c.useState)(null),{data:y,isLoading:z}=(0,d.useQuery)({queryKey:["sites",a?.organization_id],queryFn:async()=>a?.organization_id?i.getAll(a.organization_id):[],enabled:!!a?.organization_id}),A=(0,e.useMutation)({mutationFn:async b=>{if(!a?.organization_id)throw Error("Organization ID missing");return i.create({...b,organization_id:a.organization_id})},onSuccess:()=>{h.invalidateQueries({queryKey:["sites"]}),n(!1),l({title:"SuccÃ¨s",description:"Site crÃ©Ã© avec succÃ¨s",type:"success"})},onError:a=>{l({title:"Erreur",description:a.message||"Erreur lors de la crÃ©ation du site",type:"error"})}}),C=(0,e.useMutation)({mutationFn:async({id:a,data:b})=>i.update(a,b),onSuccess:()=>{h.invalidateQueries({queryKey:["sites"]}),n(!1),p(null),l({title:"SuccÃ¨s",description:"Site mis Ã  jour avec succÃ¨s",type:"success"})},onError:a=>{l({title:"Erreur",description:a.message||"Erreur lors de la mise Ã  jour",type:"error"})}}),D=(0,e.useMutation)({mutationFn:async a=>i.delete(a),onSuccess:()=>{h.invalidateQueries({queryKey:["sites"]}),l({title:"SuccÃ¨s",description:"Site supprimÃ© avec succÃ¨s",type:"success"})},onError:a=>{l({title:"Erreur",description:a.message||"Erreur lors de la suppression",type:"error"})}}),E=async a=>{confirm("ÃŠtes-vous sÃ»r de vouloir supprimer ce site ?")&&D.mutate(a)};return a?.organization_id?(0,b.jsxs)("div",{className:"p-6 space-y-6",children:[(0,b.jsxs)("div",{className:"flex justify-between items-center",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("h1",{className:"text-3xl font-bold",children:"Sites et Antennes"}),(0,b.jsx)("p",{className:"text-gray-600 mt-1",children:"GÃ©rez les sites et antennes de votre organisation"})]}),(0,b.jsxs)(j.Button,{onClick:()=>{p(null),n(!0)},className:"bg-brand-blue hover:bg-brand-blue-dark",children:[(0,b.jsx)(r.Plus,{className:"w-4 h-4 mr-2"}),"Nouveau site"]})]}),z?(0,b.jsx)("div",{className:"text-center py-12",children:"Chargement..."}):y&&y.length>0?(0,b.jsx)("div",{className:"grid md:grid-cols-2 lg:grid-cols-3 gap-6",children:y.map(a=>(0,b.jsxs)(k.Card,{className:"hover:shadow-lg transition-shadow",children:[(0,b.jsx)(k.CardHeader,{children:(0,b.jsxs)("div",{className:"flex justify-between items-start",children:[(0,b.jsxs)("div",{className:"flex-1",children:[(0,b.jsxs)(k.CardTitle,{className:"flex items-center gap-2",children:[(0,b.jsx)(t.Building2,{className:"w-5 h-5 text-brand-blue"}),a.name]}),a.is_headquarters&&(0,b.jsx)("span",{className:"inline-block mt-2 px-2 py-1 text-xs bg-yellow-100 text-yellow-800 rounded-full",children:"SiÃ¨ge principal"}),(0,b.jsx)("span",{className:"inline-block mt-2 ml-2 px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full",children:a.type})]}),(0,b.jsxs)("div",{className:"flex gap-2",children:[(0,b.jsx)(j.Button,{variant:"outline",size:"icon",onClick:()=>{p(a),n(!0)},children:(0,b.jsx)(u.Edit,{className:"w-4 h-4"})}),(0,b.jsx)(j.Button,{variant:"outline",size:"icon",onClick:()=>E(a.id),children:(0,b.jsx)(v.Trash2,{className:"w-4 h-4 text-red-600"})})]})]})}),(0,b.jsxs)(k.CardContent,{className:"space-y-2",children:[a.address&&(0,b.jsxs)("div",{className:"flex items-start text-sm text-gray-600",children:[(0,b.jsx)(s.MapPin,{className:"w-4 h-4 mr-2 mt-0.5"}),(0,b.jsxs)("div",{children:[(0,b.jsx)("div",{children:a.address}),a.postal_code&&a.city&&(0,b.jsxs)("div",{children:[a.postal_code," ",a.city]}),a.country&&(0,b.jsx)("div",{children:a.country})]})]}),a.phone&&(0,b.jsxs)("div",{className:"text-sm text-gray-600",children:["ðŸ“ž ",a.phone]}),a.email&&(0,b.jsxs)("div",{className:"text-sm text-gray-600",children:["âœ‰ï¸ ",a.email]}),(0,b.jsx)("div",{className:"flex items-center gap-2 pt-2 border-t",children:a.is_active?(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(w.CheckCircle,{className:"w-4 h-4 text-green-600"}),(0,b.jsx)("span",{className:"text-sm text-green-600",children:"Actif"})]}):(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(x.XCircle,{className:"w-4 h-4 text-gray-400"}),(0,b.jsx)("span",{className:"text-sm text-gray-400",children:"Inactif"})]})})]})]},a.id))}):(0,b.jsx)(k.Card,{children:(0,b.jsxs)(k.CardContent,{className:"text-center py-12",children:[(0,b.jsx)("p",{className:"text-gray-600",children:"Aucun site configurÃ©"}),(0,b.jsxs)(j.Button,{onClick:()=>n(!0),className:"mt-4 bg-brand-blue hover:bg-brand-blue-dark",children:[(0,b.jsx)(r.Plus,{className:"w-4 h-4 mr-2"}),"CrÃ©er le premier site"]})]})}),(0,b.jsx)(B,{open:m,onClose:()=>{n(!1),p(null)},site:o,onSubmit:a=>{o?C.mutate({id:o.id,data:a}):A.mutate(a)},isSubmitting:A.isPending||C.isPending})]}):(0,b.jsx)("div",{className:"p-6",children:(0,b.jsx)("p",{children:"Aucune organisation"})})}function B({open:a,onClose:d,site:e,onSubmit:f,isSubmitting:g}){let[h,i]=(0,c.useState)({name:"",code:"",type:"site",address:"",city:"",postal_code:"",country:"FR",phone:"",email:"",is_active:!0,is_headquarters:!1,description:"",latitude:"",longitude:""});return(0,c.useEffect)(()=>{e?i({name:e.name||"",code:e.code||"",type:e.type||"site",address:e.address||"",city:e.city||"",postal_code:e.postal_code||"",country:e.country||"FR",phone:e.phone||"",email:e.email||"",is_active:e.is_active??!0,is_headquarters:e.is_headquarters??!1,description:e.description||"",latitude:e.latitude?.toString()||"",longitude:e.longitude?.toString()||""}):i({name:"",code:"",type:"site",address:"",city:"",postal_code:"",country:"FR",phone:"",email:"",is_active:!0,is_headquarters:!1,description:"",latitude:"",longitude:""})},[e,a]),(0,b.jsx)(l.Dialog,{open:a,onOpenChange:d,children:(0,b.jsxs)(l.DialogContent,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[(0,b.jsx)(l.DialogHeader,{children:(0,b.jsx)(l.DialogTitle,{children:e?"Modifier le site":"Nouveau site"})}),(0,b.jsxs)("form",{onSubmit:a=>{a.preventDefault(),f({...h,latitude:h.latitude?parseFloat(h.latitude):null,longitude:h.longitude?parseFloat(h.longitude):null})},className:"space-y-4",children:[(0,b.jsxs)("div",{className:"grid md:grid-cols-2 gap-4",children:[(0,b.jsxs)("div",{children:[(0,b.jsxs)(n.Label,{htmlFor:"name",children:["Nom du site ",(0,b.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,b.jsx)(m.Input,{id:"name",value:h.name,onChange:a=>i({...h,name:a.target.value}),required:!0,disabled:g})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)(n.Label,{htmlFor:"code",children:"Code (optionnel)"}),(0,b.jsx)(m.Input,{id:"code",value:h.code,onChange:a=>i({...h,code:a.target.value}),disabled:g})]})]}),(0,b.jsxs)("div",{className:"grid md:grid-cols-2 gap-4",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)(n.Label,{htmlFor:"type",children:"Type"}),(0,b.jsxs)("select",{id:"type",value:h.type,onChange:a=>i({...h,type:a.target.value}),className:"w-full px-3 py-2 border rounded-lg",disabled:g,children:[(0,b.jsx)("option",{value:"headquarters",children:"SiÃ¨ge"}),(0,b.jsx)("option",{value:"site",children:"Site"}),(0,b.jsx)("option",{value:"antenna",children:"Antenne"})]})]}),(0,b.jsxs)("div",{className:"flex items-center gap-4 pt-6",children:[(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)(p.Switch,{checked:h.is_headquarters,onCheckedChange:a=>i({...h,is_headquarters:a}),disabled:g}),(0,b.jsx)(n.Label,{children:"SiÃ¨ge principal"})]}),(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)(p.Switch,{checked:h.is_active,onCheckedChange:a=>i({...h,is_active:a}),disabled:g}),(0,b.jsx)(n.Label,{htmlFor:"is_active",children:"Actif"})]})]})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)(n.Label,{htmlFor:"address",children:"Adresse"}),(0,b.jsx)(m.Input,{id:"address",value:h.address,onChange:a=>i({...h,address:a.target.value}),disabled:g})]}),(0,b.jsxs)("div",{className:"grid md:grid-cols-3 gap-4",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)(n.Label,{htmlFor:"postal_code",children:"Code postal"}),(0,b.jsx)(m.Input,{id:"postal_code",value:h.postal_code,onChange:a=>i({...h,postal_code:a.target.value}),disabled:g})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)(n.Label,{htmlFor:"city",children:"Ville"}),(0,b.jsx)(m.Input,{id:"city",value:h.city,onChange:a=>i({...h,city:a.target.value}),disabled:g})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)(n.Label,{htmlFor:"country",children:"Pays"}),(0,b.jsx)(m.Input,{id:"country",value:h.country,onChange:a=>i({...h,country:a.target.value}),disabled:g})]})]}),(0,b.jsxs)("div",{className:"grid md:grid-cols-2 gap-4",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)(n.Label,{htmlFor:"phone",children:"TÃ©lÃ©phone"}),(0,b.jsx)(m.Input,{id:"phone",value:h.phone,onChange:a=>i({...h,phone:a.target.value}),disabled:g})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)(n.Label,{htmlFor:"email",children:"Email"}),(0,b.jsx)(m.Input,{id:"email",type:"email",value:h.email,onChange:a=>i({...h,email:a.target.value}),disabled:g})]})]}),(0,b.jsxs)("div",{className:"grid md:grid-cols-2 gap-4",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)(n.Label,{htmlFor:"latitude",children:"Latitude (GPS)"}),(0,b.jsx)(m.Input,{id:"latitude",type:"number",step:"any",value:h.latitude,onChange:a=>i({...h,latitude:a.target.value}),disabled:g})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)(n.Label,{htmlFor:"longitude",children:"Longitude (GPS)"}),(0,b.jsx)(m.Input,{id:"longitude",type:"number",step:"any",value:h.longitude,onChange:a=>i({...h,longitude:a.target.value}),disabled:g})]})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)(n.Label,{htmlFor:"description",children:"Description"}),(0,b.jsx)(o.Textarea,{id:"description",value:h.description,onChange:a=>i({...h,description:a.target.value}),rows:3,disabled:g})]}),(0,b.jsxs)(l.DialogFooter,{children:[(0,b.jsx)(j.Button,{type:"button",variant:"outline",onClick:d,disabled:g,children:"Annuler"}),(0,b.jsx)(j.Button,{type:"submit",disabled:g,className:"bg-brand-blue hover:bg-brand-blue-dark",children:e?"Enregistrer":"CrÃ©er"})]})]})]})})}a.s(["default",()=>z],879102)}];

//# sourceMappingURL=app_%28dashboard%29_dashboard_sites_page_tsx_faf8e9a6._.js.map