module.exports=[913216,a=>{"use strict";var b=a.i(433217),c=a.i(370025),d=a.i(937927),e=a.i(50944),f=a.i(269240),g=a.i(572131),h=a.i(325383);function i(){let a=(0,f.createClient)(),i=(0,e.useRouter)(),j=(0,d.useQueryClient)(),{data:k,isLoading:l}=(0,b.useQuery)({queryKey:["session"],queryFn:async()=>{try{let b=new Promise((a,b)=>{setTimeout(()=>b(Error("Session timeout")),3e3)}),c=a.auth.getSession().then(({data:{session:a},error:b})=>b?(h.logger.error("Session error",b),null):a);return await Promise.race([c,b])}catch(a){return null}},retry:!1,refetchOnWindowFocus:!1,refetchOnMount:!1,staleTime:3e5}),{data:m,isLoading:n}=(0,b.useQuery)({queryKey:["user",k?.user?.id],queryFn:async()=>{if(!k?.user?.id)return null;try{let b=new Promise((a,b)=>{setTimeout(()=>b(Error("User fetch timeout")),3e3)}),c=a.from("users").select("id, organization_id, email, full_name, phone, avatar_url, role, permissions, is_active, last_login_at, created_at, updated_at").eq("id",k.user.id).maybeSingle().then(async({data:b,error:c})=>{if(c)return"PGRST116"===c.code||c.message?.includes("No rows"),null;if(!b&&k?.user?.id){h.logger.info("User not found in public.users, attempting to sync from auth.users...");try{let{data:b,error:c}=await a.rpc("sync_user_from_auth",{user_id:k.user.id});if(c)h.logger.error("Error syncing user:",c);else if(b?.success){h.logger.info("User synced successfully, refetching...",{syncResult:b}),await new Promise(a=>setTimeout(a,100));let{data:c,error:d}=await a.from("users").select("id, organization_id, email, full_name, phone, avatar_url, role, permissions, is_active, last_login_at, created_at, updated_at").eq("id",k.user.id).maybeSingle();if(d)h.logger.error("Error refetching synced user:",d),j.invalidateQueries({queryKey:["user",k.user.id]});else{if(c)return h.logger.info("Synced user retrieved successfully:",{id:c.id,email:c.email,hasOrg:!!c.organization_id}),c;h.logger.warn("User sync succeeded but refetch returned null - invalidating cache and retrying..."),j.invalidateQueries({queryKey:["user",k.user.id]})}}}catch(a){h.logger.error("Exception during user sync:",a)}return null}return b?(b.organization_id||h.logger.warn("User exists but has no organization_id"),b):null});return await Promise.race([c,b])}catch(a){return null}},enabled:!!k?.user?.id&&!l,retry:!1,refetchOnWindowFocus:!1,refetchOnMount:!1,staleTime:3e5}),o=(0,c.useMutation)({mutationFn:async({email:b,password:c})=>{let{data:d,error:e}=await a.auth.signInWithPassword({email:b,password:c});if(e)throw e;return d},onSuccess:async()=>{j.invalidateQueries({queryKey:["session"]}),j.invalidateQueries({queryKey:["user"]}),await new Promise(a=>setTimeout(a,300)),i.push("/dashboard")}}),p=(0,c.useMutation)({mutationFn:async({email:b,password:c,fullName:d,organizationName:e})=>{let{data:f,error:g}=await a.auth.signUp({email:b,password:c});if(g){if(h.logger.error("Auth signup error",Error(g.message),{status:g.status}),429===g.status||g.message?.includes("2 seconds"))throw Error("Trop de tentatives. Veuillez attendre quelques secondes avant de réessayer.");throw Error(g.message||"Erreur lors de la création du compte")}if(!f.user)throw Error("Erreur lors de la création du compte");let i=f.session;if(!i){await new Promise(a=>setTimeout(a,1e3));let{data:{session:b}}=await a.auth.getSession();i=b}if(!i&&f.user){let{data:{session:b}}=await a.auth.refreshSession();i=b}if(!i){await new Promise(a=>setTimeout(a,2e3));let{data:{session:b}}=await a.auth.getSession();b&&(i=b)}if(!i&&!f.user)throw Error("Erreur : la session n'a pas pu être établie. Vérifiez votre email pour confirmer votre compte si nécessaire.");let k=i?.user?.id||f.user.id,l=e.toUpperCase().replace(/\s+/g,"").slice(0,6),m=null;if(!k)throw Error("Erreur : impossible d'obtenir l'ID utilisateur");try{let{data:b,error:c}=await a.rpc("create_organization_for_user",{org_name:e,org_code:l,org_type:"primary",org_country:"SN",org_currency:"XOF",org_language:"fr",org_timezone:"Africa/Dakar",user_id:k});if(c){if("P0001"===c.code&&c.message?.includes("User must be authenticated")){let b=await a.rpc("create_organization_for_user",{org_name:e,org_code:l,org_type:"primary",org_country:"SN",org_currency:"XOF",org_language:"fr",org_timezone:"Africa/Dakar"});b.error?b.error:b.data&&(m=b.data)}}else b&&(m=b)}catch(a){}let n=null;if(m)n={id:m,name:e,code:l};else{let{data:b,error:c}=await a.from("organizations").insert({name:e,code:l,type:"primary",country:"SN",currency:"XOF",language:"fr",timezone:"Africa/Dakar",subscription_tier:"free",subscription_status:"active",settings:{}}).select("id, name, code").single();if(c){if(console.error("Organization creation error:",c),console.error("Error details:",{code:c.code,message:c.message,details:c.details,hint:c.hint}),"42501"===c.code)throw Error("Erreur de sécurité (RLS) : Impossible de créer l'organisation. Les politiques RLS bloquent la création. INSTRUCTIONS : 1. Exécutez le script supabase/create_organization_function.sql dans Supabase SQL Editor 2. OU exécutez le script supabase/fix_rls_urgent.sql pour corriger les politiques RLS 3. Attendez quelques secondes puis réessayez");throw Error(`Impossible de cr\xe9er l'organisation : ${c.message}`)}n=b,m=b?.id}if(!m)throw Error("Erreur : l'organisation n'a pas été créée correctement");let o=m||n?.id;if(!o)throw Error("Erreur : impossible d'obtenir l'ID de l'organisation");let p=null,q=null;try{let{data:c,error:e}=await a.rpc("create_user_for_organization",{user_id:k,user_email:b,user_full_name:d,organization_id:o});if(e){if(q=e,"42883"===e.code){let{data:c,error:e}=await a.from("users").insert({id:k,organization_id:o,email:b,full_name:d,role:"admin",is_active:!0}).select("id, organization_id, email, full_name, role").single();e?q=e:p=c}}else c&&(p={id:c,organization_id:o,email:b,full_name:d,role:"admin"})}catch(a){q=a}if(q){if("42501"===q.code)throw Error("Erreur RLS lors de la création de l'utilisateur. Exécutez le script supabase/create_user_function.sql dans Supabase SQL Editor, ou utilisez supabase/fix_existing_user.sql pour créer l'utilisateur manuellement.");throw q}if(!p)throw Error("Erreur : l'utilisateur n'a pas été créé");if(!p?.organization_id)throw Error("Erreur : l'utilisateur n'a pas d'organization_id");if(j.invalidateQueries({queryKey:["user",k]}),j.invalidateQueries({queryKey:["session"]}),!i){await new Promise(a=>setTimeout(a,1e3));let{data:{session:b}}=await a.auth.getSession();if(b)return{...f,session:b}}return f},onSuccess:async a=>{await new Promise(a=>setTimeout(a,1500));let b=(0,f.createClient)(),{data:{session:c}}=await b.auth.getSession();j.invalidateQueries({queryKey:["session"]}),a.user&&j.invalidateQueries({queryKey:["user",a.user.id]}),c?i.push("/dashboard"):i.push("/auth/login?message=confirm-email")}}),q=(0,c.useMutation)({mutationFn:async()=>{let{error:b}=await a.auth.signOut();if(b)throw b},onSuccess:()=>{j.clear(),i.push("/")}});return(0,g.useEffect)(()=>{let{data:{subscription:b}}=a.auth.onAuthStateChange((a,b)=>{j.setQueryData(["session"],b),b||j.clear()});return()=>b.unsubscribe()},[a,j]),{session:k,user:m,isLoading:l||n,isAuthenticated:!!k,login:o.mutate,register:p.mutate,logout:q.mutate,isLoggingIn:o.isPending,isRegistering:p.isPending,isLoggingOut:q.isPending,loginError:o.error,registerError:p.error}}a.s(["useAuth",()=>i])},866774,a=>{"use strict";var b=a.i(187924),c=a.i(572131),d=a.i(238246),e=a.i(913216),f=a.i(340695),g=a.i(703130);function h(){let{register:a,isRegistering:h,registerError:i}=(0,e.useAuth)(),[j,k]=(0,c.useState)({organizationName:"",fullName:"",email:"",password:"",confirmPassword:""}),[l,m]=(0,c.useState)(null),n=async b=>{if(b.preventDefault(),m(null),j.password!==j.confirmPassword)return void m("Les mots de passe ne correspondent pas");if(j.password.length<8)return void m("Le mot de passe doit contenir au moins 8 caractères");try{a({email:j.email,password:j.password,fullName:j.fullName,organizationName:j.organizationName})}catch(a){m(a instanceof Error?a.message:"Une erreur est survenue")}};return(0,b.jsx)("div",{className:"min-h-screen flex items-center justify-center bg-gradient-to-b from-blue-50 to-white px-4 py-8",children:(0,b.jsxs)(g.Card,{className:"w-full max-w-md",children:[(0,b.jsxs)(g.CardHeader,{className:"text-center",children:[(0,b.jsx)(g.CardTitle,{className:"text-3xl font-bold text-primary",children:"eduzen"}),(0,b.jsx)(g.CardDescription,{className:"text-lg",children:"Créez votre établissement"})]}),(0,b.jsxs)(g.CardContent,{children:[(0,b.jsxs)("form",{onSubmit:n,className:"space-y-4",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{htmlFor:"organizationName",className:"block text-sm font-medium mb-2",children:"Nom de l'établissement *"}),(0,b.jsx)("input",{id:"organizationName",type:"text",value:j.organizationName,onChange:a=>k({...j,organizationName:a.target.value}),required:!0,className:"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target",placeholder:"Lycée Moderne"})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{htmlFor:"fullName",className:"block text-sm font-medium mb-2",children:"Votre nom complet *"}),(0,b.jsx)("input",{id:"fullName",type:"text",value:j.fullName,onChange:a=>k({...j,fullName:a.target.value}),required:!0,className:"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target",placeholder:"Jean Dupont"})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{htmlFor:"email",className:"block text-sm font-medium mb-2",children:"Email *"}),(0,b.jsx)("input",{id:"email",type:"email",value:j.email,onChange:a=>k({...j,email:a.target.value}),required:!0,className:"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target",placeholder:"votre@email.com",autoComplete:"email"})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{htmlFor:"password",className:"block text-sm font-medium mb-2",children:"Mot de passe *"}),(0,b.jsx)("input",{id:"password",type:"password",value:j.password,onChange:a=>k({...j,password:a.target.value}),required:!0,minLength:8,className:"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target",placeholder:"Au moins 8 caractères",autoComplete:"new-password"})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{htmlFor:"confirmPassword",className:"block text-sm font-medium mb-2",children:"Confirmer le mot de passe *"}),(0,b.jsx)("input",{id:"confirmPassword",type:"password",value:j.confirmPassword,onChange:a=>k({...j,confirmPassword:a.target.value}),required:!0,className:"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target",placeholder:"••••••••",autoComplete:"new-password"})]}),(l||i)&&(0,b.jsx)("div",{className:"bg-destructive/10 text-destructive px-4 py-3 rounded-lg text-sm",children:l||(i instanceof Error?i.message:"Une erreur est survenue")}),(0,b.jsx)(f.Button,{type:"submit",className:"w-full",disabled:h,children:h?"Création...":"Créer mon compte"})]}),(0,b.jsxs)("div",{className:"mt-6 text-center text-sm",children:[(0,b.jsx)("span",{className:"text-muted-foreground",children:"Déjà un compte ? "}),(0,b.jsx)(d.default,{href:"/auth/login",className:"text-primary font-semibold hover:underline",children:"Se connecter"})]})]})]})})}a.s(["default",()=>h])}];

//# sourceMappingURL=_5961c702._.js.map