module.exports=[400210,a=>{"use strict";let b=(0,a.i(170106).default)("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]]);a.s(["ArrowLeft",()=>b],400210)},437536,a=>{"use strict";var b=a.i(88780);let c=b.z.object({first_name:b.z.string().min(1,"Le prénom est requis").max(100,"Le prénom est trop long"),last_name:b.z.string().min(1,"Le nom est requis").max(100,"Le nom est trop long"),date_of_birth:b.z.string().optional().or(b.z.literal("")),gender:b.z.enum(["male","female","other"]).optional().or(b.z.literal("")),email:b.z.string().email("Email invalide").optional().or(b.z.literal("")),phone:b.z.string().optional().or(b.z.literal("")),address:b.z.string().optional().or(b.z.literal("")),city:b.z.string().optional().or(b.z.literal("")),class_id:b.z.string().optional().or(b.z.literal("")),enrollment_date:b.z.string().min(1,"La date d'inscription est requise"),guardian_first_name:b.z.string().min(1,"Le prénom du tuteur est requis"),guardian_last_name:b.z.string().min(1,"Le nom du tuteur est requis"),guardian_relationship:b.z.enum(["parent","guardian","other"]).default("parent"),guardian_phone_primary:b.z.string().min(1,"Le téléphone principal du tuteur est requis"),guardian_phone_secondary:b.z.string().optional().or(b.z.literal("")),guardian_email:b.z.string().email("Email invalide").optional().or(b.z.literal("")),guardian_address:b.z.string().optional().or(b.z.literal(""))});b.z.object({first_name:b.z.string().min(1,"Le prénom est requis").max(100,"Le prénom est trop long"),last_name:b.z.string().min(1,"Le nom est requis").max(100,"Le nom est trop long"),date_of_birth:b.z.string().optional().or(b.z.literal("")),gender:b.z.enum(["male","female","other"]).optional().or(b.z.literal("")),email:b.z.string().email("Email invalide").optional().or(b.z.literal("")),phone:b.z.string().optional().or(b.z.literal("")),address:b.z.string().optional().or(b.z.literal("")),city:b.z.string().optional().or(b.z.literal("")),class_id:b.z.string().optional().or(b.z.literal("")),enrollment_date:b.z.string().min(1,"La date d'inscription est requise"),status:b.z.enum(["active","inactive","graduated"]).default("active")});let d=b.z.object({code:b.z.string().min(1,"Le code est requis").max(50,"Le code est trop long"),name:b.z.string().min(1,"Le nom est requis").max(200,"Le nom est trop long"),subtitle:b.z.string().optional().or(b.z.literal("")),description:b.z.string().optional().or(b.z.literal("")),category:b.z.string().optional().or(b.z.literal("")),program_version:b.z.string().optional().or(b.z.literal("")),version_date:b.z.string().optional().or(b.z.literal("")),duration_hours:b.z.string().optional().or(b.z.literal("")),duration_days:b.z.string().optional().or(b.z.literal("")),photo_url:b.z.string().url("URL invalide").optional().or(b.z.literal("")),price:b.z.string().optional().or(b.z.literal("")),price_enterprise:b.z.string().optional().or(b.z.literal("")),price_individual:b.z.string().optional().or(b.z.literal("")),price_freelance:b.z.string().optional().or(b.z.literal("")),currency:b.z.string().default("XOF"),payment_plan:b.z.enum(["full","installment","free"]).default("full"),published_online:b.z.boolean().default(!1),is_public:b.z.boolean().default(!1),eligible_cpf:b.z.boolean().default(!1),cpf_code:b.z.string().optional().or(b.z.literal("")),modalities:b.z.string().optional().or(b.z.literal("")),training_action_type:b.z.string().optional().or(b.z.literal("")),pedagogical_objectives:b.z.string().optional().or(b.z.literal("")),learner_profile:b.z.string().optional().or(b.z.literal("")),training_content:b.z.string().optional().or(b.z.literal("")),execution_follow_up:b.z.string().optional().or(b.z.literal("")),certification_modalities:b.z.string().optional().or(b.z.literal("")),quality:b.z.string().optional().or(b.z.literal("")),accounting_product_config:b.z.string().optional().or(b.z.literal("")),edof_export_fields:b.z.string().optional().or(b.z.literal("")),competence_domains:b.z.string().optional().or(b.z.literal("")),prerequisites:b.z.string().optional().or(b.z.literal("")),capacity_max:b.z.string().optional().or(b.z.literal("")),age_min:b.z.string().optional().or(b.z.literal("")),age_max:b.z.string().optional().or(b.z.literal("")),certification_issued:b.z.boolean().default(!1),is_active:b.z.boolean().default(!0)}),e=b.z.object({program_id:b.z.string().min(1,"Le programme est requis"),code:b.z.string().min(1,"Le code est requis").max(50,"Le code est trop long"),name:b.z.string().min(1,"Le nom est requis").max(200,"Le nom est trop long"),subtitle:b.z.string().optional().or(b.z.literal("")),photo_url:b.z.string().url("URL invalide").optional().or(b.z.literal("")),category:b.z.string().optional().or(b.z.literal("")),description:b.z.string().optional().or(b.z.literal("")),program_version:b.z.string().optional().or(b.z.literal("")),version_date:b.z.string().optional().or(b.z.literal("")),duration_hours:b.z.string().optional().or(b.z.literal("")),duration_days:b.z.string().optional().or(b.z.literal("")),duration_unit:b.z.enum(["hours","days"]).default("hours"),price:b.z.string().optional().or(b.z.literal("")),currency:b.z.string().default("XOF"),payment_plan:b.z.enum(["full","installment","free"]).default("full"),published_online:b.z.boolean().default(!1),eligible_cpf:b.z.boolean().default(!1),cpf_code:b.z.string().optional().or(b.z.literal("")),modalities:b.z.string().optional().or(b.z.literal("")),training_action_type:b.z.string().optional().or(b.z.literal("")),pedagogical_objectives:b.z.string().optional().or(b.z.literal("")),learner_profile:b.z.string().optional().or(b.z.literal("")),training_content:b.z.string().optional().or(b.z.literal("")),execution_follow_up:b.z.string().optional().or(b.z.literal("")),certification_modalities:b.z.string().optional().or(b.z.literal("")),quality:b.z.string().optional().or(b.z.literal("")),accounting_product_config:b.z.string().optional().or(b.z.literal("")),edof_export_fields:b.z.string().optional().or(b.z.literal("")),competence_domains:b.z.string().optional().or(b.z.literal("")),prerequisites:b.z.string().optional().or(b.z.literal("")),capacity_max:b.z.string().optional().or(b.z.literal("")),age_min:b.z.string().optional().or(b.z.literal("")),age_max:b.z.string().optional().or(b.z.literal("")),certification_issued:b.z.boolean().default(!1),is_active:b.z.boolean().default(!0)}),f=b.z.object({formation_id:b.z.string().min(1,"La formation est requise"),name:b.z.string().min(1,"Le nom est requis").max(200,"Le nom est trop long"),code:b.z.string().optional().or(b.z.literal("")),start_date:b.z.string().min(1,"La date de début est requise"),end_date:b.z.string().min(1,"La date de fin est requise"),start_time:b.z.string().optional().or(b.z.literal("")),end_time:b.z.string().optional().or(b.z.literal("")),location:b.z.string().optional().or(b.z.literal("")),capacity_max:b.z.string().optional().or(b.z.literal("")).refine(a=>{if(!a)return!0;let b=parseInt(a);return!isNaN(b)&&b>0},"La capacité maximale doit être un nombre entier positif"),currency:b.z.string().default("XOF"),status:b.z.enum(["planned","ongoing","completed","cancelled"]).default("planned"),teacher_id:b.z.string().optional().or(b.z.literal("")),manager1_id:b.z.string().optional().or(b.z.literal("")),manager2_id:b.z.string().optional().or(b.z.literal("")),inter_entreprise:b.z.boolean().default(!0),sous_traitance:b.z.boolean().default(!1),timezone:b.z.string().default("Europe/Paris"),program_ids:b.z.array(b.z.string()).default([])}).refine(a=>!a.start_date||!a.end_date||new Date(a.end_date)>=new Date(a.start_date),{message:"La date de fin doit être postérieure à la date de début",path:["end_date"]}),g=b.z.object({student_id:b.z.string().min(1,"L'étudiant est requis"),session_id:b.z.string().optional().or(b.z.literal("")),subject:b.z.string().min(1,"Le sujet est requis").max(200,"Le sujet est trop long"),assessment_type:b.z.enum(["pre_formation","hot","cold","manager","instructor","funder","quiz","exam","project","other"]).default("quiz"),score:b.z.string().min(1,"La note est requise").refine(a=>{let b=parseFloat(a);return!isNaN(b)&&b>=0},"La note doit être un nombre valide"),max_score:b.z.string().optional().or(b.z.literal("")).refine(a=>{if(!a)return!0;let b=parseFloat(a);return!isNaN(b)&&b>0},"La note maximale doit être un nombre valide supérieur à 0"),notes:b.z.string().optional().or(b.z.literal("")),graded_at:b.z.string().min(1,"La date d'évaluation est requise"),coefficient:b.z.string().optional().or(b.z.literal("")).refine(a=>{if(!a)return!0;let b=parseFloat(a);return!isNaN(b)&&b>0},"Le coefficient doit être un nombre valide supérieur à 0"),is_makeup:b.z.boolean().optional().default(!1),original_grade_id:b.z.string().optional().or(b.z.literal("")),appreciation:b.z.string().optional().or(b.z.literal("")),term_period:b.z.enum(["Q1","Q2","Q3","Q4","S1","S2","T1","T2","T3"]).optional().or(b.z.literal("")),academic_year_id:b.z.string().optional().or(b.z.literal(""))}).refine(a=>!a.max_score||!a.score||parseFloat(a.score)<=parseFloat(a.max_score),{message:"La note ne peut pas être supérieure à la note maximale",path:["score"]}),h=b.z.object({student_id:b.z.string().min(1,"L'étudiant est requis"),document_type:b.z.enum(["quote","invoice"]).default("invoice"),invoice_number:b.z.string().optional().or(b.z.literal("")),type:b.z.enum(["tuition","registration","other"]).default("tuition"),issue_date:b.z.string().min(1,"La date d'émission est requise"),due_date:b.z.string().min(1,"La date d'échéance est requise"),amount:b.z.string().min(1,"Le montant est requis").refine(a=>{let b=parseFloat(a);return!isNaN(b)&&b>=0},"Le montant doit être un nombre valide supérieur ou égal à 0"),tax_amount:b.z.string().optional().or(b.z.literal("")).refine(a=>{if(!a)return!0;let b=parseFloat(a);return!isNaN(b)&&b>=0},"Le montant de la taxe doit être un nombre valide supérieur ou égal à 0"),currency:b.z.string().default("XOF"),status:b.z.enum(["draft","sent","partial","paid","overdue","cancelled"]).default("draft"),notes:b.z.string().optional().or(b.z.literal("")),enrollment_id:b.z.string().optional().or(b.z.literal(""))}).refine(a=>!a.issue_date||!a.due_date||new Date(a.due_date)>=new Date(a.issue_date),{message:"La date d'échéance doit être postérieure à la date d'émission",path:["due_date"]});b.z.object({invoice_id:b.z.string().min(1,"La facture est requise"),student_id:b.z.string().min(1,"L'étudiant est requis"),amount:b.z.string().min(1,"Le montant est requis").refine(a=>{let b=parseFloat(a);return!isNaN(b)&&b>0},"Le montant doit être un nombre valide supérieur à 0"),currency:b.z.string().default("XOF"),payment_method:b.z.enum(["cash","mobile_money","card","bank_transfer"]).default("cash"),payment_provider:b.z.enum(["mtn","orange","airtel","wave"]).optional().or(b.z.literal("")),transaction_id:b.z.string().optional().or(b.z.literal("")),paid_at:b.z.string().optional().or(b.z.literal("")),notes:b.z.string().optional().or(b.z.literal(""))});let i=b.z.object({student_id:b.z.string().min(1,"L'étudiant est requis"),session_id:b.z.string().min(1,"La session est requise"),enrollment_date:b.z.string().min(1,"La date d'inscription est requise"),status:b.z.enum(["pending","confirmed","completed","cancelled","failed"]).default("confirmed"),payment_status:b.z.enum(["pending","partial","paid","overdue"]).default("pending"),total_amount:b.z.string().optional().or(b.z.literal("")).refine(a=>{if(!a)return!0;let b=parseFloat(a);return!isNaN(b)&&b>=0},"Le montant total doit être un nombre valide supérieur ou égal à 0"),paid_amount:b.z.string().optional().or(b.z.literal("")).refine(a=>{if(!a)return!0;let b=parseFloat(a);return!isNaN(b)&&b>=0},"Le montant payé doit être un nombre valide supérieur ou égal à 0")}).refine(a=>{if(a.total_amount&&a.paid_amount){let b=parseFloat(a.total_amount),c=parseFloat(a.paid_amount);if(!isNaN(b)&&!isNaN(c)&&c>b)return!1}return!0},{message:"Le montant payé ne peut pas dépasser le montant total",path:["paid_amount"]});a.s(["enrollmentSchema",0,i,"evaluationSchema",0,g,"formationSchema",0,e,"invoiceSchema",0,h,"programSchema",0,d,"sessionSchema",0,f,"studentSchema",0,c])},452218,571907,a=>{"use strict";var b,c,d=a.i(325383),e=((b={}).AUTH_REQUIRED="AUTH_1001",b.AUTH_INVALID_CREDENTIALS="AUTH_1002",b.AUTH_SESSION_EXPIRED="AUTH_1003",b.AUTH_INSUFFICIENT_PERMISSIONS="AUTH_1004",b.AUTH_2FA_REQUIRED="AUTH_1005",b.AUTH_2FA_INVALID="AUTH_1006",b.VALIDATION_ERROR="VALID_2001",b.VALIDATION_REQUIRED_FIELD="VALID_2002",b.VALIDATION_INVALID_FORMAT="VALID_2003",b.VALIDATION_UNIQUE_CONSTRAINT="VALID_2004",b.DB_CONNECTION_ERROR="DB_3001",b.DB_QUERY_ERROR="DB_3002",b.DB_NOT_FOUND="DB_3003",b.DB_CONSTRAINT_VIOLATION="DB_3004",b.DB_FOREIGN_KEY_CONSTRAINT="DB_3006",b.DB_RLS_POLICY_VIOLATION="DB_3005",b.NETWORK_ERROR="NET_4001",b.API_TIMEOUT="NET_4002",b.API_RATE_LIMIT="NET_4003",b.API_SERVER_ERROR="NET_4004",b.API_NOT_FOUND="NET_4005",b.API_BAD_REQUEST="NET_4006",b.BUSINESS_LOGIC_ERROR="BIZ_5001",b.RESOURCE_LOCKED="BIZ_5002",b.OPERATION_NOT_ALLOWED="BIZ_5003",b.QUOTA_EXCEEDED="BIZ_5004",b.INTERNAL_ERROR="SYS_6001",b.CONFIGURATION_ERROR="SYS_6002",b.SERVICE_UNAVAILABLE="SYS_6003",b);(c={}).LOW="low",c.MEDIUM="medium",c.HIGH="high",c.CRITICAL="critical";class f extends Error{code;severity;userMessage;retryable;context;originalError;constructor(a,b="SYS_6001",c="medium",d={},e){super(a),this.name="AppError",this.code=b,this.severity=c,this.userMessage=d.userMessage||this.getDefaultUserMessage(b),this.retryable=d.retryable??this.isRetryable(b),this.context={...d,code:b,severity:c,timestamp:new Date().toISOString()},this.originalError=e,Error.captureStackTrace&&Error.captureStackTrace(this,f)}getDefaultUserMessage(a){return({AUTH_1001:"Vous devez être connecté pour effectuer cette action.",AUTH_1002:"Email ou mot de passe incorrect.",AUTH_1003:"Votre session a expiré. Veuillez vous reconnecter.",AUTH_1004:"Vous n'avez pas les permissions nécessaires.",AUTH_1005:"Authentification à deux facteurs requise.",AUTH_1006:"Code d'authentification invalide.",VALID_2001:"Les données fournies ne sont pas valides.",VALID_2002:"Certains champs obligatoires sont manquants.",VALID_2003:"Le format des données est incorrect.",VALID_2004:"Cette valeur existe déjà.",DB_3001:"Impossible de se connecter à la base de données.",DB_3002:"Erreur lors de l'exécution de la requête.",DB_3003:"Ressource introuvable.",DB_3004:"Cette opération viole une contrainte de la base de données.",DB_3006:"Cette opération viole une contrainte de clé étrangère.",DB_3005:"Vous n'avez pas accès à cette ressource.",NET_4001:"Erreur de connexion réseau. Vérifiez votre connexion internet.",NET_4002:"La requête a pris trop de temps. Veuillez réessayer.",NET_4003:"Trop de requêtes. Veuillez patienter quelques instants.",NET_4004:"Erreur serveur. Veuillez réessayer plus tard.",NET_4005:"Ressource introuvable.",NET_4006:"Requête invalide.",BIZ_5001:"Cette opération n'est pas autorisée dans le contexte actuel.",BIZ_5002:"Cette ressource est actuellement verrouillée.",BIZ_5003:"Cette opération n'est pas autorisée.",BIZ_5004:"Vous avez atteint la limite autorisée.",SYS_6001:"Une erreur interne est survenue. Veuillez réessayer.",SYS_6002:"Erreur de configuration du système.",SYS_6003:"Service temporairement indisponible."})[a]||"Une erreur inattendue est survenue."}isRetryable(a){return["NET_4001","NET_4002","NET_4004","DB_3001","SYS_6003"].includes(a)}toJSON(){return{name:this.name,message:this.message,code:this.code,severity:this.severity,userMessage:this.userMessage,retryable:this.retryable,context:this.context,stack:this.stack,originalError:this.originalError instanceof Error?{name:this.originalError.name,message:this.originalError.message,stack:this.originalError.stack}:this.originalError}}}let g=new class{handleError(a,b={}){if(a instanceof f)return this.logError(a),a;if(a instanceof Error)return this.handleStandardError(a,b);if(this.isSupabaseError(a))return this.handleSupabaseError(a,b);let c=new f("Une erreur inattendue est survenue.","SYS_6001","high",b,a);return this.logError(c),c}handleStandardError(a,b){let c=a.message.toLowerCase(),d="SYS_6001",e="medium";c.includes("network")||c.includes("fetch")?(d="NET_4001",e="medium"):c.includes("timeout")?(d="NET_4002",e="medium"):c.includes("unauthorized")||c.includes("401")?(d="AUTH_1001",e="high"):c.includes("forbidden")||c.includes("403")?(d="AUTH_1004",e="high"):c.includes("not found")||c.includes("404")?(d="DB_3003",e="low"):(c.includes("validation")||c.includes("invalid"))&&(d="VALID_2001",e="low");let g=new f(a.message,d,e,b,a);return this.logError(g),g}handleSupabaseError(a,b){let c=a.code||a.status,d=a.message||"Erreur Supabase",e=b.code||"DB_3002",g="medium";if(!b.code)switch(c){case"PGRST116":case"42P01":e="DB_3003",g="low";break;case"42501":e="DB_3005",g="high";break;case"23505":e="VALID_2004",g="low";break;case"23503":e="DB_3004",g="medium";break;case"PGRST301":case"400":e="NET_4006",g="low";break;case"401":e="AUTH_1001",g="high";break;case"403":e="AUTH_1004",g="high";break;case"404":e="NET_4005",g="low";break;case"500":e="NET_4004",g="high"}"DB_3006"===e&&(g="medium");let h=new f(d,e,g,b,a);return this.logError(h),h}isSupabaseError(a){return a&&(a.code||a.status||a.message)&&("string"==typeof a.code||"number"==typeof a.status)}logError(a){let b={...a.context,code:a.code,severity:a.severity,retryable:a.retryable};switch(a.severity){case"critical":case"high":d.logger.error(a.message,a.originalError||a,b);break;case"medium":d.logger.warn(a.message,b);break;case"low":d.logger.info(`Error: ${a.message}`,b)}}createValidationError(a,b){return new f(a,"VALID_2001","low",{field:b,userMessage:a})}createAuthError(a,b){return new f(b||"Erreur d'authentification",a,"high")}createDatabaseError(a,b){return new f(a,"DB_3002","medium",{},b)}createNotFoundError(a,b){return new f(a,"DB_3003","low",b)}};a.s(["AppError",()=>f,"ErrorCode",()=>e,"errorHandler",0,g],571907),a.s([],452218)},49492,a=>{"use strict";a.i(452218);var b=a.i(571907);async function c(a,c,d,e){try{let f=a.from(c).select(e?.select||"*").eq("organization_id",d);e?.filters&&Object.entries(e.filters).forEach(([a,b])=>{null!=b&&(f=f.eq(a,b))}),e?.search&&(f=f.ilike(e.search.field,`%${e.search.value}%`)),f=e?.orderBy?f.order(e.orderBy.column,{ascending:e.orderBy.ascending??!1}):f.order("created_at",{ascending:!1});let{data:g,error:h}=await f;if(h)throw b.errorHandler.handleError(h,{organizationId:d,operation:"getAllByOrganization",table:c});return g||[]}catch(a){if(a instanceof b.AppError)throw a;throw b.errorHandler.handleError(a,{organizationId:d,operation:"getAllByOrganization",table:c})}}async function d(a,c,d,e){try{let{data:f,error:g}=await a.from(c).select(e||"*").eq("id",d).single();if(g){if("PGRST116"===g.code||"42P01"===g.code)throw b.errorHandler.handleError(g,{code:b.ErrorCode.DB_NOT_FOUND,operation:"getById",id:d,table:c});throw b.errorHandler.handleError(g,{operation:"getById",id:d,table:c})}if(!f)throw b.errorHandler.createDatabaseError(`Enregistrement avec l'ID ${d} introuvable dans ${c}`,{id:d,table:c});return f}catch(a){if(a instanceof b.AppError)throw a;throw b.errorHandler.handleError(a,{operation:"getById",id:d,table:c})}}a.s(["getAllByOrganization",()=>c,"getById",()=>d])},697662,a=>{"use strict";a.i(452218);var b=a.i(571907);function c(a,c){for(let d of c)if(!a[d])throw b.errorHandler.createValidationError(`Le champ ${String(d)} est obligatoire`,String(d))}a.s(["validateRequired",()=>c])},908403,a=>{"use strict";var b=a.i(269240);a.i(452218);var c=a.i(571907),d=a.i(325383),e=a.i(49492),f=a.i(697662);let g=new class{supabase;constructor(a){this.supabase=a||(0,b.createClient)()}async getAll(a,b){try{let c={};return b?.studentId&&(c.student_id=b.studentId),b?.status&&(c.status=b.status),b?.documentType&&(c.document_type=b.documentType),(0,e.getAllByOrganization)(this.supabase,"invoices",a,{select:"*, students(id, first_name, last_name, student_number), payments(id, amount, status, paid_at)",filters:c,search:b?.search?{field:"invoice_number",value:b.search}:void 0,orderBy:{column:"issue_date",ascending:!1}})}catch(b){if(b instanceof c.AppError)throw b;throw c.errorHandler.handleError(b,{organizationId:a,operation:"getAll"})}}async getById(a){try{return(0,e.getById)(this.supabase,"invoices",a,"*, students(*), enrollments(*), payments(*)")}catch(b){if(b instanceof c.AppError)throw b;throw c.errorHandler.handleError(b,{operation:"getById",id:a})}}async generateInvoiceNumber(a,b="invoice"){let c=new Date().getFullYear().toString(),{data:d}=await this.supabase.from("invoices").select("invoice_number").eq("organization_id",a).eq("document_type",b).like("invoice_number",`${c}-%`).order("invoice_number",{ascending:!1}).limit(1).maybeSingle(),e=1;if(d?.invoice_number){let a=d.invoice_number.split("-");a.length>=2&&a[0]===c&&(e=parseInt(a[1]||"0",10)+1)}return`${c}-${String(e).padStart(3,"0")}`}async create(a){try{(0,f.validateRequired)(a,["organization_id","student_id"]);let b=a.invoice_number;if(!b||""===b.trim()){let d=a.organization_id;if(!d)throw c.errorHandler.createValidationError("Organization ID is required to create an invoice.");b=await this.generateInvoiceNumber(d,a.document_type||"invoice")}let{data:e,error:g}=await this.supabase.from("invoices").insert({...a,invoice_number:b}).select().single();if(g){if("23505"===g.code)throw c.errorHandler.handleError(g,{code:c.ErrorCode.VALIDATION_UNIQUE_CONSTRAINT,operation:"create",field:"invoice_number"});if("42501"===g.code)throw c.errorHandler.handleError(g,{code:c.ErrorCode.DB_RLS_POLICY_VIOLATION,operation:"create"});throw c.errorHandler.handleError(g,{operation:"create",invoice:a})}return d.logger.info("Facture créée avec succès",{id:e?.id,organizationId:a.organization_id||void 0,invoiceNumber:e?.invoice_number}),e}catch(b){if(b instanceof c.AppError)throw b;throw c.errorHandler.handleError(b,{operation:"create",invoice:a})}}async update(a,b){try{let{data:e,error:f}=await this.supabase.from("invoices").update(b).eq("id",a).select().single();if(f){if("PGRST116"===f.code||"42P01"===f.code)throw c.errorHandler.handleError(f,{code:c.ErrorCode.DB_NOT_FOUND,operation:"update",id:a});if("42501"===f.code)throw c.errorHandler.handleError(f,{code:c.ErrorCode.DB_RLS_POLICY_VIOLATION,operation:"update",id:a});throw c.errorHandler.handleError(f,{operation:"update",id:a,updates:b})}if(!e)throw c.errorHandler.createDatabaseError(`Facture avec l'ID ${a} introuvable pour la mise \xe0 jour`,{id:a});return d.logger.info("Facture mise à jour avec succès",{id:a,updates:b}),e}catch(d){if(d instanceof c.AppError)throw d;throw c.errorHandler.handleError(d,{operation:"update",id:a,updates:b})}}async generateForClass(a,b,e,f,g,h="tuition"){let{data:i,error:j}=await this.supabase.from("students").select("id").eq("organization_id",a).eq("class_id",b).eq("status","active");if(j)throw c.errorHandler.handleError(j,{operation:"generateForClass",organizationId:a,classId:b,step:"fetchStudents"});if(!i||0===i.length)throw c.errorHandler.createValidationError("Aucun élève actif dans cette classe","classId");let{data:k}=await this.supabase.from("organizations").select("code").eq("id",a).single(),l=k?.code||"ORG",m=new Date().getFullYear().toString().slice(-2),{data:n}=await this.supabase.from("invoices").select("invoice_number").eq("organization_id",a).like("invoice_number",`FAC-${l}-${m}-%`).order("invoice_number",{ascending:!1}).limit(1).maybeSingle(),o=1;if(n?.invoice_number){let a=n.invoice_number.split("-");o=parseInt(a[a.length-1]||"0")+1}let p=i.map((b,c)=>({organization_id:a,student_id:b.id,invoice_number:`FAC-${l}-${m}-${String(o+c).padStart(6,"0")}`,type:h,document_type:"invoice",issue_date:new Date().toISOString().split("T")[0],due_date:g,amount:e,tax_amount:0,total_amount:e,currency:f,status:"draft",items:[]})),{data:q,error:r}=await this.supabase.from("invoices").insert(p).select();if(r)throw c.errorHandler.handleError(r,{operation:"generateForClass",organizationId:a,classId:b,count:p.length});return d.logger.info("Factures générées en masse avec succès",{organizationId:a,classId:b,count:q?.length||0}),q||[]}async getOverdue(a){let b=new Date().toISOString().split("T")[0];try{let{data:d,error:e}=await this.supabase.from("invoices").select("*, students(id, first_name, last_name, student_number)").eq("organization_id",a).eq("document_type","invoice").in("status",["sent","partial"]).lt("due_date",b).order("due_date",{ascending:!0});if(e)throw c.errorHandler.handleError(e,{operation:"getOverdue",organizationId:a});return d||[]}catch(b){if(b instanceof c.AppError)throw b;throw c.errorHandler.handleError(b,{operation:"getOverdue",organizationId:a})}}async convertQuoteToInvoice(a){try{let{data:b,error:e}=await this.supabase.from("invoices").select("*").eq("id",a).eq("document_type","quote").single();if(e){if("PGRST116"===e.code||"42P01"===e.code)throw c.errorHandler.handleError(e,{code:c.ErrorCode.DB_NOT_FOUND,operation:"convertQuoteToInvoice",quoteId:a});throw c.errorHandler.handleError(e,{operation:"convertQuoteToInvoice",quoteId:a,step:"fetchQuote"})}if(!b)throw c.errorHandler.createDatabaseError(`Devis avec l'ID ${a} introuvable`,{quoteId:a});let{data:f,error:g}=await this.supabase.from("invoices").update({document_type:"invoice",status:"draft",issue_date:b.issue_date||new Date().toISOString().split("T")[0]}).eq("id",a).select().single();if(g)throw c.errorHandler.handleError(g,{operation:"convertQuoteToInvoice",quoteId:a,step:"updateInvoice"});return d.logger.info("Devis converti en facture avec succès",{quoteId:a,invoiceId:f?.id}),f}catch(b){if(b instanceof c.AppError)throw b;throw c.errorHandler.handleError(b,{operation:"convertQuoteToInvoice",quoteId:a})}}};a.s(["invoiceService",0,g])},769304,a=>{"use strict";var b=a.i(187924),c=a.i(572131),d=a.i(50944),e=a.i(370025),f=a.i(433217),g=a.i(695245),h=a.i(159501),i=a.i(913216),j=a.i(269240),k=a.i(908403),l=a.i(340695),m=a.i(703130),n=a.i(400210),o=a.i(238246),p=a.i(437536);function q(){let a=(0,d.useRouter)(),{user:q}=(0,i.useAuth)(),r=(0,j.createClient)(),{data:s}=(0,f.useQuery)({queryKey:["students",q?.organization_id],queryFn:async()=>{if(!q?.organization_id)return[];let{data:a,error:b}=await r.from("students").select("id, first_name, last_name, student_number, classes(name)").eq("organization_id",q.organization_id).eq("status","active").order("last_name");if(b)throw b;return a||[]},enabled:!!q?.organization_id}),{data:t}=(0,f.useQuery)({queryKey:["classes",q?.organization_id],queryFn:async()=>{if(!q?.organization_id)return[];let{data:a,error:b}=await r.from("classes").select("*").eq("organization_id",q.organization_id).order("name");if(b)throw b;return a||[]},enabled:!!q?.organization_id}),[u,v]=(0,c.useState)("single"),[w,x]=(0,c.useState)("quote"),{register:y,handleSubmit:z,formState:{errors:A},watch:B,setValue:C}=(0,g.useForm)({resolver:(0,h.zodResolver)(p.invoiceSchema),mode:"onChange",defaultValues:{student_id:"",document_type:"quote",type:"tuition",amount:"",tax_amount:"",currency:"EUR",issue_date:new Date().toISOString().split("T")[0],due_date:new Date(Date.now()+2592e6).toISOString().split("T")[0],notes:"",status:"draft"}}),D=B(),E=a=>{x(a),C("document_type",a)},F=(0,e.useMutation)({mutationFn:async a=>{if(!q?.organization_id)throw Error("Organization ID manquant");if("bulk"===u)throw Error("La génération en masse n'est pas encore validée avec Zod");{let b=parseFloat(a.amount)||0,c=parseFloat(a.tax_amount||"0")||0;return k.invoiceService.create({organization_id:q.organization_id,student_id:a.student_id,invoice_number:"",type:a.type,document_type:a.document_type||"invoice",issue_date:a.issue_date,due_date:a.due_date,amount:b,tax_amount:c,total_amount:b+c,currency:a.currency,status:a.status||"draft",items:[],notes:a.notes||null})}},onSuccess:b=>{"bulk"===u?a.push("/dashboard/payments"):a.push(`/dashboard/payments/${b.id}`)}}),G=z(a=>{F.mutate(a)});return(0,b.jsxs)("div",{className:"space-y-6",children:[(0,b.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,b.jsx)(o.default,{href:"/dashboard/payments",children:(0,b.jsx)(l.Button,{variant:"ghost",size:"icon",children:(0,b.jsx)(n.ArrowLeft,{className:"h-4 w-4"})})}),(0,b.jsxs)("div",{children:[(0,b.jsx)("h1",{className:"text-3xl font-bold text-gray-900",children:"quote"===w?"Nouveau devis":"Nouvelle facture"}),(0,b.jsxs)("p",{className:"mt-2 text-sm text-gray-600",children:["Créez un ","quote"===w?"devis":"facture"," individuel","le"," ou en masse"]})]})]}),(0,b.jsxs)(m.Card,{children:[(0,b.jsx)(m.CardHeader,{children:(0,b.jsx)(m.CardTitle,{children:"Type de document"})}),(0,b.jsx)(m.CardContent,{children:(0,b.jsxs)("div",{className:"flex space-x-4 mb-6",children:[(0,b.jsxs)("button",{type:"button",onClick:()=>E("quote"),className:`flex-1 p-4 border-2 rounded-lg transition-colors ${"quote"===w?"border-primary bg-primary/5":"border-gray-200 hover:border-gray-300"}`,children:[(0,b.jsx)("div",{className:"font-semibold",children:"Devis"}),(0,b.jsx)("div",{className:"text-sm text-muted-foreground mt-1",children:"Estimation avant formation"})]}),(0,b.jsxs)("button",{type:"button",onClick:()=>E("invoice"),className:`flex-1 p-4 border-2 rounded-lg transition-colors ${"invoice"===w?"border-primary bg-primary/5":"border-gray-200 hover:border-gray-300"}`,children:[(0,b.jsx)("div",{className:"font-semibold",children:"Facture"}),(0,b.jsx)("div",{className:"text-sm text-muted-foreground mt-1",children:"Facture après formation"})]})]})})]}),(0,b.jsxs)(m.Card,{children:[(0,b.jsx)(m.CardHeader,{children:(0,b.jsx)(m.CardTitle,{children:"Type de facturation"})}),(0,b.jsx)(m.CardContent,{children:(0,b.jsxs)("div",{className:"flex space-x-4 mb-6",children:[(0,b.jsxs)("button",{type:"button",onClick:()=>v("single"),className:`flex-1 p-4 border-2 rounded-lg transition-colors ${"single"===u?"border-primary bg-primary/5":"border-gray-200 hover:border-gray-300"}`,children:[(0,b.jsx)("div",{className:"font-semibold",children:"quote"===w?"Devis individuel":"Facture individuelle"}),(0,b.jsx)("div",{className:"text-sm text-muted-foreground mt-1",children:"Pour un élève spécifique"})]}),(0,b.jsxs)("button",{type:"button",onClick:()=>v("bulk"),className:`flex-1 p-4 border-2 rounded-lg transition-colors ${"bulk"===u?"border-primary bg-primary/5":"border-gray-200 hover:border-gray-300"}`,children:[(0,b.jsx)("div",{className:"font-semibold",children:"quote"===w?"Génération en masse":"Facturation en masse"}),(0,b.jsx)("div",{className:"text-sm text-muted-foreground mt-1",children:"Pour toute une classe"})]})]})})]}),(0,b.jsxs)(m.Card,{children:[(0,b.jsx)(m.CardHeader,{children:(0,b.jsxs)(m.CardTitle,{children:["Informations du ","quote"===w?"devis":"facture"]})}),(0,b.jsx)(m.CardContent,{children:(0,b.jsxs)("form",{onSubmit:G,className:"space-y-6",children:["bulk"===u&&(0,b.jsx)("div",{className:"bg-warning-bg border border-warning-border rounded-lg p-4 mb-6",children:(0,b.jsx)("p",{className:"text-sm text-warning-primary",children:'La génération en masse n\'est pas encore validée avec Zod. Veuillez utiliser "Facture individuelle" pour bénéficier de la validation complète.'})}),(0,b.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Type *"}),(0,b.jsxs)("select",{...y("type"),className:`w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target ${A.type?"border-danger-primary":""}`,children:[(0,b.jsx)("option",{value:"tuition",children:"Scolarité"}),(0,b.jsx)("option",{value:"registration",children:"Inscription"}),(0,b.jsx)("option",{value:"other",children:"Autre"})]}),A.type&&(0,b.jsx)("p",{className:"text-sm text-danger-primary mt-1",children:A.type.message})]}),"single"===u?(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Élève *"}),(0,b.jsxs)("select",{...y("student_id"),className:`w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target ${A.student_id?"border-danger-primary":""}`,children:[(0,b.jsx)("option",{value:"",children:"Sélectionner un élève"}),s?.map(a=>(0,b.jsxs)("option",{value:a.id,children:[a.first_name," ",a.last_name," (",a.student_number,")"]},a.id))]}),A.student_id&&(0,b.jsx)("p",{className:"text-sm text-danger-primary mt-1",children:A.student_id.message})]}):(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Classe *"}),(0,b.jsx)("div",{className:"bg-warning-bg border border-warning-border rounded-lg p-4",children:(0,b.jsx)("p",{className:"text-sm text-warning-primary",children:'La génération en masse n\'est pas encore validée avec Zod. Veuillez utiliser "Facture individuelle".'})})]})]}),(0,b.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Montant *"}),(0,b.jsx)("input",{type:"number",step:"0.01",min:"0",...y("amount"),className:`w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target ${A.amount?"border-danger-primary":""}`,placeholder:"0.00"}),A.amount&&(0,b.jsx)("p",{className:"text-sm text-danger-primary mt-1",children:A.amount.message})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium mb-2",children:"TVA"}),(0,b.jsx)("input",{type:"number",step:"0.01",min:"0",...y("tax_amount"),className:`w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target ${A.tax_amount?"border-danger-primary":""}`,placeholder:"0.00"}),A.tax_amount&&(0,b.jsx)("p",{className:"text-sm text-danger-primary mt-1",children:A.tax_amount.message})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Devise"}),(0,b.jsxs)("select",{...y("currency"),className:"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target",children:[(0,b.jsx)("option",{value:"XOF",children:"XOF (Franc CFA Ouest)"}),(0,b.jsx)("option",{value:"XAF",children:"XAF (Franc CFA Centre)"}),(0,b.jsx)("option",{value:"EUR",children:"EUR (Euro)"}),(0,b.jsx)("option",{value:"USD",children:"USD (Dollar)"})]})]})]}),(0,b.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Date d'émission *"}),(0,b.jsx)("input",{type:"date",...y("issue_date"),className:`w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target ${A.issue_date?"border-danger-primary":""}`}),A.issue_date&&(0,b.jsx)("p",{className:"text-sm text-danger-primary mt-1",children:A.issue_date.message})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Date d'échéance *"}),(0,b.jsx)("input",{type:"date",...y("due_date"),className:`w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target ${A.due_date?"border-danger-primary":""}`}),A.due_date&&(0,b.jsx)("p",{className:"text-sm text-danger-primary mt-1",children:A.due_date.message})]})]}),"single"===u&&(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Notes"}),(0,b.jsx)("textarea",{...y("notes"),rows:3,className:"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent",placeholder:"Notes supplémentaires..."})]}),D.amount&&(0,b.jsxs)("div",{className:"bg-gray-50 p-4 rounded-lg",children:[(0,b.jsxs)("div",{className:"flex justify-between items-center",children:[(0,b.jsx)("span",{className:"text-sm text-muted-foreground",children:"Montant HT:"}),(0,b.jsxs)("span",{className:"font-medium",children:[D.amount," ",D.currency]})]}),D.tax_amount&&parseFloat(D.tax_amount)>0&&(0,b.jsxs)("div",{className:"flex justify-between items-center mt-2",children:[(0,b.jsx)("span",{className:"text-sm text-muted-foreground",children:"TVA:"}),(0,b.jsxs)("span",{className:"font-medium",children:[D.tax_amount," ",D.currency]})]}),(0,b.jsxs)("div",{className:"flex justify-between items-center mt-2 pt-2 border-t",children:[(0,b.jsx)("span",{className:"font-semibold",children:"Total TTC:"}),(0,b.jsxs)("span",{className:"font-bold text-lg",children:[(parseFloat(D.amount||"0")+parseFloat(D.tax_amount||"0")).toFixed(2)," ",D.currency]})]})]}),F.error&&(0,b.jsx)("div",{className:"bg-destructive/10 text-destructive px-4 py-3 rounded-lg text-sm",children:F.error instanceof Error?F.error.message:"Une erreur est survenue"}),(0,b.jsxs)("div",{className:"flex justify-end space-x-4 pt-4",children:[(0,b.jsx)(o.default,{href:"/dashboard/payments",children:(0,b.jsx)(l.Button,{type:"button",variant:"outline",children:"Annuler"})}),(0,b.jsx)(l.Button,{type:"submit",disabled:F.isPending,children:F.isPending?"Création...":"bulk"===u?"quote"===w?"Générer les devis":"Générer les factures":"quote"===w?"Créer le devis":"Créer la facture"})]})]})})]})]})}a.s(["default",()=>q])}];

//# sourceMappingURL=_84710dad._.js.map