module.exports=[479106,a=>{"use strict";var b=a.i(187924),c=a.i(50944),d=a.i(433217),e=a.i(370025),f=a.i(937927),g=a.i(913216),h=a.i(805781),i=a.i(340695),j=a.i(205522),k=a.i(703130),l=a.i(400210),m=a.i(692759),n=a.i(526017),o=a.i(660246),p=a.i(546842),q=a.i(563588),r=a.i(781560),s=a.i(436265),t=a.i(572131),u=a.i(497895),v=a.i(864037);let w=(0,a.i(170106).default)("Paperclip",[["path",{d:"m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.57a2 2 0 0 1-2.83-2.83l8.49-8.48",key:"1u3ebp"}]]);var x=a.i(633508),y=a.i(435487),z=a.i(838632),A=a.i(104720);function B({attachments:a,onAttachmentsChange:c,onRemove:d,disabled:e=!1}){let f=(0,t.useRef)(null),[g,h]=(0,t.useState)(!1),j=b=>{b&&c([...a,...Array.from(b).map(a=>{let b,c=Math.random().toString(36).substring(7);return a.type.startsWith("image/")&&(b=URL.createObjectURL(a)),{file:a,id:c,preview:b}})])};return(0,b.jsxs)("div",{className:"space-y-2",children:[0===a.length&&(0,b.jsxs)("div",{onDragOver:a=>{a.preventDefault(),h(!0)},onDragLeave:a=>{a.preventDefault(),h(!1)},onDrop:a=>{a.preventDefault(),h(!1),j(a.dataTransfer.files)},className:(0,u.cn)("border-2 border-dashed rounded-lg p-4 text-center transition-colors",g?"border-primary bg-primary/5":"border-muted-foreground/25",e&&"opacity-50 cursor-not-allowed"),children:[(0,b.jsx)("input",{ref:f,type:"file",multiple:!0,className:"hidden",onChange:a=>j(a.target.files),disabled:e,accept:"image/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.csv,.zip"}),(0,b.jsxs)(i.Button,{type:"button",variant:"ghost",size:"sm",onClick:()=>f.current?.click(),disabled:e,className:"mx-auto",children:[(0,b.jsx)(w,{className:"h-4 w-4 mr-2"}),"Joindre des fichiers"]}),(0,b.jsx)("p",{className:"text-xs text-muted-foreground mt-2",children:"Glissez-déposez des fichiers ici ou cliquez pour sélectionner"})]}),a.length>0&&(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsxs)("div",{className:"flex items-center justify-between",children:[(0,b.jsxs)("span",{className:"text-sm font-medium text-muted-foreground",children:[a.length," fichier",a.length>1?"s":""," attaché",a.length>1?"s":""]}),(0,b.jsxs)(i.Button,{type:"button",variant:"ghost",size:"sm",onClick:()=>f.current?.click(),disabled:e,children:[(0,b.jsx)(w,{className:"h-4 w-4 mr-2"}),"Ajouter"]})]}),(0,b.jsx)("input",{ref:f,type:"file",multiple:!0,className:"hidden",onChange:a=>j(a.target.files),disabled:e,accept:"image/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.csv,.zip"}),(0,b.jsx)("div",{className:"grid grid-cols-1 gap-2",children:a.map(a=>{var c;return(0,b.jsxs)("div",{className:"flex items-center gap-3 p-2 border rounded-lg bg-muted/50",children:[a.preview&&(0,b.jsx)("div",{className:"flex-shrink-0 w-12 h-12 rounded overflow-hidden border",children:(0,b.jsx)("img",{src:a.preview,alt:a.file.name,className:"w-full h-full object-cover"})}),!a.preview&&(0,b.jsx)("div",{className:"flex-shrink-0 w-12 h-12 rounded border flex items-center justify-center bg-background",children:(c=a.file).type.startsWith("image/")?(0,b.jsx)(z.Image,{className:"h-4 w-4"}):"application/pdf"===c.type?(0,b.jsx)(A.FileText,{className:"h-4 w-4"}):(0,b.jsx)(y.File,{className:"h-4 w-4"})}),(0,b.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,b.jsx)("p",{className:"text-sm font-medium truncate",children:a.file.name}),(0,b.jsx)("p",{className:"text-xs text-muted-foreground",children:(a=>{if(0===a)return"0 Bytes";let b=Math.floor(Math.log(a)/Math.log(1024));return Math.round(a/Math.pow(1024,b)*100)/100+" "+["Bytes","KB","MB","GB"][b]})(a.file.size)})]}),(0,b.jsx)(i.Button,{type:"button",variant:"ghost",size:"icon",className:"flex-shrink-0 h-8 w-8",onClick:()=>{a.preview&&URL.revokeObjectURL(a.preview),d(a.id)},disabled:e,children:(0,b.jsx)(x.X,{className:"h-4 w-4"})})]},a.id)})})]})]})}var C=a.i(550513),D=a.i(676504);function E(){let a=(0,c.useParams)(),w=(0,c.useRouter)(),{user:x}=(0,g.useAuth)(),y=(0,f.useQueryClient)(),{addToast:z}=(0,v.useToast)(),A=a.id,[E,F]=(0,t.useState)(""),[G,H]=(0,t.useState)(50),[I,J]=(0,t.useState)(0),K=(0,t.useRef)(null),L=(0,t.useRef)(null),[M,N]=(0,t.useState)(!0),[O,P]=(0,t.useState)([]),{data:Q,isLoading:R,error:S}=(0,d.useQuery)({queryKey:["conversation",A],queryFn:()=>h.messagingService.getConversationById(A),enabled:!!A}),{data:T,isLoading:U,refetch:V}=(0,d.useQuery)({queryKey:["messages",A,G],queryFn:async()=>{let a=await h.messagingService.getMessages(A,G,0);return N(a.length>=G),a},enabled:!!A,refetchInterval:5e3});(0,t.useEffect)(()=>{H(50),N(!0)},[A]);let W=(0,e.useMutation)({mutationFn:async a=>h.messagingService.deleteMessage(a),onSuccess:()=>{y.invalidateQueries({queryKey:["messages",A]}),y.invalidateQueries({queryKey:["conversations"]}),z({type:"success",title:"Message supprimé",description:"Le message a été supprimé avec succès."})},onError:a=>{z({type:"error",title:"Erreur",description:a instanceof Error?a.message:"Une erreur est survenue lors de la suppression du message."})}}),X=(0,e.useMutation)({mutationFn:async({content:a,files:b})=>{if(!x?.id||!A)throw Error("Utilisateur non authentifié");let c=null;if(b.length>0){let a=b.map(async a=>({url:await h.messagingService.uploadAttachment(a.file,A),filename:a.file.name,type:a.file.type,size:a.file.size}));c=await Promise.all(a)}return h.messagingService.sendMessage({conversation_id:A,sender_id:x.id,content:a.trim()||(c?"[Pièces jointes]":""),attachments:c,message_type:c&&c.some(a=>a.type.startsWith("image/"))?"image":"text",is_deleted:!1,is_edited:!1})},onSuccess:()=>{F(""),P([]),y.invalidateQueries({queryKey:["messages",A]}),y.invalidateQueries({queryKey:["conversations"]}),setTimeout(()=>{K.current?.scrollIntoView({behavior:"smooth"})},100)},onError:a=>{z({type:"error",title:"Erreur",description:a instanceof Error?a.message:"Une erreur est survenue lors de l'envoi du message."})}});(0,t.useEffect)(()=>{K.current?.scrollIntoView({behavior:"smooth"})},[T]);let Y=a=>{let b=O.find(b=>b.id===a);b?.preview&&URL.revokeObjectURL(b.preview),P(O.filter(b=>b.id!==a))},Z=(()=>{if(!Q?.participants)return null;let a=Q.participants.find(a=>a.user_id!==x?.id&&a.student_id);if(a?.student)return{name:`${a.student.first_name||""} ${a.student.last_name||""}`.trim()||a.student.email||`Candidat ${a.student.student_number||""}`,type:"student",data:a.student};let b=Q.participants.find(a=>a.user_id!==x?.id&&a.user);return b?.user?{name:b.user.full_name||b.user.email||"Utilisateur",type:"user",data:b.user}:null})();return R?(0,b.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,b.jsx)(n.Loader2,{className:"h-8 w-8 animate-spin text-muted-foreground"})}):S||!Q?(0,b.jsxs)("div",{className:"container mx-auto py-8 px-4 max-w-7xl",children:[(0,b.jsxs)("div",{className:"flex items-center gap-4 mb-6",children:[(0,b.jsx)(i.Button,{variant:"ghost",size:"icon",onClick:()=>w.push("/dashboard/messages"),children:(0,b.jsx)(l.ArrowLeft,{className:"h-4 w-4"})}),(0,b.jsx)("h1",{className:"text-2xl font-bold",children:"Conversation introuvable"})]}),(0,b.jsx)(k.Card,{children:(0,b.jsx)(k.CardContent,{className:"py-8 text-center",children:(0,b.jsx)("p",{className:"text-muted-foreground",children:"Cette conversation n'existe pas ou vous n'avez pas la permission de la voir."})})})]}):(0,b.jsxs)("div",{className:"flex flex-col h-[calc(100vh-4rem)]",children:[(0,b.jsx)("div",{className:"border-b bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60",children:(0,b.jsx)("div",{className:"container mx-auto px-4 py-4 max-w-7xl",children:(0,b.jsxs)("div",{className:"flex items-center gap-4",children:[(0,b.jsx)(i.Button,{variant:"ghost",size:"icon",onClick:()=>w.push("/dashboard/messages"),children:(0,b.jsx)(l.ArrowLeft,{className:"h-4 w-4"})}),(0,b.jsxs)("div",{className:"flex items-center gap-3 flex-1",children:[Z?.type==="student"?(0,b.jsx)("div",{className:"h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center",children:(0,b.jsx)(p.User,{className:"h-5 w-5 text-primary"})}):(0,b.jsx)("div",{className:"h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center",children:(0,b.jsx)(o.Users,{className:"h-5 w-5 text-primary"})}),(0,b.jsxs)("div",{children:[(0,b.jsx)("h1",{className:"text-lg font-semibold",children:Z?.name||"Conversation"}),"group"===Q.conversation_type&&Q.name&&(0,b.jsx)("p",{className:"text-sm text-muted-foreground",children:Q.name})]})]})]})})}),(0,b.jsx)("div",{ref:L,className:"flex-1 overflow-y-auto container mx-auto px-4 py-6 max-w-7xl",children:U&&50===G?(0,b.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,b.jsx)(n.Loader2,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):T&&T.length>0?(0,b.jsxs)("div",{className:"space-y-4",children:[M&&T.length>0&&(0,b.jsx)("div",{className:"flex justify-center py-4",children:(0,b.jsx)(i.Button,{variant:"outline",onClick:()=>{H(a=>a+50)},disabled:U,className:"flex items-center gap-2",children:U?(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(n.Loader2,{className:"h-4 w-4 animate-spin"}),"Chargement..."]}):(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(l.ArrowLeft,{className:"h-4 w-4 rotate-90"}),"Charger plus de messages (",T.length," affichés)"]})})}),T.map(a=>{let c=a.sender_id===x?.id,d="Expéditeur inconnu";return a.sender?d=a.sender.full_name||a.sender.email||"Expéditeur inconnu":a.student_sender&&(d=`${a.student_sender.first_name||""} ${a.student_sender.last_name||""}`.trim()||a.student_sender.email||(a.student_sender.student_number?`Candidat ${a.student_sender.student_number}`:"Expéditeur inconnu")),(0,b.jsxs)("div",{className:`flex items-start gap-2 ${c?"justify-end":"justify-start"}`,children:[!c&&(0,b.jsx)("div",{className:"w-8"}),(0,b.jsxs)("div",{className:"group relative flex items-start gap-2",children:[(0,b.jsxs)("div",{className:`max-w-[70%] rounded-lg px-4 py-2 ${c?"bg-primary text-primary-foreground":"bg-muted"}`,children:[!c&&(0,b.jsx)("p",{className:"text-xs font-medium mb-1 opacity-80",children:d}),a.attachments&&Array.isArray(a.attachments)&&a.attachments.length>0&&(0,b.jsx)("div",{className:"mb-2",children:(0,b.jsx)(C.MessageAttachmentViewer,{attachments:a.attachments})}),(0,b.jsx)("p",{className:"text-sm whitespace-pre-wrap",children:a.content}),(0,b.jsx)("p",{className:`text-xs mt-1 ${c?"text-primary-foreground/70":"text-muted-foreground"}`,children:(0,u.formatRelativeTime)(a.created_at)})]}),c&&(0,b.jsxs)(D.DropdownMenu,{children:[(0,b.jsx)(D.DropdownMenuTrigger,{asChild:!0,children:(0,b.jsx)(i.Button,{variant:"ghost",size:"icon",className:"h-6 w-6 opacity-0 group-hover:opacity-100 transition-opacity",onClick:a=>a.stopPropagation(),children:(0,b.jsx)(s.MoreVertical,{className:"h-3 w-3"})})}),(0,b.jsx)(D.DropdownMenuContent,{align:"end",children:(0,b.jsxs)(D.DropdownMenuItem,{onClick:b=>{b.preventDefault(),b.stopPropagation(),confirm("Êtes-vous sûr de vouloir supprimer ce message ?")&&W.mutate(a.id)},disabled:W.isPending,className:"text-destructive focus:text-destructive",children:[(0,b.jsx)(r.Trash2,{className:"mr-2 h-4 w-4"}),"Supprimer"]})})]})]}),c&&(0,b.jsx)("div",{className:"w-8"})]},a.id)}),(0,b.jsx)("div",{ref:K})]}):(0,b.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,b.jsxs)("div",{className:"text-center",children:[(0,b.jsx)(q.MessageSquare,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),(0,b.jsx)("p",{className:"text-muted-foreground",children:"Aucun message pour le moment"}),(0,b.jsx)("p",{className:"text-sm text-muted-foreground mt-2",children:"Commencez la conversation en envoyant un message"})]})})}),(0,b.jsx)("div",{className:"border-t bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60",children:(0,b.jsxs)("div",{className:"container mx-auto px-4 py-4 max-w-7xl space-y-3",children:[O.length>0&&(0,b.jsx)("div",{className:"pb-2",children:(0,b.jsx)(B,{attachments:O,onAttachmentsChange:P,onRemove:Y,disabled:X.isPending})}),(0,b.jsxs)("form",{onSubmit:a=>{a.preventDefault(),(E.trim()||0!==O.length)&&!X.isPending&&X.mutate({content:E.trim(),files:O})},className:"flex gap-2",children:[(0,b.jsx)(j.Input,{value:E,onChange:a=>F(a.target.value),placeholder:"Tapez votre message...",disabled:X.isPending,className:"flex-1"}),(0,b.jsx)(i.Button,{type:"submit",disabled:!E.trim()&&0===O.length||X.isPending,size:"icon",children:X.isPending?(0,b.jsx)(n.Loader2,{className:"h-4 w-4 animate-spin"}):(0,b.jsx)(m.Send,{className:"h-4 w-4"})})]}),0===O.length&&(0,b.jsx)("div",{className:"pt-2",children:(0,b.jsx)(B,{attachments:O,onAttachmentsChange:P,onRemove:Y,disabled:X.isPending})})]})})]})}a.s(["default",()=>E],479106)}];

//# sourceMappingURL=app_%28dashboard%29_dashboard_messages_%5Bid%5D_page_tsx_a1f9e85e._.js.map