module.exports=[351134,a=>{"use strict";var b=a.i(187924),c=a.i(572131),d=a.i(50944),e=a.i(433217),f=a.i(913216),g=a.i(269240),h=a.i(872675),i=a.i(542502),j=a.i(908403),k=a.i(307676),l=a.i(497895);function m(a,b,c,d){let e=new Date;return{ecole_nom:b?.name||"",ecole_logo:b?.logo_url||"",ecole_adresse:b?.address||"",ecole_ville:b?.city||"",ecole_telephone:b?.phone||"",ecole_email:b?.email||"",ecole_site_web:b?.website||"",ecole_siret:b?.siret||"",ecole_code_postal:b?.postal_code||"",eleve_nom:a?.last_name||"",eleve_prenom:a?.first_name||"",eleve_numero:a?.student_number||"",eleve_date_naissance:a?.date_of_birth?(0,l.formatDate)(a.date_of_birth):"",eleve_classe:c?.name||"",eleve_photo:a?.photo_url||"",eleve_adresse:a?.address||"",eleve_telephone:a?.phone||"",eleve_email:a?.email||"",formation_nom:d?.name||"",formation_code:d?.code||"",formation_duree:d?.duration_hours?`${d.duration_hours} heures`:"",formation_prix:d?.price?`${d.price} ${d.currency||"EUR"}`:"",formation_dates:c?`${(0,l.formatDate)(c.start_date)} - ${(0,l.formatDate)(c.end_date)}`:"",formation_description:d?.description||"",formation_objectifs:d?.objectives||"",session_nom:c?.name||"",session_debut:c?.start_date?(0,l.formatDate)(c.start_date):"",session_fin:c?.end_date?(0,l.formatDate)(c.end_date):"",session_lieu:c?.location||"",session_horaires:c?.start_time&&c?.end_time?`${c.start_time} - ${c.end_time}`:"",date_jour:(0,l.formatDate)(e),date_emission:(0,l.formatDate)(e),date_generation:(0,l.formatDate)(e),annee_actuelle:e.getFullYear().toString(),heure:e.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"}),numero_document:`DOC-${e.getTime()}`,numero_page:1,total_pages:1}}var n=a.i(703130),o=a.i(340695),p=a.i(917171),q=a.i(219897),r=a.i(400210),s=a.i(284505),t=a.i(177156),u=a.i(546842),v=a.i(104720),w=a.i(911156),x=a.i(941675),y=a.i(238246),z=a.i(458198),A=a.i(747895);function B(){let a=(0,d.useParams)();(0,d.useRouter)();let B=(0,d.useSearchParams)(),{user:C}=(0,f.useAuth)(),D=(0,g.createClient)(),E=a.type,F=(0,A.getDocumentTypeConfig)(E),G=B.get("template_id"),[H,I]=(0,c.useState)(null),[J,K]=(0,c.useState)("real"),[L,M]=(0,c.useState)(""),[N,O]=(0,c.useState)(""),[P,Q]=(0,c.useState)(""),[R,S]=(0,c.useState)(""),{data:T,isLoading:U}=(0,e.useQuery)({queryKey:["document-template",C?.organization_id,E,G],queryFn:async()=>{if(!C?.organization_id)return null;if(G)try{let a=await h.documentTemplateService.getTemplateById(G);if(a.type===E)return a}catch(a){console.error("Erreur lors du chargement du template spécifique:",a)}return h.documentTemplateService.getDefaultTemplate(C.organization_id,E)},enabled:!!C?.organization_id}),{data:V}=(0,e.useQuery)({queryKey:["organization",C?.organization_id],queryFn:async()=>{if(!C?.organization_id)return null;let{data:a,error:b}=await D.from("organizations").select("*").eq("id",C.organization_id).single();if(b)throw b;return a},enabled:!!C?.organization_id}),{data:W}=(0,e.useQuery)({queryKey:["students",C?.organization_id],queryFn:async()=>C?.organization_id?i.studentService.getAll(C.organization_id):{data:[],total:0,page:1,limit:50,totalPages:0},enabled:!!C?.organization_id&&"real"===J}),{data:X}=(0,e.useQuery)({queryKey:["invoices",C?.organization_id],queryFn:async()=>C?.organization_id?j.invoiceService.getAll(C.organization_id,{}):[],enabled:!!C?.organization_id&&"real"===J}),{data:Y}=(0,e.useQuery)({queryKey:["payments",C?.organization_id],queryFn:async()=>{if(!C?.organization_id)return[];try{return(await k.paymentService.getAll(C.organization_id)).slice(0,50)}catch(d){let a=d?.code||d?.originalError?.code||d?.status,b=d?.message||d?.originalError?.message||String(d),c=d?.details||d?.hint||"";if("PGRST116"===a||"42P01"===a||"PGRST200"===a||"PGRST301"===a||"400"===a||d?.status===400||b?.toLowerCase().includes("relation")||b?.toLowerCase().includes("relationship")||b?.toLowerCase().includes("does not exist")||b?.toLowerCase().includes("schema cache")||b?.toLowerCase().includes("invalid query")||c?.toLowerCase().includes("relation")||c?.toLowerCase().includes("relationship")){console.warn("Relations non disponibles, récupération des paiements sans relations:",{errorCode:a,errorMessage:b,errorDetails:c});try{let{data:a,error:b}=await D.from("payments").select("*").eq("organization_id",C.organization_id).order("created_at",{ascending:!1}).limit(50);if(b)return console.warn("Erreur lors de la récupération simple des paiements:",b),[];return a||[]}catch(a){return console.warn("Erreur lors de la récupération de fallback des paiements:",a),[]}}return console.error("Erreur lors de la récupération des paiements:",d),[]}},enabled:!!C?.organization_id&&"real"===J,retry:!1}),{data:Z}=(0,e.useQuery)({queryKey:["sessions",C?.organization_id],queryFn:async()=>{if(!C?.organization_id)return[];let{data:a,error:b}=await D.from("sessions").select("*, formations(*)").eq("organization_id",C.organization_id).order("start_date",{ascending:!1}).limit(50);if(b)throw b;return a||[]},enabled:!!C?.organization_id&&"real"===J}),{data:$}=(0,e.useQuery)({queryKey:["student",L],queryFn:async()=>{if(!L)return null;let a=await i.studentService.getById(L);if(a?.class_id){let{data:b}=await D.from("sessions").select("*, formations(*)").eq("id",a.class_id).single();return{...a,session:b}}return a},enabled:!!L&&"real"===J}),{data:_}=(0,e.useQuery)({queryKey:["invoice",N],queryFn:async()=>{if(!N)return null;let a=await j.invoiceService.getById(N);if(a?.student_id){let b=await i.studentService.getById(a.student_id);return{...a,student:b}}return a},enabled:!!N&&"real"===J});(0,c.useEffect)(()=>{T&&aa(T,(()=>{var a,b;if("sample"===J)return{ecole_nom:"École Moderne de Dakar",ecole_logo:"",ecole_adresse:"123 Avenue de l'Education, Dakar, Sénégal",ecole_ville:"Dakar",ecole_telephone:"+221 77 123 45 67",ecole_email:"contact@ecolemoderne.sn",ecole_site_web:"www.ecolemoderne.sn",eleve_nom:"DIALLO",eleve_prenom:"Amadou",eleve_numero:"LYC001",eleve_date_naissance:"15/03/2007",eleve_classe:"Terminale A",formation_nom:"Formation en Développement Web",formation_code:"DEV-WEB-2024",formation_duree:"6 mois",formation_prix:"500 000 XOF",session_nom:"Session Janvier 2024",session_debut:"01/01/2024",session_fin:"30/06/2024",date_jour:new Date().toLocaleDateString("fr-FR"),date_emission:new Date().toLocaleDateString("fr-FR"),annee_scolaire:"2024-2025",numero_document:"2025-001",date_generation:new Date().toLocaleDateString("fr-FR"),numero_page:1,total_pages:1};if(L&&$)return m($,V,$.session,$.session?.formations);if(N&&_){let b;return a=_.student,b=new Date,{ecole_nom:V?.name||"",ecole_logo:V?.logo_url||"",ecole_adresse:V?.address||"",ecole_ville:V?.city||"",ecole_telephone:V?.phone||"",ecole_email:V?.email||"",ecole_siret:V?.siret||"",eleve_nom:a?.last_name||"",eleve_prenom:a?.first_name||"",eleve_numero:a?.student_number||"",eleve_adresse:a?.address||"",montant:_?.total_amount?`${_.total_amount} ${_.currency||"EUR"}`:"",montant_ht:_?.amount?`${_.amount} ${_.currency||"EUR"}`:"",montant_ttc:_?.total_amount?`${_.total_amount} ${_.currency||"EUR"}`:"",tva:_?.tax_amount?`${_.tax_amount} ${_.currency||"EUR"}`:"",taux_tva:_?.tax_amount&&_?.amount?`${(_.tax_amount/_.amount*100).toFixed(2)}%`:"",numero_facture:_?.invoice_number||"",date_echeance:_?.due_date?(0,l.formatDate)(_.due_date):"",date_jour:(0,l.formatDate)(b),date_emission:_?.issue_date?(0,l.formatDate)(_.issue_date):(0,l.formatDate)(b),date_generation:(0,l.formatDate)(b),numero_document:_?.invoice_number||`DOC-${b.getTime()}`,numero_page:1,total_pages:1}}if(P&&Y){let a=Y.find(a=>a.id===P);if(a){let b,c=Array.isArray(a.invoices)?a.invoices[0]:a.invoices||a.invoice,d=Array.isArray(a.students)?a.students[0]:a.students||a.student;return b=new Date,{ecole_nom:V?.name||"",ecole_logo:V?.logo_url||"",ecole_adresse:V?.address||"",ecole_telephone:V?.phone||"",ecole_email:V?.email||"",eleve_nom:d?.last_name||"",eleve_prenom:d?.first_name||"",eleve_numero:d?.student_number||"",montant:a?.amount?`${a.amount} ${a.currency||"EUR"}`:"",date_paiement:a?.paid_at?(0,l.formatDate)(a.paid_at):a?.payment_date?(0,l.formatDate)(a.payment_date):"",mode_paiement:a?.payment_method||"",numero_facture:c?.invoice_number||"",date_jour:(0,l.formatDate)(b),date_emission:(0,l.formatDate)(b),date_generation:(0,l.formatDate)(b),numero_document:a?.payment_number||`DOC-${b.getTime()}`,numero_page:1,total_pages:1}}}if(R&&Z){let a=Z.find(a=>a.id===R);if(a){let c;return b=a.formations,c=new Date,{ecole_nom:V?.name||"",ecole_logo:V?.logo_url||"",ecole_adresse:V?.address||"",ecole_ville:V?.city||"",ecole_telephone:V?.phone||"",ecole_email:V?.email||"",ecole_siret:V?.siret||"",ecole_rcs:V?.rcs||"",ecole_representant:V?.representative_name||"",formation_nom:b?.name||"",formation_code:b?.code||"",formation_duree:b?.duration_hours?`${b.duration_hours} heures`:"",formation_prix:b?.price?`${b.price} ${b.currency||"EUR"}`:"",formation_description:b?.description||"",formation_objectifs:b?.objectives||"",session_nom:a?.name||"",session_debut:a?.start_date?(0,l.formatDate)(a.start_date):"",session_fin:a?.end_date?(0,l.formatDate)(a.end_date):"",session_lieu:a?.location||"",session_horaires:a?.start_time&&a?.end_time?`${a.start_time} - ${a.end_time}`:"",date_jour:(0,l.formatDate)(c),date_emission:(0,l.formatDate)(c),date_generation:(0,l.formatDate)(c),annee_actuelle:c.getFullYear().toString(),numero_document:`DOC-${c.getTime()}`,numero_page:1,total_pages:1}}}return W&&W.data&&W.data.length>0?m(W.data[0],V):{ecole_nom:V?.name||"",date_jour:new Date().toLocaleDateString("fr-FR"),date_emission:new Date().toLocaleDateString("fr-FR"),numero_document:"DOC_001",date_generation:new Date().toLocaleDateString("fr-FR"),numero_page:1,total_pages:1}})()).then(a=>{I(a)})},[T,J,L,N,P,R,V,W,X,Y,Z]);let aa=async(a,b)=>{try{let c=await fetch("/api/documents/generate",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({template_id:a.id,format:"PDF",variables:b})});if(!c.ok){let a=await c.json().catch(()=>({})),b=a.error||`Erreur ${c.status}: ${c.statusText}`,d=a.stack;throw console.error("Erreur API:",{status:c.status,statusText:c.statusText,error:b,stack:d,fullError:a}),Error(b)}return(await c.json()).downloadUrl}catch(b){console.error("Erreur lors de la génération du preview:",b);let a=b instanceof Error?b.message:"Erreur inconnue";return alert(`Erreur lors de la g\xe9n\xe9ration: ${a}`),null}};return U||!T?(0,b.jsx)(z.SkeletonLoader,{}):(0,b.jsxs)("div",{className:"space-y-6",children:[(0,b.jsxs)("div",{className:"flex items-center justify-between",children:[(0,b.jsxs)("div",{className:"flex items-center gap-4",children:[(0,b.jsx)(y.default,{href:"/dashboard/settings/document-templates",children:(0,b.jsx)(o.Button,{variant:"outline",size:"icon",children:(0,b.jsx)(r.ArrowLeft,{className:"h-4 w-4"})})}),(0,b.jsxs)("div",{children:[(0,b.jsxs)("h1",{className:"text-2xl font-bold text-text-primary flex items-center gap-2",children:[(0,b.jsx)(F.icon,{className:"h-6 w-6",style:{color:F.color}}),"Prévisualisation - ",F.name]}),(0,b.jsx)("p",{className:"text-sm text-text-tertiary mt-1",children:"Aperçu du document avec données réelles ou fictives"})]})]}),(0,b.jsxs)("div",{className:"flex gap-2",children:[(0,b.jsx)(y.default,{href:`/dashboard/settings/document-templates/${E}/edit`,children:(0,b.jsx)(o.Button,{variant:"outline",children:"Modifier"})}),H&&(0,b.jsx)("a",{href:H,download:`${F.name}_preview.pdf`,children:(0,b.jsxs)(o.Button,{variant:"default",children:[(0,b.jsx)(s.Download,{className:"h-4 w-4 mr-2"}),"Télécharger PDF"]})})]})]}),(0,b.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-4 gap-6",children:[(0,b.jsx)("div",{className:"lg:col-span-1",children:(0,b.jsxs)(q.GlassCard,{variant:"premium",className:"p-6",children:[(0,b.jsx)("h3",{className:"font-semibold text-text-primary mb-4",children:"Source de données"}),(0,b.jsxs)("div",{className:"space-y-4",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)(p.Label,{children:"Type de données"}),(0,b.jsxs)("select",{value:J,onChange:a=>{K(a.target.value),M(""),O(""),Q(""),S("")},className:"w-full mt-1 px-3 py-2 border rounded-lg",children:[(0,b.jsx)("option",{value:"real",children:"Données réelles"}),(0,b.jsx)("option",{value:"sample",children:"Données fictives"})]})]}),"real"===J&&(0,b.jsxs)(b.Fragment,{children:[["attestation_reussite","certificat_scolarite","releve_notes","attestation_entree","attestation_assiduite"].includes(E)&&(0,b.jsxs)("div",{children:[(0,b.jsxs)(p.Label,{htmlFor:"student",className:"flex items-center gap-2",children:[(0,b.jsx)(u.User,{className:"h-4 w-4"}),"Étudiant"]}),(0,b.jsxs)("select",{id:"student",value:L,onChange:a=>{M(a.target.value),O(""),Q(""),S("")},className:"w-full mt-1 px-3 py-2 border rounded-lg",children:[(0,b.jsx)("option",{value:"",children:"Sélectionner un étudiant"}),W?.data?.map(a=>(0,b.jsxs)("option",{value:a.id,children:[a.last_name," ",a.first_name," (",a.student_number,")"]},a.id))]})]}),"facture"===E&&(0,b.jsxs)("div",{children:[(0,b.jsxs)(p.Label,{htmlFor:"invoice",className:"flex items-center gap-2",children:[(0,b.jsx)(v.FileText,{className:"h-4 w-4"}),"Facture"]}),(0,b.jsxs)("select",{id:"invoice",value:N,onChange:a=>{O(a.target.value),M(""),Q(""),S("")},className:"w-full mt-1 px-3 py-2 border rounded-lg",children:[(0,b.jsx)("option",{value:"",children:"Sélectionner une facture"}),X?.map(a=>(0,b.jsxs)("option",{value:a.id,children:[a.invoice_number," - ",a.students?.first_name," ",a.students?.last_name]},a.id))]})]}),"recu_paiement"===E&&(0,b.jsxs)("div",{children:[(0,b.jsxs)(p.Label,{htmlFor:"payment",className:"flex items-center gap-2",children:[(0,b.jsx)(w.CreditCard,{className:"h-4 w-4"}),"Paiement"]}),(0,b.jsxs)("select",{id:"payment",value:P,onChange:a=>{Q(a.target.value),M(""),O(""),S("")},className:"w-full mt-1 px-3 py-2 border rounded-lg",children:[(0,b.jsx)("option",{value:"",children:"Sélectionner un paiement"}),Y?.map(a=>{let c=Array.isArray(a.students)?a.students[0]:a.students||a.student,d=c?`${c.first_name||""} ${c.last_name||""}`.trim():"N/A";return(0,b.jsxs)("option",{value:a.id,children:[a.payment_number||a.id," - ",d]},a.id)})]})]}),["certificat_scolarite"].includes(E)&&(0,b.jsxs)("div",{children:[(0,b.jsxs)(p.Label,{htmlFor:"session",className:"flex items-center gap-2",children:[(0,b.jsx)(x.Calendar,{className:"h-4 w-4"}),"Session"]}),(0,b.jsxs)("select",{id:"session",value:R,onChange:a=>{S(a.target.value),M(""),O(""),Q("")},className:"w-full mt-1 px-3 py-2 border rounded-lg",children:[(0,b.jsx)("option",{value:"",children:"Sélectionner une session"}),Z?.map(a=>(0,b.jsxs)("option",{value:a.id,children:[a.name," - ",a.formations?.name]},a.id))]})]})]})]})]})}),(0,b.jsx)("div",{className:"lg:col-span-3",children:(0,b.jsxs)(n.Card,{children:[(0,b.jsx)(n.CardHeader,{children:(0,b.jsx)(n.CardTitle,{children:"Aperçu du document"})}),(0,b.jsx)(n.CardContent,{className:"p-0",children:H?(0,b.jsx)("iframe",{src:H,className:"w-full h-[800px] border-0",title:"Prévisualisation du document"}):(0,b.jsx)("div",{className:"flex items-center justify-center h-96 text-text-tertiary",children:(0,b.jsxs)("div",{className:"text-center",children:[(0,b.jsx)(t.Eye,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),(0,b.jsx)("p",{children:"Génération de la prévisualisation..."})]})})})]})})]})]})}a.s(["default",()=>B],351134)}];

//# sourceMappingURL=c2699_dashboard_settings_document-templates_%5Btype%5D_preview_page_tsx_109651b2._.js.map