module.exports=[139895,a=>{"use strict";var b=a.i(187924),c=a.i(433217),d=a.i(937927),e=a.i(323625),f=a.i(727163),g=a.i(219897),h=a.i(340695),i=a.i(254161),j=a.i(864037);a.i(460355);var k=a.i(346271),l=a.i(262036),m=a.i(776803),n=a.i(641710),o=a.i(111269),p=a.i(54018),q=a.i(400210),r=a.i(732860),s=a.i(290821),t=a.i(93518),u=a.i(787654),v=a.i(101989),w=a.i(238246),x=a.i(50944),y=a.i(572131),z=a.i(325383);function A(){let a,A=(0,x.useParams)();(0,x.useRouter)();let B=A.quizId,{student:C,studentId:D}=(0,e.useLearnerContext)(),E=(0,y.useMemo)(()=>D?(0,f.createLearnerClient)(D):null,[D]);(0,d.useQueryClient)();let{addToast:F}=(0,j.useToast)(),[G,H]=(0,y.useState)(0),[I,J]=(0,y.useState)({}),[K,L]=(0,y.useState)(null),[M,N]=(0,y.useState)(!1),[O,P]=(0,y.useState)(!1),[Q,R]=(0,y.useState)(null),[S,T]=(0,y.useState)(0),U=(0,y.useRef)(!1),{data:V,isLoading:W,error:X}=(0,c.useQuery)({queryKey:["learner-quiz",B],queryFn:async()=>{if(!E)return null;let{data:a,error:b}=await E.from("quizzes").select(`
          *,
          lessons(title, courses(title)),
          quiz_questions(*)
        `).eq("id",B).maybeSingle();if(b){if("PGRST116"===b.code||"PGRST301"===b.code)return z.logger.warn("Quiz not found or access denied",{quizId:(0,z.maskId)(B),error:(0,z.sanitizeError)(b)}),null;throw b}return a},enabled:!!B&&!!E}),{data:Y,isLoading:Z}=(0,c.useQuery)({queryKey:["learner-quiz-fallback-lesson",B],queryFn:async()=>{if(!E)return null;let{data:a,error:b}=await E.from("lessons").select("id, title, content").eq("id",B).maybeSingle();if(b||!a?.content)return null;try{let b=JSON.parse(a.content);if(!Array.isArray(b))return null;let c=b.filter(a=>a?.type==="quiz");if(!c.length)return null;let d=c.map((a,b)=>{let c=a?.data?.question||`Question ${b+1}`,d=(a?.data?.options||[]).map(a=>String(a?.text??"")).filter(Boolean),e=(a?.data?.options||[]).filter(a=>a?.isCorrect).map(a=>String(a?.text??"")).filter(Boolean),f=e.length>1?e:e[0]||"";return{id:String(a?.id||`block-${b}`),question:c,type:"multiple_choice",options:d,correct_answer:f,points:1,explanation:a?.data?.explanation||void 0}});return{lessonTitle:a.title,questions:d,isGraded:d.some(a=>Array.isArray(a.correct_answer)?a.correct_answer.length>0:!!a.correct_answer)}}catch(a){return null}},enabled:!!B&&!!E&&!W&&!V}),$=V?(V?.quiz_questions||[]).sort((a,b)=>(a.order_index||0)-(b.order_index||0)).map(a=>{let b,c=a.question_type||a.type||"multiple_choice",d=a.question_text||a.question||"",e=a.explanation||void 0,f=a.points||1,g=a.correct_answer;if("multiple_choice"===c){let c=a.options;if(Array.isArray(c))if(c.length&&"object"==typeof c[0]){b=c.map(a=>String(a?.text??"")).filter(Boolean);let a=c.filter(a=>a?.is_correct).map(a=>String(a?.text??"")).filter(Boolean);1===a.length&&(g=a[0]),a.length>1&&(g=a)}else b=c.map(a=>String(a)).filter(Boolean)}if("true_false"===c){let a=String(g??"").toLowerCase();["true","vrai","1","t","yes","oui"].includes(a)&&(g="vrai"),["false","faux","0","f","no","non"].includes(a)&&(g="faux")}return null==g&&(g=""),{id:a.id,question:d,type:c,options:b,correct_answer:g,points:f,explanation:e}}).filter(a=>a?.id)||[]:Y?.questions||[];(0,y.useEffect)(()=>{V?.time_limit_minutes&&!O&&L(60*V.time_limit_minutes)},[V,O]),(0,y.useEffect)(()=>{if(null===K||K<=0||O)return;let a=setInterval(()=>{L(a=>a&&a<=1?(ae(),0):a?a-1:null)},1e3);return()=>clearInterval(a)},[K,O]);let _=$[G],aa=$.length,ab=Object.keys(I).length,ac=(a,b)=>{J(c=>({...c,[a]:b}))},ad=(0,y.useCallback)((a,b,c)=>{if(a){if(!c)return void ac(a,b);J(c=>{let d=c[a],e=Array.isArray(d)?[...d]:[],f=e.indexOf(b);return f>=0?e.splice(f,1):e.push(b),{...c,[a]:e}})}},[J]),ae=async()=>{if(!M){N(!0);try{let a=0,b=0,c={};$.forEach(d=>{b+=d.points||1;let e=I[d.id],f=d.correct_answer,g=!1;(g=Array.isArray(f)?Array.isArray(e)?f.every(a=>e.includes(a))&&e.length===f.length:f.includes(e):e===f)&&(a+=d.points||1),c[d.id]={correct:g,correctAnswer:f}});let d=$.some(a=>Array.isArray(a.correct_answer)?a.correct_answer.length>0:!!a.correct_answer),e=d?Math.round(a/b*100):0,f=!d||e>=(V?.passing_score||70);if(D&&E)try{await E.from("lesson_quiz_responses").insert({student_id:D,lesson_id:V?.lesson_id,quiz_id:B,answers:I,score:e,passed:f,completed_at:new Date().toISOString()})}catch(a){}R({score:e,total:b,passed:f,answers:c}),P(!0),F({type:f?"success":"error",title:f?"Félicitations !":"Quiz terminé",description:d?f?`Vous avez r\xe9ussi avec ${e}% !`:`Score: ${e}%. Le seuil de r\xe9ussite est de ${V?.passing_score||70}%.`:"Quiz non noté : réponses enregistrées."})}catch(a){F({type:"error",title:"Erreur",description:"Impossible de soumettre le quiz."})}finally{N(!1)}}};return W||Z?(0,b.jsx)("div",{className:"flex items-center justify-center min-h-[60vh]",children:(0,b.jsxs)("div",{className:"text-center",children:[(0,b.jsx)(m.ClipboardCheck,{className:"h-12 w-12 text-gray-300 mx-auto mb-4 animate-pulse"}),(0,b.jsx)("p",{className:"text-gray-500",children:"Chargement du quiz..."})]})}):V||Y?O&&Q?(0,b.jsxs)("div",{className:"max-w-2xl mx-auto space-y-6 pb-24 lg:pb-8",children:[(0,b.jsxs)(g.GlassCard,{className:"p-8 text-center",children:[(0,b.jsx)(k.motion.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",damping:15},children:Q.passed?(0,b.jsx)("div",{className:"w-24 h-24 mx-auto mb-6 rounded-full bg-green-100 flex items-center justify-center",children:(0,b.jsx)(t.Award,{className:"h-12 w-12 text-green-600"})}):(0,b.jsx)("div",{className:"w-24 h-24 mx-auto mb-6 rounded-full bg-red-100 flex items-center justify-center",children:(0,b.jsx)(p.XCircle,{className:"h-12 w-12 text-red-600"})})}),(0,b.jsx)("h1",{className:"text-2xl font-bold text-gray-900 mb-2",children:Q.passed?"Félicitations !":"Quiz terminé"}),(0,b.jsx)("p",{className:"text-gray-500 mb-6",children:V?.title||""}),(0,b.jsxs)("div",{className:"flex justify-center gap-8 mb-8",children:[(0,b.jsxs)("div",{className:"text-center",children:[(0,b.jsxs)("div",{className:`text-4xl font-bold ${Q.passed?"text-green-600":"text-red-600"}`,children:[Q.score,"%"]}),(0,b.jsx)("p",{className:"text-sm text-gray-500",children:"Votre score"})]}),(0,b.jsx)("div",{className:"w-px bg-gray-200"}),(0,b.jsxs)("div",{className:"text-center",children:[(0,b.jsxs)("div",{className:"text-4xl font-bold text-gray-400",children:[V?.passing_score||70,"%"]}),(0,b.jsx)("p",{className:"text-sm text-gray-500",children:"Score requis"})]})]}),Q.passed?(0,b.jsxs)(i.Badge,{className:"bg-green-100 text-green-700 text-base px-4 py-2",children:[(0,b.jsx)(o.CheckCircle2,{className:"h-4 w-4 mr-2"}),"Quiz réussi"]}):(0,b.jsxs)(i.Badge,{className:"bg-red-100 text-red-700 text-base px-4 py-2",children:[(0,b.jsx)(p.XCircle,{className:"h-4 w-4 mr-2"}),"Score insuffisant"]})]}),(0,b.jsxs)(g.GlassCard,{className:"p-6",children:[(0,b.jsx)("h3",{className:"font-bold text-gray-900 mb-4",children:"Résumé des réponses"}),(0,b.jsx)("div",{className:"space-y-3",children:$.map((a,c)=>{let d=Q.answers[a.id];return(0,b.jsx)("div",{className:`p-4 rounded-xl ${d?.correct?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"}`,children:(0,b.jsxs)("div",{className:"flex items-start gap-3",children:[d?.correct?(0,b.jsx)(o.CheckCircle2,{className:"h-5 w-5 text-green-600 flex-shrink-0 mt-0.5"}):(0,b.jsx)(p.XCircle,{className:"h-5 w-5 text-red-600 flex-shrink-0 mt-0.5"}),(0,b.jsxs)("div",{children:[(0,b.jsxs)("p",{className:"font-medium text-gray-900",children:["Question ",c+1]}),(0,b.jsx)("p",{className:"text-sm text-gray-600 mt-1",children:a.question}),!d?.correct&&(0,b.jsxs)("p",{className:"text-sm text-green-600 mt-2",children:["Réponse correcte : ",Array.isArray(d?.correctAnswer)?d?.correctAnswer.join(", "):d?.correctAnswer]}),a.explanation&&(0,b.jsx)("p",{className:"text-sm text-gray-500 mt-2 italic",children:a.explanation})]})]})},a.id)})})]}),(0,b.jsxs)("div",{className:"flex gap-4",children:[!Q.passed&&(0,b.jsxs)(h.Button,{onClick:()=>{J({}),H(0),P(!1),R(null),V?.time_limit_minutes&&L(60*V.time_limit_minutes)},className:"flex-1",children:[(0,b.jsx)(u.RotateCcw,{className:"h-4 w-4 mr-2"}),"Réessayer"]}),(0,b.jsx)(w.default,{href:"/learner/evaluations",className:"flex-1",children:(0,b.jsxs)(h.Button,{variant:"outline",className:"w-full",children:[(0,b.jsx)(v.Home,{className:"h-4 w-4 mr-2"}),"Retour aux évaluations"]})})]})]}):(0,b.jsxs)("div",{className:"max-w-3xl mx-auto space-y-6 pb-24 lg:pb-8",children:[(0,b.jsxs)("div",{className:"flex items-center justify-between",children:[(0,b.jsx)(w.default,{href:"/learner/evaluations",children:(0,b.jsxs)(h.Button,{variant:"ghost",size:"sm",children:[(0,b.jsx)(q.ArrowLeft,{className:"h-4 w-4 mr-2"}),"Quitter"]})}),null!==K&&(0,b.jsxs)(i.Badge,{className:`text-base px-4 py-2 ${K<60?"bg-red-100 text-red-700":"bg-gray-100 text-gray-700"}`,children:[(0,b.jsx)(n.Clock,{className:"h-4 w-4 mr-2"}),(a=Math.floor(K/60),`${a}:${(K%60).toString().padStart(2,"0")}`)]})]}),(0,b.jsxs)("div",{className:"text-xs text-gray-500 flex items-center justify-between",children:[(0,b.jsxs)("span",{children:["version: ","quiz-ui-2025-12-17-01"]}),(0,b.jsxs)("span",{children:["taps: ",S]})]}),(0,b.jsxs)(g.GlassCard,{className:"p-4",children:[(0,b.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,b.jsxs)("span",{className:"text-sm font-medium text-gray-600",children:["Question ",G+1," sur ",aa]}),(0,b.jsxs)("span",{className:"text-sm text-gray-500",children:[ab," répondu",ab>1?"es":"e"]})]}),(0,b.jsx)("div",{className:"w-full h-2 bg-gray-100 rounded-full overflow-hidden",children:(0,b.jsx)(k.motion.div,{className:"h-full bg-brand-blue",initial:{width:0},animate:{width:`${(G+1)/aa*100}%`}})})]}),(0,b.jsx)(l.AnimatePresence,{mode:"wait",children:(0,b.jsx)(k.motion.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},transition:{duration:.2},children:(0,b.jsx)(g.GlassCard,{className:"p-6",children:(0,b.jsxs)("div",{onPointerDownCapture:()=>T(a=>a+1),onClickCapture:()=>T(a=>a+1),children:[(0,b.jsx)("h2",{className:"text-lg font-bold text-gray-900 mb-6",children:_?.question}),_?.type==="multiple_choice"&&_.options&&(0,b.jsx)("div",{className:"space-y-3",children:_.options.map((a,c)=>{let d=Array.isArray(_.correct_answer),e=I[_.id],f=d?Array.isArray(e)&&e.includes(a):e===a;return(0,b.jsx)("button",{type:"button",onPointerDown:b=>{U.current=!0,b.preventDefault(),b.stopPropagation(),ad(_.id,a,d)},onClick:b=>{if(b.preventDefault(),b.stopPropagation(),U.current){U.current=!1;return}ad(_.id,a,d)},className:`w-full p-4 rounded-xl text-left transition-all ${f?"bg-brand-blue text-white ring-2 ring-brand-blue":"bg-gray-50 hover:bg-gray-100 text-gray-700"}`,children:(0,b.jsxs)("div",{className:"flex items-center gap-3",children:[(0,b.jsx)("div",{className:`w-6 h-6 rounded-full border-2 flex items-center justify-center ${f?"border-white bg-white":"border-gray-300"}`,children:f&&(0,b.jsx)("div",{className:"w-3 h-3 rounded-full bg-brand-blue"})}),(0,b.jsx)("span",{className:"font-medium",children:a})]})},c)})}),_?.type==="true_false"&&(0,b.jsx)("div",{className:"grid grid-cols-2 gap-4",children:["Vrai","Faux"].map(a=>{let c=I[_.id]===a.toLowerCase();return(0,b.jsx)("button",{type:"button",onPointerDown:b=>{U.current=!0,b.preventDefault(),b.stopPropagation(),ac(_.id,a.toLowerCase())},onClick:b=>{if(b.preventDefault(),b.stopPropagation(),U.current){U.current=!1;return}ac(_.id,a.toLowerCase())},className:`p-6 rounded-xl text-center transition-all ${c?"bg-brand-blue text-white ring-2 ring-brand-blue":"bg-gray-50 hover:bg-gray-100 text-gray-700"}`,children:(0,b.jsx)("span",{className:"text-lg font-semibold",children:a})},a)})}),!1]})})},G)}),(0,b.jsxs)("div",{className:"flex items-center justify-between",children:[(0,b.jsxs)(h.Button,{variant:"outline",onClick:()=>H(Math.max(0,G-1)),disabled:0===G,children:[(0,b.jsx)(q.ArrowLeft,{className:"h-4 w-4 mr-2"}),"Précédent"]}),G<aa-1?(0,b.jsxs)(h.Button,{onClick:()=>H(G+1),children:["Suivant",(0,b.jsx)(r.ArrowRight,{className:"h-4 w-4 ml-2"})]}):(0,b.jsxs)(h.Button,{onClick:ae,disabled:M||ab<aa,className:"bg-green-600 hover:bg-green-700",children:[M?"Envoi...":"Soumettre",(0,b.jsx)(o.CheckCircle2,{className:"h-4 w-4 ml-2"})]})]}),(0,b.jsxs)(g.GlassCard,{className:"p-4",children:[(0,b.jsx)("p",{className:"text-sm font-medium text-gray-600 mb-3",children:"Navigation rapide"}),(0,b.jsx)("div",{className:"flex flex-wrap gap-2",children:$.map((a,c)=>{let d=!!I[a.id],e=c===G;return(0,b.jsx)("button",{type:"button",onClick:a=>{a.preventDefault(),H(c)},className:`w-10 h-10 rounded-lg font-medium transition-all ${e?"bg-brand-blue text-white":d?"bg-green-100 text-green-700":"bg-gray-100 text-gray-600 hover:bg-gray-200"}`,children:c+1},a.id)})})]})]}):(0,b.jsxs)("div",{className:"text-center py-12",children:[(0,b.jsx)(s.AlertCircle,{className:"h-16 w-16 text-gray-300 mx-auto mb-4"}),(0,b.jsx)("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Quiz introuvable"}),(0,b.jsx)("p",{className:"text-sm text-gray-600 mb-6",children:"Ce quiz n’existe pas encore, ou l’accès n’est pas autorisé côté apprenant. Vérifie qu’un quiz est bien créé pour la leçon, et que la migration `20251217000013_learner_header_access_quizzes.sql` est appliquée."}),(0,b.jsx)(w.default,{href:"/learner/evaluations",children:(0,b.jsxs)(h.Button,{variant:"outline",children:[(0,b.jsx)(q.ArrowLeft,{className:"h-4 w-4 mr-2"}),"Retour aux évaluations"]})})]})}a.s(["default",()=>A])}];

//# sourceMappingURL=app_%28learner%29_learner_evaluations_%5BquizId%5D_page_tsx_298c1134._.js.map