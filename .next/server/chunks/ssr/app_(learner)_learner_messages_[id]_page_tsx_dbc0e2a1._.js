module.exports=[3902,a=>{"use strict";var b=a.i(187924),c=a.i(50944),d=a.i(433217),e=a.i(370025),f=a.i(937927),g=a.i(323625),h=a.i(805781),i=a.i(340695),j=a.i(205522),k=a.i(400210),l=a.i(692759),m=a.i(526017),n=a.i(660246),o=a.i(546842),p=a.i(563588),q=a.i(781560),r=a.i(436265),s=a.i(572131),t=a.i(497895),u=a.i(727163),v=a.i(550513),w=a.i(676504);function x(){let a=(0,c.useParams)(),x=(0,c.useRouter)(),y=(0,g.useLearnerContext)(),z=(0,f.useQueryClient)(),A=a.id,B=y.studentId||void 0;y.organizationId;let[C,D]=(0,s.useState)(""),E=(0,s.useRef)(null),F=B?(0,u.createLearnerClient)(B):null,{data:G,isLoading:H,error:I}=(0,d.useQuery)({queryKey:["learner-conversation",A,B],queryFn:async()=>{if(!B||!A||!F)return null;let{data:a,error:b}=await F.from("conversations").select("*").eq("id",A).maybeSingle();if(b||!a)throw b||Error("Conversation introuvable");let{data:c}=await F.from("conversation_participants").select("*").eq("conversation_id",A),d=await Promise.all((c||[]).map(async a=>{let b=null,c=null;if(a.user_id)try{let{data:c,error:d}=await F.rpc("get_user_name",{p_user_id:a.user_id});if(!d&&c)b=c;else{let{data:c,error:d}=await F.from("users").select("id, full_name, email, avatar_url").eq("id",a.user_id).maybeSingle();b=!d&&c?c:{id:a.user_id,full_name:null,email:null,avatar_url:null}}}catch(c){b={id:a.user_id,full_name:null,email:null,avatar_url:null}}if(a.student_id)try{let{data:b,error:d}=await F.from("students").select("id, first_name, last_name, email, student_number").eq("id",a.student_id).maybeSingle();!d&&b&&(c=b)}catch(a){}return{...a,user:b,student:c}}));return{...a,participants:d}},enabled:!!A&&!!B}),{data:J,isLoading:K}=(0,d.useQuery)({queryKey:["learner-messages",A,B],queryFn:async()=>{if(!B||!A||!F)return[];let{data:a,error:b}=await F.from("messages").select("*").eq("conversation_id",A).eq("is_deleted",!1).order("created_at",{ascending:!1}).limit(50);if(b)throw b;return a&&0!==a.length?(await Promise.all(a.map(async a=>{let b=null,c=null;if(a.sender_id)try{let{data:c,error:d}=await F.rpc("get_user_name",{p_user_id:a.sender_id});if(!d&&c)b=c;else{let{data:c,error:d}=await F.from("users").select("id, full_name, email, avatar_url").eq("id",a.sender_id).maybeSingle();b=!d&&c?c:{id:a.sender_id,full_name:null,email:null,avatar_url:null}}}catch(c){b={id:a.sender_id,full_name:null,email:null,avatar_url:null}}if(a.student_sender_id)try{let{data:b,error:d}=await F.from("students").select("id, first_name, last_name, email, student_number").eq("id",a.student_sender_id).maybeSingle();!d&&b&&(c=b)}catch(a){}return{...a,sender:b,student_sender:c}}))).reverse():[]},enabled:!!A&&!!B,refetchInterval:5e3}),L=(0,e.useMutation)({mutationFn:async a=>{if(!F)throw Error("Client Supabase non disponible");return h.messagingService.deleteMessage(a)},onSuccess:()=>{z.invalidateQueries({queryKey:["learner-messages",A]}),z.invalidateQueries({queryKey:["learner-conversations"]})},onError:a=>{alert(a instanceof Error?a.message:"Impossible de supprimer le message.")}}),M=(0,e.useMutation)({mutationFn:async a=>{if(!B||!A||!F)throw Error("Étudiant non identifié");let{data:b}=await F.from("students").select("id, email").eq("id",B).maybeSingle();if(!b)throw Error("Étudiant non trouvé");let{data:c,error:d}=await F.rpc("insert_student_message",{p_conversation_id:A,p_student_id:B,p_content:a.trim()});if(d)throw Error(d.message||"Erreur lors de l'envoi du message");if(!c)throw Error("Le message n'a pas pu être créé");return c},onSuccess:()=>{D(""),z.invalidateQueries({queryKey:["learner-messages",A]}),z.invalidateQueries({queryKey:["learner-conversations"]}),setTimeout(()=>{E.current?.scrollIntoView({behavior:"smooth"})},100)},onError:a=>{alert(a instanceof Error?a.message:"Une erreur est survenue lors de l'envoi du message.")}});(0,s.useEffect)(()=>{E.current?.scrollIntoView({behavior:"smooth"})},[J]);let N=G?.participants?.find(a=>a.student_id===B),O=G?(()=>{if(!G?.participants||0===G.participants.length)return null;if("group"===G.conversation_type&&G.name)return{name:G.name,type:"group",data:null};let a=G.participants.find(a=>!(a.student_id===B||N?.user_id&&a.user_id===N.user_id));if(a||(a=G.participants.find(a=>a.student_id!==B)),!a)return null;if(a.user_id){if(a.user){let b=a.user.full_name||a.user.email;if(b)return{name:b,type:"admin",data:a.user}}return{name:`Administrateur ${a.user_id.substring(0,8)}`,type:"admin",data:{id:a.user_id,full_name:null,email:null}}}if(a.student_id){if(a.student){let b=`${a.student.first_name||""} ${a.student.last_name||""}`.trim()||a.student.email||(a.student.student_number?`Candidat ${a.student.student_number}`:null);if(b)return{name:b,type:"student",data:a.student}}return{name:`Candidat ${a.student_id.substring(0,8)}`,type:"student",data:{id:a.student_id,first_name:null,last_name:null,email:null}}}return null})():null,[P,Q]=(0,s.useState)(O);(0,s.useEffect)(()=>{(async()=>{if(O&&"admin"===O.type&&O.data?.id&&(!O.name||O.name.startsWith("Administrateur ")||O.name.startsWith("Utilisateur ")))try{if(!F)return;let{data:a,error:b}=await F.rpc("get_user_name",{p_user_id:O.data.id});if(!b&&a){let b=a.full_name||a.email;b&&Q({...O,name:b,type:"admin",data:a})}}catch(a){}})()},[O,F]);let R=P||O;return H?(0,b.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,b.jsx)(m.Loader2,{className:"h-8 w-8 animate-spin text-muted-foreground"})}):I||!G?(0,b.jsxs)("div",{className:"container mx-auto py-8 px-4 max-w-7xl",children:[(0,b.jsxs)("div",{className:"flex items-center gap-4 mb-6",children:[(0,b.jsx)(i.Button,{variant:"ghost",size:"icon",onClick:()=>x.push("/learner/messages"),children:(0,b.jsx)(k.ArrowLeft,{className:"h-4 w-4"})}),(0,b.jsx)("h1",{className:"text-2xl font-bold",children:"Conversation introuvable"})]}),(0,b.jsx)("div",{className:"text-center py-8",children:(0,b.jsx)("p",{className:"text-muted-foreground",children:"Cette conversation n'existe pas ou vous n'avez pas la permission de la voir."})})]}):(0,b.jsxs)("div",{className:"flex flex-col h-[calc(100vh-4rem)]",children:[(0,b.jsx)("div",{className:"border-b bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60",children:(0,b.jsx)("div",{className:"container mx-auto px-4 py-4 max-w-7xl",children:(0,b.jsxs)("div",{className:"flex items-center gap-4",children:[(0,b.jsx)(i.Button,{variant:"ghost",size:"icon",onClick:()=>x.push("/learner/messages"),children:(0,b.jsx)(k.ArrowLeft,{className:"h-4 w-4"})}),(0,b.jsxs)("div",{className:"flex items-center gap-3 flex-1",children:[O?.type==="student"?(0,b.jsx)("div",{className:"h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center",children:(0,b.jsx)(o.User,{className:"h-5 w-5 text-primary"})}):(0,b.jsx)("div",{className:"h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center",children:(0,b.jsx)(n.Users,{className:"h-5 w-5 text-primary"})}),(0,b.jsxs)("div",{children:[(0,b.jsx)("h1",{className:"text-lg font-semibold",children:R?.name||"group"===G.conversation_type&&G.name||"Conversation"}),"group"===G.conversation_type&&G.name&&R?.name!==G.name&&(0,b.jsx)("p",{className:"text-sm text-muted-foreground",children:G.name})]})]})]})})}),(0,b.jsx)("div",{className:"flex-1 overflow-y-auto container mx-auto px-4 py-6 max-w-7xl",children:K?(0,b.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,b.jsx)(m.Loader2,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):J&&J.length>0?(0,b.jsxs)("div",{className:"space-y-4",children:[J.map(a=>{let c=G.participants?.find(a=>a.student_id===B),d=c?.user_id===a.sender_id||a.student_sender_id===B,e=null;if(a.sender&&(e=a.sender.full_name||a.sender.email||null),!e&&a.student_sender&&(e=`${a.student_sender.first_name||""} ${a.student_sender.last_name||""}`.trim()||a.student_sender.email||(a.student_sender.student_number?`Candidat ${a.student_sender.student_number}`:null)),!e&&!d&&G.participants){if(a.sender_id){let b=G.participants.find(b=>b.user_id===a.sender_id);b?.user&&(e=b.user.full_name||b.user.email||null)}if(!e&&a.student_sender_id){let b=G.participants.find(b=>b.student_id===a.student_sender_id);b?.student&&(e=`${b.student.first_name||""} ${b.student.last_name||""}`.trim()||b.student.email||(b.student.student_number?`Candidat ${b.student.student_number}`:null))}}return!e&&!d&&R?.name&&(e=R.name),(0,b.jsxs)("div",{className:`flex items-start gap-2 ${d?"justify-end":"justify-start"}`,children:[!d&&(0,b.jsx)("div",{className:"w-8"}),(0,b.jsxs)("div",{className:"group relative flex items-start gap-2",children:[(0,b.jsxs)("div",{className:`max-w-[70%] rounded-lg px-4 py-2 ${d?"bg-primary text-primary-foreground":"bg-muted"}`,children:[!d&&e&&(0,b.jsx)("p",{className:"text-xs font-medium mb-1 opacity-80",children:e}),a.attachments&&Array.isArray(a.attachments)&&a.attachments.length>0&&(0,b.jsx)("div",{className:"mb-2",children:(0,b.jsx)(v.MessageAttachmentViewer,{attachments:a.attachments})}),(0,b.jsx)("p",{className:"text-sm whitespace-pre-wrap",children:a.content}),(0,b.jsx)("p",{className:`text-xs mt-1 ${d?"text-primary-foreground/70":"text-muted-foreground"}`,children:(0,t.formatRelativeTime)(a.created_at)})]}),d&&(0,b.jsxs)(w.DropdownMenu,{children:[(0,b.jsx)(w.DropdownMenuTrigger,{asChild:!0,children:(0,b.jsx)(i.Button,{variant:"ghost",size:"icon",className:"h-6 w-6 opacity-0 group-hover:opacity-100 transition-opacity",onClick:a=>a.stopPropagation(),children:(0,b.jsx)(r.MoreVertical,{className:"h-3 w-3"})})}),(0,b.jsx)(w.DropdownMenuContent,{align:"end",children:(0,b.jsxs)(w.DropdownMenuItem,{onClick:b=>{b.preventDefault(),b.stopPropagation(),confirm("Êtes-vous sûr de vouloir supprimer ce message ?")&&L.mutate(a.id)},disabled:L.isPending,className:"text-destructive focus:text-destructive",children:[(0,b.jsx)(q.Trash2,{className:"mr-2 h-4 w-4"}),"Supprimer"]})})]})]}),d&&(0,b.jsx)("div",{className:"w-8"})]},a.id)}),(0,b.jsx)("div",{ref:E})]}):(0,b.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,b.jsxs)("div",{className:"text-center",children:[(0,b.jsx)(p.MessageSquare,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),(0,b.jsx)("p",{className:"text-muted-foreground",children:"Aucun message pour le moment"}),(0,b.jsx)("p",{className:"text-sm text-muted-foreground mt-2",children:"Commencez la conversation en envoyant un message"})]})})}),(0,b.jsx)("div",{className:"border-t bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60",children:(0,b.jsx)("div",{className:"container mx-auto px-4 py-4 max-w-7xl",children:(0,b.jsxs)("form",{onSubmit:a=>{a.preventDefault(),C.trim()&&!M.isPending&&M.mutate(C.trim())},className:"flex gap-2",children:[(0,b.jsx)(j.Input,{value:C,onChange:a=>D(a.target.value),placeholder:"Tapez votre message...",disabled:M.isPending,className:"flex-1"}),(0,b.jsx)(i.Button,{type:"submit",disabled:!C.trim()||M.isPending,size:"icon",children:M.isPending?(0,b.jsx)(m.Loader2,{className:"h-4 w-4 animate-spin"}):(0,b.jsx)(l.Send,{className:"h-4 w-4"})})]})})})]})}a.s(["default",()=>x])}];

//# sourceMappingURL=app_%28learner%29_learner_messages_%5Bid%5D_page_tsx_dbc0e2a1._.js.map