{"version":3,"sources":["../../../../app/%28dashboard%29/dashboard/sessions/%5Bid%5D/hooks/use-document-generation.ts","../../../../lib/utils/document-templates.ts"],"sourcesContent":["'use client'\n\nimport { useState } from 'react'\nimport { generatePDFFromHTML, createZipFromPDFs, generatePDFBlobFromHTML } from '@/lib/utils/pdf-generator'\nimport {\n  generateConventionHTML,\n  generateContractHTML,\n  generateConvocationHTML,\n  generateProgramHTML,\n  generateTermsHTML,\n  generatePrivacyPolicyHTML,\n} from '@/lib/utils/document-templates'\nimport { useToast } from '@/components/ui/toast'\nimport { logger } from '@/lib/utils/logger'\nimport { emailService } from '@/lib/services/email.service'\nimport { formatDate } from '@/lib/utils'\nimport type { \n  SessionWithRelations, \n  EnrollmentWithRelations,\n  FormationWithRelations\n} from '@/lib/types/query-types'\nimport type { TableRow } from '@/lib/types/supabase-helpers'\n\ntype Program = TableRow<'programs'>\ntype Organization = TableRow<'organizations'>\n\ninterface DocumentGenerationProps {\n  sessionData: SessionWithRelations | undefined\n  formation: FormationWithRelations | null | undefined\n  program: Program | null | undefined\n  organization: Organization | undefined\n}\n\nexport function useDocumentGeneration({\n  sessionData,\n  formation,\n  program,\n  organization,\n}: DocumentGenerationProps) {\n  const { addToast } = useToast()\n  const [isGeneratingZip, setIsGeneratingZip] = useState(false)\n  const [zipGenerationProgress, setZipGenerationProgress] = useState({ current: 0, total: 0 })\n  const [lastZipGeneration, setLastZipGeneration] = useState<Date | null>(null)\n\n  const handleGenerateConvention = async () => {\n    if (!sessionData || !formation || !organization) {\n      addToast({\n        type: 'error',\n        title: 'Erreur',\n        description: 'Données manquantes pour générer la convention.',\n      })\n      return\n    }\n\n    try {\n      const html = await generateConventionHTML({\n        session: {\n          name: sessionData.name,\n          start_date: sessionData.start_date,\n          end_date: sessionData.end_date,\n          location: sessionData.location || undefined,\n        },\n        formation: {\n          name: formation.name,\n          code: formation.code || undefined,\n          price: (formation as FormationWithRelations & { price?: number }).price || undefined,\n          duration_hours: (formation as FormationWithRelations & { duration_hours?: number }).duration_hours || undefined,\n        },\n        program: program ? { name: program.name } : undefined,\n        organization: {\n          name: organization.name,\n          address: organization.address || undefined,\n          phone: organization.phone || undefined,\n          email: organization.email || undefined,\n          logo_url: organization.logo_url || undefined,\n        },\n        issueDate: new Date().toISOString(),\n        language: 'fr',\n      })\n\n      const tempDiv = document.createElement('div')\n      tempDiv.innerHTML = html\n      tempDiv.style.position = 'absolute'\n      tempDiv.style.left = '-9999px'\n      document.body.appendChild(tempDiv)\n\n      const element = tempDiv.querySelector('[id$=\"-document\"]')\n      if (element) {\n        element.id = `temp-convention-${Date.now()}`\n        await new Promise((resolve) => setTimeout(resolve, 500))\n        await generatePDFFromHTML(element.id, `convention_${sessionData.name.replace(/\\s+/g, '_')}.pdf`)\n      }\n\n      document.body.removeChild(tempDiv)\n      addToast({\n        type: 'success',\n        title: 'Convention générée',\n        description: 'La convention a été générée et téléchargée avec succès.',\n      })\n    } catch (error) {\n      logger.error('Erreur lors de la génération de la convention', error as Error, {\n        sessionId: sessionData?.id,\n        formationId: formation?.id,\n      })\n      addToast({\n        type: 'error',\n        title: 'Erreur',\n        description: 'Une erreur est survenue lors de la génération de la convention.',\n      })\n    }\n  }\n\n  const handleGenerateContract = async (enrollment: EnrollmentWithRelations) => {\n    if (!sessionData || !formation || !organization || !enrollment) return\n\n    const student = enrollment.students\n    if (!student) return\n\n    try {\n      const html = await generateContractHTML({\n        student: {\n          first_name: student.first_name,\n          last_name: student.last_name,\n          email: student.email || undefined,\n          phone: student.phone || undefined,\n          address: student.address || undefined,\n          date_of_birth: student.date_of_birth || undefined,\n        },\n        session: {\n          name: sessionData.name,\n          start_date: sessionData.start_date,\n          end_date: sessionData.end_date,\n          location: sessionData.location || undefined,\n        },\n        formation: {\n          name: formation.name,\n          code: formation.code || undefined,\n          price: (formation as FormationWithRelations & { price?: number }).price || undefined,\n          duration_hours: (formation as FormationWithRelations & { duration_hours?: number }).duration_hours || undefined,\n        },\n        program: program ? { name: program.name } : undefined,\n        organization: {\n          name: organization.name,\n          address: organization.address || undefined,\n          phone: organization.phone || undefined,\n          email: organization.email || undefined,\n          logo_url: organization.logo_url || undefined,\n        },\n        enrollment: {\n          enrollment_date: enrollment.enrollment_date || '',\n          total_amount: enrollment.total_amount || 0,\n          paid_amount: enrollment.paid_amount || 0,\n        },\n        issueDate: new Date().toISOString(),\n        language: 'fr',\n      })\n\n      const tempDiv = document.createElement('div')\n      tempDiv.innerHTML = html\n      tempDiv.style.position = 'absolute'\n      tempDiv.style.left = '-9999px'\n      document.body.appendChild(tempDiv)\n\n      const element = tempDiv.querySelector('[id$=\"-document\"]')\n      if (element) {\n        element.id = `temp-contract-${Date.now()}`\n        await new Promise((resolve) => setTimeout(resolve, 500))\n        await generatePDFFromHTML(element.id, `contrat_${student.last_name}_${student.first_name}.pdf`)\n      }\n\n      document.body.removeChild(tempDiv)\n      addToast({\n        type: 'success',\n        title: 'Contrat généré',\n        description: 'Le contrat a été généré et téléchargé avec succès.',\n      })\n    } catch (error) {\n      logger.error('Erreur lors de la génération du contrat', error as Error, {\n        enrollmentId: enrollment.id,\n        studentId: enrollment.student_id,\n      })\n      addToast({\n        type: 'error',\n        title: 'Erreur',\n        description: 'Une erreur est survenue lors de la génération du contrat.',\n      })\n    }\n  }\n\n  const handleGenerateConvocation = async (enrollment: EnrollmentWithRelations) => {\n    if (!sessionData || !formation || !organization || !enrollment) return\n\n    const student = enrollment.students\n    if (!student) return\n\n    try {\n      const html = await generateConvocationHTML({\n        student: {\n          first_name: student.first_name,\n          last_name: student.last_name,\n          email: student.email || undefined,\n          phone: student.phone || undefined,\n        },\n        session: {\n          name: sessionData.name,\n          start_date: sessionData.start_date,\n          end_date: sessionData.end_date,\n          start_time: sessionData.start_time || undefined,\n          end_time: sessionData.end_time || undefined,\n          location: sessionData.location || undefined,\n        },\n        formation: {\n          name: formation.name,\n          code: formation.code || undefined,\n        },\n        program: program ? { name: program.name } : undefined,\n        organization: {\n          name: organization.name,\n          address: organization.address || undefined,\n          phone: organization.phone || undefined,\n          email: organization.email || undefined,\n          logo_url: organization.logo_url || undefined,\n        },\n        issueDate: new Date().toISOString(),\n        language: 'fr',\n      })\n\n      const tempDiv = document.createElement('div')\n      tempDiv.innerHTML = html\n      tempDiv.style.position = 'absolute'\n      tempDiv.style.left = '-9999px'\n      document.body.appendChild(tempDiv)\n\n      const element = tempDiv.querySelector('[id$=\"-document\"]')\n      if (element) {\n        element.id = `temp-convocation-${Date.now()}`\n        await new Promise((resolve) => setTimeout(resolve, 500))\n        await generatePDFFromHTML(element.id, `convocation_${student.last_name}_${student.first_name}.pdf`)\n      }\n\n      document.body.removeChild(tempDiv)\n      addToast({\n        type: 'success',\n        title: 'Convocation générée',\n        description: 'La convocation a été générée et téléchargée avec succès.',\n      })\n    } catch (error) {\n      logger.error('Erreur lors de la génération de la convocation', error as Error, {\n        enrollmentId: enrollment.id,\n        studentId: enrollment.student_id,\n      })\n      addToast({\n        type: 'error',\n        title: 'Erreur',\n        description: 'Une erreur est survenue lors de la génération de la convocation.',\n      })\n    }\n  }\n\n  const handleGenerateProgram = async () => {\n    if (!sessionData || !formation || !program || !organization) return\n\n    try {\n      const html = await generateProgramHTML({\n        program: { name: program.name },\n        formation: {\n          name: formation.name,\n          code: formation.code || undefined,\n        },\n        organization: {\n          name: organization.name,\n          address: organization.address || undefined,\n          phone: organization.phone || undefined,\n          email: organization.email || undefined,\n          logo_url: organization.logo_url || undefined,\n        },\n        issueDate: new Date().toISOString(),\n        language: 'fr',\n      })\n\n      const tempDiv = document.createElement('div')\n      tempDiv.innerHTML = html\n      tempDiv.style.position = 'absolute'\n      tempDiv.style.left = '-9999px'\n      document.body.appendChild(tempDiv)\n\n      const element = tempDiv.querySelector('[id$=\"-document\"]')\n      if (element) {\n        element.id = `temp-program-${Date.now()}`\n        await new Promise((resolve) => setTimeout(resolve, 500))\n        await generatePDFFromHTML(element.id, `programme_${program.name.replace(/\\s+/g, '_')}.pdf`)\n      }\n\n      document.body.removeChild(tempDiv)\n      addToast({\n        type: 'success',\n        title: 'Programme généré',\n        description: 'Le programme a été généré et téléchargé avec succès.',\n      })\n    } catch (error) {\n      logger.error('Erreur lors de la génération du programme', error as Error)\n      addToast({\n        type: 'error',\n        title: 'Erreur',\n        description: 'Une erreur est survenue lors de la génération du programme.',\n      })\n    }\n  }\n\n  const handleGenerateTerms = async () => {\n    if (!organization) return\n\n    try {\n      const html = await generateTermsHTML({\n        organization: {\n          name: organization.name,\n          address: organization.address || undefined,\n          phone: organization.phone || undefined,\n          email: organization.email || undefined,\n          logo_url: organization.logo_url || undefined,\n        },\n        issueDate: new Date().toISOString(),\n        language: 'fr',\n      })\n\n      const tempDiv = document.createElement('div')\n      tempDiv.innerHTML = html\n      tempDiv.style.position = 'absolute'\n      tempDiv.style.left = '-9999px'\n      document.body.appendChild(tempDiv)\n\n      const element = tempDiv.querySelector('[id$=\"-document\"]')\n      if (element) {\n        element.id = `temp-terms-${Date.now()}`\n        await new Promise((resolve) => setTimeout(resolve, 500))\n        await generatePDFFromHTML(element.id, `cgv_${organization.name.replace(/\\s+/g, '_')}.pdf`)\n      }\n\n      document.body.removeChild(tempDiv)\n      addToast({\n        type: 'success',\n        title: 'CGV générée',\n        description: 'Les conditions générales de vente ont été générées avec succès.',\n      })\n    } catch (error) {\n      logger.error('Erreur lors de la génération des CGV', error as Error)\n      addToast({\n        type: 'error',\n        title: 'Erreur',\n        description: 'Une erreur est survenue lors de la génération des CGV.',\n      })\n    }\n  }\n\n  const handleGeneratePrivacyPolicy = async () => {\n    if (!organization) return\n\n    try {\n      const html = await generatePrivacyPolicyHTML({\n        organization: {\n          name: organization.name,\n          address: organization.address || undefined,\n          phone: organization.phone || undefined,\n          email: organization.email || undefined,\n          logo_url: organization.logo_url || undefined,\n        },\n        issueDate: new Date().toISOString(),\n        language: 'fr',\n      })\n\n      const tempDiv = document.createElement('div')\n      tempDiv.innerHTML = html\n      tempDiv.style.position = 'absolute'\n      tempDiv.style.left = '-9999px'\n      document.body.appendChild(tempDiv)\n\n      const element = tempDiv.querySelector('[id$=\"-document\"]')\n      if (element) {\n        element.id = `temp-privacy-${Date.now()}`\n        await new Promise((resolve) => setTimeout(resolve, 500))\n        await generatePDFFromHTML(element.id, `politique_confidentialite_${organization.name.replace(/\\s+/g, '_')}.pdf`)\n      }\n\n      document.body.removeChild(tempDiv)\n      addToast({\n        type: 'success',\n        title: 'Politique générée',\n        description: 'La politique de confidentialité a été générée avec succès.',\n      })\n    } catch (error) {\n      logger.error('Erreur lors de la génération de la politique de confidentialité', error as Error)\n      addToast({\n        type: 'error',\n        title: 'Erreur',\n        description: 'Une erreur est survenue lors de la génération de la politique de confidentialité.',\n      })\n    }\n  }\n\n  const handleGenerateAllConventionsZip = async (enrollments: EnrollmentWithRelations[]) => {\n    if (!sessionData || !formation || !organization) return\n\n    setIsGeneratingZip(true)\n    setZipGenerationProgress({ current: 0, total: enrollments.length + 1 })\n\n    try {\n      const pdfBlobs: Array<{ name: string; blob: Blob }> = []\n\n      // Générer la convention générale\n      const conventionHTML = await generateConventionHTML({\n        session: {\n          name: sessionData.name,\n          start_date: sessionData.start_date,\n          end_date: sessionData.end_date,\n          location: sessionData.location || undefined,\n        },\n        formation: {\n          name: formation.name,\n          code: formation.code || undefined,\n          price: (formation as FormationWithRelations & { price?: number }).price || undefined,\n          duration_hours: (formation as FormationWithRelations & { duration_hours?: number }).duration_hours || undefined,\n        },\n        program: program ? { name: program.name } : undefined,\n        organization: {\n          name: organization.name,\n          address: organization.address || undefined,\n          phone: organization.phone || undefined,\n          email: organization.email || undefined,\n          logo_url: organization.logo_url || undefined,\n        },\n        issueDate: new Date().toISOString(),\n        language: 'fr',\n      })\n\n      const tempDiv = document.createElement('div')\n      tempDiv.innerHTML = conventionHTML\n      tempDiv.style.position = 'absolute'\n      tempDiv.style.left = '-9999px'\n      document.body.appendChild(tempDiv)\n\n      const conventionElement = tempDiv.querySelector('[id$=\"-document\"]')\n      if (conventionElement) {\n        conventionElement.id = `temp-convention-zip-${Date.now()}`\n        await new Promise((resolve) => setTimeout(resolve, 500))\n        const blob = await generatePDFBlobFromHTML(conventionElement.id)\n        pdfBlobs.push({ name: 'convention_generale.pdf', blob })\n      }\n\n      document.body.removeChild(tempDiv)\n      setZipGenerationProgress((prev) => ({ ...prev, current: prev.current + 1 }))\n\n      // Générer les contrats pour chaque inscription\n      for (const enrollment of enrollments) {\n        const student = enrollment.students\n        if (!student) continue\n\n        const contractHTML = await generateContractHTML({\n          student: {\n            first_name: student.first_name,\n            last_name: student.last_name,\n            email: student.email || undefined,\n            phone: student.phone || undefined,\n            address: student.address || undefined,\n            date_of_birth: student.date_of_birth || undefined,\n          },\n          session: {\n            name: sessionData.name,\n            start_date: sessionData.start_date,\n            end_date: sessionData.end_date,\n            location: sessionData.location || undefined,\n          },\n          formation: {\n            name: formation.name,\n            code: formation.code || undefined,\n            price: (formation as FormationWithRelations & { price?: number }).price || undefined,\n            duration_hours: (formation as FormationWithRelations & { duration_hours?: number }).duration_hours || undefined,\n          },\n          program: program ? { name: program.name } : undefined,\n          organization: {\n            name: organization.name,\n            address: organization.address || undefined,\n            phone: organization.phone || undefined,\n            email: organization.email || undefined,\n            logo_url: organization.logo_url || undefined,\n          },\n          enrollment: {\n            enrollment_date: enrollment.enrollment_date || '',\n            total_amount: enrollment.total_amount || 0,\n            paid_amount: enrollment.paid_amount || 0,\n          },\n          issueDate: new Date().toISOString(),\n          language: 'fr',\n        })\n\n        const contractDiv = document.createElement('div')\n        contractDiv.innerHTML = contractHTML\n        contractDiv.style.position = 'absolute'\n        contractDiv.style.left = '-9999px'\n        document.body.appendChild(contractDiv)\n\n        const contractElement = contractDiv.querySelector('[id$=\"-document\"]')\n        if (contractElement) {\n          contractElement.id = `temp-contract-zip-${Date.now()}-${enrollment.id}`\n          await new Promise((resolve) => setTimeout(resolve, 500))\n          const blob = await generatePDFBlobFromHTML(contractElement.id)\n          pdfBlobs.push({ name: `contrat_${student.last_name}_${student.first_name}.pdf`, blob })\n        }\n\n        document.body.removeChild(contractDiv)\n        setZipGenerationProgress((prev) => ({ ...prev, current: prev.current + 1 }))\n      }\n\n      // Créer le ZIP\n      await createZipFromPDFs(pdfBlobs, `conventions_contrats_${sessionData.name.replace(/\\s+/g, '_')}.zip`)\n      \n      setLastZipGeneration(new Date())\n      addToast({\n        type: 'success',\n        title: 'ZIP généré',\n        description: `Le fichier ZIP contenant ${pdfBlobs.length} document(s) a été généré avec succès.`,\n      })\n    } catch (error) {\n      logger.error('Erreur lors de la génération du ZIP', error as Error, {\n        type: 'conventions',\n        count: enrollments?.length || 0,\n      })\n      addToast({\n        type: 'error',\n        title: 'Erreur',\n        description: 'Une erreur est survenue lors de la génération du ZIP.',\n      })\n    } finally {\n      setIsGeneratingZip(false)\n      setZipGenerationProgress({ current: 0, total: 0 })\n    }\n  }\n\n  const handleGenerateAllConvocationsZip = async (enrollments: EnrollmentWithRelations[]) => {\n    if (!sessionData || !formation || !organization) return\n\n    setIsGeneratingZip(true)\n    setZipGenerationProgress({ current: 0, total: enrollments.length })\n\n    try {\n      const pdfBlobs: Array<{ name: string; blob: Blob }> = []\n\n      for (const enrollment of enrollments) {\n        const student = enrollment.students\n        if (!student) continue\n\n        const convocationHTML = await generateConvocationHTML({\n          student: {\n            first_name: student.first_name,\n            last_name: student.last_name,\n            email: student.email || undefined,\n            phone: student.phone || undefined,\n          },\n          session: {\n            name: sessionData.name,\n            start_date: sessionData.start_date,\n            end_date: sessionData.end_date,\n            start_time: sessionData.start_time || undefined,\n            end_time: sessionData.end_time || undefined,\n            location: sessionData.location || undefined,\n          },\n          formation: {\n            name: formation.name,\n            code: formation.code || undefined,\n          },\n          program: program ? { name: program.name } : undefined,\n          organization: {\n            name: organization.name,\n            address: organization.address || undefined,\n            phone: organization.phone || undefined,\n            email: organization.email || undefined,\n            logo_url: organization.logo_url || undefined,\n          },\n          issueDate: new Date().toISOString(),\n          language: 'fr',\n        })\n\n        const tempDiv = document.createElement('div')\n        tempDiv.innerHTML = convocationHTML\n        tempDiv.style.position = 'absolute'\n        tempDiv.style.left = '-9999px'\n        document.body.appendChild(tempDiv)\n\n        const element = tempDiv.querySelector('[id$=\"-document\"]')\n        if (element) {\n          element.id = `temp-convocation-zip-${Date.now()}-${enrollment.id}`\n          await new Promise((resolve) => setTimeout(resolve, 500))\n          const blob = await generatePDFBlobFromHTML(element.id)\n          pdfBlobs.push({ name: `convocation_${student.last_name}_${student.first_name}.pdf`, blob })\n        }\n\n        document.body.removeChild(tempDiv)\n        setZipGenerationProgress((prev) => ({ ...prev, current: prev.current + 1 }))\n      }\n\n      await createZipFromPDFs(pdfBlobs, `convocations_${sessionData.name.replace(/\\s+/g, '_')}.zip`)\n      \n      setLastZipGeneration(new Date())\n      addToast({\n        type: 'success',\n        title: 'ZIP généré',\n        description: `Le fichier ZIP contenant ${pdfBlobs.length} convocation(s) a été généré avec succès.`,\n      })\n    } catch (error) {\n      logger.error('Erreur lors de la génération du ZIP', error as Error, {\n        type: 'conventions',\n        count: enrollments?.length || 0,\n      })\n      addToast({\n        type: 'error',\n        title: 'Erreur',\n        description: 'Une erreur est survenue lors de la génération du ZIP.',\n      })\n    } finally {\n      setIsGeneratingZip(false)\n      setZipGenerationProgress({ current: 0, total: 0 })\n    }\n  }\n\n  // Placeholder functions pour les fonctionnalités à venir\n  const handleGenerateSessionReport = async () => {\n    addToast({\n      type: 'info',\n      title: 'Fonctionnalité à venir',\n      description: 'La génération du rapport de session sera implémentée prochainement.',\n    })\n  }\n\n  const handleGenerateCertificate = async (enrollment: EnrollmentWithRelations) => {\n    addToast({\n      type: 'info',\n      title: 'Fonctionnalité à venir',\n      description: 'La génération de certificat sera implémentée prochainement.',\n    })\n  }\n\n  // ==========================================\n  // FONCTIONS D'ENVOI PAR EMAIL\n  // ==========================================\n\n  /**\n   * Prépare les données d'email pour une convocation (sans envoyer)\n   */\n  const prepareConvocationEmail = (enrollment: EnrollmentWithRelations) => {\n    if (!sessionData || !formation || !organization || !enrollment) return null\n\n    const student = enrollment.students\n    if (!student || !student.email) return null\n\n    const emailSubject = `Convocation - ${sessionData.name}`\n    const emailBody = `\n      <p>Bonjour ${student.first_name} ${student.last_name},</p>\n      <p>Vous êtes convoqué(e) pour la session de formation suivante :</p>\n      <ul>\n        <li><strong>Formation :</strong> ${formation.name}</li>\n        <li><strong>Session :</strong> ${sessionData.name}</li>\n        <li><strong>Date de début :</strong> ${formatDate(sessionData.start_date)}</li>\n        <li><strong>Date de fin :</strong> ${formatDate(sessionData.end_date)}</li>\n        ${sessionData.location ? `<li><strong>Lieu :</strong> ${sessionData.location}</li>` : ''}\n      </ul>\n      <p>Veuillez trouver ci-joint votre convocation en PDF.</p>\n      <p>Cordialement,<br>${organization.name}</p>\n    `\n\n    return {\n      to: student.email,\n      subject: emailSubject,\n      body: emailBody,\n      studentName: `${student.first_name} ${student.last_name}`,\n      enrollment,\n    }\n  }\n\n  /**\n   * Envoie une convocation par email avec contenu personnalisé\n   */\n  const handleSendConvocationByEmailWithCustomContent = async (\n    enrollment: EnrollmentWithRelations,\n    customSubject: string,\n    customBody: string\n  ) => {\n    if (!sessionData || !formation || !organization || !enrollment) return\n\n    const student = enrollment.students\n    if (!student) {\n      addToast({\n        type: 'error',\n        title: 'Erreur',\n        description: 'Données étudiant manquantes.',\n      })\n      return\n    }\n\n    try {\n      // Générer le HTML de la convocation\n      const html = await generateConvocationHTML({\n        student: {\n          first_name: student.first_name,\n          last_name: student.last_name,\n          email: student.email || undefined,\n          phone: student.phone || undefined,\n        },\n        session: {\n          name: sessionData.name,\n          start_date: sessionData.start_date,\n          end_date: sessionData.end_date,\n          start_time: sessionData.start_time || undefined,\n          end_time: sessionData.end_time || undefined,\n          location: sessionData.location || undefined,\n        },\n        formation: {\n          name: formation.name,\n          code: formation.code || undefined,\n        },\n        program: program ? { name: program.name } : undefined,\n        organization: {\n          name: organization.name,\n          address: organization.address || undefined,\n          phone: organization.phone || undefined,\n          email: organization.email || undefined,\n          logo_url: organization.logo_url || undefined,\n        },\n        issueDate: new Date().toISOString(),\n        language: 'fr',\n      })\n\n      // Créer un élément temporaire pour générer le PDF\n      const tempDiv = document.createElement('div')\n      tempDiv.innerHTML = html\n      tempDiv.style.position = 'absolute'\n      tempDiv.style.left = '-9999px'\n      document.body.appendChild(tempDiv)\n\n      const element = tempDiv.querySelector('[id$=\"-document\"]')\n      if (!element) {\n        document.body.removeChild(tempDiv)\n        throw new Error('Élément de document non trouvé')\n      }\n\n      element.id = `temp-convocation-email-${Date.now()}`\n      await new Promise((resolve) => setTimeout(resolve, 500))\n\n      // Générer le PDF en Blob\n      const pdfBlob = await generatePDFBlobFromHTML(element.id)\n      document.body.removeChild(tempDiv)\n\n      // Convertir le texte en HTML si nécessaire (ajouter des retours à la ligne)\n      const emailBodyHTML = customBody.replace(/\\n/g, '<br>')\n\n      // Envoyer l'email avec le contenu personnalisé\n      await emailService.sendDocument(\n        student.email || '',\n        customSubject,\n        pdfBlob,\n        `convocation_${student.last_name}_${student.first_name}.pdf`,\n        emailBodyHTML\n      )\n\n      addToast({\n        type: 'success',\n        title: 'Email envoyé',\n        description: `La convocation a été envoyée à ${student.email || 'l\\'adresse spécifiée'}.`,\n      })\n    } catch (error) {\n      logger.error('Erreur lors de l\\'envoi de la convocation par email', error as Error, {\n        enrollmentId: enrollment.id,\n      })\n      addToast({\n        type: 'error',\n        title: 'Erreur',\n        description: 'Une erreur est survenue lors de l\\'envoi de l\\'email.',\n      })\n    }\n  }\n\n  /**\n   * Envoie une convocation par email à un étudiant\n   */\n  const handleSendConvocationByEmail = async (enrollment: EnrollmentWithRelations) => {\n    if (!sessionData || !formation || !organization || !enrollment) return\n\n    const student = enrollment.students\n    if (!student || !student.email) {\n      addToast({\n        type: 'error',\n        title: 'Erreur',\n        description: 'L\\'étudiant n\\'a pas d\\'adresse email.',\n      })\n      return\n    }\n\n    try {\n      // Générer le HTML de la convocation\n      const html = await generateConvocationHTML({\n        student: {\n          first_name: student.first_name,\n          last_name: student.last_name,\n          email: student.email || undefined,\n          phone: student.phone || undefined,\n        },\n        session: {\n          name: sessionData.name,\n          start_date: sessionData.start_date,\n          end_date: sessionData.end_date,\n          start_time: sessionData.start_time || undefined,\n          end_time: sessionData.end_time || undefined,\n          location: sessionData.location || undefined,\n        },\n        formation: {\n          name: formation.name,\n          code: formation.code || undefined,\n        },\n        program: program ? { name: program.name } : undefined,\n        organization: {\n          name: organization.name,\n          address: organization.address || undefined,\n          phone: organization.phone || undefined,\n          email: organization.email || undefined,\n          logo_url: organization.logo_url || undefined,\n        },\n        issueDate: new Date().toISOString(),\n        language: 'fr',\n      })\n\n      // Créer un élément temporaire pour générer le PDF\n      const tempDiv = document.createElement('div')\n      tempDiv.innerHTML = html\n      tempDiv.style.position = 'absolute'\n      tempDiv.style.left = '-9999px'\n      document.body.appendChild(tempDiv)\n\n      const element = tempDiv.querySelector('[id$=\"-document\"]')\n      if (!element) {\n        document.body.removeChild(tempDiv)\n        throw new Error('Élément de document non trouvé')\n      }\n\n      element.id = `temp-convocation-email-${Date.now()}`\n      await new Promise((resolve) => setTimeout(resolve, 500))\n\n      // Générer le PDF en Blob\n      const pdfBlob = await generatePDFBlobFromHTML(element.id)\n      document.body.removeChild(tempDiv)\n\n      // Créer le corps de l'email\n      const emailSubject = `Convocation - ${sessionData.name}`\n      const emailBody = `\n        <p>Bonjour ${student.first_name} ${student.last_name},</p>\n        <p>Vous êtes convoqué(e) pour la session de formation suivante :</p>\n        <ul>\n          <li><strong>Formation :</strong> ${formation.name}</li>\n          <li><strong>Session :</strong> ${sessionData.name}</li>\n          <li><strong>Date de début :</strong> ${formatDate(sessionData.start_date)}</li>\n          <li><strong>Date de fin :</strong> ${formatDate(sessionData.end_date)}</li>\n          ${sessionData.location ? `<li><strong>Lieu :</strong> ${sessionData.location}</li>` : ''}\n        </ul>\n        <p>Veuillez trouver ci-joint votre convocation en PDF.</p>\n        <p>Cordialement,<br>${organization.name}</p>\n      `\n\n      // Envoyer l'email\n      await emailService.sendDocument(\n        student.email,\n        emailSubject,\n        pdfBlob,\n        `convocation_${student.last_name}_${student.first_name}.pdf`,\n        emailBody\n      )\n\n      addToast({\n        type: 'success',\n        title: 'Email envoyé',\n        description: `La convocation a été envoyée à ${student.email}.`,\n      })\n    } catch (error) {\n      logger.error('Erreur lors de l\\'envoi de la convocation par email', error as Error, {\n        enrollmentId: enrollment.id,\n        studentId: enrollment.student_id,\n      })\n      addToast({\n        type: 'error',\n        title: 'Erreur',\n        description: 'Une erreur est survenue lors de l\\'envoi de l\\'email.',\n      })\n    }\n  }\n\n  /**\n   * Envoie toutes les convocations par email (groupé)\n   */\n  const handleSendAllConvocationsByEmail = async (enrollments: EnrollmentWithRelations[]) => {\n    if (!sessionData || !formation || !organization) return\n\n    const validEnrollments = enrollments.filter(\n      (e) => e.students && e.students.email && e.status !== 'cancelled'\n    )\n\n    if (validEnrollments.length === 0) {\n      addToast({\n        type: 'error',\n        title: 'Erreur',\n        description: 'Aucun étudiant avec une adresse email valide trouvé.',\n      })\n      return\n    }\n\n    setIsGeneratingZip(true)\n    setZipGenerationProgress({ current: 0, total: validEnrollments.length })\n\n    try {\n      let successCount = 0\n      let errorCount = 0\n\n      for (const enrollment of validEnrollments) {\n        try {\n          await handleSendConvocationByEmail(enrollment)\n          successCount++\n        } catch (error) {\n          errorCount++\n          logger.error('Erreur lors de l\\'envoi de la convocation', error as Error, {\n            enrollmentId: enrollment.id,\n          })\n        }\n        setZipGenerationProgress((prev) => ({ ...prev, current: prev.current + 1 }))\n      }\n\n      addToast({\n        type: successCount > 0 ? 'success' : 'error',\n        title: 'Envoi terminé',\n        description: `${successCount} email(s) envoyé(s) avec succès${errorCount > 0 ? `, ${errorCount} erreur(s)` : ''}.`,\n      })\n    } catch (error) {\n      logger.error('Erreur lors de l\\'envoi groupé des convocations', error as Error)\n      addToast({\n        type: 'error',\n        title: 'Erreur',\n        description: 'Une erreur est survenue lors de l\\'envoi groupé.',\n      })\n    } finally {\n      setIsGeneratingZip(false)\n      setZipGenerationProgress({ current: 0, total: 0 })\n    }\n  }\n\n  /**\n   * Prépare les données d'email pour un contrat (sans envoyer)\n   */\n  const prepareContractEmail = (enrollment: EnrollmentWithRelations) => {\n    if (!sessionData || !formation || !organization || !enrollment) return null\n\n    const student = enrollment.students\n    if (!student || !student.email) return null\n\n    const emailSubject = `Contrat de formation - ${formation.name}`\n    const emailBody = `\n      <p>Bonjour ${student.first_name} ${student.last_name},</p>\n      <p>Veuillez trouver ci-joint votre contrat de formation pour la session \"${sessionData.name}\".</p>\n      <p>Cordialement,<br>${organization.name}</p>\n    `\n\n    return {\n      to: student.email,\n      subject: emailSubject,\n      body: emailBody,\n      studentName: `${student.first_name} ${student.last_name}`,\n      enrollment,\n    }\n  }\n\n  /**\n   * Envoie un contrat par email avec contenu personnalisé\n   */\n  const handleSendContractByEmailWithCustomContent = async (\n    enrollment: EnrollmentWithRelations,\n    customSubject: string,\n    customBody: string\n  ) => {\n    if (!sessionData || !formation || !organization || !enrollment) return\n\n    const student = enrollment.students\n    if (!student) {\n      addToast({\n        type: 'error',\n        title: 'Erreur',\n        description: 'Données étudiant manquantes.',\n      })\n      return\n    }\n\n    try {\n      const html = await generateContractHTML({\n        student: {\n          first_name: student.first_name,\n          last_name: student.last_name,\n          email: student.email || undefined,\n          phone: student.phone || undefined,\n          address: student.address || undefined,\n          date_of_birth: student.date_of_birth || undefined,\n        },\n        session: {\n          name: sessionData.name,\n          start_date: sessionData.start_date,\n          end_date: sessionData.end_date,\n          location: sessionData.location || undefined,\n        },\n        formation: {\n          name: formation.name,\n          code: formation.code || undefined,\n          price: (formation as FormationWithRelations & { price?: number }).price || undefined,\n          duration_hours: (formation as FormationWithRelations & { duration_hours?: number }).duration_hours || undefined,\n        },\n        program: program ? { name: program.name } : undefined,\n        organization: {\n          name: organization.name,\n          address: organization.address || undefined,\n          phone: organization.phone || undefined,\n          email: organization.email || undefined,\n          logo_url: organization.logo_url || undefined,\n        },\n        enrollment: {\n          enrollment_date: enrollment.enrollment_date || '',\n          total_amount: enrollment.total_amount || 0,\n          paid_amount: enrollment.paid_amount || 0,\n        },\n        issueDate: new Date().toISOString(),\n        language: 'fr',\n      })\n\n      const tempDiv = document.createElement('div')\n      tempDiv.innerHTML = html\n      tempDiv.style.position = 'absolute'\n      tempDiv.style.left = '-9999px'\n      document.body.appendChild(tempDiv)\n\n      const element = tempDiv.querySelector('[id$=\"-document\"]')\n      if (!element) {\n        document.body.removeChild(tempDiv)\n        throw new Error('Élément de document non trouvé')\n      }\n\n      element.id = `temp-contract-email-${Date.now()}`\n      await new Promise((resolve) => setTimeout(resolve, 500))\n\n      const pdfBlob = await generatePDFBlobFromHTML(element.id)\n      document.body.removeChild(tempDiv)\n\n      // Convertir le texte en HTML si nécessaire\n      const emailBodyHTML = customBody.replace(/\\n/g, '<br>')\n\n      await emailService.sendDocument(\n        student.email || '',\n        customSubject,\n        pdfBlob,\n        `contrat_${student.last_name}_${student.first_name}.pdf`,\n        emailBodyHTML\n      )\n\n      addToast({\n        type: 'success',\n        title: 'Email envoyé',\n        description: `Le contrat a été envoyé à ${student.email || 'l\\'adresse spécifiée'}.`,\n      })\n    } catch (error) {\n      logger.error('Erreur lors de l\\'envoi du contrat par email', error as Error, {\n        enrollmentId: enrollment.id,\n      })\n      addToast({\n        type: 'error',\n        title: 'Erreur',\n        description: 'Une erreur est survenue lors de l\\'envoi de l\\'email.',\n      })\n    }\n  }\n\n  /**\n   * Envoie un contrat par email\n   */\n  const handleSendContractByEmail = async (enrollment: EnrollmentWithRelations) => {\n    if (!sessionData || !formation || !organization || !enrollment) return\n\n    const student = enrollment.students\n    if (!student || !student.email) {\n      addToast({\n        type: 'error',\n        title: 'Erreur',\n        description: 'L\\'étudiant n\\'a pas d\\'adresse email.',\n      })\n      return\n    }\n\n    try {\n      const html = await generateContractHTML({\n        student: {\n          first_name: student.first_name,\n          last_name: student.last_name,\n          email: student.email || undefined,\n          phone: student.phone || undefined,\n          address: student.address || undefined,\n          date_of_birth: student.date_of_birth || undefined,\n        },\n        session: {\n          name: sessionData.name,\n          start_date: sessionData.start_date,\n          end_date: sessionData.end_date,\n          location: sessionData.location || undefined,\n        },\n        formation: {\n          name: formation.name,\n          code: formation.code || undefined,\n          price: (formation as FormationWithRelations & { price?: number }).price || undefined,\n          duration_hours: (formation as FormationWithRelations & { duration_hours?: number }).duration_hours || undefined,\n        },\n        program: program ? { name: program.name } : undefined,\n        organization: {\n          name: organization.name,\n          address: organization.address || undefined,\n          phone: organization.phone || undefined,\n          email: organization.email || undefined,\n          logo_url: organization.logo_url || undefined,\n        },\n        enrollment: {\n          enrollment_date: enrollment.enrollment_date || '',\n          total_amount: enrollment.total_amount || 0,\n          paid_amount: enrollment.paid_amount || 0,\n        },\n        issueDate: new Date().toISOString(),\n        language: 'fr',\n      })\n\n      const tempDiv = document.createElement('div')\n      tempDiv.innerHTML = html\n      tempDiv.style.position = 'absolute'\n      tempDiv.style.left = '-9999px'\n      document.body.appendChild(tempDiv)\n\n      const element = tempDiv.querySelector('[id$=\"-document\"]')\n      if (!element) {\n        document.body.removeChild(tempDiv)\n        throw new Error('Élément de document non trouvé')\n      }\n\n      element.id = `temp-contract-email-${Date.now()}`\n      await new Promise((resolve) => setTimeout(resolve, 500))\n\n      const pdfBlob = await generatePDFBlobFromHTML(element.id)\n      document.body.removeChild(tempDiv)\n\n      const emailSubject = `Contrat de formation - ${formation.name}`\n      const emailBody = `\n        <p>Bonjour ${student.first_name} ${student.last_name},</p>\n        <p>Veuillez trouver ci-joint votre contrat de formation pour la session \"${sessionData.name}\".</p>\n        <p>Cordialement,<br>${organization.name}</p>\n      `\n\n      await emailService.sendDocument(\n        student.email,\n        emailSubject,\n        pdfBlob,\n        `contrat_${student.last_name}_${student.first_name}.pdf`,\n        emailBody\n      )\n\n      addToast({\n        type: 'success',\n        title: 'Email envoyé',\n        description: `Le contrat a été envoyé à ${student.email}.`,\n      })\n    } catch (error) {\n      logger.error('Erreur lors de l\\'envoi du contrat par email', error as Error, {\n        enrollmentId: enrollment.id,\n      })\n      addToast({\n        type: 'error',\n        title: 'Erreur',\n        description: 'Une erreur est survenue lors de l\\'envoi de l\\'email.',\n      })\n    }\n  }\n\n  return {\n    isGeneratingZip,\n    zipGenerationProgress,\n    lastZipGeneration,\n    handleGenerateConvention,\n    handleGenerateContract,\n    handleGenerateConvocation,\n    handleGenerateProgram,\n    handleGenerateTerms,\n    handleGeneratePrivacyPolicy,\n    handleGenerateAllConventionsZip,\n    handleGenerateAllConvocationsZip,\n    handleGenerateSessionReport,\n    handleGenerateCertificate,\n    handleSendConvocationByEmail,\n    handleSendConvocationByEmailWithCustomContent,\n    handleSendAllConvocationsByEmail,\n    handleSendContractByEmail,\n    handleSendContractByEmailWithCustomContent,\n    prepareConvocationEmail,\n    prepareContractEmail,\n  }\n}\n\n","import { formatDateForDocument } from './pdf-generator'\nimport { formatCurrency } from '../utils'\nimport { generateHTML } from './document-generation/html-generator'\nimport type { DocumentTemplate, DocumentVariables } from '@/lib/types/document-templates'\n\n/**\n * Génère le template avec balises {variable} pour une attestation de scolarité\n * Cette fonction retourne un template avec balises qui doit être traité avec processTemplateWithTags\n */\nfunction generateAttestationTemplate(data: {\n  student: {\n    first_name: string\n    last_name: string\n    student_number: string\n    date_of_birth?: string\n    photo_url?: string\n  }\n  organization: {\n    name: string\n    address?: string\n    phone?: string\n    email?: string\n    logo_url?: string\n  }\n  class?: {\n    name: string\n  }\n  academicYear: string\n  issueDate: string\n  language?: 'fr' | 'en'\n}) {\n  const lang = data.language || 'fr'\n  const texts = {\n    fr: {\n      title: 'ATTESTATION DE SCOLARITÉ',\n      certifies: 'Je soussigné(e), Directeur(trice) de',\n      certifiesThat: 'certifie que',\n      isEnrolled: 'est régulièrement inscrit(e) en qualité d\\'élève',\n      inClass: 'dans la classe',\n      academicYear: 'pour l\\'année scolaire',\n      date: 'Fait à',\n      on: 'le',\n      signature: 'Signature et cachet',\n    },\n    en: {\n      title: 'SCHOOL ATTENDANCE CERTIFICATE',\n      certifies: 'I, the undersigned, Director of',\n      certifiesThat: 'certify that',\n      isEnrolled: 'is duly enrolled as a student',\n      inClass: 'in class',\n      academicYear: 'for the academic year',\n      date: 'Done at',\n      on: 'on',\n      signature: 'Signature and stamp',\n    },\n  }\n\n  const t = texts[lang]\n\n  // Retourner un template avec balises {variable} au lieu de template literals\n  return `\n    <div id=\"attestation-document\" style=\"max-width: 210mm; margin: 0 auto; padding: 20mm; font-family: Arial, sans-serif; color: #000;\">\n      {organization_logo && <div style=\"text-align: center; margin-bottom: 20px;\">\n        <img src=\"{organization_logo}\" alt=\"Logo\" style=\"max-height: 80px;\" />\n      </div>}\n      \n      <h1 style=\"text-align: center; font-size: 24px; font-weight: bold; margin-bottom: 30px; text-transform: uppercase;\">\n        {title}\n      </h1>\n      \n      <div style=\"line-height: 1.8; font-size: 14px; margin-bottom: 30px;\">\n        <p>{certifies} <strong>{organization_name}</strong>,</p>\n        <p style=\"margin-top: 20px; text-indent: 30px;\">\n          {certifies_that} <strong>{student_first_name} {student_last_name}</strong>,\n          {IF student_date_of_birth}né(e) le {student_date_of_birth},{ENDIF}\n          {is_enrolled} {IF class_name}{in_class} <strong>{class_name}</strong> {ENDIF}\n          {academic_year} <strong>{academic_year}</strong>.\n        </p>\n      </div>\n      \n      <div style=\"margin-top: 50px; margin-bottom: 30px;\">\n        <p>{date} <strong>{organization_address}</strong>, {on} <strong>{issue_date}</strong></p>\n      </div>\n      \n      <div style=\"margin-top: 60px; text-align: right;\">\n        <p style=\"margin-bottom: 50px;\">{signature}</p>\n        <p>_________________________</p>\n        <p style=\"margin-top: 5px; font-size: 12px;\">Directeur(trice)</p>\n      </div>\n    </div>\n  `\n}\n\n/**\n * Génère le HTML final pour une attestation de scolarité en utilisant les balises {variable}\n * Cette fonction convertit les données en variables et traite le template avec le système de génération HTML avancé\n */\nexport async function generateAttestationHTML(data: {\n  student: {\n    first_name: string\n    last_name: string\n    student_number: string\n    date_of_birth?: string\n    photo_url?: string\n  }\n  organization: {\n    name: string\n    address?: string\n    phone?: string\n    email?: string\n    logo_url?: string\n  }\n  class?: {\n    name: string\n  }\n  academicYear: string\n  issueDate: string\n  language?: 'fr' | 'en'\n  documentId?: string\n  organizationId?: string\n}): Promise<string> {\n  const lang = data.language || 'fr'\n  const texts = {\n    fr: {\n      title: 'ATTESTATION DE SCOLARITÉ',\n      certifies: 'Je soussigné(e), Directeur(trice) de',\n      certifiesThat: 'certifie que',\n      isEnrolled: 'est régulièrement inscrit(e) en qualité d\\'élève',\n      inClass: 'dans la classe',\n      academicYear: 'pour l\\'année scolaire',\n      date: 'Fait à',\n      on: 'le',\n      signature: 'Signature et cachet',\n    },\n    en: {\n      title: 'SCHOOL ATTENDANCE CERTIFICATE',\n      certifies: 'I, the undersigned, Director of',\n      certifiesThat: 'certify that',\n      isEnrolled: 'is duly enrolled as a student',\n      inClass: 'in class',\n      academicYear: 'for the academic year',\n      date: 'Done at',\n      on: 'on',\n      signature: 'Signature and stamp',\n    },\n  }\n\n  const t = texts[lang]\n  \n  // Générer le template avec balises\n  const template = generateAttestationTemplate(data)\n  \n  // Préparer les variables pour le système de balises\n  const variables: any = {\n    organisation_logo: data.organization.logo_url || '',\n    title: t.title,\n    certifies: t.certifies,\n    organization_name: data.organization.name,\n    certifies_that: t.certifiesThat,\n    student_first_name: data.student.first_name,\n    student_last_name: data.student.last_name,\n    student_date_of_birth: data.student.date_of_birth ? formatDateForDocument(data.student.date_of_birth) : '',\n    is_enrolled: t.isEnrolled,\n    class_name: data.class?.name || '',\n    in_class: t.inClass,\n    academic_year: data.academicYear,\n    date: t.date,\n    organization_address: data.organization.address || '',\n    on: t.on,\n    issue_date: formatDateForDocument(data.issueDate),\n    signature: t.signature,\n  }\n  \n  // Traiter le template avec le système de génération HTML\n  return await processTemplateWithTags(template, variables, data.documentId, data.organizationId)\n}\n\n/**\n * Génère le template avec balises {variable} pour un certificat de formation\n */\nfunction generateCertificateTemplate(data: {\n  student: {\n    first_name: string\n    last_name: string\n    student_number: string\n  }\n  organization: {\n    name: string\n    address?: string\n    logo_url?: string\n  }\n  program: {\n    name: string\n    duration_hours?: number\n  }\n  session: {\n    name: string\n    start_date: string\n    end_date: string\n  }\n  issueDate: string\n  language?: 'fr' | 'en'\n}): string {\n  // Retourner un template avec balises {variable}\n  return `\n    <div id=\"certificate-document\" style=\"max-width: 210mm; margin: 0 auto; padding: 20mm; font-family: Arial, sans-serif; color: #000; border: 5px solid #2563EB; min-height: 297mm;\">\n      {organization_logo && <div style=\"text-align: center; margin-bottom: 30px;\">\n        <img src=\"{organization_logo}\" alt=\"Logo\" style=\"max-height: 100px;\" />\n      </div>}\n      \n      <h1 style=\"text-align: center; font-size: 32px; font-weight: bold; margin-bottom: 50px; text-transform: uppercase; color: #2563EB;\">\n        {title}\n      </h1>\n      \n      <div style=\"text-align: center; line-height: 2; font-size: 16px; margin: 60px 0;\">\n        <p style=\"font-size: 18px; margin-bottom: 30px;\">\n          {certifies}\n        </p>\n        <p style=\"font-size: 24px; font-weight: bold; margin: 30px 0;\">\n          {student_first_name_upper}<br />\n          {student_last_name_upper}\n        </p>\n        <p style=\"margin-top: 40px;\">\n          {has_completed}\n        </p>\n        <p style=\"font-size: 20px; font-weight: bold; margin: 20px 0; color: #2563EB;\">\n          \"{program_name}\"\n        </p>\n        {IF program_duration_hours}<p style=\"margin-top: 20px;\">\n          {duration} <strong>{program_duration_hours}</strong> {hours}\n        </p>{ENDIF}\n        <p style=\"margin-top: 20px;\">\n          {during} <strong>{session_name}</strong><br />\n          {session_start_date} - {session_end_date}\n        </p>\n      </div>\n      \n      <div style=\"margin-top: 80px; text-align: center;\">\n        <p style=\"margin-bottom: 50px;\">{date} <strong>{organization_address}</strong>, {on} <strong>{issue_date}</strong></p>\n        <div style=\"margin-top: 60px;\">\n          <p>{signature}</p>\n          <p style=\"margin-top: 50px;\">_________________________</p>\n          <p style=\"margin-top: 5px; font-size: 12px;\">Directeur(trice)</p>\n        </div>\n      </div>\n    </div>\n  `\n}\n\n/**\n * Génère le HTML final pour un certificat de formation en utilisant les balises {variable}\n */\nexport async function generateCertificateHTML(data: {\n  student: {\n    first_name: string\n    last_name: string\n    student_number: string\n  }\n  organization: {\n    name: string\n    address?: string\n    logo_url?: string\n  }\n  program: {\n    name: string\n    duration_hours?: number\n  }\n  session: {\n    name: string\n    start_date: string\n    end_date: string\n  }\n  issueDate: string\n  language?: 'fr' | 'en'\n  documentId?: string\n  organizationId?: string\n}): Promise<string> {\n  const lang = data.language || 'fr'\n  const texts = {\n    fr: {\n      title: 'CERTIFICAT DE FORMATION',\n      certifies: 'certifie que',\n      hasCompleted: 'a suivi avec succès la formation',\n      duration: 'd\\'une durée de',\n      hours: 'heures',\n      during: 'pendant la session',\n      date: 'Fait à',\n      on: 'le',\n      signature: 'Signature et cachet',\n    },\n    en: {\n      title: 'TRAINING CERTIFICATE',\n      certifies: 'certifies that',\n      hasCompleted: 'has successfully completed the training',\n      duration: 'with a duration of',\n      hours: 'hours',\n      during: 'during the session',\n      date: 'Done at',\n      on: 'on',\n      signature: 'Signature and stamp',\n    },\n  }\n\n  const t = texts[lang]\n\n  // Générer le template avec balises\n  const template = generateCertificateTemplate(data)\n  \n  // Préparer les variables pour le système de balises\n  const variables: any = {\n    organisation_logo: data.organization.logo_url || '',\n    title: t.title,\n    certifies: t.certifies,\n    student_first_name_upper: data.student.first_name.toUpperCase(),\n    student_last_name_upper: data.student.last_name.toUpperCase(),\n    has_completed: t.hasCompleted,\n    program_name: data.program.name,\n    program_duration_hours: data.program.duration_hours || 0,\n    duration: t.duration,\n    hours: t.hours,\n    during: t.during,\n    session_name: data.session.name,\n    session_start_date: formatDateForDocument(data.session.start_date),\n    session_end_date: formatDateForDocument(data.session.end_date),\n    date: t.date,\n    organization_address: data.organization.address || '',\n    on: t.on,\n    issue_date: formatDateForDocument(data.issueDate),\n    signature: t.signature,\n  }\n  \n  // Traiter le template avec le système de génération HTML\n  return await processTemplateWithTags(template, variables, data.documentId, data.organizationId)\n}\n\n/**\n * Génère le template avec balises {variable} pour une facture\n */\nfunction generateInvoiceTemplate(data: {\n  invoice: {\n    invoice_number: string\n    issue_date: string\n    due_date: string\n    amount: number\n    tax_amount: number\n    total_amount: number\n    currency: string\n    items?: Array<{ description: string; quantity: number; unit_price: number; total: number }>\n  }\n  student: {\n    first_name: string\n    last_name: string\n    student_number: string\n    address?: string\n  }\n  organization: {\n    name: string\n    address?: string\n    phone?: string\n    email?: string\n    logo_url?: string\n  }\n  language?: 'fr' | 'en'\n}): string {\n  return `\n    <div id=\"invoice-document\" style=\"max-width: 210mm; margin: 0 auto; padding: 20mm; font-family: Arial, sans-serif; color: #000;\">\n      {organization_logo && <div style=\"text-align: right; margin-bottom: 30px;\">\n        <img src=\"{organization_logo}\" alt=\"Logo\" style=\"max-height: 60px;\" />\n      </div>}\n      \n      <div style=\"display: flex; justify-content: space-between; margin-bottom: 40px;\">\n        <div>\n          <h1 style=\"font-size: 28px; font-weight: bold; margin-bottom: 10px;\">{title}</h1>\n          <p><strong>{organization_name}</strong></p>\n          {IF organization_address}<p>{organization_address}</p>{ENDIF}\n          {IF organization_phone}<p>Tél: {organization_phone}</p>{ENDIF}\n          {IF organization_email}<p>Email: {organization_email}</p>{ENDIF}\n        </div>\n        <div style=\"text-align: right;\">\n          <p><strong>{invoice_number_label}:</strong> {invoice_number}</p>\n          <p><strong>{issue_date_label}:</strong> {issue_date}</p>\n          <p><strong>{due_date_label}:</strong> {due_date}</p>\n        </div>\n      </div>\n      \n      <div style=\"margin-bottom: 30px;\">\n        <p><strong>{bill_to}:</strong></p>\n        <p>{student_first_name} {student_last_name}</p>\n        <p>N° étudiant: {student_number}</p>\n        {IF student_address}<p>{student_address}</p>{ENDIF}\n      </div>\n      \n      <table style=\"width: 100%; border-collapse: collapse; margin-bottom: 30px;\">\n        <thead>\n          <tr style=\"background-color: #f3f4f6;\">\n            <th style=\"padding: 12px; text-align: left; border: 1px solid #ddd;\">{description_label}</th>\n            <th style=\"padding: 12px; text-align: center; border: 1px solid #ddd;\">{quantity_label}</th>\n            <th style=\"padding: 12px; text-align: right; border: 1px solid #ddd;\">{unit_price_label}</th>\n            <th style=\"padding: 12px; text-align: right; border: 1px solid #ddd;\">{total_label}</th>\n          </tr>\n        </thead>\n        <tbody>\n          {invoice_items_html}\n        </tbody>\n      </table>\n      \n      <div style=\"margin-left: auto; width: 300px; margin-bottom: 30px;\">\n        <div style=\"display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #ddd;\">\n          <span>{subtotal_label}:</span>\n          <span><strong>{subtotal_amount}</strong></span>\n        </div>\n        {IF tax_amount}<div style=\"display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #ddd;\">\n          <span>{tax_label}:</span>\n          <span><strong>{tax_amount_formatted}</strong></span>\n        </div>{ENDIF}\n        <div style=\"display: flex; justify-content: space-between; padding: 12px 0; background-color: #f3f4f6; font-size: 18px; font-weight: bold;\">\n          <span>{total_amount_label}:</span>\n          <span>{total_amount_formatted}</span>\n        </div>\n      </div>\n    </div>\n  `\n}\n\n/**\n * Génère le HTML final pour une facture en utilisant les balises {variable}\n */\nexport async function generateInvoiceHTML(data: {\n  invoice: {\n    invoice_number: string\n    issue_date: string\n    due_date: string\n    amount: number\n    tax_amount: number\n    total_amount: number\n    currency: string\n    items?: Array<{ description: string; quantity: number; unit_price: number; total: number }>\n  }\n  student: {\n    first_name: string\n    last_name: string\n    student_number: string\n    address?: string\n  }\n  organization: {\n    name: string\n    address?: string\n    phone?: string\n    email?: string\n    logo_url?: string\n  }\n  language?: 'fr' | 'en'\n  documentId?: string\n  organizationId?: string\n}): Promise<string> {\n  const lang = data.language || 'fr'\n  const texts = {\n    fr: {\n      title: 'FACTURE',\n      invoiceNumber: 'Facture N°',\n      issueDate: 'Date d\\'émission',\n      dueDate: 'Date d\\'échéance',\n      billTo: 'Facturé à',\n      description: 'Description',\n      quantity: 'Qté',\n      unitPrice: 'Prix unitaire',\n      total: 'Total',\n      subtotal: 'Sous-total',\n      tax: 'TVA',\n      totalAmount: 'TOTAL',\n      language: 'fr',\n    },\n    en: {\n      title: 'INVOICE',\n      invoiceNumber: 'Invoice N°',\n      issueDate: 'Issue date',\n      dueDate: 'Due date',\n      billTo: 'Bill to',\n      description: 'Description',\n      quantity: 'Qty',\n      unitPrice: 'Unit price',\n      total: 'Total',\n      subtotal: 'Subtotal',\n      tax: 'Tax',\n      totalAmount: 'TOTAL',\n      language: 'en',\n    },\n  }\n\n  const t = texts[lang]\n\n  // Formater les items de la facture en HTML\n  let invoiceItemsHTML = ''\n  if (data.invoice.items && data.invoice.items.length > 0) {\n    invoiceItemsHTML = data.invoice.items.map(\n                (item) => `\n                  <tr>\n                    <td style=\"padding: 12px; border: 1px solid #ddd;\">${item.description}</td>\n                    <td style=\"padding: 12px; text-align: center; border: 1px solid #ddd;\">${item.quantity}</td>\n                    <td style=\"padding: 12px; text-align: right; border: 1px solid #ddd;\">${formatCurrency(item.unit_price, data.invoice.currency)}</td>\n                    <td style=\"padding: 12px; text-align: right; border: 1px solid #ddd;\">${formatCurrency(item.total, data.invoice.currency)}</td>\n                  </tr>\n                `\n              ).join('')\n  } else {\n    invoiceItemsHTML = `\n                <tr>\n                  <td style=\"padding: 12px; border: 1px solid #ddd;\" colspan=\"4\">Scolarité</td>\n                  <td style=\"padding: 12px; text-align: right; border: 1px solid #ddd;\">${formatCurrency(data.invoice.amount, data.invoice.currency)}</td>\n                </tr>\n    `\n  }\n  \n  // Générer le template avec balises\n  const template = generateInvoiceTemplate(data)\n  \n  // Préparer les variables pour le système de balises\n  const variables: any = {\n    organisation_logo: data.organization.logo_url || '',\n    title: t.title,\n    organization_name: data.organization.name,\n    organization_address: data.organization.address || '',\n    organization_phone: data.organization.phone || '',\n    organization_email: data.organization.email || '',\n    invoice_number_label: t.invoiceNumber,\n    invoice_number: data.invoice.invoice_number,\n    issue_date_label: t.issueDate,\n    issue_date: formatDateForDocument(data.invoice.issue_date),\n    due_date_label: t.dueDate,\n    due_date: formatDateForDocument(data.invoice.due_date),\n    bill_to: t.billTo,\n    student_first_name: data.student.first_name,\n    student_last_name: data.student.last_name,\n    student_number: data.student.student_number,\n    student_address: data.student.address || '',\n    description_label: t.description,\n    quantity_label: t.quantity,\n    unit_price_label: t.unitPrice,\n    total_label: t.total,\n    invoice_items_html: invoiceItemsHTML,\n    subtotal_label: t.subtotal,\n    subtotal_amount: formatCurrency(data.invoice.amount, data.invoice.currency),\n    tax_amount: data.invoice.tax_amount > 0 ? data.invoice.tax_amount : 0,\n    tax_label: t.tax,\n    tax_amount_formatted: formatCurrency(data.invoice.tax_amount, data.invoice.currency),\n    total_amount_label: t.totalAmount,\n    total_amount_formatted: formatCurrency(data.invoice.total_amount, data.invoice.currency),\n  }\n  \n  // Traiter le template avec le système de génération HTML\n  return await processTemplateWithTags(template, variables, data.documentId, data.organizationId)\n}\n\n/**\n * Génère le template avec balises {variable} pour un reçu de paiement\n */\nfunction generateReceiptTemplate(data: {\n  payment: {\n    amount: number\n    currency: string\n    payment_method: string\n    transaction_id?: string\n    paid_at: string\n  }\n  invoice: {\n    invoice_number: string\n  }\n  student: {\n    first_name: string\n    last_name: string\n    student_number: string\n  }\n  organization: {\n    name: string\n    address?: string\n    phone?: string\n    email?: string\n    logo_url?: string\n  }\n  language?: 'fr' | 'en'\n}): string {\n  return `\n    <div id=\"receipt-document\" style=\"max-width: 210mm; margin: 0 auto; padding: 20mm; font-family: Arial, sans-serif; color: #000;\">\n      {organization_logo && <div style=\"text-align: center; margin-bottom: 20px;\">\n        <img src=\"{organization_logo}\" alt=\"Logo\" style=\"max-height: 60px;\" />\n      </div>}\n      \n      <h1 style=\"text-align: center; font-size: 24px; font-weight: bold; margin-bottom: 30px; text-transform: uppercase;\">\n        {title}\n      </h1>\n      \n      <div style=\"margin-bottom: 30px;\">\n        <p><strong>{receipt_number_label}:</strong> {receipt_number}</p>\n        <p><strong>{date_label}:</strong> {payment_date}</p>\n        </div>\n      \n      <div style=\"margin-bottom: 30px; padding: 20px; background-color: #f9fafb; border-radius: 8px;\">\n        <p><strong>{paid_by_label}:</strong></p>\n        <p style=\"font-size: 18px; font-weight: bold; margin-top: 10px;\">\n          {student_first_name} {student_last_name}\n        </p>\n        <p>N° étudiant: {student_number}</p>\n        </div>\n      \n      <div style=\"margin-bottom: 30px;\">\n        <p><strong>{invoice_label}:</strong> {invoice_number}</p>\n        <p style=\"font-size: 24px; font-weight: bold; margin-top: 20px; color: #335ACF;\">\n          {amount_label}: {payment_amount}\n        </p>\n        <p style=\"margin-top: 15px;\"><strong>{method_label}:</strong> {payment_method_label}</p>\n        {IF transaction_id}<p><strong>{transaction_id_label}:</strong> {transaction_id}</p>{ENDIF}\n      </div>\n      \n      <div style=\"text-align: center; margin-top: 50px; padding: 20px; background-color: #ecfdf5; border-radius: 8px;\">\n        <p style=\"font-size: 18px; font-weight: bold; color: #335ACF;\">{thank_you}</p>\n      </div>\n      \n      <div style=\"margin-top: 50px; text-align: center;\">\n        <p>{organization_name}</p>\n        {IF organization_address}<p>{organization_address}</p>{ENDIF}\n      </div>\n    </div>\n  `\n}\n\n/**\n * Génère le HTML final pour un reçu de paiement en utilisant les balises {variable}\n */\nexport async function generateReceiptHTML(data: {\n  payment: {\n    amount: number\n    currency: string\n    payment_method: string\n    transaction_id?: string\n    paid_at: string\n  }\n  invoice: {\n    invoice_number: string\n  }\n  student: {\n    first_name: string\n    last_name: string\n    student_number: string\n  }\n  organization: {\n    name: string\n    address?: string\n    phone?: string\n    email?: string\n    logo_url?: string\n  }\n  language?: 'fr' | 'en'\n  documentId?: string\n  organizationId?: string\n}): Promise<string> {\n  const lang = data.language || 'fr'\n  const texts = {\n    fr: {\n      title: 'REÇU DE PAIEMENT',\n      receiptNumber: 'Reçu N°',\n      date: 'Date',\n      paidBy: 'Reçu de',\n      invoice: 'Facture N°',\n      amount: 'Montant',\n      method: 'Méthode de paiement',\n      transactionId: 'ID Transaction',\n      thankYou: 'Merci pour votre paiement',\n    },\n    en: {\n      title: 'PAYMENT RECEIPT',\n      receiptNumber: 'Receipt N°',\n      date: 'Date',\n      paidBy: 'Received from',\n      invoice: 'Invoice N°',\n      amount: 'Amount',\n      method: 'Payment method',\n      transactionId: 'Transaction ID',\n      thankYou: 'Thank you for your payment',\n    },\n  }\n\n  const t = texts[lang]\n\n  const getPaymentMethodLabel = (method: string) => {\n    const methods: Record<string, { fr: string; en: string }> = {\n      cash: { fr: 'Espèces', en: 'Cash' },\n      mobile_money: { fr: 'Mobile Money', en: 'Mobile Money' },\n      card: { fr: 'Carte bancaire', en: 'Credit Card' },\n      bank_transfer: { fr: 'Virement bancaire', en: 'Bank Transfer' },\n    }\n    return methods[method]?.[lang] || method\n  }\n\n  // Générer le template avec balises\n  const template = generateReceiptTemplate(data)\n  \n  // Préparer les variables pour le système de balises\n  const variables: any = {\n    organisation_logo: data.organization.logo_url || '',\n    title: t.title,\n    receipt_number_label: t.receiptNumber,\n    receipt_number: `REC-${data.payment.paid_at.replace(/-/g, '').slice(0, 8)}`,\n    date_label: t.date,\n    payment_date: formatDateForDocument(data.payment.paid_at),\n    paid_by_label: t.paidBy,\n    student_first_name: data.student.first_name,\n    student_last_name: data.student.last_name,\n    student_number: data.student.student_number,\n    invoice_label: t.invoice,\n    invoice_number: data.invoice.invoice_number,\n    amount_label: t.amount,\n    payment_amount: formatCurrency(data.payment.amount, data.payment.currency),\n    method_label: t.method,\n    payment_method_label: getPaymentMethodLabel(data.payment.payment_method),\n    transaction_id: data.payment.transaction_id || '',\n    transaction_id_label: t.transactionId,\n    thank_you: t.thankYou,\n    organization_name: data.organization.name,\n    organization_address: data.organization.address || '',\n  }\n  \n  // Traiter le template avec le système de génération HTML\n  return await processTemplateWithTags(template, variables, data.documentId, data.organizationId)\n}\n\n/**\n * Génère le template avec balises {variable} pour une convention de formation professionnelle\n */\nfunction generateConventionTemplate(data: {\n  session: {\n    name: string\n    start_date: string\n    end_date: string\n    location?: string\n    start_time?: string\n    end_time?: string\n  }\n  formation: {\n    name: string\n    code?: string\n    price?: number\n    duration_hours?: number\n    objectives?: string\n    prerequisites?: string\n    targetAudience?: string\n  }\n  program?: {\n    name: string\n  }\n  organization: {\n    name: string\n    address?: string\n    phone?: string\n    email?: string\n    logo_url?: string\n    siret?: string\n    rcs?: string\n    vat_number?: string\n  }\n  client?: {\n    name?: string\n    address?: string\n    contact?: string\n    email?: string\n    phone?: string\n  }\n  issueDate: string\n  language?: 'fr' | 'en'\n}) {\n  const lang = data.language || 'fr'\n  const texts = {\n    fr: {\n      title: 'CONVENTION DE FORMATION PROFESSIONNELLE',\n      between: 'ENTRE',\n      theOrganization: 'L\\'organisme de formation',\n      representedBy: 'représenté(e) par',\n      director: 'Directeur(trice)',\n      and: 'ET',\n      theClient: 'Le client',\n      company: 'Entreprise',\n      object: 'ARTICLE 1 - OBJET',\n      conventionObject: 'La présente convention a pour objet de définir les conditions dans lesquelles',\n      willProvide: 's\\'engage à dispenser la formation professionnelle suivante',\n      program: 'Programme',\n      formation: 'Intitulé de la formation',\n      session: 'Session',\n      dates: 'Dates de formation',\n      location: 'Lieu de formation',\n      duration: 'Durée',\n      hours: 'heures',\n      schedule: 'Horaires',\n      objectives: 'Objectifs pédagogiques',\n      prerequisites: 'Prérequis',\n      targetAudience: 'Public visé',\n      terms: 'ARTICLE 2 - MODALITÉS DE DÉROULEMENT',\n      termsContent: 'La formation se déroulera selon les modalités définies dans le programme de formation. Les méthodes pédagogiques, les supports de cours et les modalités d\\'évaluation sont détaillés dans le programme remis au client.',\n      financial: 'ARTICLE 3 - CONDITIONS FINANCIÈRES',\n      price: 'Montant total de la formation',\n      paymentTerms: 'Modalités de paiement',\n      paymentTermsContent: 'Le paiement s\\'effectuera selon les modalités convenues entre les parties. Un acompte peut être demandé à la signature de la présente convention.',\n      cancellation: 'ARTICLE 4 - ANNULATION',\n      cancellationContent: 'En cas d\\'annulation par le client moins de 15 jours avant le début de la formation, des frais d\\'annulation pourront être appliqués. L\\'organisme de formation se réserve le droit d\\'annuler la formation en cas de nombre insuffisant de participants, avec remboursement intégral des sommes versées.',\n      signature: 'Signature et cachet',\n      doneAt: 'Fait à',\n      on: 'le',\n      inDuplicate: 'En double exemplaire',\n      for: 'Pour',\n      andAccept: 'et accepté',\n    },\n    en: {\n      title: 'PROFESSIONAL TRAINING AGREEMENT',\n      between: 'BETWEEN',\n      theOrganization: 'The training organization',\n      representedBy: 'represented by',\n      director: 'Director',\n      and: 'AND',\n      theClient: 'The client',\n      company: 'Company',\n      object: 'ARTICLE 1 - OBJECT',\n      conventionObject: 'This agreement defines the conditions under which',\n      willProvide: 'commits to provide the following professional training',\n      program: 'Program',\n      formation: 'Training title',\n      session: 'Session',\n      dates: 'Training dates',\n      location: 'Training location',\n      duration: 'Duration',\n      hours: 'hours',\n      schedule: 'Schedule',\n      objectives: 'Learning objectives',\n      prerequisites: 'Prerequisites',\n      targetAudience: 'Target audience',\n      terms: 'ARTICLE 2 - TRAINING MODALITIES',\n      termsContent: 'The training will be conducted according to the modalities defined in the training program. Teaching methods, course materials and assessment methods are detailed in the program provided to the client.',\n      financial: 'ARTICLE 3 - FINANCIAL CONDITIONS',\n      price: 'Total training amount',\n      paymentTerms: 'Payment terms',\n      paymentTermsContent: 'Payment will be made according to the terms agreed between the parties. A deposit may be required upon signing this agreement.',\n      cancellation: 'ARTICLE 4 - CANCELLATION',\n      cancellationContent: 'In case of cancellation by the client less than 15 days before the start of training, cancellation fees may apply. The training organization reserves the right to cancel the training in case of insufficient number of participants, with full refund of amounts paid.',\n      signature: 'Signature and stamp',\n      doneAt: 'Done at',\n      on: 'on',\n      inDuplicate: 'In duplicate',\n      for: 'For',\n      andAccept: 'and accepted',\n    },\n  }\n\n  return `\n    <div id=\"convention-document\" style=\"max-width: 210mm; margin: 0 auto; padding: 20mm; font-family: 'Times New Roman', serif; color: #000; line-height: 1.6;\">\n      {organization_logo && <div style=\"text-align: center; margin-bottom: 30px;\">\n        <img src=\"{organization_logo}\" alt=\"Logo\" style=\"max-height: 80px;\" />\n      </div>}\n      \n      <h1 style=\"text-align: center; font-size: 20px; font-weight: bold; margin-bottom: 40px; text-transform: uppercase; letter-spacing: 1px;\">\n        {title}\n      </h1>\n      \n      <div style=\"margin-bottom: 30px; border: 1px solid #000; padding: 15px;\">\n        <p style=\"font-weight: bold; margin-bottom: 15px; font-size: 14px;\">{between}</p>\n        \n        <div style=\"margin-bottom: 20px;\">\n          <p style=\"margin-bottom: 5px;\"><strong>{the_organization}</strong> : {organization_name}</p>\n          {IF organization_address}<p style=\"margin-left: 20px; margin-bottom: 3px;\">{organization_address}</p>{ENDIF}\n          {IF organization_phone}<p style=\"margin-left: 20px; margin-bottom: 3px;\">Tél: {organization_phone}</p>{ENDIF}\n          {IF organization_email}<p style=\"margin-left: 20px; margin-bottom: 3px;\">Email: {organization_email}</p>{ENDIF}\n          {IF organization_siret}<p style=\"margin-left: 20px; margin-bottom: 3px;\">SIRET: {organization_siret}</p>{ENDIF}\n          {IF organization_rcs}<p style=\"margin-left: 20px; margin-bottom: 3px;\">RCS: {organization_rcs}</p>{ENDIF}\n          {IF organization_vat_number}<p style=\"margin-left: 20px;\">N° TVA: {organization_vat_number}</p>{ENDIF}\n        </div>\n        \n        <p style=\"margin-top: 20px; margin-bottom: 15px;\"><strong>{and}</strong></p>\n        \n        <div>\n          {IF client_name}<p style=\"margin-bottom: 5px;\"><strong>{client_label}</strong> : {client_name}</p>\n          {IF client_address}<p style=\"margin-left: 20px; margin-bottom: 3px;\">{client_address}</p>{ENDIF}\n          {IF client_phone}<p style=\"margin-left: 20px; margin-bottom: 3px;\">Tél: {client_phone}</p>{ENDIF}\n          {IF client_email}<p style=\"margin-left: 20px;\">Email: {client_email}</p>{ENDIF}\n          {ELSE}<p style=\"margin-bottom: 5px;\"><strong>{the_client}</strong> : [Nom du client/entreprise]</p>\n            <p style=\"margin-left: 20px; margin-bottom: 3px;\">[Adresse]</p>\n          <p style=\"margin-left: 20px;\">[Téléphone/Email]</p>{ENDIF}\n        </div>\n      </div>\n      \n      <div style=\"margin-top: 40px; margin-bottom: 30px;\">\n        <h2 style=\"font-size: 16px; font-weight: bold; margin-bottom: 15px; text-transform: uppercase; border-bottom: 2px solid #000; padding-bottom: 5px;\">\n          {object}\n        </h2>\n        <p style=\"line-height: 1.8; text-align: justify; margin-bottom: 15px;\">\n          {convention_object} <strong>{organization_name}</strong> {will_provide} :\n        </p>\n        <div style=\"margin-left: 30px; margin-top: 15px; line-height: 2;\">\n          {IF program_name}<p><strong>{program}:</strong> {program_name}</p>{ENDIF}\n          <p><strong>{formation}:</strong> {formation_name}{IF formation_code} (Code: {formation_code}){ENDIF}</p>\n          <p><strong>{session}:</strong> {session_name}</p>\n          <p><strong>{dates}:</strong> Du {session_start_date} au {session_end_date}</p>\n          {IF session_start_time && session_end_time}<p><strong>{schedule}:</strong> {session_start_time} - {session_end_time}</p>{ENDIF}\n          {IF session_location}<p><strong>{location}:</strong> {session_location}</p>{ENDIF}\n          {IF formation_duration_hours}<p><strong>{duration}:</strong> {formation_duration_hours} {hours}</p>{ENDIF}\n          {IF formation_objectives}<p style=\"margin-top: 10px;\"><strong>{objectives}:</strong> {formation_objectives}</p>{ENDIF}\n          {IF formation_prerequisites}<p><strong>{prerequisites}:</strong> {formation_prerequisites}</p>{ENDIF}\n          {IF formation_target_audience}<p><strong>{target_audience}:</strong> {formation_target_audience}</p>{ENDIF}\n        </div>\n      </div>\n      \n      <div style=\"margin-top: 40px; margin-bottom: 30px;\">\n        <h2 style=\"font-size: 16px; font-weight: bold; margin-bottom: 15px; text-transform: uppercase; border-bottom: 2px solid #000; padding-bottom: 5px;\">\n          {terms}\n        </h2>\n        <p style=\"line-height: 1.8; text-align: justify;\">\n          {terms_content}\n        </p>\n      </div>\n      \n      <div style=\"margin-top: 40px; margin-bottom: 30px;\">\n        <h2 style=\"font-size: 16px; font-weight: bold; margin-bottom: 15px; text-transform: uppercase; border-bottom: 2px solid #000; padding-bottom: 5px;\">\n          {financial}\n        </h2>\n        <div style=\"margin-left: 20px; line-height: 2;\">\n          {IF formation_price}<p><strong>{price}:</strong> {formation_price_formatted} TTC</p>{ENDIF}\n          <p style=\"margin-top: 10px;\"><strong>{payment_terms}:</strong></p>\n          <p style=\"margin-left: 20px; text-align: justify;\">{payment_terms_content}</p>\n        </div>\n      </div>\n      \n      <div style=\"margin-top: 40px; margin-bottom: 30px;\">\n        <h2 style=\"font-size: 16px; font-weight: bold; margin-bottom: 15px; text-transform: uppercase; border-bottom: 2px solid #000; padding-bottom: 5px;\">\n          {cancellation}\n        </h2>\n        <p style=\"line-height: 1.8; text-align: justify;\">\n          {cancellation_content}\n        </p>\n      </div>\n      \n      <div style=\"margin-top: 60px; display: flex; justify-content: space-between; page-break-inside: avoid;\">\n        <div style=\"width: 45%;\">\n          <p style=\"margin-bottom: 50px; font-weight: bold;\">{signature}</p>\n          <p style=\"border-top: 1px solid #000; padding-top: 5px; margin-top: 60px;\">_________________________</p>\n          <p style=\"margin-top: 5px; font-size: 11px;\">{organization_name}</p>\n          <p style=\"margin-top: 5px; font-size: 11px;\">{director}</p>\n        </div>\n        <div style=\"width: 45%;\">\n          <p style=\"margin-bottom: 50px; font-weight: bold;\">{signature}</p>\n          <p style=\"border-top: 1px solid #000; padding-top: 5px; margin-top: 60px;\">_________________________</p>\n          <p style=\"margin-top: 5px; font-size: 11px;\">{client_name_or_label}</p>\n        </div>\n      </div>\n      \n      <div style=\"margin-top: 50px; text-align: center; font-size: 12px;\">\n        <p><strong>{done_at}</strong> {organization_address}, <strong>{on}</strong> <strong>{issue_date}</strong></p>\n        <p style=\"margin-top: 10px; font-style: italic;\">{in_duplicate}</p>\n      </div>\n    </div>\n  `\n}\n\n/**\n * Génère le HTML final pour une convention de formation professionnelle en utilisant les balises {variable}\n */\nexport async function generateConventionHTML(data: {\n  session: {\n    name: string\n    start_date: string\n    end_date: string\n    location?: string\n    start_time?: string\n    end_time?: string\n  }\n  formation: {\n    name: string\n    code?: string\n    price?: number\n    duration_hours?: number\n    objectives?: string\n    prerequisites?: string\n    targetAudience?: string\n  }\n  program?: {\n    name: string\n  }\n  organization: {\n    name: string\n    address?: string\n    phone?: string\n    email?: string\n    logo_url?: string\n    siret?: string\n    rcs?: string\n    vat_number?: string\n  }\n  client?: {\n    name?: string\n    address?: string\n    contact?: string\n    email?: string\n    phone?: string\n  }\n  issueDate: string\n  language?: 'fr' | 'en'\n  documentId?: string\n  organizationId?: string\n}): Promise<string> {\n  const lang = data.language || 'fr'\n  const texts = {\n    fr: {\n      title: 'CONVENTION DE FORMATION PROFESSIONNELLE',\n      between: 'ENTRE',\n      theOrganization: 'L\\'organisme de formation',\n      representedBy: 'représenté(e) par',\n      director: 'Directeur(trice)',\n      and: 'ET',\n      theClient: 'Le client',\n      company: 'Entreprise',\n      object: 'ARTICLE 1 - OBJET',\n      conventionObject: 'La présente convention a pour objet de définir les conditions dans lesquelles',\n      willProvide: 's\\'engage à dispenser la formation professionnelle suivante',\n      program: 'Programme',\n      formation: 'Intitulé de la formation',\n      session: 'Session',\n      dates: 'Dates de formation',\n      location: 'Lieu de formation',\n      duration: 'Durée',\n      hours: 'heures',\n      schedule: 'Horaires',\n      objectives: 'Objectifs pédagogiques',\n      prerequisites: 'Prérequis',\n      targetAudience: 'Public visé',\n      terms: 'ARTICLE 2 - MODALITÉS DE DÉROULEMENT',\n      termsContent: 'La formation se déroulera selon les modalités définies dans le programme de formation. Les méthodes pédagogiques, les supports de cours et les modalités d\\'évaluation sont détaillés dans le programme remis au client.',\n      financial: 'ARTICLE 3 - CONDITIONS FINANCIÈRES',\n      price: 'Montant total de la formation',\n      paymentTerms: 'Modalités de paiement',\n      paymentTermsContent: 'Le paiement s\\'effectuera selon les modalités convenues entre les parties. Un acompte peut être demandé à la signature de la présente convention.',\n      cancellation: 'ARTICLE 4 - ANNULATION',\n      cancellationContent: 'En cas d\\'annulation par le client moins de 15 jours avant le début de la formation, des frais d\\'annulation pourront être appliqués. L\\'organisme de formation se réserve le droit d\\'annuler la formation en cas de nombre insuffisant de participants, avec remboursement intégral des sommes versées.',\n      signature: 'Signature et cachet',\n      doneAt: 'Fait à',\n      on: 'le',\n      inDuplicate: 'En double exemplaire',\n      for: 'Pour',\n      andAccept: 'et accepté',\n    },\n    en: {\n      title: 'PROFESSIONAL TRAINING AGREEMENT',\n      between: 'BETWEEN',\n      theOrganization: 'The training organization',\n      representedBy: 'represented by',\n      director: 'Director',\n      and: 'AND',\n      theClient: 'The client',\n      company: 'Company',\n      object: 'ARTICLE 1 - OBJECT',\n      conventionObject: 'This agreement defines the conditions under which',\n      willProvide: 'commits to provide the following professional training',\n      program: 'Program',\n      formation: 'Training title',\n      session: 'Session',\n      dates: 'Training dates',\n      location: 'Training location',\n      duration: 'Duration',\n      hours: 'hours',\n      schedule: 'Schedule',\n      objectives: 'Learning objectives',\n      prerequisites: 'Prerequisites',\n      targetAudience: 'Target audience',\n      terms: 'ARTICLE 2 - TRAINING MODALITIES',\n      termsContent: 'The training will be conducted according to the modalities defined in the training program. Teaching methods, course materials and assessment methods are detailed in the program provided to the client.',\n      financial: 'ARTICLE 3 - FINANCIAL CONDITIONS',\n      price: 'Total training amount',\n      paymentTerms: 'Payment terms',\n      paymentTermsContent: 'Payment will be made according to the terms agreed between the parties. A deposit may be required upon signing this agreement.',\n      cancellation: 'ARTICLE 4 - CANCELLATION',\n      cancellationContent: 'In case of cancellation by the client less than 15 days before the start of training, cancellation fees may apply. The training organization reserves the right to cancel the training in case of insufficient number of participants, with full refund of amounts paid.',\n      signature: 'Signature and stamp',\n      doneAt: 'Done at',\n      on: 'on',\n      inDuplicate: 'In duplicate',\n      for: 'For',\n      andAccept: 'and accepted',\n    },\n  }\n\n  const t = texts[lang]\n  \n  // Générer le template avec balises\n  const template = generateConventionTemplate(data)\n  \n  // Préparer les variables pour le système de balises\n  const variables: any = {\n    organisation_logo: data.organization.logo_url || '',\n    title: t.title,\n    between: t.between,\n    the_organization: t.theOrganization,\n    organization_name: data.organization.name,\n    organization_address: data.organization.address || '',\n    organization_phone: data.organization.phone || '',\n    organization_email: data.organization.email || '',\n    organization_siret: data.organization.siret || '',\n    organization_rcs: data.organization.rcs || '',\n    organization_vat_number: data.organization.vat_number || '',\n    and: t.and,\n    client_name: data.client?.name || '',\n    client_label: data.client?.name ? (data.client?.name ? t.company : t.theClient) : '',\n    client_address: data.client?.address || '',\n    client_phone: data.client?.phone || '',\n    client_email: data.client?.email || '',\n    the_client: t.theClient,\n    object: t.object,\n    convention_object: t.conventionObject,\n    will_provide: t.willProvide,\n    program: t.program,\n    program_name: data.program?.name || '',\n    formation: t.formation,\n    formation_name: data.formation.name,\n    formation_code: data.formation.code || '',\n    session: t.session,\n    session_name: data.session.name,\n    dates: t.dates,\n    session_start_date: formatDateForDocument(data.session.start_date),\n    session_end_date: formatDateForDocument(data.session.end_date),\n    session_start_time: data.session.start_time || '',\n    session_end_time: data.session.end_time || '',\n    schedule: t.schedule,\n    location: t.location,\n    session_location: data.session.location || '',\n    duration: t.duration,\n    formation_duration_hours: data.formation.duration_hours || 0,\n    hours: t.hours,\n    objectives: t.objectives,\n    formation_objectives: data.formation.objectives || '',\n    prerequisites: t.prerequisites,\n    formation_prerequisites: data.formation.prerequisites || '',\n    target_audience: t.targetAudience,\n    formation_target_audience: data.formation.targetAudience || '',\n    terms: t.terms,\n    terms_content: t.termsContent,\n    financial: t.financial,\n    price: t.price,\n    formation_price: data.formation.price || 0,\n    formation_price_formatted: data.formation.price ? formatCurrency(data.formation.price, 'EUR') : '',\n    payment_terms: t.paymentTerms,\n    payment_terms_content: t.paymentTermsContent,\n    cancellation: t.cancellation,\n    cancellation_content: t.cancellationContent,\n    signature: t.signature,\n    director: t.director,\n    client_name_or_label: data.client?.name || t.theClient,\n    done_at: t.doneAt,\n    on: t.on,\n    issue_date: formatDateForDocument(data.issueDate),\n    in_duplicate: t.inDuplicate,\n  }\n  \n  // Traiter le template avec le système de génération HTML\n  return await processTemplateWithTags(template, variables, data.documentId, data.organizationId)\n}\n\n/**\n * Génère le template avec balises {variable} pour un rapport de session complet\n */\nfunction generateSessionReportTemplate(data: {\n  session: {\n    name: string\n    start_date: string\n    end_date: string\n    start_time?: string\n    end_time?: string\n    location?: string\n    status: string\n  }\n  formation: {\n    name: string\n    code?: string\n    duration_hours?: number\n    price?: number\n  }\n  program?: {\n    name: string\n  }\n  organization: {\n    name: string\n    address?: string\n    phone?: string\n    email?: string\n    logo_url?: string\n  }\n  statistics: {\n    totalEnrollments: number\n    activeEnrollments: number\n    completedEnrollments: number\n    attendanceRate: number\n    averageGrade?: number\n    averagePercentage?: number\n    totalRevenue: number\n    paidAmount: number\n    remainingAmount: number\n  }\n  students: Array<{\n    first_name: string\n    last_name: string\n    student_number?: string\n    email?: string\n    attendanceRate: number\n    averageGrade?: number\n    paymentStatus: string\n    enrollmentDate: string\n  }>\n  issueDate: string\n  language?: 'fr' | 'en'\n}) {\n  const lang = data.language || 'fr'\n  const t = {\n    fr: {\n      title: 'RAPPORT DE SESSION',\n      subtitle: 'Rapport complet de la session de formation',\n      sessionInfo: 'Informations de la session',\n      program: 'Programme',\n      formation: 'Formation',\n      session: 'Session',\n      dates: 'Dates',\n      times: 'Horaires',\n      location: 'Lieu',\n      status: 'Statut',\n      duration: 'Durée',\n      hours: 'heures',\n      statistics: 'Statistiques',\n      enrollments: 'Inscriptions',\n      active: 'Actives',\n      completed: 'Terminées',\n      attendanceRate: 'Taux de présence',\n      averageGrade: 'Note moyenne',\n      averagePercentage: 'Pourcentage moyen',\n      financial: 'Financier',\n      totalRevenue: 'Revenu total',\n      paidAmount: 'Montant payé',\n      remainingAmount: 'Reste à payer',\n      students: 'Apprenants',\n      studentName: 'Nom',\n      studentNumber: 'Numéro',\n      email: 'Email',\n      attendance: 'Présence',\n      grade: 'Note',\n      paymentStatus: 'Statut paiement',\n      enrollmentDate: 'Date d\\'inscription',\n      doneAt: 'Fait à',\n      on: 'le',\n      currency: 'FCFA',\n    },\n    en: {\n      title: 'SESSION REPORT',\n      subtitle: 'Complete training session report',\n      sessionInfo: 'Session information',\n      program: 'Program',\n      formation: 'Training',\n      session: 'Session',\n      dates: 'Dates',\n      times: 'Schedule',\n      location: 'Location',\n      status: 'Status',\n      duration: 'Duration',\n      hours: 'hours',\n      statistics: 'Statistics',\n      enrollments: 'Enrollments',\n      active: 'Active',\n      completed: 'Completed',\n      attendanceRate: 'Attendance rate',\n      averageGrade: 'Average grade',\n      averagePercentage: 'Average percentage',\n      financial: 'Financial',\n      totalRevenue: 'Total revenue',\n      paidAmount: 'Paid amount',\n      remainingAmount: 'Remaining amount',\n      students: 'Students',\n      studentName: 'Name',\n      studentNumber: 'Number',\n      email: 'Email',\n      attendance: 'Attendance',\n      grade: 'Grade',\n      paymentStatus: 'Payment status',\n      enrollmentDate: 'Enrollment date',\n      doneAt: 'Done at',\n      on: 'on',\n      currency: 'FCFA',\n    },\n  }[lang]\n\n  const statusLabels = {\n    fr: {\n      planned: 'Planifiée',\n      ongoing: 'En cours',\n      completed: 'Terminée',\n      cancelled: 'Annulée',\n    },\n    en: {\n      planned: 'Planned',\n      ongoing: 'Ongoing',\n      completed: 'Completed',\n      cancelled: 'Cancelled',\n    },\n  }[lang]\n\n  const paymentStatusLabels = {\n    fr: {\n      pending: 'En attente',\n      partial: 'Partiel',\n      paid: 'Payé',\n      overdue: 'En retard',\n    },\n    en: {\n      pending: 'Pending',\n      partial: 'Partial',\n      paid: 'Paid',\n      overdue: 'Overdue',\n    },\n  }[lang]\n\n  return `\n    <div id=\"session-report-document\" style=\"max-width: 210mm; margin: 0 auto; padding: 15mm; font-family: Arial, sans-serif; color: #000; line-height: 1.6;\">\n      {organization_logo && <div style=\"text-align: center; margin-bottom: 30px;\">\n        <img src=\"{organization_logo}\" alt=\"Logo\" style=\"max-height: 80px;\" />\n      </div>}\n      \n      <h1 style=\"text-align: center; font-size: 28px; font-weight: bold; margin-bottom: 10px; text-transform: uppercase; color: #1e40af;\">\n        {title}\n      </h1>\n      <p style=\"text-align: center; font-size: 14px; color: #6b7280; margin-bottom: 40px;\">\n        {subtitle}\n      </p>\n      \n      <!-- Informations de la session -->\n      <div style=\"margin-bottom: 30px; padding: 20px; background-color: #f9fafb; border-radius: 8px; border-left: 4px solid #1e40af;\">\n        <h2 style=\"font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #1e40af;\">\n          {session_info}\n        </h2>\n        <table style=\"width: 100%; border-collapse: collapse;\">\n          {IF program_name}<tr>\n            <td style=\"padding: 8px 0; font-weight: bold; width: 30%;\">{program}:</td>\n            <td style=\"padding: 8px 0;\">{program_name}</td>\n          </tr>{ENDIF}\n          <tr>\n            <td style=\"padding: 8px 0; font-weight: bold; width: 30%;\">{formation}:</td>\n            <td style=\"padding: 8px 0;\">{formation_name}{IF formation_code} ({formation_code}){ENDIF}</td>\n          </tr>\n          <tr>\n            <td style=\"padding: 8px 0; font-weight: bold;\">{session}:</td>\n            <td style=\"padding: 8px 0;\">{session_name}</td>\n          </tr>\n          <tr>\n            <td style=\"padding: 8px 0; font-weight: bold;\">{dates}:</td>\n            <td style=\"padding: 8px 0;\">{session_start_date} - {session_end_date}</td>\n          </tr>\n          {IF session_start_time && session_end_time}<tr>\n            <td style=\"padding: 8px 0; font-weight: bold;\">{times}:</td>\n            <td style=\"padding: 8px 0;\">{session_start_time} - {session_end_time}</td>\n          </tr>{ENDIF}\n          {IF session_location}<tr>\n            <td style=\"padding: 8px 0; font-weight: bold;\">{location}:</td>\n            <td style=\"padding: 8px 0;\">{session_location}</td>\n          </tr>{ENDIF}\n          <tr>\n            <td style=\"padding: 8px 0; font-weight: bold;\">{status}:</td>\n            <td style=\"padding: 8px 0;\">{session_status_label}</td>\n          </tr>\n          {IF formation_duration_hours}<tr>\n            <td style=\"padding: 8px 0; font-weight: bold;\">{duration}:</td>\n            <td style=\"padding: 8px 0;\">{formation_duration_hours} {hours}</td>\n          </tr>{ENDIF}\n        </table>\n      </div>\n\n      <!-- Statistiques -->\n      <div style=\"margin-bottom: 30px;\">\n        <h2 style=\"font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #1e40af;\">\n          {statistics}\n        </h2>\n        <div style=\"display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;\">\n          <div style=\"padding: 15px; background-color: #eff6ff; border-radius: 8px; text-align: center;\">\n            <div style=\"font-size: 24px; font-weight: bold; color: #1e40af;\">{total_enrollments}</div>\n            <div style=\"font-size: 12px; color: #6b7280; margin-top: 5px;\">{enrollments}</div>\n            <div style=\"font-size: 11px; color: #6b7280; margin-top: 3px;\">{active_enrollments} {active}</div>\n          </div>\n          <div style=\"padding: 15px; background-color: #f0fdf4; border-radius: 8px; text-align: center;\">\n            <div style=\"font-size: 24px; font-weight: bold; color: #335ACF;\">{completed_enrollments}</div>\n            <div style=\"font-size: 12px; color: #6b7280; margin-top: 5px;\">{completed}</div>\n            <div style=\"font-size: 11px; color: #6b7280; margin-top: 3px;\">{attendance_rate}% {attendance_rate_label}</div>\n          </div>\n          <div style=\"padding: 15px; background-color: #fef3c7; border-radius: 8px; text-align: center;\">\n            <div style=\"font-size: 24px; font-weight: bold; color: #d97706;\">\n              {average_display}\n            </div>\n            <div style=\"font-size: 12px; color: #6b7280; margin-top: 5px;\">\n              {average_label}\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <!-- Statistiques financières -->\n      <div style=\"margin-bottom: 30px; padding: 20px; background-color: #f0fdf4; border-radius: 8px;\">\n        <h2 style=\"font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #1e40af;\">\n          {financial}\n        </h2>\n        <div style=\"display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;\">\n          <div style=\"text-align: center;\">\n            <div style=\"font-size: 20px; font-weight: bold; color: #335ACF;\">{total_revenue}</div>\n            <div style=\"font-size: 12px; color: #6b7280; margin-top: 5px;\">{total_revenue_label}</div>\n          </div>\n          <div style=\"text-align: center;\">\n            <div style=\"font-size: 20px; font-weight: bold; color: #1e40af;\">{paid_amount}</div>\n            <div style=\"font-size: 12px; color: #6b7280; margin-top: 5px;\">{paid_amount_label}</div>\n          </div>\n          <div style=\"text-align: center;\">\n            <div style=\"font-size: 20px; font-weight: bold; color: #d97706;\">{remaining_amount}</div>\n            <div style=\"font-size: 12px; color: #6b7280; margin-top: 5px;\">{remaining_amount_label}</div>\n          </div>\n        </div>\n      </div>\n\n      <!-- Liste des apprenants -->\n      <div style=\"margin-bottom: 30px;\">\n        <h2 style=\"font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #1e40af;\">\n          {students} ({students_count})\n        </h2>\n        <table style=\"width: 100%; border-collapse: collapse; font-size: 12px;\">\n          <thead>\n            <tr style=\"background-color: #1e40af; color: white;\">\n              <th style=\"padding: 10px; text-align: left; border: 1px solid #1e3a8a;\">{student_name}</th>\n              <th style=\"padding: 10px; text-align: left; border: 1px solid #1e3a8a;\">{student_number}</th>\n              <th style=\"padding: 10px; text-align: center; border: 1px solid #1e3a8a;\">{attendance}</th>\n              <th style=\"padding: 10px; text-align: center; border: 1px solid #1e3a8a;\">{grade}</th>\n              <th style=\"padding: 10px; text-align: center; border: 1px solid #1e3a8a;\">{payment_status}</th>\n              <th style=\"padding: 10px; text-align: center; border: 1px solid #1e3a8a;\">{enrollment_date}</th>\n            </tr>\n          </thead>\n          <tbody>\n            {students_table_rows}\n          </tbody>\n        </table>\n      </div>\n\n      <!-- Informations de l'organisation -->\n      <div style=\"margin-top: 40px; padding-top: 20px; border-top: 2px solid #e5e7eb;\">\n        <p style=\"font-size: 12px; color: #6b7280; margin-bottom: 10px;\">\n          <strong>{organization_name}</strong>\n        </p>\n        {IF organization_address}<p style=\"font-size: 12px; color: #6b7280;\">{organization_address}</p>{ENDIF}\n        {IF organization_phone}<p style=\"font-size: 12px; color: #6b7280;\">Tél: {organization_phone}</p>{ENDIF}\n        {IF organization_email}<p style=\"font-size: 12px; color: #6b7280;\">Email: {organization_email}</p>{ENDIF}\n        <p style=\"font-size: 12px; color: #6b7280; margin-top: 20px;\">\n          {done_at} <strong>{organization_address}</strong>, {on} <strong>{issue_date}</strong>\n        </p>\n      </div>\n    </div>\n  `\n}\n\n/**\n * Génère le HTML final pour un rapport de session complet en utilisant les balises {variable}\n */\nexport async function generateSessionReportHTML(data: {\n  session: {\n    name: string\n    start_date: string\n    end_date: string\n    start_time?: string\n    end_time?: string\n    location?: string\n    status: string\n  }\n  formation: {\n    name: string\n    code?: string\n    duration_hours?: number\n    price?: number\n  }\n  program?: {\n    name: string\n  }\n  organization: {\n    name: string\n    address?: string\n    phone?: string\n    email?: string\n    logo_url?: string\n  }\n  statistics: {\n    totalEnrollments: number\n    activeEnrollments: number\n    completedEnrollments: number\n    attendanceRate: number\n    averageGrade?: number\n    averagePercentage?: number\n    totalRevenue: number\n    paidAmount: number\n    remainingAmount: number\n  }\n  students: Array<{\n    first_name: string\n    last_name: string\n    student_number?: string\n    email?: string\n    attendanceRate: number\n    averageGrade?: number\n    paymentStatus: string\n    enrollmentDate: string\n  }>\n  issueDate: string\n  language?: 'fr' | 'en'\n  documentId?: string\n  organizationId?: string\n}): Promise<string> {\n  const lang = data.language || 'fr'\n  const t = {\n    fr: {\n      title: 'RAPPORT DE SESSION',\n      subtitle: 'Rapport complet de la session de formation',\n      sessionInfo: 'Informations de la session',\n      program: 'Programme',\n      formation: 'Formation',\n      session: 'Session',\n      dates: 'Dates',\n      times: 'Horaires',\n      location: 'Lieu',\n      status: 'Statut',\n      duration: 'Durée',\n      hours: 'heures',\n      statistics: 'Statistiques',\n      enrollments: 'Inscriptions',\n      active: 'Actives',\n      completed: 'Terminées',\n      attendanceRate: 'Taux de présence',\n      averageGrade: 'Note moyenne',\n      averagePercentage: 'Pourcentage moyen',\n      financial: 'Financier',\n      totalRevenue: 'Revenu total',\n      paidAmount: 'Montant payé',\n      remainingAmount: 'Reste à payer',\n      students: 'Apprenants',\n      studentName: 'Nom',\n      studentNumber: 'Numéro',\n      email: 'Email',\n      attendance: 'Présence',\n      grade: 'Note',\n      paymentStatus: 'Statut paiement',\n      enrollmentDate: 'Date d\\'inscription',\n      doneAt: 'Fait à',\n      on: 'le',\n      currency: 'FCFA',\n    },\n    en: {\n      title: 'SESSION REPORT',\n      subtitle: 'Complete training session report',\n      sessionInfo: 'Session information',\n      program: 'Program',\n      formation: 'Training',\n      session: 'Session',\n      dates: 'Dates',\n      times: 'Schedule',\n      location: 'Location',\n      status: 'Status',\n      duration: 'Duration',\n      hours: 'hours',\n      statistics: 'Statistics',\n      enrollments: 'Enrollments',\n      active: 'Active',\n      completed: 'Completed',\n      attendanceRate: 'Attendance rate',\n      averageGrade: 'Average grade',\n      averagePercentage: 'Average percentage',\n      financial: 'Financial',\n      totalRevenue: 'Total revenue',\n      paidAmount: 'Paid amount',\n      remainingAmount: 'Remaining amount',\n      students: 'Students',\n      studentName: 'Name',\n      studentNumber: 'Number',\n      email: 'Email',\n      attendance: 'Attendance',\n      grade: 'Grade',\n      paymentStatus: 'Payment status',\n      enrollmentDate: 'Enrollment date',\n      doneAt: 'Done at',\n      on: 'on',\n      currency: 'FCFA',\n    },\n  }[lang]\n\n  const statusLabels = {\n    fr: {\n      planned: 'Planifiée',\n      ongoing: 'En cours',\n      completed: 'Terminée',\n      cancelled: 'Annulée',\n    },\n    en: {\n      planned: 'Planned',\n      ongoing: 'Ongoing',\n      completed: 'Completed',\n      cancelled: 'Cancelled',\n    },\n  }[lang]\n\n  const paymentStatusLabels = {\n    fr: {\n      pending: 'En attente',\n      partial: 'Partiel',\n      paid: 'Payé',\n      overdue: 'En retard',\n    },\n    en: {\n      pending: 'Pending',\n      partial: 'Partial',\n      paid: 'Paid',\n      overdue: 'Overdue',\n    },\n  }[lang]\n  \n  // Formater la liste des étudiants en HTML\n  const studentsTableRows = data.students.map((student, index) => `\n    <tr style=\"${index % 2 === 0 ? 'background-color: #f9fafb;' : ''}\">\n      <td style=\"padding: 8px; border: 1px solid #e5e7eb;\">\n        <strong>${student.first_name} ${student.last_name}</strong>\n        ${student.email ? `<br/><span style=\"font-size: 10px; color: #6b7280;\">${student.email}</span>` : ''}\n      </td>\n      <td style=\"padding: 8px; border: 1px solid #e5e7eb;\">${student.student_number || '-'}</td>\n      <td style=\"padding: 8px; text-align: center; border: 1px solid #e5e7eb;\">${student.attendanceRate}%</td>\n      <td style=\"padding: 8px; text-align: center; border: 1px solid #e5e7eb;\">${student.averageGrade !== null && student.averageGrade !== undefined ? student.averageGrade : '-'}</td>\n      <td style=\"padding: 8px; text-align: center; border: 1px solid #e5e7eb;\">${paymentStatusLabels[student.paymentStatus as keyof typeof paymentStatusLabels] || student.paymentStatus}</td>\n      <td style=\"padding: 8px; text-align: center; border: 1px solid #e5e7eb;\">${formatDateForDocument(student.enrollmentDate)}</td>\n    </tr>\n  `).join('')\n  \n  // Générer le template avec balises\n  const template = generateSessionReportTemplate(data)\n  \n  // Préparer les variables pour le système de balises\n  const averageDisplay = data.statistics.averagePercentage !== null \n    ? `${data.statistics.averagePercentage}%` \n    : data.statistics.averageGrade \n      ? `${data.statistics.averageGrade}` \n      : 'N/A'\n  const averageLabel = data.statistics.averagePercentage !== null \n    ? t.averagePercentage \n    : t.averageGrade\n  \n  const variables: any = {\n    organisation_logo: data.organization.logo_url || '',\n    title: t.title,\n    subtitle: t.subtitle,\n    session_info: t.sessionInfo,\n    program: t.program,\n    program_name: data.program?.name || '',\n    formation: t.formation,\n    formation_name: data.formation.name,\n    formation_code: data.formation.code || '',\n    session: t.session,\n    session_name: data.session.name,\n    dates: t.dates,\n    session_start_date: formatDateForDocument(data.session.start_date),\n    session_end_date: formatDateForDocument(data.session.end_date),\n    times: t.times,\n    session_start_time: data.session.start_time || '',\n    session_end_time: data.session.end_time || '',\n    location: t.location,\n    session_location: data.session.location || '',\n    status: t.status,\n    session_status_label: statusLabels[data.session.status as keyof typeof statusLabels] || data.session.status,\n    duration: t.duration,\n    formation_duration_hours: data.formation.duration_hours || 0,\n    hours: t.hours,\n    statistics: t.statistics,\n    total_enrollments: data.statistics.totalEnrollments,\n    enrollments: t.enrollments,\n    active_enrollments: data.statistics.activeEnrollments,\n    active: t.active,\n    completed_enrollments: data.statistics.completedEnrollments,\n    completed: t.completed,\n    attendance_rate: data.statistics.attendanceRate,\n    attendance_rate_label: t.attendanceRate,\n    average_display: averageDisplay,\n    average_label: averageLabel,\n    financial: t.financial,\n    total_revenue: formatCurrency(data.statistics.totalRevenue, 'XOF'),\n    total_revenue_label: t.totalRevenue,\n    paid_amount: formatCurrency(data.statistics.paidAmount, 'XOF'),\n    paid_amount_label: t.paidAmount,\n    remaining_amount: formatCurrency(data.statistics.remainingAmount, 'XOF'),\n    remaining_amount_label: t.remainingAmount,\n    students: t.students,\n    students_count: data.students.length,\n    student_name: t.studentName,\n    student_number: t.studentNumber,\n    attendance: t.attendance,\n    grade: t.grade,\n    payment_status: t.paymentStatus,\n    enrollment_date: t.enrollmentDate,\n    students_table_rows: studentsTableRows,\n    organization_name: data.organization.name,\n    organization_address: data.organization.address || '',\n    organization_phone: data.organization.phone || '',\n    organization_email: data.organization.email || '',\n    done_at: t.doneAt,\n    on: t.on,\n    issue_date: formatDateForDocument(data.issueDate),\n  }\n  \n  // Traiter le template avec le système de génération HTML\n  return await processTemplateWithTags(template, variables, data.documentId, data.organizationId)\n}\n\n/**\n * Génère le template avec balises {variable} pour un contrat particulier de formation professionnelle\n */\nfunction generateContractTemplate(data: {\n  student: {\n    first_name: string\n    last_name: string\n    email?: string\n    phone?: string\n    address?: string\n    date_of_birth?: string\n    student_number?: string\n    national_id?: string\n  }\n  session: {\n    name: string\n    start_date: string\n    end_date: string\n    location?: string\n    start_time?: string\n    end_time?: string\n  }\n  formation: {\n    name: string\n    code?: string\n    price?: number\n    duration_hours?: number\n    objectives?: string\n    prerequisites?: string\n    targetAudience?: string\n  }\n  program?: {\n    name: string\n  }\n  organization: {\n    name: string\n    address?: string\n    phone?: string\n    email?: string\n    logo_url?: string\n    siret?: string\n    rcs?: string\n    vat_number?: string\n  }\n  enrollment: {\n    enrollment_date: string\n    total_amount: number\n    paid_amount: number\n    payment_method?: string\n    payment_schedule?: string\n  }\n  issueDate: string\n  language?: 'fr' | 'en'\n}) {\n  const lang = data.language || 'fr'\n  const t = {\n    fr: {\n      title: 'CONTRAT PARTICULIER DE FORMATION PROFESSIONNELLE',\n      between: 'ENTRE',\n      theOrganization: 'L\\'organisme de formation',\n      representedBy: 'représenté(e) par',\n      director: 'Directeur(trice)',\n      and: 'ET',\n      theTrainee: 'Le stagiaire',\n      dateOfBirth: 'Né(e) le',\n      address: 'Adresse',\n      email: 'Email',\n      phone: 'Téléphone',\n      studentNumber: 'N° stagiaire',\n      nationalId: 'N° pièce d\\'identité',\n      object: 'ARTICLE 1 - OBJET',\n      contractObject: 'La présente convention a pour objet de définir les conditions dans lesquelles',\n      willProvide: 's\\'engage à dispenser la formation professionnelle suivante au stagiaire',\n      program: 'Programme',\n      formation: 'Intitulé de la formation',\n      session: 'Session',\n      dates: 'Dates de formation',\n      location: 'Lieu de formation',\n      duration: 'Durée',\n      hours: 'heures',\n      schedule: 'Horaires',\n      objectives: 'Objectifs pédagogiques',\n      prerequisites: 'Prérequis',\n      targetAudience: 'Public visé',\n      financial: 'ARTICLE 2 - CONDITIONS FINANCIÈRES',\n      price: 'Montant total de la formation',\n      paid: 'Montant payé',\n      remaining: 'Reste à payer',\n      enrollmentDate: 'Date d\\'inscription',\n      paymentMethod: 'Mode de paiement',\n      paymentSchedule: 'Échéancier de paiement',\n      terms: 'ARTICLE 3 - MODALITÉS DE DÉROULEMENT',\n      termsContent: 'La formation se déroulera selon les modalités définies dans le programme de formation. Les méthodes pédagogiques, les supports de cours et les modalités d\\'évaluation sont détaillés dans le programme remis au stagiaire.',\n      attendance: 'ARTICLE 4 - ASSIDUITÉ',\n      attendanceContent: 'Le stagiaire s\\'engage à suivre assidûment la formation. En cas d\\'absence non justifiée, l\\'organisme de formation se réserve le droit de refuser la délivrance de l\\'attestation de formation.',\n      cancellation: 'ARTICLE 5 - ANNULATION',\n      cancellationContent: 'En cas d\\'annulation par le stagiaire moins de 15 jours avant le début de la formation, des frais d\\'annulation pourront être appliqués. L\\'organisme de formation se réserve le droit d\\'annuler la formation en cas de nombre insuffisant de participants, avec remboursement intégral des sommes versées.',\n      signature: 'Signature et cachet',\n      doneAt: 'Fait à',\n      on: 'le',\n      inDuplicate: 'En double exemplaire',\n      for: 'Pour',\n      andAccept: 'et accepté',\n    },\n    en: {\n      title: 'INDIVIDUAL PROFESSIONAL TRAINING CONTRACT',\n      between: 'BETWEEN',\n      theOrganization: 'The training organization',\n      representedBy: 'represented by',\n      director: 'Director',\n      and: 'AND',\n      theTrainee: 'The trainee',\n      dateOfBirth: 'Born on',\n      address: 'Address',\n      email: 'Email',\n      phone: 'Phone',\n      studentNumber: 'Trainee number',\n      nationalId: 'ID number',\n      object: 'ARTICLE 1 - OBJECT',\n      contractObject: 'This contract defines the conditions under which',\n      willProvide: 'commits to provide the following professional training to the trainee',\n      program: 'Program',\n      formation: 'Training title',\n      session: 'Session',\n      dates: 'Training dates',\n      location: 'Training location',\n      duration: 'Duration',\n      hours: 'hours',\n      schedule: 'Schedule',\n      objectives: 'Learning objectives',\n      prerequisites: 'Prerequisites',\n      targetAudience: 'Target audience',\n      financial: 'ARTICLE 2 - FINANCIAL CONDITIONS',\n      price: 'Total training amount',\n      paid: 'Amount paid',\n      remaining: 'Remaining',\n      enrollmentDate: 'Enrollment date',\n      paymentMethod: 'Payment method',\n      paymentSchedule: 'Payment schedule',\n      terms: 'ARTICLE 3 - TRAINING MODALITIES',\n      termsContent: 'The training will be conducted according to the modalities defined in the training program. Teaching methods, course materials and assessment methods are detailed in the program provided to the trainee.',\n      attendance: 'ARTICLE 4 - ATTENDANCE',\n      attendanceContent: 'The trainee undertakes to attend the training regularly. In case of unjustified absence, the training organization reserves the right to refuse the issuance of the training certificate.',\n      cancellation: 'ARTICLE 5 - CANCELLATION',\n      cancellationContent: 'In case of cancellation by the trainee less than 15 days before the start of training, cancellation fees may apply. The training organization reserves the right to cancel the training in case of insufficient number of participants, with full refund of amounts paid.',\n      signature: 'Signature and stamp',\n      doneAt: 'Done at',\n      on: 'on',\n      inDuplicate: 'In duplicate',\n      for: 'For',\n      andAccept: 'and accepted',\n    },\n  }[lang]\n\n  return `\n    <div id=\"contract-document\" style=\"max-width: 210mm; margin: 0 auto; padding: 20mm; font-family: 'Times New Roman', serif; color: #000; line-height: 1.6;\">\n      {organization_logo && <div style=\"text-align: center; margin-bottom: 30px;\">\n        <img src=\"{organization_logo}\" alt=\"Logo\" style=\"max-height: 80px;\" />\n      </div>}\n      \n      <h1 style=\"text-align: center; font-size: 20px; font-weight: bold; margin-bottom: 40px; text-transform: uppercase; letter-spacing: 1px;\">\n        {title}\n      </h1>\n      \n      <div style=\"margin-bottom: 30px; border: 1px solid #000; padding: 15px;\">\n        <p style=\"font-weight: bold; margin-bottom: 15px; font-size: 14px;\">{between}</p>\n        \n        <div style=\"margin-bottom: 20px;\">\n          <p style=\"margin-bottom: 5px;\"><strong>{the_organization}</strong> : {organization_name}</p>\n          {IF organization_address}<p style=\"margin-left: 20px; margin-bottom: 3px;\">{organization_address}</p>{ENDIF}\n          {IF organization_phone}<p style=\"margin-left: 20px; margin-bottom: 3px;\">Tél: {organization_phone}</p>{ENDIF}\n          {IF organization_email}<p style=\"margin-left: 20px; margin-bottom: 3px;\">Email: {organization_email}</p>{ENDIF}\n          {IF organization_siret}<p style=\"margin-left: 20px; margin-bottom: 3px;\">SIRET: {organization_siret}</p>{ENDIF}\n          {IF organization_rcs}<p style=\"margin-left: 20px; margin-bottom: 3px;\">RCS: {organization_rcs}</p>{ENDIF}\n          {IF organization_vat_number}<p style=\"margin-left: 20px;\">N° TVA: {organization_vat_number}</p>{ENDIF}\n        </div>\n        \n        <p style=\"margin-top: 20px; margin-bottom: 15px;\"><strong>{and}</strong></p>\n        \n        <div>\n          <p style=\"margin-bottom: 5px;\"><strong>{the_trainee}</strong> : {student_first_name} {student_last_name}</p>\n          <div style=\"margin-left: 20px; margin-top: 10px;\">\n            {IF student_date_of_birth}<p style=\"margin-bottom: 3px;\">{date_of_birth}: {student_date_of_birth}</p>{ENDIF}\n            {IF student_address}<p style=\"margin-bottom: 3px;\">{address}: {student_address}</p>{ENDIF}\n            {IF student_email}<p style=\"margin-bottom: 3px;\">{email}: {student_email}</p>{ENDIF}\n            {IF student_phone}<p style=\"margin-bottom: 3px;\">{phone}: {student_phone}</p>{ENDIF}\n            {IF student_number}<p style=\"margin-bottom: 3px;\">{student_number_label}: {student_number}</p>{ENDIF}\n            {IF student_national_id}<p>{national_id}: {student_national_id}</p>{ENDIF}\n          </div>\n        </div>\n      </div>\n      \n      <div style=\"margin-top: 40px; margin-bottom: 30px;\">\n        <h2 style=\"font-size: 16px; font-weight: bold; margin-bottom: 15px; text-transform: uppercase; border-bottom: 2px solid #000; padding-bottom: 5px;\">\n          {object}\n        </h2>\n        <p style=\"line-height: 1.8; text-align: justify; margin-bottom: 15px;\">\n          {contract_object} <strong>{organization_name}</strong> {will_provide} :\n        </p>\n        <div style=\"margin-left: 30px; margin-top: 15px; line-height: 2;\">\n          {IF program_name}<p><strong>{program}:</strong> {program_name}</p>{ENDIF}\n          <p><strong>{formation}:</strong> {formation_name}{IF formation_code} (Code: {formation_code}){ENDIF}</p>\n          <p><strong>{session}:</strong> {session_name}</p>\n          <p><strong>{dates}:</strong> Du {session_start_date} au {session_end_date}</p>\n          {IF session_start_time && session_end_time}<p><strong>{schedule}:</strong> {session_start_time} - {session_end_time}</p>{ENDIF}\n          {IF session_location}<p><strong>{location}:</strong> {session_location}</p>{ENDIF}\n          {IF formation_duration_hours}<p><strong>{duration}:</strong> {formation_duration_hours} {hours}</p>{ENDIF}\n          {IF formation_objectives}<p style=\"margin-top: 10px;\"><strong>{objectives}:</strong> {formation_objectives}</p>{ENDIF}\n          {IF formation_prerequisites}<p><strong>{prerequisites}:</strong> {formation_prerequisites}</p>{ENDIF}\n          {IF formation_target_audience}<p><strong>{target_audience}:</strong> {formation_target_audience}</p>{ENDIF}\n        </div>\n      </div>\n      \n      <div style=\"margin-top: 40px; margin-bottom: 30px;\">\n        <h2 style=\"font-size: 16px; font-weight: bold; margin-bottom: 15px; text-transform: uppercase; border-bottom: 2px solid #000; padding-bottom: 5px;\">\n          {financial}\n        </h2>\n        <div style=\"margin-left: 20px; line-height: 2;\">\n          <p><strong>{price}:</strong> {total_amount_formatted} TTC</p>\n          <p><strong>{paid}:</strong> {paid_amount_formatted}</p>\n          <p><strong>{remaining}:</strong> {remaining_amount_formatted}</p>\n          <p><strong>{enrollment_date_label}:</strong> {enrollment_date}</p>\n          {IF payment_method}<p><strong>{payment_method_label}:</strong> {payment_method}</p>{ENDIF}\n          {IF payment_schedule}<p><strong>{payment_schedule_label}:</strong> {payment_schedule}</p>{ENDIF}\n        </div>\n      </div>\n      \n      <div style=\"margin-top: 40px; margin-bottom: 30px;\">\n        <h2 style=\"font-size: 16px; font-weight: bold; margin-bottom: 15px; text-transform: uppercase; border-bottom: 2px solid #000; padding-bottom: 5px;\">\n          {terms}\n        </h2>\n        <p style=\"line-height: 1.8; text-align: justify;\">\n          {terms_content}\n        </p>\n      </div>\n      \n      <div style=\"margin-top: 40px; margin-bottom: 30px;\">\n        <h2 style=\"font-size: 16px; font-weight: bold; margin-bottom: 15px; text-transform: uppercase; border-bottom: 2px solid #000; padding-bottom: 5px;\">\n          {attendance}\n        </h2>\n        <p style=\"line-height: 1.8; text-align: justify;\">\n          {attendance_content}\n        </p>\n      </div>\n      \n      <div style=\"margin-top: 40px; margin-bottom: 30px;\">\n        <h2 style=\"font-size: 16px; font-weight: bold; margin-bottom: 15px; text-transform: uppercase; border-bottom: 2px solid #000; padding-bottom: 5px;\">\n          {cancellation}\n        </h2>\n        <p style=\"line-height: 1.8; text-align: justify;\">\n          {cancellation_content}\n        </p>\n      </div>\n      \n      <div style=\"margin-top: 60px; display: flex; justify-content: space-between; page-break-inside: avoid;\">\n        <div style=\"width: 45%;\">\n          <p style=\"margin-bottom: 50px; font-weight: bold;\">{signature}</p>\n          <p style=\"border-top: 1px solid #000; padding-top: 5px; margin-top: 60px;\">_________________________</p>\n          <p style=\"margin-top: 5px; font-size: 11px;\">{organization_name}</p>\n          <p style=\"margin-top: 5px; font-size: 11px;\">{director}</p>\n        </div>\n        <div style=\"width: 45%;\">\n          <p style=\"margin-bottom: 50px; font-weight: bold;\">{signature}</p>\n          <p style=\"border-top: 1px solid #000; padding-top: 5px; margin-top: 60px;\">_________________________</p>\n          <p style=\"margin-top: 5px; font-size: 11px;\">{student_first_name} {student_last_name}</p>\n          <p style=\"margin-top: 5px; font-size: 11px;\">{the_trainee}</p>\n        </div>\n      </div>\n      \n      <div style=\"margin-top: 50px; text-align: center; font-size: 12px;\">\n        <p><strong>{done_at}</strong> {organization_address}, <strong>{on}</strong> <strong>{issue_date}</strong></p>\n        <p style=\"margin-top: 10px; font-style: italic;\">{in_duplicate}</p>\n      </div>\n    </div>\n  `\n}\n\n/**\n * Génère le HTML final pour un contrat particulier de formation professionnelle en utilisant les balises {variable}\n */\nexport async function generateContractHTML(data: {\n  student: {\n    first_name: string\n    last_name: string\n    email?: string\n    phone?: string\n    address?: string\n    date_of_birth?: string\n    student_number?: string\n    national_id?: string\n  }\n  session: {\n    name: string\n    start_date: string\n    end_date: string\n    location?: string\n    start_time?: string\n    end_time?: string\n  }\n  formation: {\n    name: string\n    code?: string\n    price?: number\n    duration_hours?: number\n    objectives?: string\n    prerequisites?: string\n    targetAudience?: string\n  }\n  program?: {\n    name: string\n  }\n  organization: {\n    name: string\n    address?: string\n    phone?: string\n    email?: string\n    logo_url?: string\n    siret?: string\n    rcs?: string\n    vat_number?: string\n  }\n  enrollment: {\n    enrollment_date: string\n    total_amount: number\n    paid_amount: number\n    payment_method?: string\n    payment_schedule?: string\n  }\n  issueDate: string\n  language?: 'fr' | 'en'\n  documentId?: string\n  organizationId?: string\n}): Promise<string> {\n  const lang = data.language || 'fr'\n  const t = {\n    fr: {\n      title: 'CONTRAT PARTICULIER DE FORMATION PROFESSIONNELLE',\n      between: 'ENTRE',\n      theOrganization: 'L\\'organisme de formation',\n      representedBy: 'représenté(e) par',\n      director: 'Directeur(trice)',\n      and: 'ET',\n      theTrainee: 'Le stagiaire',\n      dateOfBirth: 'Né(e) le',\n      address: 'Adresse',\n      email: 'Email',\n      phone: 'Téléphone',\n      studentNumber: 'N° stagiaire',\n      nationalId: 'N° pièce d\\'identité',\n      object: 'ARTICLE 1 - OBJET',\n      contractObject: 'La présente convention a pour objet de définir les conditions dans lesquelles',\n      willProvide: 's\\'engage à dispenser la formation professionnelle suivante au stagiaire',\n      program: 'Programme',\n      formation: 'Intitulé de la formation',\n      session: 'Session',\n      dates: 'Dates de formation',\n      location: 'Lieu de formation',\n      duration: 'Durée',\n      hours: 'heures',\n      schedule: 'Horaires',\n      objectives: 'Objectifs pédagogiques',\n      prerequisites: 'Prérequis',\n      targetAudience: 'Public visé',\n      financial: 'ARTICLE 2 - CONDITIONS FINANCIÈRES',\n      price: 'Montant total de la formation',\n      paid: 'Montant payé',\n      remaining: 'Reste à payer',\n      enrollmentDate: 'Date d\\'inscription',\n      paymentMethod: 'Mode de paiement',\n      paymentSchedule: 'Échéancier de paiement',\n      terms: 'ARTICLE 3 - MODALITÉS DE DÉROULEMENT',\n      termsContent: 'La formation se déroulera selon les modalités définies dans le programme de formation. Les méthodes pédagogiques, les supports de cours et les modalités d\\'évaluation sont détaillés dans le programme remis au stagiaire.',\n      attendance: 'ARTICLE 4 - ASSIDUITÉ',\n      attendanceContent: 'Le stagiaire s\\'engage à suivre assidûment la formation. En cas d\\'absence non justifiée, l\\'organisme de formation se réserve le droit de refuser la délivrance de l\\'attestation de formation.',\n      cancellation: 'ARTICLE 5 - ANNULATION',\n      cancellationContent: 'En cas d\\'annulation par le stagiaire moins de 15 jours avant le début de la formation, des frais d\\'annulation pourront être appliqués. L\\'organisme de formation se réserve le droit d\\'annuler la formation en cas de nombre insuffisant de participants, avec remboursement intégral des sommes versées.',\n      signature: 'Signature et cachet',\n      doneAt: 'Fait à',\n      on: 'le',\n      inDuplicate: 'En double exemplaire',\n      for: 'Pour',\n      andAccept: 'et accepté',\n    },\n    en: {\n      title: 'INDIVIDUAL PROFESSIONAL TRAINING CONTRACT',\n      between: 'BETWEEN',\n      theOrganization: 'The training organization',\n      representedBy: 'represented by',\n      director: 'Director',\n      and: 'AND',\n      theTrainee: 'The trainee',\n      dateOfBirth: 'Born on',\n      address: 'Address',\n      email: 'Email',\n      phone: 'Phone',\n      studentNumber: 'Trainee number',\n      nationalId: 'ID number',\n      object: 'ARTICLE 1 - OBJECT',\n      contractObject: 'This contract defines the conditions under which',\n      willProvide: 'commits to provide the following professional training to the trainee',\n      program: 'Program',\n      formation: 'Training title',\n      session: 'Session',\n      dates: 'Training dates',\n      location: 'Training location',\n      duration: 'Duration',\n      hours: 'hours',\n      schedule: 'Schedule',\n      objectives: 'Learning objectives',\n      prerequisites: 'Prerequisites',\n      targetAudience: 'Target audience',\n      financial: 'ARTICLE 2 - FINANCIAL CONDITIONS',\n      price: 'Total training amount',\n      paid: 'Amount paid',\n      remaining: 'Remaining',\n      enrollmentDate: 'Enrollment date',\n      paymentMethod: 'Payment method',\n      paymentSchedule: 'Payment schedule',\n      terms: 'ARTICLE 3 - TRAINING MODALITIES',\n      termsContent: 'The training will be conducted according to the modalities defined in the training program. Teaching methods, course materials and assessment methods are detailed in the program provided to the trainee.',\n      attendance: 'ARTICLE 4 - ATTENDANCE',\n      attendanceContent: 'The trainee undertakes to attend the training regularly. In case of unjustified absence, the training organization reserves the right to refuse the issuance of the training certificate.',\n      cancellation: 'ARTICLE 5 - CANCELLATION',\n      cancellationContent: 'In case of cancellation by the trainee less than 15 days before the start of training, cancellation fees may apply. The training organization reserves the right to cancel the training in case of insufficient number of participants, with full refund of amounts paid.',\n      signature: 'Signature and stamp',\n      doneAt: 'Done at',\n      on: 'on',\n      inDuplicate: 'In duplicate',\n      for: 'For',\n      andAccept: 'and accepted',\n    },\n  }[lang]\n  \n  const remaining = data.enrollment.total_amount - data.enrollment.paid_amount\n  \n  // Générer le template avec balises\n  const template = generateContractTemplate(data)\n  \n  // Préparer les variables pour le système de balises\n  const variables: any = {\n    organisation_logo: data.organization.logo_url || '',\n    title: t.title,\n    between: t.between,\n    the_organization: t.theOrganization,\n    organization_name: data.organization.name,\n    organization_address: data.organization.address || '',\n    organization_phone: data.organization.phone || '',\n    organization_email: data.organization.email || '',\n    organization_siret: data.organization.siret || '',\n    organization_rcs: data.organization.rcs || '',\n    organization_vat_number: data.organization.vat_number || '',\n    and: t.and,\n    the_trainee: t.theTrainee,\n    student_first_name: data.student.first_name,\n    student_last_name: data.student.last_name,\n    student_date_of_birth: data.student.date_of_birth ? formatDateForDocument(data.student.date_of_birth) : '',\n    date_of_birth: t.dateOfBirth,\n    address: t.address,\n    student_address: data.student.address || '',\n    email: t.email,\n    student_email: data.student.email || '',\n    phone: t.phone,\n    student_phone: data.student.phone || '',\n    student_number_label: t.studentNumber,\n    student_number: data.student.student_number || '',\n    national_id: t.nationalId,\n    student_national_id: data.student.national_id || '',\n    object: t.object,\n    contract_object: t.contractObject,\n    will_provide: t.willProvide,\n    program: t.program,\n    program_name: data.program?.name || '',\n    formation: t.formation,\n    formation_name: data.formation.name,\n    formation_code: data.formation.code || '',\n    session: t.session,\n    session_name: data.session.name,\n    dates: t.dates,\n    session_start_date: formatDateForDocument(data.session.start_date),\n    session_end_date: formatDateForDocument(data.session.end_date),\n    schedule: t.schedule,\n    session_start_time: data.session.start_time || '',\n    session_end_time: data.session.end_time || '',\n    location: t.location,\n    session_location: data.session.location || '',\n    duration: t.duration,\n    formation_duration_hours: data.formation.duration_hours || 0,\n    hours: t.hours,\n    objectives: t.objectives,\n    formation_objectives: data.formation.objectives || '',\n    prerequisites: t.prerequisites,\n    formation_prerequisites: data.formation.prerequisites || '',\n    target_audience: t.targetAudience,\n    formation_target_audience: data.formation.targetAudience || '',\n    financial: t.financial,\n    price: t.price,\n    total_amount_formatted: formatCurrency(data.enrollment.total_amount, 'EUR'),\n    paid: t.paid,\n    paid_amount_formatted: formatCurrency(data.enrollment.paid_amount, 'EUR'),\n    remaining: t.remaining,\n    remaining_amount_formatted: formatCurrency(remaining, 'EUR'),\n    enrollment_date_label: t.enrollmentDate,\n    enrollment_date: formatDateForDocument(data.enrollment.enrollment_date),\n    payment_method: data.enrollment.payment_method || '',\n    payment_method_label: t.paymentMethod,\n    payment_schedule: data.enrollment.payment_schedule || '',\n    payment_schedule_label: t.paymentSchedule,\n    terms: t.terms,\n    terms_content: t.termsContent,\n    attendance: t.attendance,\n    attendance_content: t.attendanceContent,\n    cancellation: t.cancellation,\n    cancellation_content: t.cancellationContent,\n    signature: t.signature,\n    director: t.director,\n    done_at: t.doneAt,\n    on: t.on,\n    issue_date: formatDateForDocument(data.issueDate),\n    in_duplicate: t.inDuplicate,\n  }\n  \n  // Traiter le template avec le système de génération HTML\n  return await processTemplateWithTags(template, variables, data.documentId, data.organizationId)\n}\n\n/**\n * Génère le template avec balises {variable} pour une convocation à une session de formation\n */\nfunction generateConvocationTemplate(data: {\n  student: {\n    first_name: string\n    last_name: string\n    email?: string\n    phone?: string\n  }\n  session: {\n    name: string\n    start_date: string\n    end_date: string\n    start_time?: string\n    end_time?: string\n    location?: string\n  }\n  formation: {\n    name: string\n    code?: string\n  }\n  program?: {\n    name: string\n  }\n  organization: {\n    name: string\n    address?: string\n    phone?: string\n    email?: string\n    logo_url?: string\n  }\n  issueDate: string\n  language?: 'fr' | 'en'\n}) {\n  const lang = data.language || 'fr'\n  const t = {\n    fr: {\n      title: 'CONVOCATION À UNE FORMATION',\n      dear: 'Madame, Monsieur',\n      weInform: 'Nous vous informons que vous êtes convoqué(e) à la session de formation suivante',\n      program: 'Programme',\n      formation: 'Formation',\n      session: 'Session',\n      dates: 'Dates',\n      times: 'Horaires',\n      location: 'Lieu',\n      contact: 'Pour toute information complémentaire, vous pouvez nous contacter',\n      seeYou: 'Nous vous prions d\\'agréer, Madame, Monsieur, l\\'expression de nos salutations distinguées.',\n      bestRegards: 'Cordialement',\n      signature: 'Signature et cachet',\n      doneAt: 'Fait à',\n      on: 'le',\n    },\n    en: {\n      title: 'TRAINING INVITATION',\n      dear: 'Dear Sir/Madam',\n      weInform: 'We inform you that you are invited to the following training session',\n      program: 'Program',\n      formation: 'Training',\n      session: 'Session',\n      dates: 'Dates',\n      times: 'Schedule',\n      location: 'Location',\n      contact: 'For any additional information, you can contact us',\n      seeYou: 'Yours sincerely',\n      bestRegards: 'Best regards',\n      signature: 'Signature and stamp',\n      doneAt: 'Done at',\n      on: 'on',\n    },\n  }[lang]\n\n  return `\n    <div id=\"convocation-document\" style=\"max-width: 210mm; margin: 0 auto; padding: 20mm; font-family: Arial, sans-serif; color: #000;\">\n      {organization_logo && <div style=\"text-align: center; margin-bottom: 30px;\">\n        <img src=\"{organization_logo}\" alt=\"Logo\" style=\"max-height: 80px;\" />\n      </div>}\n      \n      <h1 style=\"text-align: center; font-size: 24px; font-weight: bold; margin-bottom: 40px; text-transform: uppercase;\">\n        {title}\n      </h1>\n      \n      <div style=\"margin-bottom: 30px;\">\n        <p><strong>{organization_name}</strong></p>\n        {IF organization_address}<p>{organization_address}</p>{ENDIF}\n        {IF organization_phone}<p>Tél: {organization_phone}</p>{ENDIF}\n        {IF organization_email}<p>Email: {organization_email}</p>{ENDIF}\n      </div>\n      \n      <div style=\"margin-top: 40px; margin-bottom: 30px;\">\n        <p style=\"margin-bottom: 10px;\"><strong>{student_first_name} {student_last_name}</strong></p>\n        {IF student_email}<p>{student_email}</p>{ENDIF}\n        {IF student_phone}<p>{student_phone}</p>{ENDIF}\n      </div>\n      \n      <div style=\"margin-top: 40px; line-height: 1.8;\">\n        <p style=\"margin-bottom: 20px;\">{dear},</p>\n        <p style=\"text-align: justify; margin-bottom: 30px;\">\n          {we_inform} :\n        </p>\n        \n        <div style=\"margin-left: 30px; margin-top: 20px; padding: 20px; background-color: #f9fafb; border-radius: 8px;\">\n          {IF program_name}<p><strong>{program}:</strong> {program_name}</p>{ENDIF}\n          <p><strong>{formation}:</strong> {formation_name}{IF formation_code} ({formation_code}){ENDIF}</p>\n          <p><strong>{session}:</strong> {session_name}</p>\n          <p><strong>{dates}:</strong> {session_start_date} - {session_end_date}</p>\n          {IF session_start_time && session_end_time}<p><strong>{times}:</strong> {session_start_time} - {session_end_time}</p>{ENDIF}\n          {IF session_location}<p><strong>{location}:</strong> {session_location}</p>{ENDIF}\n        </div>\n        \n        <p style=\"margin-top: 30px; text-align: justify;\">\n          {contact} :\n        </p>\n        <div style=\"margin-left: 30px; margin-top: 10px;\">\n          {IF organization_phone}<p>Téléphone: {organization_phone}</p>{ENDIF}\n          {IF organization_email}<p>Email: {organization_email}</p>{ENDIF}\n        </div>\n        \n        <p style=\"margin-top: 40px; text-align: justify;\">\n          {see_you}\n        </p>\n        \n        <p style=\"margin-top: 30px;\">\n          {best_regards}\n        </p>\n      </div>\n      \n      <div style=\"margin-top: 60px; text-align: right;\">\n        <p style=\"margin-bottom: 40px;\">{signature}</p>\n        <p>_________________________</p>\n        <p style=\"margin-top: 5px; font-size: 12px;\">{organization_name}</p>\n      </div>\n      \n      <div style=\"margin-top: 40px; text-align: center;\">\n        <p>{done_at} <strong>{organization_address}</strong>, {on} <strong>{issue_date}</strong></p>\n      </div>\n    </div>\n  `\n}\n\n/**\n * Génère le HTML final pour une convocation à une session de formation en utilisant les balises {variable}\n */\nexport async function generateConvocationHTML(data: {\n  student: {\n    first_name: string\n    last_name: string\n    email?: string\n    phone?: string\n  }\n  session: {\n    name: string\n    start_date: string\n    end_date: string\n    start_time?: string\n    end_time?: string\n    location?: string\n  }\n  formation: {\n    name: string\n    code?: string\n  }\n  program?: {\n    name: string\n  }\n  organization: {\n    name: string\n    address?: string\n    phone?: string\n    email?: string\n    logo_url?: string\n  }\n  issueDate: string\n  language?: 'fr' | 'en'\n  documentId?: string\n  organizationId?: string\n}): Promise<string> {\n  const lang = data.language || 'fr'\n  const t = {\n    fr: {\n      title: 'CONVOCATION À UNE FORMATION',\n      dear: 'Madame, Monsieur',\n      weInform: 'Nous vous informons que vous êtes convoqué(e) à la session de formation suivante',\n      program: 'Programme',\n      formation: 'Formation',\n      session: 'Session',\n      dates: 'Dates',\n      times: 'Horaires',\n      location: 'Lieu',\n      contact: 'Pour toute information complémentaire, vous pouvez nous contacter',\n      seeYou: 'Nous vous prions d\\'agréer, Madame, Monsieur, l\\'expression de nos salutations distinguées.',\n      bestRegards: 'Cordialement',\n      signature: 'Signature et cachet',\n      doneAt: 'Fait à',\n      on: 'le',\n    },\n    en: {\n      title: 'TRAINING INVITATION',\n      dear: 'Dear Sir/Madam',\n      weInform: 'We inform you that you are invited to the following training session',\n      program: 'Program',\n      formation: 'Training',\n      session: 'Session',\n      dates: 'Dates',\n      times: 'Schedule',\n      location: 'Location',\n      contact: 'For any additional information, you can contact us',\n      seeYou: 'Yours sincerely',\n      bestRegards: 'Best regards',\n      signature: 'Signature and stamp',\n      doneAt: 'Done at',\n      on: 'on',\n    },\n  }[lang]\n  \n  // Générer le template avec balises\n  const template = generateConvocationTemplate(data)\n  \n  // Préparer les variables pour le système de balises\n  const variables: any = {\n    organisation_logo: data.organization.logo_url || '',\n    title: t.title,\n    organization_name: data.organization.name,\n    organization_address: data.organization.address || '',\n    organization_phone: data.organization.phone || '',\n    organization_email: data.organization.email || '',\n    student_first_name: data.student.first_name,\n    student_last_name: data.student.last_name,\n    student_email: data.student.email || '',\n    student_phone: data.student.phone || '',\n    dear: t.dear,\n    we_inform: t.weInform,\n    program: t.program,\n    program_name: data.program?.name || '',\n    formation: t.formation,\n    formation_name: data.formation.name,\n    formation_code: data.formation.code || '',\n    session: t.session,\n    session_name: data.session.name,\n    dates: t.dates,\n    session_start_date: formatDateForDocument(data.session.start_date),\n    session_end_date: formatDateForDocument(data.session.end_date),\n    times: t.times,\n    session_start_time: data.session.start_time || '',\n    session_end_time: data.session.end_time || '',\n    location: t.location,\n    session_location: data.session.location || '',\n    contact: t.contact,\n    see_you: t.seeYou,\n    best_regards: t.bestRegards,\n    signature: t.signature,\n    done_at: t.doneAt,\n    on: t.on,\n    issue_date: formatDateForDocument(data.issueDate),\n  }\n  \n  // Traiter le template avec le système de génération HTML\n  return await processTemplateWithTags(template, variables, data.documentId, data.organizationId)\n}\n\n/**\n * Génère le template avec balises {variable} pour un document de programme de formation\n */\nfunction generateProgramTemplate(data: {\n  program: {\n    name: string\n    description?: string\n  }\n  formation: {\n    name: string\n    code?: string\n    subtitle?: string\n    duration_hours?: number\n    objectives?: string\n    content?: string\n    learner_profile?: string\n  }\n  organization: {\n    name: string\n    address?: string\n    phone?: string\n    email?: string\n    logo_url?: string\n  }\n  issueDate: string\n  language?: 'fr' | 'en'\n}) {\n  const lang = data.language || 'fr'\n  const t = {\n    fr: {\n      title: 'PROGRAMME DE FORMATION',\n      subtitle: 'Description du programme',\n      program: 'Programme',\n      formation: 'Formation',\n      code: 'Code',\n      duration: 'Durée',\n      hours: 'heures',\n      objectives: 'Objectifs pédagogiques',\n      content: 'Contenu de la formation',\n      learnerProfile: 'Profil des apprenants',\n      doneAt: 'Fait à',\n      on: 'le',\n    },\n    en: {\n      title: 'TRAINING PROGRAM',\n      subtitle: 'Program description',\n      program: 'Program',\n      formation: 'Training',\n      code: 'Code',\n      duration: 'Duration',\n      hours: 'hours',\n      objectives: 'Pedagogical objectives',\n      content: 'Training content',\n      learnerProfile: 'Learner profile',\n      doneAt: 'Done at',\n      on: 'on',\n    },\n  }[lang]\n\n  return `\n    <div id=\"program-document\" style=\"max-width: 210mm; margin: 0 auto; padding: 15mm; font-family: Arial, sans-serif; color: #000; line-height: 1.6;\">\n      {organization_logo && <div style=\"text-align: center; margin-bottom: 30px;\">\n        <img src=\"{organization_logo}\" alt=\"Logo\" style=\"max-height: 80px;\" />\n      </div>}\n\n      <h1 style=\"text-align: center; font-size: 28px; font-weight: bold; margin-bottom: 10px; text-transform: uppercase; color: #1e40af;\">\n        {title}\n      </h1>\n      <p style=\"text-align: center; font-size: 14px; color: #6b7280; margin-bottom: 40px;\">\n        {subtitle}\n      </p>\n\n      <div style=\"margin-bottom: 30px; padding: 20px; background-color: #f9fafb; border-radius: 8px; border-left: 4px solid #1e40af;\">\n        <h2 style=\"font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #1e40af;\">\n          {program}: {program_name}\n        </h2>\n        {IF program_description}<p style=\"margin-top: 10px; color: #374151;\">{program_description}</p>{ENDIF}\n      </div>\n\n      <div style=\"margin-bottom: 30px;\">\n        <h2 style=\"font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #1e40af;\">\n          {formation}: {formation_name}\n        </h2>\n        {IF formation_subtitle}<p style=\"font-size: 16px; color: #6b7280; margin-bottom: 10px;\">{formation_subtitle}</p>{ENDIF}\n        {IF formation_code}<p style=\"margin-top: 10px;\"><strong>{code}:</strong> {formation_code}</p>{ENDIF}\n        {IF formation_duration_hours}<p style=\"margin-top: 10px;\"><strong>{duration}:</strong> {formation_duration_hours} {hours}</p>{ENDIF}\n      </div>\n\n      {IF formation_objectives}<div style=\"margin-bottom: 30px;\">\n        <h3 style=\"font-size: 16px; font-weight: bold; margin-bottom: 10px; color: #1e40af;\">\n          {objectives}\n        </h3>\n        <div style=\"white-space: pre-wrap; color: #374151;\">{formation_objectives}</div>\n      </div>{ENDIF}\n\n      {IF formation_content}<div style=\"margin-bottom: 30px;\">\n        <h3 style=\"font-size: 16px; font-weight: bold; margin-bottom: 10px; color: #1e40af;\">\n          {content}\n        </h3>\n        <div style=\"white-space: pre-wrap; color: #374151;\">{formation_content}</div>\n      </div>{ENDIF}\n\n      {IF formation_learner_profile}<div style=\"margin-bottom: 30px;\">\n        <h3 style=\"font-size: 16px; font-weight: bold; margin-bottom: 10px; color: #1e40af;\">\n          {learner_profile}\n        </h3>\n        <div style=\"white-space: pre-wrap; color: #374151;\">{formation_learner_profile}</div>\n      </div>{ENDIF}\n\n      <div style=\"margin-top: 40px; padding-top: 20px; border-top: 2px solid #e5e7eb;\">\n        <p style=\"font-size: 12px; color: #6b7280; margin-bottom: 10px;\">\n          <strong>{organization_name}</strong>\n        </p>\n        {IF organization_address}<p style=\"font-size: 12px; color: #6b7280;\">{organization_address}</p>{ENDIF}\n        {IF organization_phone}<p style=\"font-size: 12px; color: #6b7280;\">Tél: {organization_phone}</p>{ENDIF}\n        {IF organization_email}<p style=\"font-size: 12px; color: #6b7280;\">Email: {organization_email}</p>{ENDIF}\n        <p style=\"font-size: 12px; color: #6b7280; margin-top: 20px;\">\n          {done_at} <strong>{organization_address}</strong>, {on} <strong>{issue_date}</strong>\n        </p>\n      </div>\n    </div>\n  `\n}\n\n/**\n * Génère le HTML final pour un document de programme de formation en utilisant les balises {variable}\n */\nexport async function generateProgramHTML(data: {\n  program: {\n    name: string\n    description?: string\n  }\n  formation: {\n    name: string\n    code?: string\n    subtitle?: string\n    duration_hours?: number\n    objectives?: string\n    content?: string\n    learner_profile?: string\n  }\n  organization: {\n    name: string\n    address?: string\n    phone?: string\n    email?: string\n    logo_url?: string\n  }\n  issueDate: string\n  language?: 'fr' | 'en'\n  documentId?: string\n  organizationId?: string\n}): Promise<string> {\n  const lang = data.language || 'fr'\n  const t = {\n    fr: {\n      title: 'PROGRAMME DE FORMATION',\n      subtitle: 'Description du programme',\n      program: 'Programme',\n      formation: 'Formation',\n      code: 'Code',\n      duration: 'Durée',\n      hours: 'heures',\n      objectives: 'Objectifs pédagogiques',\n      content: 'Contenu de la formation',\n      learnerProfile: 'Profil des apprenants',\n      doneAt: 'Fait à',\n      on: 'le',\n    },\n    en: {\n      title: 'TRAINING PROGRAM',\n      subtitle: 'Program description',\n      program: 'Program',\n      formation: 'Training',\n      code: 'Code',\n      duration: 'Duration',\n      hours: 'hours',\n      objectives: 'Pedagogical objectives',\n      content: 'Training content',\n      learnerProfile: 'Learner profile',\n      doneAt: 'Done at',\n      on: 'on',\n    },\n  }[lang]\n  \n  // Générer le template avec balises\n  const template = generateProgramTemplate(data)\n  \n  // Préparer les variables pour le système de balises\n  const variables: any = {\n    organisation_logo: data.organization.logo_url || '',\n    title: t.title,\n    subtitle: t.subtitle,\n    program: t.program,\n    program_name: data.program.name,\n    program_description: data.program.description || '',\n    formation: t.formation,\n    formation_name: data.formation.name,\n    formation_subtitle: data.formation.subtitle || '',\n    code: t.code,\n    formation_code: data.formation.code || '',\n    duration: t.duration,\n    formation_duration_hours: data.formation.duration_hours || 0,\n    hours: t.hours,\n    objectives: t.objectives,\n    formation_objectives: data.formation.objectives || '',\n    content: t.content,\n    formation_content: data.formation.content || '',\n    learner_profile: t.learnerProfile,\n    formation_learner_profile: data.formation.learner_profile || '',\n    organization_name: data.organization.name,\n    organization_address: data.organization.address || '',\n    organization_phone: data.organization.phone || '',\n    organization_email: data.organization.email || '',\n    done_at: t.doneAt,\n    on: t.on,\n    issue_date: formatDateForDocument(data.issueDate),\n  }\n  \n  // Traiter le template avec le système de génération HTML\n  return await processTemplateWithTags(template, variables, data.documentId, data.organizationId)\n}\n\n/**\n * Génère le template avec balises {variable} pour les Conditions Générales de Vente (CGV)\n */\nfunction generateTermsTemplate(data: {\n  organization: {\n    name: string\n    address?: string\n    phone?: string\n    email?: string\n    logo_url?: string\n  }\n  issueDate: string\n  language?: 'fr' | 'en'\n}) {\n  const lang = data.language || 'fr'\n  const t = {\n    fr: {\n      title: 'CONDITIONS GÉNÉRALES DE VENTE',\n      subtitle: 'CGV',\n      intro: 'Les présentes Conditions Générales de Vente régissent les relations entre',\n      and: 'et les clients pour tous les services de formation proposés.',\n      doneAt: 'Fait à',\n      on: 'le',\n    },\n    en: {\n      title: 'TERMS AND CONDITIONS',\n      subtitle: 'T&C',\n      intro: 'These Terms and Conditions govern the relationship between',\n      and: 'and customers for all training services offered.',\n      doneAt: 'Done at',\n      on: 'on',\n    },\n  }[lang]\n\n  return `\n    <div id=\"terms-document\" style=\"max-width: 210mm; margin: 0 auto; padding: 15mm; font-family: Arial, sans-serif; color: #000; line-height: 1.6;\">\n      {organization_logo && <div style=\"text-align: center; margin-bottom: 30px;\">\n        <img src=\"{organization_logo}\" alt=\"Logo\" style=\"max-height: 80px;\" />\n      </div>}\n\n      <h1 style=\"text-align: center; font-size: 28px; font-weight: bold; margin-bottom: 10px; text-transform: uppercase; color: #1e40af;\">\n        {title}\n      </h1>\n      <p style=\"text-align: center; font-size: 14px; color: #6b7280; margin-bottom: 40px;\">\n        {subtitle}\n      </p>\n\n      <div style=\"margin-bottom: 30px;\">\n        <p style=\"margin-bottom: 20px; text-align: justify;\">\n          {intro} <strong>{organization_name}</strong> {and}\n        </p>\n      </div>\n\n      <div style=\"margin-top: 40px; padding-top: 20px; border-top: 2px solid #e5e7eb;\">\n        <p style=\"font-size: 12px; color: #6b7280; margin-bottom: 10px;\">\n          <strong>{organization_name}</strong>\n        </p>\n        {IF organization_address}<p style=\"font-size: 12px; color: #6b7280;\">{organization_address}</p>{ENDIF}\n        {IF organization_phone}<p style=\"font-size: 12px; color: #6b7280;\">Tél: {organization_phone}</p>{ENDIF}\n        {IF organization_email}<p style=\"font-size: 12px; color: #6b7280;\">Email: {organization_email}</p>{ENDIF}\n        <p style=\"font-size: 12px; color: #6b7280; margin-top: 20px;\">\n          {done_at} <strong>{organization_address}</strong>, {on} <strong>{issue_date}</strong>\n        </p>\n      </div>\n    </div>\n  `\n}\n\n/**\n * Génère le HTML final pour les Conditions Générales de Vente (CGV) en utilisant les balises {variable}\n */\nexport async function generateTermsHTML(data: {\n  organization: {\n    name: string\n    address?: string\n    phone?: string\n    email?: string\n    logo_url?: string\n  }\n  issueDate: string\n  language?: 'fr' | 'en'\n  documentId?: string\n  organizationId?: string\n}): Promise<string> {\n  const lang = data.language || 'fr'\n  const t = {\n    fr: {\n      title: 'CONDITIONS GÉNÉRALES DE VENTE',\n      subtitle: 'CGV',\n      intro: 'Les présentes Conditions Générales de Vente régissent les relations entre',\n      and: 'et les clients pour tous les services de formation proposés.',\n      doneAt: 'Fait à',\n      on: 'le',\n    },\n    en: {\n      title: 'TERMS AND CONDITIONS',\n      subtitle: 'T&C',\n      intro: 'These Terms and Conditions govern the relationship between',\n      and: 'and customers for all training services offered.',\n      doneAt: 'Done at',\n      on: 'on',\n    },\n  }[lang]\n  \n  // Générer le template avec balises\n  const template = generateTermsTemplate(data)\n  \n  // Préparer les variables pour le système de balises\n  const variables: any = {\n    organisation_logo: data.organization.logo_url || '',\n    title: t.title,\n    subtitle: t.subtitle,\n    intro: t.intro,\n    organization_name: data.organization.name,\n    and: t.and,\n    organization_address: data.organization.address || '',\n    organization_phone: data.organization.phone || '',\n    organization_email: data.organization.email || '',\n    done_at: t.doneAt,\n    on: t.on,\n    issue_date: formatDateForDocument(data.issueDate),\n  }\n  \n  // Traiter le template avec le système de génération HTML\n  return await processTemplateWithTags(template, variables, data.documentId, data.organizationId)\n}\n\n/**\n * Génère le template avec balises {variable} pour la Politique de Confidentialité\n */\nfunction generatePrivacyPolicyTemplate(data: {\n  organization: {\n    name: string\n    address?: string\n    phone?: string\n    email?: string\n    logo_url?: string\n  }\n  issueDate: string\n  language?: 'fr' | 'en'\n}) {\n  const lang = data.language || 'fr'\n  const t = {\n    fr: {\n      title: 'POLITIQUE DE CONFIDENTIALITÉ',\n      subtitle: 'Protection des données personnelles',\n      intro: 'La présente Politique de Confidentialité décrit comment',\n      collects: 'collecte, utilise et protège vos données personnelles.',\n      doneAt: 'Fait à',\n      on: 'le',\n    },\n    en: {\n      title: 'PRIVACY POLICY',\n      subtitle: 'Personal data protection',\n      intro: 'This Privacy Policy describes how',\n      collects: 'collects, uses and protects your personal data.',\n      doneAt: 'Done at',\n      on: 'on',\n    },\n  }[lang]\n\n  return `\n    <div id=\"privacy-policy-document\" style=\"max-width: 210mm; margin: 0 auto; padding: 15mm; font-family: Arial, sans-serif; color: #000; line-height: 1.6;\">\n      {organization_logo && <div style=\"text-align: center; margin-bottom: 30px;\">\n        <img src=\"{organization_logo}\" alt=\"Logo\" style=\"max-height: 80px;\" />\n      </div>}\n\n      <h1 style=\"text-align: center; font-size: 28px; font-weight: bold; margin-bottom: 10px; text-transform: uppercase; color: #1e40af;\">\n        {title}\n      </h1>\n      <p style=\"text-align: center; font-size: 14px; color: #6b7280; margin-bottom: 40px;\">\n        {subtitle}\n      </p>\n\n      <div style=\"margin-bottom: 30px;\">\n        <p style=\"margin-bottom: 20px; text-align: justify;\">\n          {intro} <strong>{organization_name}</strong> {collects}\n        </p>\n      </div>\n\n      <div style=\"margin-top: 40px; padding-top: 20px; border-top: 2px solid #e5e7eb;\">\n        <p style=\"font-size: 12px; color: #6b7280; margin-bottom: 10px;\">\n          <strong>{organization_name}</strong>\n        </p>\n        {IF organization_address}<p style=\"font-size: 12px; color: #6b7280;\">{organization_address}</p>{ENDIF}\n        {IF organization_phone}<p style=\"font-size: 12px; color: #6b7280;\">Tél: {organization_phone}</p>{ENDIF}\n        {IF organization_email}<p style=\"font-size: 12px; color: #6b7280;\">Email: {organization_email}</p>{ENDIF}\n        <p style=\"font-size: 12px; color: #6b7280; margin-top: 20px;\">\n          {done_at} <strong>{organization_address}</strong>, {on} <strong>{issue_date}</strong>\n        </p>\n      </div>\n    </div>\n  `\n}\n\n/**\n * Génère le HTML final pour la Politique de Confidentialité en utilisant les balises {variable}\n */\nexport async function generatePrivacyPolicyHTML(data: {\n  organization: {\n    name: string\n    address?: string\n    phone?: string\n    email?: string\n    logo_url?: string\n  }\n  issueDate: string\n  language?: 'fr' | 'en'\n  documentId?: string\n  organizationId?: string\n}): Promise<string> {\n  const lang = data.language || 'fr'\n  const t = {\n    fr: {\n      title: 'POLITIQUE DE CONFIDENTIALITÉ',\n      subtitle: 'Protection des données personnelles',\n      intro: 'La présente Politique de Confidentialité décrit comment',\n      collects: 'collecte, utilise et protège vos données personnelles.',\n      doneAt: 'Fait à',\n      on: 'le',\n    },\n    en: {\n      title: 'PRIVACY POLICY',\n      subtitle: 'Personal data protection',\n      intro: 'This Privacy Policy describes how',\n      collects: 'collects, uses and protects your personal data.',\n      doneAt: 'Done at',\n      on: 'on',\n    },\n  }[lang]\n  \n  // Générer le template avec balises\n  const template = generatePrivacyPolicyTemplate(data)\n  \n  // Préparer les variables pour le système de balises\n  const variables: any = {\n    organisation_logo: data.organization.logo_url || '',\n    title: t.title,\n    subtitle: t.subtitle,\n    intro: t.intro,\n    organization_name: data.organization.name,\n    collects: t.collects,\n    organization_address: data.organization.address || '',\n    organization_phone: data.organization.phone || '',\n    organization_email: data.organization.email || '',\n    done_at: t.doneAt,\n    on: t.on,\n    issue_date: formatDateForDocument(data.issueDate),\n  }\n  \n  // Traiter le template avec le système de génération HTML\n  return await processTemplateWithTags(template, variables, data.documentId, data.organizationId)\n}\n\n/**\n * Fonction helper pour traiter un template avec balises {variable} et générer le HTML final\n * Utilise le système de génération HTML avancé pour traiter les balises conditionnelles, boucles, etc.\n * \n * Note: Cette fonction doit être utilisée avec les templates convertis qui utilisent les balises {variable}\n * au lieu des template literals JavaScript ${variable}\n */\nexport async function processTemplateWithTags(\n  templateContent: string,\n  variables: DocumentVariables,\n  documentId?: string,\n  organizationId?: string\n): Promise<string> {\n  // Créer un template minimal pour le système de génération HTML\n  const template: any = {\n    id: documentId || 'temp',\n    name: 'Template',\n    type: 'convention', // Type par défaut\n    content: {\n      pageSize: 'A4',\n      margins: {\n        top: 20,\n        right: 20,\n        bottom: 20,\n        left: 20,\n      },\n      elements: [\n        {\n          type: 'html',\n          html: templateContent,\n        },\n      ],\n    } as any,\n    header: null,\n    footer: null,\n    header_enabled: false,\n    footer_enabled: false,\n    created_at: new Date().toISOString(),\n    updated_at: new Date().toISOString(),\n    organization_id: organizationId || '',\n  }\n\n  // Utiliser le système de génération HTML pour traiter le template\n  const result = await generateHTML(template, variables, documentId, organizationId)\n  \n  return result.html\n}\n"],"names":[],"mappings":"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"}