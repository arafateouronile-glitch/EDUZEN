module.exports=[31036,a=>{"use strict";var b=a.i(187924),c=a.i(572131),d=a.i(433217),e=a.i(370025),f=a.i(937927),g=a.i(913216),h=a.i(269240);let i=new class{supabase;constructor(a){this.supabase=a||(0,h.createClient)()}async getReports(a){try{let{data:b,error:c}=await this.supabase.from("bpf_reports").select("*").eq("organization_id",a).order("year",{ascending:!1});if(c){if(this.is404Error(c))return console.warn("[BPF] Reports table does not exist yet"),[];throw c}return b||[]}catch(a){if(this.is404Error(a))return[];throw a}}async getReport(a){let{data:b,error:c}=await this.supabase.from("bpf_reports").select("*").eq("id",a).maybeSingle();if(c)throw c;return b}async getReportByYear(a,b){let{data:c,error:d}=await this.supabase.from("bpf_reports").select("*").eq("organization_id",a).eq("year",b).maybeSingle();if(d&&!this.is404Error(d))throw d;return c}async createReport(a,b){if(await this.getReportByYear(a,b))throw Error(`Un rapport existe d\xe9j\xe0 pour l'ann\xe9e ${b}`);let c=await this.calculateMetrics(a,b),d={organization_id:a,year:b,status:"draft",...c},{data:e,error:f}=await this.supabase.from("bpf_reports").insert(d).select().single();if(f)throw f;return e}async updateReport(a,b){let c={...b};delete c.id,delete c.created_at,delete c.updated_at;let{data:d,error:e}=await this.supabase.from("bpf_reports").update(c).eq("id",a).select().single();if(e)throw e;return d}async submitReport(a,b){return await this.updateReport(a,{status:"submitted",submitted_at:new Date().toISOString(),submitted_by:b})}async calculateMetrics(a,b){try{let{data:c,error:d}=await this.supabase.rpc("calculate_bpf_metrics",{org_id:a,year_val:b});if(d)return console.warn("[BPF] Could not calculate metrics automatically:",d.message),this.getDefaultMetrics();return c||this.getDefaultMetrics()}catch(a){return console.warn("[BPF] Error calculating metrics:",a),this.getDefaultMetrics()}}async getTrainingDomains(a){try{let{data:b,error:c}=await this.supabase.from("bpf_training_domains").select("*").eq("bpf_report_id",a).order("revenue",{ascending:!1});if(c){if(this.is404Error(c))return[];throw c}return b||[]}catch(a){if(this.is404Error(a))return[];throw a}}async addTrainingDomain(a){let{data:b,error:c}=await this.supabase.from("bpf_training_domains").insert(a).select().single();if(c)throw c;return b}getDefaultMetrics(){return{total_revenue:0,revenue_cpf:0,revenue_opco:0,revenue_companies:0,revenue_individuals:0,revenue_pole_emploi:0,revenue_regions:0,revenue_state:0,revenue_other:0,total_students:0,students_men:0,students_women:0,students_under_26:0,students_over_45:0,students_disabled:0,total_training_hours:0,total_trainee_hours:0,total_programs:0,total_sessions:0,total_trainers:0,permanent_trainers:0,freelance_trainers:0,trainer_hours:0,training_locations:0,owned_locations:0,rented_locations:0,total_capacity:0,subcontracting_amount:0}}is404Error(a){return a?.code==="PGRST116"||a?.code==="42P01"||a?.code==="PGRST301"||a?.status===404||a?.message?.includes("relation")||a?.message?.includes("does not exist")}};var j=a.i(703130),k=a.i(340695),l=a.i(254161),m=a.i(864037),n=a.i(255225),o=a.i(915618),p=a.i(104720),q=a.i(284505),r=a.i(692759),s=a.i(495756),t=a.i(641710),u=a.i(290821),v=a.i(660246),w=a.i(790166),x=a.i(953722),y=a.i(238246);function z(){let{user:a}=(0,g.useAuth)(),h=(0,f.useQueryClient)(),{addToast:z}=(0,m.useToast)(),[A,B]=(0,c.useState)(new Date().getFullYear()-1),{data:C=[],isLoading:D}=(0,d.useQuery)({queryKey:["bpf-reports",a?.organization_id],queryFn:async()=>a?.organization_id?await i.getReports(a.organization_id):[],enabled:!!a?.organization_id,retry:!1}),E=(0,e.useMutation)({mutationFn:async b=>{if(!a?.organization_id)throw Error("Organization ID required");return await i.createReport(a.organization_id,b)},onSuccess:()=>{h.invalidateQueries({queryKey:["bpf-reports"]}),z({type:"success",title:"Rapport BPF créé",description:`Le rapport pour l'ann\xe9e ${A} a \xe9t\xe9 cr\xe9\xe9 avec succ\xe8s.`})},onError:a=>{z({type:"error",title:"Erreur",description:a?.message||"Impossible de créer le rapport BPF."})}}),F={draft:"bg-gray-100 text-gray-800",in_progress:"bg-blue-100 text-blue-800",completed:"bg-green-100 text-green-800",submitted:"bg-purple-100 text-purple-800"},G={draft:t.Clock,in_progress:u.AlertCircle,completed:s.CheckCircle,submitted:r.Send},H={draft:"Brouillon",in_progress:"En cours",completed:"Complété",submitted:"Soumis"},I=a=>new Intl.NumberFormat("fr-FR").format(a);return a?(0,b.jsxs)("div",{className:"p-6 space-y-8 animate-in fade-in duration-500",children:[(0,b.jsxs)("div",{className:"flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6",children:[(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsxs)("div",{className:"inline-flex items-center gap-3 mb-2",children:[(0,b.jsx)("div",{className:"p-2.5 bg-gradient-to-br from-brand-blue to-brand-cyan rounded-xl shadow-lg",children:(0,b.jsx)(n.BarChart3,{className:"h-7 w-7 text-white"})}),(0,b.jsx)("h1",{className:"text-3xl lg:text-4xl font-bold bg-gradient-to-r from-brand-blue to-brand-cyan bg-clip-text text-transparent",children:"Bilan Pédagogique et Financier"})]}),(0,b.jsx)("p",{className:"text-muted-foreground text-sm lg:text-base max-w-2xl",children:"Gérez vos rapports annuels obligatoires pour les Organismes de Formation de manière simple et efficace"})]}),(0,b.jsxs)("div",{className:"flex flex-col sm:flex-row items-stretch sm:items-center gap-3",children:[(0,b.jsx)("select",{value:A,onChange:a=>B(parseInt(a.target.value)),className:"px-4 py-2.5 border-2 border-input rounded-xl focus:ring-2 focus:ring-primary focus:border-primary transition-all bg-background hover:bg-accent/5 text-sm font-medium",children:Array.from({length:5},(a,b)=>new Date().getFullYear()-b).map(a=>(0,b.jsxs)("option",{value:a,children:["Année ",a]},a))}),(0,b.jsxs)(k.Button,{onClick:()=>E.mutate(A),disabled:E.isPending,className:"shadow-md hover:shadow-lg transition-all",children:[(0,b.jsx)(o.Plus,{className:"h-4 w-4 mr-2"}),"Créer rapport ",A]})]})]}),(0,b.jsx)(j.Card,{className:"border-brand-blue/20 bg-gradient-to-br from-brand-blue-ghost to-brand-cyan-ghost backdrop-blur-sm shadow-sm hover:shadow-md transition-all duration-300",children:(0,b.jsx)(j.CardContent,{className:"p-6",children:(0,b.jsxs)("div",{className:"flex items-start gap-4",children:[(0,b.jsx)("div",{className:"p-3 bg-brand-blue/10 rounded-xl border border-brand-blue/20",children:(0,b.jsx)(u.AlertCircle,{className:"h-6 w-6 text-brand-blue"})}),(0,b.jsxs)("div",{className:"flex-1 space-y-3",children:[(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)("h3",{className:"font-semibold text-gray-900 text-lg",children:"Obligation réglementaire"}),(0,b.jsx)(l.Badge,{className:"bg-brand-blue-ghost text-brand-blue text-xs",children:"Important"})]}),(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)("p",{className:"text-sm text-gray-700 leading-relaxed",children:"Le Bilan Pédagogique et Financier est un document obligatoire que tout organisme de formation doit transmettre chaque année à l'administration."}),(0,b.jsxs)("div",{className:"flex items-center gap-2 text-sm",children:[(0,b.jsx)(t.Clock,{className:"h-4 w-4 text-brand-blue"}),(0,b.jsx)("span",{className:"font-medium text-gray-900",children:"Date limite : 30 avril de l'année N+1"})]}),(0,b.jsx)("p",{className:"text-sm text-gray-600 leading-relaxed",children:"Ce rapport présente les données financières (chiffre d'affaires par source de financement) et pédagogiques (nombre de stagiaires, heures de formation) de l'année écoulée."})]})]})]})})}),D?(0,b.jsx)("div",{className:"space-y-4",children:[1,2].map(a=>(0,b.jsxs)(j.Card,{className:"animate-pulse",children:[(0,b.jsx)(j.CardHeader,{children:(0,b.jsxs)("div",{className:"flex items-center justify-between",children:[(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)("div",{className:"h-6 w-32 bg-muted rounded"}),(0,b.jsx)("div",{className:"h-4 w-48 bg-muted rounded"})]}),(0,b.jsx)("div",{className:"h-6 w-24 bg-muted rounded-full"})]})}),(0,b.jsxs)(j.CardContent,{className:"space-y-4",children:[(0,b.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[1,2,3,4].map(a=>(0,b.jsxs)("div",{className:"p-5 bg-muted/50 rounded-xl",children:[(0,b.jsx)("div",{className:"h-5 w-5 bg-muted rounded mb-3"}),(0,b.jsx)("div",{className:"h-7 w-24 bg-muted rounded mb-2"}),(0,b.jsx)("div",{className:"h-3 w-16 bg-muted rounded"})]},a))}),(0,b.jsxs)("div",{className:"flex items-center justify-between pt-4 border-t",children:[(0,b.jsx)("div",{className:"h-5 w-32 bg-muted rounded"}),(0,b.jsxs)("div",{className:"flex gap-2",children:[(0,b.jsx)("div",{className:"h-9 w-28 bg-muted rounded"}),(0,b.jsx)("div",{className:"h-9 w-28 bg-muted rounded"})]})]})]})]},a))}):0===C.length?(0,b.jsx)(j.Card,{className:"border-dashed border-2 hover:border-primary/50 transition-all duration-300",children:(0,b.jsx)(j.CardContent,{className:"p-16 text-center",children:(0,b.jsxs)("div",{className:"max-w-md mx-auto space-y-6",children:[(0,b.jsxs)("div",{className:"relative",children:[(0,b.jsx)("div",{className:"absolute inset-0 flex items-center justify-center",children:(0,b.jsx)("div",{className:"w-24 h-24 bg-gradient-to-br from-brand-blue-ghost to-brand-cyan-ghost rounded-full opacity-50 blur-2xl"})}),(0,b.jsx)("div",{className:"relative p-6 bg-gradient-to-br from-brand-blue-ghost to-brand-cyan-ghost rounded-2xl inline-block",children:(0,b.jsx)(p.FileText,{className:"h-16 w-16 mx-auto text-brand-blue"})})]}),(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)("h3",{className:"text-2xl font-bold text-foreground",children:"Aucun rapport BPF"}),(0,b.jsx)("p",{className:"text-muted-foreground max-w-sm mx-auto",children:"Créez votre premier Bilan Pédagogique et Financier pour commencer à suivre vos indicateurs de formation"})]}),(0,b.jsxs)(k.Button,{onClick:()=>E.mutate(A),size:"lg",className:"shadow-lg hover:shadow-xl transition-all",children:[(0,b.jsx)(o.Plus,{className:"h-5 w-5 mr-2"}),"Créer le rapport ",A]})]})})}):(0,b.jsx)("div",{className:"space-y-4",children:C.map(a=>{let c,d=G[a.status],e=a.total_revenue>0||a.total_students>0;return(0,b.jsxs)(j.Card,{className:"hover:shadow-lg hover:scale-[1.01] transition-all duration-300 border-l-4 border-l-brand-blue/30",children:[(0,b.jsx)(j.CardHeader,{children:(0,b.jsxs)("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[(0,b.jsxs)("div",{className:"space-y-1.5",children:[(0,b.jsxs)(j.CardTitle,{className:"flex items-center gap-2.5 text-xl",children:[(0,b.jsx)("div",{className:"p-2 bg-gradient-to-br from-brand-blue/10 to-brand-cyan/10 rounded-lg",children:(0,b.jsx)(n.BarChart3,{className:"h-5 w-5 text-brand-blue"})}),"BPF ",a.year]}),(0,b.jsxs)(j.CardDescription,{className:"flex items-center gap-1.5",children:[(0,b.jsx)(t.Clock,{className:"h-3.5 w-3.5"}),a.submitted_at?`Soumis le ${new Date(a.submitted_at).toLocaleDateString("fr-FR")}`:`Cr\xe9\xe9 le ${new Date(a.created_at).toLocaleDateString("fr-FR")}`]})]}),(0,b.jsx)("div",{className:"flex items-center gap-2",children:(0,b.jsxs)(l.Badge,{className:`${F[a.status]} px-3 py-1.5 text-xs font-medium`,children:[(0,b.jsx)(d,{className:"h-3.5 w-3.5 mr-1.5"}),H[a.status]]})})]})}),(0,b.jsxs)(j.CardContent,{className:"space-y-6",children:[(0,b.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[(0,b.jsxs)("div",{className:"group p-5 bg-gradient-to-br from-brand-blue-ghost to-brand-blue-ghost/50 rounded-xl border border-brand-blue/20 hover:shadow-lg hover:scale-105 transition-all duration-300",children:[(0,b.jsxs)("div",{className:"flex items-start justify-between mb-3",children:[(0,b.jsx)("div",{className:"p-2.5 bg-brand-blue/10 rounded-lg group-hover:bg-brand-blue/20 transition-colors",children:(0,b.jsx)(w.DollarSign,{className:"h-5 w-5 text-brand-blue"})}),(0,b.jsx)("p",{className:"text-xs font-medium text-gray-600",children:"CA Total"})]}),(0,b.jsx)("p",{className:"text-2xl font-bold text-gray-900 mb-1",children:(c=a.total_revenue,new Intl.NumberFormat("fr-FR",{style:"currency",currency:"EUR"}).format(c))}),(0,b.jsx)("p",{className:"text-xs text-gray-600",children:"Chiffre d'affaires"})]}),(0,b.jsxs)("div",{className:"group p-5 bg-gradient-to-br from-brand-cyan-ghost to-brand-cyan-ghost/50 rounded-xl border border-brand-cyan/20 hover:shadow-lg hover:scale-105 transition-all duration-300",children:[(0,b.jsxs)("div",{className:"flex items-start justify-between mb-3",children:[(0,b.jsx)("div",{className:"p-2.5 bg-brand-cyan/10 rounded-lg group-hover:bg-brand-cyan/20 transition-colors",children:(0,b.jsx)(v.Users,{className:"h-5 w-5 text-brand-cyan"})}),(0,b.jsx)("p",{className:"text-xs font-medium text-gray-600",children:"Stagiaires"})]}),(0,b.jsx)("p",{className:"text-2xl font-bold text-gray-900 mb-1",children:I(a.total_students)}),(0,b.jsx)("p",{className:"text-xs text-gray-600",children:"Apprenants formés"})]}),(0,b.jsxs)("div",{className:"group p-5 bg-gradient-to-br from-brand-blue-ghost to-brand-cyan-ghost/50 rounded-xl border border-brand-blue/20 hover:shadow-lg hover:scale-105 transition-all duration-300",children:[(0,b.jsxs)("div",{className:"flex items-start justify-between mb-3",children:[(0,b.jsx)("div",{className:"p-2.5 bg-brand-blue/10 rounded-lg group-hover:bg-brand-blue/20 transition-colors",children:(0,b.jsx)(t.Clock,{className:"h-5 w-5 text-brand-blue"})}),(0,b.jsx)("p",{className:"text-xs font-medium text-gray-600",children:"Heures"})]}),(0,b.jsxs)("p",{className:"text-2xl font-bold text-gray-900 mb-1",children:[I(a.total_training_hours),"h"]}),(0,b.jsx)("p",{className:"text-xs text-gray-600",children:"Heures de formation"})]}),(0,b.jsxs)("div",{className:"group p-5 bg-gradient-to-br from-brand-cyan-ghost to-brand-blue-ghost/50 rounded-xl border border-brand-cyan/20 hover:shadow-lg hover:scale-105 transition-all duration-300",children:[(0,b.jsxs)("div",{className:"flex items-start justify-between mb-3",children:[(0,b.jsx)("div",{className:"p-2.5 bg-brand-cyan/10 rounded-lg group-hover:bg-brand-cyan/20 transition-colors",children:(0,b.jsx)(x.BookOpen,{className:"h-5 w-5 text-brand-cyan"})}),(0,b.jsx)("p",{className:"text-xs font-medium text-gray-600",children:"Programmes"})]}),(0,b.jsx)("p",{className:"text-2xl font-bold text-gray-900 mb-1",children:I(a.total_programs)}),(0,b.jsx)("p",{className:"text-xs text-gray-600",children:"Formations actives"})]})]}),(0,b.jsxs)("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 pt-5 border-t",children:[(0,b.jsx)("div",{className:"text-sm",children:e?(0,b.jsxs)("div",{className:"flex items-center gap-2 px-3 py-1.5 bg-green-50 text-green-700 rounded-lg border border-green-200/50",children:[(0,b.jsx)(s.CheckCircle,{className:"h-4 w-4"}),(0,b.jsx)("span",{className:"font-medium",children:"Données renseignées"})]}):(0,b.jsxs)("div",{className:"flex items-center gap-2 px-3 py-1.5 bg-amber-50 text-amber-700 rounded-lg border border-amber-200/50",children:[(0,b.jsx)(u.AlertCircle,{className:"h-4 w-4"}),(0,b.jsx)("span",{className:"font-medium",children:"Données à compléter"})]})}),(0,b.jsxs)("div",{className:"flex flex-wrap items-center gap-2",children:[(0,b.jsx)(y.default,{href:`/dashboard/bpf/${a.year}`,children:(0,b.jsxs)(k.Button,{variant:"outline",size:"sm",className:"hover:bg-brand-blue-ghost hover:border-brand-blue/30 hover:text-brand-blue transition-all",children:[(0,b.jsx)(p.FileText,{className:"h-4 w-4 mr-2"}),"Voir le détail"]})}),(0,b.jsxs)(k.Button,{variant:"outline",size:"sm",className:"hover:bg-brand-cyan-ghost hover:border-brand-cyan/30 hover:text-brand-cyan transition-all",children:[(0,b.jsx)(q.Download,{className:"h-4 w-4 mr-2"}),"Exporter PDF"]}),"completed"===a.status&&(0,b.jsxs)(k.Button,{size:"sm",className:"bg-brand-blue hover:bg-brand-blue-dark shadow-md hover:shadow-lg transition-all",children:[(0,b.jsx)(r.Send,{className:"h-4 w-4 mr-2"}),"Soumettre"]})]})]})]})]},a.id)})})]}):(0,b.jsx)("div",{className:"p-6",children:(0,b.jsx)("p",{className:"text-sm text-muted-foreground",children:"Chargement..."})})}a.s(["default",()=>z],31036)}];

//# sourceMappingURL=app_%28dashboard%29_dashboard_bpf_page_tsx_9e0157fd._.js.map