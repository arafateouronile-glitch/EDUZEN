module.exports=[913216,a=>{"use strict";var b=a.i(433217),c=a.i(370025),d=a.i(937927),e=a.i(50944),f=a.i(269240),g=a.i(572131),h=a.i(325383);function i(){let a=(0,f.createClient)(),i=(0,e.useRouter)(),j=(0,d.useQueryClient)(),{data:k,isLoading:l}=(0,b.useQuery)({queryKey:["session"],queryFn:async()=>{try{let b=new Promise((a,b)=>{setTimeout(()=>b(Error("Session timeout")),3e3)}),c=a.auth.getSession().then(({data:{session:a},error:b})=>b?(h.logger.error("Session error",b),null):a);return await Promise.race([c,b])}catch(a){return null}},retry:!1,refetchOnWindowFocus:!1,refetchOnMount:!1,staleTime:3e5}),{data:m,isLoading:n}=(0,b.useQuery)({queryKey:["user",k?.user?.id],queryFn:async()=>{if(!k?.user?.id)return null;try{let b=new Promise((a,b)=>{setTimeout(()=>b(Error("User fetch timeout")),3e3)}),c=a.from("users").select("id, organization_id, email, full_name, phone, avatar_url, role, permissions, is_active, last_login_at, created_at, updated_at").eq("id",k.user.id).maybeSingle().then(async({data:b,error:c})=>{if(c)return"PGRST116"===c.code||c.message?.includes("No rows"),null;if(!b&&k?.user?.id){h.logger.info("User not found in public.users, attempting to sync from auth.users...");try{let{data:b,error:c}=await a.rpc("sync_user_from_auth",{user_id:k.user.id});if(c)h.logger.error("Error syncing user:",c);else if(b?.success){h.logger.info("User synced successfully, refetching...",{syncResult:b}),await new Promise(a=>setTimeout(a,100));let{data:c,error:d}=await a.from("users").select("id, organization_id, email, full_name, phone, avatar_url, role, permissions, is_active, last_login_at, created_at, updated_at").eq("id",k.user.id).maybeSingle();if(d)h.logger.error("Error refetching synced user:",d),j.invalidateQueries({queryKey:["user",k.user.id]});else{if(c)return h.logger.info("Synced user retrieved successfully:",{id:c.id,email:c.email,hasOrg:!!c.organization_id}),c;h.logger.warn("User sync succeeded but refetch returned null - invalidating cache and retrying..."),j.invalidateQueries({queryKey:["user",k.user.id]})}}}catch(a){h.logger.error("Exception during user sync:",a)}return null}return b?(b.organization_id||h.logger.warn("User exists but has no organization_id"),b):null});return await Promise.race([c,b])}catch(a){return null}},enabled:!!k?.user?.id&&!l,retry:!1,refetchOnWindowFocus:!1,refetchOnMount:!1,staleTime:3e5}),o=(0,c.useMutation)({mutationFn:async({email:b,password:c})=>{let{data:d,error:e}=await a.auth.signInWithPassword({email:b,password:c});if(e)throw e;return d},onSuccess:async()=>{j.invalidateQueries({queryKey:["session"]}),j.invalidateQueries({queryKey:["user"]}),await new Promise(a=>setTimeout(a,300)),i.push("/dashboard")}}),p=(0,c.useMutation)({mutationFn:async({email:b,password:c,fullName:d,organizationName:e})=>{let{data:f,error:g}=await a.auth.signUp({email:b,password:c});if(g){if(h.logger.error("Auth signup error",Error(g.message),{status:g.status}),429===g.status||g.message?.includes("2 seconds"))throw Error("Trop de tentatives. Veuillez attendre quelques secondes avant de réessayer.");throw Error(g.message||"Erreur lors de la création du compte")}if(!f.user)throw Error("Erreur lors de la création du compte");let i=f.session;if(!i){await new Promise(a=>setTimeout(a,1e3));let{data:{session:b}}=await a.auth.getSession();i=b}if(!i&&f.user){let{data:{session:b}}=await a.auth.refreshSession();i=b}if(!i){await new Promise(a=>setTimeout(a,2e3));let{data:{session:b}}=await a.auth.getSession();b&&(i=b)}if(!i&&!f.user)throw Error("Erreur : la session n'a pas pu être établie. Vérifiez votre email pour confirmer votre compte si nécessaire.");let k=i?.user?.id||f.user.id,l=e.toUpperCase().replace(/\s+/g,"").slice(0,6),m=null;if(!k)throw Error("Erreur : impossible d'obtenir l'ID utilisateur");try{let{data:b,error:c}=await a.rpc("create_organization_for_user",{org_name:e,org_code:l,org_type:"primary",org_country:"SN",org_currency:"XOF",org_language:"fr",org_timezone:"Africa/Dakar",user_id:k});if(c){if("P0001"===c.code&&c.message?.includes("User must be authenticated")){let b=await a.rpc("create_organization_for_user",{org_name:e,org_code:l,org_type:"primary",org_country:"SN",org_currency:"XOF",org_language:"fr",org_timezone:"Africa/Dakar"});b.error?b.error:b.data&&(m=b.data)}}else b&&(m=b)}catch(a){}let n=null;if(m)n={id:m,name:e,code:l};else{let{data:b,error:c}=await a.from("organizations").insert({name:e,code:l,type:"primary",country:"SN",currency:"XOF",language:"fr",timezone:"Africa/Dakar",subscription_tier:"free",subscription_status:"active",settings:{}}).select("id, name, code").single();if(c){if(console.error("Organization creation error:",c),console.error("Error details:",{code:c.code,message:c.message,details:c.details,hint:c.hint}),"42501"===c.code)throw Error("Erreur de sécurité (RLS) : Impossible de créer l'organisation. Les politiques RLS bloquent la création. INSTRUCTIONS : 1. Exécutez le script supabase/create_organization_function.sql dans Supabase SQL Editor 2. OU exécutez le script supabase/fix_rls_urgent.sql pour corriger les politiques RLS 3. Attendez quelques secondes puis réessayez");throw Error(`Impossible de cr\xe9er l'organisation : ${c.message}`)}n=b,m=b?.id}if(!m)throw Error("Erreur : l'organisation n'a pas été créée correctement");let o=m||n?.id;if(!o)throw Error("Erreur : impossible d'obtenir l'ID de l'organisation");let p=null,q=null;try{let{data:c,error:e}=await a.rpc("create_user_for_organization",{user_id:k,user_email:b,user_full_name:d,organization_id:o});if(e){if(q=e,"42883"===e.code){let{data:c,error:e}=await a.from("users").insert({id:k,organization_id:o,email:b,full_name:d,role:"admin",is_active:!0}).select("id, organization_id, email, full_name, role").single();e?q=e:p=c}}else c&&(p={id:c,organization_id:o,email:b,full_name:d,role:"admin"})}catch(a){q=a}if(q){if("42501"===q.code)throw Error("Erreur RLS lors de la création de l'utilisateur. Exécutez le script supabase/create_user_function.sql dans Supabase SQL Editor, ou utilisez supabase/fix_existing_user.sql pour créer l'utilisateur manuellement.");throw q}if(!p)throw Error("Erreur : l'utilisateur n'a pas été créé");if(!p?.organization_id)throw Error("Erreur : l'utilisateur n'a pas d'organization_id");if(j.invalidateQueries({queryKey:["user",k]}),j.invalidateQueries({queryKey:["session"]}),!i){await new Promise(a=>setTimeout(a,1e3));let{data:{session:b}}=await a.auth.getSession();if(b)return{...f,session:b}}return f},onSuccess:async a=>{await new Promise(a=>setTimeout(a,1500));let b=(0,f.createClient)(),{data:{session:c}}=await b.auth.getSession();j.invalidateQueries({queryKey:["session"]}),a.user&&j.invalidateQueries({queryKey:["user",a.user.id]}),c?i.push("/dashboard"):i.push("/auth/login?message=confirm-email")}}),q=(0,c.useMutation)({mutationFn:async()=>{let{error:b}=await a.auth.signOut();if(b)throw b},onSuccess:()=>{j.clear(),i.push("/")}});return(0,g.useEffect)(()=>{let{data:{subscription:b}}=a.auth.onAuthStateChange((a,b)=>{j.setQueryData(["session"],b),b||j.clear()});return()=>b.unsubscribe()},[a,j]),{session:k,user:m,isLoading:l||n,isAuthenticated:!!k,login:o.mutate,register:p.mutate,logout:q.mutate,isLoggingIn:o.isPending,isRegistering:p.isPending,isLoggingOut:q.isPending,loginError:o.error,registerError:p.error}}a.s(["useAuth",()=>i])},104720,a=>{"use strict";let b=(0,a.i(170106).default)("FileText",[["path",{d:"M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z",key:"1nnpy2"}],["polyline",{points:"14 2 14 8 20 8",key:"1ew0cm"}],["line",{x1:"16",x2:"8",y1:"13",y2:"13",key:"14keom"}],["line",{x1:"16",x2:"8",y1:"17",y2:"17",key:"17nazh"}],["line",{x1:"10",x2:"8",y1:"9",y2:"9",key:"1a5vjj"}]]);a.s(["FileText",()=>b],104720)},941675,a=>{"use strict";let b=(0,a.i(170106).default)("Calendar",[["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",ry:"2",key:"eu3xkr"}],["line",{x1:"16",x2:"16",y1:"2",y2:"6",key:"m3sa8f"}],["line",{x1:"8",x2:"8",y1:"2",y2:"6",key:"18kwsl"}],["line",{x1:"3",x2:"21",y1:"10",y2:"10",key:"xt86sb"}]]);a.s(["Calendar",()=>b],941675)},953722,a=>{"use strict";let b=(0,a.i(170106).default)("BookOpen",[["path",{d:"M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z",key:"vv98re"}],["path",{d:"M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z",key:"1cyq3y"}]]);a.s(["BookOpen",()=>b],953722)},546842,a=>{"use strict";let b=(0,a.i(170106).default)("User",[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]]);a.s(["User",()=>b],546842)},911156,a=>{"use strict";let b=(0,a.i(170106).default)("CreditCard",[["rect",{width:"20",height:"14",x:"2",y:"5",rx:"2",key:"ynyp8z"}],["line",{x1:"2",x2:"22",y1:"10",y2:"10",key:"1b3vmo"}]]);a.s(["CreditCard",()=>b],911156)},911300,a=>{"use strict";let b=(0,a.i(170106).default)("ClipboardList",[["rect",{width:"8",height:"4",x:"8",y:"2",rx:"1",ry:"1",key:"tgr4d6"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2",key:"116196"}],["path",{d:"M12 11h4",key:"1jrz19"}],["path",{d:"M12 16h4",key:"n85exb"}],["path",{d:"M8 11h.01",key:"1dfujw"}],["path",{d:"M8 16h.01",key:"18s6g9"}]]);a.s(["ClipboardList",()=>b],911300)},563588,a=>{"use strict";let b=(0,a.i(170106).default)("MessageSquare",[["path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z",key:"1lielz"}]]);a.s(["MessageSquare",()=>b],563588)},523312,a=>{"use strict";let b=(0,a.i(170106).default)("Bell",[["path",{d:"M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9",key:"1qo2s2"}],["path",{d:"M10.3 21a1.94 1.94 0 0 0 3.4 0",key:"qgo35s"}]]);a.s(["Bell",()=>b],523312)},987105,a=>{"use strict";let b=(0,a.i(170106).default)("BookMarked",[["path",{d:"M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20",key:"t4utmx"}],["polyline",{points:"10 2 10 10 13 7 16 10 16 2",key:"13o6vz"}]]);a.s(["BookMarked",()=>b],987105)},630617,a=>{"use strict";let b=(0,a.i(170106).default)("LayoutDashboard",[["rect",{width:"7",height:"9",x:"3",y:"3",rx:"1",key:"10lvy0"}],["rect",{width:"7",height:"5",x:"14",y:"3",rx:"1",key:"16une8"}],["rect",{width:"7",height:"9",x:"14",y:"12",rx:"1",key:"1hutg5"}],["rect",{width:"7",height:"5",x:"3",y:"16",rx:"1",key:"ldoo1y"}]]);a.s(["LayoutDashboard",()=>b],630617)},220005,a=>{"use strict";let b=(0,a.i(170106).default)("LogOut",[["path",{d:"M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4",key:"1uf3rs"}],["polyline",{points:"16 17 21 12 16 7",key:"1gabdz"}],["line",{x1:"21",x2:"9",y1:"12",y2:"12",key:"1uyos4"}]]);a.s(["LogOut",()=>b],220005)},510519,a=>{"use strict";var b=a.i(187924),c=a.i(238246),d=a.i(50944),e=a.i(497895),f=a.i(630617),g=a.i(546842),h=a.i(953722),i=a.i(911300),j=a.i(104720),k=a.i(911156),l=a.i(563588),m=a.i(941675),n=a.i(220005),o=a.i(987105),p=a.i(913216);let q=[{name:"Dashboard",href:"/portal",icon:f.LayoutDashboard},{name:"Enfants",href:"/portal/children",icon:g.User},{name:"Emploi du temps",href:"/portal/schedule",icon:m.Calendar},{name:"Présences",href:"/portal/attendance",icon:i.ClipboardList},{name:"Notes",href:"/portal/grades",icon:h.BookOpen},{name:"Documents",href:"/portal/documents",icon:j.FileText},{name:"Paiements",href:"/portal/payments",icon:k.CreditCard},{name:"Messages",href:"/portal/messages",icon:l.MessageSquare}],r=[{name:"Dashboard",href:"/portal",icon:f.LayoutDashboard},{name:"Profil",href:"/portal/profile",icon:g.User},{name:"Emploi du temps",href:"/portal/schedule",icon:m.Calendar},{name:"Présences",href:"/portal/attendance",icon:i.ClipboardList},{name:"Notes",href:"/portal/grades",icon:h.BookOpen},{name:"Livrets d'apprentissage",href:"/portal/portfolios",icon:o.BookMarked},{name:"Documents",href:"/portal/documents",icon:j.FileText},{name:"Paiements",href:"/portal/payments",icon:k.CreditCard},{name:"Messages",href:"/portal/messages",icon:l.MessageSquare}];function s(){let a=(0,d.usePathname)(),{user:f,logout:g}=(0,p.useAuth)(),h=f?.role==="parent"?q:r;return(0,b.jsx)("div",{className:"hidden md:flex md:flex-shrink-0",children:(0,b.jsx)("div",{className:"flex flex-col w-64",children:(0,b.jsxs)("div",{className:"flex flex-col flex-grow bg-white border-r border-gray-200 pt-5 pb-4 overflow-y-auto",children:[(0,b.jsx)("div",{className:"flex items-center flex-shrink-0 px-4 mb-8",children:(0,b.jsx)("h1",{className:"text-2xl font-bold text-primary",children:"eduzen"})}),(0,b.jsxs)("div",{className:"mt-5 flex-1 flex flex-col",children:[(0,b.jsx)("nav",{className:"flex-1 px-2 space-y-1",children:h.map(d=>{let f=a===d.href||a?.startsWith(d.href+"/");return(0,b.jsxs)(c.default,{href:d.href,className:(0,e.cn)("group flex items-center px-3 py-3 text-sm font-medium rounded-lg min-touch-target touch-manipulation transition-colors",f?"bg-primary text-white":"text-gray-700 hover:bg-gray-100 hover:text-gray-900"),children:[(0,b.jsx)(d.icon,{className:(0,e.cn)("mr-3 flex-shrink-0 h-6 w-6",f?"text-white":"text-gray-400 group-hover:text-gray-500")}),d.name]},d.name)})}),(0,b.jsx)("div",{className:"px-2 mt-auto",children:(0,b.jsxs)("button",{onClick:()=>g(),className:"group flex items-center w-full px-3 py-3 text-sm font-medium text-gray-700 rounded-lg hover:bg-gray-100 hover:text-gray-900 min-touch-target touch-manipulation",children:[(0,b.jsx)(n.LogOut,{className:"mr-3 flex-shrink-0 h-6 w-6 text-gray-400 group-hover:text-gray-500"}),"Déconnexion"]})})]})]})})})}a.s(["Sidebar",()=>s])},519551,a=>{"use strict";var b=a.i(187924),c=a.i(913216),d=a.i(523312);function e(){let{user:a}=(0,c.useAuth)();return(0,b.jsx)("header",{className:"bg-white border-b border-gray-200 px-4 py-4",children:(0,b.jsxs)("div",{className:"flex items-center justify-between",children:[(0,b.jsx)("div",{className:"flex items-center space-x-4",children:(0,b.jsx)("h2",{className:"text-xl font-semibold text-gray-900",children:a?.role==="parent"?"Espace Parent":"Espace Étudiant"})}),(0,b.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,b.jsxs)("button",{className:"relative p-2 text-gray-400 hover:text-gray-600 min-touch-target touch-manipulation",children:[(0,b.jsx)(d.Bell,{className:"h-6 w-6"}),(0,b.jsx)("span",{className:"absolute top-1 right-1 h-2 w-2 bg-red-500 rounded-full"})]}),(0,b.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,b.jsxs)("div",{className:"text-right",children:[(0,b.jsx)("p",{className:"text-sm font-medium text-gray-900",children:a?.full_name}),(0,b.jsx)("p",{className:"text-xs text-gray-500",children:a?.role==="parent"?"Parent":"Étudiant"})]}),(0,b.jsx)("div",{className:"h-10 w-10 rounded-full bg-primary text-white flex items-center justify-center font-semibold",children:a?.full_name?.charAt(0).toUpperCase()})]})]})]})})}a.s(["Header",()=>e])}];

//# sourceMappingURL=_c83d4086._.js.map