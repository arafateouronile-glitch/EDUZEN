module.exports=[915618,a=>{"use strict";let b=(0,a.i(170106).default)("Plus",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]]);a.s(["Plus",()=>b],915618)},436265,a=>{"use strict";let b=(0,a.i(170106).default)("MoreVertical",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"12",cy:"5",r:"1",key:"gxeob9"}],["circle",{cx:"12",cy:"19",r:"1",key:"lyex9k"}]]);a.s(["MoreVertical",()=>b],436265)},805781,a=>{"use strict";var b=a.i(269240);let c=new class{supabase;constructor(a){this.supabase=a||(0,b.createClient)()}async getConversations(a,b){let{data:c,error:d}=await this.supabase.from("conversation_participants").select("conversation_id").eq("user_id",a);if(d)throw d;if(!c||0===c.length)return[];let e=c.map(a=>a.conversation_id),{data:f,error:g}=await this.supabase.from("conversations").select("*").eq("organization_id",b).eq("is_archived",!1).in("id",e).order("last_message_at",{ascending:!1,nullsFirst:!1});if(g)throw g;if(!f||0===f.length)return[];let{data:h}=await this.supabase.from("conversation_participants").select("*").in("conversation_id",e),i=[...new Set((h||[]).filter(a=>a.user_id).map(a=>a.user_id))],j=[...new Set((h||[]).filter(a=>a.student_id).map(a=>a.student_id))],k={};if(i.length>0){let{data:a}=await this.supabase.from("users").select("id, full_name, email, avatar_url").in("id",i);a?.forEach(a=>{k[a.id]=a})}let l={};if(j.length>0){let{data:a}=await this.supabase.from("students").select("id, first_name, last_name, email, student_number").in("id",j);a?.forEach(a=>{l[a.id]=a})}let m=f.map(a=>this.supabase.from("messages").select("*").eq("conversation_id",a.id).eq("is_deleted",!1).order("created_at",{ascending:!1}).limit(1).maybeSingle()),n=await Promise.all(m),o=[...new Set(n.filter(a=>a.data?.sender_id).map(a=>a.data.sender_id))],p=[...new Set(n.filter(a=>a.data?.student_sender_id).map(a=>a.data.student_sender_id))];if(o.length>0){let{data:a}=await this.supabase.from("users").select("id, full_name, email").in("id",o.filter(a=>!k[a]));a?.forEach(a=>{k[a.id]=a})}if(p.length>0){let{data:a}=await this.supabase.from("students").select("id, first_name, last_name, email, student_number").in("id",p.filter(a=>!l[a]));a?.forEach(a=>{l[a.id]=a})}return f.map((a,b)=>{let c=(h||[]).filter(b=>b.conversation_id===a.id).map(a=>({...a,user:a.user_id&&k[a.user_id]||null,student:a.student_id&&l[a.student_id]||null})),d=n[b].data,e=null;return d&&(e={...d,sender:d.sender_id&&k[d.sender_id]||null,student_sender:d.student_sender_id&&l[d.student_sender_id]||null}),{...a,participants:c,last_message:e}})}async getConversationsByStudentId(a,b){let{data:c,error:d}=await this.supabase.from("conversation_participants").select("conversation_id").eq("student_id",a);if(d)throw d;if(!c||0===c.length)return[];let e=c.map(a=>a.conversation_id),{data:f,error:g}=await this.supabase.from("conversations").select("*").eq("organization_id",b).eq("is_archived",!1).in("id",e).order("last_message_at",{ascending:!1,nullsFirst:!1});if(g)throw g;return f&&0!==f.length?await Promise.all(f.map(async a=>{let{data:b}=await this.supabase.from("conversation_participants").select("*").eq("conversation_id",a.id),c=await Promise.all((b||[]).map(async a=>{let b=null,c=null;if(a.user_id){let{data:c}=await this.supabase.from("users").select("id, full_name, email, avatar_url").eq("id",a.user_id).maybeSingle();b=c}if(a.student_id){let{data:b}=await this.supabase.from("students").select("id, first_name, last_name, email, student_number").eq("id",a.student_id).maybeSingle();c=b}return{...a,user:b,student:c}})),{data:d}=await this.supabase.from("messages").select("*").eq("conversation_id",a.id).eq("is_deleted",!1).order("created_at",{ascending:!1}).limit(1),e=null;if(d&&d.length>0){let a=d[0],b=null;if(a.sender_id){let{data:c}=await this.supabase.from("users").select("id, full_name, email").eq("id",a.sender_id).maybeSingle();b=c}e={...a,sender:b}}return{...a,participants:c,last_message:e}})):[]}async getConversationById(a){let{data:b,error:c}=await this.supabase.from("conversations").select("id, organization_id, conversation_type, name, created_by, created_at, updated_at, is_archived, last_message_at").eq("id",a).maybeSingle();if(c)throw console.error("[MESSAGING] Erreur récupération conversation:",c),c;if(!b)return null;let{data:d,error:e}=await this.supabase.from("conversation_participants").select("*").eq("conversation_id",a);if(e)throw e;let f=await Promise.all((d||[]).map(async a=>{let b=null,c=null;if(a.user_id){let{data:c}=await this.supabase.from("users").select("id, full_name, email, avatar_url").eq("id",a.user_id).maybeSingle();b=c}if(a.student_id){let{data:b}=await this.supabase.from("students").select("id, first_name, last_name, email, student_number").eq("id",a.student_id).maybeSingle();c=b}return{...a,user:b,student:c}}));return{...b,participants:f}}async createDirectConversation(a,b,c,d){let{data:e,error:f}=await this.supabase.from("conversations").select("id").eq("conversation_type","direct").eq("organization_id",c);if(!f&&e&&e.length>0){let c=e.map(a=>a.id),{data:f,error:g}=await this.supabase.from("conversation_participants").select("conversation_id").eq("user_id",a).in("conversation_id",c);if(!g&&f&&f.length>0){let a=f.map(a=>a.conversation_id),c=this.supabase.from("conversation_participants").select("conversation_id").in("conversation_id",a);b?c=c.eq("user_id",b):d&&(c=c.eq("student_id",d));let{data:e}=await c.maybeSingle();if(e)return this.getConversationById(e.conversation_id)}}let{data:g,error:h}=await this.supabase.from("conversations").insert({organization_id:c,conversation_type:"direct",created_by:a}).select().single();if(h)throw h;return await this.addParticipant(g.id,a,"member"),await this.addParticipant(g.id,b,"member",d),this.getConversationById(g.id)}async createGroupConversation(a,b,c,d,e){let{data:f,error:g}=await this.supabase.from("conversations").insert({organization_id:c,conversation_type:"group",name:a,created_by:d}).select().single();if(g)throw g;for(let a of b)await this.addParticipant(f.id,a,a===d?"owner":"member");if(e&&e.length>0)for(let a of e)await this.addParticipant(f.id,null,"member",a);return this.getConversationById(f.id)}async updateConversation(a,b){let{data:c,error:d}=await this.supabase.from("conversations").update(b).eq("id",a).select().single();if(d)throw d;return c}async archiveConversation(a){return this.updateConversation(a,{is_archived:!0})}async deleteConversation(a){return this.updateConversation(a,{is_archived:!0})}async pinConversation(a,b){return this.updateConversation(a,{is_pinned:b})}async addParticipant(a,b,c="member",d){let e={conversation_id:a,role:c};if(b)e.user_id=b;else if(d)e.student_id=d;else throw Error("Either userId or studentId must be provided");let{data:f,error:g}=await this.supabase.from("conversation_participants").insert(e).select().single();if(g)throw g;return f}async removeParticipant(a,b){let{error:c}=await this.supabase.from("conversation_participants").delete().eq("conversation_id",a).eq("user_id",b);if(c)throw c}async updateParticipantRole(a,b,c){let{data:d,error:e}=await this.supabase.from("conversation_participants").update({role:c}).eq("conversation_id",a).eq("user_id",b).select().single();if(e)throw e;return d}async muteConversation(a,b,c){let{data:d,error:e}=await this.supabase.from("conversation_participants").update({is_muted:c}).eq("conversation_id",a).eq("user_id",b).select().single();if(e)throw e;return d}async markAsRead(a,b){let{error:c}=await this.supabase.from("conversation_participants").update({last_read_at:new Date().toISOString()}).eq("conversation_id",a).eq("user_id",b);if(c)throw c;let{data:d}=await this.supabase.from("messages").select("id").eq("conversation_id",a).not("sender_id","eq",b);if(d)for(let a of d)await this.supabase.from("message_reads").upsert({message_id:a.id,user_id:b,read_at:new Date().toISOString()})}async getMessages(a,b=50,c=0){let{data:d,error:e}=await this.supabase.from("messages").select("*").eq("conversation_id",a).eq("is_deleted",!1).order("created_at",{ascending:!1}).range(c,c+b-1);if(e)throw e;return d&&0!==d.length?(await Promise.all(d.map(async a=>{let b=null,c=null,d=null;if(a.sender_id){let{data:c}=await this.supabase.from("users").select("id, full_name, email, avatar_url").eq("id",a.sender_id).maybeSingle();b=c}if(a.student_sender_id){let{data:b}=await this.supabase.from("students").select("id, first_name, last_name, email, student_number").eq("id",a.student_sender_id).maybeSingle();c=b}if(a.reply_to_id){let{data:b}=await this.supabase.from("messages").select("*").eq("id",a.reply_to_id).maybeSingle();if(b){let a=null,c=null;if(b.sender_id){let{data:c}=await this.supabase.from("users").select("id, full_name").eq("id",b.sender_id).maybeSingle();a=c}if(b.student_sender_id){let{data:a}=await this.supabase.from("students").select("id, first_name, last_name, email, student_number").eq("id",b.student_sender_id).maybeSingle();c=a}d={...b,sender:a,student_sender:c}}}return{...a,sender:b,student_sender:c,reply_to:d}}))).reverse():[]}async uploadAttachment(a,b){let c=a.name.split(".").pop(),d=`${Date.now()}-${Math.random().toString(36).substring(7)}.${c}`,e=`${b}/${d}`,{data:f,error:g}=await this.supabase.storage.from("messages").upload(e,a,{cacheControl:"3600",upsert:!1});if(g)throw g;return e}async getAttachmentUrl(a){let{data:b,error:c}=await this.supabase.storage.from("messages").createSignedUrl(a,3600);if(c)throw c;return b.signedUrl}async sendMessage(a){let{data:b,error:c}=await this.supabase.from("messages").insert(a).select("*").single();if(c)throw c;let d=null,e=null;if(b.sender_id){let{data:a}=await this.supabase.from("users").select("id, full_name, email, avatar_url").eq("id",b.sender_id).maybeSingle();d=a}if(b.student_sender_id){let{data:a}=await this.supabase.from("students").select("id, first_name, last_name, email, student_number").eq("id",b.student_sender_id).maybeSingle();e=a}return{...b,sender:d,student_sender:e}}async updateMessage(a,b){let{data:c,error:d}=await this.supabase.from("messages").update({content:b,is_edited:!0}).eq("id",a).select().single();if(d)throw d;return c}async deleteMessage(a){let{data:b,error:c}=await this.supabase.from("messages").update({is_deleted:!0,deleted_at:new Date().toISOString(),content:"Message supprimé"}).eq("id",a).select().single();if(c)throw c;return b}async addReaction(a,b,c){let{data:d}=await this.supabase.from("messages").select("reactions").eq("id",a).single();if(!d)throw Error("Message non trouvé");let e=d.reactions||{};e[c]||(e[c]=[]),e[c].includes(b)||e[c].push(b);let{data:f,error:g}=await this.supabase.from("messages").update({reactions:e}).eq("id",a).select().single();if(g)throw g;return f}async removeReaction(a,b,c){let{data:d}=await this.supabase.from("messages").select("reactions").eq("id",a).single();if(!d)throw Error("Message non trouvé");let e=d.reactions||{};e[c]&&(e[c]=e[c].filter(a=>a!==b),0===e[c].length&&delete e[c]);let{data:f,error:g}=await this.supabase.from("messages").update({reactions:e}).eq("id",a).select().single();if(g)throw g;return f}async pinMessage(a,b,c){let{data:d,error:e}=await this.supabase.from("pinned_messages").insert({conversation_id:a,message_id:b,pinned_by:c}).select().single();if(e)throw e;return d}async unpinMessage(a,b){let{error:c}=await this.supabase.from("pinned_messages").delete().eq("conversation_id",a).eq("message_id",b);if(c)throw c}async getPinnedMessages(a){let{data:b,error:c}=await this.supabase.from("pinned_messages").select(`
        *,
        message:messages(*, sender:users(id, full_name, email)),
        pinned_by_user:users(id, full_name)
      `).eq("conversation_id",a).order("pinned_at",{ascending:!1});if(c)throw c;return b}async createCall(a){let{data:b,error:c}=await this.supabase.from("calls").insert(a).select().single();if(c)throw c;return b}async updateCallStatus(a,b,c){let d={status:b};"active"===b?d.started_at=new Date().toISOString():"ended"===b&&(d.ended_at=new Date().toISOString(),c&&(d.duration_seconds=c));let{data:e,error:f}=await this.supabase.from("calls").update(d).eq("id",a).select().single();if(f)throw f;return e}async addCallParticipant(a,b){let{data:c,error:d}=await this.supabase.from("call_participants").insert({call_id:a,user_id:b,status:"joined",joined_at:new Date().toISOString()}).select().single();if(d)throw d;return c}async getNotifications(a,b=!1){let c=this.supabase.from("message_notifications").select(`
        *,
        conversation:conversations(*),
        message:messages(*, sender:users(id, full_name, email))
      `).eq("user_id",a);b&&(c=c.eq("is_read",!1));let{data:d,error:e}=await c.order("created_at",{ascending:!1}).limit(50);if(e)throw e;return d}async markNotificationAsRead(a){let{data:b,error:c}=await this.supabase.from("message_notifications").update({is_read:!0,read_at:new Date().toISOString()}).eq("id",a).select().single();if(c)throw c;return b}async markAllNotificationsAsRead(a){let{error:b}=await this.supabase.from("message_notifications").update({is_read:!0,read_at:new Date().toISOString()}).eq("user_id",a).eq("is_read",!1);if(b)throw b}async searchMessages(a,b){let{data:c,error:d}=await this.supabase.from("messages").select(`
        *,
        sender:users(id, full_name, email, avatar_url)
      `).eq("conversation_id",a).eq("is_deleted",!1).ilike("content",`%${b}%`).order("created_at",{ascending:!1}).limit(50);if(d)throw d;return c}};a.s(["messagingService",0,c])}];

//# sourceMappingURL=_b8e29cbb._.js.map