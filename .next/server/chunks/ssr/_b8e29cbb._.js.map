{"version":3,"sources":["../../../../node_modules/lucide-react/src/icons/plus.ts","../../../../node_modules/lucide-react/src/icons/more-vertical.ts","../../../../lib/services/messaging.service.ts"],"sourcesContent":["import createLucideIcon from '../createLucideIcon';\n\n/**\n * @component @name Plus\n * @description Lucide SVG icon component, renders SVG Element with children.\n *\n * @preview ![img](data:image/svg+xml;base64,PHN2ZyAgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIgogIHdpZHRoPSIyNCIKICBoZWlnaHQ9IjI0IgogIHZpZXdCb3g9IjAgMCAyNCAyNCIKICBmaWxsPSJub25lIgogIHN0cm9rZT0iIzAwMCIgc3R5bGU9ImJhY2tncm91bmQtY29sb3I6ICNmZmY7IGJvcmRlci1yYWRpdXM6IDJweCIKICBzdHJva2Utd2lkdGg9IjIiCiAgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIgogIHN0cm9rZS1saW5lam9pbj0icm91bmQiCj4KICA8cGF0aCBkPSJNNSAxMmgxNCIgLz4KICA8cGF0aCBkPSJNMTIgNXYxNCIgLz4KPC9zdmc+Cg==) - https://lucide.dev/icons/plus\n * @see https://lucide.dev/guide/packages/lucide-react - Documentation\n *\n * @param {Object} props - Lucide icons props and any valid SVG attribute\n * @returns {JSX.Element} JSX Element\n *\n */\nconst Plus = createLucideIcon('Plus', [\n  ['path', { d: 'M5 12h14', key: '1ays0h' }],\n  ['path', { d: 'M12 5v14', key: 's699le' }],\n]);\n\nexport default Plus;\n","import createLucideIcon from '../createLucideIcon';\n\n/**\n * @component @name MoreVertical\n * @description Lucide SVG icon component, renders SVG Element with children.\n *\n * @preview ![img](data:image/svg+xml;base64,PHN2ZyAgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIgogIHdpZHRoPSIyNCIKICBoZWlnaHQ9IjI0IgogIHZpZXdCb3g9IjAgMCAyNCAyNCIKICBmaWxsPSJub25lIgogIHN0cm9rZT0iIzAwMCIgc3R5bGU9ImJhY2tncm91bmQtY29sb3I6ICNmZmY7IGJvcmRlci1yYWRpdXM6IDJweCIKICBzdHJva2Utd2lkdGg9IjIiCiAgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIgogIHN0cm9rZS1saW5lam9pbj0icm91bmQiCj4KICA8Y2lyY2xlIGN4PSIxMiIgY3k9IjEyIiByPSIxIiAvPgogIDxjaXJjbGUgY3g9IjEyIiBjeT0iNSIgcj0iMSIgLz4KICA8Y2lyY2xlIGN4PSIxMiIgY3k9IjE5IiByPSIxIiAvPgo8L3N2Zz4K) - https://lucide.dev/icons/more-vertical\n * @see https://lucide.dev/guide/packages/lucide-react - Documentation\n *\n * @param {Object} props - Lucide icons props and any valid SVG attribute\n * @returns {JSX.Element} JSX Element\n *\n */\nconst MoreVertical = createLucideIcon('MoreVertical', [\n  ['circle', { cx: '12', cy: '12', r: '1', key: '41hilf' }],\n  ['circle', { cx: '12', cy: '5', r: '1', key: 'gxeob9' }],\n  ['circle', { cx: '12', cy: '19', r: '1', key: 'lyex9k' }],\n]);\n\nexport default MoreVertical;\n","import { createClient } from '@/lib/supabase/client'\nimport type { SupabaseClient } from '@supabase/supabase-js'\nimport type { TableRow, TableInsert, TableUpdate } from '@/lib/types/supabase-helpers'\n\ntype Conversation = TableRow<'conversations'>\ntype Message = TableRow<'messages'>\ntype ConversationParticipant = TableRow<'conversation_participants'>\ntype Call = TableRow<'calls'>\n\n/**\n * Service de gestion de la messagerie\n * \n * Gère les conversations, messages, participants et pièces jointes.\n * Utilise une approche optimisée pour éviter les problèmes RLS :\n * - Récupération séparée des conversations, participants et messages\n * - Enrichissement des données en batch pour éviter les requêtes N+1\n * - Support des utilisateurs et étudiants comme participants\n */\nexport class MessagingService {\n  private supabase: SupabaseClient<any>\n\n\n  constructor(supabaseClient?: SupabaseClient<any>) {\n\n    this.supabase = supabaseClient || createClient()\n\n  }\n\n  // ========== CONVERSATIONS ==========\n\n  /**\n   * Récupère toutes les conversations d'un utilisateur avec leurs participants et derniers messages\n   * \n   * Optimisation : Utilise des requêtes batch pour éviter les problèmes RLS et améliorer les performances\n   * \n   * @param userId - ID de l'utilisateur\n   * @param organizationId - ID de l'organisation\n   * @returns Liste des conversations enrichies avec participants et dernier message\n   */\n  async getConversations(userId: string, organizationId: string) {\n    // 1. Récupérer les IDs de conversation où l'utilisateur participe\n    const { data: participantConversations, error: participantError } = await this.supabase\n      .from('conversation_participants')\n      .select('conversation_id')\n      .eq('user_id', userId)\n\n    if (participantError) throw participantError\n\n    if (!participantConversations || participantConversations.length === 0) {\n      return []\n    }\n\n    const conversationIds = participantConversations.map((p: any) => p.conversation_id)\n\n    // 2. Récupérer les conversations\n    const { data: conversations, error: conversationsError } = await this.supabase\n      .from('conversations')\n      .select('*')\n      .eq('organization_id', organizationId)\n      .eq('is_archived', false)\n      .in('id', conversationIds)\n      .order('last_message_at', { ascending: false, nullsFirst: false })\n\n    if (conversationsError) throw conversationsError\n\n    if (!conversations || conversations.length === 0) {\n      return []\n    }\n\n    // 3. Récupérer TOUS les participants en une seule requête (batch)\n    const { data: allParticipants } = await this.supabase\n      .from('conversation_participants')\n      .select('*')\n      .in('conversation_id', conversationIds)\n\n    // 4. Collecter tous les IDs uniques d'utilisateurs et d'étudiants\n    const userIds = [...new Set((allParticipants || []).filter(p => p.user_id).map(p => p.user_id))]\n    const studentIds = [...new Set((allParticipants || []).filter(p => p.student_id).map(p => p.student_id))]\n\n    // 5. Récupérer tous les utilisateurs en une seule requête (batch)\n    let usersMap: Record<string, any> = {}\n    if (userIds.length > 0) {\n      const { data: usersData } = await this.supabase\n        .from('users')\n        .select('id, full_name, email, avatar_url')\n        .in('id', userIds)\n      \n      usersData?.forEach(u => { usersMap[u.id] = u })\n    }\n\n    // 6. Récupérer tous les étudiants en une seule requête (batch)\n    let studentsMap: Record<string, any> = {}\n    if (studentIds.length > 0) {\n      const { data: studentsData } = await this.supabase\n        .from('students')\n        .select('id, first_name, last_name, email, student_number')\n        .in('id', studentIds)\n      \n      studentsData?.forEach(s => { studentsMap[s.id] = s })\n    }\n\n    // 7. Récupérer les derniers messages de chaque conversation en parallèle\n    const lastMessagesPromises = conversations.map(conv =>\n      this.supabase\n        .from('messages')\n        .select('*')\n        .eq('conversation_id', conv.id)\n        .eq('is_deleted', false)\n        .order('created_at', { ascending: false })\n        .limit(1)\n        .maybeSingle()\n    )\n    const lastMessagesResults = await Promise.all(lastMessagesPromises)\n\n    // 8. Collecter les IDs d'expéditeurs des derniers messages\n    const senderIds = [...new Set(lastMessagesResults.filter(r => r.data?.sender_id).map(r => r.data.sender_id))]\n    const studentSenderIds = [...new Set(lastMessagesResults.filter(r => r.data?.student_sender_id).map(r => r.data.student_sender_id))]\n\n    // 9. Récupérer les expéditeurs manquants\n    if (senderIds.length > 0) {\n      const { data: additionalUsers } = await this.supabase\n        .from('users')\n        .select('id, full_name, email')\n        .in('id', senderIds.filter(id => !usersMap[id]))\n      \n      additionalUsers?.forEach(u => { usersMap[u.id] = u })\n    }\n\n    if (studentSenderIds.length > 0) {\n      const { data: additionalStudents } = await this.supabase\n        .from('students')\n        .select('id, first_name, last_name, email, student_number')\n        .in('id', studentSenderIds.filter(id => !studentsMap[id]))\n      \n      additionalStudents?.forEach(s => { studentsMap[s.id] = s })\n    }\n\n    // 10. Assembler les données enrichies (aucune requête supplémentaire)\n    return conversations.map((conv, index) => {\n      // Participants de cette conversation\n      const convParticipants = (allParticipants || [])\n        .filter(p => p.conversation_id === conv.id)\n        .map(participant => ({\n          ...participant,\n          user: participant.user_id ? usersMap[participant.user_id] || null : null,\n          student: participant.student_id ? studentsMap[participant.student_id] || null : null,\n        }))\n\n      // Dernier message\n      const lastMessage = lastMessagesResults[index].data\n      let enrichedLastMessage = null\n      if (lastMessage) {\n        enrichedLastMessage = {\n          ...lastMessage,\n          sender: lastMessage.sender_id ? usersMap[lastMessage.sender_id] || null : null,\n          student_sender: lastMessage.student_sender_id ? studentsMap[lastMessage.student_sender_id] || null : null,\n        }\n      }\n\n      return {\n        ...conv,\n        participants: convParticipants,\n        last_message: enrichedLastMessage,\n      }\n    })\n  }\n\n  async getConversationsByStudentId(studentId: string, organizationId: string) {\n    const { data: participantConversations, error: participantError } = await this.supabase\n      .from('conversation_participants')\n      .select('conversation_id')\n      .eq('student_id', studentId)\n\n    if (participantError) throw participantError\n\n    if (!participantConversations || participantConversations.length === 0) {\n      return []\n    }\n\n    const conversationIds = participantConversations.map((p: any) => p.conversation_id)\n\n    const { data: conversations, error: conversationsError } = await this.supabase\n      .from('conversations')\n      .select('*')\n      .eq('organization_id', organizationId)\n      .eq('is_archived', false)\n      .in('id', conversationIds)\n      .order('last_message_at', { ascending: false, nullsFirst: false })\n\n    if (conversationsError) throw conversationsError\n\n    if (!conversations || conversations.length === 0) {\n      return []\n    }\n\n    const enrichedConversations = await Promise.all(\n      conversations.map(async (conversation: any) => {\n        const { data: participants } = await this.supabase\n          .from('conversation_participants')\n          .select('*')\n          .eq('conversation_id', conversation.id)\n\n        const enrichedParticipants = await Promise.all(\n          (participants || []).map(async (participant: any) => {\n            let user = null\n            let student = null\n\n            if (participant.user_id) {\n              const { data: userData } = await this.supabase\n                .from('users')\n                .select('id, full_name, email, avatar_url')\n                .eq('id', participant.user_id)\n                .maybeSingle()\n              user = userData\n            }\n\n            if (participant.student_id) {\n              const { data: studentData } = await this.supabase\n                .from('students')\n                .select('id, first_name, last_name, email, student_number')\n                .eq('id', participant.student_id)\n                .maybeSingle()\n              student = studentData\n            }\n\n            return {\n              ...participant,\n              user,\n              student,\n            }\n          })\n        )\n\n        const { data: lastMessages } = await this.supabase\n          .from('messages')\n          .select('*')\n          .eq('conversation_id', conversation.id)\n          .eq('is_deleted', false)\n          .order('created_at', { ascending: false })\n          .limit(1)\n\n        let lastMessage = null\n        if (lastMessages && lastMessages.length > 0) {\n          const msg = lastMessages[0]\n          let sender = null\n          if (msg.sender_id) {\n            const { data: senderData } = await this.supabase\n              .from('users')\n              .select('id, full_name, email')\n              .eq('id', msg.sender_id)\n              .maybeSingle()\n            sender = senderData\n          }\n          lastMessage = {\n            ...msg,\n            sender,\n          }\n        }\n\n        return {\n          ...conversation,\n          participants: enrichedParticipants,\n          last_message: lastMessage,\n        }\n      })\n    )\n\n    return enrichedConversations\n  }\n\n  async getConversationById(conversationId: string) {\n    const { data: conversation, error: convError } = await this.supabase\n      .from('conversations')\n      .select('id, organization_id, conversation_type, name, created_by, created_at, updated_at, is_archived, last_message_at')\n      .eq('id', conversationId)\n      .maybeSingle()\n\n    if (convError) {\n      console.error('[MESSAGING] Erreur récupération conversation:', convError)\n      throw convError\n    }\n\n    if (!conversation) {\n      return null\n    }\n\n    const { data: participants, error: participantsError } = await this.supabase\n      .from('conversation_participants')\n      .select('*')\n      .eq('conversation_id', conversationId)\n\n    if (participantsError) throw participantsError\n\n    const enrichedParticipants = await Promise.all(\n      (participants || []).map(async (participant: any) => {\n        let user = null\n        let student = null\n\n        if (participant.user_id) {\n          const { data: userData } = await this.supabase\n            .from('users')\n            .select('id, full_name, email, avatar_url')\n            .eq('id', participant.user_id)\n            .maybeSingle()\n          user = userData\n        }\n\n        if (participant.student_id) {\n          const { data: studentData } = await this.supabase\n            .from('students')\n            .select('id, first_name, last_name, email, student_number')\n            .eq('id', participant.student_id)\n            .maybeSingle()\n          student = studentData\n        }\n\n        return {\n          ...participant,\n          user,\n          student,\n        }\n      })\n    )\n\n    return {\n      ...conversation,\n      participants: enrichedParticipants,\n    }\n  }\n\n  /**\n   * Crée une conversation directe entre deux utilisateurs ou un utilisateur et un étudiant\n   * \n   * Vérifie d'abord si une conversation directe existe déjà entre ces participants\n   * pour éviter les doublons. Si une conversation existe, la retourne.\n   * \n   * @param userId1 - ID du premier utilisateur (créateur)\n   * @param userId2 - ID du deuxième utilisateur (optionnel, peut être null)\n   * @param organizationId - ID de l'organisation\n   * @param studentId2 - ID de l'étudiant (optionnel, utilisé si userId2 est null)\n   * @returns La conversation créée ou existante avec ses participants\n   */\n  async createDirectConversation(\n    userId1: string, \n    userId2: string | null, \n    organizationId: string,\n    studentId2?: string | null\n  ) {\n    const { data: allDirectConversations, error: conversationsError } = await this.supabase\n      .from('conversations')\n      .select('id')\n      .eq('conversation_type', 'direct')\n      .eq('organization_id', organizationId)\n    \n    if (!conversationsError && allDirectConversations && allDirectConversations.length > 0) {\n      const conversationIds = allDirectConversations.map((c: any) => c.id)\n      \n      const { data: user1Participants, error: user1Error } = await this.supabase\n        .from('conversation_participants')\n        .select('conversation_id')\n        .eq('user_id', userId1)\n        .in('conversation_id', conversationIds)\n      \n      if (!user1Error && user1Participants && user1Participants.length > 0) {\n        const user1ConversationIds = user1Participants.map((p: any) => p.conversation_id)\n        \n        let participant2Query = this.supabase\n          .from('conversation_participants')\n          .select('conversation_id')\n          .in('conversation_id', user1ConversationIds)\n        \n        if (userId2) {\n          participant2Query = participant2Query.eq('user_id', userId2)\n        } else if (studentId2) {\n          participant2Query = participant2Query.eq('student_id', studentId2)\n        }\n        \n        const { data: existingParticipant2 } = await participant2Query.maybeSingle()\n        \n        if (existingParticipant2) {\n          return this.getConversationById(existingParticipant2.conversation_id)\n        }\n      }\n    }\n\n    const { data: conversation, error: convError } = await this.supabase\n      .from('conversations')\n      .insert({\n        organization_id: organizationId,\n        conversation_type: 'direct',\n        created_by: userId1,\n      })\n      .select()\n      .single()\n\n    if (convError) throw convError\n\n    await this.addParticipant(conversation.id, userId1, 'member')\n    await this.addParticipant(conversation.id, userId2, 'member', studentId2)\n\n    return this.getConversationById(conversation.id)\n  }\n\n  /**\n   * Crée une conversation de groupe avec plusieurs participants\n   * \n   * @param name - Nom de la conversation de groupe\n   * @param userIds - Liste des IDs d'utilisateurs à ajouter\n   * @param organizationId - ID de l'organisation\n   * @param createdBy - ID de l'utilisateur créateur (sera owner)\n   * @param studentIds - Liste optionnelle des IDs d'étudiants à ajouter\n   * @returns La conversation créée avec tous ses participants\n   */\n  async createGroupConversation(\n    name: string,\n    userIds: string[],\n    organizationId: string,\n    createdBy: string,\n    studentIds?: string[]\n  ) {\n    const { data: conversation, error } = await this.supabase\n      .from('conversations')\n      .insert({\n        organization_id: organizationId,\n        conversation_type: 'group',\n        name,\n        created_by: createdBy,\n      })\n      .select()\n      .single()\n\n    if (error) throw error\n\n    for (const userId of userIds) {\n      await this.addParticipant(\n        conversation.id,\n        userId,\n        userId === createdBy ? 'owner' : 'member'\n      )\n    }\n\n    if (studentIds && studentIds.length > 0) {\n      for (const studentId of studentIds) {\n        await this.addParticipant(\n          conversation.id,\n          null,\n          'member',\n          studentId\n        )\n      }\n    }\n\n    return this.getConversationById(conversation.id)\n  }\n\n  async updateConversation(conversationId: string, updates: TableUpdate<'conversations'>) {\n    const { data, error } = await this.supabase\n      .from('conversations')\n      .update(updates)\n      .eq('id', conversationId)\n      .select()\n      .single()\n\n    if (error) throw error\n    return data\n  }\n\n  async archiveConversation(conversationId: string) {\n    return this.updateConversation(conversationId, { is_archived: true })\n  }\n\n  async deleteConversation(conversationId: string) {\n    return this.updateConversation(conversationId, { is_archived: true })\n  }\n\n  async pinConversation(conversationId: string, isPinned: boolean) {\n    return this.updateConversation(conversationId, { is_pinned: isPinned })\n  }\n\n  // ========== PARTICIPANTS ==========\n\n  async addParticipant(\n    conversationId: string, \n    userId: string | null, \n    role: string = 'member',\n    studentId?: string | null\n  ) {\n    const insertData: any = {\n      conversation_id: conversationId,\n      role,\n    }\n    \n    if (userId) {\n      insertData.user_id = userId\n    } else if (studentId) {\n      insertData.student_id = studentId\n    } else {\n      throw new Error('Either userId or studentId must be provided')\n    }\n    \n    const { data, error } = await this.supabase\n      .from('conversation_participants')\n      .insert(insertData)\n      .select()\n      .single()\n\n    if (error) throw error\n    return data\n  }\n\n  async removeParticipant(conversationId: string, userId: string) {\n    const { error } = await this.supabase\n      .from('conversation_participants')\n      .delete()\n      .eq('conversation_id', conversationId)\n      .eq('user_id', userId)\n\n    if (error) throw error\n  }\n\n  async updateParticipantRole(conversationId: string, userId: string, role: string) {\n    const { data, error } = await this.supabase\n      .from('conversation_participants')\n      .update({ role })\n      .eq('conversation_id', conversationId)\n      .eq('user_id', userId)\n      .select()\n      .single()\n\n    if (error) throw error\n    return data\n  }\n\n  async muteConversation(conversationId: string, userId: string, isMuted: boolean) {\n    const { data, error } = await this.supabase\n      .from('conversation_participants')\n      .update({ is_muted: isMuted })\n      .eq('conversation_id', conversationId)\n      .eq('user_id', userId)\n      .select()\n      .single()\n\n    if (error) throw error\n    return data\n  }\n\n  async markAsRead(conversationId: string, userId: string) {\n    const { error: updateError } = await this.supabase\n      .from('conversation_participants')\n      .update({ last_read_at: new Date().toISOString() })\n      .eq('conversation_id', conversationId)\n      .eq('user_id', userId)\n\n    if (updateError) throw updateError\n\n    const { data: messages } = await this.supabase\n      .from('messages')\n      .select('id')\n      .eq('conversation_id', conversationId)\n      .not('sender_id', 'eq', userId)\n\n    if (messages) {\n      for (const message of messages) {\n        await this.supabase\n          .from('message_reads')\n          .upsert({\n            message_id: message.id,\n            user_id: userId,\n            read_at: new Date().toISOString(),\n          })\n      }\n    }\n  }\n\n  // ========== MESSAGES ==========\n\n  /**\n   * Récupère les messages d'une conversation avec pagination\n   * \n   * Enrichit chaque message avec les données de l'expéditeur (utilisateur ou étudiant)\n   * et les données du message de réponse si présent.\n   * \n   * @param conversationId - ID de la conversation\n   * @param limit - Nombre de messages à récupérer (défaut: 50)\n   * @param offset - Offset pour la pagination (défaut: 0)\n   * @returns Liste des messages enrichis, triés par date croissante\n   */\n  async getMessages(conversationId: string, limit: number = 50, offset: number = 0) {\n    const { data: messages, error } = await this.supabase\n      .from('messages')\n      .select('*')\n      .eq('conversation_id', conversationId)\n      .eq('is_deleted', false)\n      .order('created_at', { ascending: false })\n      .range(offset, offset + limit - 1)\n\n    if (error) throw error\n\n    if (!messages || messages.length === 0) {\n      return []\n    }\n\n    const enrichedMessages = await Promise.all(\n      messages.map(async (message: any) => {\n        let sender = null\n        let studentSender = null\n        let replyTo = null\n\n        if (message.sender_id) {\n          const { data: userData } = await this.supabase\n            .from('users')\n            .select('id, full_name, email, avatar_url')\n            .eq('id', message.sender_id)\n            .maybeSingle()\n          sender = userData\n        }\n\n        if (message.student_sender_id) {\n          const { data: studentData } = await this.supabase\n            .from('students')\n            .select('id, first_name, last_name, email, student_number')\n            .eq('id', message.student_sender_id)\n            .maybeSingle()\n          studentSender = studentData\n        }\n\n        if (message.reply_to_id) {\n          const { data: replyMessage } = await this.supabase\n            .from('messages')\n            .select('*')\n            .eq('id', message.reply_to_id)\n            .maybeSingle()\n          \n          if (replyMessage) {\n            let replySender = null\n            let replyStudentSender = null\n            \n            if (replyMessage.sender_id) {\n              const { data: replyUserData } = await this.supabase\n                .from('users')\n                .select('id, full_name')\n                .eq('id', replyMessage.sender_id)\n                .maybeSingle()\n              replySender = replyUserData\n            }\n            \n            if (replyMessage.student_sender_id) {\n              const { data: replyStudentData } = await this.supabase\n                .from('students')\n                .select('id, first_name, last_name, email, student_number')\n                .eq('id', replyMessage.student_sender_id)\n                .maybeSingle()\n              replyStudentSender = replyStudentData\n            }\n            \n            replyTo = {\n              ...replyMessage,\n              sender: replySender,\n              student_sender: replyStudentSender,\n            }\n          }\n        }\n\n        return {\n          ...message,\n          sender,\n          student_sender: studentSender,\n          reply_to: replyTo,\n        }\n      })\n    )\n\n    return enrichedMessages.reverse()\n  }\n\n  /**\n   * Upload un fichier dans le bucket Supabase Storage pour les messages\n   * \n   * @param file - Fichier à uploader\n   * @param conversationId - ID de la conversation (utilisé pour organiser les fichiers)\n   * @returns Le chemin du fichier uploadé (à stocker dans la DB)\n   */\n  async uploadAttachment(file: File, conversationId: string): Promise<string> {\n    const fileExt = file.name.split('.').pop()\n    const fileName = `${Date.now()}-${Math.random().toString(36).substring(7)}.${fileExt}`\n    const filePath = `${conversationId}/${fileName}`\n\n    const { data, error } = await this.supabase.storage\n      .from('messages')\n      .upload(filePath, file, {\n        cacheControl: '3600',\n        upsert: false,\n      })\n\n    if (error) throw error\n\n    return filePath\n  }\n\n  /**\n   * Génère une URL signée pour télécharger un fichier attaché\n   * \n   * L'URL est valide pendant 1 heure (3600 secondes).\n   * \n   * @param filePath - Chemin du fichier dans le bucket Storage\n   * @returns URL signée pour télécharger le fichier\n   */\n  async getAttachmentUrl(filePath: string): Promise<string> {\n    const { data, error } = await this.supabase.storage\n      .from('messages')\n      .createSignedUrl(filePath, 3600)\n\n    if (error) throw error\n\n    return data.signedUrl\n  }\n\n  /**\n   * Envoie un message dans une conversation\n   * \n   * Enrichit le message avec les données de l'expéditeur (utilisateur ou étudiant)\n   * et met à jour le timestamp last_message_at de la conversation.\n   * \n   * @param message - Données du message à envoyer\n   * @returns Le message créé avec les données de l'expéditeur\n   */\n  async sendMessage(message: TableInsert<'messages'>) {\n    const { data: insertedMessage, error } = await this.supabase\n      .from('messages')\n      .insert(message)\n      .select('*')\n      .single()\n\n    if (error) throw error\n\n    let sender = null\n    let studentSender = null\n    \n    if (insertedMessage.sender_id) {\n      const { data: userData } = await this.supabase\n        .from('users')\n        .select('id, full_name, email, avatar_url')\n        .eq('id', insertedMessage.sender_id)\n        .maybeSingle()\n      sender = userData\n    }\n    \n    if (insertedMessage.student_sender_id) {\n      const { data: studentData } = await this.supabase\n        .from('students')\n        .select('id, first_name, last_name, email, student_number')\n        .eq('id', insertedMessage.student_sender_id)\n        .maybeSingle()\n      studentSender = studentData\n    }\n\n    return {\n      ...insertedMessage,\n      sender,\n      student_sender: studentSender,\n    }\n  }\n\n  async updateMessage(messageId: string, content: string) {\n    const { data, error } = await this.supabase\n      .from('messages')\n      .update({ content, is_edited: true })\n      .eq('id', messageId)\n      .select()\n      .single()\n\n    if (error) throw error\n    return data\n  }\n\n  async deleteMessage(messageId: string) {\n    const { data, error } = await this.supabase\n      .from('messages')\n      .update({\n        is_deleted: true,\n        deleted_at: new Date().toISOString(),\n        content: 'Message supprimé',\n      })\n      .eq('id', messageId)\n      .select()\n      .single()\n\n    if (error) throw error\n    return data\n  }\n\n  async addReaction(messageId: string, userId: string, emoji: string) {\n    const { data: message } = await this.supabase\n      .from('messages')\n      .select('reactions')\n      .eq('id', messageId)\n      .single()\n\n    if (!message) throw new Error('Message non trouvé')\n\n    const reactions = (message.reactions as Record<string, string[]>) || {}\n    if (!reactions[emoji]) {\n      reactions[emoji] = []\n    }\n    if (!reactions[emoji].includes(userId)) {\n      reactions[emoji].push(userId)\n    }\n\n    const { data, error } = await this.supabase\n      .from('messages')\n      .update({ reactions })\n      .eq('id', messageId)\n      .select()\n      .single()\n\n    if (error) throw error\n    return data\n  }\n\n  async removeReaction(messageId: string, userId: string, emoji: string) {\n    const { data: message } = await this.supabase\n      .from('messages')\n      .select('reactions')\n      .eq('id', messageId)\n      .single()\n\n    if (!message) throw new Error('Message non trouvé')\n\n    const reactions = (message.reactions as Record<string, string[]>) || {}\n    if (reactions[emoji]) {\n      reactions[emoji] = reactions[emoji].filter((id: string) => id !== userId)\n      if (reactions[emoji].length === 0) {\n        delete reactions[emoji]\n      }\n    }\n\n    const { data, error } = await this.supabase\n      .from('messages')\n      .update({ reactions })\n      .eq('id', messageId)\n      .select()\n      .single()\n\n    if (error) throw error\n    return data\n  }\n\n  // ========== PINNED MESSAGES ==========\n\n  async pinMessage(conversationId: string, messageId: string, userId: string) {\n    const { data, error } = await this.supabase\n      .from('pinned_messages')\n      .insert({\n        conversation_id: conversationId,\n        message_id: messageId,\n        pinned_by: userId,\n      })\n      .select()\n      .single()\n\n    if (error) throw error\n    return data\n  }\n\n  async unpinMessage(conversationId: string, messageId: string) {\n    const { error } = await this.supabase\n      .from('pinned_messages')\n      .delete()\n      .eq('conversation_id', conversationId)\n      .eq('message_id', messageId)\n\n    if (error) throw error\n  }\n\n  async getPinnedMessages(conversationId: string) {\n    const { data, error } = await this.supabase\n      .from('pinned_messages')\n      .select(`\n        *,\n        message:messages(*, sender:users(id, full_name, email)),\n        pinned_by_user:users(id, full_name)\n      `)\n      .eq('conversation_id', conversationId)\n      .order('pinned_at', { ascending: false })\n\n    if (error) throw error\n    return data\n  }\n\n  // ========== CALLS ==========\n\n  async createCall(call: TableInsert<'calls'>) {\n    const { data, error } = await this.supabase\n      .from('calls')\n      .insert(call)\n      .select()\n      .single()\n\n    if (error) throw error\n    return data\n  }\n\n  async updateCallStatus(callId: string, status: string, duration?: number) {\n    const updates: Record<string, string | number | undefined> = { status }\n    if (status === 'active') {\n      updates.started_at = new Date().toISOString()\n    } else if (status === 'ended') {\n      updates.ended_at = new Date().toISOString()\n      if (duration) {\n        updates.duration_seconds = duration\n      }\n    }\n\n    const { data, error } = await this.supabase\n      .from('calls')\n      .update(updates)\n      .eq('id', callId)\n      .select()\n      .single()\n\n    if (error) throw error\n    return data\n  }\n\n  async addCallParticipant(callId: string, userId: string) {\n    const { data, error } = await this.supabase\n      .from('call_participants')\n      .insert({\n        call_id: callId,\n        user_id: userId,\n        status: 'joined',\n        joined_at: new Date().toISOString(),\n      })\n      .select()\n      .single()\n\n    if (error) throw error\n    return data\n  }\n\n  // ========== NOTIFICATIONS ==========\n\n  async getNotifications(userId: string, unreadOnly: boolean = false) {\n    let query = this.supabase\n      .from('message_notifications')\n      .select(`\n        *,\n        conversation:conversations(*),\n        message:messages(*, sender:users(id, full_name, email))\n      `)\n      .eq('user_id', userId)\n\n    if (unreadOnly) {\n      query = query.eq('is_read', false)\n    }\n\n    const { data, error } = await query\n      .order('created_at', { ascending: false })\n      .limit(50)\n\n    if (error) throw error\n    return data\n  }\n\n  async markNotificationAsRead(notificationId: string) {\n    const { data, error } = await this.supabase\n      .from('message_notifications')\n      .update({\n        is_read: true,\n        read_at: new Date().toISOString(),\n      })\n      .eq('id', notificationId)\n      .select()\n      .single()\n\n    if (error) throw error\n    return data\n  }\n\n  async markAllNotificationsAsRead(userId: string) {\n    const { error } = await this.supabase\n      .from('message_notifications')\n      .update({\n        is_read: true,\n        read_at: new Date().toISOString(),\n      })\n      .eq('user_id', userId)\n      .eq('is_read', false)\n\n    if (error) throw error\n  }\n\n  // ========== SEARCH ==========\n\n  async searchMessages(conversationId: string, query: string) {\n    const { data, error } = await this.supabase\n      .from('messages')\n      .select(`\n        *,\n        sender:users(id, full_name, email, avatar_url)\n      `)\n      .eq('conversation_id', conversationId)\n      .eq('is_deleted', false)\n      .ilike('content', `%${query}%`)\n      .order('created_at', { ascending: false })\n      .limit(50)\n\n    if (error) throw error\n    return data\n  }\n}\n\nexport const messagingService = new MessagingService()\n"],"names":[],"mappings":"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","ignoreList":[0,1]}