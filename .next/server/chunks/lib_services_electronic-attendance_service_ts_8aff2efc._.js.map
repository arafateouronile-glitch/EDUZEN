{"version":3,"sources":["../../../lib/services/electronic-attendance.service.ts","../../../lib/services/attendance.service.ts"],"sourcesContent":["import { createClient } from '@/lib/supabase/client'\nimport type { SupabaseClient } from '@supabase/supabase-js'\nimport { Database } from '@/types/database.types'\nimport type { TableRow, TableInsert, TableUpdate, FlexibleInsert, FlexibleUpdate } from '@/lib/types/supabase-helpers'\nimport { errorHandler, AppError, ErrorCode } from '@/lib/errors'\nimport { logger } from '@/lib/utils/logger'\nimport { emailService } from './email.service'\nimport { AttendanceService } from './attendance.service'\n\ntype ElectronicAttendanceSession = TableRow<'electronic_attendance_sessions'>\ntype ElectronicAttendanceRequest = TableRow<'electronic_attendance_requests'>\ntype ElectronicAttendanceSessionInsert = TableInsert<'electronic_attendance_sessions'>\ntype ElectronicAttendanceRequestInsert = TableInsert<'electronic_attendance_requests'>\n\nexport interface CreateAttendanceSessionParams {\n  sessionId: string\n  organizationId: string\n  title: string\n  date: string\n  startTime?: string\n  endTime?: string\n  mode?: 'electronic' | 'manual' | 'hybrid'\n  requireSignature?: boolean\n  requireGeolocation?: boolean\n  allowedRadiusMeters?: number\n  qrCodeEnabled?: boolean\n  latitude?: number\n  longitude?: number\n  locationName?: string\n  opensAt?: string\n  closesAt?: string\n}\n\nexport interface AttendanceSessionWithRequests extends ElectronicAttendanceSession {\n  requests?: ElectronicAttendanceRequest[]\n  session?: {\n    id: string\n    title: string | null\n    start_date: string | null\n    end_date: string | null\n  }\n}\n\n/**\n * Service pour g√©rer les √©margements √©lectroniques\n */\nexport class ElectronicAttendanceService {\n  private supabase: SupabaseClient<Database>\n  private attendanceService: AttendanceService\n\n  constructor(supabaseClient?: SupabaseClient<Database>) {\n    this.supabase = supabaseClient || createClient()\n    // Cr√©er une instance d'AttendanceService avec le m√™me client Supabase\n    this.attendanceService = new AttendanceService(this.supabase)\n  }\n\n  /**\n   * Cr√©e une session d'√©margement √©lectronique\n   */\n  async createAttendanceSession(params: CreateAttendanceSessionParams) {\n    try {\n      const { data: userData } = await this.supabase.auth.getUser()\n      if (!userData.user) {\n        throw errorHandler.createAuthError(ErrorCode.AUTH_REQUIRED, 'Utilisateur non authentifi√©')\n      }\n\n      // R√©cup√©rer les √©tudiants inscrits √† la session\n      const { data: enrollments, error: enrollmentsError } = await this.supabase\n        .from('enrollments')\n        .select('student_id, students(id, first_name, last_name, email)')\n        .eq('session_id', params.sessionId)\n        .in('status', ['confirmed', 'active'])\n\n      if (enrollmentsError) throw enrollmentsError\n\n      const students = enrollments\n        ?.map((e: any) => e.students)\n        .filter((s: any) => s && s.email)\n\n      // G√©n√©rer un QR code si activ√©\n      let qrCodeData: string | null = null\n      if (params.qrCodeEnabled) {\n        qrCodeData = this.generateQRCodeData()\n      }\n\n      // Cr√©er la session d'√©margement\n      const sessionData: FlexibleInsert<'electronic_attendance_sessions'> = {\n        organization_id: params.organizationId,\n        session_id: params.sessionId,\n        title: params.title,\n        date: params.date,\n        start_time: params.startTime || null,\n        end_time: params.endTime || null,\n        status: 'draft',\n        mode: params.mode || 'electronic',\n        require_signature: params.requireSignature !== false,\n        require_geolocation: params.requireGeolocation || false,\n        allowed_radius_meters: params.allowedRadiusMeters || 100,\n        qr_code_enabled: params.qrCodeEnabled || false,\n        qr_code_data: qrCodeData,\n        latitude: params.latitude || null,\n        longitude: params.longitude || null,\n        location_name: params.locationName || null,\n        opens_at: params.opensAt || null,\n        closes_at: params.closesAt || null,\n        total_expected: students?.length || 0,\n        created_by: userData.user.id,\n      }\n\n      const { data, error } = await this.supabase\n        .from('electronic_attendance_sessions')\n        .insert(sessionData as ElectronicAttendanceSessionInsert)\n        .select(`\n          *,\n          session:sessions(id, title, start_date, end_date)\n        `)\n        .single()\n\n      if (error) throw error\n\n      logger.info('Session d\\'√©margement cr√©√©e', {\n        attendanceSessionId: data.id,\n        sessionId: params.sessionId,\n        expectedStudents: students?.length || 0,\n      })\n\n      return data as unknown as AttendanceSessionWithRequests\n    } catch (error) {\n      if (error instanceof AppError) throw error\n      throw errorHandler.handleError(error, {\n        operation: 'createAttendanceSession',\n        sessionId: params.sessionId,\n      })\n    }\n  }\n\n  /**\n   * Lance une session d'√©margement et envoie les emails aux apprenants\n   */\n  async launchAttendanceSession(\n    attendanceSessionId: string,\n    sendEmails: boolean = true\n  ) {\n    try {\n      // R√©cup√©rer la session d'√©margement\n      const { data: attendanceSession, error: sessionError } = await this.supabase\n        .from('electronic_attendance_sessions')\n        .select('*, session:sessions(id, title)')\n        .eq('id', attendanceSessionId)\n        .single()\n\n      if (sessionError || !attendanceSession) {\n        throw errorHandler.createNotFoundError('Session d\\'√©margement introuvable', { attendanceSessionId })\n      }\n\n      if (attendanceSession.status !== 'draft') {\n        throw errorHandler.createValidationError(\n          'La session d\\'√©margement a d√©j√† √©t√© lanc√©e',\n          'status'\n        )\n      }\n\n      // R√©cup√©rer les √©tudiants inscrits\n      const { data: enrollments, error: enrollmentsError } = await this.supabase\n        .from('enrollments')\n        .select('student_id, students(id, first_name, last_name, email)')\n        .eq('session_id', attendanceSession.session_id)\n        .in('status', ['confirmed', 'active'])\n\n      if (enrollmentsError) throw enrollmentsError\n\n      const students = enrollments\n        ?.map((e: any) => e.students)\n        .filter((s: any) => s && s.email) || []\n\n      // Cr√©er les demandes d'√©margement pour chaque √©tudiant\n      const requests = students.map((student: any) => ({\n        organization_id: attendanceSession.organization_id,\n        attendance_session_id: attendanceSessionId,\n        student_id: student.id,\n        student_email: student.email,\n        student_name: `${student.first_name} ${student.last_name}`,\n        status: 'pending' as const,\n        signature_token: this.generateSignatureToken(),\n      }))\n\n      const { data: createdRequests, error: requestsError } = await this.supabase\n        .from('electronic_attendance_requests')\n        .insert(requests as ElectronicAttendanceRequestInsert[])\n        .select()\n\n      if (requestsError) throw requestsError\n\n      // Mettre √† jour le statut de la session\n      const { error: updateError } = await this.supabase\n        .from('electronic_attendance_sessions')\n        .update({ status: 'active' } as any)\n        .eq('id', attendanceSessionId)\n\n      if (updateError) throw updateError\n\n      // Envoyer les emails si demand√©\n      if (sendEmails && createdRequests) {\n        await this.sendAttendanceRequestEmails(\n          createdRequests,\n          attendanceSession,\n          (attendanceSession.session as any)?.title || attendanceSession.title\n        )\n      }\n\n      logger.info('Session d\\'√©margement lanc√©e', {\n        attendanceSessionId,\n        requestsSent: createdRequests?.length || 0,\n        emailsSent: sendEmails,\n      })\n\n      return {\n        attendanceSession,\n        requests: createdRequests,\n      }\n    } catch (error) {\n      if (error instanceof AppError) throw error\n      throw errorHandler.handleError(error, {\n        operation: 'launchAttendanceSession',\n        attendanceSessionId,\n      })\n    }\n  }\n\n  /**\n   * R√©cup√®re une session d'√©margement par son ID\n   */\n  async getAttendanceSessionById(id: string) {\n    try {\n      const { data, error } = await this.supabase\n        .from('electronic_attendance_sessions')\n        .select(`\n          *,\n          session:sessions(id, title, start_date, end_date),\n          requests:electronic_attendance_requests(*)\n        `)\n        .eq('id', id)\n        .single()\n\n      if (error) {\n        if (error.code === 'PGRST116') {\n          throw errorHandler.createNotFoundError('Session d\\'√©margement introuvable', { id })\n        }\n        throw error\n      }\n\n      return data as unknown as AttendanceSessionWithRequests\n    } catch (error) {\n      if (error instanceof AppError) throw error\n      throw errorHandler.handleError(error, {\n        operation: 'getAttendanceSessionById',\n        id,\n      })\n    }\n  }\n\n  /**\n   * R√©cup√®re toutes les sessions d'√©margement pour une session de formation\n   */\n  async getAttendanceSessionsBySession(sessionId: string) {\n    try {\n      const { data, error } = await this.supabase\n        .from('electronic_attendance_sessions')\n        .select(`\n          *,\n          requests:electronic_attendance_requests(\n            id,\n            student_name,\n            student_email,\n            status,\n            signed_at\n          )\n        `)\n        .eq('session_id', sessionId)\n        .order('date', { ascending: false })\n\n      if (error) throw error\n      return data || []\n    } catch (error) {\n      if (error instanceof AppError) throw error\n      throw errorHandler.handleError(error, {\n        operation: 'getAttendanceSessionsBySession',\n        sessionId,\n      })\n    }\n  }\n\n  /**\n   * R√©cup√®re toutes les sessions d'√©margement d'une organisation\n   */\n  async getAttendanceSessionsByOrganization(\n    organizationId: string,\n    filters?: {\n      status?: 'draft' | 'active' | 'closed' | 'cancelled'\n      date?: string\n      sessionId?: string\n    }\n  ) {\n    try {\n      let query = this.supabase\n        .from('electronic_attendance_sessions')\n        .select(`\n          *,\n          session:sessions(id, title),\n          requests:electronic_attendance_requests(\n            id,\n            status\n          )\n        `)\n        .eq('organization_id', organizationId)\n\n      if (filters?.status) {\n        query = query.eq('status', filters.status)\n      }\n\n      if (filters?.date) {\n        query = query.eq('date', filters.date)\n      }\n\n      if (filters?.sessionId) {\n        query = query.eq('session_id', filters.sessionId)\n      }\n\n      const { data, error } = await query.order('date', { ascending: false })\n\n      if (error) throw error\n      return data || []\n    } catch (error) {\n      if (error instanceof AppError) throw error\n      throw errorHandler.handleError(error, {\n        operation: 'getAttendanceSessionsByOrganization',\n        organizationId,\n      })\n    }\n  }\n\n  /**\n   * R√©cup√®re une demande d'√©margement par son token\n   */\n  async getAttendanceRequestByToken(token: string) {\n    try {\n      const { data, error } = await this.supabase\n        .from('electronic_attendance_requests')\n        .select(`\n          *,\n          attendance_session:electronic_attendance_sessions(\n            id,\n            title,\n            date,\n            start_time,\n            end_time,\n            require_signature,\n            require_geolocation,\n            allowed_radius_meters,\n            latitude,\n            longitude,\n            location_name,\n            status,\n            closes_at\n          )\n        `)\n        .eq('signature_token', token)\n        .single()\n\n      if (error) {\n        if (error.code === 'PGRST116') {\n          throw errorHandler.createNotFoundError('Demande d\\'√©margement introuvable', { token })\n        }\n        throw error\n      }\n\n      // V√©rifier si la session est encore ouverte\n      const session = data.attendance_session as any\n      if (session?.status === 'closed') {\n        throw errorHandler.createValidationError('La session d\\'√©margement est ferm√©e', 'status')\n      }\n\n      if (session?.closes_at && new Date(session.closes_at) < new Date()) {\n        throw errorHandler.createValidationError('La session d\\'√©margement a expir√©', 'closes_at')\n      }\n\n      return data\n    } catch (error) {\n      if (error instanceof AppError) throw error\n      throw errorHandler.handleError(error, {\n        operation: 'getAttendanceRequestByToken',\n      })\n    }\n  }\n\n  /**\n   * Signe une demande d'√©margement\n   */\n  async signAttendanceRequest(\n    token: string,\n    signatureData: string,\n    location?: {\n      latitude: number\n      longitude: number\n      accuracy?: number\n    },\n    deviceInfo?: {\n      ipAddress?: string\n      userAgent?: string\n    }\n  ) {\n    try {\n      // R√©cup√©rer la demande\n      const request = await this.getAttendanceRequestByToken(token)\n\n      if (request.status === 'signed') {\n        throw errorHandler.createValidationError('Cette demande a d√©j√† √©t√© sign√©e', 'status')\n      }\n\n      const session = request.attendance_session as any\n\n      // Valider la g√©olocalisation si requise\n      let locationVerified = false\n      if (session?.require_geolocation && location) {\n        const validation = await this.validateAttendanceLocation(\n          session.latitude,\n          session.longitude,\n          location.latitude,\n          location.longitude,\n          session.allowed_radius_meters\n        )\n\n        if (!validation.valid) {\n          throw errorHandler.createValidationError(\n            validation.error || 'Localisation invalide',\n            'location'\n          )\n        }\n\n        locationVerified = validation.verified\n      }\n\n      // Cr√©er l'entr√©e d'√©margement dans la table attendance\n      const attendanceData = {\n        organization_id: request.organization_id,\n        student_id: request.student_id,\n        session_id: session?.session_id,\n        date: session?.date,\n        status: 'present' as const,\n        signature_url: signatureData,\n        latitude: location?.latitude,\n        longitude: location?.longitude,\n        location_accuracy: location?.accuracy,\n        location_verified: locationVerified,\n      }\n\n      const attendance = await this.attendanceService.upsert(attendanceData as any)\n\n      // Mettre √† jour la demande d'√©margement\n      const { data: updatedRequest, error: updateError } = await this.supabase\n        .from('electronic_attendance_requests')\n        .update({\n          status: 'signed',\n          signature_data: signatureData,\n          signed_at: new Date().toISOString(),\n          attendance_id: attendance.id,\n          latitude: location?.latitude || null,\n          longitude: location?.longitude || null,\n          location_accuracy: location?.accuracy || null,\n          location_verified: locationVerified,\n          ip_address: deviceInfo?.ipAddress || null,\n          user_agent: deviceInfo?.userAgent || null,\n        } as any)\n        .eq('signature_token', token)\n        .select()\n        .single()\n\n      if (updateError) throw updateError\n\n      logger.info('√âmargement √©lectronique sign√©', {\n        requestId: request.id,\n        studentId: request.student_id,\n        attendanceId: attendance.id,\n        locationVerified,\n      })\n\n      return {\n        request: updatedRequest,\n        attendance,\n      }\n    } catch (error) {\n      if (error instanceof AppError) throw error\n      throw errorHandler.handleError(error, {\n        operation: 'signAttendanceRequest',\n      })\n    }\n  }\n\n  /**\n   * Ferme une session d'√©margement\n   */\n  async closeAttendanceSession(attendanceSessionId: string) {\n    try {\n      const { data, error } = await this.supabase\n        .from('electronic_attendance_sessions')\n        .update({ status: 'closed' } as any)\n        .eq('id', attendanceSessionId)\n        .select()\n        .single()\n\n      if (error) throw error\n\n      // Marquer les demandes non sign√©es comme expir√©es\n      await this.supabase\n        .from('electronic_attendance_requests')\n        .update({ status: 'expired' } as any)\n        .eq('attendance_session_id', attendanceSessionId)\n        .eq('status', 'pending')\n\n      logger.info('Session d\\'√©margement ferm√©e', { attendanceSessionId })\n\n      return data\n    } catch (error) {\n      if (error instanceof AppError) throw error\n      throw errorHandler.handleError(error, {\n        operation: 'closeAttendanceSession',\n        attendanceSessionId,\n      })\n    }\n  }\n\n  /**\n   * Envoie un rappel d'√©margement\n   */\n  async sendAttendanceReminder(requestId: string) {\n    try {\n      const { data: request, error } = await this.supabase\n        .from('electronic_attendance_requests')\n        .select(`\n          *,\n          attendance_session:electronic_attendance_sessions(\n            id,\n            title,\n            date,\n            start_time,\n            session:sessions(title)\n          )\n        `)\n        .eq('id', requestId)\n        .single()\n\n      if (error || !request) {\n        throw errorHandler.createNotFoundError('Demande d\\'√©margement introuvable', { requestId })\n      }\n\n      if (request.status !== 'pending') {\n        throw errorHandler.createValidationError(\n          'Impossible d\\'envoyer un rappel pour une demande qui n\\'est pas en attente',\n          'status'\n        )\n      }\n\n      const session = request.attendance_session as any\n      const attendanceUrl = this.generateAttendanceUrl(request.signature_token)\n\n      await this.sendAttendanceReminderEmail(\n        request.student_email,\n        request.student_name,\n        session?.session?.title || session?.title || 'Formation',\n        session?.date,\n        attendanceUrl\n      )\n\n      // Mettre √† jour le compteur de rappels\n      await this.supabase\n        .from('electronic_attendance_requests')\n        .update({\n          reminder_count: (request.reminder_count || 0) + 1,\n          last_reminder_sent_at: new Date().toISOString(),\n        } as any)\n        .eq('id', requestId)\n\n      logger.info('Rappel d\\'√©margement envoy√©', { requestId })\n\n      return true\n    } catch (error) {\n      if (error instanceof AppError) throw error\n      throw errorHandler.handleError(error, {\n        operation: 'sendAttendanceReminder',\n        requestId,\n      })\n    }\n  }\n\n  /**\n   * Valide la g√©olocalisation pour un √©margement\n   */\n  private async validateAttendanceLocation(\n    sessionLat: number | null,\n    sessionLon: number | null,\n    userLat: number,\n    userLon: number,\n    allowedRadius: number = 100\n  ): Promise<{ valid: boolean; verified: boolean; error?: string; distance?: number }> {\n    if (!sessionLat || !sessionLon) {\n      return { valid: true, verified: false, error: 'Pas de coordonn√©es de r√©f√©rence' }\n    }\n\n    // Calculer la distance (formule de Haversine)\n    const R = 6371e3 // Rayon de la Terre en m√®tres\n    const œÜ1 = (sessionLat * Math.PI) / 180\n    const œÜ2 = (userLat * Math.PI) / 180\n    const ŒîœÜ = ((userLat - sessionLat) * Math.PI) / 180\n    const ŒîŒª = ((userLon - sessionLon) * Math.PI) / 180\n\n    const a =\n      Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +\n      Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2)\n    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a))\n\n    const distance = R * c\n\n    if (distance > allowedRadius) {\n      return {\n        valid: false,\n        verified: false,\n        error: `Vous √™tes trop loin du lieu de formation (${Math.round(distance)}m, maximum: ${allowedRadius}m)`,\n        distance,\n      }\n    }\n\n    return { valid: true, verified: true, distance }\n  }\n\n  /**\n   * G√©n√®re un token unique\n   */\n  private generateSignatureToken(): string {\n    const timestamp = Date.now().toString(36)\n    const randomPart = Math.random().toString(36).substring(2, 15)\n    const randomPart2 = Math.random().toString(36).substring(2, 15)\n    return `att-${timestamp}-${randomPart}-${randomPart2}`\n  }\n\n  /**\n   * G√©n√®re un code QR unique\n   */\n  private generateQRCodeData(): string {\n    return `qr-${Date.now()}-${Math.random().toString(36).substring(2, 15)}`\n  }\n\n  /**\n   * G√©n√®re l'URL d'√©margement\n   */\n  private generateAttendanceUrl(token: string): string {\n    const baseUrl = typeof window !== 'undefined'\n      ? window.location.origin\n      : process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000'\n\n    return `${baseUrl}/attendance/${token}`\n  }\n\n  /**\n   * Envoie les emails de demande d'√©margement\n   */\n  private async sendAttendanceRequestEmails(\n    requests: ElectronicAttendanceRequest[],\n    session: ElectronicAttendanceSession,\n    sessionTitle: string\n  ) {\n    const results = await Promise.allSettled(\n      requests.map(async (request) => {\n        const attendanceUrl = this.generateAttendanceUrl(request.signature_token)\n        return this.sendAttendanceRequestEmail(\n          request.student_email,\n          request.student_name,\n          sessionTitle,\n          session.date,\n          session.start_time || null,\n          attendanceUrl\n        )\n      })\n    )\n\n    const successful = results.filter((r) => r.status === 'fulfilled').length\n    const failed = results.filter((r) => r.status === 'rejected').length\n\n    logger.info('Emails d\\'√©margement envoy√©s', {\n      total: requests.length,\n      successful,\n      failed,\n    })\n  }\n\n  /**\n   * Envoie l'email de demande d'√©margement\n   */\n  private async sendAttendanceRequestEmail(\n    to: string,\n    studentName: string,\n    sessionTitle: string,\n    date: string,\n    startTime: string | null,\n    attendanceUrl: string\n  ) {\n    const formattedDate = new Date(date).toLocaleDateString('fr-FR', {\n      weekday: 'long',\n      day: 'numeric',\n      month: 'long',\n      year: 'numeric',\n    })\n\n    const timeText = startTime ? ` √† ${startTime}` : ''\n\n    const htmlBody = `\n      <!DOCTYPE html>\n      <html>\n        <head>\n          <meta charset=\"utf-8\">\n          <style>\n            body {\n              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\n              line-height: 1.6;\n              color: #333;\n              max-width: 600px;\n              margin: 0 auto;\n              padding: 20px;\n            }\n            .header {\n              background: linear-gradient(135deg, #10b981 0%, #059669 100%);\n              color: white;\n              padding: 30px;\n              border-radius: 8px 8px 0 0;\n              text-align: center;\n            }\n            .content {\n              background: #f9fafb;\n              padding: 30px;\n              border-radius: 0 0 8px 8px;\n            }\n            .button {\n              display: inline-block;\n              background: #10b981;\n              color: white;\n              padding: 14px 32px;\n              text-decoration: none;\n              border-radius: 6px;\n              margin: 20px 0;\n              font-weight: 600;\n            }\n            .info-box {\n              background: white;\n              border-left: 4px solid #10b981;\n              padding: 16px;\n              margin: 20px 0;\n              border-radius: 4px;\n            }\n            .footer {\n              text-align: center;\n              margin-top: 30px;\n              color: #6b7280;\n              font-size: 14px;\n            }\n          </style>\n        </head>\n        <body>\n          <div class=\"header\">\n            <h1 style=\"margin: 0;\">‚úçÔ∏è √âmargement √©lectronique</h1>\n          </div>\n          <div class=\"content\">\n            <p>Bonjour <strong>${studentName}</strong>,</p>\n\n            <p>Vous √™tes invit√©(e) √† √©marger √©lectroniquement pour la session suivante :</p>\n\n            <div class=\"info-box\">\n              <strong>üìö ${sessionTitle}</strong><br>\n              <strong>üìÖ ${formattedDate}${timeText}</strong>\n            </div>\n\n            <p>Pour valider votre pr√©sence, veuillez cliquer sur le bouton ci-dessous :</p>\n\n            <div style=\"text-align: center;\">\n              <a href=\"${attendanceUrl}\" class=\"button\">√âmarger maintenant</a>\n            </div>\n\n            <p style=\"font-size: 14px; color: #6b7280;\">\n              Ou copiez ce lien dans votre navigateur :<br>\n              <a href=\"${attendanceUrl}\" style=\"color: #10b981;\">${attendanceUrl}</a>\n            </p>\n\n            <p style=\"font-size: 14px; color: #6b7280; margin-top: 30px;\">\n              Votre signature √©lectronique sera enregistr√©e de mani√®re s√©curis√©e et conforme aux normes en vigueur.\n            </p>\n          </div>\n\n          <div class=\"footer\">\n            <p>EDUZEN - Plateforme de gestion de formation</p>\n          </div>\n        </body>\n      </html>\n    `\n\n    const textBody = `\nBonjour ${studentName},\n\nVous √™tes invit√©(e) √† √©marger √©lectroniquement pour la session suivante :\n\nSession : ${sessionTitle}\nDate : ${formattedDate}${timeText}\n\nPour valider votre pr√©sence, veuillez cliquer sur ce lien :\n${attendanceUrl}\n\nVotre signature √©lectronique sera enregistr√©e de mani√®re s√©curis√©e et conforme aux normes en vigueur.\n\n---\nEDUZEN - Plateforme de gestion de formation\n    `\n\n    await emailService.sendEmail({\n      to,\n      subject: `√âmargement √©lectronique - ${sessionTitle}`,\n      html: htmlBody,\n      text: textBody,\n    })\n  }\n\n  /**\n   * Envoie l'email de rappel d'√©margement\n   */\n  private async sendAttendanceReminderEmail(\n    to: string,\n    studentName: string,\n    sessionTitle: string,\n    date: string,\n    attendanceUrl: string\n  ) {\n    const formattedDate = new Date(date).toLocaleDateString('fr-FR', {\n      day: 'numeric',\n      month: 'long',\n      year: 'numeric',\n    })\n\n    const htmlBody = `\n      <!DOCTYPE html>\n      <html>\n        <head>\n          <meta charset=\"utf-8\">\n          <style>\n            body {\n              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\n              line-height: 1.6;\n              color: #333;\n              max-width: 600px;\n              margin: 0 auto;\n              padding: 20px;\n            }\n            .header {\n              background: linear-gradient(135deg, #f59e0b 0%, #ea580c 100%);\n              color: white;\n              padding: 30px;\n              border-radius: 8px 8px 0 0;\n              text-align: center;\n            }\n            .content {\n              background: #f9fafb;\n              padding: 30px;\n              border-radius: 0 0 8px 8px;\n            }\n            .button {\n              display: inline-block;\n              background: #f59e0b;\n              color: white;\n              padding: 14px 32px;\n              text-decoration: none;\n              border-radius: 6px;\n              margin: 20px 0;\n              font-weight: 600;\n            }\n            .footer {\n              text-align: center;\n              margin-top: 30px;\n              color: #6b7280;\n              font-size: 14px;\n            }\n          </style>\n        </head>\n        <body>\n          <div class=\"header\">\n            <h1 style=\"margin: 0;\">üîî Rappel d'√©margement</h1>\n          </div>\n          <div class=\"content\">\n            <p>Bonjour <strong>${studentName}</strong>,</p>\n\n            <p>Ceci est un rappel concernant l'√©margement √©lectronique de la session :</p>\n\n            <p><strong>üìö ${sessionTitle}</strong><br>\n            <strong>üìÖ ${formattedDate}</strong></p>\n\n            <p>Vous n'avez pas encore valid√© votre pr√©sence. Merci d'√©marger d√®s que possible.</p>\n\n            <div style=\"text-align: center;\">\n              <a href=\"${attendanceUrl}\" class=\"button\">√âmarger maintenant</a>\n            </div>\n\n            <p style=\"font-size: 14px; color: #6b7280;\">\n              Lien d'√©margement :<br>\n              <a href=\"${attendanceUrl}\" style=\"color: #f59e0b;\">${attendanceUrl}</a>\n            </p>\n          </div>\n\n          <div class=\"footer\">\n            <p>EDUZEN - Plateforme de gestion de formation</p>\n          </div>\n        </body>\n      </html>\n    `\n\n    const textBody = `\nBonjour ${studentName},\n\nCeci est un rappel concernant l'√©margement √©lectronique de la session :\n\nSession : ${sessionTitle}\nDate : ${formattedDate}\n\nVous n'avez pas encore valid√© votre pr√©sence. Merci d'√©marger d√®s que possible :\n${attendanceUrl}\n\n---\nEDUZEN - Plateforme de gestion de formation\n    `\n\n    await emailService.sendEmail({\n      to,\n      subject: `Rappel : √âmargement en attente - ${sessionTitle}`,\n      html: htmlBody,\n      text: textBody,\n    })\n  }\n}\n\nexport const electronicAttendanceService = new ElectronicAttendanceService()\n","import { createClient } from '@/lib/supabase/client'\nimport type { SupabaseClient } from '@supabase/supabase-js'\nimport { Database } from '@/types/database.types'\nimport { errorHandler, ErrorCode, AppError } from '@/lib/errors'\nimport { logger } from '@/lib/utils/logger'\nimport { getAllByOrganization, getById } from '@/lib/utils/supabase-helpers'\n\ntype Attendance = Database['public']['Tables']['attendance']['Row']\ntype AttendanceInsert = Database['public']['Tables']['attendance']['Insert']\ntype AttendanceUpdate = Database['public']['Tables']['attendance']['Update']\n\nexport class AttendanceService {\n  private supabase: SupabaseClient<Database>\n\n\n  constructor(supabaseClient?: SupabaseClient<Database>) {\n\n    this.supabase = supabaseClient || createClient()\n\n  }\n\n  /**\n   * R√©cup√®re toutes les pr√©sences d'une organisation\n   */\n  async getAll(organizationId: string, filters?: {\n    studentId?: string\n    classId?: string\n    programSessionId?: string\n    date?: string\n    status?: Attendance['status']\n  }) {\n    try {\n      // Utiliser le helper pour r√©duire la duplication\n      const filtersMap: Record<string, unknown> = {}\n      if (filters?.studentId) filtersMap.student_id = filters.studentId\n      if (filters?.classId) filtersMap.class_id = filters.classId\n      if (filters?.programSessionId) filtersMap.session_id = filters.programSessionId\n      if (filters?.date) filtersMap.date = filters.date\n      if (filters?.status) filtersMap.status = filters.status\n\n      return getAllByOrganization<Attendance>(\n        this.supabase,\n        'attendance',\n        organizationId,\n        {\n          select: '*, students(id, first_name, last_name, student_number), classes(id, name), sessions(id, title, start_time)',\n          filters: filtersMap,\n          orderBy: { column: 'date', ascending: false },\n        }\n      )\n    } catch (error) {\n      if (error instanceof AppError) {\n        throw error\n      }\n      throw errorHandler.handleError(error, {\n        organizationId,\n        operation: 'getAll',\n      })\n    }\n  }\n\n  /**\n   * R√©cup√®re l'√©margement d'une classe pour une date donn√©e\n   */\n  async getByClassAndDate(classId: string, date: string) {\n    try {\n      const { data, error } = await this.supabase\n        .from('attendance')\n        .select('*, students(id, first_name, last_name, student_number)') // ‚úÖ Jointure optimis√©e\n        .eq('class_id', classId)\n        .eq('date', date)\n        .order('students(last_name)', { ascending: true })\n\n      if (error) {\n        throw errorHandler.handleError(error, {\n          operation: 'getByClassAndDate',\n          classId,\n          date,\n        })\n      }\n\n      return data || []\n    } catch (error) {\n      if (error instanceof AppError) {\n        throw error\n      }\n      throw errorHandler.handleError(error, {\n        operation: 'getByClassAndDate',\n        classId,\n        date,\n      })\n    }\n  }\n\n  /**\n   * R√©cup√®re l'√©margement d'une session pour une date donn√©e\n   */\n  async getBySessionAndDate(sessionId: string, date: string) {\n    try {\n      const { data, error } = await this.supabase\n        .from('attendance')\n        .select('*, students(id, first_name, last_name, student_number)') // ‚úÖ Jointure optimis√©e\n        .eq('session_id', sessionId)\n        .eq('date', date)\n        .order('students(last_name)', { ascending: true })\n\n      if (error) {\n        throw errorHandler.handleError(error, {\n          operation: 'getBySessionAndDate',\n          sessionId,\n          date,\n        })\n      }\n\n      return data || []\n    } catch (error) {\n      if (error instanceof AppError) {\n        throw error\n      }\n      throw errorHandler.handleError(error, {\n        operation: 'getBySessionAndDate',\n        sessionId,\n        date,\n      })\n    }\n  }\n\n  /**\n   * Cr√©e ou met √† jour un √©margement\n   */\n  async upsert(attendance: AttendanceInsert & {\n    latitude?: number\n    longitude?: number\n    location_accuracy?: number\n    location_address?: string\n    location_method?: 'manual' | 'qr_code' | 'gps' | 'ip'\n  }) {\n    // V√©rifier la g√©olocalisation si la session l'exige\n    if (attendance.session_id && (attendance.latitude || attendance.longitude)) {\n      const locationValid = await this.validateLocation(\n        attendance.session_id,\n        attendance.latitude,\n        attendance.longitude\n      )\n\n      if (!locationValid.valid) {\n        throw errorHandler.createValidationError(\n          locationValid.error || 'Localisation invalide',\n          'location'\n        )\n      }\n\n      // Ajouter les informations de v√©rification\n      ;(attendance as Attendance & { location_verified?: boolean }).location_verified = locationValid.verified\n    }\n\n    try {\n      const { data, error } = await this.supabase\n        .from('attendance')\n        .upsert(attendance, {\n          onConflict: 'student_id,class_id,session_id,date',\n        })\n        .select()\n        .single()\n\n      if (error) {\n        if (error.code === '42501') {\n          throw errorHandler.handleError(error, {\n            code: ErrorCode.DB_RLS_POLICY_VIOLATION,\n            operation: 'upsert',\n          })\n        }\n        throw errorHandler.handleError(error, {\n          operation: 'upsert',\n          attendance,\n        })\n      }\n\n      logger.info('√âmargement cr√©√©/mis √† jour avec succ√®s', {\n        id: data?.id,\n        studentId: attendance.student_id,\n        date: attendance.date,\n      })\n\n      return data\n    } catch (error) {\n      if (error instanceof AppError) {\n        throw error\n      }\n      throw errorHandler.handleError(error, {\n        operation: 'upsert',\n        attendance,\n      })\n    }\n  }\n\n  /**\n   * Valide la g√©olocalisation pour un √©margement\n   */\n  async validateLocation(\n    sessionId: string,\n    latitude?: number,\n    longitude?: number\n  ): Promise<{ valid: boolean; verified: boolean; error?: string; distance?: number }> {\n    if (!latitude || !longitude) {\n      return { valid: false, verified: false, error: 'Coordonn√©es GPS manquantes' }\n    }\n\n    // R√©cup√©rer les informations de la session\n    const { data: session, error } = await this.supabase\n      .from('sessions')\n      .select('latitude, longitude, require_location_for_attendance, allowed_attendance_radius_meters')\n      .eq('id', sessionId)\n      .single()\n\n    if (error || !session) {\n      return { valid: false, verified: false, error: 'Session non trouv√©e' }\n    }\n\n    const sessionData = session as any\n\n    // Si la g√©olocalisation n'est pas requise, c'est valide\n    if (!sessionData.require_location_for_attendance) {\n      return { valid: true, verified: false }\n    }\n\n    // Si la session n'a pas de coordonn√©es GPS, on ne peut pas v√©rifier\n    if (!sessionData.latitude || !sessionData.longitude) {\n      return { valid: true, verified: false, error: 'Session sans coordonn√©es GPS' }\n    }\n\n    // Calculer la distance\n    const distance = this.calculateDistance(\n      sessionData.latitude,\n      sessionData.longitude,\n      latitude,\n      longitude\n    )\n\n    // V√©rifier le rayon autoris√©\n    if (sessionData.allowed_attendance_radius_meters) {\n      if (distance > sessionData.allowed_attendance_radius_meters) {\n        return {\n          valid: false,\n          verified: false,\n          error: `Vous √™tes trop loin de la session (${Math.round(distance)}m, maximum: ${sessionData.allowed_attendance_radius_meters}m)`,\n          distance,\n        }\n      }\n    }\n\n    return { valid: true, verified: true, distance }\n  }\n\n  /**\n   * Calcule la distance entre deux points GPS (formule de Haversine)\n   */\n  private calculateDistance(lat1: number, lon1: number, lat2: number, lon2: number): number {\n    const R = 6371e3 // Rayon de la Terre en m√®tres\n    const œÜ1 = (lat1 * Math.PI) / 180\n    const œÜ2 = (lat2 * Math.PI) / 180\n    const ŒîœÜ = ((lat2 - lat1) * Math.PI) / 180\n    const ŒîŒª = ((lon2 - lon1) * Math.PI) / 180\n\n    const a =\n      Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +\n      Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2)\n    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a))\n\n    return R * c // Distance en m√®tres\n  }\n\n  /**\n   * Met √† jour un √©margement\n   */\n  async update(id: string, updates: AttendanceUpdate) {\n    try {\n      const { data, error } = await this.supabase\n        .from('attendance')\n        .update(updates)\n        .eq('id', id)\n        .select()\n        .single()\n\n      if (error) {\n        if (error.code === 'PGRST116' || error.code === '42P01') {\n          throw errorHandler.handleError(error, {\n            code: ErrorCode.DB_NOT_FOUND,\n            operation: 'update',\n            id,\n          })\n        }\n        if (error.code === '42501') {\n          throw errorHandler.handleError(error, {\n            code: ErrorCode.DB_RLS_POLICY_VIOLATION,\n            operation: 'update',\n            id,\n          })\n        }\n        throw errorHandler.handleError(error, {\n          operation: 'update',\n          id,\n          updates,\n        })\n      }\n\n      if (!data) {\n        throw errorHandler.createDatabaseError(\n          `√âmargement avec l'ID ${id} introuvable pour la mise √† jour`,\n          { id }\n        )\n      }\n\n      logger.info('√âmargement mis √† jour avec succ√®s', {\n        id,\n        updates,\n      })\n\n      return data\n    } catch (error) {\n      if (error instanceof AppError) {\n        throw error\n      }\n      throw errorHandler.handleError(error, {\n        operation: 'update',\n        id,\n        updates,\n      })\n    }\n  }\n\n  /**\n   * Marque plusieurs pr√©sences en une fois\n   */\n  async markMultiple(\n    organizationId: string,\n    records: Array<{\n      student_id: string\n      class_id?: string\n      session_id?: string // Utiliser session_id au lieu de program_session_id\n      date: string\n      status: 'present' | 'absent' | 'late' | 'excused'\n      late_minutes?: number\n      teacher_id?: string\n      notes?: string\n    }>\n  ) {\n    const attendanceRecords = records.map((record) => ({\n      organization_id: organizationId,\n      ...record,\n      late_minutes: record.late_minutes || 0,\n    }))\n\n    try {\n      if (!records || records.length === 0) {\n        throw errorHandler.createValidationError(\n          'Aucun enregistrement √† marquer',\n          'records'\n        )\n      }\n\n      const { data, error } = await this.supabase\n        .from('attendance')\n        .upsert(attendanceRecords, {\n          onConflict: 'student_id,class_id,session_id,date',\n        })\n        .select()\n\n      if (error) {\n        throw errorHandler.handleError(error, {\n          operation: 'markMultiple',\n          organizationId,\n          count: records.length,\n        })\n      }\n\n      logger.info('Pr√©sences marqu√©es en masse avec succ√®s', {\n        organizationId,\n        count: data?.length || 0,\n      })\n\n      return data || []\n    } catch (error) {\n      if (error instanceof AppError) {\n        throw error\n      }\n      throw errorHandler.handleError(error, {\n        operation: 'markMultiple',\n        organizationId,\n      })\n    }\n  }\n\n  /**\n   * R√©cup√®re les statistiques de pr√©sence pour un √©l√®ve\n   */\n  async getStudentStats(studentId: string, startDate?: string, endDate?: string) {\n    let query = this.supabase\n      .from('attendance')\n      .select('status, date')\n      .eq('student_id', studentId)\n\n    if (startDate) {\n      query = query.gte('date', startDate)\n    }\n\n    if (endDate) {\n      query = query.lte('date', endDate)\n    }\n\n    try {\n      const { data, error } = await query\n\n      if (error) throw error\n\n      const total = data?.length || 0\n      const present = data?.filter((a) => a.status === 'present').length || 0\n      const absent = data?.filter((a) => a.status === 'absent').length || 0\n      const late = data?.filter((a) => a.status === 'late').length || 0\n      const excused = data?.filter((a) => a.status === 'excused').length || 0\n\n      return {\n        total,\n        present,\n        absent,\n        late,\n        excused,\n        attendanceRate: total > 0 ? (present / total) * 100 : 0,\n      }\n    } catch (error) {\n      if (error instanceof AppError) {\n        throw error\n      }\n      throw errorHandler.handleError(error, {\n        operation: 'getStudentStats',\n        studentId,\n      })\n    }\n  }\n\n  /**\n   * R√©cup√®re les statistiques de pr√©sence pour une classe\n   */\n  async getClassStats(classId: string, date?: string) {\n    let query = this.supabase\n      .from('attendance')\n      .select('status')\n      .eq('class_id', classId)\n\n    if (date) {\n      query = query.eq('date', date)\n    }\n\n    try {\n      const { data, error } = await query\n\n      if (error) {\n        throw errorHandler.handleError(error, {\n          operation: 'getClassStats',\n          classId,\n          date,\n        })\n      }\n\n      const total = data?.length || 0\n      const present = data?.filter((a) => a.status === 'present').length || 0\n      const absent = data?.filter((a) => a.status === 'absent').length || 0\n\n      return {\n        total,\n        present,\n        absent,\n        attendanceRate: total > 0 ? (present / total) * 100 : 0,\n      }\n    } catch (error) {\n      if (error instanceof AppError) {\n        throw error\n      }\n      throw errorHandler.handleError(error, {\n        operation: 'getClassStats',\n        classId,\n      })\n    }\n  }\n\n  /**\n   * Sauvegarde une signature d'enseignant\n   */\n  async saveTeacherSignature(attendanceId: string, signatureUrl: string) {\n    return this.update(attendanceId, {\n      teacher_signature_url: signatureUrl,\n    })\n  }\n}\n\nexport const attendanceService = new AttendanceService()\n"],"names":[],"mappings":"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"}