module.exports=[291103,e=>{"use strict";var t=e.i(747909),a=e.i(174017),r=e.i(996250),i=e.i(759756),n=e.i(561916),o=e.i(174677),s=e.i(869741),c=e.i(316795),d=e.i(487718),l=e.i(995169),u=e.i(47587),p=e.i(666012),m=e.i(570101),_=e.i(626937),h=e.i(10372),y=e.i(193695);e.i(52474);var g=e.i(257297),v=e.i(89171),f=e.i(703755);class w{async initiatePayment(e,t){throw Error("MTN Mobile Money adapter n'est pas encore implémenté")}async checkPaymentStatus(e,t){throw Error("MTN Mobile Money adapter n'est pas encore implémenté")}async validateWebhook(e,t){throw Error("MTN Mobile Money adapter n'est pas encore implémenté")}async processWebhook(e,t){throw Error("MTN Mobile Money adapter n'est pas encore implémenté")}}class b{async initiatePayment(e,t){throw Error("Orange Money adapter n'est pas encore implémenté")}async checkPaymentStatus(e,t){throw Error("Orange Money adapter n'est pas encore implémenté")}async validateWebhook(e,t){throw Error("Orange Money adapter n'est pas encore implémenté")}async processWebhook(e,t){throw Error("Orange Money adapter n'est pas encore implémenté")}}class E{async initiatePayment(e,t){throw Error("Airtel Money adapter n'est pas encore implémenté")}async checkPaymentStatus(e,t){throw Error("Airtel Money adapter n'est pas encore implémenté")}async validateWebhook(e,t){throw Error("Airtel Money adapter n'est pas encore implémenté")}async processWebhook(e,t){throw Error("Airtel Money adapter n'est pas encore implémenté")}}class R{supabase;constructor(e){this.supabase=e||(0,f.createClient)()}adapters={mtn_mobile_money:new w,orange_money:new b,moov_money:new E};async getConfig(e,t){let{data:a,error:r}=await this.supabase.from("mobile_money_configs").select("*").eq("organization_id",e).eq("provider",t).single();if(r){if("PGRST116"===r.code)return null;throw r}return a}async upsertConfig(e,t,a){let r=await this.getConfig(e,t);if(r){let{data:e,error:t}=await this.supabase.from("mobile_money_configs").update(a).eq("id",r.id).select().single();if(t)throw t;return e}{let{data:r,error:i}=await this.supabase.from("mobile_money_configs").insert({organization_id:e,provider:t,...a}).select().single();if(i)throw i;return r}}async initiatePayment(e,t,a,r,i,n="XOF"){let o=await this.getConfig(e,a);if(!o||!o.is_active)throw Error(`Configuration Mobile Money ${a} non active ou introuvable`);let{data:s,error:c}=await this.supabase.from("invoices").select("invoice_number, total_amount, currency").eq("id",t).single();if(c)throw c;let d={id:o.id,organization_id:o.organization_id,provider:o.provider,api_key:o.api_key||void 0,api_secret:o.api_secret||void 0,merchant_id:o.merchant_id||void 0,merchant_code:o.merchant_code||void 0,api_url:o.api_url||void 0,callback_url:o.callback_url||`http://localhost:3000/api/mobile-money/webhook/${a}`,is_active:o.is_active??!1,is_test_mode:o.is_test_mode??!1,metadata:o.metadata||void 0},l={amount:i,currency:n||s.currency,phone_number:r,invoice_id:t,invoice_number:s.invoice_number,description:`Paiement facture ${s.invoice_number}`,callback_url:d.callback_url||"http://localhost:3000/api/mobile-money/webhook"},u=this.adapters[a];if(!u)throw Error(`Adapter pour ${a} non disponible`);let p=await u.initiatePayment(d,l);if(!p.success)throw Error(p.error||"Erreur lors de l'initiation du paiement");return{transaction:await this.createTransaction({organization_id:e,invoice_id:t,provider:a,transaction_id:p.transaction_id,external_transaction_id:p.external_transaction_id,amount:i,currency:n||s.currency,phone_number:r,status:"initiated",request_data:l,response_data:p.data,initiated_at:new Date().toISOString()}),response:p}}async checkPaymentStatus(e){let{data:t,error:a}=await this.supabase.from("mobile_money_transactions").select("*, mobile_money_configs(*)").eq("id",e).single();if(a)throw a;let r=t.mobile_money_configs,i={id:r.id,organization_id:r.organization_id,provider:r.provider,api_key:r.api_key||void 0,api_secret:r.api_secret||void 0,merchant_id:r.merchant_id||void 0,merchant_code:r.merchant_code||void 0,api_url:r.api_url||void 0,callback_url:r.callback_url||void 0,is_active:r.is_active??!1,is_test_mode:r.is_test_mode??!1,metadata:r.metadata},n=this.adapters[t.provider];if(!n)throw Error(`Adapter pour ${t.provider} non disponible`);let o=await n.checkPaymentStatus(i,t.transaction_id||"");return await this.updateTransaction(t.id,{status:o.status,response_data:o.data,..."completed"===o.status&&{completed_at:new Date().toISOString()},..."failed"===o.status&&{failed_at:new Date().toISOString(),error_message:o.error}}),"completed"===o.status&&t.invoice_id&&await this.createPaymentRecord(t),o}async processWebhook(e,t){let{data:a,error:r}=await this.supabase.from("mobile_money_transactions").select("*, mobile_money_configs(*)").eq("transaction_id",t.transaction_id).eq("provider",e).single();if(r||!a)throw Error("Transaction non trouvée");let i=a.mobile_money_configs,n={id:i.id,organization_id:i.organization_id,provider:i.provider,api_key:i.api_key||void 0,api_secret:i.api_secret||void 0,merchant_id:i.merchant_id||void 0,merchant_code:i.merchant_code||void 0,api_url:i.api_url||void 0,callback_url:i.callback_url||void 0,is_active:i.is_active??!1,is_test_mode:i.is_test_mode??!1,metadata:i.metadata},o=this.adapters[e];if(!o)throw Error(`Adapter pour ${e} non disponible`);if(!await o.validateWebhook(n,t))throw Error("Webhook invalide");let s=await o.processWebhook(n,t);await this.updateTransaction(a.id,{status:s.status,webhook_received:!0,webhook_data:t,response_data:s.data,..."completed"===s.status&&{completed_at:new Date().toISOString()},..."failed"===s.status&&{failed_at:new Date().toISOString(),error_message:s.error}}),"completed"===s.status&&a.invoice_id&&await this.createPaymentRecord(a)}async createTransaction(e){let{data:t,error:a}=await this.supabase.from("mobile_money_transactions").insert(e).select().single();if(a)throw a;return t}async updateTransaction(e,t){let{data:a,error:r}=await this.supabase.from("mobile_money_transactions").update(t).eq("id",e).select().single();if(r)throw r;return a}async createPaymentRecord(e){if(e.payment_id)return;let{data:t,error:a}=await this.supabase.from("invoices").select("organization_id, student_id, currency").eq("id",e.invoice_id).single();if(a)throw a;let{data:r,error:i}=await this.supabase.from("payments").insert({organization_id:e.organization_id,invoice_id:e.invoice_id,student_id:t.student_id,amount:e.amount,currency:e.currency,payment_method:"mobile_money",payment_provider:e.provider,transaction_id:e.transaction_id,status:"completed",paid_at:e.completed_at||new Date().toISOString(),metadata:{mobile_money_transaction_id:e.id,phone_number:e.phone_number}}).select().single();if(i)throw i;await this.updateTransaction(e.id,{payment_id:r.id})}async getTransactionHistory(e){let{data:t,error:a}=await this.supabase.from("mobile_money_transactions").select("*").eq("invoice_id",e).order("created_at",{ascending:!1});if(a)throw a;return t||[]}}let k=new R;var x=e.i(901900),C=e.i(320251),S=e.i(981838);async function O(e,{params:t}){return(0,x.withRateLimit)(e,x.generalRateLimiter,async e=>{try{let a=await t,r=new URL(e.url),i=a?.provider||r.pathname.split("/").pop();if(!i||!["mtn","orange","airtel"].includes(i))return v.NextResponse.json({error:"Provider invalide"},{status:400});let n=await e.text(),o=JSON.parse(n),s=process.env[`${i.toUpperCase()}_WEBHOOK_SECRET`]||process.env.MOBILE_MONEY_WEBHOOK_SECRET;if(s){let t=await (0,C.validateWebhook)(e,{secret:s,signatureHeader:"x-signature",timestampHeader:"x-timestamp",nonceHeader:"x-nonce",maxAge:300},n);if(!t.valid)return S.logger.warn("Webhook signature validation failed",{provider:i,error:t.error,details:t.details}),v.NextResponse.json({error:t.error||"Signature invalide"},{status:401});S.logger.info("Webhook signature validated",{provider:i,details:t.details})}else S.logger.warn("Webhook secret not configured, skipping signature validation",{provider:i});let c=e.headers.get("x-signature")||e.headers.get("authorization")?.replace("Bearer ",""),d={provider:i,transaction_id:o.transaction_id||o.transactionId||o.id,status:function(e,t){let a=t?.toLowerCase()||"";switch(e){case"mtn":if("successful"===a||"success"===a)return"success";if("failed"===a||"failure"===a)return"failed";return"pending";case"orange":if("success"===a||"successful"===a)return"success";if("failed"===a||"failure"===a)return"failed";return"pending";case"airtel":if("ts"===a||"success"===a||"successful"===a)return"success";if("tf"===a||"failed"===a||"failure"===a)return"failed";return"pending";default:return"pending"}}(i,o.status||o.state),amount:o.amount?parseFloat(o.amount):0,currency:o.currency||"XOF",phone_number:o.phone_number||o.phoneNumber||o.msisdn||o.subscriber?.msisdn,timestamp:o.timestamp||o.created_at||new Date().toISOString(),metadata:{external_transaction_id:o.external_transaction_id||o.externalId||o.reference,signature:c,raw_data:o}};return await k.processWebhook(i,d),v.NextResponse.json({success:!0,message:"Webhook traité avec succès"})}catch(t){S.logger.error("Mobile Money Webhook - Processing failed",t,{error:(0,S.sanitizeError)(t)});let e=t instanceof Error?t.message:"Erreur lors du traitement du webhook";return v.NextResponse.json({success:!1,error:e},{status:500})}})}e.s(["POST",()=>O],698700);var P=e.i(698700);let T=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/mobile-money/webhook/route",pathname:"/api/mobile-money/webhook",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/mobile-money/webhook/route.ts",nextConfigOutput:"",userland:P}),{workAsyncStorage:M,workUnitAsyncStorage:A,serverHooks:N}=T;function q(){return(0,r.patchFetch)({workAsyncStorage:M,workUnitAsyncStorage:A})}async function I(e,t,r){T.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let v="/api/mobile-money/webhook/route";v=v.replace(/\/index$/,"")||"/";let f=await T.prepare(e,t,{srcPage:v,multiZoneDraftMode:!1});if(!f)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:w,params:b,nextConfig:E,parsedUrl:R,isDraftMode:k,prerenderManifest:x,routerServerContext:C,isOnDemandRevalidate:S,revalidateOnlyGenerated:O,resolvedPathname:P,clientReferenceManifest:M,serverActionsManifest:A}=f,N=(0,s.normalizeAppPath)(v),q=!!(x.dynamicRoutes[N]||x.routes[P]),I=async()=>((null==C?void 0:C.render404)?await C.render404(e,t,R,!1):t.end("This page could not be found"),null);if(q&&!k){let e=!!x.routes[P],t=x.dynamicRoutes[N];if(t&&!1===t.fallback&&!e){if(E.experimental.adapterPath)return await I();throw new y.NoFallbackError}}let H=null;!q||T.isDev||k||(H="/index"===(H=P)?"/":H);let W=!0===T.isDev||!q,D=q&&!W;A&&M&&(0,o.setManifestsSingleton)({page:v,clientReferenceManifest:M,serverActionsManifest:A});let U=e.method||"GET",$=(0,n.getTracer)(),z=$.getActiveScopeSpan(),j={params:b,prerenderManifest:x,renderOpts:{experimental:{authInterrupts:!!E.experimental.authInterrupts},cacheComponents:!!E.cacheComponents,supportsDynamicResponse:W,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:E.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r,i)=>T.onRequestError(e,t,r,i,C)},sharedContext:{buildId:w}},F=new c.NodeNextRequest(e),K=new c.NodeNextResponse(t),L=d.NextRequestAdapter.fromNodeNextRequest(F,(0,d.signalFromNodeResponse)(t));try{let o=async e=>T.handle(L,j).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=$.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==l.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=a.get("next.route");if(r){let t=`${U} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${U} ${v}`)}),s=!!(0,i.getRequestMeta)(e,"minimalMode"),c=async i=>{var n,c;let d=async({previousCacheEntry:a})=>{try{if(!s&&S&&O&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await o(i);e.fetchMetrics=j.renderOpts.fetchMetrics;let c=j.renderOpts.pendingWaitUntil;c&&r.waitUntil&&(r.waitUntil(c),c=void 0);let d=j.renderOpts.collectedTags;if(!q)return await (0,p.sendResponse)(F,K,n,j.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(n.headers);d&&(t[h.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==j.renderOpts.collectedRevalidate&&!(j.renderOpts.collectedRevalidate>=h.INFINITE_CACHE)&&j.renderOpts.collectedRevalidate,r=void 0===j.renderOpts.collectedExpire||j.renderOpts.collectedExpire>=h.INFINITE_CACHE?void 0:j.renderOpts.collectedExpire;return{value:{kind:g.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==a?void 0:a.isStale)&&await T.onRequestError(e,t,{routerKind:"App Router",routePath:v,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:D,isOnDemandRevalidate:S})},!1,C),t}},l=await T.handleResponse({req:e,nextConfig:E,cacheKey:H,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:x,isRoutePPREnabled:!1,isOnDemandRevalidate:S,revalidateOnlyGenerated:O,responseGenerator:d,waitUntil:r.waitUntil,isMinimalMode:s});if(!q)return null;if((null==l||null==(n=l.value)?void 0:n.kind)!==g.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(c=l.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",S?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),k&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let y=(0,m.fromNodeOutgoingHttpHeaders)(l.value.headers);return s&&q||y.delete(h.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||t.getHeader("Cache-Control")||y.get("Cache-Control")||y.set("Cache-Control",(0,_.getCacheControlHeader)(l.cacheControl)),await (0,p.sendResponse)(F,K,new Response(l.value.body,{headers:y,status:l.value.status||200})),null};z?await c(z):await $.withPropagatedContext(e.headers,()=>$.trace(l.BaseServerSpan.handleRequest,{spanName:`${U} ${v}`,kind:n.SpanKind.SERVER,attributes:{"http.method":U,"http.target":e.url}},c))}catch(t){if(t instanceof y.NoFallbackError||await T.onRequestError(e,t,{routerKind:"App Router",routePath:N,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:D,isOnDemandRevalidate:S})},!1,C),q)throw t;return await (0,p.sendResponse)(F,K,new Response(null,{status:500})),null}}e.s(["handler",()=>I,"patchFetch",()=>q,"routeModule",()=>T,"serverHooks",()=>N,"workAsyncStorage",()=>M,"workUnitAsyncStorage",()=>A],291103)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_2e1a143c.js.map