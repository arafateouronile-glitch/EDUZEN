{"version":3,"sources":["../../../lib/utils/document-generation/form-field-processor.ts"],"sourcesContent":["/**\n * Processeur pour les champs de formulaire interactifs\n * Rend les champs de formulaire fonctionnels dans les documents générés\n */\n\n/**\n * Traite les champs de formulaire dans le HTML et les rend interactifs\n */\nexport function processFormFields(html: string, variables: Record<string, any> = {}): string {\n  // Remplacer les variables dans les attributs data-* des champs\n  let processedHTML = html\n\n  // Remplacer les variables dans les valeurs par défaut\n  processedHTML = processedHTML.replace(\n    /value=\"\\{([^}]+)\\}\"/g,\n    (match, varName) => {\n      const value = variables[varName.trim()] || ''\n      return `value=\"${value}\"`\n    }\n  )\n\n  // Remplacer les variables dans les placeholders\n  processedHTML = processedHTML.replace(\n    /placeholder=\"\\{([^}]+)\\}\"/g,\n    (match, varName) => {\n      const value = variables[varName.trim()] || ''\n      return `placeholder=\"${value}\"`\n    }\n  )\n\n  // Remplacer les variables dans les labels\n  processedHTML = processedHTML.replace(\n    />\\{([^}]+)\\}<\\/label>/g,\n    (match, varName) => {\n      const value = variables[varName.trim()] || varName\n      return `>${value}</label>`\n    }\n  )\n\n  // Ajouter le script pour les calculs automatiques\n  if (processedHTML.includes('data-calculation-formula')) {\n    processedHTML += `\n      <script>\n        (function() {\n          // Fonction pour évaluer les formules de calcul\n          function evaluateFormula(formula, fieldValues) {\n            try {\n              // Remplacer les noms de champs par leurs valeurs\n              let expression = formula\n              Object.keys(fieldValues).forEach(fieldName => {\n                const regex = new RegExp('\\\\\\\\b' + fieldName + '\\\\\\\\b', 'g')\n                expression = expression.replace(regex, fieldValues[fieldName] || 0)\n              })\n              \n              // Évaluer l'expression (attention à la sécurité en production)\n              return Function('\"use strict\"; return (' + expression + ')')()\n            } catch (error) {\n              console.error('Erreur lors de l\\'évaluation de la formule:', error)\n              return 0\n            }\n          }\n\n          // Fonction pour mettre à jour les calculs\n          function updateCalculations() {\n            const calculatedFields = document.querySelectorAll('[data-calculation-formula]')\n            const fieldValues = {}\n            \n            // Collecter toutes les valeurs de champs\n            document.querySelectorAll('.form-field-interactive').forEach(field => {\n              const fieldName = field.getAttribute('data-field-name')\n              if (fieldName) {\n                if (field.type === 'checkbox' || field.type === 'radio') {\n                  fieldValues[fieldName] = field.checked ? parseFloat(field.value) || 1 : 0\n                } else {\n                  fieldValues[fieldName] = parseFloat(field.value) || 0\n                }\n              }\n            })\n\n            // Mettre à jour les champs calculés\n            calculatedFields.forEach(field => {\n              const formula = field.getAttribute('data-calculation-formula')\n              const targetField = field.getAttribute('data-calculation-target')\n              \n              if (formula) {\n                const result = evaluateFormula(formula, fieldValues)\n                \n                if (targetField) {\n                  const target = document.querySelector('[name=\"' + targetField + '\"]')\n                  if (target) {\n                    target.value = result\n                  }\n                } else {\n                  field.value = result\n                }\n              }\n            })\n          }\n\n          // Ajouter les écouteurs d'événements\n          document.addEventListener('DOMContentLoaded', function() {\n            document.querySelectorAll('.form-field-interactive').forEach(field => {\n              field.addEventListener('input', updateCalculations)\n              field.addEventListener('change', updateCalculations)\n            })\n            \n            // Mettre à jour les calculs au chargement\n            updateCalculations()\n          })\n        })()\n      </script>\n    `\n  }\n\n  // Ajouter la validation des champs\n  if (processedHTML.includes('form-field-interactive')) {\n    processedHTML += `\n      <script>\n        (function() {\n          function validateField(field) {\n            const validationMessage = field.parentElement.querySelector('.validation-message')\n            let isValid = true\n            let message = ''\n\n            // Validation requise\n            if (field.hasAttribute('required') && !field.value.trim()) {\n              isValid = false\n              message = 'Ce champ est obligatoire'\n            }\n\n            // Validation minlength\n            if (field.hasAttribute('minlength')) {\n              const min = parseInt(field.getAttribute('minlength'))\n              if (field.value.length < min) {\n                isValid = false\n                message = 'Minimum ' + min + ' caractères requis'\n              }\n            }\n\n            // Validation maxlength\n            if (field.hasAttribute('maxlength')) {\n              const max = parseInt(field.getAttribute('maxlength'))\n              if (field.value.length > max) {\n                isValid = false\n                message = 'Maximum ' + max + ' caractères autorisés'\n              }\n            }\n\n            // Validation pattern\n            if (field.hasAttribute('pattern')) {\n              const pattern = new RegExp(field.getAttribute('pattern'))\n              if (!pattern.test(field.value)) {\n                isValid = false\n                message = field.getAttribute('data-validation-message') || 'Format invalide'\n              }\n            }\n\n            // Validation min/max pour les nombres\n            if (field.type === 'number') {\n              if (field.hasAttribute('min')) {\n                const min = parseFloat(field.getAttribute('min'))\n                if (parseFloat(field.value) < min) {\n                  isValid = false\n                  message = 'La valeur minimale est ' + min\n                }\n              }\n              if (field.hasAttribute('max')) {\n                const max = parseFloat(field.getAttribute('max'))\n                if (parseFloat(field.value) > max) {\n                  isValid = false\n                  message = 'La valeur maximale est ' + max\n                }\n              }\n            }\n\n            // Afficher/masquer le message d'erreur\n            if (validationMessage) {\n              if (isValid) {\n                validationMessage.style.display = 'none'\n                field.style.borderColor = '#d1d5db'\n              } else {\n                validationMessage.style.display = 'block'\n                validationMessage.textContent = message\n                field.style.borderColor = '#ef4444'\n              }\n            }\n\n            return isValid\n          }\n\n          document.addEventListener('DOMContentLoaded', function() {\n            document.querySelectorAll('.form-field-interactive').forEach(field => {\n              field.addEventListener('blur', function() {\n                validateField(this)\n              })\n              \n              field.addEventListener('input', function() {\n                const validationMessage = this.parentElement.querySelector('.validation-message')\n                if (validationMessage) {\n                  validationMessage.style.display = 'none'\n                  this.style.borderColor = '#d1d5db'\n                }\n              })\n            })\n          })\n        })()\n      </script>\n    `\n  }\n\n  return processedHTML\n}\n\n/**\n * Extrait les valeurs des champs de formulaire depuis le HTML\n * Note: Cette fonction doit être utilisée uniquement côté client (navigateur)\n */\nexport function extractFormFieldValues(html: string): Record<string, any> {\n  if (typeof window === 'undefined') {\n    // Côté serveur, retourner un objet vide\n    return {}\n  }\n\n  const values: Record<string, any> = {}\n  const parser = new DOMParser()\n  const doc = parser.parseFromString(html, 'text/html')\n  \n  doc.querySelectorAll('.form-field-interactive').forEach((field: any) => {\n    const fieldName = field.getAttribute('name') || field.getAttribute('data-field-name')\n    if (fieldName) {\n      if (field.type === 'checkbox') {\n        values[fieldName] = field.checked\n      } else if (field.type === 'radio') {\n        if (field.checked) {\n          values[fieldName] = field.value\n        }\n      } else {\n        values[fieldName] = field.value\n      }\n    }\n  })\n  \n  return values\n}\n"],"names":[],"mappings":"wCAQO,SAAS,EAAkB,CAAY,CAAE,EAAiC,CAAC,CAAC,EAEjF,IAAI,EAAgB,EAwMpB,MA1KI,CATJ,EATA,AASgB,GATA,CAThB,EAAgB,EAAc,OAAO,CACnC,uBACA,CAAC,EAAO,KACN,IAAM,EAAQ,CAAS,CAAC,EAAQ,IAAI,GAAG,EAAI,GAC3C,MAAO,CAAC,OAAO,EAAE,EAAM,CAAC,CAAC,AAC3B,EAAA,EAI4B,OAAO,CACnC,6BACA,CAAC,EAAO,KACN,IAAM,EAAQ,CAAS,CAAC,EAAQ,IAAI,GAAG,EAAI,GAC3C,MAAO,CAAC,aAAa,EAAE,EAAM,CAAC,CAAC,AACjC,EAAA,EAI4B,OAAO,CACnC,yBACA,CAAC,EAAO,KACN,IAAM,EAAQ,CAAS,CAAC,EAAQ,IAAI,GAAG,EAAI,EAC3C,MAAO,CAAC,CAAC,EAAE,EAAM,QAAQ,CAAC,AAC5B,EAAA,EAIgB,QAAQ,CAAC,6BAA6B,CACtD,GAAiB,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;KAsElB,AAAC,EAIC,EAAc,QAAQ,CAAC,2BAA2B,CACpD,GAAiB,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;KA2FlB,AAAC,EAGI,CACT,CAMO,SAAS,EAAuB,CAAY,EAG/C,MAAO,CAAC,CAuBZ"}