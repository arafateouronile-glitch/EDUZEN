module.exports=[133915,e=>{"use strict";var t=e.i(747909),r=e.i(174017),a=e.i(996250),i=e.i(759756),s=e.i(561916),n=e.i(174677),o=e.i(869741),l=e.i(316795),d=e.i(487718),u=e.i(995169),c=e.i(47587),p=e.i(666012),h=e.i(570101),_=e.i(626937),g=e.i(10372),m=e.i(193695);e.i(52474);var w=e.i(257297),f=e.i(89171),y=e.i(703755),b=e.i(254799);let v=new class{supabase;constructor(e){this.supabase=e||(0,y.createClient)()}generateAPIKey(){let e=`eduz_${b.default.randomBytes(32).toString("hex")}`,t=b.default.createHash("sha256").update(e).digest("hex"),r=e.substring(0,12)+"...";return{key:e,hash:t,prefix:r}}async verifyAPIKey(e){let t=b.default.createHash("sha256").update(e).digest("hex"),{data:r,error:a}=await this.supabase.from("api_keys").select("*").eq("key_hash",t).eq("is_active",!0).maybeSingle();if(a)throw a;return r}async createAPIKey(e,t,r,a){let{key:i,hash:s,prefix:n}=this.generateAPIKey();await this.ensureQuotaExists(e);let{data:o,error:l}=await this.supabase.from("api_keys").insert({organization_id:e,user_id:t,name:r,key_hash:s,key_prefix:n,description:a?.description,scopes:a?.scopes||[],allowed_ips:a?.allowedIPs||[],allowed_origins:a?.allowedOrigins||[],rate_limit_per_minute:a?.rateLimitPerMinute||60,rate_limit_per_hour:a?.rateLimitPerHour||1e3,rate_limit_per_day:a?.rateLimitPerDay||1e4,expires_at:a?.expiresAt?.toISOString()}).select().single();if(l)throw l;return{...o,key:i}}async getAPIKeys(e){let{data:t,error:r}=await this.supabase.from("api_keys").select("*").eq("organization_id",e).order("created_at",{ascending:!1});if(r)throw r;return t}async updateAPIKey(e,t){let{data:r,error:a}=await this.supabase.from("api_keys").update(t).eq("id",e).select().single();if(a)throw a;return r}async revokeAPIKey(e){return this.updateAPIKey(e,{is_active:!1})}async deleteAPIKey(e){let{error:t}=await this.supabase.from("api_keys").delete().eq("id",e);if(t)throw t}async checkRateLimit(e,t){let r=await this.checkKeyRateLimit(e.id);if(!r.allowed)return r;let a=await this.checkQuotaRateLimit(t);return a.allowed?{allowed:!0,remaining:Math.min(r.remaining,a.remaining),resetAt:a.resetAt}:a}async checkKeyRateLimit(e){let{data:t}=await this.supabase.from("api_keys").select("rate_limit_per_minute, rate_limit_per_hour, rate_limit_per_day").eq("id",e).single();if(!t)return{allowed:!1,remaining:0,resetAt:new Date};let r=new Date,a=new Date(r.getTime()-6e4),i=new Date(r.getTime()-36e5),s=new Date(r.getTime()-864e5),{count:n}=await this.supabase.from("api_requests").select("*",{count:"exact",head:!0}).eq("api_key_id",e).gte("created_at",a.toISOString()),{count:o}=await this.supabase.from("api_requests").select("*",{count:"exact",head:!0}).eq("api_key_id",e).gte("created_at",i.toISOString()),{count:l}=await this.supabase.from("api_requests").select("*",{count:"exact",head:!0}).eq("api_key_id",e).gte("created_at",s.toISOString());return n&&n>=(t.rate_limit_per_minute||60)?{allowed:!1,remaining:0,resetAt:new Date(r.getTime()+6e4)}:o&&o>=(t.rate_limit_per_hour||1e3)?{allowed:!1,remaining:0,resetAt:new Date(r.getTime()+36e5)}:l&&l>=(t.rate_limit_per_day||1e4)?{allowed:!1,remaining:0,resetAt:new Date(r.getTime()+864e5)}:{allowed:!0,remaining:Math.min((t.rate_limit_per_minute||60)-(n||0),(t.rate_limit_per_hour||1e3)-(o||0),(t.rate_limit_per_day||1e4)-(l||0)),resetAt:new Date(r.getTime()+6e4)}}async checkQuotaRateLimit(e){let{data:t}=await this.supabase.from("api_quotas").select("*").eq("organization_id",e).single();return t?t.requests_used_minute>=(t.requests_per_minute||60)||t.requests_used_hour>=(t.requests_per_hour||1e3)||t.requests_used_day>=(t.requests_per_day||1e4)?{allowed:!1,remaining:0,resetAt:new Date}:{allowed:!0,remaining:Math.min((t.requests_per_minute||60)-t.requests_used_minute,(t.requests_per_hour||1e3)-t.requests_used_hour,(t.requests_per_day||1e4)-t.requests_used_day),resetAt:new Date}:(await this.ensureQuotaExists(e),{allowed:!0,remaining:1e4,resetAt:new Date})}async logAPIRequest(e,t,r,a,i,s,n,o,l,d){let{data:u,error:c}=await this.supabase.from("api_requests").insert({api_key_id:e,organization_id:t,method:r,endpoint:a,path:i,status_code:s,response_time_ms:n,ip_address:o,user_agent:l,query_params:d}).select().single();if(c)throw c;return u}async getAPIUsageStats(e,t,r){let a=this.supabase.from("api_requests").select("method, endpoint, status_code, response_time_ms").eq("organization_id",e);t&&(a=a.gte("created_at",t.toISOString())),r&&(a=a.lte("created_at",r.toISOString()));let{data:i,error:s}=await a;if(s)throw s;let n={total_requests:i?.length||0,by_method:{},by_endpoint:{},by_status:{},average_response_time:0,error_rate:0};if(i&&i.length>0){let e=0,t=0;i.forEach(r=>{n.by_method[r.method]=(n.by_method[r.method]||0)+1;let a=r.endpoint;n.by_endpoint[a]=(n.by_endpoint[a]||0)+1;let i=r.status_code||0,s=100*Math.floor(i/100);n.by_status[s]=(n.by_status[s]||0)+1;let o=r.response_time_ms||0;o&&(e+=o),i>=400&&t++}),n.average_response_time=e/i.length,n.error_rate=t/i.length*100}return n}async ensureQuotaExists(e){let{data:t}=await this.supabase.from("api_quotas").select("id").eq("organization_id",e).maybeSingle();if(!t){let{error:t}=await this.supabase.from("api_quotas").insert({organization_id:e});if(t)throw t}}async getQuota(e){let{data:t,error:r}=await this.supabase.from("api_quotas").select("*").eq("organization_id",e).single();if(r)throw r;return t}async updateQuota(e,t){let{data:r,error:a}=await this.supabase.from("api_quotas").update(t).eq("organization_id",e).select().single();if(a)throw a;return r}async createWebhook(e){let t=b.default.randomBytes(32).toString("hex"),{data:r,error:a}=await this.supabase.from("webhooks").insert({...e,secret:t}).select().single();if(a)throw a;return{...r,secret:t}}async getWebhooks(e){let{data:t,error:r}=await this.supabase.from("webhooks").select("*").eq("organization_id",e).order("created_at",{ascending:!1});if(r)throw r;return t}async updateWebhook(e,t){let{data:r,error:a}=await this.supabase.from("webhooks").update(t).eq("id",e).select().single();if(a)throw a;return r}async deleteWebhook(e){let{error:t}=await this.supabase.from("webhooks").delete().eq("id",e);if(t)throw t}async triggerWebhook(e,t,r){let{data:a}=await this.supabase.from("webhooks").select("*").eq("id",e).eq("is_active",!0).single();if(!a)throw Error("Webhook non trouvé ou inactif");if(!a.events.includes(t))return null;let{data:i,error:s}=await this.supabase.from("webhook_deliveries").insert({webhook_id:e,event_type:t,event_data:r,status:"pending"}).select().single();if(s)throw s;return i}async sendWebhook(e){let{data:t}=await this.supabase.from("webhook_deliveries").select("*, webhook:webhooks(*)").eq("id",e).single();if(!t||!t.webhook)throw Error("Livraison non trouvée");let r=t.webhook,a=JSON.stringify({event:t.event_type,data:t.event_data,timestamp:new Date().toISOString()}),i=r.secret||"",s=b.default.createHmac("sha256",i).update(a).digest("hex");try{let i=await fetch(r.url,{method:"POST",headers:{"Content-Type":"application/json","X-Webhook-Signature":s,"X-Webhook-Event":t.event_type},body:a,signal:AbortSignal.timeout(1e3*(r.timeout_seconds||30))}),n=await i.text();return await this.supabase.from("webhook_deliveries").update({status:i.ok?"success":"failed",response_status_code:i.status,response_body:n,delivered_at:new Date().toISOString()}).eq("id",e),await this.supabase.from("webhooks").update({success_count:i.ok?(r.success_count||0)+1:r.success_count||0,failure_count:i.ok?r.failure_count||0:(r.failure_count||0)+1,last_triggered_at:new Date().toISOString()}).eq("id",r.id),{success:i.ok,status:i.status}}catch(a){let r=a instanceof Error?a.message:"Erreur inconnue";throw await this.supabase.from("webhook_deliveries").update({status:"failed",error_message:r,attempt_number:t.attempt_number+1,next_retry_at:t.attempt_number<t.max_attempts?new Date(Date.now()+3e5).toISOString():null}).eq("id",e),a}}async getWebhookDeliveries(e){let{data:t,error:r}=await this.supabase.from("webhook_deliveries").select("*").eq("webhook_id",e).order("created_at",{ascending:!1}).limit(100);if(r)throw r;return t}};async function E(e){let t=e.headers.get("x-api-key")||e.headers.get("authorization")?.replace("Bearer ","");if(!t)return f.NextResponse.json({error:"API key required",message:"Please provide an API key in the X-API-Key header or Authorization header"},{status:401});let r=await v.verifyAPIKey(t);if(!r)return f.NextResponse.json({error:"Invalid API key",message:"The provided API key is invalid or has been revoked"},{status:401});if(r.expires_at&&new Date(r.expires_at)<new Date)return f.NextResponse.json({error:"API key expired",message:"The provided API key has expired"},{status:401});if(r.allowed_ips&&r.allowed_ips.length>0){let t=e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")||"unknown";if(!r.allowed_ips.includes(t))return f.NextResponse.json({error:"IP not allowed",message:"Your IP address is not authorized to use this API key"},{status:403})}let a=await v.checkRateLimit(r,r.organization_id);if(!a.allowed)return f.NextResponse.json({error:"Rate limit exceeded",message:"You have exceeded the rate limit for this API key",retryAfter:Math.ceil((a.resetAt.getTime()-Date.now())/1e3)},{status:429,headers:{"X-RateLimit-Limit":"1000","X-RateLimit-Remaining":"0","X-RateLimit-Reset":a.resetAt.toISOString(),"Retry-After":Math.ceil((a.resetAt.getTime()-Date.now())/1e3).toString()}});let i=new Headers(e.headers);return i.set("x-api-key-id",r.id),i.set("x-organization-id",r.organization_id),i.set("x-api-scopes",JSON.stringify(r.scopes||[])),{key:r,organizationId:r.organization_id,scopes:r.scopes||[],requestHeaders:i,rateLimit:a}}e.i(61356);var R=e.i(652931),A=e.i(981838),I=e.i(725953);async function k(e,t,r,a){try{let i=a.year||new Date().getFullYear().toString().slice(-2),s=a.padding||6,n=a.fieldName||"number",o=`${a.prefix}-${a.orgCode}-${i}-%`,{data:l,error:d}=await e.from(t).select(n).eq("organization_id",r).like(n,o).order(n,{ascending:!1}).limit(1).maybeSingle();if(d&&"PGRST116"!==d.code&&"42P01"!==d.code)throw R.errorHandler.handleError(d,{operation:"generateUniqueNumber",table:t,organizationId:r});let u=1;if(l&&l[n]){let e=String(l[n]).split("-");u=parseInt(e[e.length-1]||"0",10)+1}return`${a.prefix}-${a.orgCode}-${i}-${String(u).padStart(s,"0")}`}catch(e){throw R.errorHandler.handleError(e,{operation:"generateUniqueNumber",table:t,organizationId:r})}}let q=new class{supabase;constructor(e){this.supabase=e||(0,y.createClient)()}async getAll(e,t){try{let r=t?.page||1,a=t?.limit||50,i=(r-1)*a;if(t?.search){let s=this.supabase.from("students").select("*, classes(id, name, level)",{count:"exact"}).eq("organization_id",e).or(`first_name.ilike.%${t.search}%,last_name.ilike.%${t.search}%,student_number.ilike.%${t.search}%`);t?.classId&&(s=s.eq("class_id",t.classId)),t?.status&&(s=s.eq("status",t.status));let{data:n,error:o,count:l}=await s.order("last_name",{ascending:!0}).range(i,i+a-1);if(o)throw R.errorHandler.handleError(o,{organizationId:e,operation:"getAll",filters:t});return{data:n||[],total:l||0,page:r,limit:a,totalPages:Math.ceil((l||0)/a)}}let s=this.supabase.from("students").select("*, classes(id, name, level)",{count:"exact"}).eq("organization_id",e);t?.classId&&(s=s.eq("class_id",t.classId)),t?.status&&(s=s.eq("status",t.status));let{data:n,error:o,count:l}=await s.order("last_name",{ascending:!0}).range(i,i+a-1);if(o)throw R.errorHandler.handleError(o,{organizationId:e,operation:"getAll",filters:t});return{data:n||[],total:l||0,page:r,limit:a,totalPages:Math.ceil((l||0)/a)}}catch(t){if(t instanceof R.AppError)throw t;throw R.errorHandler.handleError(t,{organizationId:e,operation:"getAll"})}}async getById(e){try{return(0,I.getById)(this.supabase,"students",e,"*, classes(id, name, level)")}catch(t){if(t instanceof R.AppError)throw t;throw R.errorHandler.handleError(t,{operation:"getById",id:e})}}async getByNumber(e,t){try{let{data:r,error:a}=await this.supabase.from("students").select("*").eq("organization_id",e).eq("student_number",t).single();if(a){if("PGRST116"===a.code||"42P01"===a.code)throw R.errorHandler.handleError(a,{code:R.ErrorCode.DB_NOT_FOUND,operation:"getByNumber",organizationId:e,studentNumber:t});throw R.errorHandler.handleError(a,{operation:"getByNumber",organizationId:e,studentNumber:t})}return r}catch(r){if(r instanceof R.AppError)throw r;throw R.errorHandler.handleError(r,{operation:"getByNumber",organizationId:e,studentNumber:t})}}async create(e){try{for(let t of["first_name","last_name","organization_id"])if(!e[t])throw R.errorHandler.createValidationError(`Le champ ${String(t)} est obligatoire`,String(t));let t=e.student_number;if(!t||""===t.trim()){let r=e.organization_id;if(!r)throw Error("organization_id is required");let{data:a}=await this.supabase.from("organizations").select("code").eq("id",r).single(),i=a?.code||"ORG",s=new Date().getFullYear().toString().slice(-2);t=await k(this.supabase,"students",r,{prefix:"EDU",orgCode:i,year:s,padding:6,fieldName:"student_number"})}let r={...e,student_number:t},{data:a,error:i}=await this.supabase.from("students").insert(r).select().single();if(i){if("23505"===i.code)throw R.errorHandler.handleError(i,{code:R.ErrorCode.VALIDATION_UNIQUE_CONSTRAINT,operation:"create",field:"student_number"});if("42501"===i.code)throw R.errorHandler.handleError(i,{code:R.ErrorCode.DB_RLS_POLICY_VIOLATION,operation:"create"});throw R.errorHandler.handleError(i,{operation:"create",student:e})}return A.logger.info("Étudiant créé avec succès",{id:a?.id,organizationId:e.organization_id||void 0,studentNumber:a?.student_number}),a}catch(t){if(t instanceof R.AppError)throw t;throw R.errorHandler.handleError(t,{operation:"create",student:e})}}async update(e,t){try{let r={...t};if("class_id"in r)if(""!==r.class_id&&r.class_id){let{data:e,error:t}=await this.supabase.from("classes").select("id").eq("id",r.class_id).maybeSingle();e||t||(r.class_id=null)}else r.class_id=null;let{data:a,error:i}=await this.supabase.from("students").update(r).eq("id",e).select().single();if(i){if("PGRST116"===i.code||"42P01"===i.code)throw R.errorHandler.handleError(i,{code:R.ErrorCode.DB_NOT_FOUND,operation:"update",id:e});if("42501"===i.code)throw R.errorHandler.handleError(i,{code:R.ErrorCode.DB_RLS_POLICY_VIOLATION,operation:"update",id:e});throw R.errorHandler.handleError(i,{operation:"update",id:e,updates:t})}if(!a)throw R.errorHandler.createDatabaseError(`\xc9tudiant avec l'ID ${e} introuvable pour la mise \xe0 jour`,{id:e});return A.logger.info("Étudiant mis à jour avec succès",{id:e,updates:t}),a}catch(r){if(r instanceof R.AppError)throw r;throw R.errorHandler.handleError(r,{operation:"update",id:e,updates:t})}}async delete(e){return this.update(e,{status:"inactive"})}async import(e,t){try{if(!t||0===t.length)throw R.errorHandler.createValidationError("Aucun étudiant à importer","students");let{data:r}=await this.supabase.from("organizations").select("code").eq("id",e).single(),a=r?.code||"ORG",i=new Date().getFullYear().toString().slice(-2),s=await Promise.all(t.map(async t=>{if(t.student_number&&""!==t.student_number.trim())return t;let r=await k(this.supabase,"students",e,{prefix:"EDU",orgCode:a,year:i,padding:6,fieldName:"student_number"});return{...t,student_number:r}})),{data:n,error:o}=await this.supabase.from("students").insert(s).select();if(o){if("23505"===o.code)throw R.errorHandler.handleError(o,{code:R.ErrorCode.VALIDATION_UNIQUE_CONSTRAINT,operation:"import",field:"student_number"});throw R.errorHandler.handleError(o,{operation:"import",organizationId:e,count:t.length})}return A.logger.info("Étudiants importés avec succès",{organizationId:e,count:n?.length||0}),n||[]}catch(t){if(t instanceof R.AppError)throw t;throw R.errorHandler.handleError(t,{operation:"import",organizationId:e})}}};async function x(e){try{var t;let r=await E(e);if(r instanceof f.NextResponse)return r;if(t=r.scopes,!(t.includes("read:students")||t.includes("*")))return f.NextResponse.json({error:"Insufficient permissions",message:"This API key does not have permission to read students"},{status:403});let a=Date.now(),i=e.nextUrl.searchParams,s=parseInt(i.get("page")||"1"),n=parseInt(i.get("limit")||"50"),o=i.get("search")||void 0,l=await q.getStudents(r.organizationId,{page:s,limit:n,search:o}),d=Date.now()-a;return await v.logAPIRequest(r.key.id,r.organizationId,"GET","/api/v1/students",e.nextUrl.pathname,200,d,e.headers.get("x-forwarded-for")||void 0,e.headers.get("user-agent")||void 0,Object.fromEntries(i)),f.NextResponse.json({data:l,meta:{page:s,limit:n,total:l.length}},{headers:{"X-RateLimit-Remaining":r.rateLimit.remaining.toString(),"X-RateLimit-Reset":r.rateLimit.resetAt.toISOString()}})}catch(t){let e=t instanceof Error?t.message:"Internal server error";return f.NextResponse.json({error:"Internal server error",message:e},{status:500})}}e.s(["GET",()=>x],810873);var S=e.i(810873);let P=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/v1/students/route",pathname:"/api/v1/students",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/v1/students/route.ts",nextConfigOutput:"",userland:S}),{workAsyncStorage:N,workUnitAsyncStorage:O,serverHooks:D}=P;function T(){return(0,a.patchFetch)({workAsyncStorage:N,workUnitAsyncStorage:O})}async function C(e,t,a){P.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let f="/api/v1/students/route";f=f.replace(/\/index$/,"")||"/";let y=await P.prepare(e,t,{srcPage:f,multiZoneDraftMode:!1});if(!y)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:b,params:v,nextConfig:E,parsedUrl:R,isDraftMode:A,prerenderManifest:I,routerServerContext:k,isOnDemandRevalidate:q,revalidateOnlyGenerated:x,resolvedPathname:S,clientReferenceManifest:N,serverActionsManifest:O}=y,D=(0,o.normalizeAppPath)(f),T=!!(I.dynamicRoutes[D]||I.routes[S]),C=async()=>((null==k?void 0:k.render404)?await k.render404(e,t,R,!1):t.end("This page could not be found"),null);if(T&&!A){let e=!!I.routes[S],t=I.dynamicRoutes[D];if(t&&!1===t.fallback&&!e){if(E.experimental.adapterPath)return await C();throw new m.NoFallbackError}}let H=null;!T||P.isDev||A||(H="/index"===(H=S)?"/":H);let z=!0===P.isDev||!T,L=T&&!z;O&&N&&(0,n.setManifestsSingleton)({page:f,clientReferenceManifest:N,serverActionsManifest:O});let U=e.method||"GET",$=(0,s.getTracer)(),K=$.getActiveScopeSpan(),M={params:v,prerenderManifest:I,renderOpts:{experimental:{authInterrupts:!!E.experimental.authInterrupts},cacheComponents:!!E.cacheComponents,supportsDynamicResponse:z,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:E.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a,i)=>P.onRequestError(e,t,a,i,k)},sharedContext:{buildId:b}},j=new l.NodeNextRequest(e),B=new l.NodeNextResponse(t),F=d.NextRequestAdapter.fromNodeNextRequest(j,(0,d.signalFromNodeResponse)(t));try{let n=async e=>P.handle(F,M).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=$.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${U} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${U} ${f}`)}),o=!!(0,i.getRequestMeta)(e,"minimalMode"),l=async i=>{var s,l;let d=async({previousCacheEntry:r})=>{try{if(!o&&q&&x&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await n(i);e.fetchMetrics=M.renderOpts.fetchMetrics;let l=M.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let d=M.renderOpts.collectedTags;if(!T)return await (0,p.sendResponse)(j,B,s,M.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(s.headers);d&&(t[g.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==M.renderOpts.collectedRevalidate&&!(M.renderOpts.collectedRevalidate>=g.INFINITE_CACHE)&&M.renderOpts.collectedRevalidate,a=void 0===M.renderOpts.collectedExpire||M.renderOpts.collectedExpire>=g.INFINITE_CACHE?void 0:M.renderOpts.collectedExpire;return{value:{kind:w.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await P.onRequestError(e,t,{routerKind:"App Router",routePath:f,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:L,isOnDemandRevalidate:q})},!1,k),t}},u=await P.handleResponse({req:e,nextConfig:E,cacheKey:H,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:I,isRoutePPREnabled:!1,isOnDemandRevalidate:q,revalidateOnlyGenerated:x,responseGenerator:d,waitUntil:a.waitUntil,isMinimalMode:o});if(!T)return null;if((null==u||null==(s=u.value)?void 0:s.kind)!==w.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",q?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),A&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,h.fromNodeOutgoingHttpHeaders)(u.value.headers);return o&&T||m.delete(g.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,_.getCacheControlHeader)(u.cacheControl)),await (0,p.sendResponse)(j,B,new Response(u.value.body,{headers:m,status:u.value.status||200})),null};K?await l(K):await $.withPropagatedContext(e.headers,()=>$.trace(u.BaseServerSpan.handleRequest,{spanName:`${U} ${f}`,kind:s.SpanKind.SERVER,attributes:{"http.method":U,"http.target":e.url}},l))}catch(t){if(t instanceof m.NoFallbackError||await P.onRequestError(e,t,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:L,isOnDemandRevalidate:q})},!1,k),T)throw t;return await (0,p.sendResponse)(j,B,new Response(null,{status:500})),null}}e.s(["handler",()=>C,"patchFetch",()=>T,"routeModule",()=>P,"serverHooks",()=>D,"workAsyncStorage",()=>N,"workUnitAsyncStorage",()=>O],133915)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_d150a972.js.map