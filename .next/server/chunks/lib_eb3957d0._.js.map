{"version":3,"sources":["../../../lib/errors/error-handler.ts","../../../lib/services/email.service.ts","../../../lib/services/signature-request.service.ts"],"sourcesContent":["/**\n * ErrorHandler Global - Gestion centralis√©e des erreurs\n * \n * Fournit :\n * - Types d'erreurs personnalis√©s\n * - Classification automatique des erreurs\n * - Messages utilisateur traduits\n * - Logging automatique\n * - Formatage coh√©rent\n */\n\nimport { logger } from '@/lib/utils/logger'\nimport type { LogContext } from '@/lib/utils/logger'\n\n// ============================================================================\n// TYPES D'ERREURS PERSONNALIS√âS\n// ============================================================================\n\nexport enum ErrorCode {\n  // Erreurs d'authentification (1000-1999)\n  AUTH_REQUIRED = 'AUTH_1001',\n  AUTH_INVALID_CREDENTIALS = 'AUTH_1002',\n  AUTH_SESSION_EXPIRED = 'AUTH_1003',\n  AUTH_INSUFFICIENT_PERMISSIONS = 'AUTH_1004',\n  AUTH_2FA_REQUIRED = 'AUTH_1005',\n  AUTH_2FA_INVALID = 'AUTH_1006',\n\n  // Erreurs de validation (2000-2999)\n  VALIDATION_ERROR = 'VALID_2001',\n  VALIDATION_REQUIRED_FIELD = 'VALID_2002',\n  VALIDATION_INVALID_FORMAT = 'VALID_2003',\n  VALIDATION_UNIQUE_CONSTRAINT = 'VALID_2004',\n\n  // Erreurs de base de donn√©es (3000-3999)\n  DB_CONNECTION_ERROR = 'DB_3001',\n  DB_QUERY_ERROR = 'DB_3002',\n  DB_NOT_FOUND = 'DB_3003',\n  DB_CONSTRAINT_VIOLATION = 'DB_3004',\n  DB_FOREIGN_KEY_CONSTRAINT = 'DB_3006',\n  DB_RLS_POLICY_VIOLATION = 'DB_3005',\n\n  // Erreurs r√©seau/API (4000-4999)\n  NETWORK_ERROR = 'NET_4001',\n  API_TIMEOUT = 'NET_4002',\n  API_RATE_LIMIT = 'NET_4003',\n  API_SERVER_ERROR = 'NET_4004',\n  API_NOT_FOUND = 'NET_4005',\n  API_BAD_REQUEST = 'NET_4006',\n\n  // Erreurs m√©tier (5000-5999)\n  BUSINESS_LOGIC_ERROR = 'BIZ_5001',\n  RESOURCE_LOCKED = 'BIZ_5002',\n  OPERATION_NOT_ALLOWED = 'BIZ_5003',\n  QUOTA_EXCEEDED = 'BIZ_5004',\n\n  // Erreurs syst√®me (6000-6999)\n  INTERNAL_ERROR = 'SYS_6001',\n  CONFIGURATION_ERROR = 'SYS_6002',\n  SERVICE_UNAVAILABLE = 'SYS_6003',\n}\n\nexport enum ErrorSeverity {\n  LOW = 'low',\n  MEDIUM = 'medium',\n  HIGH = 'high',\n  CRITICAL = 'critical',\n}\n\nexport interface AppErrorContext extends LogContext {\n  code?: ErrorCode\n  severity?: ErrorSeverity\n  userMessage?: string\n  retryable?: boolean\n  timestamp?: string\n}\n\n/**\n * Classe d'erreur personnalis√©e pour l'application\n */\nexport class AppError extends Error {\n  public readonly code: ErrorCode\n  public readonly severity: ErrorSeverity\n  public readonly userMessage: string\n  public readonly retryable: boolean\n  public readonly context: AppErrorContext\n  public readonly originalError?: Error | unknown\n\n  constructor(\n    message: string,\n    code: ErrorCode = ErrorCode.INTERNAL_ERROR,\n    severity: ErrorSeverity = ErrorSeverity.MEDIUM,\n    context: AppErrorContext = {},\n    originalError?: Error | unknown\n  ) {\n    super(message)\n    this.name = 'AppError'\n    this.code = code\n    this.severity = severity\n    this.userMessage = context.userMessage || this.getDefaultUserMessage(code)\n    this.retryable = context.retryable ?? this.isRetryable(code)\n    this.context = {\n      ...context,\n      code,\n      severity,\n      timestamp: new Date().toISOString(),\n    }\n    this.originalError = originalError\n\n    // Maintenir la stack trace\n    if (Error.captureStackTrace) {\n      Error.captureStackTrace(this, AppError)\n    }\n  }\n\n  /**\n   * Messages utilisateur par d√©faut selon le code d'erreur\n   */\n  private getDefaultUserMessage(code: ErrorCode): string {\n    const messages: Record<ErrorCode, string> = {\n      // Auth\n      [ErrorCode.AUTH_REQUIRED]: 'Vous devez √™tre connect√© pour effectuer cette action.',\n      [ErrorCode.AUTH_INVALID_CREDENTIALS]: 'Email ou mot de passe incorrect.',\n      [ErrorCode.AUTH_SESSION_EXPIRED]: 'Votre session a expir√©. Veuillez vous reconnecter.',\n      [ErrorCode.AUTH_INSUFFICIENT_PERMISSIONS]: \"Vous n'avez pas les permissions n√©cessaires.\",\n      [ErrorCode.AUTH_2FA_REQUIRED]: 'Authentification √† deux facteurs requise.',\n      [ErrorCode.AUTH_2FA_INVALID]: 'Code d\\'authentification invalide.',\n\n      // Validation\n      [ErrorCode.VALIDATION_ERROR]: 'Les donn√©es fournies ne sont pas valides.',\n      [ErrorCode.VALIDATION_REQUIRED_FIELD]: 'Certains champs obligatoires sont manquants.',\n      [ErrorCode.VALIDATION_INVALID_FORMAT]: 'Le format des donn√©es est incorrect.',\n      [ErrorCode.VALIDATION_UNIQUE_CONSTRAINT]: 'Cette valeur existe d√©j√†.',\n\n      // Database\n      [ErrorCode.DB_CONNECTION_ERROR]: 'Impossible de se connecter √† la base de donn√©es.',\n      [ErrorCode.DB_QUERY_ERROR]: 'Erreur lors de l\\'ex√©cution de la requ√™te.',\n      [ErrorCode.DB_NOT_FOUND]: 'Ressource introuvable.',\n      [ErrorCode.DB_CONSTRAINT_VIOLATION]: 'Cette op√©ration viole une contrainte de la base de donn√©es.',\n      [ErrorCode.DB_FOREIGN_KEY_CONSTRAINT]: 'Cette op√©ration viole une contrainte de cl√© √©trang√®re.',\n      [ErrorCode.DB_RLS_POLICY_VIOLATION]: 'Vous n\\'avez pas acc√®s √† cette ressource.',\n\n      // Network\n      [ErrorCode.NETWORK_ERROR]: 'Erreur de connexion r√©seau. V√©rifiez votre connexion internet.',\n      [ErrorCode.API_TIMEOUT]: 'La requ√™te a pris trop de temps. Veuillez r√©essayer.',\n      [ErrorCode.API_RATE_LIMIT]: 'Trop de requ√™tes. Veuillez patienter quelques instants.',\n      [ErrorCode.API_SERVER_ERROR]: 'Erreur serveur. Veuillez r√©essayer plus tard.',\n      [ErrorCode.API_NOT_FOUND]: 'Ressource introuvable.',\n      [ErrorCode.API_BAD_REQUEST]: 'Requ√™te invalide.',\n\n      // Business\n      [ErrorCode.BUSINESS_LOGIC_ERROR]: 'Cette op√©ration n\\'est pas autoris√©e dans le contexte actuel.',\n      [ErrorCode.RESOURCE_LOCKED]: 'Cette ressource est actuellement verrouill√©e.',\n      [ErrorCode.OPERATION_NOT_ALLOWED]: 'Cette op√©ration n\\'est pas autoris√©e.',\n      [ErrorCode.QUOTA_EXCEEDED]: 'Vous avez atteint la limite autoris√©e.',\n\n      // System\n      [ErrorCode.INTERNAL_ERROR]: 'Une erreur interne est survenue. Veuillez r√©essayer.',\n      [ErrorCode.CONFIGURATION_ERROR]: 'Erreur de configuration du syst√®me.',\n      [ErrorCode.SERVICE_UNAVAILABLE]: 'Service temporairement indisponible.',\n    }\n\n    return messages[code] || 'Une erreur inattendue est survenue.'\n  }\n\n  /**\n   * D√©termine si une erreur est retryable selon son code\n   */\n  private isRetryable(code: ErrorCode): boolean {\n    const retryableCodes = [\n      ErrorCode.NETWORK_ERROR,\n      ErrorCode.API_TIMEOUT,\n      ErrorCode.API_SERVER_ERROR,\n      ErrorCode.DB_CONNECTION_ERROR,\n      ErrorCode.SERVICE_UNAVAILABLE,\n    ]\n    return retryableCodes.includes(code)\n  }\n\n  /**\n   * Convertit l'erreur en objet JSON pour logging\n   */\n  toJSON() {\n    return {\n      name: this.name,\n      message: this.message,\n      code: this.code,\n      severity: this.severity,\n      userMessage: this.userMessage,\n      retryable: this.retryable,\n      context: this.context,\n      stack: this.stack,\n      originalError: this.originalError instanceof Error\n        ? {\n            name: this.originalError.name,\n            message: this.originalError.message,\n            stack: this.originalError.stack,\n          }\n        : this.originalError,\n    }\n  }\n}\n\n// ============================================================================\n// ERROR HANDLER PRINCIPAL\n// ============================================================================\n\nexport class ErrorHandler {\n  /**\n   * Analyse et classe une erreur inconnue\n   */\n  handleError(error: unknown, context: AppErrorContext = {}): AppError {\n    // Si c'est d√©j√† une AppError, la retourner telle quelle\n    if (error instanceof AppError) {\n      this.logError(error)\n      return error\n    }\n\n    // Si c'est une Error standard, la convertir\n    if (error instanceof Error) {\n      return this.handleStandardError(error, context)\n    }\n\n    // Si c'est une erreur Supabase\n    if (this.isSupabaseError(error)) {\n      return this.handleSupabaseError(error, context)\n    }\n\n    // Erreur inconnue\n    const appError = new AppError(\n      'Une erreur inattendue est survenue.',\n      ErrorCode.INTERNAL_ERROR,\n      ErrorSeverity.HIGH,\n      context,\n      error\n    )\n    this.logError(appError)\n    return appError\n  }\n\n  /**\n   * G√®re les erreurs Error standard\n   */\n  private handleStandardError(error: Error, context: AppErrorContext): AppError {\n    const message = error.message.toLowerCase()\n\n    // D√©tection par message\n    let code = ErrorCode.INTERNAL_ERROR\n    let severity = ErrorSeverity.MEDIUM\n\n    if (message.includes('network') || message.includes('fetch')) {\n      code = ErrorCode.NETWORK_ERROR\n      severity = ErrorSeverity.MEDIUM\n    } else if (message.includes('timeout')) {\n      code = ErrorCode.API_TIMEOUT\n      severity = ErrorSeverity.MEDIUM\n    } else if (message.includes('unauthorized') || message.includes('401')) {\n      code = ErrorCode.AUTH_REQUIRED\n      severity = ErrorSeverity.HIGH\n    } else if (message.includes('forbidden') || message.includes('403')) {\n      code = ErrorCode.AUTH_INSUFFICIENT_PERMISSIONS\n      severity = ErrorSeverity.HIGH\n    } else if (message.includes('not found') || message.includes('404')) {\n      code = ErrorCode.DB_NOT_FOUND\n      severity = ErrorSeverity.LOW\n    } else if (message.includes('validation') || message.includes('invalid')) {\n      code = ErrorCode.VALIDATION_ERROR\n      severity = ErrorSeverity.LOW\n    }\n\n    const appError = new AppError(error.message, code, severity, context, error)\n    this.logError(appError)\n    return appError\n  }\n\n  /**\n   * G√®re les erreurs Supabase\n   */\n  private handleSupabaseError(error: any, context: AppErrorContext): AppError {\n    const code = error.code || error.status\n    const message = error.message || 'Erreur Supabase'\n\n    // Si un code d'erreur est fourni dans le contexte, l'utiliser en priorit√©\n    let errorCode = context.code || ErrorCode.DB_QUERY_ERROR\n    let severity = ErrorSeverity.MEDIUM\n\n    // Classification par code Supabase (seulement si pas de code dans le contexte)\n    if (!context.code) {\n      switch (code) {\n        case 'PGRST116':\n        case '42P01':\n          errorCode = ErrorCode.DB_NOT_FOUND\n          severity = ErrorSeverity.LOW\n          break\n        case '42501':\n          errorCode = ErrorCode.DB_RLS_POLICY_VIOLATION\n          severity = ErrorSeverity.HIGH\n          break\n        case '23505':\n          errorCode = ErrorCode.VALIDATION_UNIQUE_CONSTRAINT\n          severity = ErrorSeverity.LOW\n          break\n        case '23503':\n          errorCode = ErrorCode.DB_CONSTRAINT_VIOLATION\n          severity = ErrorSeverity.MEDIUM\n          break\n        case 'PGRST301':\n        case '400':\n          errorCode = ErrorCode.API_BAD_REQUEST\n          severity = ErrorSeverity.LOW\n          break\n        case '401':\n          errorCode = ErrorCode.AUTH_REQUIRED\n          severity = ErrorSeverity.HIGH\n          break\n        case '403':\n          errorCode = ErrorCode.AUTH_INSUFFICIENT_PERMISSIONS\n          severity = ErrorSeverity.HIGH\n          break\n        case '404':\n          errorCode = ErrorCode.API_NOT_FOUND\n          severity = ErrorSeverity.LOW\n          break\n        case '500':\n          errorCode = ErrorCode.API_SERVER_ERROR\n          severity = ErrorSeverity.HIGH\n          break\n      }\n    }\n\n    // Ajuster la s√©v√©rit√© selon le code d'erreur\n    if (errorCode === ErrorCode.DB_FOREIGN_KEY_CONSTRAINT) {\n      severity = ErrorSeverity.MEDIUM\n    }\n\n    const appError = new AppError(message, errorCode, severity, context, error)\n    this.logError(appError)\n    return appError\n  }\n\n  /**\n   * V√©rifie si une erreur est une erreur Supabase\n   */\n  private isSupabaseError(error: any): boolean {\n    return (\n      error &&\n      (error.code || error.status || error.message) &&\n      (typeof error.code === 'string' || typeof error.status === 'number')\n    )\n  }\n\n  /**\n   * Log l'erreur selon sa s√©v√©rit√©\n   */\n  private logError(error: AppError) {\n    const logContext: LogContext = {\n      ...error.context,\n      code: error.code,\n      severity: error.severity,\n      retryable: error.retryable,\n    }\n\n    switch (error.severity) {\n      case ErrorSeverity.CRITICAL:\n      case ErrorSeverity.HIGH:\n        logger.error(error.message, error.originalError || error, logContext)\n        break\n      case ErrorSeverity.MEDIUM:\n        logger.warn(error.message, logContext)\n        break\n      case ErrorSeverity.LOW:\n        logger.info(`Error: ${error.message}`, logContext)\n        break\n    }\n  }\n\n  /**\n   * Cr√©e une erreur de validation\n   */\n  createValidationError(message: string, field?: string): AppError {\n    return new AppError(\n      message,\n      ErrorCode.VALIDATION_ERROR,\n      ErrorSeverity.LOW,\n      { field, userMessage: message }\n    )\n  }\n\n  /**\n   * Cr√©e une erreur d'authentification\n   */\n  createAuthError(code: ErrorCode, message?: string): AppError {\n    return new AppError(\n      message || 'Erreur d\\'authentification',\n      code,\n      ErrorSeverity.HIGH\n    )\n  }\n\n  /**\n   * Cr√©e une erreur de base de donn√©es\n   */\n  createDatabaseError(message: string, originalError?: unknown): AppError {\n    return new AppError(\n      message,\n      ErrorCode.DB_QUERY_ERROR,\n      ErrorSeverity.MEDIUM,\n      {},\n      originalError\n    )\n  }\n\n  /**\n   * Cr√©e une erreur \"Not Found\"\n   */\n  createNotFoundError(message: string, context?: AppErrorContext): AppError {\n    return new AppError(\n      message,\n      ErrorCode.DB_NOT_FOUND,\n      ErrorSeverity.LOW,\n      context\n    )\n  }\n}\n\n// Export d'une instance singleton\nexport const errorHandler = new ErrorHandler()\n\n// Export de fonctions helper pour faciliter l'utilisation\nexport const handleError = (error: unknown, context?: AppErrorContext) =>\n  errorHandler.handleError(error, context)\n\nexport const createValidationError = (message: string, field?: string) =>\n  errorHandler.createValidationError(message, field)\n\nexport const createAuthError = (code: ErrorCode, message?: string) =>\n  errorHandler.createAuthError(code, message)\n\nexport const createDatabaseError = (message: string, originalError?: unknown) =>\n  errorHandler.createDatabaseError(message, originalError)\n\nexport const createNotFoundError = (message: string, context?: AppErrorContext) =>\n  errorHandler.createNotFoundError(message, context)\n\n// Alias pour NotFoundError (compatibilit√©)\nexport const NotFoundError = createNotFoundError\n\n","/**\n * Service d'envoi d'emails\n * \n * Ce service permet d'envoyer des emails avec pi√®ces jointes depuis l'application.\n * \n * Configuration requise :\n * - Installer Resend : npm install resend\n * - Ajouter RESEND_API_KEY dans .env.local\n * - Ou utiliser un autre service d'email (SendGrid, etc.)\n */\n\ninterface EmailAttachment {\n  filename: string\n  content: Blob | ArrayBuffer | string // Base64 ou Blob\n  contentType: string\n}\n\ninterface SendEmailOptions {\n  to: string | string[]\n  subject: string\n  html?: string\n  text?: string\n  attachments?: EmailAttachment[]\n  cc?: string | string[]\n  bcc?: string | string[]\n  replyTo?: string\n}\n\nexport class EmailService {\n  /**\n   * Convertit un Blob en base64\n   */\n  private async blobToBase64(blob: Blob): Promise<string> {\n    return new Promise((resolve, reject) => {\n      const reader = new FileReader()\n      reader.onloadend = () => {\n        const base64 = (reader.result as string).split(',')[1]\n        resolve(base64)\n      }\n      reader.onerror = reject\n      reader.readAsDataURL(blob)\n    })\n  }\n\n  /**\n   * Envoie un email avec pi√®ces jointes\n   */\n  async sendEmail(options: SendEmailOptions): Promise<{ success: boolean; message: string }> {\n    try {\n      // Convertir les pi√®ces jointes en base64 si n√©cessaire\n      const attachments = options.attachments\n        ? await Promise.all(\n            options.attachments.map(async (att) => {\n              let content: string\n              if (att.content instanceof Blob) {\n                content = await this.blobToBase64(att.content)\n              } else if (att.content instanceof ArrayBuffer) {\n                const blob = new Blob([att.content], { type: att.contentType })\n                content = await this.blobToBase64(blob)\n              } else {\n                content = att.content\n              }\n\n              return {\n                filename: att.filename,\n                content,\n                contentType: att.contentType,\n              }\n            })\n          )\n        : undefined\n\n      const response = await fetch('/api/email/send', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        credentials: 'include', // Inclure les cookies pour l'authentification\n        body: JSON.stringify({\n          to: options.to,\n          subject: options.subject,\n          html: options.html,\n          text: options.text,\n          attachments,\n          cc: options.cc,\n          bcc: options.bcc,\n          replyTo: options.replyTo,\n        }),\n      })\n\n      if (!response.ok) {\n        const error = await response.json()\n        throw new Error(error.message || 'Erreur lors de l\\'envoi de l\\'email')\n      }\n\n      const data = await response.json()\n      return { success: true, message: data.message || 'Email envoy√© avec succ√®s' }\n    } catch (error) {\n      throw new Error(\n        error instanceof Error\n          ? error.message\n          : 'Erreur lors de l\\'envoi de l\\'email'\n      )\n    }\n  }\n\n  /**\n   * Envoie un document PDF par email\n   */\n  async sendDocument(\n    to: string | string[],\n    subject: string,\n    pdfBlob: Blob,\n    filename: string,\n    htmlBody?: string,\n    textBody?: string\n  ): Promise<{ success: boolean; message: string }> {\n    return this.sendEmail({\n      to,\n      subject,\n      html: htmlBody,\n      text: textBody,\n      attachments: [\n        {\n          filename,\n          content: pdfBlob,\n          contentType: 'application/pdf',\n        },\n      ],\n    })\n  }\n\n  /**\n   * Envoie plusieurs documents par email\n   */\n  async sendMultipleDocuments(\n    to: string | string[],\n    subject: string,\n    documents: Array<{ blob: Blob; filename: string }>,\n    htmlBody?: string,\n    textBody?: string\n  ): Promise<{ success: boolean; message: string }> {\n    return this.sendEmail({\n      to,\n      subject,\n      html: htmlBody,\n      text: textBody,\n      attachments: documents.map((doc) => ({\n        filename: doc.filename,\n        content: doc.blob,\n        contentType: 'application/pdf',\n      })),\n    })\n  }\n}\n\nexport const emailService = new EmailService()\n","import { createClient } from '@/lib/supabase/client'\nimport type { SupabaseClient } from '@supabase/supabase-js'\nimport { Database } from '@/types/database.types'\nimport type { TableRow, TableInsert, TableUpdate, FlexibleInsert, FlexibleUpdate } from '@/lib/types/supabase-helpers'\nimport { errorHandler, AppError, ErrorCode } from '@/lib/errors'\nimport { logger } from '@/lib/utils/logger'\nimport { emailService } from './email.service'\n\ntype SignatureRequest = TableRow<'signature_requests'>\ntype SignatureRequestInsert = TableInsert<'signature_requests'>\ntype SignatureRequestUpdate = TableUpdate<'signature_requests'>\n\nexport interface CreateSignatureRequestParams {\n  documentId: string\n  organizationId: string\n  recipientEmail: string\n  recipientName: string\n  recipientType: 'student' | 'funder' | 'teacher' | 'other'\n  recipientId?: string\n  subject?: string\n  message?: string\n  expiresAt?: string\n  requiresNotarization?: boolean\n  reminderFrequency?: 'daily' | 'weekly' | 'none'\n}\n\nexport interface SignatureRequestWithDetails extends SignatureRequest {\n  document: {\n    id: string\n    title: string | null\n    file_url: string | null\n  } | null\n  requester: {\n    id: string\n    full_name: string | null\n    email: string | null\n  } | null\n}\n\n/**\n * Service pour g√©rer les demandes de signature √©lectronique par email\n */\nexport class SignatureRequestService {\n  private supabase: SupabaseClient<Database>\n\n\n  constructor(supabaseClient?: SupabaseClient<Database>) {\n\n    this.supabase = supabaseClient || createClient()\n\n  }\n\n  /**\n   * Cr√©e une demande de signature et envoie l'email\n   */\n  async createSignatureRequest(params: CreateSignatureRequestParams) {\n    try {\n      // R√©cup√©rer l'utilisateur actuel\n      const { data: userData } = await this.supabase.auth.getUser()\n      if (!userData.user) {\n        throw errorHandler.createAuthError(ErrorCode.AUTH_REQUIRED, 'Utilisateur non authentifi√©')\n      }\n\n      // R√©cup√©rer les informations du document\n      const { data: document, error: documentError } = await this.supabase\n        .from('documents')\n        .select('id, title, file_url, organization_id')\n        .eq('id', params.documentId)\n        .single()\n\n      if (documentError || !document) {\n        throw errorHandler.createNotFoundError('Document introuvable', { documentId: params.documentId })\n      }\n\n      // G√©n√©rer un token unique pour la signature\n      const signatureToken = this.generateSignatureToken()\n\n      // Calculer la date d'expiration (par d√©faut 30 jours)\n      const expiresAt = params.expiresAt || new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString()\n\n      // Cr√©er la demande de signature\n      const requestData: FlexibleInsert<'signature_requests'> = {\n        document_id: params.documentId,\n        organization_id: params.organizationId,\n        requester_id: userData.user.id,\n        recipient_email: params.recipientEmail,\n        recipient_name: params.recipientName,\n        recipient_type: params.recipientType,\n        recipient_id: params.recipientId || null,\n        subject: params.subject || `Demande de signature : ${document.title}`,\n        message: params.message || null,\n        status: 'pending',\n        signature_token: signatureToken,\n        expires_at: expiresAt,\n        requires_notarization: params.requiresNotarization || false,\n        reminder_frequency: params.reminderFrequency || 'none',\n      }\n\n      const { data, error } = await this.supabase\n        .from('signature_requests')\n        .insert(requestData as SignatureRequestInsert)\n        .select(`\n          *,\n          document:documents(id, title, file_url),\n          requester:users!signature_requests_requester_id_fkey(id, full_name, email)\n        `)\n        .single()\n\n      if (error) throw error\n\n      // G√©n√©rer l'URL de signature\n      const signatureUrl = this.generateSignatureUrl(signatureToken)\n\n      // Envoyer l'email de demande de signature\n      await this.sendSignatureRequestEmail({\n        to: params.recipientEmail,\n        recipientName: params.recipientName,\n        documentTitle: document.title || 'Document',\n        signatureUrl,\n        message: params.message,\n        expiresAt,\n        requesterName: userData.user.user_metadata?.full_name || 'Un utilisateur',\n      })\n\n      logger.info('Demande de signature cr√©√©e et email envoy√©', {\n        requestId: data.id,\n        documentId: params.documentId,\n        recipientEmail: params.recipientEmail,\n      })\n\n      return data as SignatureRequestWithDetails\n    } catch (error) {\n      if (error instanceof AppError) throw error\n      throw errorHandler.handleError(error, {\n        operation: 'createSignatureRequest',\n        documentId: params.documentId,\n      })\n    }\n  }\n\n  /**\n   * Cr√©e plusieurs demandes de signature en masse\n   */\n  async createBulkSignatureRequests(\n    documentId: string,\n    organizationId: string,\n    recipients: Array<{\n      email: string\n      name: string\n      type: 'student' | 'funder' | 'teacher' | 'other'\n      id?: string\n    }>,\n    options?: {\n      subject?: string\n      message?: string\n      expiresAt?: string\n    }\n  ) {\n    try {\n      const results = await Promise.allSettled(\n        recipients.map((recipient) =>\n          this.createSignatureRequest({\n            documentId,\n            organizationId,\n            recipientEmail: recipient.email,\n            recipientName: recipient.name,\n            recipientType: recipient.type,\n            recipientId: recipient.id,\n            subject: options?.subject,\n            message: options?.message,\n            expiresAt: options?.expiresAt,\n          })\n        )\n      )\n\n      const successful = results.filter((r) => r.status === 'fulfilled')\n      const failed = results.filter((r) => r.status === 'rejected')\n\n      logger.info('Demandes de signature en masse', {\n        total: recipients.length,\n        successful: successful.length,\n        failed: failed.length,\n      })\n\n      return {\n        successful: successful.map((r) => (r as PromiseFulfilledResult<SignatureRequestWithDetails>).value),\n        failed: failed.map((r) => (r as PromiseRejectedResult).reason),\n        total: recipients.length,\n      }\n    } catch (error) {\n      if (error instanceof AppError) throw error\n      throw errorHandler.handleError(error, {\n        operation: 'createBulkSignatureRequests',\n        documentId,\n      })\n    }\n  }\n\n  /**\n   * R√©cup√®re une demande de signature par son token\n   */\n  async getSignatureRequestByToken(token: string) {\n    try {\n      const { data, error } = await this.supabase\n        .from('signature_requests')\n        .select(`\n          *,\n          document:documents(id, title, file_url, type),\n          requester:users!signature_requests_requester_id_fkey(id, full_name, email)\n        `)\n        .eq('signature_token', token)\n        .single()\n\n      if (error) {\n        if (error.code === 'PGRST116') {\n          throw errorHandler.createNotFoundError('Demande de signature introuvable', { token })\n        }\n        throw error\n      }\n\n      // V√©rifier si la demande n'a pas expir√©\n      if (data.expires_at && new Date(data.expires_at) < new Date()) {\n        throw errorHandler.createValidationError('La demande de signature a expir√©', 'expires_at')\n      }\n\n      return data as SignatureRequestWithDetails\n    } catch (error) {\n      if (error instanceof AppError) throw error\n      throw errorHandler.handleError(error, {\n        operation: 'getSignatureRequestByToken',\n      })\n    }\n  }\n\n  /**\n   * R√©cup√®re toutes les demandes de signature pour un document\n   */\n  async getSignatureRequestsByDocument(documentId: string) {\n    try {\n      const { data, error } = await this.supabase\n        .from('signature_requests')\n        .select(`\n          *,\n          requester:users!signature_requests_requester_id_fkey(id, full_name, email)\n        `)\n        .eq('document_id', documentId)\n        .order('created_at', { ascending: false })\n\n      if (error) throw error\n      return data || []\n    } catch (error) {\n      if (error instanceof AppError) throw error\n      throw errorHandler.handleError(error, {\n        operation: 'getSignatureRequestsByDocument',\n        documentId,\n      })\n    }\n  }\n\n  /**\n   * R√©cup√®re toutes les demandes de signature pour une organisation\n   */\n  async getSignatureRequestsByOrganization(\n    organizationId: string,\n    filters?: {\n      status?: 'pending' | 'signed' | 'expired' | 'declined' | 'cancelled'\n      recipientType?: 'student' | 'funder' | 'teacher' | 'other'\n    }\n  ) {\n    try {\n      let query = this.supabase\n        .from('signature_requests')\n        .select(`\n          *,\n          document:documents(id, title, type),\n          requester:users!signature_requests_requester_id_fkey(id, full_name, email)\n        `)\n        .eq('organization_id', organizationId)\n\n      if (filters?.status) {\n        query = query.eq('status', filters.status)\n      }\n\n      if (filters?.recipientType) {\n        query = query.eq('recipient_type', filters.recipientType)\n      }\n\n      const { data, error } = await query.order('created_at', { ascending: false })\n\n      if (error) throw error\n      return data || []\n    } catch (error) {\n      if (error instanceof AppError) throw error\n      throw errorHandler.handleError(error, {\n        operation: 'getSignatureRequestsByOrganization',\n        organizationId,\n      })\n    }\n  }\n\n  /**\n   * Met √† jour le statut d'une demande de signature\n   */\n  async updateSignatureRequestStatus(\n    requestId: string,\n    status: 'pending' | 'signed' | 'expired' | 'declined' | 'cancelled',\n    signatureId?: string\n  ) {\n    try {\n      const updates: FlexibleUpdate<'signature_requests'> = {\n        status,\n      }\n\n      if (status === 'signed' && signatureId) {\n        updates.signature_id = signatureId\n        updates.signed_at = new Date().toISOString()\n      }\n\n      const { data, error } = await this.supabase\n        .from('signature_requests')\n        .update(updates as SignatureRequestUpdate)\n        .eq('id', requestId)\n        .select()\n        .single()\n\n      if (error) throw error\n\n      logger.info('Statut de demande de signature mis √† jour', {\n        requestId,\n        status,\n      })\n\n      return data\n    } catch (error) {\n      if (error instanceof AppError) throw error\n      throw errorHandler.handleError(error, {\n        operation: 'updateSignatureRequestStatus',\n        requestId,\n      })\n    }\n  }\n\n  /**\n   * Annule une demande de signature\n   */\n  async cancelSignatureRequest(requestId: string) {\n    return this.updateSignatureRequestStatus(requestId, 'cancelled')\n  }\n\n  /**\n   * Envoie un rappel pour une demande de signature en attente\n   */\n  async sendReminder(requestId: string) {\n    try {\n      const { data: request, error } = await this.supabase\n        .from('signature_requests')\n        .select(`\n          *,\n          document:documents(id, title, file_url),\n          requester:users!signature_requests_requester_id_fkey(id, full_name, email)\n        `)\n        .eq('id', requestId)\n        .single()\n\n      if (error || !request) {\n        throw errorHandler.createNotFoundError('Demande de signature introuvable', { requestId })\n      }\n\n      if (request.status !== 'pending') {\n        throw errorHandler.createValidationError(\n          'Impossible d\\'envoyer un rappel pour une demande qui n\\'est pas en attente',\n          'status'\n        )\n      }\n\n      const signatureUrl = this.generateSignatureUrl(request.signature_token)\n\n      await this.sendSignatureReminderEmail({\n        to: request.recipient_email,\n        recipientName: request.recipient_name,\n        documentTitle: (request.document as any)?.title || 'Document',\n        signatureUrl,\n        expiresAt: request.expires_at,\n        requesterName: (request.requester as any)?.full_name || 'Un utilisateur',\n      })\n\n      // Mettre √† jour le compteur de rappels et la date du dernier rappel\n      await this.supabase\n        .from('signature_requests')\n        .update({\n          reminder_count: (request.reminder_count || 0) + 1,\n          last_reminder_sent_at: new Date().toISOString(),\n        } as SignatureRequestUpdate)\n        .eq('id', requestId)\n\n      logger.info('Rappel de signature envoy√©', { requestId })\n\n      return true\n    } catch (error) {\n      if (error instanceof AppError) throw error\n      throw errorHandler.handleError(error, {\n        operation: 'sendReminder',\n        requestId,\n      })\n    }\n  }\n\n  /**\n   * G√©n√®re un token unique pour une demande de signature\n   */\n  private generateSignatureToken(): string {\n    const timestamp = Date.now().toString(36)\n    const randomPart = Math.random().toString(36).substring(2, 15)\n    const randomPart2 = Math.random().toString(36).substring(2, 15)\n    return `${timestamp}-${randomPart}-${randomPart2}`\n  }\n\n  /**\n   * G√©n√®re l'URL de signature √† partir du token\n   */\n  private generateSignatureUrl(token: string): string {\n    const baseUrl = typeof window !== 'undefined'\n      ? window.location.origin\n      : process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000'\n\n    return `${baseUrl}/signature/${token}`\n  }\n\n  /**\n   * Envoie l'email de demande de signature\n   */\n  private async sendSignatureRequestEmail(params: {\n    to: string\n    recipientName: string\n    documentTitle: string\n    signatureUrl: string\n    message?: string | null\n    expiresAt: string\n    requesterName: string\n  }) {\n    const expirationDate = new Date(params.expiresAt).toLocaleDateString('fr-FR', {\n      day: 'numeric',\n      month: 'long',\n      year: 'numeric',\n    })\n\n    const htmlBody = `\n      <!DOCTYPE html>\n      <html>\n        <head>\n          <meta charset=\"utf-8\">\n          <style>\n            body {\n              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\n              line-height: 1.6;\n              color: #333;\n              max-width: 600px;\n              margin: 0 auto;\n              padding: 20px;\n            }\n            .header {\n              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n              color: white;\n              padding: 30px;\n              border-radius: 8px 8px 0 0;\n              text-align: center;\n            }\n            .content {\n              background: #f9fafb;\n              padding: 30px;\n              border-radius: 0 0 8px 8px;\n            }\n            .button {\n              display: inline-block;\n              background: #667eea;\n              color: white;\n              padding: 14px 32px;\n              text-decoration: none;\n              border-radius: 6px;\n              margin: 20px 0;\n              font-weight: 600;\n            }\n            .button:hover {\n              background: #5568d3;\n            }\n            .info-box {\n              background: white;\n              border-left: 4px solid #667eea;\n              padding: 16px;\n              margin: 20px 0;\n              border-radius: 4px;\n            }\n            .footer {\n              text-align: center;\n              margin-top: 30px;\n              color: #6b7280;\n              font-size: 14px;\n            }\n          </style>\n        </head>\n        <body>\n          <div class=\"header\">\n            <h1 style=\"margin: 0;\">üìù Demande de signature</h1>\n          </div>\n          <div class=\"content\">\n            <p>Bonjour <strong>${params.recipientName}</strong>,</p>\n\n            <p>${params.requesterName} vous demande de signer le document suivant :</p>\n\n            <div class=\"info-box\">\n              <strong>üìÑ ${params.documentTitle}</strong>\n            </div>\n\n            ${params.message ? `<p><em>${params.message}</em></p>` : ''}\n\n            <p>Pour consulter et signer ce document, veuillez cliquer sur le bouton ci-dessous :</p>\n\n            <div style=\"text-align: center;\">\n              <a href=\"${params.signatureUrl}\" class=\"button\">Signer le document</a>\n            </div>\n\n            <p style=\"font-size: 14px; color: #6b7280;\">\n              Ou copiez ce lien dans votre navigateur :<br>\n              <a href=\"${params.signatureUrl}\" style=\"color: #667eea;\">${params.signatureUrl}</a>\n            </p>\n\n            <div class=\"info-box\" style=\"background: #fef3c7; border-left-color: #f59e0b;\">\n              <strong>‚è∞ Date d'expiration :</strong> ${expirationDate}\n            </div>\n\n            <p style=\"font-size: 14px; color: #6b7280; margin-top: 30px;\">\n              Cette demande de signature est conforme aux normes eIDAS et garantit la validit√© juridique de votre signature √©lectronique.\n            </p>\n          </div>\n\n          <div class=\"footer\">\n            <p>EDUZEN - Plateforme de gestion de formation</p>\n            <p style=\"font-size: 12px;\">Si vous n'√™tes pas le destinataire de ce message, veuillez l'ignorer.</p>\n          </div>\n        </body>\n      </html>\n    `\n\n    const textBody = `\nBonjour ${params.recipientName},\n\n${params.requesterName} vous demande de signer le document suivant :\n\nDocument : ${params.documentTitle}\n\n${params.message ? `Message : ${params.message}\\n\\n` : ''}\n\nPour consulter et signer ce document, veuillez cliquer sur ce lien :\n${params.signatureUrl}\n\nDate d'expiration : ${expirationDate}\n\nCette demande de signature est conforme aux normes eIDAS et garantit la validit√© juridique de votre signature √©lectronique.\n\n---\nEDUZEN - Plateforme de gestion de formation\nSi vous n'√™tes pas le destinataire de ce message, veuillez l'ignorer.\n    `\n\n    await emailService.sendEmail({\n      to: params.to,\n      subject: `Demande de signature : ${params.documentTitle}`,\n      html: htmlBody,\n      text: textBody,\n    })\n  }\n\n  /**\n   * Envoie l'email de rappel de signature\n   */\n  private async sendSignatureReminderEmail(params: {\n    to: string\n    recipientName: string\n    documentTitle: string\n    signatureUrl: string\n    expiresAt: string | null\n    requesterName: string\n  }) {\n    const expirationText = params.expiresAt\n      ? `Expire le ${new Date(params.expiresAt).toLocaleDateString('fr-FR')}`\n      : ''\n\n    const htmlBody = `\n      <!DOCTYPE html>\n      <html>\n        <head>\n          <meta charset=\"utf-8\">\n          <style>\n            body {\n              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\n              line-height: 1.6;\n              color: #333;\n              max-width: 600px;\n              margin: 0 auto;\n              padding: 20px;\n            }\n            .header {\n              background: linear-gradient(135deg, #f59e0b 0%, #ea580c 100%);\n              color: white;\n              padding: 30px;\n              border-radius: 8px 8px 0 0;\n              text-align: center;\n            }\n            .content {\n              background: #f9fafb;\n              padding: 30px;\n              border-radius: 0 0 8px 8px;\n            }\n            .button {\n              display: inline-block;\n              background: #f59e0b;\n              color: white;\n              padding: 14px 32px;\n              text-decoration: none;\n              border-radius: 6px;\n              margin: 20px 0;\n              font-weight: 600;\n            }\n            .footer {\n              text-align: center;\n              margin-top: 30px;\n              color: #6b7280;\n              font-size: 14px;\n            }\n          </style>\n        </head>\n        <body>\n          <div class=\"header\">\n            <h1 style=\"margin: 0;\">üîî Rappel de signature</h1>\n          </div>\n          <div class=\"content\">\n            <p>Bonjour <strong>${params.recipientName}</strong>,</p>\n\n            <p>Ceci est un rappel concernant la demande de signature du document suivant :</p>\n\n            <p><strong>üìÑ ${params.documentTitle}</strong></p>\n\n            <p>Ce document est en attente de votre signature.</p>\n\n            ${expirationText ? `<p style=\"color: #f59e0b;\"><strong>‚è∞ ${expirationText}</strong></p>` : ''}\n\n            <div style=\"text-align: center;\">\n              <a href=\"${params.signatureUrl}\" class=\"button\">Signer maintenant</a>\n            </div>\n\n            <p style=\"font-size: 14px; color: #6b7280;\">\n              Lien de signature :<br>\n              <a href=\"${params.signatureUrl}\" style=\"color: #f59e0b;\">${params.signatureUrl}</a>\n            </p>\n          </div>\n\n          <div class=\"footer\">\n            <p>EDUZEN - Plateforme de gestion de formation</p>\n          </div>\n        </body>\n      </html>\n    `\n\n    const textBody = `\nBonjour ${params.recipientName},\n\nCeci est un rappel concernant la demande de signature du document suivant :\n\nDocument : ${params.documentTitle}\n\nCe document est en attente de votre signature.\n\n${expirationText}\n\nPour signer ce document, veuillez cliquer sur ce lien :\n${params.signatureUrl}\n\n---\nEDUZEN - Plateforme de gestion de formation\n    `\n\n    await emailService.sendEmail({\n      to: params.to,\n      subject: `Rappel : Signature en attente - ${params.documentTitle}`,\n      html: htmlBody,\n      text: textBody,\n    })\n  }\n}\n\nexport const signatureRequestService = new SignatureRequestService()\n"],"names":[],"mappings":"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"}