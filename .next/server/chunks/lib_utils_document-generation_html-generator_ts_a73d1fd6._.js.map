{"version":3,"sources":["../../../lib/utils/document-generation/html-generator.ts"],"sourcesContent":["/**\n * G√©n√©rateur HTML pour documents\n */\n\nimport type { DocumentTemplate, DocumentVariables } from '@/lib/types/document-templates'\nimport { evaluateConditionalContent } from './conditional-processor'\nimport { processLoops } from './loop-processor'\nimport { processCalculatedVariables } from './calculated-variables'\nimport { processDynamicTables } from './dynamic-table-processor'\nimport { processElementVisibility } from './element-visibility-processor'\nimport { processNestedVariables, flattenVariables } from './nested-variables-processor'\nimport { processDynamicHyperlinks } from './dynamic-hyperlinks-processor'\nimport { processSignatures } from './signature-processor'\nimport { processAttachments } from './attachment-processor'\nimport { processFormFields } from './form-field-processor'\nimport { enrichVariablesWithExternalData } from './api-integration-processor'\n// Note: getGlobalDocumentLayout est import√© dynamiquement pour √©viter les erreurs c√¥t√© client\n\n/**\n * G√©n√®re un en-t√™te professionnel bas√© sur les informations de l'organisation\n * Style Premium inspir√© de INSSI FORMATION :\n * - Informations de l'organisme √† gauche\n * - Logo √† droite\n * - Ligne de s√©paration en bas (2px solid noir)\n */\nfunction generateProfessionalHeader(variables: Record<string, any>): string {\n  const orgName = variables.ecole_nom || variables.organization_name || ''\n  const orgAddress = variables.ecole_adresse || variables.organization_address || ''\n  const orgPostalCode = variables.ecole_code_postal || ''\n  const orgCity = variables.ecole_ville || ''\n  const orgEmail = variables.ecole_email || variables.organization_email || ''\n  const orgPhone = variables.ecole_telephone || variables.organization_phone || ''\n  const orgLogo = variables.ecole_logo || variables.organization_logo || ''\n\n  return `\n    <div style=\"display: flex; justify-content: space-between; align-items: flex-start; padding: 0 0 15px 0; border-bottom: 2px solid #1A1A1A; margin-bottom: 20px;\">\n      <div style=\"flex: 1;\">\n        <p style=\"font-weight: bold; font-size: 14pt; margin: 0; color: #1A1A1A; line-height: 1.3;\">${orgName}</p>\n        ${orgAddress ? `<p style=\"font-size: 9pt; color: #666; margin: 4px 0 0 0; line-height: 1.4;\">${orgAddress}</p>` : ''}\n        ${(orgPostalCode || orgCity) ? `<p style=\"font-size: 9pt; color: #666; margin: 2px 0; line-height: 1.4;\">${orgPostalCode} ${orgCity}</p>` : ''}\n        ${orgEmail ? `<p style=\"font-size: 9pt; color: #666; margin: 2px 0; line-height: 1.4;\">Email : ${orgEmail}</p>` : ''}\n        ${orgPhone ? `<p style=\"font-size: 9pt; color: #666; margin: 2px 0; line-height: 1.4;\">Tel : ${orgPhone}</p>` : ''}\n      </div>\n      ${orgLogo ? `\n      <div style=\"text-align: right; min-width: 100px;\">\n        <img src=\"${orgLogo}\" alt=\"Logo\" style=\"max-height: 55px; max-width: 140px; object-fit: contain;\" />\n      </div>\n      ` : ''}\n    </div>\n  `\n}\n\n/**\n * G√©n√®re un bas de page professionnel bas√© sur les informations de l'organisation\n * Style Premium inspir√© de INSSI FORMATION :\n * - Nom | Adresse | SIRET sur une ligne centrale\n * - Num√©ro de d√©claration d'activit√©\n * - Mention l√©gale en italique\n * - Pagination √† droite\n */\nfunction generateProfessionalFooter(variables: Record<string, any>, pageNumber?: number, totalPages?: number): string {\n  const orgName = variables.ecole_nom || variables.organization_name || ''\n  const orgAddress = variables.ecole_adresse || variables.organization_address || ''\n  const orgCity = variables.ecole_ville || ''\n  const orgPostalCode = variables.ecole_code_postal || ''\n  const orgSiret = variables.ecole_siret || variables.organization_siret || ''\n  const orgDeclaration = variables.ecole_numero_declaration || variables.organization_declaration_number || ''\n  const orgRegion = variables.ecole_region || ''\n\n  // Construire la ligne principale avec s√©parateurs\n  const mainLineParts = [\n    orgName,\n    orgAddress ? `${orgAddress} ${orgCity} ${orgPostalCode}`.trim() : '',\n    orgSiret ? `Num√©ro SIRET : ${orgSiret}` : '',\n  ].filter(Boolean)\n  \n  const mainLine = mainLineParts.join(' | ')\n\n  // Pagination\n  const pageInfo = (pageNumber !== undefined && totalPages !== undefined) \n    ? `Page ${pageNumber} / ${totalPages}`\n    : 'Page {numero_page} / {total_pages}'\n\n  return `\n    <div style=\"border-top: 1px solid #E5E7EB; padding: 12px 0 8px 0; margin-top: 25px; background-color: #FAFAFA;\">\n      <p style=\"font-size: 9pt; color: #1A1A1A; margin: 0; text-align: center; font-weight: 500; line-height: 1.4;\">\n        ${mainLine}\n      </p>\n      ${orgDeclaration ? `\n      <p style=\"font-size: 8pt; color: #666; margin: 4px 0 0 0; text-align: center; line-height: 1.3;\">\n        Num√©ro de d√©claration d'activit√© : ${orgDeclaration} ${orgRegion ? `<em>(aupr√®s du pr√©fet de r√©gion de : ${orgRegion})</em>` : '<em>(aupr√®s du pr√©fet de r√©gion de : )</em>'}\n      </p>\n      <p style=\"font-size: 8pt; color: #888; font-style: italic; margin: 3px 0 0 0; text-align: center; line-height: 1.3;\">\n        Cet enregistrement ne vaut pas l'agr√©ment de l'√âtat.\n      </p>\n      ` : ''}\n      <p style=\"font-size: 9pt; color: #666; margin: 8px 0 0 0; text-align: right; font-weight: 500;\">\n        ${pageInfo}\n      </p>\n    </div>\n  `\n}\n\n/**\n * Convertit une URL d'image en base64 (pour Puppeteer/PDF)\n * Cette fonction est asynchrone et doit √™tre appel√©e c√¥t√© serveur\n */\nasync function convertImageUrlToBase64(imageUrl: string): Promise<string | null> {\n  try {\n    // Si c'est d√©j√† une data URL, la retourner telle quelle\n    if (imageUrl.startsWith('data:')) {\n      console.log(`[convertImageUrlToBase64] URL d√©j√† en base64`)\n      return imageUrl\n    }\n    \n    if (!imageUrl || !imageUrl.trim()) {\n      console.warn(`[convertImageUrlToBase64] URL vide`)\n      return null\n    }\n    \n    console.log(`[convertImageUrlToBase64] T√©l√©chargement de l'image depuis: ${imageUrl.substring(0, 80)}...`)\n    \n    // T√©l√©charger l'image avec timeout\n    const controller = new AbortController()\n    const timeoutId = setTimeout(() => controller.abort(), 10000) // 10 secondes de timeout\n    \n    try {\n      const response = await fetch(imageUrl, {\n        headers: {\n          'Accept': 'image/*',\n        },\n        signal: controller.signal,\n      })\n      \n      clearTimeout(timeoutId)\n      \n      if (!response.ok) {\n        console.warn(`[convertImageUrlToBase64] √âchec du t√©l√©chargement: ${response.status} ${response.statusText}`)\n        return null\n      }\n      \n      // Convertir en buffer puis en base64\n      const arrayBuffer = await response.arrayBuffer()\n      const buffer = Buffer.from(arrayBuffer)\n      const base64 = buffer.toString('base64')\n      \n      // D√©terminer le type MIME\n      const contentType = response.headers.get('content-type') || 'image/png'\n      \n      const dataUrl = `data:${contentType};base64,${base64}`\n      console.log(`[convertImageUrlToBase64] ‚úÖ Image convertie en base64 (${dataUrl.substring(0, 50)}..., taille: ${base64.length} caract√®res)`)\n      return dataUrl\n    } catch (fetchError) {\n      clearTimeout(timeoutId)\n      if (fetchError instanceof Error && fetchError.name === 'AbortError') {\n        console.error(`[convertImageUrlToBase64] Timeout lors du t√©l√©chargement`)\n      } else {\n        console.error(`[convertImageUrlToBase64] Erreur fetch:`, fetchError)\n      }\n      return null\n    }\n  } catch (error) {\n    console.error(`[convertImageUrlToBase64] Erreur lors de la conversion:`, error)\n    return null\n  }\n}\n\n// Fonction pour traiter les logos (doit √™tre appel√©e AVANT replaceVariablesInHTML)\n// NOTE: Cette fonction est maintenant asynchrone pour convertir les URLs en base64\nasync function processLogos(html: string, variables: Record<string, any>): Promise<string> {\n  if (!html || typeof html !== 'string') {\n    return html\n  }\n  \n  let result = html\n  const logoKeys = ['ecole_logo', 'organization_logo']\n  \n  console.log('[processLogos] D√©but du traitement, longueur HTML:', html.length)\n  console.log('[processLogos] Variables disponibles:', Object.keys(variables).filter(k => logoKeys.includes(k)))\n  \n  // √âTAPE 1: Si le header contient d√©j√† l'URL comme texte (au lieu de data-logo-var),\n  // la remplacer par une balise img avec data-logo-var AVANT de traiter les balises existantes\n  logoKeys.forEach((key) => {\n    const logoValue = variables[key] && String(variables[key]).trim() ? String(variables[key]) : null\n    if (logoValue && logoValue.includes('supabase.co')) {\n      // Chercher si l'URL appara√Æt comme texte dans le HTML (pas dans un attribut src ou href)\n      // Utiliser un regex simple qui trouve l'URL et v√©rifie le contexte\n      const escapedUrl = logoValue.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&')\n      \n      // Pattern: URL qui n'est pas pr√©c√©d√©e par src=\" ou href=\" et qui n'est pas dans une balise avec src\n      // On va utiliser une approche en deux passes : d'abord trouver, puis remplacer\n      let foundTextUrl = false\n      const urlRegex = new RegExp(escapedUrl, 'gi')\n      const matches = [...result.matchAll(urlRegex)]\n      \n      // Traiter les matches en ordre inverse pour √©viter les probl√®mes d'offset\n      for (let i = matches.length - 1; i >= 0; i--) {\n        const match = matches[i]\n        if (!match.index) continue\n        \n        const offset = match.index\n        const before = result.substring(Math.max(0, offset - 150), offset)\n        const after = result.substring(offset + logoValue.length, Math.min(result.length, offset + logoValue.length + 50))\n        \n        // V√©rifier si on est dans un attribut src=\"...\" ou href=\"...\"\n        const isInSrc = before.match(/src\\s*=\\s*\"[^\"]*$/)\n        const isInHref = before.match(/href\\s*=\\s*\"[^\"]*$/)\n        const isInImgTag = before.match(/<img[^>]*$/)\n        \n        // Si l'URL n'est PAS dans un attribut src/href mais est dans une balise img, c'est OK\n        // Si l'URL est compl√®tement en dehors d'une balise img, la remplacer\n        if (!isInSrc && !isInHref) {\n          // V√©rifier si on est dans une balise img existante (peut-√™tre avec un src vide)\n          if (isInImgTag) {\n            // On est dans une balise img mais pas dans src, peut-√™tre que le src est manquant\n            // Ne rien faire, on va le traiter dans l'√©tape suivante\n            continue\n          } else {\n            // L'URL est comme texte pur, la remplacer par une balise img\n            console.log(`[processLogos] üîÑ Remplacement URL texte par balise img √† l'offset ${offset}`)\n            foundTextUrl = true\n            result = result.substring(0, offset) + \n                     `<img alt=\"Logo\" style=\"max-height: 55px; max-width: 140px; object-fit: contain;\" data-logo-var=\"{${key}}\" />` + \n                     result.substring(offset + logoValue.length)\n          }\n        }\n      }\n      \n      if (foundTextUrl) {\n        console.log(`[processLogos] ‚úÖ URLs textuelles remplac√©es par des balises img avec data-logo-var`)\n      }\n    }\n  })\n  \n  // Traiter chaque logo de mani√®re asynchrone\n  // V√©rifier aussi les variantes de noms de variables\n  const allLogoKeys = [...logoKeys, 'organisation_logo']\n  \n  for (const key of allLogoKeys) {\n    const logoValue = variables[key] && String(variables[key]).trim() ? String(variables[key]) : null\n    console.log(`[processLogos] Traitement de ${key}, logoValue:`, logoValue ? `${logoValue.substring(0, 50)}...` : 'null')\n    \n    if (logoValue) {\n      // Remplacer le src des images avec data-logo-var=\"{ecole_logo}\" ou data-logo-var=\"{organization_logo}\"\n      const escapedKey = key.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&')\n      \n      // Chercher toutes les occurrences de data-logo-var avec la variable\n      // Pattern flexible : cherche data-logo-var=\"{ecole_logo}\" n'importe o√π dans la balise img\n      // Essayer plusieurs patterns pour √™tre s√ªr de trouver la balise\n      const patterns = [\n        // Pattern 1: data-logo-var=\"{ecole_logo}\" avec attributs avant et apr√®s\n        `<img([^>]*?)data-logo-var\\\\s*=\\\\s*\"\\\\{${escapedKey}\\\\}\"([^>]*?)>`,\n        // Pattern 2: data-logo-var=\"{ecole_logo}\" avec espace optionnel avant data-logo-var\n        `<img([^>]*?)\\\\s+data-logo-var\\\\s*=\\\\s*\"\\\\{${escapedKey}\\\\}\"([^>]*?)>`,\n        // Pattern 3: data-logo-var=\"{ecole_logo}\" avec attributs dans n'importe quel ordre\n        `<img[^>]*?data-logo-var\\\\s*=\\\\s*\"\\\\{${escapedKey}\\\\}\"[^>]*?>`,\n      ]\n      \n      let found = false\n      for (const pattern of patterns) {\n        const regex = new RegExp(pattern, 'gi')\n        const testMatches = result.match(regex)\n        if (testMatches && testMatches.length > 0) {\n          console.log(`[processLogos] ‚úÖ Pattern trouv√©: ${pattern.substring(0, 80)}...`)\n          console.log(`[processLogos] Nombre de correspondances: ${testMatches.length}`)\n          console.log(`[processLogos] Exemples:`, testMatches.slice(0, 2).map(m => m.substring(0, 150)))\n          found = true\n          break\n        }\n      }\n      \n      if (!found) {\n        console.warn(`[processLogos] ‚ö†Ô∏è Aucune balise logo trouv√©e avec ${key}`)\n        // Chercher si data-logo-var existe dans le HTML\n        if (result.includes('data-logo-var')) {\n          console.warn(`[processLogos] ‚ö†Ô∏è data-logo-var trouv√© dans le HTML mais pattern ne correspond pas`)\n          // Afficher un extrait du HTML contenant data-logo-var\n          const dataLogoVarIndex = result.indexOf('data-logo-var')\n          const excerpt = result.substring(Math.max(0, dataLogoVarIndex - 50), Math.min(result.length, dataLogoVarIndex + 200))\n          console.warn(`[processLogos] Extrait HTML:`, excerpt)\n        }\n      }\n      \n      // Utiliser le pattern le plus simple et flexible\n      // Pattern: <img ... data-logo-var=\"{ecole_logo}\" ... >\n      const regex = new RegExp(`<img([^>]*?)data-logo-var\\\\s*=\\\\s*\"\\\\{${escapedKey}\\\\}\"([^>]*?)>`, 'gi')\n      \n      // Convertir l'URL en base64 pour √©viter les probl√®mes CORS avec Puppeteer\n      let logoSrc = logoValue\n      if (logoValue && (logoValue.includes('supabase.co') || logoValue.startsWith('http'))) {\n        console.log(`[processLogos] Conversion de l'URL en base64 pour ${key}...`)\n        try {\n          const base64Image = await convertImageUrlToBase64(logoValue)\n          if (base64Image) {\n            logoSrc = base64Image\n            console.log(`[processLogos] ‚úÖ Image convertie en base64 avec succ√®s`)\n          } else {\n            console.warn(`[processLogos] ‚ö†Ô∏è √âchec de la conversion en base64, utilisation de l'URL originale`)\n            // Essayer quand m√™me avec l'URL originale, Puppeteer pourra peut-√™tre la charger\n          }\n        } catch (error) {\n          console.error(`[processLogos] ‚ùå Erreur lors de la conversion en base64:`, error)\n          // En cas d'erreur, utiliser l'URL originale\n        }\n      } else {\n        console.log(`[processLogos] URL ne n√©cessite pas de conversion (pas une URL HTTP/Supabase)`)\n      }\n      \n      result = result.replace(\n        regex,\n        (match, before, after) => {\n          console.log(`[processLogos] ‚úÖ Correspondance trouv√©e:`, match.substring(0, 150))\n          \n          // Extraire tous les attributs existants sauf src et data-logo-var\n          const allAttrs = (before + ' ' + after).trim()\n          \n          // Extraire le style existant\n          const styleMatch = match.match(/style\\s*=\\s*\"([^\"]*)\"/)\n          const existingStyle = styleMatch ? styleMatch[1] : ''\n          \n          // Extraire l'alt existant ou utiliser \"Logo\" par d√©faut\n          const altMatch = match.match(/alt\\s*=\\s*\"([^\"]*)\"/)\n          const altValue = altMatch ? altMatch[1] : 'Logo'\n          \n          // Supprimer src et data-logo-var des attributs existants\n          let cleanedAttrs = allAttrs\n            .replace(/\\s+src\\s*=\\s*\"[^\"]*\"/g, '')\n            .replace(/\\s+data-logo-var\\s*=\\s*\"[^\"]*\"/g, '')\n            .trim()\n          \n          // Construire la nouvelle balise img avec le src du logo (base64 ou URL)\n          const newImg = `<img src=\"${logoSrc}\" alt=\"${altValue}\"${cleanedAttrs ? ' ' + cleanedAttrs : ''} style=\"${existingStyle}\">`\n          console.log(`[processLogos] ‚úÖ Remplacement effectu√©:`, newImg.substring(0, 150))\n          return newImg\n        }\n      )\n    } else {\n      console.log(`[processLogos] Pas de logo pour ${key}, masquage de l'image`)\n      // Si pas de logo, masquer l'image\n      const escapedKey = key.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&')\n      result = result.replace(\n        new RegExp(`<img([^>]*?)data-logo-var\\\\s*=\\\\s*\"\\\\{${escapedKey}\\\\}\"([^>]*?)>`, 'gi'),\n        (match, before, after) => {\n          const styleMatch = match.match(/style\\s*=\\s*\"([^\"]*)\"/)\n          const existingStyle = styleMatch ? styleMatch[1] : ''\n          return `<img${before} data-logo-var=\"{${key}}\"${after} style=\"${existingStyle}; display: none;\">`\n        }\n      )\n    }\n  }\n  \n  // Supprimer les occurrences textuelles de l'URL du logo (qui ne sont pas dans un attribut src)\n  // Cela √©vite que l'URL apparaisse comme texte dans le document\n  logoKeys.forEach(key => {\n    const logoValue = variables[key]\n    if (logoValue && typeof logoValue === 'string' && logoValue.trim()) {\n      // √âchapper l'URL pour le regex\n      const escapedUrl = logoValue.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&')\n      \n      // Chercher l'URL qui n'est PAS dans un attribut src d'une balise img\n      // Pattern: URL qui n'est pas pr√©c√©d√©e par src=\" et qui n'est pas dans une balise img avec src\n      const textUrlPattern = new RegExp(`(?!<img[^>]*src\\\\s*=\\\\s*\"[^\"]*${escapedUrl}[^\"]*\"[^>]*>)${escapedUrl}(?![^<]*</img>)`, 'gi')\n      \n      // Remplacer les occurrences textuelles par une cha√Æne vide\n      const beforeRemoval = result\n      result = result.replace(textUrlPattern, (match, offset) => {\n        // V√©rifier le contexte pour s'assurer qu'on n'est pas dans un attribut src\n        const before = result.substring(Math.max(0, offset - 50), offset)\n        const after = result.substring(offset + match.length, Math.min(result.length, offset + match.length + 50))\n        const context = before + match + after\n        \n        // Si on trouve \"src=\" avant l'URL dans le contexte, ne pas supprimer\n        if (context.match(/src\\s*=\\s*\"[^\"]*$/)) {\n          return match\n        }\n        \n        console.log(`[processLogos] üóëÔ∏è Suppression de l'URL texte du logo: ${match.substring(0, 80)}...`)\n        return ''\n      })\n      \n      if (beforeRemoval !== result) {\n        console.log(`[processLogos] ‚úÖ URLs textuelles supprim√©es pour ${key}`)\n      }\n    }\n  })\n  \n  return result\n}\n\n// Fonction pour remplacer les variables dans le HTML\nfunction replaceVariablesInHTML(html: string, variables: Record<string, any>): string {\n  // Note: Les conditionnels sont d√©j√† trait√©s dans generateHTML avant l'appel √† cette fonction\n  let result = html\n  \n  // Traiter les QR codes avec variables dynamiques\n  // Remplacer les images avec classe qr-code-dynamic\n  result = result.replace(/<img([^>]*?)class=\"qr-code-dynamic\"([^>]*?)data-qr-data=\"([^\"]*)\"([^>]*?)>/g, (match, before, middle, data, after) => {\n    let processedData = data\n    Object.entries(variables).forEach(([key, value]) => {\n      const regex = new RegExp(`\\\\{${key}\\\\}`, 'g')\n      processedData = processedData.replace(regex, String(value))\n    })\n    // Extraire la taille depuis le style\n    const sizeMatch = match.match(/max-width:\\s*(\\d+)px/)\n    const size = sizeMatch ? sizeMatch[1] : '200'\n    const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${encodeURIComponent(processedData)}`\n    return `<img${before}${middle}src=\"${qrCodeUrl}\" data-qr-data=\"${processedData}\"${after}>`\n  })\n  \n  // Traiter les codes-barres avec variables dynamiques\n  result = result.replace(/<img([^>]*?)class=\"barcode-dynamic\"([^>]*?)data-barcode-data=\"([^\"]*)\"([^>]*?)data-barcode-type=\"([^\"]*)\"([^>]*?)>/g, (match, before, middle1, data, middle2, type, after) => {\n    let processedData = data\n    Object.entries(variables).forEach(([key, value]) => {\n      const regex = new RegExp(`\\\\{${key}\\\\}`, 'g')\n      processedData = processedData.replace(regex, String(value))\n    })\n    // Extraire la largeur et hauteur depuis le style\n    const widthMatch = match.match(/max-width:\\s*(\\d+)px/)\n    const heightMatch = match.match(/height:\\s*(\\d+)px/)\n    const width = widthMatch ? widthMatch[1] : '200'\n    const height = heightMatch ? heightMatch[1] : '50'\n    const barcodeUrl = `https://barcode.tec-it.com/barcode.ashx?data=${encodeURIComponent(processedData)}&code=${type}&dpi=96&dataseparator=`\n    return `<img${before}${middle1}src=\"${barcodeUrl}\" data-barcode-data=\"${processedData}\"${middle2}data-barcode-type=\"${type}\"${after}>`\n  })\n  \n  // Les logos sont maintenant trait√©s dans processLogos AVANT l'appel √† cette fonction\n  \n  // Remplacer les variables restantes dans le texte\n  // Utiliser un ordre de remplacement pour √©viter les conflits\n  // D'abord les variables longues, puis les courtes\n  // EXCLURE COMPL√àTEMENT les variables de logo car elles sont d√©j√† trait√©es dans processLogos\n  const logoKeys = ['ecole_logo', 'organization_logo', 'organisation_logo']\n  const sortedKeys = Object.keys(variables)\n    .filter(key => !logoKeys.includes(key)) // Exclure les variables de logo\n    .sort((a, b) => b.length - a.length)\n  \n  sortedKeys.forEach((key) => {\n    const value = variables[key]\n    \n    // Remplacer {variable} dans le HTML m√™me si la valeur est null/undefined (remplacer par cha√Æne vide)\n    // Utiliser un pattern qui ne capture que les variables compl√®tes (pas dans les mots)\n    const escapedKey = key.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&')\n    const regex = new RegExp(`\\\\{${escapedKey}\\\\}`, 'g')\n    const replacement = (value === null || value === undefined) \n      ? '' \n      : String(value).replace(/</g, '&lt;').replace(/>/g, '&gt;')\n    \n    // Remplacer toutes les occurrences sauf celles dans data-logo-var\n    result = result.replace(regex, (match, offset) => {\n      // V√©rifier le contexte autour de la correspondance\n      const before = result.substring(Math.max(0, offset - 100), offset)\n      const after = result.substring(offset + match.length, Math.min(result.length, offset + match.length + 100))\n      \n      // Si on trouve \"data-logo-var\" dans le contexte avant ou apr√®s, ne pas remplacer\n      if (before.includes('data-logo-var') || after.includes('data-logo-var')) {\n        return match\n      }\n      \n      return replacement\n    })\n  })\n  \n  // √âtape finale : supprimer toutes les balises {variable} restantes qui n'ont pas √©t√© remplac√©es\n  // Cela garantit qu'aucune balise ne reste dans le document final\n  result = result.replace(/\\{[a-zA-Z_][a-zA-Z0-9_]*\\}/g, (match) => {\n    // V√©rifier si c'est une balise conditionnelle (IF, ELSE, ENDIF)\n    const variableName = match.slice(1, -1)\n    if (variableName === 'IF' || variableName === 'ELSE' || variableName === 'ENDIF') {\n      return match\n    }\n    // Supprimer toutes les autres balises non remplac√©es\n    return ''\n  })\n  \n  // Nettoyer les conditionnels JSX mal form√©s qui pourraient rester\n  // Supprimer les patterns {variable && qui n'ont pas √©t√© trait√©s\n  result = result.replace(/\\{[a-zA-Z_][a-zA-Z0-9_]*\\s+&&\\s+[^}]*\\}/g, '')\n  \n  return result\n}\n\nexport interface HTMLGenerationResult {\n  html: string\n  pageCount: number\n}\n\n/**\n * G√©n√®re un document HTML √† partir d'un template\n */\nexport async function generateHTML(\n  template: DocumentTemplate,\n  variables: DocumentVariables,\n  documentId?: string,\n  organizationId?: string\n): Promise<HTMLGenerationResult> {\n  try {\n    console.log('[HTML Generator] D√©but de la g√©n√©ration HTML')\n    console.log('[HTML Generator] Template:', {\n      id: template.id,\n      type: template.type,\n      name: template.name,\n      hasHeader: !!template.header,\n      headerType: typeof template.header,\n    })\n    \n    // R√©cup√©rer le contenu HTML du template\n  // Le contenu peut √™tre dans content.html ou content.elements[0].content\n  let content = ''\n  if (template.content) {\n    const contentData = template.content as any\n    console.log('[HTML Generator] Template content structure:', {\n      hasHtml: !!contentData.html,\n      htmlLength: contentData.html?.length || 0,\n      hasElements: !!contentData.elements,\n      elementsCount: contentData.elements?.length || 0,\n    })\n    \n    if (contentData.html) {\n      content = contentData.html\n      console.log('[HTML Generator] Using content.html, length:', content.length)\n    } else if (contentData.elements && Array.isArray(contentData.elements) && contentData.elements.length > 0) {\n      // Si le contenu est dans les √©l√©ments, extraire le HTML de chaque √©l√©ment\n      content = contentData.elements\n        .map((el: any) => el.content || '')\n        .filter((c: string) => c && c.trim())\n        .join('\\n')\n      console.log('[HTML Generator] Using content.elements, length:', content.length)\n    }\n  } else {\n    console.warn('[HTML Generator] Template content is null or undefined')\n  }\n  \n  // Si le contenu est toujours vide, utiliser une cha√Æne vide par d√©faut\n  if (!content || content.trim().length === 0) {\n    console.warn('[HTML Generator] Template content is empty after extraction, template:', {\n      id: template.id,\n      type: template.type,\n      name: template.name,\n    })\n    content = ''\n  }\n  \n  // Aplatir les variables imbriqu√©es pour compatibilit√© (n√©cessaire pour g√©n√©rer l'en-t√™te/bas de page)\n  const flattenedVariablesForHeaderFooter = flattenVariables(variables)\n  \n  // R√©cup√©rer le layout global si disponible, sinon utiliser le template sp√©cifique\n  let headerContent = (template.header as any)?.content || ''\n  // FORCER l'utilisation du footer propre avec uniquement les 3 lignes essentielles\n  // Ignorer compl√®tement le footer du template en base de donn√©es pour √©viter le contenu parasit√©\n  let footerContent = `\n    <div style=\"border-top: 1px solid #E5E7EB; padding: 12px 0 8px 0; margin-top: 25px; background-color: #FAFAFA;\">\n      <p style=\"font-size: 9pt; color: #1A1A1A; margin: 0; text-align: center; font-weight: 500; line-height: 1.4;\">\n        {ecole_nom} | {ecole_adresse} {ecole_ville} {ecole_code_postal} | Num√©ro SIRET: {ecole_siret}\n      </p>\n      <p style=\"font-size: 8pt; color: #666; margin: 4px 0 0 0; text-align: center; line-height: 1.3;\">\n        Num√©ro de d√©claration d'activit√©: {ecole_numero_declaration} <em>(aupr√®s du pr√©fet de r√©gion de: {ecole_region})</em>\n      </p>\n      <p style=\"font-size: 8pt; color: #888; font-style: italic; margin: 3px 0 0 0; text-align: center; line-height: 1.3;\">\n        Cet enregistrement ne vaut pas l'agr√©ment de l'√âtat.\n      </p>\n    </div>\n  `\n  \n  let headerEnabled = template.header_enabled ?? true\n  let footerEnabled = template.footer_enabled ?? true\n  let headerHeight = (template.header as any)?.height || template.header_height || 30\n  let footerHeight = (template.footer as any)?.height || template.footer_height || 20\n  // Header uniquement sur la premi√®re page, footer sur toutes les pages\n  let headerRepeatOnAllPages = false\n  let footerRepeatOnAllPages = true\n  \n  // Log pour d√©boguer\n  console.log('[HTML Generator] Header/Footer config:', {\n    headerEnabled,\n    headerContentLength: headerContent.length,\n    headerContent: headerContent.substring(0, 100),\n    footerEnabled,\n    footerContentLength: footerContent.length,\n    footerContent: footerContent.substring(0, 100),\n    templateHeader: template.header,\n    templateFooter: template.footer,\n  })\n  \n  // Note: Le layout global est d√©sactiv√© pour √©viter les erreurs d'import c√¥t√© client\n  // Cette fonctionnalit√© peut √™tre r√©activ√©e si n√©cessaire en cr√©ant une API route d√©di√©e\n  // if (organizationId && typeof window === 'undefined') {\n  //   try {\n  //     const module = await import('@/lib/services/global-document-layout.service')\n  //     const service = module.globalDocumentLayoutService\n  //     const globalLayout = await service.getActiveLayout(organizationId) as any\n  //     if (globalLayout) {\n  //       if (globalLayout.header_enabled && globalLayout.header_content) {\n  //         headerContent = globalLayout.header_content\n  //         headerEnabled = true\n  //         headerHeight = globalLayout.header_height\n  //         if (globalLayout.header_logo_url) {\n  //           headerContent = `<img src=\"${globalLayout.header_logo_url}\" alt=\"Logo\" style=\"max-height: 60px; margin-bottom: 10px;\" />${headerContent}`\n  //         }\n  //         if (globalLayout.header_image_url) {\n  //           headerContent = `${headerContent}<img src=\"${globalLayout.header_image_url}\" alt=\"Header Image\" style=\"max-width: 100%; margin-top: 10px;\" />`\n  //         }\n  //       }\n  //     }\n  //   } catch (error) {\n  //     console.warn('Erreur lors de la r√©cup√©ration du layout global:', error)\n  //   }\n  // }\n\n  // Si l'en-t√™te est vide ou d√©sactiv√© mais qu'on veut un en-t√™te par d√©faut, g√©n√©rer un en-t√™te professionnel\n  if (headerEnabled && (!headerContent || headerContent.trim().length === 0)) {\n    headerContent = generateProfessionalHeader(flattenedVariablesForHeaderFooter)\n    console.log('[HTML Generator] G√©n√©ration automatique de l\\'en-t√™te professionnel')\n  }\n  \n  // DEBUG: Logger le header avant traitement pour voir s'il y a un probl√®me\n  console.log('[HTML Generator] Header avant traitement (premiers 500 chars):', headerContent.substring(0, 500))\n  console.log('[HTML Generator] Header contient tableau?', headerContent.includes('<table'))\n  console.log('[HTML Generator] Header contient {ecole_logo}?', headerContent.includes('{ecole_logo}'))\n\n  // Le footer est d√©j√† d√©fini proprement ci-dessus avec uniquement les 3 lignes essentielles\n  // Pas besoin de g√©n√©rer un footer par d√©faut\n\n  // Aplatir les variables imbriqu√©es pour compatibilit√©\n  const flattenedVariables = flattenVariables(variables)\n\n  // Traiter dans l'ordre : logos -> tableaux dynamiques -> boucles -> conditions -> visibilit√© -> variables calcul√©es -> variables imbriqu√©es -> remplacement de variables\n  let processedHeader = headerContent\n  let processedContent = content\n  let processedFooter = footerContent\n\n  // 0. NETTOYAGE PR√âLIMINAIRE : Remplacer {ecole_logo} et autres variables de logo par des balises img AVANT le traitement\n  // Cela g√®re le cas o√π le header sauvegard√© contient {ecole_logo} comme texte au lieu d'une balise img avec data-logo-var\n  console.log('[HTML Generator] Header initial (premiers 800 chars):', headerContent.substring(0, 800))\n  console.log('[HTML Generator] Header contient {ecole_logo}?', processedHeader.includes('{ecole_logo}'))\n  console.log('[HTML Generator] Header contient URL supabase comme texte?', headerContent.includes('supabase.co') && !headerContent.includes('src=\"'))\n  \n  // Remplacer {ecole_logo}, {organization_logo}, {organisation_logo} par des balises img avec data-logo-var\n  // Seulement si la variable existe et n'est pas vide\n  const logoVariablePatterns = ['ecole_logo', 'organization_logo', 'organisation_logo']\n  logoVariablePatterns.forEach(key => {\n    const pattern = new RegExp(`\\\\{${key}\\\\}`, 'g')\n    if (processedHeader.includes(`{${key}}`)) {\n      const logoValue = flattenedVariables[key]\n      // Si le logo existe et n'est pas vide, cr√©er la balise img\n      if (logoValue && String(logoValue).trim()) {\n        console.log(`[HTML Generator] üîÑ Remplacement de {${key}} par balise img avec data-logo-var`)\n        processedHeader = processedHeader.replace(\n          pattern,\n          `<img alt=\"Logo\" style=\"max-height: 55px; max-width: 140px; object-fit: contain;\" data-logo-var=\"{${key}}\" />`\n        )\n        console.log(`[HTML Generator] ‚úÖ {${key}} remplac√© par balise img`)\n      } else {\n        // Si le logo n'existe pas ou est vide, supprimer la balise {ecole_logo}\n        console.log(`[HTML Generator] ‚ö†Ô∏è {${key}} est vide ou undefined, suppression de la balise`)\n        processedHeader = processedHeader.replace(pattern, '')\n      }\n    }\n  })\n  \n  // Ensuite, remplacer les URLs Supabase qui apparaissent comme texte (si elles existent)\n  console.log('[HTML Generator] Variables disponibles pour logos:', {\n    ecole_logo: flattenedVariables['ecole_logo'] ? `${String(flattenedVariables['ecole_logo']).substring(0, 50)}...` : 'undefined',\n    organization_logo: flattenedVariables['organization_logo'] ? `${String(flattenedVariables['organization_logo']).substring(0, 50)}...` : 'undefined',\n    organisation_logo: flattenedVariables['organisation_logo'] ? `${String(flattenedVariables['organisation_logo']).substring(0, 50)}...` : 'undefined',\n  })\n  \n  const logoUrlPatterns = ['ecole_logo', 'organization_logo', 'organisation_logo'].map(key => {\n    const logoValue = flattenedVariables[key]\n    return logoValue && typeof logoValue === 'string' && logoValue.includes('supabase.co') ? { key, url: logoValue } : null\n  }).filter(Boolean) as Array<{key: string, url: string}>\n  \n  console.log('[HTML Generator] URLs de logo trouv√©es:', logoUrlPatterns.length)\n  \n  logoUrlPatterns.forEach(({ key, url }) => {\n    // Chercher toutes les occurrences de l'URL dans le header (pas dans un attribut src)\n    let searchIndex = 0\n    const urlLength = url.length\n    const replacements: Array<{start: number, end: number, key: string}> = []\n    \n    while ((searchIndex = processedHeader.indexOf(url, searchIndex)) !== -1) {\n      const before = processedHeader.substring(Math.max(0, searchIndex - 300), searchIndex)\n      const after = processedHeader.substring(searchIndex + urlLength, Math.min(processedHeader.length, searchIndex + urlLength + 100))\n      \n      // V√©rifier si on est dans un attribut src=\"...\" ou href=\"...\"\n      const isInSrc = /src\\s*=\\s*\"[^\"]*$/.test(before)\n      const isInHref = /href\\s*=\\s*\"[^\"]*$/.test(before)\n      \n      // Si l'URL n'est PAS dans un attribut src/href, la remplacer par une balise img avec data-logo-var\n      if (!isInSrc && !isInHref) {\n        replacements.push({ start: searchIndex, end: searchIndex + urlLength, key })\n        console.log(`[HTML Generator] üîÑ URL texte d√©tect√©e √† l'offset ${searchIndex}, sera remplac√©e par balise img`)\n      }\n      \n      searchIndex += urlLength\n    }\n    \n    // Remplacer les URLs en ordre inverse (pour √©viter les probl√®mes d'offset)\n    for (let i = replacements.length - 1; i >= 0; i--) {\n      const { start, end, key: logoKey } = replacements[i]\n      // Remplacer l'URL par une balise img avec data-logo-var\n      const imgTag = `<img alt=\"Logo\" style=\"max-height: 55px; max-width: 140px; object-fit: contain;\" data-logo-var=\"{${logoKey}}\" />`\n      processedHeader = processedHeader.substring(0, start) + imgTag + processedHeader.substring(end)\n      console.log(`[HTML Generator] ‚úÖ URL texte remplac√©e par balise img avec data-logo-var=\"{${logoKey}}\"`)\n    }\n    \n    if (replacements.length > 0) {\n      console.log(`[HTML Generator] ‚úÖ ${replacements.length} URL(s) texte remplac√©e(s) par des balises img`)\n    }\n  })\n  \n  // 0.5. Traiter les logos (remplacer data-logo-var par le src de l'image en base64)\n  console.log('[HTML Generator] Traitement des logos - Header avant (premiers 500 chars):', processedHeader.substring(0, 500))\n  console.log('[HTML Generator] Header contient data-logo-var?', processedHeader.includes('data-logo-var'))\n  console.log('[HTML Generator] Header contient URL supabase?', processedHeader.includes('supabase.co'))\n  try {\n    processedHeader = await processLogos(processedHeader, flattenedVariables)\n    console.log('[HTML Generator] Traitement des logos - Header apr√®s (premiers 500 chars):', processedHeader.substring(0, 500))\n    console.log('[HTML Generator] Header apr√®s contient data:image?', processedHeader.includes('data:image'))\n    console.log('[HTML Generator] Header apr√®s contient URL supabase?', processedHeader.includes('supabase.co'))\n  } catch (logoError) {\n    console.error('[HTML Generator] Erreur lors du traitement des logos dans le header:', logoError)\n    // Continuer m√™me si le traitement du logo √©choue\n    if (logoError instanceof Error) {\n      console.error('[HTML Generator] Message:', logoError.message)\n      console.error('[HTML Generator] Stack:', logoError.stack)\n    }\n  }\n  try {\n    processedContent = await processLogos(processedContent, flattenedVariables)\n  } catch (logoError) {\n    console.error('[HTML Generator] Erreur lors du traitement des logos dans le content:', logoError)\n  }\n  try {\n    processedFooter = await processLogos(processedFooter, flattenedVariables)\n  } catch (logoError) {\n    console.error('[HTML Generator] Erreur lors du traitement des logos dans le footer:', logoError)\n  }\n\n  // 1. Traiter les tableaux dynamiques (doit √™tre avant les boucles pour √©viter les conflits)\n  processedHeader = processDynamicTables(processedHeader, flattenedVariables)\n  processedContent = processDynamicTables(processedContent, flattenedVariables)\n  processedFooter = processDynamicTables(processedFooter, flattenedVariables)\n\n  // 2. Traiter les boucles (FOR/WHILE)\n  processedHeader = processLoops(processedHeader, flattenedVariables)\n  processedContent = processLoops(processedContent, flattenedVariables)\n  processedFooter = processLoops(processedFooter, flattenedVariables)\n\n  // 3. Traiter les conditions (IF/ELSE)\n  processedHeader = evaluateConditionalContent(processedHeader, flattenedVariables)\n  processedContent = evaluateConditionalContent(processedContent, flattenedVariables)\n  processedFooter = evaluateConditionalContent(processedFooter, flattenedVariables)\n\n  // 4. Traiter la visibilit√© conditionnelle (SHOW_IF/HIDE_IF)\n  processedHeader = processElementVisibility(processedHeader, flattenedVariables)\n  processedContent = processElementVisibility(processedContent, flattenedVariables)\n  processedFooter = processElementVisibility(processedFooter, flattenedVariables)\n\n  // 5. Traiter les variables calcul√©es (SUM, AVERAGE, etc.)\n  processedHeader = processCalculatedVariables(processedHeader, flattenedVariables)\n  processedContent = processCalculatedVariables(processedContent, flattenedVariables)\n  processedFooter = processCalculatedVariables(processedFooter, flattenedVariables)\n\n  // 6. Traiter les variables imbriqu√©es (object.property, array[index])\n  processedHeader = processNestedVariables(processedHeader, flattenedVariables)\n  processedContent = processNestedVariables(processedContent, flattenedVariables)\n  processedFooter = processNestedVariables(processedFooter, flattenedVariables)\n\n  // 7. Traiter les liens hypertextes dynamiques (LINK, EMAIL, PHONE, SMS)\n  processedHeader = processDynamicHyperlinks(processedHeader, flattenedVariables)\n  processedContent = processDynamicHyperlinks(processedContent, flattenedVariables)\n  processedFooter = processDynamicHyperlinks(processedFooter, flattenedVariables)\n\n  // 8. Traiter les signatures √©lectroniques\n  processedHeader = await processSignatures(processedHeader, flattenedVariables, documentId)\n  processedContent = await processSignatures(processedContent, flattenedVariables, documentId)\n  processedFooter = await processSignatures(processedFooter, flattenedVariables, documentId)\n\n  // 9. Traiter les pi√®ces jointes dynamiques\n  processedHeader = await processAttachments(processedHeader, flattenedVariables, documentId)\n  processedContent = await processAttachments(processedContent, flattenedVariables, documentId)\n  processedFooter = await processAttachments(processedFooter, flattenedVariables, documentId)\n\n  // 10. Remplacer les variables simples\n  processedHeader = replaceVariablesInHTML(processedHeader, flattenedVariables)\n  processedContent = replaceVariablesInHTML(processedContent, flattenedVariables)\n  processedFooter = replaceVariablesInHTML(processedFooter, flattenedVariables)\n  \n  // 10.5. Nettoyage final : supprimer toutes les balises {variable} restantes qui n'ont pas √©t√© remplac√©es\n  // Cela garantit qu'aucune balise ne reste dans le document final\n  const cleanRemainingTags = (html: string): string => {\n    return html.replace(/\\{[a-zA-Z_][a-zA-Z0-9_]*\\}/g, (match) => {\n      // V√©rifier si c'est une balise conditionnelle (IF, ELSE, ENDIF)\n      const variableName = match.slice(1, -1)\n      if (variableName === 'IF' || variableName === 'ELSE' || variableName === 'ENDIF') {\n        return match\n      }\n      // Supprimer toutes les autres balises non remplac√©es\n      return ''\n    })\n  }\n  \n  processedHeader = cleanRemainingTags(processedHeader)\n  processedContent = cleanRemainingTags(processedContent)\n  processedFooter = cleanRemainingTags(processedFooter)\n\n  // 11. Traiter les champs de formulaire interactifs (doit √™tre apr√®s le remplacement des variables)\n  processedHeader = processFormFields(processedHeader, flattenedVariables)\n  processedContent = processFormFields(processedContent, flattenedVariables)\n  processedFooter = processFormFields(processedFooter, flattenedVariables)\n  \n  // 12. FORCER le footer propre : reconstruire syst√©matiquement avec uniquement les 3 lignes essentielles\n  // FAIRE CELA EN DERNIER pour √©viter que tout traitement ult√©rieur n'ajoute du contenu ind√©sirable\n  // Ignorer compl√®tement tout contenu du template ou du globalLayout qui pourrait √™tre parasit√©\n  processedFooter = `\n    <div style=\"padding: 12px 0 8px 0; margin-top: 25px; background-color: #FAFAFA; font-family: 'Times New Roman', Times, serif;\">\n      <p style=\"font-size: 8pt; font-family: 'Times New Roman', Times, serif; color: #1A1A1A; margin: 0; text-align: center; font-weight: 500; line-height: 1.4;\">\n        ${flattenedVariables.ecole_nom || flattenedVariables.organization_name || ''} | ${flattenedVariables.ecole_adresse || flattenedVariables.organization_address || ''} ${flattenedVariables.ecole_ville || ''} ${flattenedVariables.ecole_code_postal || ''} | Num√©ro SIRET: ${flattenedVariables.ecole_siret || ''}\n      </p>\n      <p style=\"font-size: 8pt; font-family: 'Times New Roman', Times, serif; color: #666; margin: 4px 0 0 0; text-align: center; line-height: 1.3;\">\n        Num√©ro de d√©claration d'activit√©: ${flattenedVariables.ecole_numero_declaration || ''} <em>(aupr√®s du pr√©fet de r√©gion de: ${flattenedVariables.ecole_region || ''})</em>\n      </p>\n      <p style=\"font-size: 8pt; font-family: 'Times New Roman', Times, serif; color: #888; font-style: italic; margin: 3px 0 0 0; text-align: center; line-height: 1.3;\">\n        Cet enregistrement ne vaut pas l'agr√©ment de l'√âtat.\n      </p>\n    </div>\n  `\n\n  // Construire le HTML complet avec styles optimis√©s pour PDF\n  const pageSize = (template.content as any)?.pageSize || template.page_size || 'A4'\n  // Marges par d√©faut en mm (15mm = ~0.6 pouces, plus compact pour documents professionnels)\n  const defaultMargins = { top: 15, right: 15, bottom: 15, left: 15 }\n  const margins = template.margins || defaultMargins\n  \n  // S'assurer que toutes les marges sont d√©finies\n  const finalMargins = {\n    top: margins.top ?? defaultMargins.top,\n    right: margins.right ?? defaultMargins.right,\n    bottom: margins.bottom ?? defaultMargins.bottom,\n    left: margins.left ?? defaultMargins.left,\n  }\n  \n  // Convertir les marges en pixels (1mm ‚âà 3.78px √† 96 DPI)\n  const marginTopPx = finalMargins.top * 3.78\n  const marginBottomPx = finalMargins.bottom * 3.78\n  const marginLeftPx = finalMargins.left * 3.78\n  const marginRightPx = finalMargins.right * 3.78\n  \n  // Convertir les hauteurs d'en-t√™te et de pied de page en pixels\n  const headerHeightPx = headerHeight * 3.78\n  const footerHeightPx = footerHeight * 3.78\n  \n  // Dimensions A4 en pixels (210mm x 297mm √† 96 DPI)\n  const pageWidthPx = 794 // 210mm\n  const pageHeightPx = 1123 // 297mm\n  const contentWidthPx = pageWidthPx - marginLeftPx - marginRightPx\n  \n  // Calculer la hauteur disponible pour le contenu\n  // Si le header ne se r√©p√®te pas sur toutes les pages, il n'occupe de l'espace que sur la premi√®re page\n  // Le contenu doit commencer apr√®s le header + marge du haut\n  const contentTopPxFirstPage = headerEnabled ? (marginTopPx + headerHeightPx + 5) : marginTopPx\n  const contentBottomPx = footerEnabled ? (marginBottomPx + footerHeightPx + 5) : marginBottomPx\n  const contentHeightPx = pageHeightPx - contentTopPxFirstPage - contentBottomPx\n  \n  // Log pour d√©boguer\n  console.log('[HTML Generator] Building full HTML:', {\n    hasHeader: headerEnabled && processedHeader.length > 0,\n    headerLength: processedHeader.length,\n    headerHeight,\n    headerHeightPx,\n    hasFooter: footerEnabled && processedFooter.length > 0,\n    footerLength: processedFooter.length,\n    footerHeight,\n    footerHeightPx,\n    margins: finalMargins,\n    marginTopPx,\n    marginBottomPx,\n    marginLeftPx,\n    marginRightPx,\n    pageWidthPx,\n    pageHeightPx,\n    contentWidthPx,\n    contentTopPxFirstPage,\n    contentBottomPx,\n    contentHeightPx,\n    headerRepeatOnAllPages,\n    footerRepeatOnAllPages,\n  })\n  \n    const fullHTML = `\n<!DOCTYPE html>\n<html lang=\"fr\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>${template.name || 'Document'}</title>\n  <script src=\"https://unpkg.com/pagedjs/dist/paged.polyfill.js\"></script>\n  <style>\n    /* Paged.js - D√©finition de la page physique A4 */\n    @page {\n      size: A4;\n      margin-top: ${finalMargins.top}mm;\n      margin-bottom: ${footerEnabled ? footerHeight + 5 : finalMargins.bottom}mm;\n      margin-left: ${finalMargins.left}mm;\n      margin-right: ${finalMargins.right}mm;\n      \n      /* Footer sur toutes les pages */\n      ${footerEnabled ? `@bottom-center {\n        content: element(footerEnv);\n      }` : ''}\n    }\n    @page:first {\n      margin-top: ${headerEnabled ? headerHeight + 5 : finalMargins.top}mm;\n      \n      /* Header uniquement sur la premi√®re page */\n      ${headerEnabled ? `@top-center {\n        content: element(headerEnv);\n      }` : ''}\n      ${footerEnabled ? `@bottom-center {\n        content: element(footerEnv);\n      }` : ''}\n    }\n    \n    /* Style de l'En-t√™te HTML - Extrait du flux normal */\n    ${headerEnabled ? `.document-header {\n      position: running(headerEnv);\n      width: 100%;\n      background: #ffffff;\n      padding: 0;\n      margin: 0;\n      font-size: ${(template.font_size || 10) * 0.85}pt;\n      line-height: 1.2;\n    }` : ''}\n    \n    /* Style du Pied de page HTML - Extrait du flux normal */\n    ${footerEnabled ? `.document-footer {\n      position: running(footerEnv);\n      width: 100%;\n      background: #ffffff;\n      padding: 5px 0;\n      margin: 0;\n      font-size: ${(template.font_size || 10) * 0.85}pt;\n      line-height: 1.2;\n      text-align: center;\n      border-top: 1px solid #E5E7EB;\n    }` : ''}\n    \n    /* Le contenu principal - Plus besoin de marges bizarres */\n    .document-content {\n      font-family: 'Arial', sans-serif;\n      line-height: 1.5;\n      padding: 0;\n      margin: 0;\n    }\n    \n    /* Styles existants */\n    * {\n      box-sizing: border-box;\n      -webkit-print-color-adjust: exact;\n      print-color-adjust: exact;\n      color-adjust: exact;\n    }\n    html, body {\n      margin: 0;\n      padding: 0;\n      width: ${pageWidthPx}px;\n      height: auto;\n    }\n    body {\n      font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif;\n      font-size: ${template.font_size || 10}pt;\n      line-height: 1.4;\n      color: #000;\n      background: #ffffff;\n      min-height: ${pageHeightPx}px;\n    }\n    .document-container {\n      width: ${pageWidthPx}px !important;\n      min-height: ${pageHeightPx}px !important;\n      height: auto !important;\n      background: #ffffff !important;\n      position: relative !important;\n      box-sizing: border-box !important;\n      margin: 0 !important;\n      padding: 0 !important;\n      overflow: visible !important;\n    }\n    .header * {\n      max-height: ${headerHeightPx - 10}px !important;\n      overflow: visible !important;\n    }\n    .header img {\n      max-height: ${headerHeightPx * 0.6}px !important;\n      width: auto !important;\n    }\n    /* Note: Le header sera visible uniquement sur la premi√®re page lors de la g√©n√©ration PDF\n       si repeatOnAllPages est false, car html2canvas capture le document en une seule fois */\n    .content {\n      position: relative !important;\n      top: auto !important;\n      bottom: auto !important;\n      left: ${marginLeftPx}px !important;\n      right: ${marginRightPx}px !important;\n      width: calc(100% - ${marginLeftPx + marginRightPx}px) !important;\n      min-height: ${contentHeightPx}px !important;\n      max-height: none !important;\n      background: #ffffff !important;\n      overflow: visible !important;\n      padding: 10px 0 ${footerEnabled ? (footerHeightPx + marginBottomPx + 20) : 20}px 0 !important;\n      margin: ${headerEnabled ? (headerHeightPx + marginTopPx + 5) : marginTopPx}px 0 0 0 !important;\n      z-index: 1 !important;\n    }\n    .footer * {\n      max-height: ${footerHeightPx - 10}px !important;\n      overflow: visible !important;\n    }\n    .footer img {\n      max-height: ${footerHeightPx * 0.6}px !important;\n      width: auto !important;\n    }\n    /* Styles pour les tableaux */\n    table {\n      width: 100%;\n      border-collapse: collapse;\n      margin: 6px 0;\n      table-layout: auto;\n      border-spacing: 0;\n      font-size: ${(template.font_size || 10) * 0.9}pt;\n    }\n    table th, table td {\n      border: 1px solid #ddd;\n      padding: 4px 6px;\n      text-align: left;\n      word-wrap: break-word;\n      overflow-wrap: break-word;\n      vertical-align: top;\n    }\n    table th {\n      background-color: #f3f4f6;\n      font-weight: bold;\n      font-size: ${(template.font_size || 10) * 0.9}pt;\n    }\n    /* Images */\n    img {\n      max-width: 100%;\n      height: auto;\n      display: block;\n      image-rendering: -webkit-optimize-contrast;\n      image-rendering: crisp-edges;\n    }\n    /* Pr√©server les flexbox */\n    [style*=\"display: flex\"], [style*=\"display:flex\"] {\n      display: flex !important;\n    }\n    /* Pr√©server les gradients et couleurs */\n    [style*=\"gradient\"], [style*=\"background\"] {\n      -webkit-print-color-adjust: exact !important;\n      print-color-adjust: exact !important;\n      color-adjust: exact !important;\n    }\n    /* Assurer que les bordures sont visibles */\n    [style*=\"border\"] {\n      border-style: solid !important;\n    }\n    /* Pr√©server les espacements */\n    p, div, span {\n      margin: 0;\n      padding: 0;\n    }\n    p {\n      margin-bottom: 0.5em;\n      font-size: ${template.font_size || 10}pt;\n      line-height: 1.4;\n    }\n    h1 {\n      font-size: ${(template.font_size || 10) * 1.6}pt;\n      line-height: 1.3;\n      margin-bottom: 8px;\n      margin-top: 12px;\n    }\n    h2 {\n      font-size: ${(template.font_size || 10) * 1.4}pt;\n      line-height: 1.3;\n      margin-bottom: 6px;\n      margin-top: 10px;\n    }\n    h3 {\n      font-size: ${(template.font_size || 10) * 1.2}pt;\n      line-height: 1.3;\n      margin-bottom: 4px;\n      margin-top: 8px;\n    }\n    /* R√©duire les espacements g√©n√©raux */\n    .header {\n      margin-bottom: 12px !important;\n    }\n    .footer {\n      padding-top: 12px !important;\n    }\n    /* Header uniquement sur la premi√®re page si repeatOnAllPages est false */\n    .header-first-page-only {\n      display: block !important;\n    }\n    /* Footer toujours visible sur toutes les pages */\n    .footer {\n      display: block !important;\n    }\n  </style>\n</head>\n<body>\n  ${headerEnabled ? `<header class=\"document-header\">${processedHeader}</header>` : ''}\n  ${footerEnabled && processedFooter ? `<footer class=\"document-footer\">${processedFooter}</footer>` : ''}\n  <main class=\"document-content\">\n    ${processedContent}\n  </main>\n  <script>\n    // Attendre que Paged.js ait fini le calcul du rendu\n    if (typeof window !== 'undefined' && window.PagedPolyfill) {\n      window.addEventListener('pagedjsReady', function() {\n        window.pagedjs_finished = true;\n      });\n    }\n  </script>\n</body>\n</html>\n  `.trim()\n\n    // Estimer le nombre de pages (approximatif)\n    const pageCount = Math.max(1, Math.ceil(processedContent.length / 3000))\n\n    console.log('[HTML Generator] ‚úÖ G√©n√©ration HTML r√©ussie, longueur:', fullHTML.length, 'pages estim√©es:', pageCount)\n\n    return {\n      html: fullHTML,\n      pageCount,\n    }\n  } catch (error) {\n    console.error('[HTML Generator] ‚ùå ERREUR lors de la g√©n√©ration HTML:', error)\n    if (error instanceof Error) {\n      console.error('[HTML Generator] Message:', error.message)\n      console.error('[HTML Generator] Stack:', error.stack)\n      console.error('[HTML Generator] Name:', error.name)\n    }\n    // Logger aussi le template et les variables pour d√©boguer\n    console.error('[HTML Generator] Template info:', {\n      id: template?.id,\n      type: template?.type,\n      name: template?.name,\n      headerLength: template?.header ? (typeof (template.header as any) === 'string' ? (template.header as any).length : JSON.stringify(template.header as any).length) : 0,\n    })\n    console.error('[HTML Generator] Variables keys:', Object.keys(variables || {}).slice(0, 20))\n    throw error\n  }\n}\n\n\n\n"],"names":[],"mappings":"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"}