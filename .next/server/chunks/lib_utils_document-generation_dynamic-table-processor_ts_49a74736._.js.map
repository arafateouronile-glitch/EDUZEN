{"version":3,"sources":["../../../lib/utils/document-generation/dynamic-table-processor.ts"],"sourcesContent":["/**\n * Traitement des tableaux dynamiques dans les templates\n * Permet de générer des tableaux à partir de données structurées\n */\n\n/**\n * Traite les tableaux dynamiques dans le contenu HTML\n * Remplace les patterns de tableaux dynamiques par du HTML généré\n */\nexport function processDynamicTables(\n  html: string,\n  variables: Record<string, any>\n): string {\n  let result = html\n\n  // Pattern pour les tableaux dynamiques : {{#table variable_name}}\n  // Exemple : {{#table facture_items}}\n  const tablePattern = /\\{\\{#table\\s+(\\w+)\\}\\}([\\s\\S]*?)\\{\\{\\/table\\}\\}/g\n\n  result = result.replace(tablePattern, (match, variableName, tableTemplate) => {\n    const tableData = variables[variableName]\n\n    // Si la variable n'existe pas ou n'est pas un tableau, retourner le template vide\n    if (!tableData || !Array.isArray(tableData)) {\n      return ''\n    }\n\n    // Si c'est une chaîne JSON, parser\n    let items: any[] = []\n    if (typeof tableData === 'string') {\n      try {\n        items = JSON.parse(tableData)\n      } catch {\n        return ''\n      }\n    } else {\n      items = tableData\n    }\n\n    // Générer les lignes du tableau\n    const rows = items.map((item, index) => {\n      let row = tableTemplate\n\n      // Remplacer les variables dans le template de ligne\n      // Support pour {variable} et {item.variable}\n      Object.keys(item).forEach((key) => {\n        const value = item[key] !== null && item[key] !== undefined ? String(item[key]) : ''\n        const regex = new RegExp(`\\\\{${key}\\\\}`, 'g')\n        row = row.replace(regex, value)\n        // Support pour {item.variable}\n        const itemRegex = new RegExp(`\\\\{item\\\\.${key}\\\\}`, 'g')\n        row = row.replace(itemRegex, value)\n      })\n\n      // Variables spéciales\n      row = row.replace(/\\{index\\}/g, String(index + 1))\n      row = row.replace(/\\{row_number\\}/g, String(index + 1))\n\n      return row\n    }).join('')\n\n    return rows\n  })\n\n  // Pattern pour les tableaux simples avec boucle inline\n  // Exemple : {{#each facture_items}}<tr><td>{description}</td></tr>{{/each}}\n  const eachPattern = /\\{\\{#each\\s+(\\w+)\\}\\}([\\s\\S]*?)\\{\\{\\/each\\}\\}/g\n\n  result = result.replace(eachPattern, (match, variableName, itemTemplate) => {\n    const arrayData = variables[variableName]\n\n    if (!arrayData || !Array.isArray(arrayData)) {\n      return ''\n    }\n\n    let items: any[] = []\n    if (typeof arrayData === 'string') {\n      try {\n        items = JSON.parse(arrayData)\n      } catch {\n        return ''\n      }\n    } else {\n      items = arrayData\n    }\n\n    const rows = items.map((item, index) => {\n      let row = itemTemplate\n\n      // Remplacer les variables dans le template\n      if (typeof item === 'object' && item !== null) {\n        Object.keys(item).forEach((key) => {\n          const value = item[key] !== null && item[key] !== undefined ? String(item[key]) : ''\n          const regex = new RegExp(`\\\\{${key}\\\\}`, 'g')\n          row = row.replace(regex, value)\n        })\n      } else {\n        // Si l'item est une valeur simple, remplacer {this} ou {.}\n        row = row.replace(/\\{this\\}/g, String(item))\n        row = row.replace(/\\{\\.\\}/g, String(item))\n      }\n\n      row = row.replace(/\\{index\\}/g, String(index))\n      row = row.replace(/\\{@index\\}/g, String(index))\n\n      return row\n    }).join('')\n\n    return rows\n  })\n\n  return result\n}\n"],"names":[],"mappings":"wCASO,SAAS,EACd,CAAY,CACZ,CAA8B,EAE9B,IAAI,EAAS,QAuDJ,CAjDT,EAAS,EAAO,OAAO,CAFF,AAEG,mDAAc,CAAC,EAAO,EAAc,KAC1D,IAAM,EAAY,CAAS,CAAC,EAAa,CAGzC,GAAI,CAAC,GAAa,CAAC,MAAM,OAAO,CAAC,GAC/B,MAAO,GADoC,AAK7C,IAAI,EAAe,EAAE,CACrB,GAAyB,UAArB,AAA+B,OAAxB,EACT,GAAI,CACF,EAAQ,KAAK,KAAK,CAAC,EACrB,CAAE,KAAM,CACN,MAAO,EACT,MAEA,EAAQ,EAyBV,OArBa,AAqBN,EArBY,GAAG,CAAC,CAAC,EAAM,KAC5B,IAAI,EAAM,EAiBV,OAbA,AAaO,OAbA,IAAI,CAAC,GAAM,OAAO,CAAC,AAAC,IACzB,IAAM,EAAsB,OAAd,CAAI,CAAC,EAAI,OAA2B,IAAd,CAAI,CAAC,EAAI,CAAiB,OAAO,CAAI,CAAC,EAAI,EAAI,GAC5E,EAAQ,AAAI,OAAO,CAAC,GAAG,EAAE,EAAI,GAAG,CAAC,CAAE,KACzC,EAAM,EAAI,OAAO,CAAC,EAAO,GAEzB,IAAM,EAAY,AAAI,OAAO,CAAC,UAAU,EAAE,EAAI,GAAG,CAAC,CAAE,KACpD,EAAM,EAAI,OAAO,CAAC,EAAW,EAC/B,GAIA,EAAM,CADN,EAAM,EAAI,OAAO,CAAC,aAAc,OAAO,EAAQ,GAAA,EACrC,OAAO,CAAC,kBAAmB,OAAO,EAAQ,GAGtD,GAAG,IAAI,CAAC,GAGV,EAAA,EAMgB,OAAO,CAFH,AAEI,iDAAa,CAAC,EAAO,EAAc,KACzD,IAAM,EAAY,CAAS,CAAC,EAAa,CAEzC,GAAI,CAAC,GAAa,CAAC,MAAM,OAAO,CAAC,GAC/B,MAAO,GADoC,AAI7C,IAAI,EAAe,EAAE,CACrB,GAAyB,UAAU,AAA/B,OAAO,EACT,GAAI,CACF,EAAQ,KAAK,KAAK,CAAC,EACrB,CAAE,KAAM,CACN,MAAO,EACT,MAEA,EAAQ,EAyBV,OAtBa,AAsBN,EAtBY,GAAG,CAAC,CAAC,EAAM,KAC5B,IAAI,EAAM,EAkBV,MAfoB,AAAhB,CAeG,gBAfI,GAA8B,MAAM,CAAf,EAC9B,OAAO,IAAI,CAAC,GAAM,OAAO,CAAC,AAAC,IACzB,IAAM,EAAsB,OAAd,CAAI,CAAC,EAAI,EAAa,KAAc,KAAV,CAAC,EAAI,CAAiB,OAAO,CAAI,CAAC,EAAI,EAAI,GAC5E,EAAY,AAAJ,OAAW,CAAC,GAAG,EAAE,EAAI,GAAG,CAAC,CAAE,KACzC,EAAM,EAAI,OAAO,CAAC,EAAO,EAC3B,GAIA,EAAM,CADN,EAAM,EAAI,OAAO,CAAC,YAAa,OAAO,GAAA,EAC5B,OAAO,CAAC,UAAW,OAAO,IAItC,EAAM,AADN,GAAM,EAAI,OAAO,CAAC,aAAc,OAAO,GAAA,EAC7B,OAAO,CAAC,cAAe,OAAO,GAG1C,GAAG,IAAI,CAAC,GAGV,EAGF"}