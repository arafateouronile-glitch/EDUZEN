module.exports=[997953,(e,t,r)=>{"use strict";t.exports=e.r(442315).vendored["react-rsc"].ReactServerDOMTurbopackServer},458515,e=>{"use strict";e.s(["createClient",()=>t]);let t=(0,e.i(997953).registerClientReference)(function(){throw Error("Attempted to call createClient() from the server but createClient is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/supabase/client.ts <module evaluation>","createClient")},565963,e=>{"use strict";e.s(["createClient",()=>t]);let t=(0,e.i(997953).registerClientReference)(function(){throw Error("Attempted to call createClient() from the server but createClient is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/supabase/client.ts","createClient")},703755,e=>{"use strict";e.i(458515);var t=e.i(565963);e.n(t)},61356,652931,e=>{"use strict";var t,r,n=e.i(981838),a=((t={}).AUTH_REQUIRED="AUTH_1001",t.AUTH_INVALID_CREDENTIALS="AUTH_1002",t.AUTH_SESSION_EXPIRED="AUTH_1003",t.AUTH_INSUFFICIENT_PERMISSIONS="AUTH_1004",t.AUTH_2FA_REQUIRED="AUTH_1005",t.AUTH_2FA_INVALID="AUTH_1006",t.VALIDATION_ERROR="VALID_2001",t.VALIDATION_REQUIRED_FIELD="VALID_2002",t.VALIDATION_INVALID_FORMAT="VALID_2003",t.VALIDATION_UNIQUE_CONSTRAINT="VALID_2004",t.DB_CONNECTION_ERROR="DB_3001",t.DB_QUERY_ERROR="DB_3002",t.DB_NOT_FOUND="DB_3003",t.DB_CONSTRAINT_VIOLATION="DB_3004",t.DB_FOREIGN_KEY_CONSTRAINT="DB_3006",t.DB_RLS_POLICY_VIOLATION="DB_3005",t.NETWORK_ERROR="NET_4001",t.API_TIMEOUT="NET_4002",t.API_RATE_LIMIT="NET_4003",t.API_SERVER_ERROR="NET_4004",t.API_NOT_FOUND="NET_4005",t.API_BAD_REQUEST="NET_4006",t.BUSINESS_LOGIC_ERROR="BIZ_5001",t.RESOURCE_LOCKED="BIZ_5002",t.OPERATION_NOT_ALLOWED="BIZ_5003",t.QUOTA_EXCEEDED="BIZ_5004",t.INTERNAL_ERROR="SYS_6001",t.CONFIGURATION_ERROR="SYS_6002",t.SERVICE_UNAVAILABLE="SYS_6003",t);(r={}).LOW="low",r.MEDIUM="medium",r.HIGH="high",r.CRITICAL="critical";class i extends Error{code;severity;userMessage;retryable;context;originalError;constructor(e,t="SYS_6001",r="medium",n={},a){super(e),this.name="AppError",this.code=t,this.severity=r,this.userMessage=n.userMessage||this.getDefaultUserMessage(t),this.retryable=n.retryable??this.isRetryable(t),this.context={...n,code:t,severity:r,timestamp:new Date().toISOString()},this.originalError=a,Error.captureStackTrace&&Error.captureStackTrace(this,i)}getDefaultUserMessage(e){return({AUTH_1001:"Vous devez être connecté pour effectuer cette action.",AUTH_1002:"Email ou mot de passe incorrect.",AUTH_1003:"Votre session a expiré. Veuillez vous reconnecter.",AUTH_1004:"Vous n'avez pas les permissions nécessaires.",AUTH_1005:"Authentification à deux facteurs requise.",AUTH_1006:"Code d'authentification invalide.",VALID_2001:"Les données fournies ne sont pas valides.",VALID_2002:"Certains champs obligatoires sont manquants.",VALID_2003:"Le format des données est incorrect.",VALID_2004:"Cette valeur existe déjà.",DB_3001:"Impossible de se connecter à la base de données.",DB_3002:"Erreur lors de l'exécution de la requête.",DB_3003:"Ressource introuvable.",DB_3004:"Cette opération viole une contrainte de la base de données.",DB_3006:"Cette opération viole une contrainte de clé étrangère.",DB_3005:"Vous n'avez pas accès à cette ressource.",NET_4001:"Erreur de connexion réseau. Vérifiez votre connexion internet.",NET_4002:"La requête a pris trop de temps. Veuillez réessayer.",NET_4003:"Trop de requêtes. Veuillez patienter quelques instants.",NET_4004:"Erreur serveur. Veuillez réessayer plus tard.",NET_4005:"Ressource introuvable.",NET_4006:"Requête invalide.",BIZ_5001:"Cette opération n'est pas autorisée dans le contexte actuel.",BIZ_5002:"Cette ressource est actuellement verrouillée.",BIZ_5003:"Cette opération n'est pas autorisée.",BIZ_5004:"Vous avez atteint la limite autorisée.",SYS_6001:"Une erreur interne est survenue. Veuillez réessayer.",SYS_6002:"Erreur de configuration du système.",SYS_6003:"Service temporairement indisponible."})[e]||"Une erreur inattendue est survenue."}isRetryable(e){return["NET_4001","NET_4002","NET_4004","DB_3001","SYS_6003"].includes(e)}toJSON(){return{name:this.name,message:this.message,code:this.code,severity:this.severity,userMessage:this.userMessage,retryable:this.retryable,context:this.context,stack:this.stack,originalError:this.originalError instanceof Error?{name:this.originalError.name,message:this.originalError.message,stack:this.originalError.stack}:this.originalError}}}let s=new class{handleError(e,t={}){if(e instanceof i)return this.logError(e),e;if(e instanceof Error)return this.handleStandardError(e,t);if(this.isSupabaseError(e))return this.handleSupabaseError(e,t);let r=new i("Une erreur inattendue est survenue.","SYS_6001","high",t,e);return this.logError(r),r}handleStandardError(e,t){let r=e.message.toLowerCase(),n="SYS_6001",a="medium";r.includes("network")||r.includes("fetch")?(n="NET_4001",a="medium"):r.includes("timeout")?(n="NET_4002",a="medium"):r.includes("unauthorized")||r.includes("401")?(n="AUTH_1001",a="high"):r.includes("forbidden")||r.includes("403")?(n="AUTH_1004",a="high"):r.includes("not found")||r.includes("404")?(n="DB_3003",a="low"):(r.includes("validation")||r.includes("invalid"))&&(n="VALID_2001",a="low");let s=new i(e.message,n,a,t,e);return this.logError(s),s}handleSupabaseError(e,t){let r=e.code||e.status,n=e.message||"Erreur Supabase",a=t.code||"DB_3002",s="medium";if(!t.code)switch(r){case"PGRST116":case"42P01":a="DB_3003",s="low";break;case"42501":a="DB_3005",s="high";break;case"23505":a="VALID_2004",s="low";break;case"23503":a="DB_3004",s="medium";break;case"PGRST301":case"400":a="NET_4006",s="low";break;case"401":a="AUTH_1001",s="high";break;case"403":a="AUTH_1004",s="high";break;case"404":a="NET_4005",s="low";break;case"500":a="NET_4004",s="high"}"DB_3006"===a&&(s="medium");let o=new i(n,a,s,t,e);return this.logError(o),o}isSupabaseError(e){return e&&(e.code||e.status||e.message)&&("string"==typeof e.code||"number"==typeof e.status)}logError(e){let t={...e.context,code:e.code,severity:e.severity,retryable:e.retryable};switch(e.severity){case"critical":case"high":n.logger.error(e.message,e.originalError||e,t);break;case"medium":n.logger.warn(e.message,t);break;case"low":n.logger.info(`Error: ${e.message}`,t)}}createValidationError(e,t){return new i(e,"VALID_2001","low",{field:t,userMessage:e})}createAuthError(e,t){return new i(t||"Erreur d'authentification",e,"high")}createDatabaseError(e,t){return new i(e,"DB_3002","medium",{},t)}createNotFoundError(e,t){return new i(e,"DB_3003","low",t)}};e.s(["AppError",()=>i,"ErrorCode",()=>a,"errorHandler",0,s],652931),e.s([],61356)},543093,e=>{"use strict";var t=e.i(703755);e.i(61356);var r=e.i(652931),n=e.i(981838);let a=new class{supabase;constructor(e){this.supabase=e||(0,t.createClient)()}async getSignaturesByDocument(e){try{let{data:t,error:r}=await this.supabase.from("document_signatures").select(`
          *,
          signer:users!document_signatures_signer_id_fkey(id, full_name, email, role)
        `).eq("document_id",e).eq("status","signed").order("signed_at",{ascending:!0});if(r)throw r;return t||[]}catch(t){if(t instanceof r.AppError)throw t;throw r.errorHandler.handleError(t,{operation:"getSignaturesByDocument",documentId:e})}}async getSignatureById(e){try{let{data:t,error:n}=await this.supabase.from("document_signatures").select(`
          *,
          signer:users!document_signatures_signer_id_fkey(id, full_name, email, role),
          document:documents(id, title, organization_id)
        `).eq("id",e).single();if(n){if("PGRST116"===n.code)throw r.errorHandler.createNotFoundError(`Signature avec l'ID ${e} introuvable`,{signatureId:e});throw n}return t}catch(t){if(t instanceof r.AppError)throw t;throw r.errorHandler.handleError(t,{operation:"getSignatureById",signatureId:e})}}async getSignaturesByUser(e,t){try{let{data:r,error:n}=await this.supabase.from("document_signatures").select(`
          *,
          document:documents(id, title, type, organization_id)
        `).eq("signer_id",e).eq("organization_id",t).order("signed_at",{ascending:!1});if(n)throw n;return r||[]}catch(n){if(n instanceof r.AppError)throw n;throw r.errorHandler.handleError(n,{operation:"getSignaturesByUser",userId:e,organizationId:t})}}async getSignaturesBySession(e,t){try{let{data:r,error:n}=await this.supabase.from("enrollments").select("student_id").eq("session_id",e).in("status",["confirmed","completed","active"]);if(n)throw n;if(!r||0===r.length)return[];let a=r.map(e=>e.student_id).filter(Boolean),{data:i,error:s}=await this.supabase.from("documents").select("id").eq("organization_id",t).in("student_id",a);if(s)throw s;if(!i||0===i.length)return[];let o=i.map(e=>e.id),{data:d,error:u}=await this.supabase.from("document_signatures").select(`
          *,
          signer:users!document_signatures_signer_id_fkey(id, full_name, email, role),
          document:documents(id, title, type, student_id, students(id, first_name, last_name))
        `).in("document_id",o).eq("organization_id",t).order("signed_at",{ascending:!1});if(u)throw u;return d||[]}catch(n){if(n instanceof r.AppError)throw n;throw r.errorHandler.handleError(n,{operation:"getSignaturesBySession",sessionId:e,organizationId:t})}}async createSignature(e){try{let{data:t}=await this.supabase.auth.getUser();if(!t.user)throw r.errorHandler.createAuthError(r.ErrorCode.AUTH_REQUIRED,"Utilisateur non authentifié");let a=this.generateValidationCode(),i={document_id:e.documentId,organization_id:e.organizationId,signer_id:e.signerId,signature_data:e.signatureData,signature_type:e.signatureType||"handwritten",signer_name:e.signerName||t.user.user_metadata?.full_name||"Utilisateur",signer_email:e.signerEmail||t.user.email||null,signer_role:e.signerRole||null,position_x:e.positionX||null,position_y:e.positionY||null,width:e.width||200,height:e.height||80,page_number:e.pageNumber||1,status:"signed",is_valid:!0,validation_code:a,comment:e.comment||null,ip_address:null,user_agent:null},{data:s,error:o}=await this.supabase.from("document_signatures").insert(i).select(`
          *,
          signer:users!document_signatures_signer_id_fkey(id, full_name, email, role)
        `).single();if(o)throw o;return n.logger.info("Signature créée",{signatureId:s.id,documentId:e.documentId,signerId:e.signerId}),s}catch(t){if(t instanceof r.AppError)throw t;throw r.errorHandler.handleError(t,{operation:"createSignature",documentId:e.documentId,signerId:e.signerId})}}async updateSignature(e,t){try{let{data:n,error:a}=await this.supabase.from("document_signatures").update(t).eq("id",e).select().single();if(a){if("PGRST116"===a.code)throw r.errorHandler.createNotFoundError(`Signature avec l'ID ${e} introuvable`,{signatureId:e});throw a}return n}catch(t){if(t instanceof r.AppError)throw t;throw r.errorHandler.handleError(t,{operation:"updateSignature",signatureId:e})}}async revokeSignature(e,t){try{return this.updateSignature(e,{status:"revoked",is_valid:!1,comment:t||"Signature révoquée"})}catch(t){if(t instanceof r.AppError)throw t;throw r.errorHandler.handleError(t,{operation:"revokeSignature",signatureId:e})}}async deleteSignature(e){try{let{error:t}=await this.supabase.from("document_signatures").delete().eq("id",e);if(t)throw t;n.logger.info("Signature supprimée",{signatureId:e})}catch(t){if(t instanceof r.AppError)throw t;throw r.errorHandler.handleError(t,{operation:"deleteSignature",signatureId:e})}}async hasSignatures(e){try{let{count:t,error:r}=await this.supabase.from("document_signatures").select("*",{count:"exact",head:!0}).eq("document_id",e).eq("status","signed");if(r)throw r;return(t||0)>0}catch(t){if(t instanceof r.AppError)throw t;throw r.errorHandler.handleError(t,{operation:"hasSignatures",documentId:e})}}generateValidationCode(){let e=Date.now(),t=Math.random().toString(36).substring(2,15);return`${e}-${t}`}async validateSignature(e,t){try{let r=await this.getSignatureById(e);return r.validation_code===t&&!0===r.is_valid}catch(e){return!1}}};e.s(["signatureService",0,a])},83614,e=>{"use strict";var t=e.i(543093),r=e.i(981838),n=e.i(89660);class a{async processWebhookEvent(e){try{switch(r.logger.info("Traitement du webhook de signature",{provider:e.provider,eventType:e.eventType,signatureId:(0,r.maskId)(e.signatureId),documentId:(0,r.maskId)(e.documentId)}),e.eventType){case"signature.created":case"signature.pending":return await this.handleSignaturePending(e);case"signature.signed":return await this.handleSignatureSigned(e);case"signature.completed":return await this.handleSignatureCompleted(e);case"signature.declined":return await this.handleSignatureDeclined(e);case"signature.expired":return await this.handleSignatureExpired(e);case"signature.canceled":return await this.handleSignatureCanceled(e);case"document.sent":case"document.opened":case"document.downloaded":return await this.handleDocumentEvent(e);default:return r.logger.warn("Type d'événement webhook non géré",{eventType:e.eventType,provider:e.provider}),{success:!0,message:`\xc9v\xe9nement ${e.eventType} enregistr\xe9 mais non trait\xe9`}}}catch(t){throw r.logger.error("Erreur lors du traitement du webhook",t instanceof Error?t:Error(String(t)),{provider:e.provider,eventType:e.eventType,signatureId:(0,r.maskId)(e.signatureId)}),t}}async handleSignaturePending(e){if(e.documentId&&e.signerEmail){let t=await (0,n.createClient)(),{data:a}=await t.from("document_signatures").select("id").eq("document_id",e.documentId).eq("signer_email",e.signerEmail).eq("status","pending").limit(1);if(a&&a.length>0)return{success:!0,message:"Signature en attente déjà enregistrée",signatureId:a[0].id,documentId:e.documentId};r.logger.info("Signature en attente créée",{documentId:(0,r.maskId)(e.documentId),signerEmail:e.signerEmail})}return{success:!0,message:"Événement de signature en attente traité",documentId:e.documentId,action:"pending_recorded"}}async handleSignatureSigned(e){if(!e.documentId)throw Error("documentId manquant dans l'événement signature.signed");let a=await (0,n.createClient)(),{data:i}=await a.from("document_signatures").select("*").eq("document_id",e.documentId).or(`signer_email.eq.${e.signerEmail},validation_code.eq.${e.signatureId}`).limit(1);if(i&&i.length>0){let n=i[0];return await t.signatureService.updateSignature(n.id,{status:"signed",is_valid:!0,signed_at:e.signedAt?new Date(e.signedAt).toISOString():new Date().toISOString()}),r.logger.info("Signature mise à jour comme signée",{signatureId:(0,r.maskId)(n.id),documentId:(0,r.maskId)(e.documentId)}),{success:!0,message:"Signature enregistrée comme signée",signatureId:n.id,documentId:e.documentId,action:"signature_signed"}}return r.logger.warn("Aucune signature correspondante trouvée pour l'événement signed",{documentId:(0,r.maskId)(e.documentId),signerEmail:e.signerEmail}),{success:!0,message:"Événement enregistré mais aucune signature correspondante",documentId:e.documentId}}async handleSignatureCompleted(e){if(!e.documentId)throw Error("documentId manquant dans l'événement signature.completed");let t=await (0,n.createClient)(),{error:a}=await t.from("documents").update({status:"signed",signed_at:new Date().toISOString()}).eq("id",e.documentId);a&&r.logger.error("Erreur lors de la mise à jour du document",a,{documentId:(0,r.maskId)(e.documentId)});let{error:i}=await t.from("document_signatures").update({status:"signed"}).eq("document_id",e.documentId).in("status",["pending","processing"]);return i&&r.logger.error("Erreur lors de la mise à jour des signatures",i,{documentId:(0,r.maskId)(e.documentId)}),r.logger.info("Document marqué comme complètement signé",{documentId:(0,r.maskId)(e.documentId)}),{success:!0,message:"Document complètement signé",documentId:e.documentId,action:"document_completed"}}async handleSignatureDeclined(e){if(!e.documentId)throw Error("documentId manquant dans l'événement signature.declined");let a=await (0,n.createClient)(),{data:i}=await a.from("document_signatures").select("id").eq("document_id",e.documentId).eq("signer_email",e.signerEmail||"").limit(1);return i&&i.length>0?(await t.signatureService.revokeSignature(i[0].id,"Signature refusée par le signataire"),r.logger.info("Signature marquée comme refusée",{signatureId:(0,r.maskId)(i[0].id),documentId:(0,r.maskId)(e.documentId)}),{success:!0,message:"Signature refusée enregistrée",signatureId:i[0].id,documentId:e.documentId,action:"signature_declined"}):{success:!0,message:"Événement de refus enregistré",documentId:e.documentId}}async handleSignatureExpired(e){if(!e.documentId)throw Error("documentId manquant dans l'événement signature.expired");let t=await (0,n.createClient)(),{error:a}=await t.from("document_signatures").update({status:"expired",is_valid:!1}).eq("document_id",e.documentId).eq("status","pending");return a&&r.logger.error("Erreur lors de la mise à jour des signatures expirées",a,{documentId:(0,r.maskId)(e.documentId)}),r.logger.info("Signatures marquées comme expirées",{documentId:(0,r.maskId)(e.documentId)}),{success:!0,message:"Signatures expirées",documentId:e.documentId,action:"signatures_expired"}}async handleSignatureCanceled(e){if(!e.documentId)throw Error("documentId manquant dans l'événement signature.canceled");let a=await (0,n.createClient)(),{data:i}=await a.from("document_signatures").select("id").eq("document_id",e.documentId).in("status",["pending","processing"]);if(i)for(let e of i)await t.signatureService.revokeSignature(e.id,"Procédure de signature annulée");return r.logger.info("Procédure de signature annulée",{documentId:(0,r.maskId)(e.documentId),signaturesCount:i?.length||0}),{success:!0,message:"Procédure de signature annulée",documentId:e.documentId,action:"signature_canceled"}}async handleDocumentEvent(e){return r.logger.info("Événement document reçu",{eventType:e.eventType,documentId:(0,r.maskId)(e.documentId),signerEmail:e.signerEmail}),{success:!0,message:`\xc9v\xe9nement ${e.eventType} enregistr\xe9`,documentId:e.documentId,action:"document_event_logged"}}parseYousignWebhook(e){return{provider:"yousign",eventType:this.mapYousignEventType(e.event_name||e.type),signatureId:e.signature_request?.id||e.id,documentId:e.metadata?.documentId||e.signature_request?.metadata?.documentId,signerEmail:e.signer?.email||e.signature_request?.signer?.email,signerName:e.signer?.info?.first_name&&e.signer?.info?.last_name?`${e.signer.info.first_name} ${e.signer.info.last_name}`:void 0,signedAt:e.signer?.signed_at||e.signature_request?.signed_at,status:e.status||e.signature_request?.status,metadata:e.metadata,rawPayload:e}}parseDocuSignWebhook(e){return{provider:"docusign",eventType:this.mapDocuSignEventType(e.event),signatureId:e.envelopeId||e.data?.envelopeId,documentId:e.envelopeSummary?.customFields?.textCustomFields?.find(e=>"documentId"===e.name)?.value,signerEmail:e.data?.recipients?.signers?.[0]?.email,signerName:e.data?.recipients?.signers?.[0]?.name,signedAt:e.data?.recipients?.signers?.[0]?.signedDateTime,status:e.data?.envelopeStatus||e.status,metadata:e.data,rawPayload:e}}parseHelloSignWebhook(e){return{provider:"hellosign",eventType:this.mapHelloSignEventType(e.event?.event_type),signatureId:e.signature_request?.signature_request_id,documentId:e.signature_request?.metadata?.documentId,signerEmail:e.event?.event_metadata?.reported_for_signer_email,signerName:e.signature_request?.signatures?.[0]?.signer_name,signedAt:e.signature_request?.signatures?.[0]?.signed_at?new Date(1e3*e.signature_request.signatures[0].signed_at).toISOString():void 0,status:e.signature_request?.status,metadata:e.signature_request?.metadata,rawPayload:e}}mapYousignEventType(e){return({"signature_request.created":"signature.created","signature_request.activated":"signature.pending","signature_request.signed":"signature.signed","signature_request.done":"signature.completed","signature_request.refused":"signature.declined","signature_request.expired":"signature.expired","signature_request.canceled":"signature.canceled"})[e]||"signature.created"}mapDocuSignEventType(e){return({"envelope-created":"signature.created","envelope-sent":"document.sent","envelope-delivered":"document.opened","recipient-completed":"signature.signed","envelope-completed":"signature.completed","recipient-declined":"signature.declined","envelope-voided":"signature.canceled"})[e]||"signature.created"}mapHelloSignEventType(e){return({signature_request_sent:"document.sent",signature_request_viewed:"document.opened",signature_request_signed:"signature.signed",signature_request_all_signed:"signature.completed",signature_request_declined:"signature.declined",signature_request_canceled:"signature.canceled",signature_request_expired:"signature.expired"})[e]||"signature.created"}}let i=new a;e.s(["ESignatureWebhookHandlerService",()=>a,"webhookHandlerService",0,i])}];

//# sourceMappingURL=_a887adfa._.js.map