module.exports=[206551,e=>{"use strict";function t(e,a="fr-FR"){return new Intl.DateTimeFormat(a,{year:"numeric",month:"long",day:"numeric"}).format(new Date(e))}function a(e,a,n,r){let o=new Date;return{ecole_nom:a?.name||"",ecole_logo:a?.logo_url||"",ecole_adresse:a?.address||"",ecole_ville:a?.city||"",ecole_telephone:a?.phone||"",ecole_email:a?.email||"",ecole_site_web:a?.website||"",ecole_siret:a?.siret||"",ecole_code_postal:a?.postal_code||"",eleve_nom:e?.last_name||"",eleve_prenom:e?.first_name||"",eleve_numero:e?.student_number||"",eleve_date_naissance:e?.date_of_birth?t(e.date_of_birth):"",eleve_classe:n?.name||"",eleve_photo:e?.photo_url||"",eleve_adresse:e?.address||"",eleve_telephone:e?.phone||"",eleve_email:e?.email||"",formation_nom:r?.name||"",formation_code:r?.code||"",formation_duree:r?.duration_hours?`${r.duration_hours} heures`:"",formation_prix:r?.price?`${r.price} ${r.currency||"EUR"}`:"",formation_dates:n?`${t(n.start_date)} - ${t(n.end_date)}`:"",formation_description:r?.description||"",formation_objectifs:r?.objectives||"",session_nom:n?.name||"",session_debut:n?.start_date?t(n.start_date):"",session_fin:n?.end_date?t(n.end_date):"",session_lieu:n?.location||"",session_horaires:n?.start_time&&n?.end_time?`${n.start_time} - ${n.end_time}`:"",date_jour:t(o),date_emission:t(o),date_generation:t(o),annee_actuelle:o.getFullYear().toString(),heure:o.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"}),numero_document:`DOC-${o.getTime()}`,numero_page:1,total_pages:1}}function n(e,n){let{student:r,invoice:o,payment:i,session:s,formation:l,organization:d}=n,u=Array.isArray(s)?s[0]:s;switch(e){case"invoice":if(o){let e;return e=new Date,{ecole_nom:d?.name||"",ecole_logo:d?.logo_url||"",ecole_adresse:d?.address||"",ecole_ville:d?.city||"",ecole_telephone:d?.phone||"",ecole_email:d?.email||"",ecole_siret:d?.siret||"",eleve_nom:r?.last_name||"",eleve_prenom:r?.first_name||"",eleve_numero:r?.student_number||"",eleve_adresse:r?.address||"",montant:o?.total_amount?`${o.total_amount} ${o.currency||"EUR"}`:"",montant_ht:o?.amount?`${o.amount} ${o.currency||"EUR"}`:"",montant_ttc:o?.total_amount?`${o.total_amount} ${o.currency||"EUR"}`:"",tva:o?.tax_amount?`${o.tax_amount} ${o.currency||"EUR"}`:"",taux_tva:o?.tax_amount&&o?.amount?`${(o.tax_amount/o.amount*100).toFixed(2)}%`:"",numero_facture:o?.invoice_number||"",date_echeance:o?.due_date?t(o.due_date):"",date_jour:t(e),date_emission:o?.issue_date?t(o.issue_date):t(e),date_generation:t(e),numero_document:o?.invoice_number||`DOC-${e.getTime()}`,numero_page:1,total_pages:1}}break;case"certificate":if(r&&u)return a(r,d,u,l);break;case"contract":case"report":case"other":if(r)return a(r,d,u,l);if(u){let e;return e=new Date,{ecole_nom:d?.name||"",ecole_logo:d?.logo_url||"",ecole_adresse:d?.address||"",ecole_ville:d?.city||"",ecole_telephone:d?.phone||"",ecole_email:d?.email||"",ecole_siret:d?.siret||"",ecole_rcs:d?.rcs||"",ecole_representant:d?.representative_name||"",formation_nom:l?.name||"",formation_code:l?.code||"",formation_duree:l?.duration_hours?`${l.duration_hours} heures`:"",formation_prix:l?.price?`${l.price} ${l.currency||"EUR"}`:"",formation_description:l?.description||"",formation_objectifs:l?.objectives||"",session_nom:u?.name||"",session_debut:u?.start_date?t(u.start_date):"",session_fin:u?.end_date?t(u.end_date):"",session_lieu:u?.location||"",session_horaires:u?.start_time&&u?.end_time?`${u.start_time} - ${u.end_time}`:"",date_jour:t(e),date_emission:t(e),date_generation:t(e),annee_actuelle:e.getFullYear().toString(),numero_document:`DOC-${e.getTime()}`,numero_page:1,total_pages:1}}}let c=new Date;return{ecole_nom:d?.name||"",ecole_logo:d?.logo_url||"",ecole_adresse:d?.address||"",ecole_ville:d?.city||"",ecole_telephone:d?.phone||"",ecole_email:d?.email||"",eleve_nom:r?.last_name||"",eleve_prenom:r?.first_name||"",eleve_numero:r?.student_number||"",date_jour:t(c),date_emission:t(c),date_generation:t(c),annee_actuelle:c.getFullYear().toString(),numero_document:`DOC-${c.getTime()}`,numero_page:1,total_pages:1}}e.s(["mapDataToVariables",()=>n],206551)},37161,e=>e.a(async(t,a)=>{try{var n=e.i(89171);e.i(694879);var r=e.i(87022),o=e.i(480963),i=e.i(77445),s=e.i(107497),l=e.i(162036),d=e.i(206551),u=e.i(338992),c=t([i]);async function m(e){try{let t=e.headers.get("authorization"),a=process.env.SCHEDULED_GENERATION_SECRET_KEY;if(a&&t!==`Bearer ${a}`)return n.NextResponse.json({error:"Non autorisé"},{status:401});let c=(0,r.createServerClient)("https://ocdlaouymksskmmhmzdr.supabase.co",process.env.NEXT_PUBLIC_SUPABASE_ANON_SERVICE_ROLE_KEY||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9jZGxhb3V5bWtzc2ttbWhtemRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNjEzOTksImV4cCI6MjA3ODYzNzM5OX0.5--WO4j5r1eC6_NqfFbWnyKVDeQqDk5RkhqL91T4wjE",{cookies:{get(){},set(){},remove(){}}}),m=await o.scheduledGenerationService.getDueGenerations(),_=[];for(let e of m)try{let{data:t,error:a}=await c.from("document_templates").select("*").eq("id",e.template_id).single();if(a||!t)throw Error(`Template non trouv\xe9: ${a?.message}`);let n=e.filter_config,r=[];if(n?.studentIds&&Array.isArray(n.studentIds))r=n.studentIds;else{let{data:t}=await c.from("students").select("id").eq("organization_id",e.organization_id).eq("status","active");r=t?.map(e=>e.id)||[]}for(let a of r)try{let n,r,{data:o}=await c.from("students").select("*, sessions(*, formations(*, programs(*)))").eq("id",a).single();if(!o)continue;let m=(0,d.mapDataToVariables)(t.type,{student:o,session:o.sessions});if("PDF"===e.format)n=(await (0,i.generatePDF)(t,m)).blob,r=`${e.name}_${o.student_number||a}.pdf`;else if("DOCX"===e.format)n=(await (0,s.generateDOCX)(t,m)).blob,r=`${e.name}_${o.student_number||a}.docx`;else{let i=await (0,l.generateHTML)(t,m);n=new Blob([i.html],{type:"text/html"}),r=`${e.name}_${o.student_number||a}.html`}let _=await n.arrayBuffer(),p=Buffer.from(_).toString("base64"),h=`data:application/${e.format.toLowerCase()};base64,${p}`;if(await c.from("generated_documents").insert({organization_id:e.organization_id,template_id:t.id,type:t.type,file_name:r,file_url:h,format:e.format,related_entity_type:"student",related_entity_id:a,metadata:m}),e.send_email&&e.email_recipients&&e.email_recipients.length>0){let t=e.email_recipients,a=o.email;for(let n of a&&t.includes(a)?[a]:t)await u.emailService.sendEmail({to:n,subject:`${e.name} - ${o.first_name} ${o.last_name}`,html:`
                    <!DOCTYPE html>
                    <html>
                      <head>
                        <meta charset="utf-8">
                        <style>
                          body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
                          .container { max-width: 600px; margin: 0 auto; padding: 20px; }
                          .header { background: #335ACF; color: white; padding: 20px; text-align: center; }
                          .content { padding: 20px; background: #f9fafb; }
                        </style>
                      </head>
                      <body>
                        <div class="container">
                          <div class="header">
                            <h1>${e.name}</h1>
                          </div>
                          <div class="content">
                            <p>Bonjour,</p>
                            <p>Veuillez trouver ci-joint le document <strong>${e.name}</strong> pour ${o.first_name} ${o.last_name}.</p>
                            <p>Ce document a \xe9t\xe9 g\xe9n\xe9r\xe9 automatiquement le ${new Date().toLocaleDateString("fr-FR")}.</p>
                            <p>Cordialement,<br>Eduzen</p>
                          </div>
                        </div>
                      </body>
                    </html>
                  `,attachments:[{filename:r,content:_,contentType:"PDF"===e.format?"application/pdf":"DOCX"===e.format?"application/vnd.openxmlformats-officedocument.wordprocessingml.document":"text/html"}]})}}catch(e){console.error(`Erreur lors de la g\xe9n\xe9ration pour l'\xe9tudiant ${a}:`,e)}_.push({generationId:e.id,success:!0})}catch(t){console.error(`Erreur lors de l'ex\xe9cution de la g\xe9n\xe9ration ${e.id}:`,t),_.push({generationId:e.id,success:!1,error:t instanceof Error?t.message:"Erreur inconnue"})}return n.NextResponse.json({executed:_.length,results:_})}catch(e){return console.error("Erreur lors de l'exécution des générations programmées:",e),n.NextResponse.json({error:e instanceof Error?e.message:"Erreur serveur"},{status:500})}}[i]=c.then?(await c)():c,e.s(["POST",()=>m]),a()}catch(e){a(e)}},!1),101924,e=>e.a(async(t,a)=>{try{var n=e.i(747909),r=e.i(174017),o=e.i(996250),i=e.i(759756),s=e.i(561916),l=e.i(174677),d=e.i(869741),u=e.i(316795),c=e.i(487718),m=e.i(995169),_=e.i(47587),p=e.i(666012),h=e.i(570101),f=e.i(626937),g=e.i(10372),v=e.i(193695);e.i(52474);var R=e.i(257297),E=e.i(37161),x=t([E]);[E]=x.then?(await x)():x;let b=new n.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/documents/scheduled/execute/route",pathname:"/api/documents/scheduled/execute",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/documents/scheduled/execute/route.ts",nextConfigOutput:"",userland:E}),{workAsyncStorage:C,workUnitAsyncStorage:$,serverHooks:T}=b;function y(){return(0,o.patchFetch)({workAsyncStorage:C,workUnitAsyncStorage:$})}async function w(e,t,a){b.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let n="/api/documents/scheduled/execute/route";n=n.replace(/\/index$/,"")||"/";let o=await b.prepare(e,t,{srcPage:n,multiZoneDraftMode:!1});if(!o)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:E,params:x,nextConfig:y,parsedUrl:w,isDraftMode:C,prerenderManifest:$,routerServerContext:T,isOnDemandRevalidate:A,revalidateOnlyGenerated:D,resolvedPathname:O,clientReferenceManifest:I,serverActionsManifest:N}=o,S=(0,d.normalizeAppPath)(n),P=!!($.dynamicRoutes[S]||$.routes[O]),j=async()=>((null==T?void 0:T.render404)?await T.render404(e,t,w,!1):t.end("This page could not be found"),null);if(P&&!C){let e=!!$.routes[O],t=$.dynamicRoutes[S];if(t&&!1===t.fallback&&!e){if(y.experimental.adapterPath)return await j();throw new v.NoFallbackError}}let U=null;!P||b.isDev||C||(U=O,U="/index"===U?"/":U);let k=!0===b.isDev||!P,F=P&&!k;N&&I&&(0,l.setManifestsSingleton)({page:n,clientReferenceManifest:I,serverActionsManifest:N});let q=e.method||"GET",H=(0,s.getTracer)(),M=H.getActiveScopeSpan(),z={params:x,prerenderManifest:$,renderOpts:{experimental:{authInterrupts:!!y.experimental.authInterrupts},cacheComponents:!!y.cacheComponents,supportsDynamicResponse:k,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:y.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,n,r)=>b.onRequestError(e,t,n,r,T)},sharedContext:{buildId:E}},L=new u.NodeNextRequest(e),B=new u.NodeNextResponse(t),K=c.NextRequestAdapter.fromNodeNextRequest(L,(0,c.signalFromNodeResponse)(t));try{let o=async e=>b.handle(K,z).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=H.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=a.get("next.route");if(r){let t=`${q} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${q} ${n}`)}),l=!!(0,i.getRequestMeta)(e,"minimalMode"),d=async i=>{var s,d;let u=async({previousCacheEntry:r})=>{try{if(!l&&A&&D&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await o(i);e.fetchMetrics=z.renderOpts.fetchMetrics;let s=z.renderOpts.pendingWaitUntil;s&&a.waitUntil&&(a.waitUntil(s),s=void 0);let d=z.renderOpts.collectedTags;if(!P)return await (0,p.sendResponse)(L,B,n,z.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(n.headers);d&&(t[g.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==z.renderOpts.collectedRevalidate&&!(z.renderOpts.collectedRevalidate>=g.INFINITE_CACHE)&&z.renderOpts.collectedRevalidate,r=void 0===z.renderOpts.collectedExpire||z.renderOpts.collectedExpire>=g.INFINITE_CACHE?void 0:z.renderOpts.collectedExpire;return{value:{kind:R.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==r?void 0:r.isStale)&&await b.onRequestError(e,t,{routerKind:"App Router",routePath:n,routeType:"route",revalidateReason:(0,_.getRevalidateReason)({isStaticGeneration:F,isOnDemandRevalidate:A})},!1,T),t}},c=await b.handleResponse({req:e,nextConfig:y,cacheKey:U,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:$,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:D,responseGenerator:u,waitUntil:a.waitUntil,isMinimalMode:l});if(!P)return null;if((null==c||null==(s=c.value)?void 0:s.kind)!==R.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(d=c.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",A?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),C&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,h.fromNodeOutgoingHttpHeaders)(c.value.headers);return l&&P||m.delete(g.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,f.getCacheControlHeader)(c.cacheControl)),await (0,p.sendResponse)(L,B,new Response(c.value.body,{headers:m,status:c.value.status||200})),null};M?await d(M):await H.withPropagatedContext(e.headers,()=>H.trace(m.BaseServerSpan.handleRequest,{spanName:`${q} ${n}`,kind:s.SpanKind.SERVER,attributes:{"http.method":q,"http.target":e.url}},d))}catch(t){if(t instanceof v.NoFallbackError||await b.onRequestError(e,t,{routerKind:"App Router",routePath:S,routeType:"route",revalidateReason:(0,_.getRevalidateReason)({isStaticGeneration:F,isOnDemandRevalidate:A})},!1,T),P)throw t;return await (0,p.sendResponse)(L,B,new Response(null,{status:500})),null}}e.s(["handler",()=>w,"patchFetch",()=>y,"routeModule",()=>b,"serverHooks",()=>T,"workAsyncStorage",()=>C,"workUnitAsyncStorage",()=>$]),a()}catch(e){a(e)}},!1)];

//# sourceMappingURL=_898bcc55._.js.map