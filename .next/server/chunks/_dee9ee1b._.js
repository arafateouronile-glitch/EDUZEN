module.exports=[415589,e=>{"use strict";e.s(["templateAnalyticsService",0,{logEvent:async(e,t,r)=>(console.warn("templateAnalyticsService.logEvent not implemented"),null)}])},983639,e=>e.a(async(t,r)=>{try{var o=e.i(89171);e.i(694879);var n=e.i(87022),a=e.i(77445),i=e.i(107497),s=e.i(162036),l=e.i(338992),u=e.i(415589);e.i(97205);var c=e.i(901900),d=t([a]);async function p(e){return(0,c.withRateLimit)(e,c.mutationRateLimiter,async e=>{try{let t,r,c,d,p,m=(0,n.createServerClient)("https://ocdlaouymksskmmhmzdr.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9jZGxhb3V5bWtzc2ttbWhtemRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNjEzOTksImV4cCI6MjA3ODYzNzM5OX0.5--WO4j5r1eC6_NqfFbWnyKVDeQqDk5RkhqL91T4wjE",{cookies:{get:t=>e.cookies.get(t)?.value,set(e,t,r){},remove(e,t){}}}),g=e.cookies.getAll();console.log("Cookies reçus dans l'API:",g.map(e=>e.name)),console.log("Cookies Supabase présents:",g.some(e=>e.name.includes("supabase")||e.name.includes("sb-")));let{data:{session:f},error:h}=await m.auth.getSession();if(f&&f.user)t=f.user;else{let{data:{user:r},error:n}=await m.auth.getUser();if(n||!r)return console.error("Erreur d'authentification:",n),console.error("Utilisateur:",r),console.error("Cookies disponibles:",e.cookies.getAll().map(e=>`${e.name}=${e.value.substring(0,20)}...`)),o.NextResponse.json({error:"Non autorisé"},{status:401});t=r}if(!t)return console.error("Aucun utilisateur trouvé"),o.NextResponse.json({error:"Non autorisé"},{status:401});let{data:v,error:y}=await m.from("users").select("organization_id").eq("id",t.id).single();if(y||!v?.organization_id)return o.NextResponse.json({error:"Organisation non trouvée"},{status:404});let x=await e.json(),{data:E,error:w}=await m.from("document_templates").select("*").eq("id",x.template_id).single();if(w||!E)return console.error("Erreur lors de la récupération du template:",w),o.NextResponse.json({error:"Template non trouvé"},{status:404});if(E.organization_id!==v.organization_id)return o.NextResponse.json({error:"Accès non autorisé"},{status:403});let b=E.content,R=E.header,_=E.footer;if(!(b?.html||b?.elements&&b.elements.length>0||R?.content||_?.content))return o.NextResponse.json({error:"Le template ne contient pas de contenu. Veuillez éditer le template avant de générer un document."},{status:400});let C=Date.now();try{if("PDF"===x.format){console.log("Début de la génération PDF..."),console.log("Template content type:",typeof E.content),console.log("Template header type:",typeof E.header),console.log("Template footer type:",typeof E.footer),console.log("Variables reçues:",Object.keys(x.variables||{}).length,"variables");try{let e=await (0,a.generatePDF)(E,x.variables,p,v.organization_id);r=e.blob,c=e.pageCount,d=`${E.type}_${Date.now()}.pdf`,console.log("PDF généré avec succès, taille:",r.size,"bytes")}catch(r){console.error("Erreur spécifique lors de la génération PDF:",r);let e=r instanceof Error?r.message:String(r),t=r instanceof Error?r.stack:void 0;if(console.error("Stack trace PDF:",t),e.includes("Puppeteer")||e.includes("Chromium")||e.includes("browser"))throw Error(`Impossible de g\xe9n\xe9rer le PDF: Puppeteer n\xe9cessite Chromium pour fonctionner. Dans un environnement de d\xe9veloppement, vous pouvez utiliser le format HTML pour l'aper\xe7u. Erreur: ${e}`);throw r}}else if("DOCX"===x.format){console.log("Début de la génération DOCX...");let e=await (0,i.generateDOCX)(E,x.variables,p,v.organization_id);r=e.blob,c=e.pageCount,d=`${E.type}_${Date.now()}.docx`,console.log("DOCX généré avec succès")}else if("ODT"===x.format)return o.NextResponse.json({error:"Le format ODT n'est pas encore implémenté. Utilisez PDF, DOCX ou HTML."},{status:501});else if("HTML"===x.format){console.log("Début de la génération HTML...");let e=await (0,s.generateHTML)(E,x.variables,void 0,v.organization_id);r=new Blob([e.html],{type:"text/html;charset=utf-8"}),c=e.pageCount,d=`${E.type}_${Date.now()}.html`,console.log("HTML généré avec succès")}else throw Error(`Format non support\xe9: ${x.format}`)}catch(r){console.error("Erreur lors de la génération du document:",r);let e=r instanceof Error?r.message:"Erreur lors de la génération du document",t=r instanceof Error?r.stack:void 0;if(console.error("Stack trace complète:",t),console.error("Type d'erreur:",r?.constructor?.name),console.error("Erreur complète:",JSON.stringify(r,Object.getOwnPropertyNames(r))),e.includes("Puppeteer")||e.includes("Chromium"))throw Error(`Puppeteer n'a pas pu \xeatre lanc\xe9. Puppeteer n\xe9cessite Chromium pour fonctionner. Veuillez installer Chromium ou utiliser un environnement qui le supporte. Erreur: ${e}`);throw Error(`G\xe9n\xe9ration ${x.format} \xe9chou\xe9e: ${e}`)}let D=await r.arrayBuffer(),T=Buffer.from(D).toString("base64"),O=`data:application/${x.format.toLowerCase()};base64,${T}`,{data:$}=await m.from("organizations").select("name, email").eq("id",v.organization_id).single(),{data:P,error:A}=await m.from("generated_documents").insert({organization_id:v.organization_id,template_id:E.id,type:E.type,file_name:d,file_url:O,format:x.format,page_count:c,related_entity_type:x.related_entity_type,related_entity_id:x.related_entity_id,metadata:x.variables,generated_by:t.id}).select().single();P&&(p=P.id),A&&console.error("Erreur lors de la création de l'enregistrement:",A);try{let e=Date.now()-C,o=Object.keys(x.variables||{}).length;await u.templateAnalyticsService.logEvent(E.id,"generate",{organization_id:v.organization_id,user_id:t.id,format:x.format,variablesCount:o,generationTimeMs:e,fileSizeBytes:r.size,pageCount:c,related_entity_type:x.related_entity_type,related_entity_id:x.related_entity_id})}catch(e){console.warn("Erreur lors du logging analytics:",e)}let N=null;if(x.options?.sendEmail&&x.options?.emailTo)try{let e="",t=E.name||`Document ${E.type}`;if("student"===x.related_entity_type&&x.related_entity_id){let{data:t}=await m.from("students").select("first_name, last_name, email").eq("id",x.related_entity_id).single();t&&(e=`${t.first_name} ${t.last_name}`,!x.options.emailTo&&t.email&&(x.options.emailTo=t.email))}let o=await r.arrayBuffer(),n={filename:d,content:o,contentType:"PDF"===x.format?"application/pdf":"DOCX"===x.format?"application/vnd.openxmlformats-officedocument.wordprocessingml.document":"text/html"};N=await l.emailService.sendEmail({to:x.options.emailTo,subject:`${t} - ${$?.name||"Eduzen"}`,html:`
            <!DOCTYPE html>
            <html>
              <head>
                <meta charset="utf-8">
                <style>
                  body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
                  .container { max-width: 600px; margin: 0 auto; padding: 20px; }
                  .header { background: #335ACF; color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0; }
                  .content { padding: 20px; background: #f9fafb; border: 1px solid #e5e7eb; }
                  .footer { text-align: center; padding: 20px; color: #6b7280; font-size: 12px; }
                  .button { background: #335ACF; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block; margin: 10px 0; }
                </style>
              </head>
              <body>
                <div class="container">
                  <div class="header">
                    <h1>${t}</h1>
                  </div>
                  <div class="content">
                    ${e?`<p>Bonjour ${e},</p>`:"<p>Bonjour,</p>"}
                    <p>Veuillez trouver ci-joint votre document <strong>${t}</strong>.</p>
                    <p>Ce document a \xe9t\xe9 g\xe9n\xe9r\xe9 le ${new Date().toLocaleDateString("fr-FR",{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})}.</p>
                    ${$?.name?`<p>Cordialement,<br><strong>${$.name}</strong></p>`:"<p>Cordialement,<br>L'équipe Eduzen</p>"}
                  </div>
                  <div class="footer">
                    <p>Cet email a \xe9t\xe9 envoy\xe9 automatiquement. Merci de ne pas y r\xe9pondre.</p>
                    ${$?.email?`<p>Pour toute question, contactez-nous \xe0 ${$.email}</p>`:""}
                  </div>
                </div>
              </body>
            </html>
          `,text:`
Bonjour${e?` ${e}`:""},

Veuillez trouver ci-joint votre document ${t}.

Ce document a \xe9t\xe9 g\xe9n\xe9r\xe9 le ${new Date().toLocaleDateString("fr-FR")}.

${$?.name?`Cordialement,
${$.name}`:"Cordialement,\nL'équipe Eduzen"}
          `.trim(),attachments:[n]}),console.log("Email envoyé avec succès:",N)}catch(e){console.error("Erreur lors de l'envoi de l'email:",e),N={success:!1,error:e instanceof Error?e.message:"Erreur inconnue"}}return o.NextResponse.json({document:P,downloadUrl:O,fileName:d,emailSent:N?.success||!1,emailError:N?.error||(N?.success?void 0:"Erreur lors de l'envoi de l'email")})}catch(r){console.error("Erreur lors de la génération du document:",r);let e=r instanceof Error?r.message:"string"==typeof r?r:"Erreur serveur inconnue",t=r instanceof Error?r.stack:void 0;return console.error("Stack trace:",t),o.NextResponse.json({error:e},{status:500})}})}[a]=d.then?(await d)():d,e.s(["POST",()=>p]),r()}catch(e){r(e)}},!1),223049,e=>e.a(async(t,r)=>{try{var o=e.i(747909),n=e.i(174017),a=e.i(996250),i=e.i(759756),s=e.i(561916),l=e.i(174677),u=e.i(869741),c=e.i(316795),d=e.i(487718),p=e.i(995169),m=e.i(47587),g=e.i(666012),f=e.i(570101),h=e.i(626937),v=e.i(10372),y=e.i(193695);e.i(52474);var x=e.i(257297),E=e.i(983639),w=t([E]);[E]=w.then?(await w)():w;let _=new o.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/documents/generate/route",pathname:"/api/documents/generate",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/documents/generate/route.ts",nextConfigOutput:"",userland:E}),{workAsyncStorage:C,workUnitAsyncStorage:D,serverHooks:T}=_;function b(){return(0,a.patchFetch)({workAsyncStorage:C,workUnitAsyncStorage:D})}async function R(e,t,r){_.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let o="/api/documents/generate/route";o=o.replace(/\/index$/,"")||"/";let a=await _.prepare(e,t,{srcPage:o,multiZoneDraftMode:!1});if(!a)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:E,params:w,nextConfig:b,parsedUrl:R,isDraftMode:C,prerenderManifest:D,routerServerContext:T,isOnDemandRevalidate:O,revalidateOnlyGenerated:$,resolvedPathname:P,clientReferenceManifest:A,serverActionsManifest:N}=a,S=(0,u.normalizeAppPath)(o),k=!!(D.dynamicRoutes[S]||D.routes[P]),z=async()=>((null==T?void 0:T.render404)?await T.render404(e,t,R,!1):t.end("This page could not be found"),null);if(k&&!C){let e=!!D.routes[P],t=D.dynamicRoutes[S];if(t&&!1===t.fallback&&!e){if(b.experimental.adapterPath)return await z();throw new y.NoFallbackError}}let j=null;!k||_.isDev||C||(j=P,j="/index"===j?"/":j);let I=!0===_.isDev||!k,q=k&&!I;N&&A&&(0,l.setManifestsSingleton)({page:o,clientReferenceManifest:A,serverActionsManifest:N});let F=e.method||"GET",M=(0,s.getTracer)(),H=M.getActiveScopeSpan(),L={params:w,prerenderManifest:D,renderOpts:{experimental:{authInterrupts:!!b.experimental.authInterrupts},cacheComponents:!!b.cacheComponents,supportsDynamicResponse:I,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:b.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,o,n)=>_.onRequestError(e,t,o,n,T)},sharedContext:{buildId:E}},U=new c.NodeNextRequest(e),B=new c.NodeNextResponse(t),X=d.NextRequestAdapter.fromNodeNextRequest(U,(0,d.signalFromNodeResponse)(t));try{let a=async e=>_.handle(X,L).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=M.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${F} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${F} ${o}`)}),l=!!(0,i.getRequestMeta)(e,"minimalMode"),u=async i=>{var s,u;let c=async({previousCacheEntry:n})=>{try{if(!l&&O&&$&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let o=await a(i);e.fetchMetrics=L.renderOpts.fetchMetrics;let s=L.renderOpts.pendingWaitUntil;s&&r.waitUntil&&(r.waitUntil(s),s=void 0);let u=L.renderOpts.collectedTags;if(!k)return await (0,g.sendResponse)(U,B,o,L.renderOpts.pendingWaitUntil),null;{let e=await o.blob(),t=(0,f.toNodeOutgoingHttpHeaders)(o.headers);u&&(t[v.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==L.renderOpts.collectedRevalidate&&!(L.renderOpts.collectedRevalidate>=v.INFINITE_CACHE)&&L.renderOpts.collectedRevalidate,n=void 0===L.renderOpts.collectedExpire||L.renderOpts.collectedExpire>=v.INFINITE_CACHE?void 0:L.renderOpts.collectedExpire;return{value:{kind:x.CachedRouteKind.APP_ROUTE,status:o.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==n?void 0:n.isStale)&&await _.onRequestError(e,t,{routerKind:"App Router",routePath:o,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:O})},!1,T),t}},d=await _.handleResponse({req:e,nextConfig:b,cacheKey:j,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:D,isRoutePPREnabled:!1,isOnDemandRevalidate:O,revalidateOnlyGenerated:$,responseGenerator:c,waitUntil:r.waitUntil,isMinimalMode:l});if(!k)return null;if((null==d||null==(s=d.value)?void 0:s.kind)!==x.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(u=d.value)?void 0:u.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",O?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),C&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,f.fromNodeOutgoingHttpHeaders)(d.value.headers);return l&&k||p.delete(v.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,h.getCacheControlHeader)(d.cacheControl)),await (0,g.sendResponse)(U,B,new Response(d.value.body,{headers:p,status:d.value.status||200})),null};H?await u(H):await M.withPropagatedContext(e.headers,()=>M.trace(p.BaseServerSpan.handleRequest,{spanName:`${F} ${o}`,kind:s.SpanKind.SERVER,attributes:{"http.method":F,"http.target":e.url}},u))}catch(t){if(t instanceof y.NoFallbackError||await _.onRequestError(e,t,{routerKind:"App Router",routePath:S,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:O})},!1,T),k)throw t;return await (0,g.sendResponse)(U,B,new Response(null,{status:500})),null}}e.s(["handler",()=>R,"patchFetch",()=>b,"routeModule",()=>_,"serverHooks",()=>T,"workAsyncStorage",()=>C,"workUnitAsyncStorage",()=>D]),r()}catch(e){r(e)}},!1)];

//# sourceMappingURL=_dee9ee1b._.js.map