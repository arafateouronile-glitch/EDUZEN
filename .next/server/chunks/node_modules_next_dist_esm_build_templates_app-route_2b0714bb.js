module.exports=[396818,e=>{"use strict";var t=e.i(747909),a=e.i(174017),i=e.i(996250),s=e.i(759756),r=e.i(561916),n=e.i(174677),o=e.i(869741),l=e.i(316795),d=e.i(487718),u=e.i(995169),c=e.i(47587),_=e.i(666012),m=e.i(570101),p=e.i(626937),g=e.i(10372),f=e.i(193695);e.i(52474);var h=e.i(257297),w=e.i(89171),v=e.i(89660),y=e.i(703755);let E=new class{supabase;constructor(e){this.supabase=e||(0,y.createClient)()}async getAllSchedules(e,t){let a=this.supabase.from("email_schedules").select("*, email_templates(*)").eq("organization_id",e).order("created_at",{ascending:!1});t?.isActive!==void 0&&(a=a.eq("is_active",t.isActive)),t?.emailType&&(a=a.eq("email_type",t.emailType));let{data:i,error:s}=await a;if(s)throw s;return i||[]}async getScheduleById(e){let{data:t,error:a}=await this.supabase.from("email_schedules").select("*, email_templates(*)").eq("id",e).single();if(a)throw a;return t}async createSchedule(e,t){let{data:a}=await this.supabase.auth.getUser(),i={organization_id:e,name:t.name,email_type:t.email_type,trigger_type:t.trigger_type,target_type:t.target_type,is_active:t.is_active??!0,send_to_students:t.send_to_students??!0,send_to_teachers:t.send_to_teachers??!1,send_to_coordinators:t.send_to_coordinators??!1};void 0!==t.description&&(i.description=t.description||null),void 0!==t.template_id&&(i.template_id=t.template_id||null),void 0!==t.trigger_days&&(i.trigger_days=t.trigger_days??null),void 0!==t.trigger_time&&(i.trigger_time=t.trigger_time||null),void 0!==t.trigger_datetime&&(i.trigger_datetime=t.trigger_datetime||null),void 0!==t.session_status&&(i.session_status=t.session_status||null),void 0!==t.session_id&&(i.session_id=t.session_id||null),void 0!==t.formation_id&&(i.formation_id=t.formation_id||null),void 0!==t.program_id&&(i.program_id=t.program_id||null),void 0!==t.custom_variables&&(i.custom_variables=t.custom_variables||null),void 0!==t.send_document&&(i.send_document=t.send_document??!1),void 0!==t.document_type&&(i.document_type=t.document_type||null),void 0!==t.document_template_id&&(i.document_template_id=t.document_template_id||null),a?.user?.id&&(i.created_by=a.user.id);let{data:s,error:r}=await this.supabase.from("email_schedules").insert(i).select().single();if(r)throw console.error("Error creating email schedule:",r),r;return s}async updateSchedule(e,t){let a={name:t.name,description:t.description,email_type:t.email_type,template_id:t.template_id,trigger_type:t.trigger_type,trigger_days:t.trigger_days,trigger_time:t.trigger_time,trigger_datetime:t.trigger_datetime,target_type:t.target_type,session_status:t.session_status,formation_id:t.formation_id,program_id:t.program_id,is_active:t.is_active,send_to_students:t.send_to_students,send_to_teachers:t.send_to_teachers,send_to_coordinators:t.send_to_coordinators,custom_variables:t.custom_variables,send_document:t.send_document,document_type:t.document_type,document_template_id:t.document_template_id};Object.keys(a).forEach(e=>{void 0===a[e]&&delete a[e]});let{data:i,error:s}=await this.supabase.from("email_schedules").update(a).eq("id",e).select().single();if(s)throw s;return i}async deleteSchedule(e){let{error:t}=await this.supabase.from("email_schedules").delete().eq("id",e);if(t)throw t}async getActiveSchedulesToExecute(){let{data:e,error:t}=await this.supabase.from("email_schedules").select("*, email_templates(*), organizations(*)").eq("is_active",!0);if(t)throw t;return e||[]}async logExecution(e,t,a,i){let s={schedule_id:e,organization_id:t,status:a.status,total_recipients:a.totalRecipients,successful_sends:a.successfulSends,failed_sends:a.failedSends,error_message:a.errorMessage||null,error_details:a.errorDetails||null,trigger_context:i||null},{data:r,error:n}=await this.supabase.from("email_schedule_logs").insert(s).select().single();if(n)throw n;let{data:o}=await this.supabase.from("email_schedules").select("total_sent").eq("id",e).single(),l=(o?.total_sent||0)+a.successfulSends;return await this.supabase.from("email_schedules").update({last_run_at:new Date().toISOString(),last_run_status:a.status,last_run_error:a.errorMessage||null,total_sent:l}).eq("id",e),r}async getScheduleLogs(e,t=50){let{data:a,error:i}=await this.supabase.from("email_schedule_logs").select("*").eq("schedule_id",e).order("executed_at",{ascending:!1}).limit(t);if(i)throw i;return a||[]}},b=new class{supabase;constructor(e){this.supabase=e||(0,y.createClient)()}async getAll(e){let{data:t,error:a}=await this.supabase.from("email_templates").select("*").eq("organization_id",e).eq("is_active",!0).order("email_type",{ascending:!0}).order("is_default",{ascending:!1}).order("created_at",{ascending:!1});if(a)throw a;return t||[]}async getByType(e,t){let{data:a,error:i}=await this.supabase.from("email_templates").select("*").eq("organization_id",e).eq("email_type",t).eq("is_active",!0).order("is_default",{ascending:!1}).order("created_at",{ascending:!1});if(i)throw i;return a||[]}async getDefault(e,t){let{data:a,error:i}=await this.supabase.from("email_templates").select("*").eq("organization_id",e).eq("email_type",t).eq("is_default",!0).eq("is_active",!0).maybeSingle();if(i)throw i;return a}async getById(e){let{data:t,error:a}=await this.supabase.from("email_templates").select("*").eq("id",e).maybeSingle();if(a)throw a;return t}async create(e,t){e.is_default&&await this.unsetOtherDefaults(e.organization_id,e.email_type);let{data:a,error:i}=await this.supabase.from("email_templates").insert({...e,created_by:t,available_variables:e.available_variables||[]}).select().single();if(i)throw i;return a}async update(e,t){let a=await this.getById(e);if(!a)throw Error("Modèle non trouvé");t.is_default&&await this.unsetOtherDefaults(a.organization_id,a.email_type,e);let{data:i,error:s}=await this.supabase.from("email_templates").update(t).eq("id",e).select().single();if(s)throw s;return i}async delete(e){let{error:t}=await this.supabase.from("email_templates").update({is_active:!1}).eq("id",e);if(t)throw t}async deletePermanently(e){let{error:t}=await this.supabase.from("email_templates").delete().eq("id",e);if(t)throw t}async unsetOtherDefaults(e,t,a){let i=this.supabase.from("email_templates").update({is_default:!1}).eq("organization_id",e).eq("email_type",t).eq("is_default",!0);a&&(i=i.neq("id",a));let{error:s}=await i;if(s)throw s}replaceVariables(e,t){let a=e;for(let[e,i]of Object.entries(t)){let t=RegExp(`\\{${e}\\}`,"g");a=a.replace(t,i?.toString()||"")}return a}getEmailTypes(){return[{value:"document_generated",label:"Document généré",description:"Email envoyé lors de la génération d'un document",defaultVariables:["student_name","document_title","document_type","organization_name","document_url"]},{value:"invoice_sent",label:"Facture envoyée",description:"Email envoyé lors de l'envoi d'une facture",defaultVariables:["student_name","invoice_number","invoice_amount","due_date","organization_name","invoice_url"]},{value:"payment_reminder",label:"Rappel de paiement",description:"Email de rappel pour un paiement en attente",defaultVariables:["student_name","invoice_number","invoice_amount","due_date","days_overdue","organization_name"]},{value:"enrollment_confirmation",label:"Confirmation d'inscription",description:"Email de confirmation d'inscription à une session",defaultVariables:["student_name","session_name","session_start_date","session_location","organization_name"]},{value:"session_reminder",label:"Rappel de session",description:"Email de rappel avant une session",defaultVariables:["student_name","session_name","session_date","session_time","session_location","organization_name"]},{value:"certificate_issued",label:"Certificat délivré",description:"Email lors de la délivrance d'un certificat",defaultVariables:["student_name","certificate_name","certificate_date","organization_name","certificate_url"]},{value:"notification",label:"Notification générale",description:"Notification générale personnalisée",defaultVariables:["recipient_name","message","organization_name","action_url"]},{value:"custom",label:"Personnalisé",description:"Modèle d'email personnalisé",defaultVariables:[]}]}};var R=e.i(779314),D=e.i(246245);let x=process.env.CRON_SECRET||process.env.EMAIL_SCHEDULE_SECRET;async function S(e,t,a){let i=t.from("sessions").select("*, formations(*), programs(*)").eq("is_active",!0);e.formation_id&&(i=i.eq("formation_id",e.formation_id)),e.program_id&&(i=i.eq("program_id",e.program_id)),e.session_status&&e.session_status.length>0&&(i=i.in("status",e.session_status));let{data:s,error:r}=await i;return r?(console.error("Error fetching sessions:",r),[]):s?s.filter(t=>{if(!t.start_date||!t.end_date)return!1;let i=new Date(t.start_date),s=new Date(t.end_date);if("before_session_start"===e.trigger_type){let t=e.trigger_days||0,s=new Date(i);s.setDate(s.getDate()-t);let r=new Date(a);r.setHours(0,0,0,0);let n=new Date(s);if(n.setHours(0,0,0,0),n.getTime()===r.getTime()){if(e.trigger_time){let[t,i]=e.trigger_time.split(":").map(Number),s=new Date(a);return s.setHours(t,i||0,0,0),a>=s&&a<new Date(s.getTime()+36e5)}return!0}return!1}if("after_session_end"===e.trigger_type){let t=e.trigger_days||0,i=new Date(s);i.setDate(i.getDate()+t);let r=new Date(a);r.setHours(0,0,0,0);let n=new Date(i);if(n.setHours(0,0,0,0),n.getTime()===r.getTime()){if(e.trigger_time){let[t,i]=e.trigger_time.split(":").map(Number),s=new Date(a);return s.setHours(t,i||0,0,0),a>=s&&a<new Date(s.getTime()+36e5)}return!0}}return!1}):[]}async function q(e,t,a){let i=t.from("evaluations").select("*, sessions(*), formations(*)").eq("is_active",!0),{data:s,error:r}=await i;return r?(console.error("Error fetching evaluations:",r),[]):s?s.filter(t=>{if(!t.start_date||!t.end_date)return!1;let i=new Date(t.start_date),s=new Date(t.end_date);if("before_evaluation_start"===e.trigger_type){let t=e.trigger_days||0,s=new Date(i);s.setDate(s.getDate()-t);let r=new Date(a);r.setHours(0,0,0,0);let n=new Date(s);if(n.setHours(0,0,0,0),n.getTime()===r.getTime()){if(e.trigger_time){let[t,i]=e.trigger_time.split(":").map(Number),s=new Date(a);return s.setHours(t,i||0,0,0),a>=s&&a<new Date(s.getTime()+36e5)}return!0}return!1}if("after_evaluation_end"===e.trigger_type){let t=e.trigger_days||0,i=new Date(s);i.setDate(i.getDate()+t);let r=new Date(a);r.setHours(0,0,0,0);let n=new Date(i);if(n.setHours(0,0,0,0),n.getTime()===r.getTime()){if(e.trigger_time){let[t,i]=e.trigger_time.split(":").map(Number),s=new Date(a);return s.setHours(t,i||0,0,0),a>=s&&a<new Date(s.getTime()+36e5)}return!0}}return!1}):[]}async function T(e,t,a){let i=[];try{let{data:s}=await t.from("organizations").select("*").eq("id",e.organization_id).single();if("session"===e.target_type)for(let s of(await S(e,t,a))){if(e.send_to_students){let{data:e}=await t.from("enrollments").select("*, students(*)").eq("session_id",s.id).eq("status","active");if(e)for(let t of e){let e=t.students;e?.email&&i.push({email:e.email,name:`${e.first_name} ${e.last_name}`,type:"student",context:{session:s,enrollment:t,student:e}})}}if(e.send_to_teachers&&s.teacher_id){let{data:e}=await t.from("users").select("*").eq("id",s.teacher_id).single();e?.email&&i.push({email:e.email,name:`${e.first_name||""} ${e.last_name||""}`.trim(),type:"teacher",context:{session:s,teacher:e}})}if(e.send_to_coordinators){let{data:a}=await t.from("users").select("*").eq("organization_id",e.organization_id).in("role",["admin","super_admin","coordinator"]);if(a)for(let e of a)e.email&&i.push({email:e.email,name:`${e.first_name||""} ${e.last_name||""}`.trim(),type:"coordinator",context:{session:s,coordinator:e}})}}if("evaluation"===e.target_type)for(let s of(await q(e,t,a))){if(e.send_to_students&&s.session_id){let{data:e}=await t.from("enrollments").select("*, students(*)").eq("session_id",s.session_id).eq("status","active");if(e)for(let t of e){let e=t.students;e?.email&&i.push({email:e.email,name:`${e.first_name} ${e.last_name}`,type:"student",context:{evaluation:s,enrollment:t,student:e}})}}if(e.send_to_teachers){let{data:e}=await t.from("sessions").select("*, users(*)").eq("id",s.session_id).single();e?.users?.email&&i.push({email:e.users.email,name:`${e.users.first_name||""} ${e.users.last_name||""}`.trim(),type:"teacher",context:{evaluation:s,teacher:e.users}})}}return i.reduce((e,t)=>(e.find(e=>e.email===t.email)||e.push(t),e),[])}catch(e){return console.error("Error getting recipients:",e),i}}async function C(e){try{if(x&&e.headers.get("authorization")!==`Bearer ${x}`)return w.NextResponse.json({error:"Unauthorized"},{status:401});await (0,v.createClient)();let t=(0,R.createAdminClient)(),a=await E.getActiveSchedulesToExecute(),i=new Date,s=[];for(let e of a)try{if(!function(e,t=new Date){let{trigger_type:a,trigger_datetime:i,trigger_days:s,trigger_time:r}=e;return"fixed_date"!==a||!!i&&new Date(i)<=new Date(t.getTime()+3e5)}(e,i))continue;if("fixed_date"!==e.trigger_type&&("session"===e.target_type||"evaluation"===e.target_type)){let a=await T(e,t,i);if(0===a.length){console.log(`No recipients for schedule ${e.id} at this time`);continue}let r=null;if(!(r=e.template_id?await b.getById(e.template_id):await b.getDefault(e.organization_id,e.email_type))){console.warn(`No template found for schedule ${e.id}`);continue}let{data:n}=await t.from("organizations").select("*").eq("id",e.organization_id).single(),o=0,l=0,d=[];for(let e of a)try{let{subject:t,bodyHtml:a,bodyText:i}=function(e,t,a){let i=e.subject||"",s=e.body_html||"",r=e.body_text||"",n={organization_name:a?.name||"",organization_email:a?.email||"",organization_phone:a?.phone||"",recipient_name:t.name||"",recipient_email:t.email||""};if(t.context){if(t.context.session){let e=t.context.session;n.session_name=e.name||"",n.session_start_date=e.start_date?new Date(e.start_date).toLocaleDateString("fr-FR"):"",n.session_end_date=e.end_date?new Date(e.end_date).toLocaleDateString("fr-FR"):""}if(t.context.student){let e=t.context.student;n.student_name=`${e.first_name} ${e.last_name}`,n.student_first_name=e.first_name||"",n.student_last_name=e.last_name||"",n.student_email=e.email||""}if(t.context.evaluation){let e=t.context.evaluation;n.evaluation_name=e.name||"",n.evaluation_start_date=e.start_date?new Date(e.start_date).toLocaleDateString("fr-FR"):"",n.evaluation_end_date=e.end_date?new Date(e.end_date).toLocaleDateString("fr-FR"):""}}return Object.entries(n).forEach(([e,t])=>{let a=RegExp(`{${e}}`,"g");i=i.replace(a,t),s=s.replace(a,t),r=r.replace(a,t)}),{subject:i,bodyHtml:s,bodyText:r}}(r,e,n);if(!process.env.RESEND_API_KEY)throw Error("RESEND_API_KEY not configured");let s=new D.Resend(process.env.RESEND_API_KEY),l=n?.email||process.env.RESEND_FROM_EMAIL||process.env.EMAIL_FROM||"noreply@eduzen.fr",{data:d,error:u}=await s.emails.send({from:`${n?.name||"EDUZEN"} <${l}>`,to:e.email,subject:t,html:a||i,text:i});if(u)throw Error(`Email send failed: ${u.message}`);o++}catch(t){l++,d.push({email:e.email,error:t instanceof Error?t.message:"Unknown error"}),console.error(`Error sending email to ${e.email}:`,t)}await E.logExecution(e.id,e.organization_id,{scheduleId:e.id,status:0===l?"success":l===o?"failed":"partial",totalRecipients:a.length,successfulSends:o,failedSends:l,errorMessage:d.length>0?`${d.length} erreurs`:void 0,errorDetails:d.length>0?{errors:d}:void 0},{executed_at:i.toISOString(),schedule_name:e.name,trigger_type:e.trigger_type}),s.push({scheduleId:e.id,scheduleName:e.name,status:"success",recipientsCount:a.length,successfulSends:o,failedSends:l})}else"fixed_date"===e.trigger_type&&console.log(`Fixed date schedule ${e.id} - implementation simplified`)}catch(t){console.error(`Error executing schedule ${e.id}:`,t),await E.logExecution(e.id,e.organization_id,{scheduleId:e.id,status:"failed",totalRecipients:0,successfulSends:0,failedSends:0,errorMessage:t instanceof Error?t.message:"Unknown error"},{executed_at:i.toISOString(),schedule_name:e.name}),s.push({scheduleId:e.id,scheduleName:e.name,status:"failed",error:t instanceof Error?t.message:"Unknown error"})}return w.NextResponse.json({success:!0,executedAt:i.toISOString(),schedulesProcessed:s.length,results:s})}catch(e){return console.error("Error in scheduled email execution:",e),w.NextResponse.json({error:"Internal server error",message:e instanceof Error?e.message:"Unknown error"},{status:500})}}async function A(e){return C(e)}e.s(["GET",()=>A,"POST",()=>C],165110);var N=e.i(165110);let O=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/emails/scheduled/execute/route",pathname:"/api/emails/scheduled/execute",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/emails/scheduled/execute/route.ts",nextConfigOutput:"",userland:N}),{workAsyncStorage:I,workUnitAsyncStorage:z,serverHooks:$}=O;function H(){return(0,i.patchFetch)({workAsyncStorage:I,workUnitAsyncStorage:z})}async function P(e,t,i){O.isDev&&(0,s.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let w="/api/emails/scheduled/execute/route";w=w.replace(/\/index$/,"")||"/";let v=await O.prepare(e,t,{srcPage:w,multiZoneDraftMode:!1});if(!v)return t.statusCode=400,t.end("Bad Request"),null==i.waitUntil||i.waitUntil.call(i,Promise.resolve()),null;let{buildId:y,params:E,nextConfig:b,parsedUrl:R,isDraftMode:D,prerenderManifest:x,routerServerContext:S,isOnDemandRevalidate:q,revalidateOnlyGenerated:T,resolvedPathname:C,clientReferenceManifest:A,serverActionsManifest:N}=v,I=(0,o.normalizeAppPath)(w),z=!!(x.dynamicRoutes[I]||x.routes[C]),$=async()=>((null==S?void 0:S.render404)?await S.render404(e,t,R,!1):t.end("This page could not be found"),null);if(z&&!D){let e=!!x.routes[C],t=x.dynamicRoutes[I];if(t&&!1===t.fallback&&!e){if(b.experimental.adapterPath)return await $();throw new f.NoFallbackError}}let H=null;!z||O.isDev||D||(H="/index"===(H=C)?"/":H);let P=!0===O.isDev||!z,U=z&&!P;N&&A&&(0,n.setManifestsSingleton)({page:w,clientReferenceManifest:A,serverActionsManifest:N});let M=e.method||"GET",k=(0,r.getTracer)(),F=k.getActiveScopeSpan(),j={params:E,prerenderManifest:x,renderOpts:{experimental:{authInterrupts:!!b.experimental.authInterrupts},cacheComponents:!!b.cacheComponents,supportsDynamicResponse:P,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:b.cacheLife,waitUntil:i.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,i,s)=>O.onRequestError(e,t,i,s,S)},sharedContext:{buildId:y}},L=new l.NodeNextRequest(e),V=new l.NodeNextResponse(t),B=d.NextRequestAdapter.fromNodeNextRequest(L,(0,d.signalFromNodeResponse)(t));try{let n=async e=>O.handle(B,j).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=k.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let i=a.get("next.route");if(i){let t=`${M} ${i}`;e.setAttributes({"next.route":i,"http.route":i,"next.span_name":t}),e.updateName(t)}else e.updateName(`${M} ${w}`)}),o=!!(0,s.getRequestMeta)(e,"minimalMode"),l=async s=>{var r,l;let d=async({previousCacheEntry:a})=>{try{if(!o&&q&&T&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let r=await n(s);e.fetchMetrics=j.renderOpts.fetchMetrics;let l=j.renderOpts.pendingWaitUntil;l&&i.waitUntil&&(i.waitUntil(l),l=void 0);let d=j.renderOpts.collectedTags;if(!z)return await (0,_.sendResponse)(L,V,r,j.renderOpts.pendingWaitUntil),null;{let e=await r.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(r.headers);d&&(t[g.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==j.renderOpts.collectedRevalidate&&!(j.renderOpts.collectedRevalidate>=g.INFINITE_CACHE)&&j.renderOpts.collectedRevalidate,i=void 0===j.renderOpts.collectedExpire||j.renderOpts.collectedExpire>=g.INFINITE_CACHE?void 0:j.renderOpts.collectedExpire;return{value:{kind:h.CachedRouteKind.APP_ROUTE,status:r.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:i}}}}catch(t){throw(null==a?void 0:a.isStale)&&await O.onRequestError(e,t,{routerKind:"App Router",routePath:w,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:q})},!1,S),t}},u=await O.handleResponse({req:e,nextConfig:b,cacheKey:H,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:x,isRoutePPREnabled:!1,isOnDemandRevalidate:q,revalidateOnlyGenerated:T,responseGenerator:d,waitUntil:i.waitUntil,isMinimalMode:o});if(!z)return null;if((null==u||null==(r=u.value)?void 0:r.kind)!==h.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",q?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),D&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let f=(0,m.fromNodeOutgoingHttpHeaders)(u.value.headers);return o&&z||f.delete(g.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||f.get("Cache-Control")||f.set("Cache-Control",(0,p.getCacheControlHeader)(u.cacheControl)),await (0,_.sendResponse)(L,V,new Response(u.value.body,{headers:f,status:u.value.status||200})),null};F?await l(F):await k.withPropagatedContext(e.headers,()=>k.trace(u.BaseServerSpan.handleRequest,{spanName:`${M} ${w}`,kind:r.SpanKind.SERVER,attributes:{"http.method":M,"http.target":e.url}},l))}catch(t){if(t instanceof f.NoFallbackError||await O.onRequestError(e,t,{routerKind:"App Router",routePath:I,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:q})},!1,S),z)throw t;return await (0,_.sendResponse)(L,V,new Response(null,{status:500})),null}}e.s(["handler",()=>P,"patchFetch",()=>H,"routeModule",()=>O,"serverHooks",()=>$,"workAsyncStorage",()=>I,"workUnitAsyncStorage",()=>z],396818)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_2b0714bb.js.map