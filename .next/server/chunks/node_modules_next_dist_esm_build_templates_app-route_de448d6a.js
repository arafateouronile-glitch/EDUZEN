module.exports=[627807,e=>{"use strict";var t=e.i(747909),r=e.i(174017),a=e.i(996250),i=e.i(759756),n=e.i(561916),o=e.i(174677),s=e.i(869741),u=e.i(316795),d=e.i(487718),c=e.i(995169),l=e.i(47587),m=e.i(666012),p=e.i(570101),h=e.i(626937),C=e.i(10372),E=e.i(193695);e.i(52474);var f=e.i(257297),v=e.i(89171);e.i(694879);var g=e.i(87022),R=e.i(224389);class b{supabase=(0,R.createClient)("https://ocdlaouymksskmmhmzdr.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9jZGxhb3V5bWtzc2ttbWhtemRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNjEzOTksImV4cCI6MjA3ODYzNzM5OX0.5--WO4j5r1eC6_NqfFbWnyKVDeQqDk5RkhqL91T4wjE");async generateFEC(e){return["JournalCode|JournalLib|EcritureNum|EcritureDate|CompteNum|CompteLib|CompAuxNum|CompAuxLib|PieceRef|PieceDate|EcritureLib|Debit|Credit|EcritureLet|DateLet|ValidDate|Montantdevise|Idevise",...(await this.getAccountingEntries(e)).map(e=>[e.JournalCode||"",e.JournalLib||"",e.EcritureNum||"",e.EcritureDate||"",e.CompteNum||"",e.CompteLib||"",e.CompAuxNum||"",e.CompAuxLib||"",e.PieceRef||"",e.PieceDate||"",e.EcritureLib||"",e.Debit||"0.00",e.Credit||"0.00",e.EcritureLet||"",e.DateLet||"",e.ValidDate||"",e.Montantdevise||"",e.Idevise||""].join("|"))].join("\n")}async getAccountingEntries(e){let t=[],r=this.supabase.from("invoices").select("*, students(id, first_name, last_name, student_number)").eq("organization_id",e.organizationId).eq("document_type","invoice").order("issue_date",{ascending:!0});e.startDate&&(r=r.gte("issue_date",e.startDate)),e.endDate&&(r=r.lte("issue_date",e.endDate));let{data:a,error:i}=await r;if(i)throw Error(`Erreur lors de la r\xe9cup\xe9ration des factures: ${i.message}`);for(let r of a||[]){let a=new Date(r.issue_date?r.issue_date:r.created_at||new Date().toISOString()),i=this.formatDateFEC(a),n=r.invoice_number||r.id.slice(0,8).toUpperCase(),o=r.amount||0,s=r.tax_amount||0,u=r.total_amount||o+s;t.push({JournalCode:e.journalCode||"VT",JournalLib:"Ventes",EcritureNum:n,EcritureDate:i,CompteNum:"411000",CompteLib:"Clients",CompAuxNum:r.student_id?r.student_id.slice(0,10):void 0,CompAuxLib:r.students?`${r.students.first_name||""} ${r.students.last_name||""}`.trim():void 0,PieceRef:r.invoice_number||"",PieceDate:i,EcritureLib:`Facture ${r.invoice_number||n}`,Debit:this.formatAmount(u),Credit:"0.00",ValidDate:i,Idevise:r.currency||"EUR",Montantdevise:r.currency&&"EUR"!==r.currency?this.formatAmount(u):void 0}),t.push({JournalCode:e.journalCode||"VT",JournalLib:"Ventes",EcritureNum:n,EcritureDate:i,CompteNum:"701000",CompteLib:"Ventes de produits finis",PieceRef:r.invoice_number||"",PieceDate:i,EcritureLib:`Facture ${r.invoice_number||n}`,Debit:"0.00",Credit:this.formatAmount(o),ValidDate:i,Idevise:r.currency||"EUR",Montantdevise:r.currency&&"EUR"!==r.currency?this.formatAmount(o):void 0}),s>0&&t.push({JournalCode:e.journalCode||"VT",JournalLib:"Ventes",EcritureNum:n,EcritureDate:i,CompteNum:"445710",CompteLib:"TVA collectée",PieceRef:r.invoice_number||"",PieceDate:i,EcritureLib:`TVA Facture ${r.invoice_number||n}`,Debit:"0.00",Credit:this.formatAmount(s),ValidDate:i,Idevise:r.currency||"EUR",Montantdevise:r.currency&&"EUR"!==r.currency?this.formatAmount(s):void 0})}if(e.includePayments){let r=this.supabase.from("payments").select("*, invoices(invoice_number, issue_date, student_id, students(id, first_name, last_name))").eq("organization_id",e.organizationId).eq("status","paid").order("paid_at",{ascending:!0});e.startDate&&(r=r.gte("paid_at",e.startDate)),e.endDate&&(r=r.lte("paid_at",e.endDate));let{data:a,error:i}=await r;if(i)throw Error(`Erreur lors de la r\xe9cup\xe9ration des paiements: ${i.message}`);for(let r of a||[]){let a=new Date(r.paid_at?r.paid_at:r.created_at||new Date().toISOString()),i=this.formatDateFEC(a),n=`PAY-${r.id.slice(0,8).toUpperCase()}`,o=r.invoices;t.push({JournalCode:e.journalCode||"BQ",JournalLib:"Banque",EcritureNum:n,EcritureDate:i,CompteNum:"512000",CompteLib:"Banque",PieceRef:o?.invoice_number||r.id,PieceDate:i,EcritureLib:`Paiement ${o?.invoice_number||r.id}`,Debit:this.formatAmount(r.amount||0),Credit:"0.00",ValidDate:i,Idevise:r.currency||"EUR",Montantdevise:r.currency&&"EUR"!==r.currency?this.formatAmount(r.amount||0):void 0}),t.push({JournalCode:e.journalCode||"BQ",JournalLib:"Banque",EcritureNum:n,EcritureDate:i,CompteNum:"411000",CompteLib:"Clients",CompAuxNum:o?.student_id?o.student_id.slice(0,10):void 0,CompAuxLib:o?.students?`${o.students.first_name||""} ${o.students.last_name||""}`.trim():void 0,PieceRef:o?.invoice_number||r.id,PieceDate:i,EcritureLib:`Paiement ${o?.invoice_number||r.id}`,Debit:"0.00",Credit:this.formatAmount(r.amount||0),ValidDate:i,Idevise:r.currency||"EUR",Montantdevise:r.currency&&"EUR"!==r.currency?this.formatAmount(r.amount||0):void 0})}}return t}formatDateFEC(e){let t=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),a=String(e.getDate()).padStart(2,"0");return`${t}${r}${a}`}formatAmount(e){return e.toFixed(2).replace(",",".")}generateFECFilename(e,t){let r=new Date,a=r.getFullYear(),i=String(r.getMonth()+1).padStart(2,"0"),n=`FEC_${e.slice(0,8)}_${a}${i}`;if(t?.startDate&&t?.endDate){let e=new Date(t.startDate),r=new Date(t.endDate);n+=`_${this.formatDateFEC(e)}_${this.formatDateFEC(r)}`}return`${n}.txt`}}let D=new b;var _=e.i(981838);async function x(e){try{let t=(0,g.createServerClient)("https://ocdlaouymksskmmhmzdr.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9jZGxhb3V5bWtzc2ttbWhtemRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNjEzOTksImV4cCI6MjA3ODYzNzM5OX0.5--WO4j5r1eC6_NqfFbWnyKVDeQqDk5RkhqL91T4wjE",{cookies:{getAll:()=>e.cookies.getAll().map(e=>({name:e.name,value:e.value})),setAll(){}}}),{data:{user:r},error:a}=await t.auth.getUser();if(a||!r)return v.NextResponse.json({error:"Non authentifié"},{status:401});let{data:i,error:n}=await t.from("users").select("organization_id, role").eq("id",r.id).single();if(n||!i?.organization_id)return v.NextResponse.json({error:"Organisation non trouvée"},{status:403});if(!["super_admin","admin","accountant"].includes(i.role))return v.NextResponse.json({error:"Permission refusée"},{status:403});let o=i.organization_id,s=e.nextUrl.searchParams,u=s.get("startDate")||void 0,d=s.get("endDate")||void 0,c="true"===s.get("includePayments"),l=s.get("journalCode")||void 0,m=await D.generateFEC({organizationId:o,startDate:u,endDate:d,includePayments:c,journalCode:l}),p=D.generateFECFilename(o,{startDate:u,endDate:d});return new v.NextResponse(m,{status:200,headers:{"Content-Type":"text/plain; charset=utf-8","Content-Disposition":`attachment; filename="${p}"`}})}catch(e){return _.logger.error("FEC Export - Export failed",e,{error:(0,_.sanitizeError)(e)}),v.NextResponse.json({error:"Erreur lors de l'export FEC",details:e instanceof Error?e.message:String(e)},{status:500})}}e.s(["GET",()=>x,"maxDuration",0,60,"runtime",0,"nodejs"],214367);var y=e.i(214367);let w=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/accounting/fec-export/route",pathname:"/api/accounting/fec-export",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/accounting/fec-export/route.ts",nextConfigOutput:"",userland:y}),{workAsyncStorage:A,workUnitAsyncStorage:N,serverHooks:I}=w;function P(){return(0,a.patchFetch)({workAsyncStorage:A,workUnitAsyncStorage:N})}async function L(e,t,a){w.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let v="/api/accounting/fec-export/route";v=v.replace(/\/index$/,"")||"/";let g=await w.prepare(e,t,{srcPage:v,multiZoneDraftMode:!1});if(!g)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:R,params:b,nextConfig:D,parsedUrl:_,isDraftMode:x,prerenderManifest:y,routerServerContext:A,isOnDemandRevalidate:N,revalidateOnlyGenerated:I,resolvedPathname:P,clientReferenceManifest:L,serverActionsManifest:O}=g,S=(0,s.normalizeAppPath)(v),T=!!(y.dynamicRoutes[S]||y.routes[P]),j=async()=>((null==A?void 0:A.render404)?await A.render404(e,t,_,!1):t.end("This page could not be found"),null);if(T&&!x){let e=!!y.routes[P],t=y.dynamicRoutes[S];if(t&&!1===t.fallback&&!e){if(D.experimental.adapterPath)return await j();throw new E.NoFallbackError}}let F=null;!T||w.isDev||x||(F="/index"===(F=P)?"/":F);let U=!0===w.isDev||!T,$=T&&!U;O&&L&&(0,o.setManifestsSingleton)({page:v,clientReferenceManifest:L,serverActionsManifest:O});let M=e.method||"GET",q=(0,n.getTracer)(),J=q.getActiveScopeSpan(),k={params:b,prerenderManifest:y,renderOpts:{experimental:{authInterrupts:!!D.experimental.authInterrupts},cacheComponents:!!D.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:D.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a,i)=>w.onRequestError(e,t,a,i,A)},sharedContext:{buildId:R}},V=new u.NodeNextRequest(e),z=new u.NodeNextResponse(t),H=d.NextRequestAdapter.fromNodeNextRequest(V,(0,d.signalFromNodeResponse)(t));try{let o=async e=>w.handle(H,k).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=q.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${M} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${M} ${v}`)}),s=!!(0,i.getRequestMeta)(e,"minimalMode"),u=async i=>{var n,u;let d=async({previousCacheEntry:r})=>{try{if(!s&&N&&I&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await o(i);e.fetchMetrics=k.renderOpts.fetchMetrics;let u=k.renderOpts.pendingWaitUntil;u&&a.waitUntil&&(a.waitUntil(u),u=void 0);let d=k.renderOpts.collectedTags;if(!T)return await (0,m.sendResponse)(V,z,n,k.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,p.toNodeOutgoingHttpHeaders)(n.headers);d&&(t[C.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==k.renderOpts.collectedRevalidate&&!(k.renderOpts.collectedRevalidate>=C.INFINITE_CACHE)&&k.renderOpts.collectedRevalidate,a=void 0===k.renderOpts.collectedExpire||k.renderOpts.collectedExpire>=C.INFINITE_CACHE?void 0:k.renderOpts.collectedExpire;return{value:{kind:f.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await w.onRequestError(e,t,{routerKind:"App Router",routePath:v,routeType:"route",revalidateReason:(0,l.getRevalidateReason)({isStaticGeneration:$,isOnDemandRevalidate:N})},!1,A),t}},c=await w.handleResponse({req:e,nextConfig:D,cacheKey:F,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:y,isRoutePPREnabled:!1,isOnDemandRevalidate:N,revalidateOnlyGenerated:I,responseGenerator:d,waitUntil:a.waitUntil,isMinimalMode:s});if(!T)return null;if((null==c||null==(n=c.value)?void 0:n.kind)!==f.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(u=c.value)?void 0:u.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",N?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),x&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let E=(0,p.fromNodeOutgoingHttpHeaders)(c.value.headers);return s&&T||E.delete(C.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||E.get("Cache-Control")||E.set("Cache-Control",(0,h.getCacheControlHeader)(c.cacheControl)),await (0,m.sendResponse)(V,z,new Response(c.value.body,{headers:E,status:c.value.status||200})),null};J?await u(J):await q.withPropagatedContext(e.headers,()=>q.trace(c.BaseServerSpan.handleRequest,{spanName:`${M} ${v}`,kind:n.SpanKind.SERVER,attributes:{"http.method":M,"http.target":e.url}},u))}catch(t){if(t instanceof E.NoFallbackError||await w.onRequestError(e,t,{routerKind:"App Router",routePath:S,routeType:"route",revalidateReason:(0,l.getRevalidateReason)({isStaticGeneration:$,isOnDemandRevalidate:N})},!1,A),T)throw t;return await (0,m.sendResponse)(V,z,new Response(null,{status:500})),null}}e.s(["handler",()=>L,"patchFetch",()=>P,"routeModule",()=>w,"serverHooks",()=>I,"workAsyncStorage",()=>A,"workUnitAsyncStorage",()=>N],627807)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_de448d6a.js.map