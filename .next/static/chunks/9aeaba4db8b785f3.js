(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,107233,e=>{"use strict";let r=(0,e.i(475254).default)("Plus",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]]);e.s(["Plus",()=>r],107233)},871689,e=>{"use strict";let r=(0,e.i(475254).default)("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]]);e.s(["ArrowLeft",()=>r],871689)},503116,e=>{"use strict";let r=(0,e.i(475254).default)("Clock",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["polyline",{points:"12 6 12 12 16 14",key:"68esgv"}]]);e.s(["Clock",()=>r],503116)},605631,e=>{"use strict";let r=(0,e.i(475254).default)("CheckCircle",[["path",{d:"M22 11.08V12a10 10 0 1 1-5.93-9.14",key:"g774vq"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]]);e.s(["CheckCircle",()=>r],605631)},738308,e=>{"use strict";let r=(0,e.i(475254).default)("XCircle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]]);e.s(["XCircle",()=>r],738308)},350627,e=>{"use strict";let r=(0,e.i(475254).default)("Receipt",[["path",{d:"M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1-2 1-2-1Z",key:"wqdwcb"}],["path",{d:"M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8",key:"1h4pet"}],["path",{d:"M12 17V7",key:"pyj7ub"}]]);e.s(["Receipt",()=>r],350627)},330293,e=>{"use strict";function r(e){let{student:r,organization:a,session:n,invoice:i,program:o,academicYear:s,language:l="fr",issueDate:c=new Date().toISOString()}=e;return{date_emission:new Date().toLocaleDateString("fr-FR"),date_aujourd_hui:new Date().toLocaleDateString("fr-FR"),date_jour:new Date().toLocaleDateString("fr-FR"),annee_courante:new Date().getFullYear().toString(),annee_actuelle:new Date().getFullYear().toString(),date_generation:new Date().toLocaleDateString("fr-FR"),heure:new Date().toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"}),ecole_nom:a?.name||"",ecole_logo:a?.logo_url||"",ecole_adresse:a?.address||"",ecole_ville:(a?.address||"").split(",").pop()?.trim()||"",ecole_telephone:a?.phone||"",ecole_email:a?.email||"",ecole_site_web:a?.website||"",ecole_code_postal:(a?.address||"").match(/\d{5}/)?.[0]||"",organisation_nom:a?.name||"",organisation_adresse:a?.address||"",organisation_telephone:a?.phone||"",organisation_email:a?.email||"",organisation_logo:a?.logo_url||"",organisation_site_web:a?.website||"",eleve_nom:r?.last_name||"",eleve_prenom:r?.first_name||"",eleve_numero:r?.student_number||"",eleve_date_naissance:r?.date_of_birth?new Date(r.date_of_birth).toLocaleDateString("fr-FR"):"",eleve_classe:r?.classes?r.classes.name:"",eleve_photo:r?.photo_url||"",eleve_adresse:r?.address||"",eleve_telephone:r?.phone||"",eleve_email:r?.email||"",etudiant_nom:r?.last_name||"",etudiant_prenom:r?.first_name||"",etudiant_nom_complet:r?`${r.first_name} ${r.last_name}`:"",etudiant_numero:r?.student_number||"",etudiant_date_naissance:r?.date_of_birth?new Date(r.date_of_birth).toLocaleDateString("fr-FR"):"",etudiant_adresse:r?.address||"",etudiant_telephone:r?.phone||"",etudiant_email:r?.email||"",etudiant_photo:r?.photo_url||"",classe_nom:r?.classes?r.classes.name:"",annee_academique:s?.name||new Date().getFullYear().toString(),annee_scolaire:s?.name||new Date().getFullYear().toString(),session_nom:n?.name||"",session_debut:n?.start_date?new Date(n.start_date).toLocaleDateString("fr-FR"):"",session_fin:n?.end_date?new Date(n.end_date).toLocaleDateString("fr-FR"):"",session_date_debut:n?.start_date?new Date(n.start_date).toLocaleDateString("fr-FR"):"",session_date_fin:n?.end_date?new Date(n.end_date).toLocaleDateString("fr-FR"):"",formation_nom:n?.formations?.name||"",formation_duree:n?.formations?.duration_hours?`${n.formations?.duration_hours} heures`:"",formation_objectifs:n?.formations?.objectives||o?.objectives||"",formation_public_concerne:n?.formations?.target_audience||o?.target_audience||"",formation_prerequis:n?.formations?.prerequisites||o?.prerequisites||"",formation_qualite_et_resultats:n?.formations?.quality_indicators||o?.quality_indicators||"",formation_contenu:n?.formations?.content||o?.content||"",formation_equipe_pedagogique:n?.formations?.pedagogical_team||o?.pedagogical_team||"",formation_ressources:n?.formations?.resources||o?.resources||"",formation_supports:n?.formations?.materials||o?.materials||"",session_lieu:n?.location||n?.venue||"",session_effectif:n?.enrollment_count?.toString()||n?.student_count?.toString()||"",diplome_ou_certification:n?.formations?.certification||o?.certification||"",ecole_region:a?.region||a?.administrative_region||"",programme_nom:o?.name||n?.formations?.programs?.name||"",programme_code:o?.code||"",programme_description:o?.description||"",programme_objectifs:o?.objectives||"",programme_duree_totale:o?.formations?`${o.formations.reduce((e,r)=>e+(r.duration_hours||0),0)} heures`:"",programme_nombre_formations:o?.formations?`${o.formations.length}`:"",programme_nombre_sessions:"",programme_public_concerne:o?.target_audience||"",programme_modalites:o?.modalities||"",programme_certification:o?.certification||"",numero_facture:i?.invoice_number||"",facture_numero:i?.invoice_number||"",facture_date_emission:i?.issue_date?new Date(i.issue_date).toLocaleDateString("fr-FR"):"",facture_date_echeance:i?.due_date?new Date(i.due_date).toLocaleDateString("fr-FR"):"",date_echeance:i?.due_date?new Date(i.due_date).toLocaleDateString("fr-FR"):"",montant:i?.amount?Number(i.amount).toFixed(2):"0.00",montant_ht:i?.amount?Number(i.amount).toFixed(2):"0.00",montant_ttc:i?.total_amount?Number(i.total_amount).toFixed(2):"0.00",tva:i?.tax_amount?Number(i.tax_amount).toFixed(2):"0.00",taux_tva:i?.tax_amount&&i?.amount?(Number(i.tax_amount)/Number(i.amount)*100).toFixed(2):"0.00",facture_montant:i?.amount?Number(i.amount).toFixed(2):"0.00",facture_tva:i?.tax_amount?Number(i.tax_amount).toFixed(2):"0.00",facture_total:i?.total_amount?Number(i.total_amount).toFixed(2):"0.00",facture_devise:i?.currency||"EUR",facture_items:i?.items?JSON.stringify(i.items):"[]",montant_lettres:i?.total_amount?function(e,r="fr"){return"en"===r?e.toFixed(2)+" euros":function e(r){if(0===r)return"zéro euro";if(r<0)return"moins "+e(-r);let a=Math.floor(r),n=Math.round((r-a)*100),i=t(a);return n>0&&(i+=" virgule "+t(n)),i+(a>1?" euros":" euro")}(e)}(Number(i.total_amount),l):"",mode_paiement:i?.payment_method||"",date_paiement:i?.paid_at?new Date(i.paid_at).toLocaleDateString("fr-FR"):"",ecole_siret:a?.siret||"",ecole_numero_declaration:a?.declaration_number||"",ecole_representant:a?.representative_name||"",langue:l}}function t(e){if(0===e)return"";if(e<10)return["","un","deux","trois","quatre","cinq","six","sept","huit","neuf"][e];if(e<20)return["dix","onze","douze","treize","quatorze","quinze","seize","dix-sept","dix-huit","dix-neuf"][e-10];if(e<100){let r=Math.floor(e/10),a=e%10,n=["","","vingt","trente","quarante","cinquante","soixante","soixante","quatre-vingt","quatre-vingt"][r];return 7===r||9===r?n+="-"+(1===a?"et-":"")+t(10+a):a>0?n+=(1===a&&8!==r?"-et-":"-")+t(a):8===r&&(n+="s"),n}if(e<1e3){let r=Math.floor(e/100),a=e%100,n=1===r?"cent":t(r)+"-cent";return a>0?n+="-"+t(a):r>1&&(n+="s"),n}if(e<1e6){let r=Math.floor(e/1e3),a=e%1e3,n=1===r?"mille":t(r)+"-mille";return a>0&&(n+="-"+t(a)),n}return e.toString()}function a(e){return({attestation:"attestation_reussite",certificate:"certificat_scolarite",invoice:"facture",receipt:"facture",transcript:"releve_notes",report_card:"releve_notes",convocation:"convocation",contract:"contrat"})[e]||e}e.s(["extractDocumentVariables",()=>r,"mapDocumentTypeToTemplateType",()=>a])},246704,779478,e=>{"use strict";var r,t,a=e.i(790224),n=((r={}).AUTH_REQUIRED="AUTH_1001",r.AUTH_INVALID_CREDENTIALS="AUTH_1002",r.AUTH_SESSION_EXPIRED="AUTH_1003",r.AUTH_INSUFFICIENT_PERMISSIONS="AUTH_1004",r.AUTH_2FA_REQUIRED="AUTH_1005",r.AUTH_2FA_INVALID="AUTH_1006",r.VALIDATION_ERROR="VALID_2001",r.VALIDATION_REQUIRED_FIELD="VALID_2002",r.VALIDATION_INVALID_FORMAT="VALID_2003",r.VALIDATION_UNIQUE_CONSTRAINT="VALID_2004",r.DB_CONNECTION_ERROR="DB_3001",r.DB_QUERY_ERROR="DB_3002",r.DB_NOT_FOUND="DB_3003",r.DB_CONSTRAINT_VIOLATION="DB_3004",r.DB_FOREIGN_KEY_CONSTRAINT="DB_3006",r.DB_RLS_POLICY_VIOLATION="DB_3005",r.NETWORK_ERROR="NET_4001",r.API_TIMEOUT="NET_4002",r.API_RATE_LIMIT="NET_4003",r.API_SERVER_ERROR="NET_4004",r.API_NOT_FOUND="NET_4005",r.API_BAD_REQUEST="NET_4006",r.BUSINESS_LOGIC_ERROR="BIZ_5001",r.RESOURCE_LOCKED="BIZ_5002",r.OPERATION_NOT_ALLOWED="BIZ_5003",r.QUOTA_EXCEEDED="BIZ_5004",r.INTERNAL_ERROR="SYS_6001",r.CONFIGURATION_ERROR="SYS_6002",r.SERVICE_UNAVAILABLE="SYS_6003",r);(t={}).LOW="low",t.MEDIUM="medium",t.HIGH="high",t.CRITICAL="critical";class i extends Error{code;severity;userMessage;retryable;context;originalError;constructor(e,r="SYS_6001",t="medium",a={},n){super(e),this.name="AppError",this.code=r,this.severity=t,this.userMessage=a.userMessage||this.getDefaultUserMessage(r),this.retryable=a.retryable??this.isRetryable(r),this.context={...a,code:r,severity:t,timestamp:new Date().toISOString()},this.originalError=n,Error.captureStackTrace&&Error.captureStackTrace(this,i)}getDefaultUserMessage(e){return({AUTH_1001:"Vous devez être connecté pour effectuer cette action.",AUTH_1002:"Email ou mot de passe incorrect.",AUTH_1003:"Votre session a expiré. Veuillez vous reconnecter.",AUTH_1004:"Vous n'avez pas les permissions nécessaires.",AUTH_1005:"Authentification à deux facteurs requise.",AUTH_1006:"Code d'authentification invalide.",VALID_2001:"Les données fournies ne sont pas valides.",VALID_2002:"Certains champs obligatoires sont manquants.",VALID_2003:"Le format des données est incorrect.",VALID_2004:"Cette valeur existe déjà.",DB_3001:"Impossible de se connecter à la base de données.",DB_3002:"Erreur lors de l'exécution de la requête.",DB_3003:"Ressource introuvable.",DB_3004:"Cette opération viole une contrainte de la base de données.",DB_3006:"Cette opération viole une contrainte de clé étrangère.",DB_3005:"Vous n'avez pas accès à cette ressource.",NET_4001:"Erreur de connexion réseau. Vérifiez votre connexion internet.",NET_4002:"La requête a pris trop de temps. Veuillez réessayer.",NET_4003:"Trop de requêtes. Veuillez patienter quelques instants.",NET_4004:"Erreur serveur. Veuillez réessayer plus tard.",NET_4005:"Ressource introuvable.",NET_4006:"Requête invalide.",BIZ_5001:"Cette opération n'est pas autorisée dans le contexte actuel.",BIZ_5002:"Cette ressource est actuellement verrouillée.",BIZ_5003:"Cette opération n'est pas autorisée.",BIZ_5004:"Vous avez atteint la limite autorisée.",SYS_6001:"Une erreur interne est survenue. Veuillez réessayer.",SYS_6002:"Erreur de configuration du système.",SYS_6003:"Service temporairement indisponible."})[e]||"Une erreur inattendue est survenue."}isRetryable(e){return["NET_4001","NET_4002","NET_4004","DB_3001","SYS_6003"].includes(e)}toJSON(){return{name:this.name,message:this.message,code:this.code,severity:this.severity,userMessage:this.userMessage,retryable:this.retryable,context:this.context,stack:this.stack,originalError:this.originalError instanceof Error?{name:this.originalError.name,message:this.originalError.message,stack:this.originalError.stack}:this.originalError}}}let o=new class{handleError(e,r={}){if(e instanceof i)return this.logError(e),e;if(e instanceof Error)return this.handleStandardError(e,r);if(this.isSupabaseError(e))return this.handleSupabaseError(e,r);let t=new i("Une erreur inattendue est survenue.","SYS_6001","high",r,e);return this.logError(t),t}handleStandardError(e,r){let t=e.message.toLowerCase(),a="SYS_6001",n="medium";t.includes("network")||t.includes("fetch")?(a="NET_4001",n="medium"):t.includes("timeout")?(a="NET_4002",n="medium"):t.includes("unauthorized")||t.includes("401")?(a="AUTH_1001",n="high"):t.includes("forbidden")||t.includes("403")?(a="AUTH_1004",n="high"):t.includes("not found")||t.includes("404")?(a="DB_3003",n="low"):(t.includes("validation")||t.includes("invalid"))&&(a="VALID_2001",n="low");let o=new i(e.message,a,n,r,e);return this.logError(o),o}handleSupabaseError(e,r){let t=e.code||e.status,a=e.message||"Erreur Supabase",n=r.code||"DB_3002",o="medium";if(!r.code)switch(t){case"PGRST116":case"42P01":n="DB_3003",o="low";break;case"42501":n="DB_3005",o="high";break;case"23505":n="VALID_2004",o="low";break;case"23503":n="DB_3004",o="medium";break;case"PGRST301":case"400":n="NET_4006",o="low";break;case"401":n="AUTH_1001",o="high";break;case"403":n="AUTH_1004",o="high";break;case"404":n="NET_4005",o="low";break;case"500":n="NET_4004",o="high"}"DB_3006"===n&&(o="medium");let s=new i(a,n,o,r,e);return this.logError(s),s}isSupabaseError(e){return e&&(e.code||e.status||e.message)&&("string"==typeof e.code||"number"==typeof e.status)}logError(e){let r={...e.context,code:e.code,severity:e.severity,retryable:e.retryable};switch(e.severity){case"critical":case"high":a.logger.error(e.message,e.originalError||e,r);break;case"medium":a.logger.warn(e.message,r);break;case"low":a.logger.info(`Error: ${e.message}`,r)}}createValidationError(e,r){return new i(e,"VALID_2001","low",{field:r,userMessage:e})}createAuthError(e,r){return new i(r||"Erreur d'authentification",e,"high")}createDatabaseError(e,r){return new i(e,"DB_3002","medium",{},r)}createNotFoundError(e,r){return new i(e,"DB_3003","low",r)}};e.s(["AppError",()=>i,"ErrorCode",()=>n,"errorHandler",0,o],779478),e.s([],246704)},627404,e=>{"use strict";e.i(246704);var r=e.i(779478);async function t(e,t,a,n){try{let i=e.from(t).select(n?.select||"*").eq("organization_id",a);n?.filters&&Object.entries(n.filters).forEach(([e,r])=>{null!=r&&(i=i.eq(e,r))}),n?.search&&(i=i.ilike(n.search.field,`%${n.search.value}%`)),i=n?.orderBy?i.order(n.orderBy.column,{ascending:n.orderBy.ascending??!1}):i.order("created_at",{ascending:!1});let{data:o,error:s}=await i;if(s)throw r.errorHandler.handleError(s,{organizationId:a,operation:"getAllByOrganization",table:t});return o||[]}catch(e){if(e instanceof r.AppError)throw e;throw r.errorHandler.handleError(e,{organizationId:a,operation:"getAllByOrganization",table:t})}}async function a(e,t,a,n){try{let{data:i,error:o}=await e.from(t).select(n||"*").eq("id",a).single();if(o){if("PGRST116"===o.code||"42P01"===o.code)throw r.errorHandler.handleError(o,{code:r.ErrorCode.DB_NOT_FOUND,operation:"getById",id:a,table:t});throw r.errorHandler.handleError(o,{operation:"getById",id:a,table:t})}if(!i)throw r.errorHandler.createDatabaseError(`Enregistrement avec l'ID ${a} introuvable dans ${t}`,{id:a,table:t});return i}catch(e){if(e instanceof r.AppError)throw e;throw r.errorHandler.handleError(e,{operation:"getById",id:a,table:t})}}e.s(["getAllByOrganization",()=>t,"getById",()=>a])},34458,e=>{"use strict";e.i(246704);var r=e.i(779478);function t(e,t){for(let a of t)if(!e[a])throw r.errorHandler.createValidationError(`Le champ ${String(a)} est obligatoire`,String(a))}e.s(["validateRequired",()=>t])},631259,e=>{"use strict";var r=e.i(920755);e.i(246704);var t=e.i(779478),a=e.i(790224),n=e.i(627404),i=e.i(34458);let o=new class{supabase;constructor(e){this.supabase=e||(0,r.createClient)()}async getAll(e,r){try{let t={};return r?.studentId&&(t.student_id=r.studentId),r?.status&&(t.status=r.status),r?.documentType&&(t.document_type=r.documentType),(0,n.getAllByOrganization)(this.supabase,"invoices",e,{select:"*, students(id, first_name, last_name, student_number), payments(id, amount, status, paid_at)",filters:t,search:r?.search?{field:"invoice_number",value:r.search}:void 0,orderBy:{column:"issue_date",ascending:!1}})}catch(r){if(r instanceof t.AppError)throw r;throw t.errorHandler.handleError(r,{organizationId:e,operation:"getAll"})}}async getById(e){try{return(0,n.getById)(this.supabase,"invoices",e,"*, students(*), enrollments(*), payments(*)")}catch(r){if(r instanceof t.AppError)throw r;throw t.errorHandler.handleError(r,{operation:"getById",id:e})}}async generateInvoiceNumber(e,r="invoice"){let t=new Date().getFullYear().toString(),{data:a}=await this.supabase.from("invoices").select("invoice_number").eq("organization_id",e).eq("document_type",r).like("invoice_number",`${t}-%`).order("invoice_number",{ascending:!1}).limit(1).maybeSingle(),n=1;if(a?.invoice_number){let e=a.invoice_number.split("-");e.length>=2&&e[0]===t&&(n=parseInt(e[1]||"0",10)+1)}return`${t}-${String(n).padStart(3,"0")}`}async create(e){try{(0,i.validateRequired)(e,["organization_id","student_id"]);let r=e.invoice_number;if(!r||""===r.trim()){let a=e.organization_id;if(!a)throw t.errorHandler.createValidationError("Organization ID is required to create an invoice.");r=await this.generateInvoiceNumber(a,e.document_type||"invoice")}let{data:n,error:o}=await this.supabase.from("invoices").insert({...e,invoice_number:r}).select().single();if(o){if("23505"===o.code)throw t.errorHandler.handleError(o,{code:t.ErrorCode.VALIDATION_UNIQUE_CONSTRAINT,operation:"create",field:"invoice_number"});if("42501"===o.code)throw t.errorHandler.handleError(o,{code:t.ErrorCode.DB_RLS_POLICY_VIOLATION,operation:"create"});throw t.errorHandler.handleError(o,{operation:"create",invoice:e})}return a.logger.info("Facture créée avec succès",{id:n?.id,organizationId:e.organization_id||void 0,invoiceNumber:n?.invoice_number}),n}catch(r){if(r instanceof t.AppError)throw r;throw t.errorHandler.handleError(r,{operation:"create",invoice:e})}}async update(e,r){try{let{data:n,error:i}=await this.supabase.from("invoices").update(r).eq("id",e).select().single();if(i){if("PGRST116"===i.code||"42P01"===i.code)throw t.errorHandler.handleError(i,{code:t.ErrorCode.DB_NOT_FOUND,operation:"update",id:e});if("42501"===i.code)throw t.errorHandler.handleError(i,{code:t.ErrorCode.DB_RLS_POLICY_VIOLATION,operation:"update",id:e});throw t.errorHandler.handleError(i,{operation:"update",id:e,updates:r})}if(!n)throw t.errorHandler.createDatabaseError(`Facture avec l'ID ${e} introuvable pour la mise \xe0 jour`,{id:e});return a.logger.info("Facture mise à jour avec succès",{id:e,updates:r}),n}catch(a){if(a instanceof t.AppError)throw a;throw t.errorHandler.handleError(a,{operation:"update",id:e,updates:r})}}async generateForClass(e,r,n,i,o,s="tuition"){let{data:l,error:c}=await this.supabase.from("students").select("id").eq("organization_id",e).eq("class_id",r).eq("status","active");if(c)throw t.errorHandler.handleError(c,{operation:"generateForClass",organizationId:e,classId:r,step:"fetchStudents"});if(!l||0===l.length)throw t.errorHandler.createValidationError("Aucun élève actif dans cette classe","classId");let{data:d}=await this.supabase.from("organizations").select("code").eq("id",e).single(),u=d?.code||"ORG",m=new Date().getFullYear().toString().slice(-2),{data:p}=await this.supabase.from("invoices").select("invoice_number").eq("organization_id",e).like("invoice_number",`FAC-${u}-${m}-%`).order("invoice_number",{ascending:!1}).limit(1).maybeSingle(),h=1;if(p?.invoice_number){let e=p.invoice_number.split("-");h=parseInt(e[e.length-1]||"0")+1}let _=l.map((r,t)=>({organization_id:e,student_id:r.id,invoice_number:`FAC-${u}-${m}-${String(h+t).padStart(6,"0")}`,type:s,document_type:"invoice",issue_date:new Date().toISOString().split("T")[0],due_date:o,amount:n,tax_amount:0,total_amount:n,currency:i,status:"draft",items:[]})),{data:f,error:g}=await this.supabase.from("invoices").insert(_).select();if(g)throw t.errorHandler.handleError(g,{operation:"generateForClass",organizationId:e,classId:r,count:_.length});return a.logger.info("Factures générées en masse avec succès",{organizationId:e,classId:r,count:f?.length||0}),f||[]}async getOverdue(e){let r=new Date().toISOString().split("T")[0];try{let{data:a,error:n}=await this.supabase.from("invoices").select("*, students(id, first_name, last_name, student_number)").eq("organization_id",e).eq("document_type","invoice").in("status",["sent","partial"]).lt("due_date",r).order("due_date",{ascending:!0});if(n)throw t.errorHandler.handleError(n,{operation:"getOverdue",organizationId:e});return a||[]}catch(r){if(r instanceof t.AppError)throw r;throw t.errorHandler.handleError(r,{operation:"getOverdue",organizationId:e})}}async convertQuoteToInvoice(e){try{let{data:r,error:n}=await this.supabase.from("invoices").select("*").eq("id",e).eq("document_type","quote").single();if(n){if("PGRST116"===n.code||"42P01"===n.code)throw t.errorHandler.handleError(n,{code:t.ErrorCode.DB_NOT_FOUND,operation:"convertQuoteToInvoice",quoteId:e});throw t.errorHandler.handleError(n,{operation:"convertQuoteToInvoice",quoteId:e,step:"fetchQuote"})}if(!r)throw t.errorHandler.createDatabaseError(`Devis avec l'ID ${e} introuvable`,{quoteId:e});let{data:i,error:o}=await this.supabase.from("invoices").update({document_type:"invoice",status:"draft",issue_date:r.issue_date||new Date().toISOString().split("T")[0]}).eq("id",e).select().single();if(o)throw t.errorHandler.handleError(o,{operation:"convertQuoteToInvoice",quoteId:e,step:"updateInvoice"});return a.logger.info("Devis converti en facture avec succès",{quoteId:e,invoiceId:i?.id}),i}catch(r){if(r instanceof t.AppError)throw r;throw t.errorHandler.handleError(r,{operation:"convertQuoteToInvoice",quoteId:e})}}};e.s(["invoiceService",0,o])},548347,e=>{"use strict";var r=e.i(920755);e.i(246704);var t=e.i(779478),a=e.i(790224),n=e.i(627404);let i=new class{supabase;constructor(e){this.supabase=e||(0,r.createClient)()}async getAll(e,r){try{let i={};r?.invoiceId&&(i.invoice_id=r.invoiceId),r?.studentId&&(i.student_id=r.studentId),r?.status&&(i.status=r.status);try{return await (0,n.getAllByOrganization)(this.supabase,"payments",e,{select:"*, invoices(*), students(id, first_name, last_name, student_number)",filters:i,orderBy:{column:"created_at",ascending:!1}})}catch(i){let r=i?.code||i?.originalError?.code,n=i?.message||String(i);if("PGRST116"===r||"42P01"===r||"PGRST200"===r||"PGRST301"===r||"400"===r||n?.includes("relation")||n?.includes("relationship")||n?.includes("does not exist")||n?.includes("schema cache"))return a.logger.warn("Payments table or relations not available, returning empty array",{organizationId:e,errorCode:r,errorMessage:n}),[];if(i instanceof t.AppError){let r=i.originalError;if(r){let t=r.code,n=r.message||"";if("PGRST116"===t||"42P01"===t||"PGRST200"===t||"PGRST301"===t||"400"===t||n.includes("relation")||n.includes("relationship")||n.includes("does not exist")||n.includes("schema cache"))return a.logger.warn("Payments table or relations not available (from AppError.originalError), returning empty array",{organizationId:e,errorCode:t,errorMessage:n}),[]}let t=i.context?.code;if("PGRST116"===t||"42P01"===t||"PGRST200"===t||"PGRST301"===t||"400"===t)return a.logger.warn("Payments table or relations not available (from AppError.context), returning empty array",{organizationId:e,errorCode:t}),[]}throw i}}catch(r){if(r instanceof t.AppError)throw r;throw t.errorHandler.handleError(r,{organizationId:e,operation:"getAll"})}}async getById(e){try{return(0,n.getById)(this.supabase,"payments",e,"*, invoices(*), students(*)")}catch(r){if(r instanceof t.AppError)throw r;throw t.errorHandler.handleError(r,{operation:"getById",id:e})}}async create(e){try{if(!e.amount||0>=Number(e.amount))throw t.errorHandler.createValidationError("Le montant doit être supérieur à 0","amount");if(!e.organization_id)throw t.errorHandler.createValidationError("L'organisation est obligatoire","organization_id");let{data:r,error:n}=await this.supabase.from("payments").insert(e).select().single();if(n){if("23505"===n.code)throw t.errorHandler.handleError(n,{code:t.ErrorCode.VALIDATION_UNIQUE_CONSTRAINT,operation:"create",field:"transaction_id"});if("42501"===n.code)throw t.errorHandler.handleError(n,{code:t.ErrorCode.DB_RLS_POLICY_VIOLATION,operation:"create"});throw t.errorHandler.handleError(n,{operation:"create",payment:e})}return e.invoice_id&&await this.updateInvoicePaymentStatus(e.invoice_id),a.logger.info("Paiement créé avec succès",{id:r?.id,organizationId:e.organization_id,amount:e.amount}),r}catch(r){if(r instanceof t.AppError)throw r;throw t.errorHandler.handleError(r,{operation:"create",payment:e})}}async update(e,r){try{let{data:n,error:i}=await this.supabase.from("payments").update(r).eq("id",e).select().single();if(i){if("PGRST116"===i.code||"42P01"===i.code)throw t.errorHandler.handleError(i,{code:t.ErrorCode.DB_NOT_FOUND,operation:"update",id:e});if("42501"===i.code)throw t.errorHandler.handleError(i,{code:t.ErrorCode.DB_RLS_POLICY_VIOLATION,operation:"update",id:e});throw t.errorHandler.handleError(i,{operation:"update",id:e,updates:r})}if(!n)throw t.errorHandler.createDatabaseError(`Paiement avec l'ID ${e} introuvable pour la mise \xe0 jour`,{id:e});if("completed"===r.status||"failed"===r.status){let r=await this.getById(e);if(r&&"object"==typeof r&&"invoice_id"in r){let e=r.invoice_id;e&&await this.updateInvoicePaymentStatus(e)}}return a.logger.info("Paiement mis à jour avec succès",{id:e,updates:r}),n}catch(a){if(a instanceof t.AppError)throw a;throw t.errorHandler.handleError(a,{operation:"update",id:e,updates:r})}}async updateInvoicePaymentStatus(e){try{let{data:r,error:a}=await this.supabase.from("payments").select("amount").eq("invoice_id",e).eq("status","completed");if(a)throw t.errorHandler.handleError(a,{operation:"updateInvoicePaymentStatus",invoiceId:e,step:"fetchPayments"});let n=r?.reduce((e,r)=>e+Number(r.amount),0)||0,{data:i,error:o}=await this.supabase.from("invoices").select("total_amount").eq("id",e).single();if(o)throw t.errorHandler.handleError(o,{operation:"updateInvoicePaymentStatus",invoiceId:e,step:"fetchInvoice"});if(!i)throw t.errorHandler.createDatabaseError(`Facture avec l'ID ${e} introuvable`,{invoiceId:e});let s="sent";n>=Number(i.total_amount)?s="paid":n>0&&(s="partial");let{data:l}=await this.supabase.from("invoices").select("due_date").eq("id",e).single();if(l){let e=new Date;new Date(l.due_date)<e&&"paid"!==s&&(s="overdue")}let{error:c}=await this.supabase.from("invoices").update({status:s}).eq("id",e);if(c)throw t.errorHandler.handleError(c,{operation:"updateInvoicePaymentStatus",invoiceId:e,step:"updateInvoice"})}catch(r){if(r instanceof t.AppError)throw r;throw t.errorHandler.handleError(r,{operation:"updateInvoicePaymentStatus",invoiceId:e})}}async recordMobileMoneyPayment(e,r,a,n,i,o){try{if(!i)throw t.errorHandler.createValidationError("L'ID de transaction est obligatoire","transactionId");let{data:s,error:l}=await this.supabase.from("invoices").select("organization_id, student_id").eq("id",e).single();if(l){if("PGRST116"===l.code||"42P01"===l.code)throw t.errorHandler.handleError(l,{code:t.ErrorCode.DB_NOT_FOUND,operation:"recordMobileMoneyPayment",invoiceId:e});throw t.errorHandler.handleError(l,{operation:"recordMobileMoneyPayment",invoiceId:e})}if(!s)throw t.errorHandler.createDatabaseError(`Facture avec l'ID ${e} introuvable`,{invoiceId:e});return this.create({organization_id:s.organization_id,invoice_id:e,student_id:s.student_id,amount:r,currency:a,payment_method:"mobile_money",payment_provider:n,transaction_id:i,status:"pending",metadata:{phone_number:o}})}catch(r){if(r instanceof t.AppError)throw r;throw t.errorHandler.handleError(r,{operation:"recordMobileMoneyPayment",invoiceId:e,provider:n})}}};e.s(["paymentService",0,i])},975831,e=>{"use strict";var r=e.i(843476),t=e.i(618566),a=e.i(266027),n=e.i(954616),i=e.i(912598),o=e.i(631259),s=e.i(548347),l=e.i(325715),c=e.i(920755),d=e.i(167881),u=e.i(970065),m=e.i(871689),p=e.i(107233),h=e.i(87316),_=e.i(178583),f=e.i(605631),g=e.i(738308),v=e.i(503116),y=e.i(561659),x=e.i(607486),b=e.i(440160),E=e.i(350627),w=e.i(522016),N=e.i(647163),j=e.i(271645),S=e.i(6799),D=e.i(69319),I=e.i(875976),T=e.i(330293),A=e.i(674824);function C(){let e=(0,t.useParams)();(0,t.useRouter)();let C=e.id,{user:R}=(0,l.useAuth)(),{addToast:H}=(0,S.useToast)(),O=(0,c.createClient)(),L=(0,i.useQueryClient)(),[q,B]=(0,j.useState)(!1),[F,P]=(0,j.useState)(!1),[z,k]=(0,j.useState)(!1),[U,V]=(0,j.useState)(!1),[M,$]=(0,j.useState)(!1),{data:Q,isLoading:Y,refetch:G}=(0,a.useQuery)({queryKey:["invoice",C],queryFn:()=>o.invoiceService.getById(C)}),{data:K,refetch:Z}=(0,a.useQuery)({queryKey:["payments",C],queryFn:async()=>R?.organization_id?s.paymentService.getAll(R.organization_id,{invoiceId:C}):[],enabled:!!C&&!!R?.organization_id}),{data:X}=(0,a.useQuery)({queryKey:["organization",R?.organization_id],queryFn:async()=>{if(!R?.organization_id)return null;let{data:e,error:r}=await O.from("organizations").select("*").eq("id",R.organization_id).single();if(r)throw r;return e},enabled:!!R?.organization_id}),{data:W}=(0,a.useQuery)({queryKey:["academic-year",R?.organization_id],queryFn:async()=>{if(!R?.organization_id)return null;let{data:e,error:r}=await O.from("academic_years").select("*").eq("organization_id",R.organization_id).eq("is_current",!0).maybeSingle();return r?(console.warn("Erreur lors de la récupération de l'année académique:",r),null):e||null},enabled:!!R?.organization_id}),{data:J}=(0,a.useQuery)({queryKey:["invoice-template",R?.organization_id],queryFn:async()=>{if(!R?.organization_id)return null;let e=await D.documentTemplateService.getTemplatesByType("facture",R.organization_id);return e.length>0?e[0]:null},enabled:!!R?.organization_id}),[ee,er]=(0,j.useState)({amount:"",currency:Q?.currency||"EUR",payment_method:"cash",payment_provider:"stripe",transaction_id:"",notes:""}),[et,ea]=(0,j.useState)({amount:"",reason:"",notes:""}),en=K?.filter(e=>"completed"===e.status).reduce((e,r)=>e+Number(r.amount),0)||0,ei=Q?Number(Q.total_amount)-en:0,eo=(0,n.useMutation)({mutationFn:async()=>{if(!Q)throw Error("Facture non trouvée");let e=parseFloat(ee.amount);if(isNaN(e)||e<=0)throw Error("Montant de paiement invalide");let r=K?.filter(e=>"completed"===e.status).reduce((e,r)=>e+Number(r.amount),0)||0;if(e>Number(Q.total_amount)-r)throw Error("Le montant du paiement ne peut pas dépasser le reste à payer");let t="cash"===ee.payment_method,a=t?new Date().toISOString():null;return s.paymentService.create({organization_id:Q.organization_id,invoice_id:C,student_id:Q.student_id,amount:e,currency:ee.currency,payment_method:ee.payment_method,payment_provider:"card"===ee.payment_method||"sepa"===ee.payment_method?ee.payment_provider:null,transaction_id:ee.transaction_id||null,status:t?"completed":"pending",paid_at:a,metadata:{notes:ee.notes}})},onSuccess:()=>{H({type:"success",title:"Paiement enregistré",description:"Le paiement a bien été enregistré et les totaux ont été mis à jour."}),B(!1),er({amount:"",currency:Q?.currency||"EUR",payment_method:"cash",payment_provider:"stripe",transaction_id:"",notes:""}),G(),Z(),L.refetchQueries({queryKey:["dashboard-stats",R?.organization_id]}),L.refetchQueries({queryKey:["revenue-evolution",R?.organization_id]}),L.refetchQueries({queryKey:["payment-stats",R?.organization_id]}),L.invalidateQueries({queryKey:["invoices"]}),L.invalidateQueries({queryKey:["overdue-invoices"]})},onError:e=>{H({type:"error",title:"Erreur lors de lenregistrement du paiement",description:e?.message||"Veuillez vérifier les informations saisies."})}}),es=(0,n.useMutation)({mutationFn:async()=>{if(!Q)throw Error("Facture non trouvée");let e=parseFloat(et.amount);if(isNaN(e)||e<=0)throw Error("Montant de l'avoir invalide");if(e>Number(Q.total_amount))throw Error("Le montant de l'avoir ne peut pas dépasser le montant total de la facture");let{data:r,error:t}=await O.from("invoices").insert({organization_id:Q.organization_id,student_id:Q.student_id,invoice_number:`AVOIR-${Q.invoice_number}`,type:"credit_note",document_type:"invoice",issue_date:new Date().toISOString().split("T")[0],due_date:new Date().toISOString().split("T")[0],amount:-e,tax_amount:0,total_amount:-e,currency:Q.currency,status:"sent",notes:`Avoir pour la facture ${Q.invoice_number}. Raison: ${et.reason}. ${et.notes}`,metadata:{original_invoice_id:Q.id,reason:et.reason,notes:et.notes}}).select().single();if(t)throw t;return r},onSuccess:()=>{H({type:"success",title:"Avoir créé",description:"L'avoir a été créé avec succès."}),V(!1),ea({amount:"",reason:"",notes:""}),G(),L.invalidateQueries({queryKey:["invoices"]})},onError:e=>{H({type:"error",title:"Erreur lors de la création de l'avoir",description:e?.message||"Veuillez vérifier les informations saisies."})}});if(Y)return(0,r.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,r.jsx)("div",{className:"text-center",children:(0,r.jsx)("div",{className:"text-muted-foreground",children:"Chargement..."})})});if(!Q)return(0,r.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,r.jsxs)("div",{className:"text-center",children:[(0,r.jsx)("div",{className:"text-muted-foreground",children:"Facture non trouvée"}),(0,r.jsx)(w.default,{href:"/dashboard/payments",children:(0,r.jsx)(d.Button,{className:"mt-4",children:"Retour à la liste"})})]})});let el=async()=>{if(!Q||!X||!J)return void H({type:"error",title:"Erreur",description:"Impossible de générer la facture. Données manquantes."});$(!0);try{let e=Q.students,r=(0,T.extractDocumentVariables)({student:e,organization:X,session:void 0,invoice:Q,academicYear:W,language:"fr",issueDate:Q.issue_date??void 0}),t=await (0,I.generateHTML)(J,r,void 0,R?.organization_id||void 0),a=`facture_${Q.invoice_number}.pdf`,n=document.createElement("div");n.style.position="absolute",n.style.left="-9999px",n.style.top="0",n.style.width="794px",n.style.minHeight="1123px",n.style.backgroundColor="#ffffff",n.style.overflow="visible",n.style.fontFamily="Arial, sans-serif",document.body.appendChild(n),n.innerHTML=new DOMParser().parseFromString(t.html,"text/html").body.innerHTML;let i=n.querySelector(".document-container")||n.querySelector('[id$="-document"]')||n.firstElementChild;i&&i instanceof HTMLElement||(i=n);let o=`temp-pdf-invoice-${Date.now()}`;if(i instanceof HTMLElement&&(i.id=o,i.style.width||(i.style.width="794px"),i.style.minHeight||(i.style.minHeight="1123px"),i.style.backgroundColor="#ffffff"),await new Promise(e=>setTimeout(e,1e3)),i instanceof HTMLElement){let e=i.getBoundingClientRect();(0===e.width||0===e.height)&&(i=n,n.id=o,n.style.width="794px",n.style.minHeight="1123px")}await (0,A.generatePDFFromHTML)(o,a),H({type:"success",title:"Facture téléchargée",description:"La facture a été générée et téléchargée avec succès."})}catch(e){console.error("Erreur lors de la génération de la facture:",e),H({type:"error",title:"Erreur",description:"Une erreur est survenue lors de la génération de la facture."})}finally{$(!1),document.querySelectorAll('[id^="temp-pdf-invoice-"]').forEach(e=>{e.parentNode===document.body&&document.body.removeChild(e)})}};return(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,r.jsx)(w.default,{href:"/dashboard/payments",children:(0,r.jsx)(d.Button,{variant:"ghost",size:"icon",children:(0,r.jsx)(m.ArrowLeft,{className:"h-4 w-4"})})}),(0,r.jsxs)("div",{children:[(0,r.jsxs)("h1",{className:"text-3xl font-bold text-gray-900",children:["Facture ",Q.invoice_number]}),(0,r.jsxs)("p",{className:"mt-2 text-sm text-gray-600",children:[Q.students?.first_name," ",Q.students?.last_name]})]})]}),(0,r.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,r.jsxs)(d.Button,{variant:"outline",onClick:el,disabled:M||!J,children:[(0,r.jsx)(b.Download,{className:"mr-2 h-4 w-4"}),M?"Génération...":"Télécharger la facture"]}),ei>0&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(d.Button,{onClick:()=>B(!q),children:[(0,r.jsx)(p.Plus,{className:"mr-2 h-4 w-4"}),"Enregistrer un paiement"]}),(0,r.jsxs)(d.Button,{variant:"outline",onClick:()=>P(!F),children:[(0,r.jsx)(y.CreditCard,{className:"mr-2 h-4 w-4"}),"Payer par carte"]}),(0,r.jsxs)(d.Button,{variant:"outline",onClick:()=>k(!z),children:[(0,r.jsx)(x.Building2,{className:"mr-2 h-4 w-4"}),"Virement SEPA"]})]}),(0,r.jsxs)(d.Button,{variant:"outline",onClick:()=>V(!U),children:[(0,r.jsx)(E.Receipt,{className:"mr-2 h-4 w-4"}),"Créer un avoir"]})]})]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[(0,r.jsxs)("div",{className:"lg:col-span-2 space-y-6",children:[(0,r.jsxs)(u.Card,{children:[(0,r.jsx)(u.CardHeader,{children:(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsx)(u.CardTitle,{children:"Détails de la facture"}),(0,r.jsx)("span",{className:`px-3 py-1 rounded text-sm font-medium ${(e=>{switch(e){case"paid":return"bg-success-bg text-success-primary";case"sent":return"bg-blue-100 text-blue-800";case"partial":return"bg-warning-bg text-warning-primary";case"overdue":return"bg-red-100 text-red-800";default:return"bg-gray-100 text-gray-800"}})(Q.status||"pending")}`,children:(e=>{switch(e){case"paid":return"Payée";case"sent":return"Envoyée";case"partial":return"Partielle";case"overdue":return"En retard";case"draft":return"Brouillon";default:return e}})(Q.status||"pending")})]})}),(0,r.jsxs)(u.CardContent,{className:"space-y-4",children:[(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsxs)("p",{className:"text-sm text-muted-foreground flex items-center mb-2",children:[(0,r.jsx)(_.FileText,{className:"mr-2 h-4 w-4"}),"Numéro"]}),(0,r.jsx)("p",{className:"font-medium",children:Q.invoice_number})]}),(0,r.jsxs)("div",{children:[(0,r.jsxs)("p",{className:"text-sm text-muted-foreground flex items-center mb-2",children:[(0,r.jsx)(h.Calendar,{className:"mr-2 h-4 w-4"}),"Type"]}),(0,r.jsx)("p",{className:"font-medium capitalize",children:Q.type})]})]}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"text-sm text-muted-foreground",children:"Date d'émission"}),(0,r.jsx)("p",{className:"font-medium",children:(0,N.formatDate)(Q.issue_date||"")})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"text-sm text-muted-foreground",children:"Date d'échéance"}),(0,r.jsx)("p",{className:`font-medium ${Q.due_date&&Q.due_date<new Date().toISOString().split("T")[0]&&"paid"!==Q.status?"text-red-600":""}`,children:(0,N.formatDate)(Q.due_date||"")})]})]}),(0,r.jsxs)("div",{className:"bg-gray-50 p-4 rounded-lg space-y-2",children:[(0,r.jsxs)("div",{className:"flex justify-between",children:[(0,r.jsx)("span",{className:"text-muted-foreground",children:"Montant HT:"}),(0,r.jsx)("span",{className:"font-medium",children:(0,N.formatCurrency)(Number(Q.amount),Q.currency)})]}),Number(Q.tax_amount)>0&&(0,r.jsxs)("div",{className:"flex justify-between",children:[(0,r.jsx)("span",{className:"text-muted-foreground",children:"TVA:"}),(0,r.jsx)("span",{className:"font-medium",children:(0,N.formatCurrency)(Number(Q.tax_amount),Q.currency)})]}),(0,r.jsxs)("div",{className:"flex justify-between pt-2 border-t",children:[(0,r.jsx)("span",{className:"font-semibold",children:"Total TTC:"}),(0,r.jsx)("span",{className:"font-bold text-lg",children:(0,N.formatCurrency)(Number(Q.total_amount),Q.currency)})]}),en>0&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{className:"flex justify-between pt-2 border-t",children:[(0,r.jsx)("span",{className:"text-muted-foreground",children:"Total payé:"}),(0,r.jsx)("span",{className:"font-medium text-success-primary",children:(0,N.formatCurrency)(en,Q.currency)})]}),ei>0&&(0,r.jsxs)("div",{className:"flex justify-between pt-2 border-t",children:[(0,r.jsx)("span",{className:"font-semibold",children:"Reste à payer:"}),(0,r.jsx)("span",{className:"font-bold text-lg text-red-600",children:(0,N.formatCurrency)(ei,Q.currency)})]})]})]}),Q.notes&&(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"text-sm text-muted-foreground mb-2",children:"Notes"}),(0,r.jsx)("p",{className:"text-gray-700 whitespace-pre-wrap",children:Q.notes})]})]})]}),(0,r.jsxs)(u.Card,{children:[(0,r.jsx)(u.CardHeader,{children:(0,r.jsx)(u.CardTitle,{children:"Historique des paiements"})}),(0,r.jsx)(u.CardContent,{children:K&&K.length>0?(0,r.jsx)("div",{className:"space-y-4",children:K.map(e=>(0,r.jsxs)("div",{className:"flex items-center justify-between p-4 border rounded-lg",children:[(0,r.jsxs)("div",{className:"flex items-center space-x-4",children:[(e=>{switch(e){case"completed":return(0,r.jsx)(f.CheckCircle,{className:"h-5 w-5 text-success-primary"});case"failed":return(0,r.jsx)(g.XCircle,{className:"h-5 w-5 text-red-600"});case"pending":case"processing":return(0,r.jsx)(v.Clock,{className:"h-5 w-5 text-warning-primary"});default:return null}})(e.status),(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"font-semibold",children:(0,N.formatCurrency)(Number(e.amount),e.currency)}),(0,r.jsxs)("p",{className:"text-sm text-muted-foreground",children:[(e=>{switch(e){case"cash":return"Espèces";case"card":return"Carte bancaire";case"bank_transfer":return"Virement bancaire";case"sepa":return"Virement SEPA";default:return e}})(e.payment_method),e.payment_provider&&` - ${e.payment_provider.toUpperCase()}`]}),e.transaction_id&&(0,r.jsxs)("p",{className:"text-xs text-muted-foreground",children:["Transaction: ",e.transaction_id]})]})]}),(0,r.jsxs)("div",{className:"text-right",children:[(0,r.jsx)("p",{className:"text-sm text-muted-foreground",children:e.paid_at?(0,N.formatDateTime)(e.paid_at):(0,N.formatDateTime)(e.created_at)}),(0,r.jsx)("span",{className:`inline-block px-2 py-1 rounded text-xs mt-1 ${"completed"===e.status?"bg-success-bg text-success-primary":"failed"===e.status?"bg-red-100 text-red-800":"bg-warning-bg text-warning-primary"}`,children:"completed"===e.status?"Complété":"failed"===e.status?"Échoué":"pending"===e.status?"En attente":e.status})]})]},e.id))}):(0,r.jsx)("div",{className:"text-center py-8 text-muted-foreground",children:"Aucun paiement enregistré"})})]})]}),q&&ei>0&&(0,r.jsx)("div",{className:"lg:col-span-1",children:(0,r.jsxs)(u.Card,{children:[(0,r.jsx)(u.CardHeader,{children:(0,r.jsx)(u.CardTitle,{children:"Enregistrer un paiement"})}),(0,r.jsx)(u.CardContent,{children:(0,r.jsxs)("form",{onSubmit:e=>{e.preventDefault(),eo.mutate()},className:"space-y-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Montant *"}),(0,r.jsx)("input",{type:"number",required:!0,step:"0.01",min:"0.01",max:ei,value:ee.amount,onChange:e=>er({...ee,amount:e.target.value}),className:"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target",placeholder:ei.toString()}),(0,r.jsxs)("p",{className:"text-xs text-muted-foreground mt-1",children:["Reste à payer: ",(0,N.formatCurrency)(ei,Q.currency)]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Méthode de paiement *"}),(0,r.jsxs)("select",{required:!0,value:ee.payment_method||"",onChange:e=>er({...ee,payment_method:e.target.value}),className:"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target",children:[(0,r.jsx)("option",{value:"cash",children:"Espèces"}),(0,r.jsx)("option",{value:"card",children:"Carte bancaire (Stripe)"}),(0,r.jsx)("option",{value:"sepa",children:"Virement SEPA"}),(0,r.jsx)("option",{value:"bank_transfer",children:"Virement bancaire"})]})]}),"card"===ee.payment_method&&(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Fournisseur *"}),(0,r.jsx)("select",{required:!0,value:ee.payment_provider||"",onChange:e=>er({...ee,payment_provider:e.target.value||"stripe"}),className:"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target",children:(0,r.jsx)("option",{value:"stripe",children:"Stripe"})})]}),"sepa"===ee.payment_method&&(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Fournisseur *"}),(0,r.jsx)("select",{required:!0,value:ee.payment_provider||"",onChange:e=>er({...ee,payment_provider:e.target.value||"stripe"}),className:"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target",children:(0,r.jsx)("option",{value:"sepa",children:"SEPA"})})]}),"cash"!==ee.payment_method&&(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2",children:"ID de transaction"}),(0,r.jsx)("input",{type:"text",value:ee.transaction_id,onChange:e=>er({...ee,transaction_id:e.target.value}),className:"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target",placeholder:"ID de la transaction"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Notes"}),(0,r.jsx)("textarea",{value:ee.notes,onChange:e=>er({...ee,notes:e.target.value}),rows:2,className:"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent",placeholder:"Notes supplémentaires..."})]}),eo.error&&(0,r.jsx)("div",{className:"bg-destructive/10 text-destructive px-4 py-3 rounded-lg text-sm",children:eo.error instanceof Error?eo.error.message:"Une erreur est survenue"}),(0,r.jsxs)("div",{className:"flex space-x-2",children:[(0,r.jsx)(d.Button,{type:"button",variant:"outline",className:"flex-1",onClick:()=>B(!1),children:"Annuler"}),(0,r.jsx)(d.Button,{type:"submit",className:"flex-1",disabled:eo.isPending,children:eo.isPending?"Enregistrement...":"Enregistrer"})]})]})})]})}),U&&(0,r.jsx)("div",{className:"lg:col-span-1",children:(0,r.jsxs)(u.Card,{children:[(0,r.jsx)(u.CardHeader,{children:(0,r.jsx)(u.CardTitle,{children:"Créer un avoir"})}),(0,r.jsx)(u.CardContent,{children:(0,r.jsxs)("form",{onSubmit:e=>{e.preventDefault(),es.mutate()},className:"space-y-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Montant de l'avoir *"}),(0,r.jsx)("input",{type:"number",required:!0,step:"0.01",min:"0.01",max:Number(Q.total_amount),value:et.amount,onChange:e=>ea({...et,amount:e.target.value}),className:"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target",placeholder:"0.00"}),(0,r.jsxs)("p",{className:"text-xs text-muted-foreground mt-1",children:["Montant total de la facture: ",(0,N.formatCurrency)(Number(Q.total_amount),Q.currency)]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Raison de l'avoir *"}),(0,r.jsxs)("select",{required:!0,value:et.reason,onChange:e=>ea({...et,reason:e.target.value}),className:"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target",children:[(0,r.jsx)("option",{value:"",children:"Sélectionner une raison"}),(0,r.jsx)("option",{value:"retour_produit",children:"Retour de produit/service"}),(0,r.jsx)("option",{value:"erreur_facturation",children:"Erreur de facturation"}),(0,r.jsx)("option",{value:"remise_commerciale",children:"Remise commerciale"}),(0,r.jsx)("option",{value:"annulation",children:"Annulation de commande"}),(0,r.jsx)("option",{value:"autre",children:"Autre"})]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Notes"}),(0,r.jsx)("textarea",{value:et.notes,onChange:e=>ea({...et,notes:e.target.value}),rows:3,className:"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent",placeholder:"Notes supplémentaires sur l'avoir..."})]}),es.error&&(0,r.jsx)("div",{className:"bg-destructive/10 text-destructive px-4 py-3 rounded-lg text-sm",children:es.error instanceof Error?es.error.message:"Une erreur est survenue"}),(0,r.jsxs)("div",{className:"flex space-x-2",children:[(0,r.jsx)(d.Button,{type:"button",variant:"outline",className:"flex-1",onClick:()=>{V(!1),ea({amount:"",reason:"",notes:""})},children:"Annuler"}),(0,r.jsx)(d.Button,{type:"submit",className:"flex-1",disabled:es.isPending,children:es.isPending?"Création...":"Créer l'avoir"})]})]})})]})})]})]})}e.s(["default",()=>C])},48503,e=>{e.v(e=>Promise.resolve().then(()=>e(915833)))},870653,e=>{e.v(r=>Promise.all(["static/chunks/e551d4a510c7c3c6.js"].map(r=>e.l(r))).then(()=>r(424154)))},195111,e=>{e.v(r=>Promise.all(["static/chunks/9fc253a1d558cb4a.js"].map(r=>e.l(r))).then(()=>r(38201)))}]);