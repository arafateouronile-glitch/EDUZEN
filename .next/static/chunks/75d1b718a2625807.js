(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,107233,e=>{"use strict";let t=(0,e.i(475254).default)("Plus",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]]);e.s(["Plus",()=>t],107233)},871689,e=>{"use strict";let t=(0,e.i(475254).default)("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]]);e.s(["ArrowLeft",()=>t],871689)},356909,e=>{"use strict";let t=(0,e.i(475254).default)("Save",[["path",{d:"M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z",key:"1owoqh"}],["polyline",{points:"17 21 17 13 7 13 7 21",key:"1md35c"}],["polyline",{points:"7 3 7 8 15 8",key:"8nz8an"}]]);e.s(["Save",()=>t],356909)},434249,e=>{"use strict";var t=e.i(920755);let s=new class{supabase;constructor(e){this.supabase=e||(0,t.createClient)()}async getTemplates(e){let{data:t,error:s}=await this.supabase.from("evaluation_templates").select(`
        *,
        questions:evaluation_template_questions(*)
      `).or(`organization_id.eq.${e},organization_id.is.null`).eq("is_active",!0).order("created_at",{ascending:!1});return s?(console.error("Erreur récupération modèles:",s),[]):t||[]}async getTemplateById(e){let{data:t,error:s}=await this.supabase.from("evaluation_templates").select(`
        *,
        questions:evaluation_template_questions(*)
      `).eq("id",e).single();return s?(console.error("Erreur récupération modèle:",s),null):t}async createTemplate(e,t,s){let{data:a,error:r}=await this.supabase.from("evaluation_templates").insert({...t,organization_id:e}).select().single();if(r)throw r;if(s.length>0){let e=s.map((e,t)=>({...e,template_id:a.id,order_index:e.order_index??t+1})),{error:t}=await this.supabase.from("evaluation_template_questions").insert(e);if(t)throw t}let i=await this.getTemplateById(a.id);if(!i)throw Error("Erreur lors de la récupération du modèle créé");return i}async updateTemplate(e,t,s){let{error:a}=await this.supabase.from("evaluation_templates").update(t).eq("id",e);if(a)throw a;if(void 0!==s){let{error:t}=await this.supabase.from("evaluation_template_questions").delete().eq("template_id",e);if(t)throw t;if(s.length>0){let t=s.map((t,s)=>({...t,template_id:e,order_index:t.order_index??s+1})),{error:a}=await this.supabase.from("evaluation_template_questions").insert(t);if(a)throw a}}let r=await this.getTemplateById(e);if(!r)throw Error("Erreur lors de la récupération du modèle mis à jour");return r}async deleteTemplate(e){let{error:t}=await this.supabase.from("evaluation_templates").delete().eq("id",e);if(t)throw t}async createInstance(e,t,s){let{data:a,error:r}=await this.supabase.from("evaluation_template_instances").insert({grade_id:e,template_id:t,max_score:s?.max_score,time_limit_minutes:s?.time_limit_minutes}).select().single();if(r)throw r;return a}async getInstanceByGradeId(e){try{let{data:t,error:s}=await this.supabase.from("evaluation_template_instances").select(`
          *,
          template:evaluation_templates(
            *,
            questions:evaluation_template_questions(*)
          ),
          grade:grades(*)
        `).eq("grade_id",e).single();if(s){if("PGRST116"===s.code)return null;throw s}return t}catch{return null}}async getResponses(e,t){let s=this.supabase.from("evaluation_responses").select("*").eq("instance_id",e);t&&(s=s.eq("student_id",t));let{data:a,error:r}=await s.order("created_at",{ascending:!0});return r?(console.error("Erreur récupération réponses:",r),[]):a||[]}async saveResponse(e,t,s,a){let{data:r,error:i}=await this.supabase.from("evaluation_responses").upsert({instance_id:e,question_id:t,student_id:s,answer_text:a.answer_text,answer_choice:a.answer_choice,answer_boolean:a.answer_boolean},{onConflict:"instance_id,question_id,student_id"}).select().single();if(i)throw i;return r}async autoCorrectResponses(e){let{data:t,error:s}=await this.supabase.rpc("auto_correct_evaluation_responses",{p_instance_id:e});if(s)throw s;return t||0}async calculateScore(e){let{data:t,error:s}=await this.supabase.rpc("calculate_evaluation_score",{p_instance_id:e});return s?(console.error("Erreur calcul score:",s),null):t&&0!==t.length?{total_score:Number(t[0].total_score)||0,max_score:Number(t[0].max_score)||0,percentage:Number(t[0].percentage)||0,correct_count:Number(t[0].correct_count)||0,total_questions:Number(t[0].total_questions)||0}:null}async updateGradeFromScore(e,t){let s=await this.calculateScore(t);if(!s)return;let{error:a}=await this.supabase.from("grades").update({score:s.total_score,max_score:s.max_score}).eq("id",e);if(a)throw a}};e.s(["evaluationTemplateService",0,s])},533726,e=>{"use strict";var t=e.i(843476),s=e.i(271645),a=e.i(266027),r=e.i(954616),i=e.i(912598),n=e.i(618566),o=e.i(325715),l=e.i(434249),c=e.i(970065),u=e.i(167881),d=e.i(23750),p=e.i(10708),m=e.i(184762),h=e.i(6799),x=e.i(871689),_=e.i(107233),v=e.i(727612),j=e.i(356909),g=e.i(522016);function f(){let e=(0,n.useParams)();(0,n.useRouter)();let f=e.id,{user:y}=(0,o.useAuth)(),w=(0,i.useQueryClient)(),{addToast:b}=(0,h.useToast)(),{data:q,isLoading:N}=(0,a.useQuery)({queryKey:["evaluation-template",f],queryFn:async()=>await l.evaluationTemplateService.getTemplateById(f),enabled:!!f}),[C,T]=(0,s.useState)({name:"",description:"",assessment_type:"",subject:"",max_score:20,passing_score:70,time_limit_minutes:null,shuffle_questions:!1,show_correct_answers:!0}),[L,S]=(0,s.useState)([]);(0,s.useEffect)(()=>{q&&(T({name:q.name,description:q.description||"",assessment_type:q.assessment_type||"",subject:q.subject||"",max_score:q.max_score||20,passing_score:q.passing_score||70,time_limit_minutes:q.time_limit_minutes??null,shuffle_questions:q.shuffle_questions||!1,show_correct_answers:!1!==q.show_correct_answers}),S((q.questions||[]).map(e=>({id:e.id,question_text:e.question_text,question_type:e.question_type,options:"string"==typeof e.options?JSON.parse(e.options):e.options,correct_answer:e.correct_answer||void 0,correct_answer_pattern:e.correct_answer_pattern||void 0,points:e.points||1,explanation:e.explanation||void 0,order_index:e.order_index||0}))))},[q]);let k=(0,r.useMutation)({mutationFn:async()=>{if(!C.name)throw Error("Le nom du modèle est requis");if(0===L.length)throw Error("Au moins une question est requise");return l.evaluationTemplateService.updateTemplate(f,{name:C.name,description:C.description||null,assessment_type:C.assessment_type||null,subject:C.subject||null,max_score:C.max_score,passing_score:C.passing_score||null,time_limit_minutes:C.time_limit_minutes||null,shuffle_questions:C.shuffle_questions,show_correct_answers:C.show_correct_answers},L.map(e=>({question_text:e.question_text,question_type:e.question_type,options:e.options?JSON.stringify(e.options):null,correct_answer:e.correct_answer||null,correct_answer_pattern:e.correct_answer_pattern||null,points:e.points,explanation:e.explanation||null,order_index:e.order_index})))},onSuccess:()=>{w.invalidateQueries({queryKey:["evaluation-template",f]}),w.invalidateQueries({queryKey:["evaluation-templates"]}),b({type:"success",title:"Modèle mis à jour",description:"Le modèle d'évaluation a été mis à jour avec succès."})},onError:e=>{b({type:"error",title:"Erreur",description:e.message||"Une erreur est survenue lors de la mise à jour."})}}),I=(e,t)=>{S(L.map(s=>{if(s.id===e){let e={...s,...t};return t.question_type&&t.question_type!==s.question_type&&("multiple_choice"===t.question_type?e.options=[{text:"",is_correct:!1},{text:"",is_correct:!1}]:e.options=void 0,e.correct_answer=void 0),e}return s}))},B=(e,t,s)=>{S(L.map(a=>a.id===e&&a.options?{...a,options:a.options.map((e,a)=>a===t?{...e,...s}:e)}:a))};return N?(0,t.jsx)("div",{className:"space-y-6",children:"Chargement..."}):q?(0,t.jsxs)("div",{className:"space-y-6",children:[(0,t.jsxs)("div",{className:"flex items-center gap-4",children:[(0,t.jsx)(g.default,{href:"/dashboard/evaluations/templates",children:(0,t.jsx)(u.Button,{variant:"ghost",size:"icon",children:(0,t.jsx)(x.ArrowLeft,{className:"h-4 w-4"})})}),(0,t.jsxs)("div",{children:[(0,t.jsx)("h1",{className:"text-3xl font-bold",children:"Modifier le modèle"}),(0,t.jsx)("p",{className:"text-muted-foreground mt-1",children:"Modifiez le modèle d'évaluation et ses questions"})]})]}),(0,t.jsxs)("form",{onSubmit:e=>{e.preventDefault(),k.mutate()},className:"space-y-6",children:[(0,t.jsxs)(c.Card,{children:[(0,t.jsx)(c.CardHeader,{children:(0,t.jsx)(c.CardTitle,{children:"Informations générales"})}),(0,t.jsxs)(c.CardContent,{className:"space-y-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)(p.Label,{htmlFor:"name",children:"Nom du modèle *"}),(0,t.jsx)(d.Input,{id:"name",value:C.name,onChange:e=>T({...C,name:e.target.value}),required:!0})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)(p.Label,{htmlFor:"description",children:"Description"}),(0,t.jsx)(m.Textarea,{id:"description",value:C.description,onChange:e=>T({...C,description:e.target.value}),rows:3})]}),(0,t.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)(p.Label,{htmlFor:"subject",children:"Sujet/Matière"}),(0,t.jsx)(d.Input,{id:"subject",value:C.subject,onChange:e=>T({...C,subject:e.target.value})})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)(p.Label,{htmlFor:"assessment_type",children:"Type d'évaluation"}),(0,t.jsxs)("select",{id:"assessment_type",value:C.assessment_type,onChange:e=>T({...C,assessment_type:e.target.value}),className:"w-full px-4 py-2 border rounded-lg",children:[(0,t.jsx)("option",{value:"",children:"Sélectionner..."}),(0,t.jsx)("option",{value:"pre_formation",children:"Pré-formation"}),(0,t.jsx)("option",{value:"hot",children:"À chaud"}),(0,t.jsx)("option",{value:"cold",children:"À froid"}),(0,t.jsx)("option",{value:"quiz",children:"Quiz"}),(0,t.jsx)("option",{value:"exam",children:"Examen"}),(0,t.jsx)("option",{value:"other",children:"Autre"})]})]})]}),(0,t.jsxs)("div",{className:"grid grid-cols-3 gap-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)(p.Label,{htmlFor:"max_score",children:"Note maximale"}),(0,t.jsx)(d.Input,{id:"max_score",type:"number",step:"0.01",min:"1",value:C.max_score,onChange:e=>T({...C,max_score:parseFloat(e.target.value)||20})})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)(p.Label,{htmlFor:"passing_score",children:"Score de réussite (%)"}),(0,t.jsx)(d.Input,{id:"passing_score",type:"number",step:"0.01",min:"0",max:"100",value:C.passing_score,onChange:e=>T({...C,passing_score:parseFloat(e.target.value)||70})})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)(p.Label,{htmlFor:"time_limit",children:"Durée (minutes)"}),(0,t.jsx)(d.Input,{id:"time_limit",type:"number",min:"1",value:C.time_limit_minutes||"",onChange:e=>T({...C,time_limit_minutes:e.target.value?parseInt(e.target.value):null}),placeholder:"Illimité"})]})]}),(0,t.jsxs)("div",{className:"flex items-center gap-4",children:[(0,t.jsxs)("label",{className:"flex items-center gap-2",children:[(0,t.jsx)("input",{type:"checkbox",checked:C.shuffle_questions,onChange:e=>T({...C,shuffle_questions:e.target.checked})}),(0,t.jsx)("span",{children:"Mélanger les questions"})]}),(0,t.jsxs)("label",{className:"flex items-center gap-2",children:[(0,t.jsx)("input",{type:"checkbox",checked:C.show_correct_answers,onChange:e=>T({...C,show_correct_answers:e.target.checked})}),(0,t.jsx)("span",{children:"Afficher les bonnes réponses après correction"})]})]})]})]}),(0,t.jsxs)(c.Card,{children:[(0,t.jsx)(c.CardHeader,{children:(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsx)(c.CardTitle,{children:"Questions"}),(0,t.jsxs)(u.Button,{type:"button",onClick:()=>{let e={id:`temp-${Date.now()}`,question_text:"",question_type:"multiple_choice",options:[{text:"",is_correct:!1},{text:"",is_correct:!1}],points:1,order_index:L.length+1};S([...L,e])},variant:"outline",children:[(0,t.jsx)(_.Plus,{className:"h-4 w-4 mr-2"}),"Ajouter une question"]})]})}),(0,t.jsx)(c.CardContent,{className:"space-y-6",children:0===L.length?(0,t.jsx)("div",{className:"text-center py-8 text-muted-foreground",children:'Aucune question. Cliquez sur "Ajouter une question" pour commencer.'}):L.map((e,s)=>(0,t.jsxs)(c.Card,{className:"border-2",children:[(0,t.jsx)(c.CardHeader,{children:(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)(c.CardTitle,{className:"text-base",children:["Question ",s+1]}),(0,t.jsx)(u.Button,{type:"button",variant:"ghost",size:"icon",onClick:()=>{var t;return t=e.id,void S(L.filter(e=>e.id!==t).map((e,t)=>({...e,order_index:t+1})))},children:(0,t.jsx)(v.Trash2,{className:"h-4 w-4 text-destructive"})})]})}),(0,t.jsxs)(c.CardContent,{className:"space-y-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)(p.Label,{children:"Texte de la question *"}),(0,t.jsx)(m.Textarea,{value:e.question_text,onChange:t=>I(e.id,{question_text:t.target.value}),rows:2,required:!0})]}),(0,t.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)(p.Label,{children:"Type de question *"}),(0,t.jsxs)("select",{value:e.question_type,onChange:t=>I(e.id,{question_type:t.target.value}),className:"w-full px-4 py-2 border rounded-lg",children:[(0,t.jsx)("option",{value:"multiple_choice",children:"Choix multiples"}),(0,t.jsx)("option",{value:"true_false",children:"Vrai/Faux"}),(0,t.jsx)("option",{value:"short_answer",children:"Réponse courte"}),(0,t.jsx)("option",{value:"numeric",children:"Numérique"}),(0,t.jsx)("option",{value:"essay",children:"Dissertation (correction manuelle)"})]})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)(p.Label,{children:"Points *"}),(0,t.jsx)(d.Input,{type:"number",step:"0.01",min:"0",value:e.points,onChange:t=>I(e.id,{points:parseFloat(t.target.value)||1}),required:!0})]})]}),"multiple_choice"===e.question_type&&e.options&&(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(p.Label,{children:"Options de réponse *"}),e.options.map((s,a)=>(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("input",{type:"checkbox",checked:s.is_correct,onChange:t=>B(e.id,a,{is_correct:t.target.checked})}),(0,t.jsx)(d.Input,{value:s.text,onChange:t=>B(e.id,a,{text:t.target.value}),placeholder:`Option ${a+1}`,className:"flex-1"}),e.options&&e.options.length>2&&(0,t.jsx)(u.Button,{type:"button",variant:"ghost",size:"icon",onClick:()=>{var t;return t=e.id,void S(L.map(e=>{if(e.id===t&&e.options){let t=e.options.filter((e,t)=>t!==a);return{...e,options:t.length>0?t:void 0}}return e}))},children:(0,t.jsx)(v.Trash2,{className:"h-4 w-4"})})]},a)),(0,t.jsxs)(u.Button,{type:"button",variant:"outline",size:"sm",onClick:()=>{var t;return t=e.id,void S(L.map(e=>e.id===t&&e.options?{...e,options:[...e.options,{text:"",is_correct:!1}]}:e))},children:[(0,t.jsx)(_.Plus,{className:"h-4 w-4 mr-2"}),"Ajouter une option"]})]}),"true_false"===e.question_type&&(0,t.jsxs)("div",{children:[(0,t.jsx)(p.Label,{children:"Bonne réponse *"}),(0,t.jsxs)("select",{value:e.correct_answer||"",onChange:t=>I(e.id,{correct_answer:t.target.value}),className:"w-full px-4 py-2 border rounded-lg",children:[(0,t.jsx)("option",{value:"",children:"Sélectionner..."}),(0,t.jsx)("option",{value:"true",children:"Vrai"}),(0,t.jsx)("option",{value:"false",children:"Faux"})]})]}),"short_answer"===e.question_type&&(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)(p.Label,{children:"Bonne réponse *"}),(0,t.jsx)(d.Input,{value:e.correct_answer||"",onChange:t=>I(e.id,{correct_answer:t.target.value})})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)(p.Label,{children:"Pattern regex (optionnel)"}),(0,t.jsx)(d.Input,{value:e.correct_answer_pattern||"",onChange:t=>I(e.id,{correct_answer_pattern:t.target.value})})]})]}),"numeric"===e.question_type&&(0,t.jsxs)("div",{children:[(0,t.jsx)(p.Label,{children:"Bonne réponse (nombre) *"}),(0,t.jsx)(d.Input,{type:"number",step:"0.01",value:e.correct_answer||"",onChange:t=>I(e.id,{correct_answer:t.target.value})})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)(p.Label,{children:"Explication (optionnel)"}),(0,t.jsx)(m.Textarea,{value:e.explanation||"",onChange:t=>I(e.id,{explanation:t.target.value}),rows:2})]})]})]},e.id))})]}),(0,t.jsxs)("div",{className:"flex items-center justify-end gap-4",children:[(0,t.jsx)(g.default,{href:"/dashboard/evaluations/templates",children:(0,t.jsx)(u.Button,{type:"button",variant:"outline",children:"Annuler"})}),(0,t.jsxs)(u.Button,{type:"submit",disabled:k.isPending||0===L.length,children:[(0,t.jsx)(j.Save,{className:"h-4 w-4 mr-2"}),k.isPending?"Sauvegarde...":"Enregistrer"]})]})]})]}):(0,t.jsx)("div",{className:"space-y-6",children:(0,t.jsxs)("div",{className:"text-center py-12",children:[(0,t.jsx)("h2",{className:"text-2xl font-bold mb-2",children:"Modèle non trouvé"}),(0,t.jsx)("p",{className:"text-muted-foreground mb-4",children:"Le modèle demandé n'existe pas ou a été supprimé."}),(0,t.jsx)(g.default,{href:"/dashboard/evaluations/templates",children:(0,t.jsxs)(u.Button,{children:[(0,t.jsx)(x.ArrowLeft,{className:"h-4 w-4 mr-2"}),"Retour aux modèles"]})})]})})}e.s(["default",()=>f])}]);