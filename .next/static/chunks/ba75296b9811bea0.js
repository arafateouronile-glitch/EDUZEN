(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,107233,e=>{"use strict";let t=(0,e.i(475254).default)("Plus",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]]);e.s(["Plus",()=>t],107233)},871689,e=>{"use strict";let t=(0,e.i(475254).default)("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]]);e.s(["ArrowLeft",()=>t],871689)},750570,e=>{"use strict";let t=(0,e.i(475254).default)("GripVertical",[["circle",{cx:"9",cy:"12",r:"1",key:"1vctgf"}],["circle",{cx:"9",cy:"5",r:"1",key:"hp0tcf"}],["circle",{cx:"9",cy:"19",r:"1",key:"fkjjf6"}],["circle",{cx:"15",cy:"12",r:"1",key:"1tmaij"}],["circle",{cx:"15",cy:"5",r:"1",key:"19l28e"}],["circle",{cx:"15",cy:"19",r:"1",key:"f4zoj3"}]]);e.s(["GripVertical",()=>t],750570)},434249,e=>{"use strict";var t=e.i(920755);let s=new class{supabase;constructor(e){this.supabase=e||(0,t.createClient)()}async getTemplates(e){let{data:t,error:s}=await this.supabase.from("evaluation_templates").select(`
        *,
        questions:evaluation_template_questions(*)
      `).or(`organization_id.eq.${e},organization_id.is.null`).eq("is_active",!0).order("created_at",{ascending:!1});return s?(console.error("Erreur récupération modèles:",s),[]):t||[]}async getTemplateById(e){let{data:t,error:s}=await this.supabase.from("evaluation_templates").select(`
        *,
        questions:evaluation_template_questions(*)
      `).eq("id",e).single();return s?(console.error("Erreur récupération modèle:",s),null):t}async createTemplate(e,t,s){let{data:r,error:a}=await this.supabase.from("evaluation_templates").insert({...t,organization_id:e}).select().single();if(a)throw a;if(s.length>0){let e=s.map((e,t)=>({...e,template_id:r.id,order_index:e.order_index??t+1})),{error:t}=await this.supabase.from("evaluation_template_questions").insert(e);if(t)throw t}let i=await this.getTemplateById(r.id);if(!i)throw Error("Erreur lors de la récupération du modèle créé");return i}async updateTemplate(e,t,s){let{error:r}=await this.supabase.from("evaluation_templates").update(t).eq("id",e);if(r)throw r;if(void 0!==s){let{error:t}=await this.supabase.from("evaluation_template_questions").delete().eq("template_id",e);if(t)throw t;if(s.length>0){let t=s.map((t,s)=>({...t,template_id:e,order_index:t.order_index??s+1})),{error:r}=await this.supabase.from("evaluation_template_questions").insert(t);if(r)throw r}}let a=await this.getTemplateById(e);if(!a)throw Error("Erreur lors de la récupération du modèle mis à jour");return a}async deleteTemplate(e){let{error:t}=await this.supabase.from("evaluation_templates").delete().eq("id",e);if(t)throw t}async createInstance(e,t,s){let{data:r,error:a}=await this.supabase.from("evaluation_template_instances").insert({grade_id:e,template_id:t,max_score:s?.max_score,time_limit_minutes:s?.time_limit_minutes}).select().single();if(a)throw a;return r}async getInstanceByGradeId(e){try{let{data:t,error:s}=await this.supabase.from("evaluation_template_instances").select(`
          *,
          template:evaluation_templates(
            *,
            questions:evaluation_template_questions(*)
          ),
          grade:grades(*)
        `).eq("grade_id",e).single();if(s){if("PGRST116"===s.code)return null;throw s}return t}catch{return null}}async getResponses(e,t){let s=this.supabase.from("evaluation_responses").select("*").eq("instance_id",e);t&&(s=s.eq("student_id",t));let{data:r,error:a}=await s.order("created_at",{ascending:!0});return a?(console.error("Erreur récupération réponses:",a),[]):r||[]}async saveResponse(e,t,s,r){let{data:a,error:i}=await this.supabase.from("evaluation_responses").upsert({instance_id:e,question_id:t,student_id:s,answer_text:r.answer_text,answer_choice:r.answer_choice,answer_boolean:r.answer_boolean},{onConflict:"instance_id,question_id,student_id"}).select().single();if(i)throw i;return a}async autoCorrectResponses(e){let{data:t,error:s}=await this.supabase.rpc("auto_correct_evaluation_responses",{p_instance_id:e});if(s)throw s;return t||0}async calculateScore(e){let{data:t,error:s}=await this.supabase.rpc("calculate_evaluation_score",{p_instance_id:e});return s?(console.error("Erreur calcul score:",s),null):t&&0!==t.length?{total_score:Number(t[0].total_score)||0,max_score:Number(t[0].max_score)||0,percentage:Number(t[0].percentage)||0,correct_count:Number(t[0].correct_count)||0,total_questions:Number(t[0].total_questions)||0}:null}async updateGradeFromScore(e,t){let s=await this.calculateScore(t);if(!s)return;let{error:r}=await this.supabase.from("grades").update({score:s.total_score,max_score:s.max_score}).eq("id",e);if(r)throw r}};e.s(["evaluationTemplateService",0,s])},82754,e=>{"use strict";var t=e.i(843476),s=e.i(271645),r=e.i(954616),a=e.i(912598),i=e.i(618566),n=e.i(325715),o=e.i(434249),l=e.i(970065),c=e.i(167881),u=e.i(23750),d=e.i(10708),p=e.i(184762),m=e.i(6799),h=e.i(871689),x=e.i(107233),_=e.i(727612),v=e.i(750570),j=e.i(522016);function g(){let e=(0,i.useRouter)(),{user:g}=(0,n.useAuth)(),f=(0,a.useQueryClient)(),{addToast:y}=(0,m.useToast)(),[b,w]=(0,s.useState)({name:"",description:"",assessment_type:"",subject:"",max_score:20,passing_score:70,time_limit_minutes:null,shuffle_questions:!1,show_correct_answers:!0}),[q,C]=(0,s.useState)([]),N=(0,r.useMutation)({mutationFn:async()=>{if(!g?.organization_id)throw Error("Organisation non trouvée");if(!b.name)throw Error("Le nom du modèle est requis");if(0===q.length)throw Error("Au moins une question est requise");return o.evaluationTemplateService.createTemplate(g.organization_id,{name:b.name,description:b.description||null,assessment_type:b.assessment_type||null,subject:b.subject||null,max_score:b.max_score,passing_score:b.passing_score||null,time_limit_minutes:b.time_limit_minutes||null,shuffle_questions:b.shuffle_questions,show_correct_answers:b.show_correct_answers},q.map(e=>({question_text:e.question_text,question_type:e.question_type,options:e.options?JSON.stringify(e.options):null,correct_answer:e.correct_answer||null,correct_answer_pattern:e.correct_answer_pattern||null,points:e.points,explanation:e.explanation||null,order_index:e.order_index})))},onSuccess:t=>{f.invalidateQueries({queryKey:["evaluation-templates"]}),y({type:"success",title:"Modèle créé",description:"Le modèle d'évaluation a été créé avec succès."}),t?.id&&e.push(`/dashboard/evaluations/templates/${t.id}`)},onError:e=>{y({type:"error",title:"Erreur",description:e.message||"Une erreur est survenue lors de la création."})}}),T=(e,t)=>{C(q.map(s=>{if(s.id===e){let e={...s,...t};return t.question_type&&t.question_type!==s.question_type&&("multiple_choice"===t.question_type?e.options=[{text:"",is_correct:!1},{text:"",is_correct:!1}]:e.options=void 0,e.correct_answer=void 0),e}return s}))},k=(e,t,s)=>{C(q.map(r=>r.id===e&&r.options?{...r,options:r.options.map((e,r)=>r===t?{...e,...s}:e)}:r))};return(0,t.jsxs)("div",{className:"space-y-6",children:[(0,t.jsxs)("div",{className:"flex items-center gap-4",children:[(0,t.jsx)(j.default,{href:"/dashboard/evaluations/templates",children:(0,t.jsx)(c.Button,{variant:"ghost",size:"icon",children:(0,t.jsx)(h.ArrowLeft,{className:"h-4 w-4"})})}),(0,t.jsxs)("div",{children:[(0,t.jsx)("h1",{className:"text-3xl font-bold",children:"Nouveau modèle d'évaluation"}),(0,t.jsx)("p",{className:"text-muted-foreground mt-1",children:"Créez un modèle avec questions et réponses pour correction automatique"})]})]}),(0,t.jsxs)("form",{onSubmit:e=>{e.preventDefault(),N.mutate()},className:"space-y-6",children:[(0,t.jsxs)(l.Card,{children:[(0,t.jsx)(l.CardHeader,{children:(0,t.jsx)(l.CardTitle,{children:"Informations générales"})}),(0,t.jsxs)(l.CardContent,{className:"space-y-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)(d.Label,{htmlFor:"name",children:"Nom du modèle *"}),(0,t.jsx)(u.Input,{id:"name",value:b.name,onChange:e=>w({...b,name:e.target.value}),placeholder:"Ex: Évaluation de fin de module",required:!0})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)(d.Label,{htmlFor:"description",children:"Description"}),(0,t.jsx)(p.Textarea,{id:"description",value:b.description,onChange:e=>w({...b,description:e.target.value}),placeholder:"Description du modèle d'évaluation",rows:3})]}),(0,t.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)(d.Label,{htmlFor:"subject",children:"Sujet/Matière"}),(0,t.jsx)(u.Input,{id:"subject",value:b.subject,onChange:e=>w({...b,subject:e.target.value}),placeholder:"Ex: Mathématiques"})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)(d.Label,{htmlFor:"assessment_type",children:"Type d'évaluation"}),(0,t.jsxs)("select",{id:"assessment_type",value:b.assessment_type,onChange:e=>w({...b,assessment_type:e.target.value}),className:"w-full px-4 py-2 border rounded-lg",children:[(0,t.jsx)("option",{value:"",children:"Sélectionner..."}),(0,t.jsx)("option",{value:"pre_formation",children:"Pré-formation"}),(0,t.jsx)("option",{value:"hot",children:"À chaud"}),(0,t.jsx)("option",{value:"cold",children:"À froid"}),(0,t.jsx)("option",{value:"quiz",children:"Quiz"}),(0,t.jsx)("option",{value:"exam",children:"Examen"}),(0,t.jsx)("option",{value:"other",children:"Autre"})]})]})]}),(0,t.jsxs)("div",{className:"grid grid-cols-3 gap-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)(d.Label,{htmlFor:"max_score",children:"Note maximale"}),(0,t.jsx)(u.Input,{id:"max_score",type:"number",step:"0.01",min:"1",value:b.max_score,onChange:e=>w({...b,max_score:parseFloat(e.target.value)||20})})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)(d.Label,{htmlFor:"passing_score",children:"Score de réussite (%)"}),(0,t.jsx)(u.Input,{id:"passing_score",type:"number",step:"0.01",min:"0",max:"100",value:b.passing_score,onChange:e=>w({...b,passing_score:parseFloat(e.target.value)||70})})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)(d.Label,{htmlFor:"time_limit",children:"Durée (minutes)"}),(0,t.jsx)(u.Input,{id:"time_limit",type:"number",min:"1",value:b.time_limit_minutes||"",onChange:e=>w({...b,time_limit_minutes:e.target.value?parseInt(e.target.value):null}),placeholder:"Illimité"})]})]}),(0,t.jsxs)("div",{className:"flex items-center gap-4",children:[(0,t.jsxs)("label",{className:"flex items-center gap-2",children:[(0,t.jsx)("input",{type:"checkbox",checked:b.shuffle_questions,onChange:e=>w({...b,shuffle_questions:e.target.checked})}),(0,t.jsx)("span",{children:"Mélanger les questions"})]}),(0,t.jsxs)("label",{className:"flex items-center gap-2",children:[(0,t.jsx)("input",{type:"checkbox",checked:b.show_correct_answers,onChange:e=>w({...b,show_correct_answers:e.target.checked})}),(0,t.jsx)("span",{children:"Afficher les bonnes réponses après correction"})]})]})]})]}),(0,t.jsxs)(l.Card,{children:[(0,t.jsx)(l.CardHeader,{children:(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsx)(l.CardTitle,{children:"Questions"}),(0,t.jsxs)(c.Button,{type:"button",onClick:()=>{let e={id:`temp-${Date.now()}`,question_text:"",question_type:"multiple_choice",options:[{text:"",is_correct:!1},{text:"",is_correct:!1}],points:1,order_index:q.length+1};C([...q,e])},variant:"outline",children:[(0,t.jsx)(x.Plus,{className:"h-4 w-4 mr-2"}),"Ajouter une question"]})]})}),(0,t.jsx)(l.CardContent,{className:"space-y-6",children:0===q.length?(0,t.jsx)("div",{className:"text-center py-8 text-muted-foreground",children:'Aucune question. Cliquez sur "Ajouter une question" pour commencer.'}):q.map((e,s)=>(0,t.jsxs)(l.Card,{className:"border-2",children:[(0,t.jsx)(l.CardHeader,{children:(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)(v.GripVertical,{className:"h-4 w-4 text-muted-foreground"}),(0,t.jsxs)(l.CardTitle,{className:"text-base",children:["Question ",s+1]})]}),(0,t.jsx)(c.Button,{type:"button",variant:"ghost",size:"icon",onClick:()=>{var t;return t=e.id,void C(q.filter(e=>e.id!==t).map((e,t)=>({...e,order_index:t+1})))},children:(0,t.jsx)(_.Trash2,{className:"h-4 w-4 text-destructive"})})]})}),(0,t.jsxs)(l.CardContent,{className:"space-y-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)(d.Label,{children:"Texte de la question *"}),(0,t.jsx)(p.Textarea,{value:e.question_text,onChange:t=>T(e.id,{question_text:t.target.value}),placeholder:"Entrez la question...",rows:2,required:!0})]}),(0,t.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)(d.Label,{children:"Type de question *"}),(0,t.jsxs)("select",{value:e.question_type,onChange:t=>T(e.id,{question_type:t.target.value}),className:"w-full px-4 py-2 border rounded-lg",children:[(0,t.jsx)("option",{value:"multiple_choice",children:"Choix multiples"}),(0,t.jsx)("option",{value:"true_false",children:"Vrai/Faux"}),(0,t.jsx)("option",{value:"short_answer",children:"Réponse courte"}),(0,t.jsx)("option",{value:"numeric",children:"Numérique"}),(0,t.jsx)("option",{value:"essay",children:"Dissertation (correction manuelle)"})]})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)(d.Label,{children:"Points *"}),(0,t.jsx)(u.Input,{type:"number",step:"0.01",min:"0",value:e.points,onChange:t=>T(e.id,{points:parseFloat(t.target.value)||1}),required:!0})]})]}),"multiple_choice"===e.question_type&&e.options&&(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(d.Label,{children:"Options de réponse *"}),e.options.map((s,r)=>(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("input",{type:"checkbox",checked:s.is_correct,onChange:t=>k(e.id,r,{is_correct:t.target.checked})}),(0,t.jsx)(u.Input,{value:s.text,onChange:t=>k(e.id,r,{text:t.target.value}),placeholder:`Option ${r+1}`,className:"flex-1"}),e.options&&e.options.length>2&&(0,t.jsx)(c.Button,{type:"button",variant:"ghost",size:"icon",onClick:()=>{var t;return t=e.id,void C(q.map(e=>{if(e.id===t&&e.options){let t=e.options.filter((e,t)=>t!==r);return{...e,options:t.length>0?t:void 0}}return e}))},children:(0,t.jsx)(_.Trash2,{className:"h-4 w-4"})})]},r)),(0,t.jsxs)(c.Button,{type:"button",variant:"outline",size:"sm",onClick:()=>{var t;return t=e.id,void C(q.map(e=>e.id===t&&e.options?{...e,options:[...e.options,{text:"",is_correct:!1}]}:e))},children:[(0,t.jsx)(x.Plus,{className:"h-4 w-4 mr-2"}),"Ajouter une option"]})]}),"true_false"===e.question_type&&(0,t.jsxs)("div",{children:[(0,t.jsx)(d.Label,{children:"Bonne réponse *"}),(0,t.jsxs)("select",{value:e.correct_answer||"",onChange:t=>T(e.id,{correct_answer:t.target.value}),className:"w-full px-4 py-2 border rounded-lg",children:[(0,t.jsx)("option",{value:"",children:"Sélectionner..."}),(0,t.jsx)("option",{value:"true",children:"Vrai"}),(0,t.jsx)("option",{value:"false",children:"Faux"})]})]}),"short_answer"===e.question_type&&(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)(d.Label,{children:"Bonne réponse *"}),(0,t.jsx)(u.Input,{value:e.correct_answer||"",onChange:t=>T(e.id,{correct_answer:t.target.value}),placeholder:"Réponse attendue"})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)(d.Label,{children:"Pattern regex (optionnel)"}),(0,t.jsx)(u.Input,{value:e.correct_answer_pattern||"",onChange:t=>T(e.id,{correct_answer_pattern:t.target.value}),placeholder:"Ex: ^(oui|yes)$ pour accepter 'oui' ou 'yes'"}),(0,t.jsx)("p",{className:"text-xs text-muted-foreground mt-1",children:"Permet une validation flexible (insensible à la casse par défaut)"})]})]}),"numeric"===e.question_type&&(0,t.jsxs)("div",{children:[(0,t.jsx)(d.Label,{children:"Bonne réponse (nombre) *"}),(0,t.jsx)(u.Input,{type:"number",step:"0.01",value:e.correct_answer||"",onChange:t=>T(e.id,{correct_answer:t.target.value}),placeholder:"Ex: 42"})]}),"essay"===e.question_type&&(0,t.jsxs)("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm text-blue-800",children:[(0,t.jsx)("strong",{children:"Note :"}),' Les questions de type "Dissertation" nécessitent une correction manuelle. La note sera attribuée par l\'enseignant après correction.']}),(0,t.jsxs)("div",{children:[(0,t.jsx)(d.Label,{children:"Explication (optionnel)"}),(0,t.jsx)(p.Textarea,{value:e.explanation||"",onChange:t=>T(e.id,{explanation:t.target.value}),placeholder:"Explication de la réponse correcte (affichée après correction)",rows:2})]})]})]},e.id))})]}),(0,t.jsxs)("div",{className:"flex items-center justify-end gap-4",children:[(0,t.jsx)(j.default,{href:"/dashboard/evaluations/templates",children:(0,t.jsx)(c.Button,{type:"button",variant:"outline",children:"Annuler"})}),(0,t.jsx)(c.Button,{type:"submit",disabled:N.isPending||0===q.length,children:N.isPending?"Création...":"Créer le modèle"})]})]})]})}e.s(["default",()=>g])}]);