(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,107233,e=>{"use strict";let t=(0,e.i(475254).default)("Plus",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]]);e.s(["Plus",()=>t],107233)},318216,e=>{"use strict";let t=(0,e.i(475254).default)("MoreVertical",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"12",cy:"5",r:"1",key:"gxeob9"}],["circle",{cx:"12",cy:"19",r:"1",key:"lyex9k"}]]);e.s(["MoreVertical",()=>t],318216)},604667,e=>{"use strict";var t=e.i(920755);let a=new class{supabase;constructor(e){this.supabase=e||(0,t.createClient)()}async getConversations(e,t){let{data:a,error:s}=await this.supabase.from("conversation_participants").select("conversation_id").eq("user_id",e);if(s)throw s;if(!a||0===a.length)return[];let r=a.map(e=>e.conversation_id),{data:i,error:n}=await this.supabase.from("conversations").select("*").eq("organization_id",t).eq("is_archived",!1).in("id",r).order("last_message_at",{ascending:!1,nullsFirst:!1});if(n)throw n;if(!i||0===i.length)return[];let{data:o}=await this.supabase.from("conversation_participants").select("*").in("conversation_id",r),d=[...new Set((o||[]).filter(e=>e.user_id).map(e=>e.user_id))],l=[...new Set((o||[]).filter(e=>e.student_id).map(e=>e.student_id))],u={};if(d.length>0){let{data:e}=await this.supabase.from("users").select("id, full_name, email, avatar_url").in("id",d);e?.forEach(e=>{u[e.id]=e})}let c={};if(l.length>0){let{data:e}=await this.supabase.from("students").select("id, first_name, last_name, email, student_number").in("id",l);e?.forEach(e=>{c[e.id]=e})}let m=i.map(e=>this.supabase.from("messages").select("*").eq("conversation_id",e.id).eq("is_deleted",!1).order("created_at",{ascending:!1}).limit(1).maybeSingle()),h=await Promise.all(m),g=[...new Set(h.filter(e=>e.data?.sender_id).map(e=>e.data.sender_id))],p=[...new Set(h.filter(e=>e.data?.student_sender_id).map(e=>e.data.student_sender_id))];if(g.length>0){let{data:e}=await this.supabase.from("users").select("id, full_name, email").in("id",g.filter(e=>!u[e]));e?.forEach(e=>{u[e.id]=e})}if(p.length>0){let{data:e}=await this.supabase.from("students").select("id, first_name, last_name, email, student_number").in("id",p.filter(e=>!c[e]));e?.forEach(e=>{c[e.id]=e})}return i.map((e,t)=>{let a=(o||[]).filter(t=>t.conversation_id===e.id).map(e=>({...e,user:e.user_id&&u[e.user_id]||null,student:e.student_id&&c[e.student_id]||null})),s=h[t].data,r=null;return s&&(r={...s,sender:s.sender_id&&u[s.sender_id]||null,student_sender:s.student_sender_id&&c[s.student_sender_id]||null}),{...e,participants:a,last_message:r}})}async getConversationsByStudentId(e,t){let{data:a,error:s}=await this.supabase.from("conversation_participants").select("conversation_id").eq("student_id",e);if(s)throw s;if(!a||0===a.length)return[];let r=a.map(e=>e.conversation_id),{data:i,error:n}=await this.supabase.from("conversations").select("*").eq("organization_id",t).eq("is_archived",!1).in("id",r).order("last_message_at",{ascending:!1,nullsFirst:!1});if(n)throw n;return i&&0!==i.length?await Promise.all(i.map(async e=>{let{data:t}=await this.supabase.from("conversation_participants").select("*").eq("conversation_id",e.id),a=await Promise.all((t||[]).map(async e=>{let t=null,a=null;if(e.user_id){let{data:a}=await this.supabase.from("users").select("id, full_name, email, avatar_url").eq("id",e.user_id).maybeSingle();t=a}if(e.student_id){let{data:t}=await this.supabase.from("students").select("id, first_name, last_name, email, student_number").eq("id",e.student_id).maybeSingle();a=t}return{...e,user:t,student:a}})),{data:s}=await this.supabase.from("messages").select("*").eq("conversation_id",e.id).eq("is_deleted",!1).order("created_at",{ascending:!1}).limit(1),r=null;if(s&&s.length>0){let e=s[0],t=null;if(e.sender_id){let{data:a}=await this.supabase.from("users").select("id, full_name, email").eq("id",e.sender_id).maybeSingle();t=a}r={...e,sender:t}}return{...e,participants:a,last_message:r}})):[]}async getConversationById(e){let{data:t,error:a}=await this.supabase.from("conversations").select("id, organization_id, conversation_type, name, created_by, created_at, updated_at, is_archived, last_message_at").eq("id",e).maybeSingle();if(a)throw console.error("[MESSAGING] Erreur récupération conversation:",a),a;if(!t)return null;let{data:s,error:r}=await this.supabase.from("conversation_participants").select("*").eq("conversation_id",e);if(r)throw r;let i=await Promise.all((s||[]).map(async e=>{let t=null,a=null;if(e.user_id){let{data:a}=await this.supabase.from("users").select("id, full_name, email, avatar_url").eq("id",e.user_id).maybeSingle();t=a}if(e.student_id){let{data:t}=await this.supabase.from("students").select("id, first_name, last_name, email, student_number").eq("id",e.student_id).maybeSingle();a=t}return{...e,user:t,student:a}}));return{...t,participants:i}}async createDirectConversation(e,t,a,s){let{data:r,error:i}=await this.supabase.from("conversations").select("id").eq("conversation_type","direct").eq("organization_id",a);if(!i&&r&&r.length>0){let a=r.map(e=>e.id),{data:i,error:n}=await this.supabase.from("conversation_participants").select("conversation_id").eq("user_id",e).in("conversation_id",a);if(!n&&i&&i.length>0){let e=i.map(e=>e.conversation_id),a=this.supabase.from("conversation_participants").select("conversation_id").in("conversation_id",e);t?a=a.eq("user_id",t):s&&(a=a.eq("student_id",s));let{data:r}=await a.maybeSingle();if(r)return this.getConversationById(r.conversation_id)}}let{data:n,error:o}=await this.supabase.from("conversations").insert({organization_id:a,conversation_type:"direct",created_by:e}).select().single();if(o)throw o;return await this.addParticipant(n.id,e,"member"),await this.addParticipant(n.id,t,"member",s),this.getConversationById(n.id)}async createGroupConversation(e,t,a,s,r){let{data:i,error:n}=await this.supabase.from("conversations").insert({organization_id:a,conversation_type:"group",name:e,created_by:s}).select().single();if(n)throw n;for(let e of t)await this.addParticipant(i.id,e,e===s?"owner":"member");if(r&&r.length>0)for(let e of r)await this.addParticipant(i.id,null,"member",e);return this.getConversationById(i.id)}async updateConversation(e,t){let{data:a,error:s}=await this.supabase.from("conversations").update(t).eq("id",e).select().single();if(s)throw s;return a}async archiveConversation(e){return this.updateConversation(e,{is_archived:!0})}async deleteConversation(e){return this.updateConversation(e,{is_archived:!0})}async pinConversation(e,t){return this.updateConversation(e,{is_pinned:t})}async addParticipant(e,t,a="member",s){let r={conversation_id:e,role:a};if(t)r.user_id=t;else if(s)r.student_id=s;else throw Error("Either userId or studentId must be provided");let{data:i,error:n}=await this.supabase.from("conversation_participants").insert(r).select().single();if(n)throw n;return i}async removeParticipant(e,t){let{error:a}=await this.supabase.from("conversation_participants").delete().eq("conversation_id",e).eq("user_id",t);if(a)throw a}async updateParticipantRole(e,t,a){let{data:s,error:r}=await this.supabase.from("conversation_participants").update({role:a}).eq("conversation_id",e).eq("user_id",t).select().single();if(r)throw r;return s}async muteConversation(e,t,a){let{data:s,error:r}=await this.supabase.from("conversation_participants").update({is_muted:a}).eq("conversation_id",e).eq("user_id",t).select().single();if(r)throw r;return s}async markAsRead(e,t){let{error:a}=await this.supabase.from("conversation_participants").update({last_read_at:new Date().toISOString()}).eq("conversation_id",e).eq("user_id",t);if(a)throw a;let{data:s}=await this.supabase.from("messages").select("id").eq("conversation_id",e).not("sender_id","eq",t);if(s)for(let e of s)await this.supabase.from("message_reads").upsert({message_id:e.id,user_id:t,read_at:new Date().toISOString()})}async getMessages(e,t=50,a=0){let{data:s,error:r}=await this.supabase.from("messages").select("*").eq("conversation_id",e).eq("is_deleted",!1).order("created_at",{ascending:!1}).range(a,a+t-1);if(r)throw r;return s&&0!==s.length?(await Promise.all(s.map(async e=>{let t=null,a=null,s=null;if(e.sender_id){let{data:a}=await this.supabase.from("users").select("id, full_name, email, avatar_url").eq("id",e.sender_id).maybeSingle();t=a}if(e.student_sender_id){let{data:t}=await this.supabase.from("students").select("id, first_name, last_name, email, student_number").eq("id",e.student_sender_id).maybeSingle();a=t}if(e.reply_to_id){let{data:t}=await this.supabase.from("messages").select("*").eq("id",e.reply_to_id).maybeSingle();if(t){let e=null,a=null;if(t.sender_id){let{data:a}=await this.supabase.from("users").select("id, full_name").eq("id",t.sender_id).maybeSingle();e=a}if(t.student_sender_id){let{data:e}=await this.supabase.from("students").select("id, first_name, last_name, email, student_number").eq("id",t.student_sender_id).maybeSingle();a=e}s={...t,sender:e,student_sender:a}}}return{...e,sender:t,student_sender:a,reply_to:s}}))).reverse():[]}async uploadAttachment(e,t){let a=e.name.split(".").pop(),s=`${Date.now()}-${Math.random().toString(36).substring(7)}.${a}`,r=`${t}/${s}`,{data:i,error:n}=await this.supabase.storage.from("messages").upload(r,e,{cacheControl:"3600",upsert:!1});if(n)throw n;return r}async getAttachmentUrl(e){let{data:t,error:a}=await this.supabase.storage.from("messages").createSignedUrl(e,3600);if(a)throw a;return t.signedUrl}async sendMessage(e){let{data:t,error:a}=await this.supabase.from("messages").insert(e).select("*").single();if(a)throw a;let s=null,r=null;if(t.sender_id){let{data:e}=await this.supabase.from("users").select("id, full_name, email, avatar_url").eq("id",t.sender_id).maybeSingle();s=e}if(t.student_sender_id){let{data:e}=await this.supabase.from("students").select("id, first_name, last_name, email, student_number").eq("id",t.student_sender_id).maybeSingle();r=e}return{...t,sender:s,student_sender:r}}async updateMessage(e,t){let{data:a,error:s}=await this.supabase.from("messages").update({content:t,is_edited:!0}).eq("id",e).select().single();if(s)throw s;return a}async deleteMessage(e){let{data:t,error:a}=await this.supabase.from("messages").update({is_deleted:!0,deleted_at:new Date().toISOString(),content:"Message supprimé"}).eq("id",e).select().single();if(a)throw a;return t}async addReaction(e,t,a){let{data:s}=await this.supabase.from("messages").select("reactions").eq("id",e).single();if(!s)throw Error("Message non trouvé");let r=s.reactions||{};r[a]||(r[a]=[]),r[a].includes(t)||r[a].push(t);let{data:i,error:n}=await this.supabase.from("messages").update({reactions:r}).eq("id",e).select().single();if(n)throw n;return i}async removeReaction(e,t,a){let{data:s}=await this.supabase.from("messages").select("reactions").eq("id",e).single();if(!s)throw Error("Message non trouvé");let r=s.reactions||{};r[a]&&(r[a]=r[a].filter(e=>e!==t),0===r[a].length&&delete r[a]);let{data:i,error:n}=await this.supabase.from("messages").update({reactions:r}).eq("id",e).select().single();if(n)throw n;return i}async pinMessage(e,t,a){let{data:s,error:r}=await this.supabase.from("pinned_messages").insert({conversation_id:e,message_id:t,pinned_by:a}).select().single();if(r)throw r;return s}async unpinMessage(e,t){let{error:a}=await this.supabase.from("pinned_messages").delete().eq("conversation_id",e).eq("message_id",t);if(a)throw a}async getPinnedMessages(e){let{data:t,error:a}=await this.supabase.from("pinned_messages").select(`
        *,
        message:messages(*, sender:users(id, full_name, email)),
        pinned_by_user:users(id, full_name)
      `).eq("conversation_id",e).order("pinned_at",{ascending:!1});if(a)throw a;return t}async createCall(e){let{data:t,error:a}=await this.supabase.from("calls").insert(e).select().single();if(a)throw a;return t}async updateCallStatus(e,t,a){let s={status:t};"active"===t?s.started_at=new Date().toISOString():"ended"===t&&(s.ended_at=new Date().toISOString(),a&&(s.duration_seconds=a));let{data:r,error:i}=await this.supabase.from("calls").update(s).eq("id",e).select().single();if(i)throw i;return r}async addCallParticipant(e,t){let{data:a,error:s}=await this.supabase.from("call_participants").insert({call_id:e,user_id:t,status:"joined",joined_at:new Date().toISOString()}).select().single();if(s)throw s;return a}async getNotifications(e,t=!1){let a=this.supabase.from("message_notifications").select(`
        *,
        conversation:conversations(*),
        message:messages(*, sender:users(id, full_name, email))
      `).eq("user_id",e);t&&(a=a.eq("is_read",!1));let{data:s,error:r}=await a.order("created_at",{ascending:!1}).limit(50);if(r)throw r;return s}async markNotificationAsRead(e){let{data:t,error:a}=await this.supabase.from("message_notifications").update({is_read:!0,read_at:new Date().toISOString()}).eq("id",e).select().single();if(a)throw a;return t}async markAllNotificationsAsRead(e){let{error:t}=await this.supabase.from("message_notifications").update({is_read:!0,read_at:new Date().toISOString()}).eq("user_id",e).eq("is_read",!1);if(t)throw t}async searchMessages(e,t){let{data:a,error:s}=await this.supabase.from("messages").select(`
        *,
        sender:users(id, full_name, email, avatar_url)
      `).eq("conversation_id",e).eq("is_deleted",!1).ilike("content",`%${t}%`).order("created_at",{ascending:!1}).limit(50);if(s)throw s;return a}};e.s(["messagingService",0,a])},437905,e=>{"use strict";var t=e.i(843476),a=e.i(271645),s=e.i(618566),r=e.i(266027),i=e.i(954616),n=e.i(912598),o=e.i(325715),d=e.i(604667),l=e.i(920755),u=e.i(970065),c=e.i(23750),m=e.i(167881),h=e.i(630374),g=e.i(555436),p=e.i(686311),b=e.i(761911),f=e.i(107233),_=e.i(318216),v=e.i(629377),x=e.i(727612),y=e.i(522016),w=e.i(647163),j=e.i(6799),N=e.i(463415);function q(){let e=(0,s.useRouter)(),{user:q}=(0,o.useAuth)(),C=(0,l.createClient)(),S=(0,n.useQueryClient)(),{addToast:z}=(0,j.useToast)(),[k,M]=(0,a.useState)(""),[P,E]=(0,a.useState)(!1),[I,$]=(0,a.useState)(""),[D,L]=(0,a.useState)("personal"),[A,U]=(0,a.useState)(""),[F,R]=(0,a.useState)(""),{data:B}=(0,r.useQuery)({queryKey:["conversations",q?.id,q?.organization_id],queryFn:()=>d.messagingService.getConversations(q?.id||"",q?.organization_id||""),enabled:!!q?.id&&!!q?.organization_id}),O=(0,i.useMutation)({mutationFn:async e=>d.messagingService.deleteConversation(e),onSuccess:()=>{S.invalidateQueries({queryKey:["conversations"]}),z({type:"success",title:"Conversation supprimée",description:"La conversation a été supprimée avec succès."})},onError:e=>{z({type:"error",title:"Erreur",description:"Impossible de supprimer la conversation. Veuillez réessayer."})}}),{data:K,isLoading:T}=(0,r.useQuery)({queryKey:["sessions-for-messages",q?.organization_id],queryFn:async()=>{if(!q?.organization_id)return[];let{data:e,error:t}=await C.from("sessions").select("id, name, start_date, end_date, formations(name)").eq("organization_id",q.organization_id).order("start_date",{ascending:!1}).limit(100);if(t)throw t;return e||[]},enabled:!!q?.organization_id&&P}),{data:Q,isLoading:G}=(0,r.useQuery)({queryKey:["session-students",A],queryFn:async()=>{if(!A)return[];let{data:e,error:t}=await C.from("enrollments").select(`
          student_id,
          status,
          students!inner(id, first_name, last_name, student_number, email)
        `).eq("session_id",A);if(t)throw console.error("Erreur récupération inscriptions:",t),t;if(!e||0===e.length)return[];let a=e.filter(e=>{let t=e.status;return"cancelled"!==t&&"rejected"!==t&&"dropped"!==t});return 0===a.length?[]:a.map(e=>({student:e.students,user:null,enrollmentId:e.student_id}))},enabled:!!A&&"personal"===D}),{data:V,isLoading:H}=(0,r.useQuery)({queryKey:["organization-users",q?.organization_id],queryFn:async()=>{if(!q?.organization_id)return[];let{data:e,error:t}=await C.from("users").select("id, full_name, email, avatar_url, role").eq("organization_id",q.organization_id).neq("id",q.id).order("full_name");if(t)throw t;return e||[]},enabled:!!q?.organization_id&&P&&"personal"===D&&!A}),J=(0,i.useMutation)({mutationFn:async({userId:e,studentId:t})=>{if(!q?.id||!q?.organization_id)throw Error("Utilisateur non authentifié");if(!e&&!t)throw Error("Either userId or studentId must be provided");try{return await d.messagingService.createDirectConversation(q.id,e||null,q.organization_id,t||null)}catch(e){throw e}},onSuccess:t=>{S.invalidateQueries({queryKey:["conversations"]}),E(!1),X(),t?.id&&e.push(`/dashboard/messages/${t.id}`),z({type:"success",title:"Conversation créée",description:"La conversation a été créée avec succès."})},onError:e=>{z({type:"error",title:"Erreur",description:e instanceof Error?e.message:"Une erreur est survenue lors de la création de la conversation."})}}),W=(0,i.useMutation)({mutationFn:async()=>{if(!q?.id||!q?.organization_id)throw Error("Utilisateur non authentifié");if(!A)throw Error("Veuillez sélectionner une session");let{data:e,error:t}=await C.from("enrollments").select(`
          student_id,
          status,
          students!inner(id, email)
        `).eq("session_id",A);if(t)throw t;let a=(e||[]).filter(e=>{let t=e.status;return"cancelled"!==t&&"rejected"!==t&&"dropped"!==t}).map(e=>e.students?.id).filter(e=>e),s=[];if(a.length>0){let{data:e,error:t}=await C.from("users").select("id").in("id",a).eq("organization_id",q.organization_id);!t&&e&&(s=e.map(e=>e.id).filter(e=>e!==q.id))}let r=a.filter(e=>!s.includes(e)&&e!==q.id),i=[q.id,...s],n=K?.find(e=>e.id===A),o=n?`Session: ${n.name}`:"Groupe de session";return d.messagingService.createGroupConversation(o,i,q.organization_id,q.id,r)},onSuccess:t=>{S.invalidateQueries({queryKey:["conversations"]}),E(!1),X(),t?.id&&e.push(`/dashboard/messages/${t.id}`),z({type:"success",title:"Conversation de groupe créée",description:"La conversation de groupe a été créée avec succès."})},onError:e=>{z({type:"error",title:"Erreur",description:e instanceof Error?e.message:"Une erreur est survenue lors de la création de la conversation de groupe."})}}),X=()=>{$(""),L("personal"),U(""),R("")};V?.filter(e=>{if(!I)return!0;let t=I.toLowerCase();return e.full_name?.toLowerCase().includes(t)||e.email?.toLowerCase().includes(t)});let Y=e=>{if("group"===e.conversation_type&&e.name)return e.name;if(e.participants){let t=e.participants.find(e=>e.user_id!==q?.id);if(t?.user)return t.user.full_name||t.user.email||"Conversation";if(t?.student)return`${t.student.first_name||""} ${t.student.last_name||""}`.trim()||t.student.email||`Candidat ${t.student.student_number||""}`||"Conversation"}return"Conversation"},Z=B?.filter(e=>!k||Y(e).toLowerCase().includes(k.toLowerCase()));return(0,t.jsxs)("div",{className:"container mx-auto py-8 px-4 max-w-7xl",children:[(0,t.jsxs)("div",{className:"mb-8",children:[(0,t.jsxs)("div",{className:"flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6 mb-6",children:[(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsxs)("div",{className:"inline-flex items-center gap-3 mb-2",children:[(0,t.jsx)("div",{className:"p-2.5 bg-gradient-to-br from-brand-blue to-brand-cyan rounded-xl shadow-lg",children:(0,t.jsx)(p.MessageSquare,{className:"h-7 w-7 text-white"})}),(0,t.jsx)("h1",{className:"text-3xl lg:text-4xl font-bold bg-gradient-to-r from-brand-blue to-brand-cyan bg-clip-text text-transparent",children:"Messages"})]}),(0,t.jsx)("p",{className:"text-gray-600 text-sm lg:text-base ml-1",children:"Communiquez avec vos collègues et candidats"})]}),(0,t.jsxs)(m.Button,{onClick:()=>E(!0),className:"bg-gradient-to-r from-brand-blue to-brand-cyan hover:from-brand-blue-dark hover:to-brand-cyan shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105",children:[(0,t.jsx)(f.Plus,{className:"h-4 w-4 mr-2"}),"Nouvelle conversation"]})]}),(0,t.jsx)(u.Card,{className:"border-brand-blue/20 bg-gradient-to-br from-brand-blue-ghost/30 to-brand-cyan-ghost/30 backdrop-blur-sm shadow-sm hover:shadow-md transition-all duration-300",children:(0,t.jsx)(u.CardContent,{className:"pt-6",children:(0,t.jsxs)("div",{className:"relative",children:[(0,t.jsx)(g.Search,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-brand-blue"}),(0,t.jsx)(c.Input,{type:"text",placeholder:"Rechercher une conversation...",value:k,onChange:e=>M(e.target.value),className:"pl-10 border-brand-blue/20 focus:border-brand-blue focus:ring-brand-blue"})]})})})]}),(0,t.jsx)("div",{className:"space-y-3",children:Z&&Z.length>0?Z.map(e=>{let a=Y(e),s=(e=>{if(e.avatar_url)return e.avatar_url;if("direct"===e.conversation_type&&e.participants){let t=e.participants.find(e=>e.user_id!==q?.id);if(t?.user)return t.user.avatar_url}return null})(e),r=Array.isArray(e.last_message)?e.last_message[0]:e.last_message;return(0,t.jsx)("div",{children:(0,t.jsx)(u.Card,{className:"group border-brand-blue/10 hover:border-brand-blue/30 hover:shadow-lg transition-all duration-300 hover:scale-[1.02] cursor-pointer bg-gradient-to-br from-white to-brand-blue-ghost/20",children:(0,t.jsx)(u.CardContent,{className:"p-5",children:(0,t.jsxs)("div",{className:"flex items-center gap-4",children:[(0,t.jsxs)(y.default,{href:`/dashboard/messages/${e.id}`,className:"flex-1 flex items-center gap-4",children:[(0,t.jsxs)("div",{className:"flex-shrink-0 relative",children:[s?(0,t.jsx)("img",{src:s,alt:a,className:"h-14 w-14 rounded-full object-cover ring-2 ring-brand-blue/20 group-hover:ring-brand-blue/40 transition-all"}):(0,t.jsx)("div",{className:"h-14 w-14 rounded-full bg-gradient-to-br from-brand-blue-ghost to-brand-cyan-ghost flex items-center justify-center ring-2 ring-brand-blue/20 group-hover:ring-brand-blue/40 transition-all",children:"group"===e.conversation_type?(0,t.jsx)(b.Users,{className:"h-7 w-7 text-brand-blue"}):(0,t.jsx)(p.MessageSquare,{className:"h-7 w-7 text-brand-cyan"})}),false]}),(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,t.jsx)("h3",{className:"font-semibold text-gray-900 truncate text-lg group-hover:text-brand-blue transition-colors",children:a}),e.last_message_at&&(0,t.jsx)("span",{className:"text-xs text-gray-500 flex-shrink-0 ml-2 font-medium",children:(0,w.formatRelativeTime)(e.last_message_at)})]}),r&&(0,t.jsx)("div",{className:"flex items-center gap-2",children:(0,t.jsxs)("p",{className:"text-sm text-gray-600 truncate",children:[(0,t.jsx)("span",{className:"font-medium text-gray-700",children:r.sender?.full_name||r.sender?.email||(r.student_sender?`${r.student_sender.first_name||""} ${r.student_sender.last_name||""}`.trim()||r.student_sender.email||`Candidat ${r.student_sender.student_number||""}`:"Expéditeur")}),":"," ",r.content]})}),"group"===e.conversation_type&&e.participants&&(0,t.jsxs)("div",{className:"flex items-center gap-1.5 mt-1.5",children:[(0,t.jsx)(b.Users,{className:"h-3.5 w-3.5 text-brand-cyan"}),(0,t.jsxs)("p",{className:"text-xs text-gray-500 font-medium",children:[e.participants.length," participants"]})]})]})]}),(0,t.jsx)("div",{className:"flex-shrink-0",onClick:e=>e.stopPropagation(),children:(0,t.jsxs)(N.DropdownMenu,{children:[(0,t.jsx)(N.DropdownMenuTrigger,{asChild:!0,children:(0,t.jsx)(m.Button,{variant:"ghost",size:"icon",className:"hover:bg-brand-blue-ghost",onClick:e=>e.stopPropagation(),children:(0,t.jsx)(_.MoreVertical,{className:"h-4 w-4"})})}),(0,t.jsx)(N.DropdownMenuContent,{align:"end",children:(0,t.jsxs)(N.DropdownMenuItem,{onClick:t=>{t.preventDefault(),t.stopPropagation(),confirm("Êtes-vous sûr de vouloir supprimer cette conversation ?")&&O.mutate(e.id)},disabled:O.isPending,className:"text-destructive focus:text-destructive",children:[(0,t.jsx)(x.Trash2,{className:"mr-2 h-4 w-4"}),"Supprimer"]})})]})})]})})})},e.id)}):(0,t.jsx)(u.Card,{className:"border-brand-blue/20 bg-gradient-to-br from-brand-blue-ghost/30 to-brand-cyan-ghost/30",children:(0,t.jsx)(u.CardContent,{className:"py-16",children:(0,t.jsxs)("div",{className:"text-center space-y-4",children:[(0,t.jsxs)("div",{className:"relative inline-block",children:[(0,t.jsx)("div",{className:"absolute inset-0 flex items-center justify-center",children:(0,t.jsx)("div",{className:"w-24 h-24 bg-gradient-to-br from-brand-blue-ghost to-brand-cyan-ghost rounded-full opacity-50 blur-2xl"})}),(0,t.jsx)("div",{className:"relative p-6 bg-gradient-to-br from-brand-blue-ghost to-brand-cyan-ghost rounded-2xl inline-block",children:(0,t.jsx)(p.MessageSquare,{className:"h-16 w-16 mx-auto text-brand-blue"})})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)("h3",{className:"text-xl font-semibold text-gray-900",children:k?"Aucune conversation trouvée":"Aucune conversation"}),(0,t.jsx)("p",{className:"text-gray-600",children:k?"Essayez de modifier votre recherche":"Commencez une nouvelle conversation pour échanger avec vos collègues et candidats"})]}),!k&&(0,t.jsxs)(m.Button,{onClick:()=>E(!0),className:"mt-4 bg-gradient-to-r from-brand-blue to-brand-cyan hover:from-brand-blue-dark hover:to-brand-cyan shadow-md hover:shadow-lg transition-all",children:[(0,t.jsx)(f.Plus,{className:"h-4 w-4 mr-2"}),"Créer une conversation"]})]})})})}),(0,t.jsx)(h.Dialog,{open:P,onOpenChange:e=>{E(e),e||X()},children:(0,t.jsxs)(h.DialogContent,{className:"sm:max-w-[600px]",children:[(0,t.jsxs)(h.DialogHeader,{children:[(0,t.jsx)(h.DialogTitle,{children:"Nouvelle conversation"}),(0,t.jsx)(h.DialogDescription,{children:"Choisissez le type de conversation que vous souhaitez créer"})]}),(0,t.jsxs)("div",{className:"space-y-4 mt-4",children:[(0,t.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,t.jsxs)("button",{type:"button",onClick:()=>{L("personal"),U(""),R("")},className:`group p-5 border-2 rounded-xl transition-all duration-300 ${"personal"===D?"border-brand-blue bg-gradient-to-br from-brand-blue-ghost to-brand-blue-ghost/50 shadow-md scale-105":"border-gray-200 hover:border-brand-blue/40 hover:bg-brand-blue-ghost/30"}`,children:[(0,t.jsx)("div",{className:`p-2.5 rounded-lg mb-3 inline-flex ${"personal"===D?"bg-brand-blue/20":"bg-brand-blue/10 group-hover:bg-brand-blue/20"}`,children:(0,t.jsx)(p.MessageSquare,{className:"h-6 w-6 text-brand-blue"})}),(0,t.jsx)("h3",{className:"font-semibold mb-1 text-gray-900",children:"Message personnel"}),(0,t.jsx)("p",{className:"text-sm text-gray-600",children:"Envoyer un message à un candidat spécifique"})]}),(0,t.jsxs)("button",{type:"button",onClick:()=>{L("group"),R("")},className:`group p-5 border-2 rounded-xl transition-all duration-300 ${"group"===D?"border-brand-cyan bg-gradient-to-br from-brand-cyan-ghost to-brand-cyan-ghost/50 shadow-md scale-105":"border-gray-200 hover:border-brand-cyan/40 hover:bg-brand-cyan-ghost/30"}`,children:[(0,t.jsx)("div",{className:`p-2.5 rounded-lg mb-3 inline-flex ${"group"===D?"bg-brand-cyan/20":"bg-brand-cyan/10 group-hover:bg-brand-cyan/20"}`,children:(0,t.jsx)(b.Users,{className:"h-6 w-6 text-brand-cyan"})}),(0,t.jsx)("h3",{className:"font-semibold mb-1 text-gray-900",children:"Message groupé"}),(0,t.jsx)("p",{className:"text-sm text-gray-600",children:"Envoyer un message à tous les candidats d'une session"})]})]}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("label",{className:"block text-sm font-medium mb-2",children:["Session ","group"===D?"*":"(optionnel)"]}),T?(0,t.jsx)("div",{className:"flex items-center justify-center py-4",children:(0,t.jsx)(v.Loader2,{className:"h-5 w-5 animate-spin text-muted-foreground"})}):(0,t.jsxs)("select",{value:A,onChange:e=>{U(e.target.value),R("")},required:"group"===D,className:"w-full px-4 py-2 rounded-lg border focus:ring-2 focus:ring-brand-blue focus:border-transparent",children:[(0,t.jsx)("option",{value:"",children:"Sélectionner une session"}),K?.map(e=>(0,t.jsxs)("option",{value:e.id,children:[e.name," ",e.formations?.name?`- ${e.formations.name}`:""]},e.id))]})]}),"personal"===D&&A&&(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Candidat *"}),G?(0,t.jsx)("div",{className:"flex items-center justify-center py-4",children:(0,t.jsx)(v.Loader2,{className:"h-5 w-5 animate-spin text-muted-foreground"})}):Q&&Q.length>0?(0,t.jsx)("div",{className:"max-h-[300px] overflow-y-auto space-y-2 border rounded-lg p-2",children:Q.map(e=>{let a=e.student,s=`${a?.first_name||""} ${a?.last_name||""}`.trim()||a?.email||`Candidat ${a?.student_number||""}`,r=a?.email;return(0,t.jsxs)("button",{type:"button",onClick:()=>{let e=a?.id||null;e?J.mutate({userId:void 0,studentId:e}):z({type:"error",title:"Erreur",description:"Impossible de trouver l'identifiant de ce candidat."})},disabled:J.isPending||!a?.id,className:"group w-full flex items-center gap-3 p-3 rounded-xl transition-all duration-300 text-left hover:bg-gradient-to-br hover:from-brand-blue-ghost hover:to-brand-cyan-ghost cursor-pointer border border-transparent hover:border-brand-blue/20 hover:shadow-md",title:"Cliquer pour démarrer une conversation",children:[(0,t.jsx)("div",{className:"h-10 w-10 rounded-full bg-gradient-to-br from-brand-blue-ghost to-brand-cyan-ghost flex items-center justify-center group-hover:scale-110 transition-transform",children:(0,t.jsx)(b.Users,{className:"h-5 w-5 text-brand-blue"})}),(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsx)("p",{className:"font-medium truncate text-gray-900 group-hover:text-brand-blue transition-colors",children:s}),r&&(0,t.jsx)("p",{className:"text-sm text-gray-600 truncate",children:r}),a?.student_number&&(0,t.jsxs)("p",{className:"text-xs text-gray-500",children:["N°: ",a.student_number]})]}),J.isPending&&(0,t.jsx)(v.Loader2,{className:"h-4 w-4 animate-spin text-brand-blue"})]},a?.id)})}):(0,t.jsx)("div",{className:"text-center py-4 text-muted-foreground text-sm",children:"Aucun candidat trouvé dans cette session"})]}),"group"===D&&A&&(0,t.jsx)("div",{className:"flex justify-end",children:(0,t.jsx)(m.Button,{onClick:()=>W.mutate(),disabled:W.isPending||!A,className:"bg-gradient-to-r from-brand-cyan to-brand-blue hover:from-brand-cyan-dark hover:to-brand-blue-dark shadow-md hover:shadow-lg transition-all",children:W.isPending?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(v.Loader2,{className:"mr-2 h-4 w-4 animate-spin"}),"Création..."]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(b.Users,{className:"mr-2 h-4 w-4"}),"Créer la conversation de groupe"]})})}),"personal"===D&&!A&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:"relative",children:[(0,t.jsx)(g.Search,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),(0,t.jsx)(c.Input,{type:"text",placeholder:"Rechercher un utilisateur...",value:I,onChange:e=>$(e.target.value),className:"pl-10"})]}),(0,t.jsx)("div",{className:"max-h-[300px] overflow-y-auto space-y-2",children:H?(0,t.jsx)("div",{className:"flex items-center justify-center py-8",children:(0,t.jsx)(v.Loader2,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):V&&V.length>0?V.filter(e=>{if(!I)return!0;let t=I.toLowerCase();return e.full_name?.toLowerCase().includes(t)||e.email?.toLowerCase().includes(t)}).map(e=>(0,t.jsxs)("button",{onClick:()=>J.mutate(e.id),disabled:J.isPending,className:"group w-full flex items-center gap-3 p-3 rounded-xl hover:bg-gradient-to-br hover:from-brand-blue-ghost hover:to-brand-cyan-ghost transition-all duration-300 text-left border border-transparent hover:border-brand-blue/20 hover:shadow-md",children:[e.avatar_url?(0,t.jsx)("img",{src:e.avatar_url,alt:e.full_name||e.email,className:"h-10 w-10 rounded-full object-cover ring-2 ring-brand-blue/20 group-hover:ring-brand-blue/40 transition-all"}):(0,t.jsx)("div",{className:"h-10 w-10 rounded-full bg-gradient-to-br from-brand-blue-ghost to-brand-cyan-ghost flex items-center justify-center group-hover:scale-110 transition-transform",children:(0,t.jsx)(b.Users,{className:"h-5 w-5 text-brand-blue"})}),(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsx)("p",{className:"font-medium truncate text-gray-900 group-hover:text-brand-blue transition-colors",children:e.full_name||e.email}),e.full_name&&(0,t.jsx)("p",{className:"text-sm text-gray-600 truncate",children:e.email}),e.role&&(0,t.jsx)("p",{className:"text-xs text-gray-500 capitalize",children:e.role})]}),J.isPending&&(0,t.jsx)(v.Loader2,{className:"h-4 w-4 animate-spin text-brand-blue"})]},e.id)):(0,t.jsx)("div",{className:"text-center py-8 text-muted-foreground",children:I?"Aucun utilisateur trouvé":"Aucun utilisateur disponible"})})]})]})]})})]})}e.s(["default",()=>q])}]);