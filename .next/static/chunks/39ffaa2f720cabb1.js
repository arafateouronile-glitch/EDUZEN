(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,107233,e=>{"use strict";let s=(0,e.i(475254).default)("Plus",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]]);e.s(["Plus",()=>s],107233)},871689,e=>{"use strict";let s=(0,e.i(475254).default)("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]]);e.s(["ArrowLeft",()=>s],871689)},923432,e=>{"use strict";var s=e.i(843476),t=e.i(271645),r=e.i(618566),a=e.i(266027),i=e.i(954616),n=e.i(325715),l=e.i(920755),d=e.i(970065),o=e.i(167881),c=e.i(23750),u=e.i(6799),m=e.i(871689),x=e.i(107233),h=e.i(555436),p=e.i(761911),j=e.i(178583),b=e.i(87316),g=e.i(465286),f=e.i(810980),y=e.i(522016);e.i(882205);var v=e.i(846932),N=e.i(647163);function C(){let e=(0,r.useRouter)(),{user:C}=(0,n.useAuth)(),w=(0,l.createClient)(),{addToast:_}=(0,u.useToast)(),[z,k]=(0,t.useState)(1),[S,T]=(0,t.useState)(""),[A,B]=(0,t.useState)(""),[q,L]=(0,t.useState)([]),[$,F]=(0,t.useState)(""),{data:P,isLoading:R}=(0,a.useQuery)({queryKey:["portfolio-templates-active",C?.organization_id],queryFn:async()=>{if(!C?.organization_id)return[];let{data:e,error:s}=await w.from("learning_portfolio_templates").select("*").or(`organization_id.eq.${C.organization_id},organization_id.is.null`).eq("is_active",!0).order("is_default",{ascending:!1}).order("name");return s?(console.log("Table non trouvée:",s),[]):e||[]},enabled:!!C?.organization_id}),{data:E}=(0,a.useQuery)({queryKey:["sessions-for-portfolio",C?.organization_id],queryFn:async()=>{if(!C?.organization_id)return[];let{data:e,error:s}=await w.from("sessions").select("id, name, start_date, end_date, formations!inner(id, name, organization_id)").eq("formations.organization_id",C.organization_id).in("status",["planned","ongoing","active","in_progress"]).order("start_date",{ascending:!1});return s?[]:e||[]},enabled:!!C?.organization_id}),{data:M,isLoading:K}=(0,a.useQuery)({queryKey:["session-students",A],queryFn:async()=>{if(!A)return[];let{data:e,error:s}=await w.from("enrollments").select("student:students(id, first_name, last_name, email, photo_url)").eq("session_id",A).not("status","in",'("cancelled","rejected","dropped")');if(s)return console.error("Erreur récupération apprenants:",s),[];let t=new Map;return e?.forEach(e=>{e.student&&e.student.id&&t.set(e.student.id,e.student)}),Array.from(t.values())},enabled:!!A}),D=(0,i.useMutation)({mutationFn:async()=>{let e=q.map(e=>({organization_id:C?.organization_id,template_id:S,student_id:e,session_id:A||null,status:"draft",progress_percentage:0,started_at:new Date().toISOString(),content:{}})),{data:s,error:t}=await w.from("learning_portfolios").insert(e).select();if(t)throw t;return s},onSuccess:s=>{_({type:"success",title:"Livrets créés",description:`${s.length} livret(s) ont \xe9t\xe9 cr\xe9\xe9s avec succ\xe8s.`}),1===s.length?e.push(`/dashboard/evaluations/portfolios/${s[0].id}`):e.push("/dashboard/evaluations/portfolios")},onError:e=>{_({type:"error",title:"Erreur",description:e.message||"Impossible de créer les livrets."})}}),H=M?.filter(e=>`${e.first_name} ${e.last_name}`.toLowerCase().includes($.toLowerCase())||e.email?.toLowerCase().includes($.toLowerCase()));return(0,s.jsxs)("div",{className:"container mx-auto py-8 px-4 max-w-4xl",children:[(0,s.jsxs)(v.motion.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"mb-8",children:[(0,s.jsxs)("div",{className:"flex items-center gap-4 mb-4",children:[(0,s.jsx)(y.default,{href:"/dashboard/evaluations/portfolios",children:(0,s.jsx)(o.Button,{variant:"ghost",size:"icon",children:(0,s.jsx)(m.ArrowLeft,{className:"h-5 w-5"})})}),(0,s.jsxs)("div",{children:[(0,s.jsx)("h1",{className:"text-3xl font-bold text-gray-900",children:"Nouveau livret d'apprentissage"}),(0,s.jsx)("p",{className:"text-gray-600",children:"Créez un livret pour un ou plusieurs apprenants"})]})]}),(0,s.jsx)("div",{className:"flex items-center gap-2 mt-6",children:[1,2,3].map(e=>(0,s.jsxs)("div",{className:"flex items-center",children:[(0,s.jsx)("div",{className:(0,N.cn)("w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium transition-colors",z>=e?"bg-brand-blue text-white":"bg-gray-200 text-gray-600"),children:z>e?(0,s.jsx)(g.CheckCircle2,{className:"h-5 w-5"}):e}),e<3&&(0,s.jsx)("div",{className:(0,N.cn)("w-12 h-1 mx-2 rounded",z>e?"bg-brand-blue":"bg-gray-200")})]},e))}),(0,s.jsxs)("div",{className:"flex gap-16 mt-2 text-sm text-gray-600",children:[(0,s.jsx)("span",{className:z>=1?"text-brand-blue font-medium":"",children:"Modèle"}),(0,s.jsx)("span",{className:z>=2?"text-brand-blue font-medium":"",children:"Session"}),(0,s.jsx)("span",{className:z>=3?"text-brand-blue font-medium":"",children:"Apprenants"})]})]}),1===z&&(0,s.jsx)(v.motion.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},children:(0,s.jsxs)(d.Card,{children:[(0,s.jsxs)(d.CardHeader,{children:[(0,s.jsxs)(d.CardTitle,{className:"flex items-center gap-2",children:[(0,s.jsx)(j.FileText,{className:"h-5 w-5 text-brand-blue"}),"Choisir un modèle de livret"]}),(0,s.jsx)(d.CardDescription,{children:"Sélectionnez le modèle de livret à utiliser pour ce(s) apprenant(s)"})]}),(0,s.jsxs)(d.CardContent,{children:[R?(0,s.jsx)("div",{className:"flex justify-center py-8",children:(0,s.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-brand-blue"})}):P?.length===0?(0,s.jsxs)("div",{className:"text-center py-8",children:[(0,s.jsx)(j.FileText,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),(0,s.jsx)("p",{className:"text-gray-600 mb-4",children:"Aucun modèle de livret disponible"}),(0,s.jsx)(y.default,{href:"/dashboard/evaluations/portfolios/templates/new",children:(0,s.jsxs)(o.Button,{children:[(0,s.jsx)(x.Plus,{className:"h-4 w-4 mr-2"}),"Créer un modèle"]})})]}):(0,s.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:P?.map(e=>(0,s.jsx)("div",{onClick:()=>T(e.id),className:(0,N.cn)("p-4 border-2 rounded-lg cursor-pointer transition-all",S===e.id?"border-brand-blue bg-brand-blue/5":"border-gray-200 hover:border-gray-300"),children:(0,s.jsxs)("div",{className:"flex items-start gap-3",children:[(0,s.jsx)("div",{className:"w-10 h-10 rounded-lg flex items-center justify-center",style:{backgroundColor:`${e.primary_color}20`},children:(0,s.jsx)(j.FileText,{className:"h-5 w-5",style:{color:e.primary_color}})}),(0,s.jsxs)("div",{className:"flex-1",children:[(0,s.jsx)("h4",{className:"font-medium text-gray-900",children:e.name}),e.description&&(0,s.jsx)("p",{className:"text-sm text-gray-600 line-clamp-2",children:e.description}),(0,s.jsxs)("p",{className:"text-xs text-gray-500 mt-1",children:[e.template_structure?.length||0," sections"]})]}),S===e.id&&(0,s.jsx)(g.CheckCircle2,{className:"h-5 w-5 text-brand-blue"})]})},e.id))}),(0,s.jsx)("div",{className:"flex justify-end mt-6",children:(0,s.jsx)(o.Button,{onClick:()=>k(2),disabled:!S,children:"Continuer"})})]})]})}),2===z&&(0,s.jsx)(v.motion.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},children:(0,s.jsxs)(d.Card,{children:[(0,s.jsxs)(d.CardHeader,{children:[(0,s.jsxs)(d.CardTitle,{className:"flex items-center gap-2",children:[(0,s.jsx)(b.Calendar,{className:"h-5 w-5 text-brand-blue"}),"Sélectionner une session (optionnel)"]}),(0,s.jsx)(d.CardDescription,{children:"Associez le livret à une session de formation pour faciliter le suivi"})]}),(0,s.jsxs)(d.CardContent,{children:[(0,s.jsxs)("div",{className:"space-y-3",children:[(0,s.jsx)("div",{onClick:()=>B(""),className:(0,N.cn)("p-4 border-2 rounded-lg cursor-pointer transition-all",A?"border-gray-200 hover:border-gray-300":"border-brand-blue bg-brand-blue/5"),children:(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("h4",{className:"font-medium text-gray-900",children:"Sans session"}),(0,s.jsx)("p",{className:"text-sm text-gray-600",children:"Créer un livret indépendant"})]}),!A&&(0,s.jsx)(g.CheckCircle2,{className:"h-5 w-5 text-brand-blue"})]})}),E?.map(e=>(0,s.jsx)("div",{onClick:()=>B(e.id),className:(0,N.cn)("p-4 border-2 rounded-lg cursor-pointer transition-all",A===e.id?"border-brand-blue bg-brand-blue/5":"border-gray-200 hover:border-gray-300"),children:(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("h4",{className:"font-medium text-gray-900",children:e.name}),(0,s.jsx)("p",{className:"text-sm text-gray-600",children:e.formations?.name})]}),A===e.id&&(0,s.jsx)(g.CheckCircle2,{className:"h-5 w-5 text-brand-blue"})]})},e.id))]}),(0,s.jsxs)("div",{className:"flex justify-between mt-6",children:[(0,s.jsx)(o.Button,{variant:"outline",onClick:()=>k(1),children:"Retour"}),(0,s.jsx)(o.Button,{onClick:()=>k(3),children:"Continuer"})]})]})]})}),3===z&&(0,s.jsx)(v.motion.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},children:(0,s.jsxs)(d.Card,{children:[(0,s.jsxs)(d.CardHeader,{children:[(0,s.jsxs)(d.CardTitle,{className:"flex items-center gap-2",children:[(0,s.jsx)(p.Users,{className:"h-5 w-5 text-brand-blue"}),"Sélectionner les apprenants"]}),(0,s.jsx)(d.CardDescription,{children:A?"Sélectionnez les apprenants de la session":"Recherchez et sélectionnez les apprenants"})]}),(0,s.jsxs)(d.CardContent,{children:[(0,s.jsxs)("div",{className:"flex items-center gap-4 mb-4",children:[(0,s.jsxs)("div",{className:"relative flex-1",children:[(0,s.jsx)(h.Search,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400"}),(0,s.jsx)(c.Input,{placeholder:"Rechercher un apprenant...",value:$,onChange:e=>F(e.target.value),className:"pl-10"})]}),M&&M.length>0&&(0,s.jsx)(o.Button,{variant:"outline",onClick:()=>{M&&L(M.map(e=>e.id))},children:"Tout sélectionner"})]}),K?(0,s.jsx)("div",{className:"flex justify-center py-8",children:(0,s.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-brand-blue"})}):A?H?.length===0?(0,s.jsxs)("div",{className:"text-center py-8 text-gray-600",children:[(0,s.jsx)(p.Users,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),(0,s.jsx)("p",{children:"Aucun apprenant trouvé dans cette session"})]}):(0,s.jsx)("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:H?.map(e=>(0,s.jsxs)("div",{onClick:()=>{var s;return s=e.id,void L(e=>e.includes(s)?e.filter(e=>e!==s):[...e,s])},className:(0,N.cn)("p-3 border rounded-lg cursor-pointer transition-all flex items-center gap-3",q.includes(e.id)?"border-brand-blue bg-brand-blue/5":"border-gray-200 hover:border-gray-300"),children:[(0,s.jsx)("div",{className:"w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 font-medium",children:e.photo_url?(0,s.jsx)("img",{src:e.photo_url,alt:"",className:"w-10 h-10 rounded-full object-cover"}):`${e.first_name?.[0]}${e.last_name?.[0]}`}),(0,s.jsxs)("div",{className:"flex-1",children:[(0,s.jsxs)("p",{className:"font-medium text-gray-900",children:[e.first_name," ",e.last_name]}),(0,s.jsx)("p",{className:"text-sm text-gray-600",children:e.email})]}),q.includes(e.id)&&(0,s.jsx)(g.CheckCircle2,{className:"h-5 w-5 text-brand-blue"})]},e.id))}):(0,s.jsxs)("div",{className:"text-center py-8 text-gray-600",children:[(0,s.jsx)(f.BookOpen,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),(0,s.jsx)("p",{children:"Sélectionnez une session à l'étape précédente pour voir les apprenants"}),(0,s.jsx)("p",{className:"text-sm mt-2",children:"ou créez un livret sans session"})]}),q.length>0&&(0,s.jsx)("div",{className:"mt-4 p-3 bg-brand-blue/5 rounded-lg",children:(0,s.jsxs)("p",{className:"text-sm text-brand-blue font-medium",children:[q.length," apprenant(s) sélectionné(s)"]})}),(0,s.jsxs)("div",{className:"flex justify-between mt-6",children:[(0,s.jsx)(o.Button,{variant:"outline",onClick:()=>k(2),children:"Retour"}),(0,s.jsx)(o.Button,{onClick:()=>{S?0===q.length?_({type:"error",title:"Erreur",description:"Sélectionnez au moins un apprenant."}):D.mutate():_({type:"error",title:"Erreur",description:"Sélectionnez un modèle de livret."})},disabled:0===q.length||D.isPending,children:D.isPending?"Création...":`Cr\xe9er ${q.length} livret(s)`})]})]})]})})]})}e.s(["default",()=>C])}]);