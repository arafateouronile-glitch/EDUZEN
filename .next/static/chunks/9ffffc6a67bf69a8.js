(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,871689,e=>{"use strict";let r=(0,e.i(475254).default)("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]]);e.s(["ArrowLeft",()=>r],871689)},209372,e=>{"use strict";var r=e.i(50270);let t=r.z.object({first_name:r.z.string().min(1,"Le prénom est requis").max(100,"Le prénom est trop long"),last_name:r.z.string().min(1,"Le nom est requis").max(100,"Le nom est trop long"),date_of_birth:r.z.string().optional().or(r.z.literal("")),gender:r.z.enum(["male","female","other"]).optional().or(r.z.literal("")),email:r.z.string().email("Email invalide").optional().or(r.z.literal("")),phone:r.z.string().optional().or(r.z.literal("")),address:r.z.string().optional().or(r.z.literal("")),city:r.z.string().optional().or(r.z.literal("")),class_id:r.z.string().optional().or(r.z.literal("")),enrollment_date:r.z.string().min(1,"La date d'inscription est requise"),guardian_first_name:r.z.string().min(1,"Le prénom du tuteur est requis"),guardian_last_name:r.z.string().min(1,"Le nom du tuteur est requis"),guardian_relationship:r.z.enum(["parent","guardian","other"]).default("parent"),guardian_phone_primary:r.z.string().min(1,"Le téléphone principal du tuteur est requis"),guardian_phone_secondary:r.z.string().optional().or(r.z.literal("")),guardian_email:r.z.string().email("Email invalide").optional().or(r.z.literal("")),guardian_address:r.z.string().optional().or(r.z.literal(""))});r.z.object({first_name:r.z.string().min(1,"Le prénom est requis").max(100,"Le prénom est trop long"),last_name:r.z.string().min(1,"Le nom est requis").max(100,"Le nom est trop long"),date_of_birth:r.z.string().optional().or(r.z.literal("")),gender:r.z.enum(["male","female","other"]).optional().or(r.z.literal("")),email:r.z.string().email("Email invalide").optional().or(r.z.literal("")),phone:r.z.string().optional().or(r.z.literal("")),address:r.z.string().optional().or(r.z.literal("")),city:r.z.string().optional().or(r.z.literal("")),class_id:r.z.string().optional().or(r.z.literal("")),enrollment_date:r.z.string().min(1,"La date d'inscription est requise"),status:r.z.enum(["active","inactive","graduated"]).default("active")});let i=r.z.object({code:r.z.string().min(1,"Le code est requis").max(50,"Le code est trop long"),name:r.z.string().min(1,"Le nom est requis").max(200,"Le nom est trop long"),subtitle:r.z.string().optional().or(r.z.literal("")),description:r.z.string().optional().or(r.z.literal("")),category:r.z.string().optional().or(r.z.literal("")),program_version:r.z.string().optional().or(r.z.literal("")),version_date:r.z.string().optional().or(r.z.literal("")),duration_hours:r.z.string().optional().or(r.z.literal("")),duration_days:r.z.string().optional().or(r.z.literal("")),photo_url:r.z.string().url("URL invalide").optional().or(r.z.literal("")),price:r.z.string().optional().or(r.z.literal("")),price_enterprise:r.z.string().optional().or(r.z.literal("")),price_individual:r.z.string().optional().or(r.z.literal("")),price_freelance:r.z.string().optional().or(r.z.literal("")),currency:r.z.string().default("XOF"),payment_plan:r.z.enum(["full","installment","free"]).default("full"),published_online:r.z.boolean().default(!1),is_public:r.z.boolean().default(!1),eligible_cpf:r.z.boolean().default(!1),cpf_code:r.z.string().optional().or(r.z.literal("")),modalities:r.z.string().optional().or(r.z.literal("")),training_action_type:r.z.string().optional().or(r.z.literal("")),pedagogical_objectives:r.z.string().optional().or(r.z.literal("")),learner_profile:r.z.string().optional().or(r.z.literal("")),training_content:r.z.string().optional().or(r.z.literal("")),execution_follow_up:r.z.string().optional().or(r.z.literal("")),certification_modalities:r.z.string().optional().or(r.z.literal("")),quality:r.z.string().optional().or(r.z.literal("")),accounting_product_config:r.z.string().optional().or(r.z.literal("")),edof_export_fields:r.z.string().optional().or(r.z.literal("")),competence_domains:r.z.string().optional().or(r.z.literal("")),prerequisites:r.z.string().optional().or(r.z.literal("")),capacity_max:r.z.string().optional().or(r.z.literal("")),age_min:r.z.string().optional().or(r.z.literal("")),age_max:r.z.string().optional().or(r.z.literal("")),certification_issued:r.z.boolean().default(!1),is_active:r.z.boolean().default(!0)}),a=r.z.object({program_id:r.z.string().min(1,"Le programme est requis"),code:r.z.string().min(1,"Le code est requis").max(50,"Le code est trop long"),name:r.z.string().min(1,"Le nom est requis").max(200,"Le nom est trop long"),subtitle:r.z.string().optional().or(r.z.literal("")),photo_url:r.z.string().url("URL invalide").optional().or(r.z.literal("")),category:r.z.string().optional().or(r.z.literal("")),description:r.z.string().optional().or(r.z.literal("")),program_version:r.z.string().optional().or(r.z.literal("")),version_date:r.z.string().optional().or(r.z.literal("")),duration_hours:r.z.string().optional().or(r.z.literal("")),duration_days:r.z.string().optional().or(r.z.literal("")),duration_unit:r.z.enum(["hours","days"]).default("hours"),price:r.z.string().optional().or(r.z.literal("")),currency:r.z.string().default("XOF"),payment_plan:r.z.enum(["full","installment","free"]).default("full"),published_online:r.z.boolean().default(!1),eligible_cpf:r.z.boolean().default(!1),cpf_code:r.z.string().optional().or(r.z.literal("")),modalities:r.z.string().optional().or(r.z.literal("")),training_action_type:r.z.string().optional().or(r.z.literal("")),pedagogical_objectives:r.z.string().optional().or(r.z.literal("")),learner_profile:r.z.string().optional().or(r.z.literal("")),training_content:r.z.string().optional().or(r.z.literal("")),execution_follow_up:r.z.string().optional().or(r.z.literal("")),certification_modalities:r.z.string().optional().or(r.z.literal("")),quality:r.z.string().optional().or(r.z.literal("")),accounting_product_config:r.z.string().optional().or(r.z.literal("")),edof_export_fields:r.z.string().optional().or(r.z.literal("")),competence_domains:r.z.string().optional().or(r.z.literal("")),prerequisites:r.z.string().optional().or(r.z.literal("")),capacity_max:r.z.string().optional().or(r.z.literal("")),age_min:r.z.string().optional().or(r.z.literal("")),age_max:r.z.string().optional().or(r.z.literal("")),certification_issued:r.z.boolean().default(!1),is_active:r.z.boolean().default(!0)}),n=r.z.object({formation_id:r.z.string().min(1,"La formation est requise"),name:r.z.string().min(1,"Le nom est requis").max(200,"Le nom est trop long"),code:r.z.string().optional().or(r.z.literal("")),start_date:r.z.string().min(1,"La date de début est requise"),end_date:r.z.string().min(1,"La date de fin est requise"),start_time:r.z.string().optional().or(r.z.literal("")),end_time:r.z.string().optional().or(r.z.literal("")),location:r.z.string().optional().or(r.z.literal("")),capacity_max:r.z.string().optional().or(r.z.literal("")).refine(e=>{if(!e)return!0;let r=parseInt(e);return!isNaN(r)&&r>0},"La capacité maximale doit être un nombre entier positif"),currency:r.z.string().default("XOF"),status:r.z.enum(["planned","ongoing","completed","cancelled"]).default("planned"),teacher_id:r.z.string().optional().or(r.z.literal("")),manager1_id:r.z.string().optional().or(r.z.literal("")),manager2_id:r.z.string().optional().or(r.z.literal("")),inter_entreprise:r.z.boolean().default(!0),sous_traitance:r.z.boolean().default(!1),timezone:r.z.string().default("Europe/Paris"),program_ids:r.z.array(r.z.string()).default([])}).refine(e=>!e.start_date||!e.end_date||new Date(e.end_date)>=new Date(e.start_date),{message:"La date de fin doit être postérieure à la date de début",path:["end_date"]}),o=r.z.object({student_id:r.z.string().min(1,"L'étudiant est requis"),session_id:r.z.string().optional().or(r.z.literal("")),subject:r.z.string().min(1,"Le sujet est requis").max(200,"Le sujet est trop long"),assessment_type:r.z.enum(["pre_formation","hot","cold","manager","instructor","funder","quiz","exam","project","other"]).default("quiz"),score:r.z.string().min(1,"La note est requise").refine(e=>{let r=parseFloat(e);return!isNaN(r)&&r>=0},"La note doit être un nombre valide"),max_score:r.z.string().optional().or(r.z.literal("")).refine(e=>{if(!e)return!0;let r=parseFloat(e);return!isNaN(r)&&r>0},"La note maximale doit être un nombre valide supérieur à 0"),notes:r.z.string().optional().or(r.z.literal("")),graded_at:r.z.string().min(1,"La date d'évaluation est requise"),coefficient:r.z.string().optional().or(r.z.literal("")).refine(e=>{if(!e)return!0;let r=parseFloat(e);return!isNaN(r)&&r>0},"Le coefficient doit être un nombre valide supérieur à 0"),is_makeup:r.z.boolean().optional().default(!1),original_grade_id:r.z.string().optional().or(r.z.literal("")),appreciation:r.z.string().optional().or(r.z.literal("")),term_period:r.z.enum(["Q1","Q2","Q3","Q4","S1","S2","T1","T2","T3"]).optional().or(r.z.literal("")),academic_year_id:r.z.string().optional().or(r.z.literal(""))}).refine(e=>!e.max_score||!e.score||parseFloat(e.score)<=parseFloat(e.max_score),{message:"La note ne peut pas être supérieure à la note maximale",path:["score"]}),s=r.z.object({student_id:r.z.string().min(1,"L'étudiant est requis"),document_type:r.z.enum(["quote","invoice"]).default("invoice"),invoice_number:r.z.string().optional().or(r.z.literal("")),type:r.z.enum(["tuition","registration","other"]).default("tuition"),issue_date:r.z.string().min(1,"La date d'émission est requise"),due_date:r.z.string().min(1,"La date d'échéance est requise"),amount:r.z.string().min(1,"Le montant est requis").refine(e=>{let r=parseFloat(e);return!isNaN(r)&&r>=0},"Le montant doit être un nombre valide supérieur ou égal à 0"),tax_amount:r.z.string().optional().or(r.z.literal("")).refine(e=>{if(!e)return!0;let r=parseFloat(e);return!isNaN(r)&&r>=0},"Le montant de la taxe doit être un nombre valide supérieur ou égal à 0"),currency:r.z.string().default("XOF"),status:r.z.enum(["draft","sent","partial","paid","overdue","cancelled"]).default("draft"),notes:r.z.string().optional().or(r.z.literal("")),enrollment_id:r.z.string().optional().or(r.z.literal(""))}).refine(e=>!e.issue_date||!e.due_date||new Date(e.due_date)>=new Date(e.issue_date),{message:"La date d'échéance doit être postérieure à la date d'émission",path:["due_date"]});r.z.object({invoice_id:r.z.string().min(1,"La facture est requise"),student_id:r.z.string().min(1,"L'étudiant est requis"),amount:r.z.string().min(1,"Le montant est requis").refine(e=>{let r=parseFloat(e);return!isNaN(r)&&r>0},"Le montant doit être un nombre valide supérieur à 0"),currency:r.z.string().default("XOF"),payment_method:r.z.enum(["cash","mobile_money","card","bank_transfer"]).default("cash"),payment_provider:r.z.enum(["mtn","orange","airtel","wave"]).optional().or(r.z.literal("")),transaction_id:r.z.string().optional().or(r.z.literal("")),paid_at:r.z.string().optional().or(r.z.literal("")),notes:r.z.string().optional().or(r.z.literal(""))});let l=r.z.object({student_id:r.z.string().min(1,"L'étudiant est requis"),session_id:r.z.string().min(1,"La session est requise"),enrollment_date:r.z.string().min(1,"La date d'inscription est requise"),status:r.z.enum(["pending","confirmed","completed","cancelled","failed"]).default("confirmed"),payment_status:r.z.enum(["pending","partial","paid","overdue"]).default("pending"),total_amount:r.z.string().optional().or(r.z.literal("")).refine(e=>{if(!e)return!0;let r=parseFloat(e);return!isNaN(r)&&r>=0},"Le montant total doit être un nombre valide supérieur ou égal à 0"),paid_amount:r.z.string().optional().or(r.z.literal("")).refine(e=>{if(!e)return!0;let r=parseFloat(e);return!isNaN(r)&&r>=0},"Le montant payé doit être un nombre valide supérieur ou égal à 0")}).refine(e=>{if(e.total_amount&&e.paid_amount){let r=parseFloat(e.total_amount),t=parseFloat(e.paid_amount);if(!isNaN(r)&&!isNaN(t)&&t>r)return!1}return!0},{message:"Le montant payé ne peut pas dépasser le montant total",path:["paid_amount"]});e.s(["enrollmentSchema",0,l,"evaluationSchema",0,o,"formationSchema",0,a,"invoiceSchema",0,s,"programSchema",0,i,"sessionSchema",0,n,"studentSchema",0,t])},246704,779478,e=>{"use strict";var r,t,i=e.i(790224),a=((r={}).AUTH_REQUIRED="AUTH_1001",r.AUTH_INVALID_CREDENTIALS="AUTH_1002",r.AUTH_SESSION_EXPIRED="AUTH_1003",r.AUTH_INSUFFICIENT_PERMISSIONS="AUTH_1004",r.AUTH_2FA_REQUIRED="AUTH_1005",r.AUTH_2FA_INVALID="AUTH_1006",r.VALIDATION_ERROR="VALID_2001",r.VALIDATION_REQUIRED_FIELD="VALID_2002",r.VALIDATION_INVALID_FORMAT="VALID_2003",r.VALIDATION_UNIQUE_CONSTRAINT="VALID_2004",r.DB_CONNECTION_ERROR="DB_3001",r.DB_QUERY_ERROR="DB_3002",r.DB_NOT_FOUND="DB_3003",r.DB_CONSTRAINT_VIOLATION="DB_3004",r.DB_FOREIGN_KEY_CONSTRAINT="DB_3006",r.DB_RLS_POLICY_VIOLATION="DB_3005",r.NETWORK_ERROR="NET_4001",r.API_TIMEOUT="NET_4002",r.API_RATE_LIMIT="NET_4003",r.API_SERVER_ERROR="NET_4004",r.API_NOT_FOUND="NET_4005",r.API_BAD_REQUEST="NET_4006",r.BUSINESS_LOGIC_ERROR="BIZ_5001",r.RESOURCE_LOCKED="BIZ_5002",r.OPERATION_NOT_ALLOWED="BIZ_5003",r.QUOTA_EXCEEDED="BIZ_5004",r.INTERNAL_ERROR="SYS_6001",r.CONFIGURATION_ERROR="SYS_6002",r.SERVICE_UNAVAILABLE="SYS_6003",r);(t={}).LOW="low",t.MEDIUM="medium",t.HIGH="high",t.CRITICAL="critical";class n extends Error{code;severity;userMessage;retryable;context;originalError;constructor(e,r="SYS_6001",t="medium",i={},a){super(e),this.name="AppError",this.code=r,this.severity=t,this.userMessage=i.userMessage||this.getDefaultUserMessage(r),this.retryable=i.retryable??this.isRetryable(r),this.context={...i,code:r,severity:t,timestamp:new Date().toISOString()},this.originalError=a,Error.captureStackTrace&&Error.captureStackTrace(this,n)}getDefaultUserMessage(e){return({AUTH_1001:"Vous devez être connecté pour effectuer cette action.",AUTH_1002:"Email ou mot de passe incorrect.",AUTH_1003:"Votre session a expiré. Veuillez vous reconnecter.",AUTH_1004:"Vous n'avez pas les permissions nécessaires.",AUTH_1005:"Authentification à deux facteurs requise.",AUTH_1006:"Code d'authentification invalide.",VALID_2001:"Les données fournies ne sont pas valides.",VALID_2002:"Certains champs obligatoires sont manquants.",VALID_2003:"Le format des données est incorrect.",VALID_2004:"Cette valeur existe déjà.",DB_3001:"Impossible de se connecter à la base de données.",DB_3002:"Erreur lors de l'exécution de la requête.",DB_3003:"Ressource introuvable.",DB_3004:"Cette opération viole une contrainte de la base de données.",DB_3006:"Cette opération viole une contrainte de clé étrangère.",DB_3005:"Vous n'avez pas accès à cette ressource.",NET_4001:"Erreur de connexion réseau. Vérifiez votre connexion internet.",NET_4002:"La requête a pris trop de temps. Veuillez réessayer.",NET_4003:"Trop de requêtes. Veuillez patienter quelques instants.",NET_4004:"Erreur serveur. Veuillez réessayer plus tard.",NET_4005:"Ressource introuvable.",NET_4006:"Requête invalide.",BIZ_5001:"Cette opération n'est pas autorisée dans le contexte actuel.",BIZ_5002:"Cette ressource est actuellement verrouillée.",BIZ_5003:"Cette opération n'est pas autorisée.",BIZ_5004:"Vous avez atteint la limite autorisée.",SYS_6001:"Une erreur interne est survenue. Veuillez réessayer.",SYS_6002:"Erreur de configuration du système.",SYS_6003:"Service temporairement indisponible."})[e]||"Une erreur inattendue est survenue."}isRetryable(e){return["NET_4001","NET_4002","NET_4004","DB_3001","SYS_6003"].includes(e)}toJSON(){return{name:this.name,message:this.message,code:this.code,severity:this.severity,userMessage:this.userMessage,retryable:this.retryable,context:this.context,stack:this.stack,originalError:this.originalError instanceof Error?{name:this.originalError.name,message:this.originalError.message,stack:this.originalError.stack}:this.originalError}}}let o=new class{handleError(e,r={}){if(e instanceof n)return this.logError(e),e;if(e instanceof Error)return this.handleStandardError(e,r);if(this.isSupabaseError(e))return this.handleSupabaseError(e,r);let t=new n("Une erreur inattendue est survenue.","SYS_6001","high",r,e);return this.logError(t),t}handleStandardError(e,r){let t=e.message.toLowerCase(),i="SYS_6001",a="medium";t.includes("network")||t.includes("fetch")?(i="NET_4001",a="medium"):t.includes("timeout")?(i="NET_4002",a="medium"):t.includes("unauthorized")||t.includes("401")?(i="AUTH_1001",a="high"):t.includes("forbidden")||t.includes("403")?(i="AUTH_1004",a="high"):t.includes("not found")||t.includes("404")?(i="DB_3003",a="low"):(t.includes("validation")||t.includes("invalid"))&&(i="VALID_2001",a="low");let o=new n(e.message,i,a,r,e);return this.logError(o),o}handleSupabaseError(e,r){let t=e.code||e.status,i=e.message||"Erreur Supabase",a=r.code||"DB_3002",o="medium";if(!r.code)switch(t){case"PGRST116":case"42P01":a="DB_3003",o="low";break;case"42501":a="DB_3005",o="high";break;case"23505":a="VALID_2004",o="low";break;case"23503":a="DB_3004",o="medium";break;case"PGRST301":case"400":a="NET_4006",o="low";break;case"401":a="AUTH_1001",o="high";break;case"403":a="AUTH_1004",o="high";break;case"404":a="NET_4005",o="low";break;case"500":a="NET_4004",o="high"}"DB_3006"===a&&(o="medium");let s=new n(i,a,o,r,e);return this.logError(s),s}isSupabaseError(e){return e&&(e.code||e.status||e.message)&&("string"==typeof e.code||"number"==typeof e.status)}logError(e){let r={...e.context,code:e.code,severity:e.severity,retryable:e.retryable};switch(e.severity){case"critical":case"high":i.logger.error(e.message,e.originalError||e,r);break;case"medium":i.logger.warn(e.message,r);break;case"low":i.logger.info(`Error: ${e.message}`,r)}}createValidationError(e,r){return new n(e,"VALID_2001","low",{field:r,userMessage:e})}createAuthError(e,r){return new n(r||"Erreur d'authentification",e,"high")}createDatabaseError(e,r){return new n(e,"DB_3002","medium",{},r)}createNotFoundError(e,r){return new n(e,"DB_3003","low",r)}};e.s(["AppError",()=>n,"ErrorCode",()=>a,"errorHandler",0,o],779478),e.s([],246704)},627404,e=>{"use strict";e.i(246704);var r=e.i(779478);async function t(e,t,i,a){try{let n=e.from(t).select(a?.select||"*").eq("organization_id",i);a?.filters&&Object.entries(a.filters).forEach(([e,r])=>{null!=r&&(n=n.eq(e,r))}),a?.search&&(n=n.ilike(a.search.field,`%${a.search.value}%`)),n=a?.orderBy?n.order(a.orderBy.column,{ascending:a.orderBy.ascending??!1}):n.order("created_at",{ascending:!1});let{data:o,error:s}=await n;if(s)throw r.errorHandler.handleError(s,{organizationId:i,operation:"getAllByOrganization",table:t});return o||[]}catch(e){if(e instanceof r.AppError)throw e;throw r.errorHandler.handleError(e,{organizationId:i,operation:"getAllByOrganization",table:t})}}async function i(e,t,i,a){try{let{data:n,error:o}=await e.from(t).select(a||"*").eq("id",i).single();if(o){if("PGRST116"===o.code||"42P01"===o.code)throw r.errorHandler.handleError(o,{code:r.ErrorCode.DB_NOT_FOUND,operation:"getById",id:i,table:t});throw r.errorHandler.handleError(o,{operation:"getById",id:i,table:t})}if(!n)throw r.errorHandler.createDatabaseError(`Enregistrement avec l'ID ${i} introuvable dans ${t}`,{id:i,table:t});return n}catch(e){if(e instanceof r.AppError)throw e;throw r.errorHandler.handleError(e,{operation:"getById",id:i,table:t})}}e.s(["getAllByOrganization",()=>t,"getById",()=>i])},34458,e=>{"use strict";e.i(246704);var r=e.i(779478);function t(e,t){for(let i of t)if(!e[i])throw r.errorHandler.createValidationError(`Le champ ${String(i)} est obligatoire`,String(i))}e.s(["validateRequired",()=>t])},631259,e=>{"use strict";var r=e.i(920755);e.i(246704);var t=e.i(779478),i=e.i(790224),a=e.i(627404),n=e.i(34458);let o=new class{supabase;constructor(e){this.supabase=e||(0,r.createClient)()}async getAll(e,r){try{let t={};return r?.studentId&&(t.student_id=r.studentId),r?.status&&(t.status=r.status),r?.documentType&&(t.document_type=r.documentType),(0,a.getAllByOrganization)(this.supabase,"invoices",e,{select:"*, students(id, first_name, last_name, student_number), payments(id, amount, status, paid_at)",filters:t,search:r?.search?{field:"invoice_number",value:r.search}:void 0,orderBy:{column:"issue_date",ascending:!1}})}catch(r){if(r instanceof t.AppError)throw r;throw t.errorHandler.handleError(r,{organizationId:e,operation:"getAll"})}}async getById(e){try{return(0,a.getById)(this.supabase,"invoices",e,"*, students(*), enrollments(*), payments(*)")}catch(r){if(r instanceof t.AppError)throw r;throw t.errorHandler.handleError(r,{operation:"getById",id:e})}}async generateInvoiceNumber(e,r="invoice"){let t=new Date().getFullYear().toString(),{data:i}=await this.supabase.from("invoices").select("invoice_number").eq("organization_id",e).eq("document_type",r).like("invoice_number",`${t}-%`).order("invoice_number",{ascending:!1}).limit(1).maybeSingle(),a=1;if(i?.invoice_number){let e=i.invoice_number.split("-");e.length>=2&&e[0]===t&&(a=parseInt(e[1]||"0",10)+1)}return`${t}-${String(a).padStart(3,"0")}`}async create(e){try{(0,n.validateRequired)(e,["organization_id","student_id"]);let r=e.invoice_number;if(!r||""===r.trim()){let i=e.organization_id;if(!i)throw t.errorHandler.createValidationError("Organization ID is required to create an invoice.");r=await this.generateInvoiceNumber(i,e.document_type||"invoice")}let{data:a,error:o}=await this.supabase.from("invoices").insert({...e,invoice_number:r}).select().single();if(o){if("23505"===o.code)throw t.errorHandler.handleError(o,{code:t.ErrorCode.VALIDATION_UNIQUE_CONSTRAINT,operation:"create",field:"invoice_number"});if("42501"===o.code)throw t.errorHandler.handleError(o,{code:t.ErrorCode.DB_RLS_POLICY_VIOLATION,operation:"create"});throw t.errorHandler.handleError(o,{operation:"create",invoice:e})}return i.logger.info("Facture créée avec succès",{id:a?.id,organizationId:e.organization_id||void 0,invoiceNumber:a?.invoice_number}),a}catch(r){if(r instanceof t.AppError)throw r;throw t.errorHandler.handleError(r,{operation:"create",invoice:e})}}async update(e,r){try{let{data:a,error:n}=await this.supabase.from("invoices").update(r).eq("id",e).select().single();if(n){if("PGRST116"===n.code||"42P01"===n.code)throw t.errorHandler.handleError(n,{code:t.ErrorCode.DB_NOT_FOUND,operation:"update",id:e});if("42501"===n.code)throw t.errorHandler.handleError(n,{code:t.ErrorCode.DB_RLS_POLICY_VIOLATION,operation:"update",id:e});throw t.errorHandler.handleError(n,{operation:"update",id:e,updates:r})}if(!a)throw t.errorHandler.createDatabaseError(`Facture avec l'ID ${e} introuvable pour la mise \xe0 jour`,{id:e});return i.logger.info("Facture mise à jour avec succès",{id:e,updates:r}),a}catch(i){if(i instanceof t.AppError)throw i;throw t.errorHandler.handleError(i,{operation:"update",id:e,updates:r})}}async generateForClass(e,r,a,n,o,s="tuition"){let{data:l,error:d}=await this.supabase.from("students").select("id").eq("organization_id",e).eq("class_id",r).eq("status","active");if(d)throw t.errorHandler.handleError(d,{operation:"generateForClass",organizationId:e,classId:r,step:"fetchStudents"});if(!l||0===l.length)throw t.errorHandler.createValidationError("Aucun élève actif dans cette classe","classId");let{data:u}=await this.supabase.from("organizations").select("code").eq("id",e).single(),c=u?.code||"ORG",m=new Date().getFullYear().toString().slice(-2),{data:p}=await this.supabase.from("invoices").select("invoice_number").eq("organization_id",e).like("invoice_number",`FAC-${c}-${m}-%`).order("invoice_number",{ascending:!1}).limit(1).maybeSingle(),g=1;if(p?.invoice_number){let e=p.invoice_number.split("-");g=parseInt(e[e.length-1]||"0")+1}let _=l.map((r,t)=>({organization_id:e,student_id:r.id,invoice_number:`FAC-${c}-${m}-${String(g+t).padStart(6,"0")}`,type:s,document_type:"invoice",issue_date:new Date().toISOString().split("T")[0],due_date:o,amount:a,tax_amount:0,total_amount:a,currency:n,status:"draft",items:[]})),{data:h,error:z}=await this.supabase.from("invoices").insert(_).select();if(z)throw t.errorHandler.handleError(z,{operation:"generateForClass",organizationId:e,classId:r,count:_.length});return i.logger.info("Factures générées en masse avec succès",{organizationId:e,classId:r,count:h?.length||0}),h||[]}async getOverdue(e){let r=new Date().toISOString().split("T")[0];try{let{data:i,error:a}=await this.supabase.from("invoices").select("*, students(id, first_name, last_name, student_number)").eq("organization_id",e).eq("document_type","invoice").in("status",["sent","partial"]).lt("due_date",r).order("due_date",{ascending:!0});if(a)throw t.errorHandler.handleError(a,{operation:"getOverdue",organizationId:e});return i||[]}catch(r){if(r instanceof t.AppError)throw r;throw t.errorHandler.handleError(r,{operation:"getOverdue",organizationId:e})}}async convertQuoteToInvoice(e){try{let{data:r,error:a}=await this.supabase.from("invoices").select("*").eq("id",e).eq("document_type","quote").single();if(a){if("PGRST116"===a.code||"42P01"===a.code)throw t.errorHandler.handleError(a,{code:t.ErrorCode.DB_NOT_FOUND,operation:"convertQuoteToInvoice",quoteId:e});throw t.errorHandler.handleError(a,{operation:"convertQuoteToInvoice",quoteId:e,step:"fetchQuote"})}if(!r)throw t.errorHandler.createDatabaseError(`Devis avec l'ID ${e} introuvable`,{quoteId:e});let{data:n,error:o}=await this.supabase.from("invoices").update({document_type:"invoice",status:"draft",issue_date:r.issue_date||new Date().toISOString().split("T")[0]}).eq("id",e).select().single();if(o)throw t.errorHandler.handleError(o,{operation:"convertQuoteToInvoice",quoteId:e,step:"updateInvoice"});return i.logger.info("Devis converti en facture avec succès",{quoteId:e,invoiceId:n?.id}),n}catch(r){if(r instanceof t.AppError)throw r;throw t.errorHandler.handleError(r,{operation:"convertQuoteToInvoice",quoteId:e})}}};e.s(["invoiceService",0,o])},36178,e=>{"use strict";var r=e.i(843476),t=e.i(271645),i=e.i(618566),a=e.i(954616),n=e.i(266027),o=e.i(653145),s=e.i(994814),l=e.i(325715),d=e.i(920755),u=e.i(631259),c=e.i(167881),m=e.i(970065),p=e.i(871689),g=e.i(522016),_=e.i(209372);function h(){let e=(0,i.useRouter)(),{user:h}=(0,l.useAuth)(),z=(0,d.createClient)(),{data:f}=(0,n.useQuery)({queryKey:["students",h?.organization_id],queryFn:async()=>{if(!h?.organization_id)return[];let{data:e,error:r}=await z.from("students").select("id, first_name, last_name, student_number, classes(name)").eq("organization_id",h.organization_id).eq("status","active").order("last_name");if(r)throw r;return e||[]},enabled:!!h?.organization_id}),{data:b}=(0,n.useQuery)({queryKey:["classes",h?.organization_id],queryFn:async()=>{if(!h?.organization_id)return[];let{data:e,error:r}=await z.from("classes").select("*").eq("organization_id",h.organization_id).order("name");if(r)throw r;return e||[]},enabled:!!h?.organization_id}),[v,x]=(0,t.useState)("single"),[y,E]=(0,t.useState)("quote"),{register:N,handleSubmit:I,formState:{errors:j},watch:T,setValue:w}=(0,o.useForm)({resolver:(0,s.zodResolver)(_.invoiceSchema),mode:"onChange",defaultValues:{student_id:"",document_type:"quote",type:"tuition",amount:"",tax_amount:"",currency:"EUR",issue_date:new Date().toISOString().split("T")[0],due_date:new Date(Date.now()+2592e6).toISOString().split("T")[0],notes:"",status:"draft"}}),A=T(),L=e=>{E(e),w("document_type",e)},S=(0,a.useMutation)({mutationFn:async e=>{if(!h?.organization_id)throw Error("Organization ID manquant");if("bulk"===v)throw Error("La génération en masse n'est pas encore validée avec Zod");{let r=parseFloat(e.amount)||0,t=parseFloat(e.tax_amount||"0")||0;return u.invoiceService.create({organization_id:h.organization_id,student_id:e.student_id,invoice_number:"",type:e.type,document_type:e.document_type||"invoice",issue_date:e.issue_date,due_date:e.due_date,amount:r,tax_amount:t,total_amount:r+t,currency:e.currency,status:e.status||"draft",items:[],notes:e.notes||null})}},onSuccess:r=>{"bulk"===v?e.push("/dashboard/payments"):e.push(`/dashboard/payments/${r.id}`)}}),D=I(e=>{S.mutate(e)});return(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,r.jsx)(g.default,{href:"/dashboard/payments",children:(0,r.jsx)(c.Button,{variant:"ghost",size:"icon",children:(0,r.jsx)(p.ArrowLeft,{className:"h-4 w-4"})})}),(0,r.jsxs)("div",{children:[(0,r.jsx)("h1",{className:"text-3xl font-bold text-gray-900",children:"quote"===y?"Nouveau devis":"Nouvelle facture"}),(0,r.jsxs)("p",{className:"mt-2 text-sm text-gray-600",children:["Créez un ","quote"===y?"devis":"facture"," individuel","le"," ou en masse"]})]})]}),(0,r.jsxs)(m.Card,{children:[(0,r.jsx)(m.CardHeader,{children:(0,r.jsx)(m.CardTitle,{children:"Type de document"})}),(0,r.jsx)(m.CardContent,{children:(0,r.jsxs)("div",{className:"flex space-x-4 mb-6",children:[(0,r.jsxs)("button",{type:"button",onClick:()=>L("quote"),className:`flex-1 p-4 border-2 rounded-lg transition-colors ${"quote"===y?"border-primary bg-primary/5":"border-gray-200 hover:border-gray-300"}`,children:[(0,r.jsx)("div",{className:"font-semibold",children:"Devis"}),(0,r.jsx)("div",{className:"text-sm text-muted-foreground mt-1",children:"Estimation avant formation"})]}),(0,r.jsxs)("button",{type:"button",onClick:()=>L("invoice"),className:`flex-1 p-4 border-2 rounded-lg transition-colors ${"invoice"===y?"border-primary bg-primary/5":"border-gray-200 hover:border-gray-300"}`,children:[(0,r.jsx)("div",{className:"font-semibold",children:"Facture"}),(0,r.jsx)("div",{className:"text-sm text-muted-foreground mt-1",children:"Facture après formation"})]})]})})]}),(0,r.jsxs)(m.Card,{children:[(0,r.jsx)(m.CardHeader,{children:(0,r.jsx)(m.CardTitle,{children:"Type de facturation"})}),(0,r.jsx)(m.CardContent,{children:(0,r.jsxs)("div",{className:"flex space-x-4 mb-6",children:[(0,r.jsxs)("button",{type:"button",onClick:()=>x("single"),className:`flex-1 p-4 border-2 rounded-lg transition-colors ${"single"===v?"border-primary bg-primary/5":"border-gray-200 hover:border-gray-300"}`,children:[(0,r.jsx)("div",{className:"font-semibold",children:"quote"===y?"Devis individuel":"Facture individuelle"}),(0,r.jsx)("div",{className:"text-sm text-muted-foreground mt-1",children:"Pour un élève spécifique"})]}),(0,r.jsxs)("button",{type:"button",onClick:()=>x("bulk"),className:`flex-1 p-4 border-2 rounded-lg transition-colors ${"bulk"===v?"border-primary bg-primary/5":"border-gray-200 hover:border-gray-300"}`,children:[(0,r.jsx)("div",{className:"font-semibold",children:"quote"===y?"Génération en masse":"Facturation en masse"}),(0,r.jsx)("div",{className:"text-sm text-muted-foreground mt-1",children:"Pour toute une classe"})]})]})})]}),(0,r.jsxs)(m.Card,{children:[(0,r.jsx)(m.CardHeader,{children:(0,r.jsxs)(m.CardTitle,{children:["Informations du ","quote"===y?"devis":"facture"]})}),(0,r.jsx)(m.CardContent,{children:(0,r.jsxs)("form",{onSubmit:D,className:"space-y-6",children:["bulk"===v&&(0,r.jsx)("div",{className:"bg-warning-bg border border-warning-border rounded-lg p-4 mb-6",children:(0,r.jsx)("p",{className:"text-sm text-warning-primary",children:'La génération en masse n\'est pas encore validée avec Zod. Veuillez utiliser "Facture individuelle" pour bénéficier de la validation complète.'})}),(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Type *"}),(0,r.jsxs)("select",{...N("type"),className:`w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target ${j.type?"border-danger-primary":""}`,children:[(0,r.jsx)("option",{value:"tuition",children:"Scolarité"}),(0,r.jsx)("option",{value:"registration",children:"Inscription"}),(0,r.jsx)("option",{value:"other",children:"Autre"})]}),j.type&&(0,r.jsx)("p",{className:"text-sm text-danger-primary mt-1",children:j.type.message})]}),"single"===v?(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Élève *"}),(0,r.jsxs)("select",{...N("student_id"),className:`w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target ${j.student_id?"border-danger-primary":""}`,children:[(0,r.jsx)("option",{value:"",children:"Sélectionner un élève"}),f?.map(e=>(0,r.jsxs)("option",{value:e.id,children:[e.first_name," ",e.last_name," (",e.student_number,")"]},e.id))]}),j.student_id&&(0,r.jsx)("p",{className:"text-sm text-danger-primary mt-1",children:j.student_id.message})]}):(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Classe *"}),(0,r.jsx)("div",{className:"bg-warning-bg border border-warning-border rounded-lg p-4",children:(0,r.jsx)("p",{className:"text-sm text-warning-primary",children:'La génération en masse n\'est pas encore validée avec Zod. Veuillez utiliser "Facture individuelle".'})})]})]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Montant *"}),(0,r.jsx)("input",{type:"number",step:"0.01",min:"0",...N("amount"),className:`w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target ${j.amount?"border-danger-primary":""}`,placeholder:"0.00"}),j.amount&&(0,r.jsx)("p",{className:"text-sm text-danger-primary mt-1",children:j.amount.message})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2",children:"TVA"}),(0,r.jsx)("input",{type:"number",step:"0.01",min:"0",...N("tax_amount"),className:`w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target ${j.tax_amount?"border-danger-primary":""}`,placeholder:"0.00"}),j.tax_amount&&(0,r.jsx)("p",{className:"text-sm text-danger-primary mt-1",children:j.tax_amount.message})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Devise"}),(0,r.jsxs)("select",{...N("currency"),className:"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target",children:[(0,r.jsx)("option",{value:"XOF",children:"XOF (Franc CFA Ouest)"}),(0,r.jsx)("option",{value:"XAF",children:"XAF (Franc CFA Centre)"}),(0,r.jsx)("option",{value:"EUR",children:"EUR (Euro)"}),(0,r.jsx)("option",{value:"USD",children:"USD (Dollar)"})]})]})]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Date d'émission *"}),(0,r.jsx)("input",{type:"date",...N("issue_date"),className:`w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target ${j.issue_date?"border-danger-primary":""}`}),j.issue_date&&(0,r.jsx)("p",{className:"text-sm text-danger-primary mt-1",children:j.issue_date.message})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Date d'échéance *"}),(0,r.jsx)("input",{type:"date",...N("due_date"),className:`w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-touch-target ${j.due_date?"border-danger-primary":""}`}),j.due_date&&(0,r.jsx)("p",{className:"text-sm text-danger-primary mt-1",children:j.due_date.message})]})]}),"single"===v&&(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Notes"}),(0,r.jsx)("textarea",{...N("notes"),rows:3,className:"w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent",placeholder:"Notes supplémentaires..."})]}),A.amount&&(0,r.jsxs)("div",{className:"bg-gray-50 p-4 rounded-lg",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center",children:[(0,r.jsx)("span",{className:"text-sm text-muted-foreground",children:"Montant HT:"}),(0,r.jsxs)("span",{className:"font-medium",children:[A.amount," ",A.currency]})]}),A.tax_amount&&parseFloat(A.tax_amount)>0&&(0,r.jsxs)("div",{className:"flex justify-between items-center mt-2",children:[(0,r.jsx)("span",{className:"text-sm text-muted-foreground",children:"TVA:"}),(0,r.jsxs)("span",{className:"font-medium",children:[A.tax_amount," ",A.currency]})]}),(0,r.jsxs)("div",{className:"flex justify-between items-center mt-2 pt-2 border-t",children:[(0,r.jsx)("span",{className:"font-semibold",children:"Total TTC:"}),(0,r.jsxs)("span",{className:"font-bold text-lg",children:[(parseFloat(A.amount||"0")+parseFloat(A.tax_amount||"0")).toFixed(2)," ",A.currency]})]})]}),S.error&&(0,r.jsx)("div",{className:"bg-destructive/10 text-destructive px-4 py-3 rounded-lg text-sm",children:S.error instanceof Error?S.error.message:"Une erreur est survenue"}),(0,r.jsxs)("div",{className:"flex justify-end space-x-4 pt-4",children:[(0,r.jsx)(g.default,{href:"/dashboard/payments",children:(0,r.jsx)(c.Button,{type:"button",variant:"outline",children:"Annuler"})}),(0,r.jsx)(c.Button,{type:"submit",disabled:S.isPending,children:S.isPending?"Création...":"bulk"===v?"quote"===y?"Générer les devis":"Générer les factures":"quote"===y?"Créer le devis":"Créer la facture"})]})]})})]})]})}e.s(["default",()=>h])}]);