(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,24899,e=>{"use strict";var t=e.i(843476),a=e.i(618566),n=e.i(522016),s=e.i(271645),i=e.i(167881),r=e.i(645760),o=e.i(871689),l=e.i(356909),d=e.i(174886),c=e.i(475254);let u=(0,c.default)("Archive",[["rect",{width:"20",height:"5",x:"2",y:"3",rx:"1",key:"1wp1u1"}],["path",{d:"M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8",key:"1s80jp"}],["path",{d:"M10 12h4",key:"a56b0p"}]]);var m=e.i(727612),g=e.i(87316),p=e.i(810980),h=e.i(283086),y=e.i(266027),x=e.i(954616),f=e.i(912598),b=e.i(2034),_=e.i(683909),v=e.i(1262),j=e.i(3251),w=e.i(178088),S=e.i(920755),N=e.i(325715),E=e.i(6799),z=e.i(790224),C=e.i(209372),F=e.i(239616);let q=(0,c.default)("FolderOpen",[["path",{d:"m6 14 1.5-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-1.54 6a2 2 0 0 1-1.95 1.5H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3.9a2 2 0 0 1 1.69.9l.81 1.2a2 2 0 0 0 1.67.9H18a2 2 0 0 1 2 2v2",key:"usdka0"}]]);var k=e.i(32095),A=e.i(605631);let I=[{id:"configuration",label:"Configuration",icon:F.Settings,color:"purple"},{id:"gestion",label:"Gestion",icon:q,color:"teal"},{id:"espace_apprenant",label:"Espace Apprenant",icon:k.GraduationCap,color:"blue"},{id:"suivi",label:"Suivi",icon:A.CheckCircle,color:"yellow"}];function T({activeStep:e,onStepChange:a}){return(0,t.jsx)("div",{className:"flex items-center justify-between border-b pb-4",children:I.map((n,s)=>{let i=n.icon,r=e===n.id,o=I.findIndex(t=>t.id===e)>s;return(0,t.jsxs)("button",{onClick:()=>a(n.id),className:`flex items-center space-x-2 px-4 py-2 rounded-lg transition-colors ${r?"purple"===n.color?"bg-purple-100 text-purple-800":"teal"===n.color?"bg-teal-100 text-teal-800":"blue"===n.color?"bg-blue-100 text-blue-800":"bg-warning-bg text-warning-primary":o?"bg-gray-100 text-gray-600":"bg-white text-gray-400 hover:bg-gray-50"}`,children:[(0,t.jsx)(i,{className:"h-5 w-5"}),(0,t.jsx)("span",{className:"font-medium",children:n.label})]},n.id)})})}let D=[{id:"initialisation",label:"Initialisation"},{id:"dates_prix",label:"Dates et prix"},{id:"apprenants",label:"Apprenants"},{id:"programme",label:"Programme"},{id:"intervenants",label:"Intervenants"}];function K({activeTab:e,onTabChange:a}){return(0,t.jsx)("div",{className:"flex space-x-2 border-b pb-2",children:D.map(n=>(0,t.jsx)("button",{onClick:()=>a(n.id),className:`px-4 py-2 font-medium transition-colors ${e===n.id?"border-b-2 border-primary text-primary":"text-muted-foreground hover:text-foreground"}`,children:n.label},n.id))})}e.i(882205);var H=e.i(846932),O=e.i(178583),P=e.i(226691),Q=e.i(842009),M=e.i(212426),G=e.i(607486),L=e.i(39312),B=e.i(647163);let $=[{id:"conventions",label:"Conventions",icon:O.FileText,color:"from-purple-500 to-purple-600"},{id:"convocations",label:"Convocations",icon:P.Bell,color:"from-brand-blue to-brand-cyan"},{id:"evaluations",label:"Évaluations",icon:Q.Award,color:"from-amber-500 to-amber-600"},{id:"finances",label:"Finances",icon:M.DollarSign,color:"from-emerald-500 to-emerald-600"},{id:"espace_entreprise",label:"Espace entreprise",icon:G.Building2,color:"from-blue-500 to-blue-600"},{id:"automatisation",label:"Automatisation",icon:L.Zap,color:"from-orange-500 to-orange-600"}];function R({activeTab:e,onTabChange:a}){return(0,t.jsx)("div",{className:"flex flex-wrap gap-3 p-1.5 bg-gray-50/50 rounded-2xl border-2 border-gray-100",children:$.map((n,s)=>{let i=e===n.id,r=n.icon;return(0,t.jsxs)(H.motion.button,{onClick:()=>a(n.id),initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.05*s,duration:.3,ease:[.16,1,.3,1]},whileHover:{scale:1.05,y:-2},whileTap:{scale:.98},className:(0,B.cn)("relative px-5 py-3 rounded-xl font-semibold text-sm transition-all duration-300 flex items-center gap-2.5 tracking-tight","shadow-sm hover:shadow-lg",i?"bg-white text-gray-900 shadow-xl":"text-gray-600 hover:text-gray-900 hover:bg-white/70"),children:[(0,t.jsx)(H.motion.div,{className:(0,B.cn)("p-1.5 rounded-lg",i?`bg-gradient-to-br ${n.color}`:"bg-gray-100"),whileHover:{rotate:5,scale:1.1},transition:{type:"spring",stiffness:400,damping:10},children:(0,t.jsx)(r,{className:(0,B.cn)("h-4 w-4",i?"text-white":"text-gray-500")})}),(0,t.jsx)("span",{children:n.label}),i&&(0,t.jsx)(H.motion.div,{layoutId:"activeGestionTab",className:(0,B.cn)("absolute bottom-0 left-0 right-0 h-1 rounded-full",`bg-gradient-to-r ${n.color}`),transition:{type:"spring",stiffness:500,damping:30}}),(0,t.jsx)(H.motion.div,{className:"absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent rounded-xl",initial:{x:"-100%"},whileHover:{x:"100%"},transition:{duration:.6,ease:"easeInOut"}})]},n.id)})})}var U=e.i(970065);function W(){return(0,t.jsxs)("div",{className:"space-y-6",children:[(0,t.jsxs)(U.Card,{children:[(0,t.jsx)(U.CardHeader,{children:(0,t.jsx)("div",{className:"h-6 bg-gray-200 rounded w-1/3 animate-pulse"})}),(0,t.jsxs)(U.CardContent,{className:"space-y-4",children:[(0,t.jsxs)("div",{className:"space-y-3",children:[(0,t.jsx)("div",{className:"h-4 bg-gray-200 rounded w-full animate-pulse"}),(0,t.jsx)("div",{className:"h-4 bg-gray-200 rounded w-5/6 animate-pulse"}),(0,t.jsx)("div",{className:"h-4 bg-gray-200 rounded w-4/6 animate-pulse"})]}),(0,t.jsxs)("div",{className:"grid grid-cols-2 gap-4 mt-6",children:[(0,t.jsx)("div",{className:"h-10 bg-gray-200 rounded animate-pulse"}),(0,t.jsx)("div",{className:"h-10 bg-gray-200 rounded animate-pulse"})]})]})]}),(0,t.jsxs)(U.Card,{children:[(0,t.jsx)(U.CardHeader,{children:(0,t.jsx)("div",{className:"h-6 bg-gray-200 rounded w-1/4 animate-pulse"})}),(0,t.jsx)(U.CardContent,{children:(0,t.jsxs)("div",{className:"space-y-3",children:[(0,t.jsx)("div",{className:"h-4 bg-gray-200 rounded w-full animate-pulse"}),(0,t.jsx)("div",{className:"h-4 bg-gray-200 rounded w-3/4 animate-pulse"})]})})]})]})}let Z=(0,s.lazy)(()=>e.A(260970).then(e=>({default:e.ConfigInitialisation}))),V=(0,s.lazy)(()=>e.A(637711).then(e=>({default:e.ConfigDatesPrix}))),X=(0,s.lazy)(()=>e.A(407155).then(e=>({default:e.ConfigProgramme}))),J=(0,s.lazy)(()=>e.A(163882).then(e=>({default:e.ConfigIntervenants}))),Y=(0,s.lazy)(()=>e.A(97042).then(e=>({default:e.ConfigApprenants}))),ee=(0,s.lazy)(()=>e.A(500160).then(e=>({default:e.GestionConventions}))),et=(0,s.lazy)(()=>e.A(815865).then(e=>({default:e.GestionConvocations}))),ea=(0,s.lazy)(()=>e.A(483325).then(e=>({default:e.GestionEvaluations}))),en=(0,s.lazy)(()=>e.A(280612).then(e=>({default:e.GestionFinances}))),es=(0,s.lazy)(()=>e.A(327362).then(e=>({default:e.GestionEspaceEntreprise}))),ei=(0,s.lazy)(()=>e.A(362844).then(e=>({default:e.GestionAutomatisation}))),er=(0,s.lazy)(()=>e.A(17409).then(e=>({default:e.EspaceApprenant}))),eo=(0,s.lazy)(()=>e.A(796136).then(e=>({default:e.Suivi})));function el(){let e=(0,a.useParams)();(0,a.useRouter)();let c=e.id,{activeStep:F,setActiveStep:q,activeTab:k,setActiveTab:A,activeGestionTab:I,setActiveGestionTab:D,formData:O,setFormData:P,slotConfig:Q,setSlotConfig:M,showEnrollmentForm:G,setShowEnrollmentForm:L,session:B,isLoading:$,sessionData:U,formation:el,program:ed,programs:ec,formations:eu,sessionPrograms:em,users:eg,sessionSlots:ep,refetchSlots:eh,enrollments:ey,organization:ex,students:ef,payments:eb,grades:e_,gradesStats:ev,attendanceStats:ej,enrollmentForm:ew,setEnrollmentForm:eS,evaluationForm:eN,setEvaluationForm:eE,showEvaluationForm:ez,setShowEvaluationForm:eC,isGeneratingZip:eF,zipGenerationProgress:eq,lastZipGeneration:ek,updateMutation:eA,createEnrollmentMutation:eI,cancelEnrollmentMutation:eT,createEvaluationMutation:eD,handleSave:eK,user:eH}=function(e){let t=(0,a.useRouter)(),n=(0,a.useSearchParams)(),i=(0,S.createClient)(),r=(0,f.useQueryClient)(),{user:o}=(0,N.useAuth)(),{addToast:l}=(0,E.useToast)(),d=["configuration","gestion","espace_apprenant","suivi"],[c,u]=(0,s.useState)(()=>{{let e=new URLSearchParams(window.location.search).get("step");if(e&&d.includes(e))return e}return"configuration"}),[m,g]=(0,s.useState)("initialisation"),[p,h]=(0,s.useState)("conventions");(0,s.useEffect)(()=>{let e=n.get("step");e&&d.includes(e)&&e!==c&&u(e)},[n]);let[F,q]=(0,s.useState)({name:"",type:"formation_professionnelle",code:"",manager1_id:"",manager2_id:"",inter_entreprise:!0,sous_traitance:!1,timezone:"Europe/Paris",formation_id:"",program_ids:[],start_date:"",end_date:"",start_time:"",end_time:"",location:"",capacity_max:"",teacher_id:"",status:"planned"}),[k,A]=(0,s.useState)(!1),[I,T]=(0,s.useState)({student_id:"",enrollment_date:new Date().toISOString().split("T")[0],status:"confirmed",payment_status:"pending",total_amount:"",paid_amount:"0"}),[D,K]=(0,s.useState)(!1),[H,O]=(0,s.useState)({subject:"",assessment_type:"evaluation_generale",student_id:void 0,score:"",max_score:"20",percentage:"",notes:"",graded_at:new Date().toISOString().split("T")[0]}),[P,Q]=(0,s.useState)({timeSlotType:"both",morningStart:"09:00",morningEnd:"12:00",afternoonStart:"14:00",afternoonEnd:"17:00"}),[M,G]=(0,s.useState)(!1),[L,B]=(0,s.useState)({current:0,total:0}),[$,R]=(0,s.useState)(null),{data:U,isLoading:W}=(0,y.useQuery)({queryKey:["session",e],queryFn:()=>b.sessionService.getSessionById(e),enabled:!!e}),{data:Z}=(0,y.useQuery)({queryKey:["programs",o?.organization_id],queryFn:async()=>o?.organization_id?_.programService.getAllPrograms(o.organization_id,{isActive:!0}):[],enabled:!!o?.organization_id}),{data:V}=(0,y.useQuery)({queryKey:["formations",o?.organization_id,F.program_ids],queryFn:async()=>o?.organization_id?F.program_ids&&0!==F.program_ids.length?(await v.formationService.getAllFormations(o.organization_id,{isActive:!0})).map(e=>({...e,programs:e.programs||void 0})).filter(e=>e.program_id&&F.program_ids.includes(e.program_id)):v.formationService.getAllFormations(o.organization_id,{isActive:!0}):[],enabled:!!o?.organization_id}),{data:X}=(0,y.useQuery)({queryKey:["session-programs",e],queryFn:async()=>e?b.sessionService.getSessionPrograms(e):[],enabled:!!e}),{data:J}=(0,y.useQuery)({queryKey:["users",o?.organization_id],queryFn:async()=>{if(!o?.organization_id)return[];let{data:e,error:t}=await i.from("users").select("id, full_name, email, role").eq("organization_id",o.organization_id).eq("is_active",!0);if(t)throw t;return e||[]},enabled:!!o?.organization_id}),{data:Y,refetch:ee}=(0,y.useQuery)({queryKey:["session-slots",e],queryFn:async()=>e?j.sessionSlotService.getBySessionId(e):[],enabled:!!e}),{data:et,isLoading:ea}=(0,y.useQuery)({queryKey:["session-enrollments",e],queryFn:async()=>{if(!e)return[];let{data:t,error:a}=await i.from("enrollments").select(`
          *,
          students (
            id,
            first_name,
            last_name,
            student_number,
            email,
            phone,
            photo_url,
            date_of_birth,
            gender,
            address,
            city,
            status,
            organization_id
          ),
          sessions (*)
        `).eq("session_id",e).order("enrollment_date",{ascending:!1});if(a)throw a;return t||[]},enabled:!!e,refetchOnWindowFocus:!0,refetchOnMount:!0}),{data:en}=(0,y.useQuery)({queryKey:["session-payments",e],queryFn:async()=>{if(!e)return[];let{data:t,error:a}=await i.from("payments").select("*, students(*), invoices(*)").eq("organization_id",o?.organization_id||"").in("student_id",et?.map(e=>e.student_id).filter(e=>null!==e)||[]).order("paid_at",{ascending:!1});if(a)throw a;return t||[]},enabled:!!e&&!!et&&!!o?.organization_id,refetchOnWindowFocus:!0,refetchOnMount:!0}),{data:es}=(0,y.useQuery)({queryKey:["students",o?.organization_id],queryFn:async()=>{if(!o?.organization_id)return[];let{data:e,error:t}=await i.from("students").select("id, first_name, last_name, student_number, email").eq("organization_id",o.organization_id).eq("status","active").order("last_name",{ascending:!0});if(t)throw t;return e||[]},enabled:!!o?.organization_id}),{data:ei,isLoading:er}=(0,y.useQuery)({queryKey:["session-attendance-stats",e],queryFn:async()=>{if(!e)return null;let{data:t,error:a}=await i.from("attendance").select("status, student_id").eq("session_id",e);if(a)throw a;let n=t||[],s={total:n.length,present:n.filter(e=>"present"===e.status).length,absent:n.filter(e=>"absent"===e.status).length,late:n.filter(e=>"late"===e.status).length,excused:n.filter(e=>"excused"===e.status).length,byStudent:{}};return n.forEach(e=>{s.byStudent[e.student_id]||(s.byStudent[e.student_id]={present:0,total:0}),s.byStudent[e.student_id].total++,("present"===e.status||"late"===e.status)&&s.byStudent[e.student_id].present++}),s},enabled:!!e,refetchOnWindowFocus:!0,refetchOnMount:!0}),{data:eo,isLoading:el}=(0,y.useQuery)({queryKey:["session-grades",e],queryFn:async()=>{if(!e)return[];let{data:t,error:a}=await i.from("grades").select("*, students(*)").eq("session_id",e).order("graded_at",{ascending:!1});if(a)throw a;return t||[]},enabled:!!e,refetchOnWindowFocus:!0,refetchOnMount:!0}),{data:ed}=(0,y.useQuery)({queryKey:["organization",o?.organization_id],queryFn:async()=>{if(!o?.organization_id)return null;let{data:e,error:t}=await i.from("organizations").select("*").eq("id",o.organization_id).single();if(t)throw t;return e},enabled:!!o?.organization_id}),ec=U?.formations,eu=ec?.programs;(0,s.useEffect)(()=>{if(U&&X){let e=U?.formations,t=e?.programs,a=[];X&&X.length>0?a=X.map(e=>e.id):U.session_programs&&U.session_programs.length>0?a=U.session_programs.map(e=>e.id):t?.id&&(a=[t.id]),q({name:U.name||"",type:"formation_professionnelle",code:U.code||"",manager1_id:U.manager1_id||o?.id||"",manager2_id:U.manager2_id||"",inter_entreprise:U.inter_entreprise??!0,sous_traitance:U.sous_traitance??!1,timezone:U.timezone||"Europe/Paris",formation_id:e?.id||"",program_ids:a,start_date:U.start_date?.split("T")[0]||"",end_date:U.end_date?.split("T")[0]||"",start_time:U.start_time||"",end_time:U.end_time||"",location:U.location||"",capacity_max:U.capacity_max?.toString()||"",teacher_id:U.teacher_id||"",status:U.status||"planned"}),e&&T(t=>({...t,total_amount:t.total_amount||e.price?.toString()||"0"}))}},[U,o?.id,X]);let em=(0,x.useMutation)({mutationFn:async t=>b.sessionService.updateSession(e,t),onSuccess:()=>{r.invalidateQueries({queryKey:["session",e]})},onError:t=>{z.logger.error("Erreur lors de la mise à jour de la session",t,{sessionId:e})}}),eg=(0,x.useMutation)({mutationFn:async({programIds:t,organizationId:a})=>b.sessionService.updateSessionPrograms(e,t,a),onSuccess:()=>{r.invalidateQueries({queryKey:["session",e]}),r.invalidateQueries({queryKey:["session-programs",e]})}}),ep=(0,x.useMutation)({mutationFn:async()=>{if(!e||!F.start_date||!F.end_date)throw Error("Les dates de début et de fin sont requises");return j.sessionSlotService.generateSlots({sessionId:e,startDate:F.start_date,endDate:F.end_date,timeSlotType:"full_day"===P.timeSlotType?"both":P.timeSlotType,morningStart:P.morningStart,morningEnd:P.morningEnd,afternoonStart:P.afternoonStart,afternoonEnd:P.afternoonEnd,location:F.location||void 0,teacherId:F.teacher_id||void 0,capacityMax:F.capacity_max?parseInt(F.capacity_max):void 0})},onSuccess:()=>{ee()},onError:t=>{z.logger.error("Erreur lors de la génération des séances",t,{sessionId:e,slotConfig:P})}}),eh=(0,x.useMutation)({mutationFn:async e=>j.sessionSlotService.delete(e),onSuccess:()=>{ee()}}),ey=(0,x.useMutation)({mutationFn:async t=>j.sessionSlotService.create({session_id:e,date:t.date,time_slot:t.time_slot,start_time:t.start_time,end_time:t.end_time,location:F.location||null,teacher_id:F.teacher_id||null,capacity_max:F.capacity_max?parseInt(F.capacity_max):null}),onSuccess:()=>{ee()}}),ex=(0,x.useMutation)({mutationFn:async()=>{try{let t={student_id:I.student_id,session_id:e,enrollment_date:I.enrollment_date,status:I.status,payment_status:I.payment_status,total_amount:I.total_amount||"",paid_amount:I.paid_amount||"0"};C.enrollmentSchema.parse(t)}catch(e){if(e instanceof Error||e.errors){let t=(e.errors||[]).map(e=>`${e.path.join(".")}: ${e.message}`).join(", ");throw Error(`Erreur de validation : ${t}`)}throw e}let{data:t,error:a}=await i.from("sessions").select("id, start_date, end_date, status, capacity_max").eq("id",e).single();if(a||!t)throw Error("Session non trouvée");let n=new Date;n.setHours(0,0,0,0);let s=t.end_date?new Date(t.end_date):null;if(s&&s.setHours(23,59,59,999),"completed"===t.status||"cancelled"===t.status||s&&s<n)throw Error("Impossible d'inscrire un apprenant à une session terminée ou annulée");let{data:r}=await i.from("enrollments").select("id").eq("session_id",e).eq("student_id",I.student_id).maybeSingle();if(r)throw Error("Cet élève est déjà inscrit à cette session");if(null!==t.capacity_max&&t.capacity_max>0){let{count:a,error:n}=await i.from("enrollments").select("*",{count:"exact",head:!0}).eq("session_id",e).in("status",["confirmed","pending"]);if(n)throw Error("Erreur lors de la vérification de la capacité");if(null!==a&&a>=t.capacity_max)throw Error(`La session est compl\xe8te (${t.capacity_max} apprenants maximum)`)}let{data:o,error:l}=await i.from("enrollments").insert({student_id:I.student_id,session_id:e,enrollment_date:I.enrollment_date,status:I.status,payment_status:I.payment_status,total_amount:parseFloat(I.total_amount)||0,paid_amount:parseFloat(I.paid_amount)||0}).select().single();if(l){if("23505"===l.code)throw Error("Cet élève est déjà inscrit à cette session");throw l}return o},onSuccess:()=>{r.invalidateQueries({queryKey:["session-enrollments",e]}),r.invalidateQueries({queryKey:["session",e]}),A(!1),T({student_id:"",enrollment_date:new Date().toISOString().split("T")[0],status:"confirmed",payment_status:"pending",total_amount:ec?.price?.toString()||"0",paid_amount:"0"})}}),ef=(0,x.useMutation)({mutationFn:async e=>{let{data:t,error:a}=await i.from("enrollments").select("id, session_id, student_id").eq("id",e).single();if(a||!t)throw Error("Inscription non trouvée");let{data:n,error:s}=await i.from("sessions").select("id, start_date, end_date, status").eq("id",t.session_id||"").single();if(s||!n)throw Error("Session non trouvée");let r=new Date;r.setHours(0,0,0,0);let o=n.end_date?new Date(n.end_date):null;if(o&&o.setHours(23,59,59,999),"completed"===n.status||o&&o<r)throw Error("Impossible d'annuler une inscription pour une session déjà terminée");let{data:l,error:d}=await i.from("invoices").select("id, document_type, status").eq("enrollment_id",e).eq("document_type","invoice").maybeSingle();if(d)throw Error("Erreur lors de la vérification des factures");if(l)throw Error("Impossible d'annuler une inscription pour laquelle une facture a été émise");let{data:c,error:u}=await i.from("enrollments").update({status:"cancelled"}).eq("id",e).select().single();if(u)throw u;return c},onSuccess:()=>{r.invalidateQueries({queryKey:["session-enrollments",e]}),r.invalidateQueries({queryKey:["session",e]}),l({type:"success",title:"Inscription annulée",description:"L'inscription a été annulée avec succès."})},onError:t=>{l({type:"error",title:"Erreur",description:t instanceof Error?t.message:"Une erreur est survenue lors de l'annulation de l'inscription."}),z.logger.error("Erreur lors de l'annulation de l'inscription",t,{sessionId:e})}}),eb=(0,x.useMutation)({mutationFn:async()=>{var t;if(!H.subject)throw Error("Le sujet est requis");if(!o?.organization_id)throw Error("Organisation non trouvée");let a=H.max_score?parseFloat(H.max_score):null,n=H.score?parseFloat(H.score):null,s=(t=H.assessment_type)&&({evaluation_generale:"other",preformation:"pre_formation",a_chaud:"hot",a_froid:"cold",managers:"manager",intervenants:"instructor",financeurs:"funder",quiz:"quiz",exam:"exam",project:"project",other:"other",pre_formation:"pre_formation",hot:"hot",cold:"cold",manager:"manager",instructor:"instructor",funder:"funder"})[t]||"other",i={subject:H.subject,assessment_type:s,student_id:H.student_id||null,session_id:e,score:n,max_score:a,notes:H.notes||null,graded_at:H.graded_at||new Date().toISOString(),teacher_id:o.id||null};Object.keys(i).forEach(e=>{void 0===i[e]&&(i[e]=null)});try{return await w.evaluationService.create(o.organization_id,i)}catch(e){throw console.error("Erreur détaillée création évaluation:",{error:e,message:e?.message,code:e?.code,details:e?.details,hint:e?.hint,evaluationData:i,organizationId:o.organization_id}),e}},onSuccess:()=>{r.invalidateQueries({queryKey:["session-grades",e]}),K(!1),O({subject:"",assessment_type:"evaluation_generale",student_id:void 0,score:"",max_score:"20",percentage:"",notes:"",graded_at:new Date().toISOString().split("T")[0]}),l({type:"success",title:"Évaluation créée",description:"L'évaluation a été créée avec succès."})},onError:t=>{l({type:"error",title:"Erreur",description:t instanceof Error?t.message:"Une erreur est survenue lors de la création de l'évaluation."}),z.logger.error("Erreur lors de la création de l'évaluation",t,{sessionId:e,evaluationForm:H})}}),e_=async()=>{try{let e={formation_id:F.formation_id,name:F.name,code:F.code||"",start_date:F.start_date,end_date:F.end_date,start_time:F.start_time||"",end_time:F.end_time||"",location:F.location||"",capacity_max:F.capacity_max||"",currency:"XOF",status:F.status,teacher_id:F.teacher_id||"",manager1_id:F.manager1_id||"",manager2_id:F.manager2_id||"",inter_entreprise:F.inter_entreprise,sous_traitance:F.sous_traitance,timezone:F.timezone,program_ids:F.program_ids};C.sessionSchema.parse(e)}catch(e){if(e instanceof Error||e.errors){let t=(e.errors||[]).map(e=>`${e.path.join(".")}: ${e.message}`).join(", ");l({type:"error",title:"Erreur de validation",description:`Veuillez corriger les erreurs suivantes : ${t}`}),z.logger.error("Erreur de validation Zod",e,{formData:F});return}}let e={name:F.name,start_date:F.start_date,end_date:F.end_date,start_time:F.start_time||null,end_time:F.end_time||null,location:F.location||null,capacity_max:F.capacity_max?parseInt(F.capacity_max):null,teacher_id:F.teacher_id||null,status:F.status};F.formation_id&&F.formation_id!==U?.formation_id&&(e.formation_id=F.formation_id),await em.mutateAsync(e),o?.organization_id&&F.program_ids&&await eg.mutateAsync({programIds:F.program_ids,organizationId:o.organization_id})},ev=eo&&eo.length>0?{total:eo.length,average:eo.reduce((e,t)=>e+(Number(t.score)||0),0)/eo.length,averagePercentage:eo.reduce((e,t)=>{let a=Number(t.max_score)||20;return e+(Number(t.score)||0)/a*100},0)/eo.length}:null;return{activeStep:c,setActiveStep:a=>{u(a);let s=new URLSearchParams(n.toString());s.set("step",a),t.push(`/dashboard/sessions/${e}?${s.toString()}`,{scroll:!1})},activeTab:m,setActiveTab:g,activeGestionTab:p,setActiveGestionTab:h,formData:F,setFormData:q,enrollmentForm:I,setEnrollmentForm:T,showEnrollmentForm:k,setShowEnrollmentForm:A,evaluationForm:H,setEvaluationForm:O,showEvaluationForm:D,setShowEvaluationForm:K,slotConfig:P,setSlotConfig:Q,isGeneratingZip:M,setIsGeneratingZip:G,zipGenerationProgress:L,setZipGenerationProgress:B,lastZipGeneration:$,setLastZipGeneration:R,session:U,sessionData:U,formation:ec,program:eu,programs:Z,formations:V,sessionPrograms:X,users:J,sessionSlots:Y,enrollments:et,payments:en,students:es,attendanceStats:ei,grades:eo,gradesStats:ev,organization:ed,isLoading:W||ea||er||el,updateMutation:em,updateProgramsMutation:eg,generateSlotsMutation:ep,deleteSlotMutation:eh,createSlotMutation:ey,createEnrollmentMutation:ex,cancelEnrollmentMutation:ef,createEvaluationMutation:eb,handleSave:e_,refetchSlots:ee,user:o,router:t,queryClient:r,supabase:i}}(c),eO={hidden:{opacity:0,y:20},visible:{opacity:1,y:0,transition:{duration:.5,ease:[.16,1,.3,1]}}};return $?(0,t.jsxs)(H.motion.div,{className:"space-y-8 pb-8 max-w-[1600px] mx-auto",initial:{opacity:0},animate:{opacity:1},transition:{duration:.3},children:[(0,t.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,t.jsx)("div",{className:"h-4 bg-gradient-to-r from-gray-200 to-gray-300 rounded w-32 animate-pulse"}),(0,t.jsx)("div",{className:"h-4 bg-gradient-to-r from-gray-200 to-gray-300 rounded w-4 animate-pulse"}),(0,t.jsx)("div",{className:"h-4 bg-gradient-to-r from-gray-200 to-gray-300 rounded w-24 animate-pulse"})]}),(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,t.jsx)("div",{className:"w-12 h-12 bg-gradient-to-br from-brand-blue/20 to-brand-cyan/20 rounded-2xl animate-pulse"}),(0,t.jsxs)("div",{className:"space-y-3",children:[(0,t.jsx)("div",{className:"h-10 bg-gradient-to-r from-gray-200 to-gray-300 rounded-xl w-64 animate-pulse"}),(0,t.jsx)("div",{className:"h-4 bg-gradient-to-r from-gray-200 to-gray-300 rounded w-48 animate-pulse"})]})]}),(0,t.jsx)("div",{className:"h-12 w-36 bg-gradient-to-br from-brand-blue/20 to-brand-cyan/20 rounded-xl animate-pulse"})]}),(0,t.jsx)("div",{className:"h-20 bg-gradient-to-r from-gray-100 to-gray-200 rounded-2xl animate-pulse"}),(0,t.jsx)(W,{})]}):B?(0,t.jsxs)(H.motion.div,{className:"space-y-8 pb-8 max-w-[1600px] mx-auto",variants:{hidden:{opacity:0},visible:{opacity:1,transition:{staggerChildren:.1}}},initial:"hidden",animate:"visible",children:[(0,t.jsxs)(H.motion.div,{variants:eO,className:"flex items-center space-x-2 text-sm",children:[(0,t.jsx)(n.default,{href:"/dashboard/sessions",className:"text-gray-500 hover:text-brand-blue transition-colors font-medium tracking-tight",children:"Toutes mes sessions"}),(0,t.jsx)("span",{className:"text-gray-300",children:"/"}),(0,t.jsx)("span",{className:"text-gray-700 font-semibold tracking-tight",children:O.name||U?.name}),"configuration"!==F&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("span",{className:"text-gray-300",children:"/"}),(0,t.jsx)("span",{className:"text-brand-blue font-bold tracking-tight",children:"gestion"===F?"Gestion":"espace_apprenant"===F?"Espace Apprenant":"suivi"===F?"Suivi":""})]})]}),(0,t.jsxs)(H.motion.div,{variants:eO,className:"flex flex-col md:flex-row items-start md:items-center justify-between gap-6",children:[(0,t.jsxs)("div",{className:"flex items-center gap-4",children:[(0,t.jsx)(n.default,{href:"/dashboard/sessions",children:(0,t.jsx)(H.motion.div,{whileHover:{scale:1.1,x:-3},whileTap:{scale:.95},transition:{type:"spring",stiffness:400,damping:15},children:(0,t.jsx)(i.Button,{variant:"ghost",size:"icon",className:"h-12 w-12 rounded-2xl hover:bg-gradient-to-br hover:from-brand-blue/10 hover:to-brand-cyan/10 transition-all",children:(0,t.jsx)(o.ArrowLeft,{className:"h-5 w-5"})})})}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("div",{className:"flex items-center gap-3 mb-2",children:[(0,t.jsx)(H.motion.div,{className:"p-2.5 bg-gradient-to-br from-brand-blue to-brand-cyan rounded-2xl shadow-lg shadow-brand-blue/20",whileHover:{scale:1.1,rotate:5},transition:{type:"spring",stiffness:400,damping:10},children:(0,t.jsx)(g.Calendar,{className:"h-6 w-6 text-white"})}),(0,t.jsx)("h1",{className:"text-3xl md:text-5xl font-display font-bold text-gray-900 tracking-tighter leading-none",children:O.name||U?.name}),(0,t.jsxs)(H.motion.div,{className:"px-3 py-1.5 bg-gradient-to-br from-brand-blue-ghost to-brand-cyan-ghost border-2 border-brand-blue/20 rounded-xl flex items-center gap-2 shadow-sm",whileHover:{scale:1.05},transition:{type:"spring",stiffness:400,damping:10},children:[(0,t.jsx)(h.Sparkles,{className:"h-4 w-4 text-brand-blue"}),(0,t.jsx)("span",{className:"text-xs font-bold text-brand-blue uppercase tracking-wide",children:"Session active"})]})]}),el&&(0,t.jsxs)("div",{className:"flex items-center gap-2 text-gray-600",children:[(0,t.jsx)(p.BookOpen,{className:"h-4 w-4 text-brand-cyan"}),(0,t.jsxs)("p",{className:"text-base font-medium tracking-tight",children:[el.name,ed&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("span",{className:"mx-2 text-gray-300",children:"•"}),(0,t.jsx)("span",{className:"text-brand-blue font-semibold",children:ed.name})]})]})]})]})]}),(0,t.jsx)(H.motion.div,{whileHover:{scale:1.05,y:-3},whileTap:{scale:.98},className:"flex items-center space-x-3",children:(0,t.jsxs)(i.Button,{onClick:eK,disabled:eA.isPending,className:"bg-gradient-to-br from-brand-blue to-brand-cyan text-white hover:from-brand-blue-dark hover:to-brand-cyan-dark shadow-xl shadow-brand-blue/20 hover:shadow-2xl hover:shadow-brand-cyan/30 transition-all duration-500 font-semibold tracking-tight px-6 py-6 text-base",children:[(0,t.jsx)(l.Save,{className:"mr-2 h-5 w-5"}),eA.isPending?"Sauvegarde...":"Enregistrer"]})})]}),(0,t.jsx)(H.motion.div,{variants:eO,children:(0,t.jsx)(T,{activeStep:F,onStepChange:q})}),(0,t.jsxs)("div",{children:["configuration"===F&&(0,t.jsx)(H.motion.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},transition:{duration:.2},children:(0,t.jsx)(K,{activeTab:k,onTabChange:A})},"config-tabs"),"gestion"===F&&(0,t.jsx)(H.motion.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},transition:{duration:.2},children:(0,t.jsx)(R,{activeTab:I,onTabChange:D})},"gestion-tabs")]}),(0,t.jsx)(H.motion.div,{variants:eO,children:(0,t.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-4 gap-6",children:[(0,t.jsxs)("div",{className:"lg:col-span-3 space-y-6",children:["configuration"===F&&"initialisation"===k&&(0,t.jsx)(s.Suspense,{fallback:(0,t.jsx)(W,{}),children:(0,t.jsx)(Z,{formData:O,onFormDataChange:P,users:eg})}),"configuration"===F&&"dates_prix"===k&&(0,t.jsx)(s.Suspense,{fallback:(0,t.jsx)(W,{}),children:(0,t.jsx)(V,{sessionId:c,formData:O,onFormDataChange:P,slotConfig:Q,onSlotConfigChange:M,sessionSlots:ep,onSlotsRefetch:eh})}),"configuration"===F&&"programme"===k&&(0,t.jsx)(s.Suspense,{fallback:(0,t.jsx)(W,{}),children:(0,t.jsx)(X,{formData:O,onFormDataChange:P,programs:ec,formations:eu,sessionPrograms:em,formation:el||void 0,program:ed||void 0})}),"configuration"===F&&"intervenants"===k&&(0,t.jsx)(s.Suspense,{fallback:(0,t.jsx)(W,{}),children:(0,t.jsx)(J,{formData:O,onFormDataChange:P,users:eg})}),"configuration"===F&&"apprenants"===k&&(0,t.jsx)(s.Suspense,{fallback:(0,t.jsx)(W,{}),children:(0,t.jsx)(Y,{sessionId:c,formationId:O.formation_id,enrollments:ey,students:ef,enrollmentForm:ew,onEnrollmentFormChange:e=>{eS({...e,status:e.status||"pending",payment_status:e.payment_status||"pending"})},onCreateEnrollment:()=>eI.mutate(),createEnrollmentMutation:eI,formationPrice:el?.price?"number"==typeof el.price?el.price:"string"==typeof el.price&&parseFloat(el.price)||void 0:void 0})}),"gestion"===F&&"conventions"===I&&(0,t.jsx)(s.Suspense,{fallback:(0,t.jsx)(W,{}),children:(0,t.jsx)(ee,{sessionData:U,formation:el||void 0,program:ed||void 0,organization:ex,enrollments:ey,isLoading:!ey,onShowEnrollmentForm:()=>{D("convocations"),L(!0)},onSwitchTab:e=>D(e)})}),"gestion"===F&&"convocations"===I&&(0,t.jsx)(s.Suspense,{fallback:(0,t.jsx)(W,{}),children:(0,t.jsx)(et,{sessionId:c,sessionData:U,formation:el||void 0,program:ed||void 0,organization:ex,enrollments:ey,students:ef,showEnrollmentForm:G,enrollmentForm:ew,onEnrollmentFormChange:e=>{eS({...e,status:e.status||"pending",payment_status:e.payment_status||"pending"})},onCreateEnrollment:()=>eI.mutate(),createEnrollmentMutation:eI,cancelEnrollmentMutation:eT,onCloseEnrollmentForm:()=>L(!1),onShowEnrollmentForm:()=>L(!0),isGeneratingZip:eF,zipGenerationProgress:eq,lastZipGeneration:ek})}),"gestion"===F&&"evaluations"===I&&(0,t.jsx)(s.Suspense,{fallback:(0,t.jsx)(W,{}),children:(0,t.jsx)(ea,{grades:e_,gradesStats:ev,students:ef,showEvaluationForm:ez,evaluationForm:eN,onEvaluationFormChange:eE,onCreateEvaluation:()=>eD.mutate(),createEvaluationMutation:eD,onCloseEvaluationForm:()=>eC(!1),onShowEvaluationForm:(e,t)=>{eE({...eN,assessment_type:e||"evaluation_generale",subject:t||"Évaluation générale"}),eC(!0)}})}),"gestion"===F&&"finances"===I&&(0,t.jsx)(s.Suspense,{fallback:(0,t.jsx)(W,{}),children:(0,t.jsx)(en,{enrollments:ey,payments:eb,sessionId:c,sessionData:U,organization:ex})}),"gestion"===F&&"espace_entreprise"===I&&(0,t.jsx)(s.Suspense,{fallback:(0,t.jsx)(W,{}),children:(0,t.jsx)(es,{sessionData:U,formation:el||void 0,program:ed||void 0,organization:ex,enrollments:ey})}),"gestion"===F&&"automatisation"===I&&(0,t.jsx)(s.Suspense,{fallback:(0,t.jsx)(W,{}),children:(0,t.jsx)(ei,{sessionId:c,sessionData:U})}),"espace_apprenant"===F&&(0,t.jsx)(s.Suspense,{fallback:(0,t.jsx)(W,{}),children:(0,t.jsx)(er,{sessionId:c,sessionData:U,formation:el||void 0,program:ed||void 0,organization:ex,enrollments:ey,grades:e_,attendanceStats:ej,organizationId:eH?.organization_id||void 0,onShowEnrollmentForm:()=>{q("gestion"),D("convocations"),L(!0)},onSwitchToGestion:()=>{q("gestion"),D("convocations")}})}),"suivi"===F&&(0,t.jsx)(s.Suspense,{fallback:(0,t.jsx)(W,{}),children:(0,t.jsx)(eo,{sessionData:U,formation:el||void 0,program:ed||void 0,organization:ex,enrollments:ey,grades:e_,gradesStats:ev,attendanceStats:ej})})]}),(0,t.jsx)("div",{className:"lg:col-span-1 space-y-6",children:(0,t.jsxs)(r.GlassCard,{variant:"premium",className:"overflow-hidden border-2 border-transparent hover:border-brand-blue/20 transition-all duration-500",children:[(0,t.jsx)("div",{className:"p-6 border-b-2 border-gray-100",children:(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)(H.motion.div,{className:"p-2 bg-gradient-to-br from-brand-blue to-brand-cyan rounded-xl shadow-md",whileHover:{rotate:5,scale:1.1},transition:{type:"spring",stiffness:400,damping:10},children:(0,t.jsx)(h.Sparkles,{className:"h-5 w-5 text-white"})}),(0,t.jsx)("h3",{className:"text-lg font-display font-bold text-gray-900 tracking-tight",children:"Actions rapides"})]})}),(0,t.jsxs)("div",{className:"p-4 space-y-3",children:[(0,t.jsx)(H.motion.div,{whileHover:{x:4,scale:1.02},whileTap:{scale:.98},children:(0,t.jsxs)(i.Button,{variant:"outline",className:"w-full justify-start gap-3 h-12 rounded-xl border-2 border-gray-200 hover:border-brand-blue/30 hover:bg-brand-blue-ghost transition-all font-semibold tracking-tight",size:"sm",children:[(0,t.jsx)("div",{className:"p-1.5 bg-brand-blue/10 rounded-lg",children:(0,t.jsx)(d.Copy,{className:"h-4 w-4 text-brand-blue"})}),(0,t.jsx)("span",{children:"Cloner la session"})]})}),(0,t.jsx)(H.motion.div,{whileHover:{x:4,scale:1.02},whileTap:{scale:.98},children:(0,t.jsxs)(i.Button,{variant:"outline",className:"w-full justify-start gap-3 h-12 rounded-xl border-2 border-gray-200 hover:border-brand-cyan/30 hover:bg-brand-cyan-ghost transition-all font-semibold tracking-tight",size:"sm",children:[(0,t.jsx)("div",{className:"p-1.5 bg-brand-cyan/10 rounded-lg",children:(0,t.jsx)(u,{className:"h-4 w-4 text-brand-cyan"})}),(0,t.jsx)("span",{children:"Archiver"})]})}),(0,t.jsx)(H.motion.div,{whileHover:{x:4,scale:1.02},whileTap:{scale:.98},children:(0,t.jsxs)(i.Button,{variant:"outline",className:"w-full justify-start gap-3 h-12 rounded-xl border-2 border-red-200 hover:border-red-400 hover:bg-red-50 text-red-600 hover:text-red-700 transition-all font-semibold tracking-tight",size:"sm",children:[(0,t.jsx)("div",{className:"p-1.5 bg-red-100 rounded-lg",children:(0,t.jsx)(m.Trash2,{className:"h-4 w-4 text-red-600"})}),(0,t.jsx)("span",{children:"Supprimer"})]})})]})]})})]})})]}):(0,t.jsx)(H.motion.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},transition:{duration:.5,ease:[.16,1,.3,1]},className:"flex items-center justify-center min-h-screen",children:(0,t.jsxs)(r.GlassCard,{variant:"premium",className:"p-16 text-center border-2 border-dashed border-gray-200",children:[(0,t.jsx)(H.motion.div,{initial:{scale:.8,opacity:0},animate:{scale:1,opacity:1},transition:{delay:.2,duration:.5,ease:[.16,1,.3,1]},className:"w-20 h-20 bg-gradient-to-br from-brand-blue/10 to-brand-cyan/10 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-lg",children:(0,t.jsx)(g.Calendar,{className:"h-10 w-10 text-brand-blue"})}),(0,t.jsx)(H.motion.h3,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.3,duration:.5},className:"text-2xl font-display font-bold text-gray-900 mb-2 tracking-tight",children:"Session non trouvée"}),(0,t.jsx)(H.motion.p,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.4,duration:.5},className:"text-gray-600 mb-8 font-medium tracking-tight",children:"Cette session n'existe pas ou a été supprimée."}),(0,t.jsx)(H.motion.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.5,duration:.5},whileHover:{scale:1.05,y:-3},whileTap:{scale:.98},children:(0,t.jsx)(n.default,{href:"/dashboard/sessions",children:(0,t.jsxs)(i.Button,{className:"bg-gradient-to-br from-brand-blue to-brand-cyan text-white hover:from-brand-blue-dark hover:to-brand-cyan-dark shadow-xl shadow-brand-blue/20 hover:shadow-2xl hover:shadow-brand-cyan/30 transition-all duration-500 font-semibold tracking-tight px-6 py-6 text-base",children:[(0,t.jsx)(o.ArrowLeft,{className:"mr-2 h-5 w-5"}),"Retour à la liste"]})})})]})})}e.s(["default",()=>el],24899)}]);