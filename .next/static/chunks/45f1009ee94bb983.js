(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,263488,e=>{"use strict";let t=(0,e.i(475254).default)("Mail",[["rect",{width:"20",height:"16",x:"2",y:"4",rx:"2",key:"18n3k1"}],["path",{d:"m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7",key:"1ocrg3"}]]);e.s(["Mail",()=>t],263488)},879002,e=>{"use strict";let t=(0,e.i(475254).default)("UserPlus",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"19",x2:"19",y1:"8",y2:"14",key:"1bvyxn"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]]);e.s(["UserPlus",()=>t],879002)},669671,e=>{"use strict";let t=new class{async blobToBase64(e){return new Promise((t,s)=>{let n=new FileReader;n.onloadend=()=>{t(n.result.split(",")[1])},n.onerror=s,n.readAsDataURL(e)})}async sendEmail(e){try{let t=e.attachments?await Promise.all(e.attachments.map(async e=>{let t;if(e.content instanceof Blob)t=await this.blobToBase64(e.content);else if(e.content instanceof ArrayBuffer){let s=new Blob([e.content],{type:e.contentType});t=await this.blobToBase64(s)}else t=e.content;return{filename:e.filename,content:t,contentType:e.contentType}})):void 0,s=await fetch("/api/email/send",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({to:e.to,subject:e.subject,html:e.html,text:e.text,attachments:t,cc:e.cc,bcc:e.bcc,replyTo:e.replyTo})});if(!s.ok){let e=await s.json();throw Error(e.message||"Erreur lors de l'envoi de l'email")}let n=await s.json();return{success:!0,message:n.message||"Email envoyé avec succès"}}catch(e){throw Error(e instanceof Error?e.message:"Erreur lors de l'envoi de l'email")}}async sendDocument(e,t,s,n,a,l){return this.sendEmail({to:e,subject:t,html:a,text:l,attachments:[{filename:n,content:s,contentType:"application/pdf"}]})}async sendMultipleDocuments(e,t,s,n,a){return this.sendEmail({to:e,subject:t,html:n,text:a,attachments:s.map(e=>({filename:e.filename,content:e.blob,contentType:"application/pdf"}))})}};e.s(["emailService",0,t])},233009,e=>{"use strict";var t=e.i(843476),s=e.i(271645),n=e.i(970065),a=e.i(167881),l=e.i(440160),r=e.i(263488),i=e.i(879002),c=e.i(37727),o=e.i(178583),d=e.i(727612),u=e.i(647163),m=e.i(348572),x=e.i(630374),h=e.i(23750),p=e.i(184762),j=e.i(10708);function b({sessionId:e,sessionData:b,formation:g,program:v,organization:y,enrollments:f=[],students:N=[],showEnrollmentForm:w,enrollmentForm:C,onEnrollmentFormChange:k,onCreateEnrollment:T,createEnrollmentMutation:_,cancelEnrollmentMutation:P,onCloseEnrollmentForm:B,onShowEnrollmentForm:E,isGeneratingZip:D=!1,zipGenerationProgress:S={current:0,total:0},lastZipGeneration:A=null}){let{handleGenerateConvocation:M,handleGenerateAllConvocationsZip:U,handleSendConvocationByEmail:F,handleSendConvocationByEmailWithCustomContent:I,handleSendAllConvocationsByEmail:z,prepareConvocationEmail:$}=(0,m.useDocumentGeneration)({sessionData:b,formation:g,program:v,organization:y}),[G,L]=(0,s.useState)(null),[O,H]=(0,s.useState)(null);return(0,t.jsxs)("div",{className:"space-y-6",children:[w&&(0,t.jsxs)(n.Card,{children:[(0,t.jsx)(n.CardHeader,{children:(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsx)(n.CardTitle,{children:"Inscrire un apprenant"}),(0,t.jsx)(a.Button,{variant:"ghost",size:"icon",onClick:B,children:(0,t.jsx)(c.X,{className:"h-4 w-4"})})]})}),(0,t.jsx)(n.CardContent,{children:(0,t.jsxs)("form",{onSubmit:e=>{e.preventDefault(),T()},className:"space-y-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Élève *"}),(0,t.jsxs)("select",{value:C.student_id,onChange:e=>k({...C,student_id:e.target.value}),className:"w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent",required:!0,children:[(0,t.jsx)("option",{value:"",children:"Sélectionner un élève"}),N.map(e=>(0,t.jsxs)("option",{value:e.id,children:[e.first_name," ",e.last_name," (",e.student_number,")"]},e.id))]})]}),(0,t.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Date d'inscription *"}),(0,t.jsx)("input",{type:"date",value:C.enrollment_date,onChange:e=>k({...C,enrollment_date:e.target.value}),className:"w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent",required:!0})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Statut *"}),(0,t.jsxs)("select",{value:C.status||"pending",onChange:e=>k({...C,status:e.target.value}),className:"w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent",children:[(0,t.jsx)("option",{value:"pending",children:"En attente"}),(0,t.jsx)("option",{value:"confirmed",children:"Confirmée"}),(0,t.jsx)("option",{value:"completed",children:"Terminée"}),(0,t.jsx)("option",{value:"cancelled",children:"Annulée"})]})]})]}),(0,t.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Montant total"}),(0,t.jsx)("input",{type:"number",step:"0.01",value:C.total_amount,onChange:e=>k({...C,total_amount:e.target.value}),className:"w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent",placeholder:"0"})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Montant payé"}),(0,t.jsx)("input",{type:"number",step:"0.01",value:C.paid_amount,onChange:e=>k({...C,paid_amount:e.target.value}),className:"w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent",placeholder:"0"})]})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Statut de paiement *"}),(0,t.jsxs)("select",{value:C.payment_status||"pending",onChange:e=>k({...C,payment_status:e.target.value}),className:"w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent",children:[(0,t.jsx)("option",{value:"pending",children:"En attente"}),(0,t.jsx)("option",{value:"partial",children:"Partiel"}),(0,t.jsx)("option",{value:"paid",children:"Payé"}),(0,t.jsx)("option",{value:"overdue",children:"En retard"})]})]}),_.error&&(0,t.jsx)("div",{className:"bg-destructive/10 text-destructive px-4 py-3 rounded-lg text-sm",children:_.error instanceof Error?_.error.message:"Une erreur est survenue"}),P.error&&(0,t.jsx)("div",{className:"bg-destructive/10 text-destructive px-4 py-3 rounded-lg text-sm",children:P.error instanceof Error?P.error.message:"Une erreur est survenue lors de l'annulation"}),(0,t.jsxs)("div",{className:"flex justify-end space-x-4",children:[(0,t.jsx)(a.Button,{type:"button",variant:"outline",onClick:B,children:"Annuler"}),(0,t.jsx)(a.Button,{type:"submit",disabled:_.isPending,children:_.isPending?"Inscription...":"Inscrire"})]})]})})]}),(0,t.jsxs)(n.Card,{children:[(0,t.jsx)(n.CardHeader,{children:(0,t.jsx)(n.CardTitle,{children:"Génération et envoi des convocations"})}),(0,t.jsxs)(n.CardContent,{className:"space-y-4",children:[(0,t.jsxs)("div",{className:"p-4 border rounded-lg",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"font-medium",children:"Convocations"}),A?(0,t.jsxs)("span",{className:"text-xs text-muted-foreground",children:["Dernière génération : ",(0,u.formatDate)(A.toISOString())]}):(0,t.jsx)("span",{className:"text-xs text-muted-foreground",children:"Jamais généré"})]}),(0,t.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,t.jsxs)(a.Button,{variant:"outline",size:"sm",onClick:()=>U(f),disabled:D||0===f.length,children:[(0,t.jsx)(l.Download,{className:"mr-2 h-4 w-4"}),D?`G\xe9n\xe9ration... (${S.current}/${S.total})`:"Générer un ZIP des convocations"]}),(0,t.jsxs)(a.Button,{variant:"outline",size:"sm",onClick:()=>z(f),disabled:0===f.length,children:[(0,t.jsx)(r.Mail,{className:"mr-2 h-4 w-4"}),"Envoyer par email"]})]})]}),D&&(0,t.jsxs)("div",{className:"mt-3",children:[(0,t.jsx)("div",{className:"w-full bg-gray-200 rounded-full h-2",children:(0,t.jsx)("div",{className:"bg-primary h-2 rounded-full transition-all duration-300",style:{width:`${S.total>0?S.current/S.total*100:0}%`}})}),(0,t.jsxs)("p",{className:"text-xs text-muted-foreground mt-1 text-center",children:["Génération en cours... ",S.current," sur ",S.total," convocations"]})]})]}),(0,t.jsxs)("div",{className:"space-y-3",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("h4",{className:"font-medium",children:["Apprenants inscrits (",f.length,")"]}),!w&&(0,t.jsxs)(a.Button,{variant:"outline",size:"sm",onClick:E,children:[(0,t.jsx)(i.UserPlus,{className:"mr-2 h-4 w-4"}),"Inscrire un apprenant"]})]}),0===f.length?(0,t.jsxs)("div",{className:"text-center py-8 text-muted-foreground border rounded-lg",children:[(0,t.jsx)(o.FileText,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),(0,t.jsx)("p",{className:"text-sm",children:"Aucun apprenant inscrit pour le moment"}),(0,t.jsxs)(a.Button,{variant:"outline",className:"mt-4",onClick:E,children:[(0,t.jsx)(i.UserPlus,{className:"mr-2 h-4 w-4"}),"Inscrire le premier apprenant"]})]}):f.map(e=>{let s=e.students;return s?(0,t.jsxs)("div",{className:"flex items-center justify-between p-4 border rounded-lg hover:bg-gray-50",children:[(0,t.jsxs)("div",{className:"flex items-center space-x-3 flex-1",children:[(0,t.jsx)("div",{className:"w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center",children:(0,t.jsx)(o.FileText,{className:"h-5 w-5 text-primary"})}),(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsxs)("p",{className:"font-medium",children:[s.first_name," ",s.last_name]}),(0,t.jsxs)("p",{className:"text-sm text-muted-foreground",children:[s.student_number,s.email&&` • ${s.email}`]}),(0,t.jsxs)("div",{className:"flex items-center space-x-2 mt-1",children:[(0,t.jsx)("span",{className:`text-xs px-2 py-1 rounded ${"confirmed"===e.status?"bg-brand-blue-ghost text-brand-blue":"completed"===e.status?"bg-blue-100 text-blue-800":"cancelled"===e.status?"bg-red-100 text-red-800":"bg-gray-100 text-gray-800"}`,children:"confirmed"===e.status?"Confirmé":"completed"===e.status?"Terminé":"cancelled"===e.status?"Annulé":"En attente"}),(0,t.jsx)("span",{className:`text-xs px-2 py-1 rounded ${"paid"===e.payment_status?"bg-brand-blue-ghost text-brand-blue":"partial"===e.payment_status?"bg-brand-cyan-ghost text-brand-cyan":"overdue"===e.payment_status?"bg-red-100 text-red-800":"bg-gray-100 text-gray-800"}`,children:"paid"===e.payment_status?"Payé":"partial"===e.payment_status?"Partiel":"overdue"===e.payment_status?"En retard":"En attente"})]})]})]}),(0,t.jsxs)("div",{className:"flex items-center space-x-2",children:["cancelled"!==e.status&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(a.Button,{variant:"ghost",size:"sm",onClick:()=>M(e),title:"Générer la convocation",children:(0,t.jsx)(l.Download,{className:"h-4 w-4"})}),(0,t.jsx)(a.Button,{variant:"ghost",size:"sm",onClick:()=>{let t=$(e);t&&(L(t),H({to:t.to,subject:t.subject,body:t.body}))},title:"Envoyer par email",disabled:!s.email,children:(0,t.jsx)(r.Mail,{className:"h-4 w-4"})})]}),"cancelled"!==e.status&&"completed"!==e.status&&(0,t.jsx)(a.Button,{variant:"ghost",size:"sm",onClick:()=>{confirm(`\xcates-vous s\xfbr de vouloir annuler l'inscription de ${s.first_name} ${s.last_name} ?`)&&P.mutate(e.id)},disabled:P.isPending,title:"Annuler l'inscription",className:"text-danger-primary hover:text-danger-primary hover:bg-danger-bg",children:(0,t.jsx)(d.Trash2,{className:"h-4 w-4"})})]}),(0,t.jsx)(x.Dialog,{open:!!G,onOpenChange:e=>{e||(L(null),H(null))},children:(0,t.jsxs)(x.DialogContent,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[(0,t.jsxs)(x.DialogHeader,{children:[(0,t.jsx)(x.DialogTitle,{children:"Aperçu de l'email"}),(0,t.jsx)(x.DialogDescription,{children:"Vérifiez le contenu et le destinataire avant d'envoyer"})]}),G&&O&&(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)(j.Label,{htmlFor:"email-to",children:"Destinataire"}),(0,t.jsx)(h.Input,{id:"email-to",type:"email",value:O.to,onChange:e=>H({...O,to:e.target.value}),className:"mt-1",placeholder:"email@example.com"})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)(j.Label,{htmlFor:"email-subject",children:"Sujet"}),(0,t.jsx)(h.Input,{id:"email-subject",type:"text",value:O.subject,onChange:e=>H({...O,subject:e.target.value}),className:"mt-1",placeholder:"Sujet de l'email"})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)(j.Label,{htmlFor:"email-body",children:"Contenu"}),(0,t.jsx)(p.Textarea,{id:"email-body",value:O.body.replace(/<[^>]*>/g,"").replace(/&nbsp;/g," ").trim(),onChange:e=>H({...O,body:e.target.value}),className:"mt-1 min-h-[200px] font-mono text-sm",placeholder:"Contenu de l'email"}),(0,t.jsx)("p",{className:"text-xs text-muted-foreground mt-1",children:"Le formatage HTML sera préservé lors de l'envoi"})]}),(0,t.jsx)("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-3",children:(0,t.jsxs)("p",{className:"text-xs text-blue-800",children:[(0,t.jsx)("strong",{children:"Pièce jointe :"})," Un PDF de la convocation sera joint à cet email."]})})]}),(0,t.jsxs)(x.DialogFooter,{children:[(0,t.jsx)(a.Button,{variant:"outline",onClick:()=>{L(null),H(null)},children:"Annuler"}),(0,t.jsxs)(a.Button,{onClick:async()=>{if(G&&O){let e={...G.enrollment,students:{...G.enrollment.students,email:O.to}};await I(e,O.subject,O.body),L(null),H(null)}},disabled:!O?.to||!O?.subject||!O?.body,children:[(0,t.jsx)(r.Mail,{className:"h-4 w-4 mr-2"}),"Envoyer l'email"]})]})]})})]},e.id):null})]})]})]})]})}e.s(["GestionConvocations",()=>b])},48503,e=>{e.v(e=>Promise.resolve().then(()=>e(915833)))},870653,e=>{e.v(t=>Promise.all(["static/chunks/e551d4a510c7c3c6.js"].map(t=>e.l(t))).then(()=>t(424154)))},195111,e=>{e.v(t=>Promise.all(["static/chunks/9fc253a1d558cb4a.js"].map(t=>e.l(t))).then(()=>t(38201)))}]);