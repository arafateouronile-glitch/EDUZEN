(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,871689,e=>{"use strict";let r=(0,e.i(475254).default)("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]]);e.s(["ArrowLeft",()=>r],871689)},645760,e=>{"use strict";var r=e.i(843476),t=e.i(271645),a=e.i(647163);e.i(882205);var o=e.i(846932);let i=t.forwardRef(({className:e,variant:t="default",hoverable:i=!1,glow:n=!1,glowColor:s="rgba(51, 90, 207, 0.3)",...l},d)=>(0,r.jsxs)(o.motion.div,{ref:d,className:(0,a.cn)("relative rounded-2xl border backdrop-blur-xl transition-all duration-300",{"bg-white/70 dark:bg-gray-900/70 border-white/20 dark:border-gray-700/30 shadow-lg":"default"===t,"bg-white/80 dark:bg-gray-900/80 border-white/30 dark:border-gray-700/40 shadow-xl":"premium"===t,"bg-white/50 dark:bg-gray-900/50 border-white/10 dark:border-gray-700/20 shadow-md":"subtle"===t,"cursor-pointer":i,"hover:shadow-2xl hover:scale-[1.02]":i,"hover:bg-white/90 dark:hover:bg-gray-900/90":i},e),whileHover:i?{scale:1.02,y:-2}:void 0,transition:{type:"spring",stiffness:300,damping:30},...l,children:[n&&(0,r.jsx)(o.motion.div,{className:"absolute inset-0 rounded-2xl opacity-0 blur-xl",style:{background:`radial-gradient(circle, ${s} 0%, transparent 70%)`},animate:{opacity:[0,.5,0]},transition:{duration:3,repeat:1/0,ease:"easeInOut"}}),(0,r.jsx)("div",{className:"relative z-10",children:l.children})]}));i.displayName="GlassCard",e.s(["GlassCard",()=>i])},605631,e=>{"use strict";let r=(0,e.i(475254).default)("CheckCircle",[["path",{d:"M22 11.08V12a10 10 0 1 1-5.93-9.14",key:"g774vq"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]]);e.s(["CheckCircle",()=>r],605631)},286536,e=>{"use strict";let r=(0,e.i(475254).default)("Eye",[["path",{d:"M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z",key:"rwhkz3"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]]);e.s(["Eye",()=>r],286536)},671428,e=>{"use strict";var r=e.i(843476),t=e.i(647163);function a({className:e,...a}){return(0,r.jsx)("div",{className:(0,t.cn)("animate-pulse rounded-md bg-gray-200",e),...a})}function o(){return(0,r.jsxs)("div",{className:"rounded-2xl p-6 border-2 border-gray-200 bg-white",children:[(0,r.jsxs)("div",{className:"flex items-start justify-between mb-4",children:[(0,r.jsx)(a,{className:"h-12 w-12 rounded-2xl"}),(0,r.jsx)(a,{className:"h-6 w-20"})]}),(0,r.jsx)(a,{className:"h-8 w-24 mb-2"}),(0,r.jsx)(a,{className:"h-4 w-32"})]})}function i(){return(0,r.jsxs)("div",{className:"rounded-2xl p-6 border-2 border-gray-200 bg-white",children:[(0,r.jsx)(a,{className:"h-6 w-48 mb-4"}),(0,r.jsx)(a,{className:"h-64 w-full"})]})}function n({count:e=3}){return(0,r.jsx)("div",{className:"space-y-3",children:Array.from({length:e}).map((e,t)=>(0,r.jsxs)("div",{className:"flex items-center gap-4 p-4 border rounded-lg",children:[(0,r.jsx)(a,{className:"h-12 w-12 rounded-full"}),(0,r.jsxs)("div",{className:"flex-1 space-y-2",children:[(0,r.jsx)(a,{className:"h-4 w-3/4"}),(0,r.jsx)(a,{className:"h-3 w-1/2"})]}),(0,r.jsx)(a,{className:"h-8 w-20"})]},t))})}function s({count:e=3}){return(0,r.jsx)(n,{count:e})}function l({items:e=4}){return(0,r.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:Array.from({length:e}).map((e,t)=>(0,r.jsx)(o,{},t))})}e.s(["ChartSkeleton",()=>i,"Skeleton",()=>a,"SkeletonBentoGrid",()=>l,"SkeletonList",()=>s,"StatsCardSkeleton",()=>o])},163454,e=>{"use strict";var r=e.i(920755);e.i(246704);var t=e.i(779478),a=e.i(790224),o=e.i(627404);async function i(e,r,a,o){try{let i=o.year||new Date().getFullYear().toString().slice(-2),n=o.padding||6,s=o.fieldName||"number",l=`${o.prefix}-${o.orgCode}-${i}-%`,{data:d,error:c}=await e.from(r).select(s).eq("organization_id",a).like(s,l).order(s,{ascending:!1}).limit(1).maybeSingle();if(c&&"PGRST116"!==c.code&&"42P01"!==c.code)throw t.errorHandler.handleError(c,{operation:"generateUniqueNumber",table:r,organizationId:a});let u=1;if(d&&d[s]){let e=String(d[s]).split("-");u=parseInt(e[e.length-1]||"0",10)+1}return`${o.prefix}-${o.orgCode}-${i}-${String(u).padStart(n,"0")}`}catch(e){throw t.errorHandler.handleError(e,{operation:"generateUniqueNumber",table:r,organizationId:a})}}var n=e.i(34458);let s=new class{supabase;constructor(e){this.supabase=e||(0,r.createClient)()}async getAll(e,r){try{let a=r?.page||1,o=r?.limit||50,i=(a-1)*o;if(r?.search){let n=this.supabase.from("students").select("*, classes(id, name, level)",{count:"exact"}).eq("organization_id",e).or(`first_name.ilike.%${r.search}%,last_name.ilike.%${r.search}%,student_number.ilike.%${r.search}%`);r?.classId&&(n=n.eq("class_id",r.classId)),r?.status&&(n=n.eq("status",r.status));let{data:s,error:l,count:d}=await n.order("last_name",{ascending:!0}).range(i,i+o-1);if(l)throw t.errorHandler.handleError(l,{organizationId:e,operation:"getAll",filters:r});return{data:s||[],total:d||0,page:a,limit:o,totalPages:Math.ceil((d||0)/o)}}let n=this.supabase.from("students").select("*, classes(id, name, level)",{count:"exact"}).eq("organization_id",e);r?.classId&&(n=n.eq("class_id",r.classId)),r?.status&&(n=n.eq("status",r.status));let{data:s,error:l,count:d}=await n.order("last_name",{ascending:!0}).range(i,i+o-1);if(l)throw t.errorHandler.handleError(l,{organizationId:e,operation:"getAll",filters:r});return{data:s||[],total:d||0,page:a,limit:o,totalPages:Math.ceil((d||0)/o)}}catch(r){if(r instanceof t.AppError)throw r;throw t.errorHandler.handleError(r,{organizationId:e,operation:"getAll"})}}async getById(e){try{return(0,o.getById)(this.supabase,"students",e,"*, classes(id, name, level)")}catch(r){if(r instanceof t.AppError)throw r;throw t.errorHandler.handleError(r,{operation:"getById",id:e})}}async getByNumber(e,r){try{let{data:a,error:o}=await this.supabase.from("students").select("*").eq("organization_id",e).eq("student_number",r).single();if(o){if("PGRST116"===o.code||"42P01"===o.code)throw t.errorHandler.handleError(o,{code:t.ErrorCode.DB_NOT_FOUND,operation:"getByNumber",organizationId:e,studentNumber:r});throw t.errorHandler.handleError(o,{operation:"getByNumber",organizationId:e,studentNumber:r})}return a}catch(a){if(a instanceof t.AppError)throw a;throw t.errorHandler.handleError(a,{operation:"getByNumber",organizationId:e,studentNumber:r})}}async create(e){try{(0,n.validateRequired)(e,["first_name","last_name","organization_id"]);let r=e.student_number;if(!r||""===r.trim()){let t=e.organization_id;if(!t)throw Error("organization_id is required");let{data:a}=await this.supabase.from("organizations").select("code").eq("id",t).single(),o=a?.code||"ORG",n=new Date().getFullYear().toString().slice(-2);r=await i(this.supabase,"students",t,{prefix:"EDU",orgCode:o,year:n,padding:6,fieldName:"student_number"})}let o={...e,student_number:r},{data:s,error:l}=await this.supabase.from("students").insert(o).select().single();if(l){if("23505"===l.code)throw t.errorHandler.handleError(l,{code:t.ErrorCode.VALIDATION_UNIQUE_CONSTRAINT,operation:"create",field:"student_number"});if("42501"===l.code)throw t.errorHandler.handleError(l,{code:t.ErrorCode.DB_RLS_POLICY_VIOLATION,operation:"create"});throw t.errorHandler.handleError(l,{operation:"create",student:e})}return a.logger.info("Étudiant créé avec succès",{id:s?.id,organizationId:e.organization_id||void 0,studentNumber:s?.student_number}),s}catch(r){if(r instanceof t.AppError)throw r;throw t.errorHandler.handleError(r,{operation:"create",student:e})}}async update(e,r){try{let o={...r};if("class_id"in o)if(""!==o.class_id&&o.class_id){let{data:e,error:r}=await this.supabase.from("classes").select("id").eq("id",o.class_id).maybeSingle();e||r||(o.class_id=null)}else o.class_id=null;let{data:i,error:n}=await this.supabase.from("students").update(o).eq("id",e).select().single();if(n){if("PGRST116"===n.code||"42P01"===n.code)throw t.errorHandler.handleError(n,{code:t.ErrorCode.DB_NOT_FOUND,operation:"update",id:e});if("42501"===n.code)throw t.errorHandler.handleError(n,{code:t.ErrorCode.DB_RLS_POLICY_VIOLATION,operation:"update",id:e});throw t.errorHandler.handleError(n,{operation:"update",id:e,updates:r})}if(!i)throw t.errorHandler.createDatabaseError(`\xc9tudiant avec l'ID ${e} introuvable pour la mise \xe0 jour`,{id:e});return a.logger.info("Étudiant mis à jour avec succès",{id:e,updates:r}),i}catch(a){if(a instanceof t.AppError)throw a;throw t.errorHandler.handleError(a,{operation:"update",id:e,updates:r})}}async delete(e){return this.update(e,{status:"inactive"})}async import(e,r){try{if(!r||0===r.length)throw t.errorHandler.createValidationError("Aucun étudiant à importer","students");let{data:o}=await this.supabase.from("organizations").select("code").eq("id",e).single(),n=o?.code||"ORG",s=new Date().getFullYear().toString().slice(-2),l=await Promise.all(r.map(async r=>{if(r.student_number&&""!==r.student_number.trim())return r;let t=await i(this.supabase,"students",e,{prefix:"EDU",orgCode:n,year:s,padding:6,fieldName:"student_number"});return{...r,student_number:t}})),{data:d,error:c}=await this.supabase.from("students").insert(l).select();if(c){if("23505"===c.code)throw t.errorHandler.handleError(c,{code:t.ErrorCode.VALIDATION_UNIQUE_CONSTRAINT,operation:"import",field:"student_number"});throw t.errorHandler.handleError(c,{operation:"import",organizationId:e,count:r.length})}return a.logger.info("Étudiants importés avec succès",{organizationId:e,count:d?.length||0}),d||[]}catch(r){if(r instanceof t.AppError)throw r;throw t.errorHandler.handleError(r,{operation:"import",organizationId:e})}}};e.s(["studentService",0,s],163454)},882293,e=>{"use strict";let r=(0,e.i(475254).default)("UserCheck",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["polyline",{points:"16 11 18 13 22 9",key:"1pwet4"}]]);e.s(["UserCheck",()=>r],882293)},350627,e=>{"use strict";let r=(0,e.i(475254).default)("Receipt",[["path",{d:"M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1-2 1-2-1Z",key:"wqdwcb"}],["path",{d:"M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8",key:"1h4pet"}],["path",{d:"M12 17V7",key:"pyj7ub"}]]);e.s(["Receipt",()=>r],350627)},203496,173998,e=>{"use strict";var r=e.i(475254);let t=(0,r.default)("Scale",[["path",{d:"m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z",key:"7g6ntu"}],["path",{d:"m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z",key:"ijws7r"}],["path",{d:"M7 21h10",key:"1b0cd5"}],["path",{d:"M12 3v18",key:"108xh3"}],["path",{d:"M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2",key:"3gwbw2"}]]);e.s(["Scale",()=>t],203496);let a=(0,r.default)("Book",[["path",{d:"M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20",key:"t4utmx"}]]);e.s(["Book",()=>a],173998)},246704,779478,e=>{"use strict";var r,t,a=e.i(790224),o=((r={}).AUTH_REQUIRED="AUTH_1001",r.AUTH_INVALID_CREDENTIALS="AUTH_1002",r.AUTH_SESSION_EXPIRED="AUTH_1003",r.AUTH_INSUFFICIENT_PERMISSIONS="AUTH_1004",r.AUTH_2FA_REQUIRED="AUTH_1005",r.AUTH_2FA_INVALID="AUTH_1006",r.VALIDATION_ERROR="VALID_2001",r.VALIDATION_REQUIRED_FIELD="VALID_2002",r.VALIDATION_INVALID_FORMAT="VALID_2003",r.VALIDATION_UNIQUE_CONSTRAINT="VALID_2004",r.DB_CONNECTION_ERROR="DB_3001",r.DB_QUERY_ERROR="DB_3002",r.DB_NOT_FOUND="DB_3003",r.DB_CONSTRAINT_VIOLATION="DB_3004",r.DB_FOREIGN_KEY_CONSTRAINT="DB_3006",r.DB_RLS_POLICY_VIOLATION="DB_3005",r.NETWORK_ERROR="NET_4001",r.API_TIMEOUT="NET_4002",r.API_RATE_LIMIT="NET_4003",r.API_SERVER_ERROR="NET_4004",r.API_NOT_FOUND="NET_4005",r.API_BAD_REQUEST="NET_4006",r.BUSINESS_LOGIC_ERROR="BIZ_5001",r.RESOURCE_LOCKED="BIZ_5002",r.OPERATION_NOT_ALLOWED="BIZ_5003",r.QUOTA_EXCEEDED="BIZ_5004",r.INTERNAL_ERROR="SYS_6001",r.CONFIGURATION_ERROR="SYS_6002",r.SERVICE_UNAVAILABLE="SYS_6003",r);(t={}).LOW="low",t.MEDIUM="medium",t.HIGH="high",t.CRITICAL="critical";class i extends Error{code;severity;userMessage;retryable;context;originalError;constructor(e,r="SYS_6001",t="medium",a={},o){super(e),this.name="AppError",this.code=r,this.severity=t,this.userMessage=a.userMessage||this.getDefaultUserMessage(r),this.retryable=a.retryable??this.isRetryable(r),this.context={...a,code:r,severity:t,timestamp:new Date().toISOString()},this.originalError=o,Error.captureStackTrace&&Error.captureStackTrace(this,i)}getDefaultUserMessage(e){return({AUTH_1001:"Vous devez être connecté pour effectuer cette action.",AUTH_1002:"Email ou mot de passe incorrect.",AUTH_1003:"Votre session a expiré. Veuillez vous reconnecter.",AUTH_1004:"Vous n'avez pas les permissions nécessaires.",AUTH_1005:"Authentification à deux facteurs requise.",AUTH_1006:"Code d'authentification invalide.",VALID_2001:"Les données fournies ne sont pas valides.",VALID_2002:"Certains champs obligatoires sont manquants.",VALID_2003:"Le format des données est incorrect.",VALID_2004:"Cette valeur existe déjà.",DB_3001:"Impossible de se connecter à la base de données.",DB_3002:"Erreur lors de l'exécution de la requête.",DB_3003:"Ressource introuvable.",DB_3004:"Cette opération viole une contrainte de la base de données.",DB_3006:"Cette opération viole une contrainte de clé étrangère.",DB_3005:"Vous n'avez pas accès à cette ressource.",NET_4001:"Erreur de connexion réseau. Vérifiez votre connexion internet.",NET_4002:"La requête a pris trop de temps. Veuillez réessayer.",NET_4003:"Trop de requêtes. Veuillez patienter quelques instants.",NET_4004:"Erreur serveur. Veuillez réessayer plus tard.",NET_4005:"Ressource introuvable.",NET_4006:"Requête invalide.",BIZ_5001:"Cette opération n'est pas autorisée dans le contexte actuel.",BIZ_5002:"Cette ressource est actuellement verrouillée.",BIZ_5003:"Cette opération n'est pas autorisée.",BIZ_5004:"Vous avez atteint la limite autorisée.",SYS_6001:"Une erreur interne est survenue. Veuillez réessayer.",SYS_6002:"Erreur de configuration du système.",SYS_6003:"Service temporairement indisponible."})[e]||"Une erreur inattendue est survenue."}isRetryable(e){return["NET_4001","NET_4002","NET_4004","DB_3001","SYS_6003"].includes(e)}toJSON(){return{name:this.name,message:this.message,code:this.code,severity:this.severity,userMessage:this.userMessage,retryable:this.retryable,context:this.context,stack:this.stack,originalError:this.originalError instanceof Error?{name:this.originalError.name,message:this.originalError.message,stack:this.originalError.stack}:this.originalError}}}let n=new class{handleError(e,r={}){if(e instanceof i)return this.logError(e),e;if(e instanceof Error)return this.handleStandardError(e,r);if(this.isSupabaseError(e))return this.handleSupabaseError(e,r);let t=new i("Une erreur inattendue est survenue.","SYS_6001","high",r,e);return this.logError(t),t}handleStandardError(e,r){let t=e.message.toLowerCase(),a="SYS_6001",o="medium";t.includes("network")||t.includes("fetch")?(a="NET_4001",o="medium"):t.includes("timeout")?(a="NET_4002",o="medium"):t.includes("unauthorized")||t.includes("401")?(a="AUTH_1001",o="high"):t.includes("forbidden")||t.includes("403")?(a="AUTH_1004",o="high"):t.includes("not found")||t.includes("404")?(a="DB_3003",o="low"):(t.includes("validation")||t.includes("invalid"))&&(a="VALID_2001",o="low");let n=new i(e.message,a,o,r,e);return this.logError(n),n}handleSupabaseError(e,r){let t=e.code||e.status,a=e.message||"Erreur Supabase",o=r.code||"DB_3002",n="medium";if(!r.code)switch(t){case"PGRST116":case"42P01":o="DB_3003",n="low";break;case"42501":o="DB_3005",n="high";break;case"23505":o="VALID_2004",n="low";break;case"23503":o="DB_3004",n="medium";break;case"PGRST301":case"400":o="NET_4006",n="low";break;case"401":o="AUTH_1001",n="high";break;case"403":o="AUTH_1004",n="high";break;case"404":o="NET_4005",n="low";break;case"500":o="NET_4004",n="high"}"DB_3006"===o&&(n="medium");let s=new i(a,o,n,r,e);return this.logError(s),s}isSupabaseError(e){return e&&(e.code||e.status||e.message)&&("string"==typeof e.code||"number"==typeof e.status)}logError(e){let r={...e.context,code:e.code,severity:e.severity,retryable:e.retryable};switch(e.severity){case"critical":case"high":a.logger.error(e.message,e.originalError||e,r);break;case"medium":a.logger.warn(e.message,r);break;case"low":a.logger.info(`Error: ${e.message}`,r)}}createValidationError(e,r){return new i(e,"VALID_2001","low",{field:r,userMessage:e})}createAuthError(e,r){return new i(r||"Erreur d'authentification",e,"high")}createDatabaseError(e,r){return new i(e,"DB_3002","medium",{},r)}createNotFoundError(e,r){return new i(e,"DB_3003","low",r)}};e.s(["AppError",()=>i,"ErrorCode",()=>o,"errorHandler",0,n],779478),e.s([],246704)},627404,e=>{"use strict";e.i(246704);var r=e.i(779478);async function t(e,t,a,o){try{let i=e.from(t).select(o?.select||"*").eq("organization_id",a);o?.filters&&Object.entries(o.filters).forEach(([e,r])=>{null!=r&&(i=i.eq(e,r))}),o?.search&&(i=i.ilike(o.search.field,`%${o.search.value}%`)),i=o?.orderBy?i.order(o.orderBy.column,{ascending:o.orderBy.ascending??!1}):i.order("created_at",{ascending:!1});let{data:n,error:s}=await i;if(s)throw r.errorHandler.handleError(s,{organizationId:a,operation:"getAllByOrganization",table:t});return n||[]}catch(e){if(e instanceof r.AppError)throw e;throw r.errorHandler.handleError(e,{organizationId:a,operation:"getAllByOrganization",table:t})}}async function a(e,t,a,o){try{let{data:i,error:n}=await e.from(t).select(o||"*").eq("id",a).single();if(n){if("PGRST116"===n.code||"42P01"===n.code)throw r.errorHandler.handleError(n,{code:r.ErrorCode.DB_NOT_FOUND,operation:"getById",id:a,table:t});throw r.errorHandler.handleError(n,{operation:"getById",id:a,table:t})}if(!i)throw r.errorHandler.createDatabaseError(`Enregistrement avec l'ID ${a} introuvable dans ${t}`,{id:a,table:t});return i}catch(e){if(e instanceof r.AppError)throw e;throw r.errorHandler.handleError(e,{operation:"getById",id:a,table:t})}}e.s(["getAllByOrganization",()=>t,"getById",()=>a])},34458,e=>{"use strict";e.i(246704);var r=e.i(779478);function t(e,t){for(let a of t)if(!e[a])throw r.errorHandler.createValidationError(`Le champ ${String(a)} est obligatoire`,String(a))}e.s(["validateRequired",()=>t])},631259,e=>{"use strict";var r=e.i(920755);e.i(246704);var t=e.i(779478),a=e.i(790224),o=e.i(627404),i=e.i(34458);let n=new class{supabase;constructor(e){this.supabase=e||(0,r.createClient)()}async getAll(e,r){try{let t={};return r?.studentId&&(t.student_id=r.studentId),r?.status&&(t.status=r.status),r?.documentType&&(t.document_type=r.documentType),(0,o.getAllByOrganization)(this.supabase,"invoices",e,{select:"*, students(id, first_name, last_name, student_number), payments(id, amount, status, paid_at)",filters:t,search:r?.search?{field:"invoice_number",value:r.search}:void 0,orderBy:{column:"issue_date",ascending:!1}})}catch(r){if(r instanceof t.AppError)throw r;throw t.errorHandler.handleError(r,{organizationId:e,operation:"getAll"})}}async getById(e){try{return(0,o.getById)(this.supabase,"invoices",e,"*, students(*), enrollments(*), payments(*)")}catch(r){if(r instanceof t.AppError)throw r;throw t.errorHandler.handleError(r,{operation:"getById",id:e})}}async generateInvoiceNumber(e,r="invoice"){let t=new Date().getFullYear().toString(),{data:a}=await this.supabase.from("invoices").select("invoice_number").eq("organization_id",e).eq("document_type",r).like("invoice_number",`${t}-%`).order("invoice_number",{ascending:!1}).limit(1).maybeSingle(),o=1;if(a?.invoice_number){let e=a.invoice_number.split("-");e.length>=2&&e[0]===t&&(o=parseInt(e[1]||"0",10)+1)}return`${t}-${String(o).padStart(3,"0")}`}async create(e){try{(0,i.validateRequired)(e,["organization_id","student_id"]);let r=e.invoice_number;if(!r||""===r.trim()){let a=e.organization_id;if(!a)throw t.errorHandler.createValidationError("Organization ID is required to create an invoice.");r=await this.generateInvoiceNumber(a,e.document_type||"invoice")}let{data:o,error:n}=await this.supabase.from("invoices").insert({...e,invoice_number:r}).select().single();if(n){if("23505"===n.code)throw t.errorHandler.handleError(n,{code:t.ErrorCode.VALIDATION_UNIQUE_CONSTRAINT,operation:"create",field:"invoice_number"});if("42501"===n.code)throw t.errorHandler.handleError(n,{code:t.ErrorCode.DB_RLS_POLICY_VIOLATION,operation:"create"});throw t.errorHandler.handleError(n,{operation:"create",invoice:e})}return a.logger.info("Facture créée avec succès",{id:o?.id,organizationId:e.organization_id||void 0,invoiceNumber:o?.invoice_number}),o}catch(r){if(r instanceof t.AppError)throw r;throw t.errorHandler.handleError(r,{operation:"create",invoice:e})}}async update(e,r){try{let{data:o,error:i}=await this.supabase.from("invoices").update(r).eq("id",e).select().single();if(i){if("PGRST116"===i.code||"42P01"===i.code)throw t.errorHandler.handleError(i,{code:t.ErrorCode.DB_NOT_FOUND,operation:"update",id:e});if("42501"===i.code)throw t.errorHandler.handleError(i,{code:t.ErrorCode.DB_RLS_POLICY_VIOLATION,operation:"update",id:e});throw t.errorHandler.handleError(i,{operation:"update",id:e,updates:r})}if(!o)throw t.errorHandler.createDatabaseError(`Facture avec l'ID ${e} introuvable pour la mise \xe0 jour`,{id:e});return a.logger.info("Facture mise à jour avec succès",{id:e,updates:r}),o}catch(a){if(a instanceof t.AppError)throw a;throw t.errorHandler.handleError(a,{operation:"update",id:e,updates:r})}}async generateForClass(e,r,o,i,n,s="tuition"){let{data:l,error:d}=await this.supabase.from("students").select("id").eq("organization_id",e).eq("class_id",r).eq("status","active");if(d)throw t.errorHandler.handleError(d,{operation:"generateForClass",organizationId:e,classId:r,step:"fetchStudents"});if(!l||0===l.length)throw t.errorHandler.createValidationError("Aucun élève actif dans cette classe","classId");let{data:c}=await this.supabase.from("organizations").select("code").eq("id",e).single(),u=c?.code||"ORG",m=new Date().getFullYear().toString().slice(-2),{data:_}=await this.supabase.from("invoices").select("invoice_number").eq("organization_id",e).like("invoice_number",`FAC-${u}-${m}-%`).order("invoice_number",{ascending:!1}).limit(1).maybeSingle(),h=1;if(_?.invoice_number){let e=_.invoice_number.split("-");h=parseInt(e[e.length-1]||"0")+1}let p=l.map((r,t)=>({organization_id:e,student_id:r.id,invoice_number:`FAC-${u}-${m}-${String(h+t).padStart(6,"0")}`,type:s,document_type:"invoice",issue_date:new Date().toISOString().split("T")[0],due_date:n,amount:o,tax_amount:0,total_amount:o,currency:i,status:"draft",items:[]})),{data:g,error:f}=await this.supabase.from("invoices").insert(p).select();if(f)throw t.errorHandler.handleError(f,{operation:"generateForClass",organizationId:e,classId:r,count:p.length});return a.logger.info("Factures générées en masse avec succès",{organizationId:e,classId:r,count:g?.length||0}),g||[]}async getOverdue(e){let r=new Date().toISOString().split("T")[0];try{let{data:a,error:o}=await this.supabase.from("invoices").select("*, students(id, first_name, last_name, student_number)").eq("organization_id",e).eq("document_type","invoice").in("status",["sent","partial"]).lt("due_date",r).order("due_date",{ascending:!0});if(o)throw t.errorHandler.handleError(o,{operation:"getOverdue",organizationId:e});return a||[]}catch(r){if(r instanceof t.AppError)throw r;throw t.errorHandler.handleError(r,{operation:"getOverdue",organizationId:e})}}async convertQuoteToInvoice(e){try{let{data:r,error:o}=await this.supabase.from("invoices").select("*").eq("id",e).eq("document_type","quote").single();if(o){if("PGRST116"===o.code||"42P01"===o.code)throw t.errorHandler.handleError(o,{code:t.ErrorCode.DB_NOT_FOUND,operation:"convertQuoteToInvoice",quoteId:e});throw t.errorHandler.handleError(o,{operation:"convertQuoteToInvoice",quoteId:e,step:"fetchQuote"})}if(!r)throw t.errorHandler.createDatabaseError(`Devis avec l'ID ${e} introuvable`,{quoteId:e});let{data:i,error:n}=await this.supabase.from("invoices").update({document_type:"invoice",status:"draft",issue_date:r.issue_date||new Date().toISOString().split("T")[0]}).eq("id",e).select().single();if(n)throw t.errorHandler.handleError(n,{operation:"convertQuoteToInvoice",quoteId:e,step:"updateInvoice"});return a.logger.info("Devis converti en facture avec succès",{quoteId:e,invoiceId:i?.id}),i}catch(r){if(r instanceof t.AppError)throw r;throw t.errorHandler.handleError(r,{operation:"convertQuoteToInvoice",quoteId:e})}}};e.s(["invoiceService",0,n])},548347,e=>{"use strict";var r=e.i(920755);e.i(246704);var t=e.i(779478),a=e.i(790224),o=e.i(627404);let i=new class{supabase;constructor(e){this.supabase=e||(0,r.createClient)()}async getAll(e,r){try{let i={};r?.invoiceId&&(i.invoice_id=r.invoiceId),r?.studentId&&(i.student_id=r.studentId),r?.status&&(i.status=r.status);try{return await (0,o.getAllByOrganization)(this.supabase,"payments",e,{select:"*, invoices(*), students(id, first_name, last_name, student_number)",filters:i,orderBy:{column:"created_at",ascending:!1}})}catch(i){let r=i?.code||i?.originalError?.code,o=i?.message||String(i);if("PGRST116"===r||"42P01"===r||"PGRST200"===r||"PGRST301"===r||"400"===r||o?.includes("relation")||o?.includes("relationship")||o?.includes("does not exist")||o?.includes("schema cache"))return a.logger.warn("Payments table or relations not available, returning empty array",{organizationId:e,errorCode:r,errorMessage:o}),[];if(i instanceof t.AppError){let r=i.originalError;if(r){let t=r.code,o=r.message||"";if("PGRST116"===t||"42P01"===t||"PGRST200"===t||"PGRST301"===t||"400"===t||o.includes("relation")||o.includes("relationship")||o.includes("does not exist")||o.includes("schema cache"))return a.logger.warn("Payments table or relations not available (from AppError.originalError), returning empty array",{organizationId:e,errorCode:t,errorMessage:o}),[]}let t=i.context?.code;if("PGRST116"===t||"42P01"===t||"PGRST200"===t||"PGRST301"===t||"400"===t)return a.logger.warn("Payments table or relations not available (from AppError.context), returning empty array",{organizationId:e,errorCode:t}),[]}throw i}}catch(r){if(r instanceof t.AppError)throw r;throw t.errorHandler.handleError(r,{organizationId:e,operation:"getAll"})}}async getById(e){try{return(0,o.getById)(this.supabase,"payments",e,"*, invoices(*), students(*)")}catch(r){if(r instanceof t.AppError)throw r;throw t.errorHandler.handleError(r,{operation:"getById",id:e})}}async create(e){try{if(!e.amount||0>=Number(e.amount))throw t.errorHandler.createValidationError("Le montant doit être supérieur à 0","amount");if(!e.organization_id)throw t.errorHandler.createValidationError("L'organisation est obligatoire","organization_id");let{data:r,error:o}=await this.supabase.from("payments").insert(e).select().single();if(o){if("23505"===o.code)throw t.errorHandler.handleError(o,{code:t.ErrorCode.VALIDATION_UNIQUE_CONSTRAINT,operation:"create",field:"transaction_id"});if("42501"===o.code)throw t.errorHandler.handleError(o,{code:t.ErrorCode.DB_RLS_POLICY_VIOLATION,operation:"create"});throw t.errorHandler.handleError(o,{operation:"create",payment:e})}return e.invoice_id&&await this.updateInvoicePaymentStatus(e.invoice_id),a.logger.info("Paiement créé avec succès",{id:r?.id,organizationId:e.organization_id,amount:e.amount}),r}catch(r){if(r instanceof t.AppError)throw r;throw t.errorHandler.handleError(r,{operation:"create",payment:e})}}async update(e,r){try{let{data:o,error:i}=await this.supabase.from("payments").update(r).eq("id",e).select().single();if(i){if("PGRST116"===i.code||"42P01"===i.code)throw t.errorHandler.handleError(i,{code:t.ErrorCode.DB_NOT_FOUND,operation:"update",id:e});if("42501"===i.code)throw t.errorHandler.handleError(i,{code:t.ErrorCode.DB_RLS_POLICY_VIOLATION,operation:"update",id:e});throw t.errorHandler.handleError(i,{operation:"update",id:e,updates:r})}if(!o)throw t.errorHandler.createDatabaseError(`Paiement avec l'ID ${e} introuvable pour la mise \xe0 jour`,{id:e});if("completed"===r.status||"failed"===r.status){let r=await this.getById(e);if(r&&"object"==typeof r&&"invoice_id"in r){let e=r.invoice_id;e&&await this.updateInvoicePaymentStatus(e)}}return a.logger.info("Paiement mis à jour avec succès",{id:e,updates:r}),o}catch(a){if(a instanceof t.AppError)throw a;throw t.errorHandler.handleError(a,{operation:"update",id:e,updates:r})}}async updateInvoicePaymentStatus(e){try{let{data:r,error:a}=await this.supabase.from("payments").select("amount").eq("invoice_id",e).eq("status","completed");if(a)throw t.errorHandler.handleError(a,{operation:"updateInvoicePaymentStatus",invoiceId:e,step:"fetchPayments"});let o=r?.reduce((e,r)=>e+Number(r.amount),0)||0,{data:i,error:n}=await this.supabase.from("invoices").select("total_amount").eq("id",e).single();if(n)throw t.errorHandler.handleError(n,{operation:"updateInvoicePaymentStatus",invoiceId:e,step:"fetchInvoice"});if(!i)throw t.errorHandler.createDatabaseError(`Facture avec l'ID ${e} introuvable`,{invoiceId:e});let s="sent";o>=Number(i.total_amount)?s="paid":o>0&&(s="partial");let{data:l}=await this.supabase.from("invoices").select("due_date").eq("id",e).single();if(l){let e=new Date;new Date(l.due_date)<e&&"paid"!==s&&(s="overdue")}let{error:d}=await this.supabase.from("invoices").update({status:s}).eq("id",e);if(d)throw t.errorHandler.handleError(d,{operation:"updateInvoicePaymentStatus",invoiceId:e,step:"updateInvoice"})}catch(r){if(r instanceof t.AppError)throw r;throw t.errorHandler.handleError(r,{operation:"updateInvoicePaymentStatus",invoiceId:e})}}async recordMobileMoneyPayment(e,r,a,o,i,n){try{if(!i)throw t.errorHandler.createValidationError("L'ID de transaction est obligatoire","transactionId");let{data:s,error:l}=await this.supabase.from("invoices").select("organization_id, student_id").eq("id",e).single();if(l){if("PGRST116"===l.code||"42P01"===l.code)throw t.errorHandler.handleError(l,{code:t.ErrorCode.DB_NOT_FOUND,operation:"recordMobileMoneyPayment",invoiceId:e});throw t.errorHandler.handleError(l,{operation:"recordMobileMoneyPayment",invoiceId:e})}if(!s)throw t.errorHandler.createDatabaseError(`Facture avec l'ID ${e} introuvable`,{invoiceId:e});return this.create({organization_id:s.organization_id,invoice_id:e,student_id:s.student_id,amount:r,currency:a,payment_method:"mobile_money",payment_provider:o,transaction_id:i,status:"pending",metadata:{phone_number:n}})}catch(r){if(r instanceof t.AppError)throw r;throw t.errorHandler.handleError(r,{operation:"recordMobileMoneyPayment",invoiceId:e,provider:o})}}};e.s(["paymentService",0,i])},718052,55479,e=>{"use strict";var r=e.i(843476),t=e.i(970065),a=e.i(671428);function o(){return(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsx)(a.Skeleton,{className:"h-8 w-64"}),(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)(a.Skeleton,{className:"h-10 w-32"}),(0,r.jsx)(a.Skeleton,{className:"h-10 w-32"})]})]}),(0,r.jsx)(t.Card,{children:(0,r.jsx)(t.CardContent,{className:"p-6",children:(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsx)(a.Skeleton,{className:"h-10 w-full"}),(0,r.jsx)(a.Skeleton,{className:"h-96 w-full"})]})})})]})}e.s(["SkeletonLoader",()=>o],718052);var i=e.i(178583),n=e.i(350627),s=e.i(626912),l=e.i(87316),d=e.i(191741),c=e.i(842009),u=e.i(32095),m=e.i(810980),_=e.i(882293),h=e.i(98919),p=e.i(203496),g=e.i(173998),f=e.i(605631);function v(e){return({convention:{name:"Convention de formation",description:"Contrat entre l'établissement et l'apprenant",icon:i.FileText,color:"#335ACF"},facture:{name:"Facture",description:"Document comptable de facturation",icon:n.Receipt,color:"#335ACF"},devis:{name:"Devis",description:"Estimation de prix avant formation",icon:s.FileCheck,color:"#34B9EE"},convocation:{name:"Convocation",description:"Invitation à une session ou examen",icon:l.Calendar,color:"#335ACF"},contrat:{name:"Contrat de scolarité",description:"Accord de scolarisation officiel",icon:d.ClipboardList,color:"#335ACF"},attestation_reussite:{name:"Attestation de réussite",description:"Certificat de réussite à une formation",icon:c.Award,color:"#335ACF"},certificat_scolarite:{name:"Certificat de scolarité",description:"Justificatif d'inscription dans l'établissement",icon:u.GraduationCap,color:"#335ACF"},releve_notes:{name:"Relevé de notes",description:"Bulletin de notes et appréciations",icon:m.BookOpen,color:"#34B9EE"},attestation_entree:{name:"Attestation d'entrée en formation",description:"Certificat d'inscription à une formation",icon:_.UserCheck,color:"#335ACF"},reglement_interieur:{name:"Règlement intérieur",description:"Règles et procédures de l'établissement",icon:h.Shield,color:"#335ACF"},cgv:{name:"Conditions Générales de Vente",description:"CGV et conditions d'utilisation",icon:p.Scale,color:"#34B9EE"},programme:{name:"Programme de formation",description:"Détails du contenu pédagogique",icon:g.Book,color:"#335ACF"},attestation_assiduite:{name:"Attestation d'assiduité",description:"Justificatif de présence aux cours",icon:f.CheckCircle,color:"#335ACF"},certificat_realisation:{name:"Certificat de réalisation",description:"Certificat OF de réalisation de formation",icon:c.Award,color:"#335ACF"},livret_accueil:{name:"Livret d'accueil",description:"Livret d'accueil OF pour les apprenants",icon:m.BookOpen,color:"#34B9EE"},emargement:{name:"Feuille d'émargement",description:"Feuille d'émargement OF pour les sessions",icon:d.ClipboardList,color:"#335ACF"}})[e]}e.s(["getDocumentTypeConfig",()=>v],55479)},233802,e=>{"use strict";var r=e.i(843476),t=e.i(271645),a=e.i(618566),o=e.i(266027),i=e.i(325715),n=e.i(920755),s=e.i(69319),l=e.i(163454),d=e.i(631259),c=e.i(548347),u=e.i(647163);function m(e,r,t,a){let o=new Date;return{ecole_nom:r?.name||"",ecole_logo:r?.logo_url||"",ecole_adresse:r?.address||"",ecole_ville:r?.city||"",ecole_telephone:r?.phone||"",ecole_email:r?.email||"",ecole_site_web:r?.website||"",ecole_siret:r?.siret||"",ecole_code_postal:r?.postal_code||"",eleve_nom:e?.last_name||"",eleve_prenom:e?.first_name||"",eleve_numero:e?.student_number||"",eleve_date_naissance:e?.date_of_birth?(0,u.formatDate)(e.date_of_birth):"",eleve_classe:t?.name||"",eleve_photo:e?.photo_url||"",eleve_adresse:e?.address||"",eleve_telephone:e?.phone||"",eleve_email:e?.email||"",formation_nom:a?.name||"",formation_code:a?.code||"",formation_duree:a?.duration_hours?`${a.duration_hours} heures`:"",formation_prix:a?.price?`${a.price} ${a.currency||"EUR"}`:"",formation_dates:t?`${(0,u.formatDate)(t.start_date)} - ${(0,u.formatDate)(t.end_date)}`:"",formation_description:a?.description||"",formation_objectifs:a?.objectives||"",session_nom:t?.name||"",session_debut:t?.start_date?(0,u.formatDate)(t.start_date):"",session_fin:t?.end_date?(0,u.formatDate)(t.end_date):"",session_lieu:t?.location||"",session_horaires:t?.start_time&&t?.end_time?`${t.start_time} - ${t.end_time}`:"",date_jour:(0,u.formatDate)(o),date_emission:(0,u.formatDate)(o),date_generation:(0,u.formatDate)(o),annee_actuelle:o.getFullYear().toString(),heure:o.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"}),numero_document:`DOC-${o.getTime()}`,numero_page:1,total_pages:1}}var _=e.i(970065),h=e.i(167881),p=e.i(10708),g=e.i(645760),f=e.i(871689),v=e.i(440160),y=e.i(286536),w=e.i(284614),E=e.i(178583),b=e.i(561659),x=e.i(87316),I=e.i(522016),N=e.i(718052),D=e.i(55479);function A(){let e=(0,a.useParams)();(0,a.useRouter)();let A=(0,a.useSearchParams)(),{user:S}=(0,i.useAuth)(),T=(0,n.createClient)(),C=e.type,j=(0,D.getDocumentTypeConfig)(C),R=A.get("template_id"),[O,H]=(0,t.useState)(null),[B,L]=(0,t.useState)("real"),[k,P]=(0,t.useState)(""),[F,z]=(0,t.useState)(""),[q,U]=(0,t.useState)(""),[$,V]=(0,t.useState)(""),{data:M,isLoading:G}=(0,o.useQuery)({queryKey:["document-template",S?.organization_id,C,R],queryFn:async()=>{if(!S?.organization_id)return null;if(R)try{let e=await s.documentTemplateService.getTemplateById(R);if(e.type===C)return e}catch(e){console.error("Erreur lors du chargement du template spécifique:",e)}return s.documentTemplateService.getDefaultTemplate(S.organization_id,C)},enabled:!!S?.organization_id}),{data:Y}=(0,o.useQuery)({queryKey:["organization",S?.organization_id],queryFn:async()=>{if(!S?.organization_id)return null;let{data:e,error:r}=await T.from("organizations").select("*").eq("id",S.organization_id).single();if(r)throw r;return e},enabled:!!S?.organization_id}),{data:Q}=(0,o.useQuery)({queryKey:["students",S?.organization_id],queryFn:async()=>S?.organization_id?l.studentService.getAll(S.organization_id):{data:[],total:0,page:1,limit:50,totalPages:0},enabled:!!S?.organization_id&&"real"===B}),{data:K}=(0,o.useQuery)({queryKey:["invoices",S?.organization_id],queryFn:async()=>S?.organization_id?d.invoiceService.getAll(S.organization_id,{}):[],enabled:!!S?.organization_id&&"real"===B}),{data:Z}=(0,o.useQuery)({queryKey:["payments",S?.organization_id],queryFn:async()=>{if(!S?.organization_id)return[];try{return(await c.paymentService.getAll(S.organization_id)).slice(0,50)}catch(a){let e=a?.code||a?.originalError?.code||a?.status,r=a?.message||a?.originalError?.message||String(a),t=a?.details||a?.hint||"";if("PGRST116"===e||"42P01"===e||"PGRST200"===e||"PGRST301"===e||"400"===e||a?.status===400||r?.toLowerCase().includes("relation")||r?.toLowerCase().includes("relationship")||r?.toLowerCase().includes("does not exist")||r?.toLowerCase().includes("schema cache")||r?.toLowerCase().includes("invalid query")||t?.toLowerCase().includes("relation")||t?.toLowerCase().includes("relationship")){console.warn("Relations non disponibles, récupération des paiements sans relations:",{errorCode:e,errorMessage:r,errorDetails:t});try{let{data:e,error:r}=await T.from("payments").select("*").eq("organization_id",S.organization_id).order("created_at",{ascending:!1}).limit(50);if(r)return console.warn("Erreur lors de la récupération simple des paiements:",r),[];return e||[]}catch(e){return console.warn("Erreur lors de la récupération de fallback des paiements:",e),[]}}return console.error("Erreur lors de la récupération des paiements:",a),[]}},enabled:!!S?.organization_id&&"real"===B,retry:!1}),{data:J}=(0,o.useQuery)({queryKey:["sessions",S?.organization_id],queryFn:async()=>{if(!S?.organization_id)return[];let{data:e,error:r}=await T.from("sessions").select("*, formations(*)").eq("organization_id",S.organization_id).order("start_date",{ascending:!1}).limit(50);if(r)throw r;return e||[]},enabled:!!S?.organization_id&&"real"===B}),{data:W}=(0,o.useQuery)({queryKey:["student",k],queryFn:async()=>{if(!k)return null;let e=await l.studentService.getById(k);if(e?.class_id){let{data:r}=await T.from("sessions").select("*, formations(*)").eq("id",e.class_id).single();return{...e,session:r}}return e},enabled:!!k&&"real"===B}),{data:X}=(0,o.useQuery)({queryKey:["invoice",F],queryFn:async()=>{if(!F)return null;let e=await d.invoiceService.getById(F);if(e?.student_id){let r=await l.studentService.getById(e.student_id);return{...e,student:r}}return e},enabled:!!F&&"real"===B});(0,t.useEffect)(()=>{M&&ee(M,(()=>{var e,r;if("sample"===B)return{ecole_nom:"École Moderne de Dakar",ecole_logo:"",ecole_adresse:"123 Avenue de l'Education, Dakar, Sénégal",ecole_ville:"Dakar",ecole_telephone:"+221 77 123 45 67",ecole_email:"contact@ecolemoderne.sn",ecole_site_web:"www.ecolemoderne.sn",eleve_nom:"DIALLO",eleve_prenom:"Amadou",eleve_numero:"LYC001",eleve_date_naissance:"15/03/2007",eleve_classe:"Terminale A",formation_nom:"Formation en Développement Web",formation_code:"DEV-WEB-2024",formation_duree:"6 mois",formation_prix:"500 000 XOF",session_nom:"Session Janvier 2024",session_debut:"01/01/2024",session_fin:"30/06/2024",date_jour:new Date().toLocaleDateString("fr-FR"),date_emission:new Date().toLocaleDateString("fr-FR"),annee_scolaire:"2024-2025",numero_document:"2025-001",date_generation:new Date().toLocaleDateString("fr-FR"),numero_page:1,total_pages:1};if(k&&W)return m(W,Y,W.session,W.session?.formations);if(F&&X){let r;return e=X.student,r=new Date,{ecole_nom:Y?.name||"",ecole_logo:Y?.logo_url||"",ecole_adresse:Y?.address||"",ecole_ville:Y?.city||"",ecole_telephone:Y?.phone||"",ecole_email:Y?.email||"",ecole_siret:Y?.siret||"",eleve_nom:e?.last_name||"",eleve_prenom:e?.first_name||"",eleve_numero:e?.student_number||"",eleve_adresse:e?.address||"",montant:X?.total_amount?`${X.total_amount} ${X.currency||"EUR"}`:"",montant_ht:X?.amount?`${X.amount} ${X.currency||"EUR"}`:"",montant_ttc:X?.total_amount?`${X.total_amount} ${X.currency||"EUR"}`:"",tva:X?.tax_amount?`${X.tax_amount} ${X.currency||"EUR"}`:"",taux_tva:X?.tax_amount&&X?.amount?`${(X.tax_amount/X.amount*100).toFixed(2)}%`:"",numero_facture:X?.invoice_number||"",date_echeance:X?.due_date?(0,u.formatDate)(X.due_date):"",date_jour:(0,u.formatDate)(r),date_emission:X?.issue_date?(0,u.formatDate)(X.issue_date):(0,u.formatDate)(r),date_generation:(0,u.formatDate)(r),numero_document:X?.invoice_number||`DOC-${r.getTime()}`,numero_page:1,total_pages:1}}if(q&&Z){let e=Z.find(e=>e.id===q);if(e){let r,t=Array.isArray(e.invoices)?e.invoices[0]:e.invoices||e.invoice,a=Array.isArray(e.students)?e.students[0]:e.students||e.student;return r=new Date,{ecole_nom:Y?.name||"",ecole_logo:Y?.logo_url||"",ecole_adresse:Y?.address||"",ecole_telephone:Y?.phone||"",ecole_email:Y?.email||"",eleve_nom:a?.last_name||"",eleve_prenom:a?.first_name||"",eleve_numero:a?.student_number||"",montant:e?.amount?`${e.amount} ${e.currency||"EUR"}`:"",date_paiement:e?.paid_at?(0,u.formatDate)(e.paid_at):e?.payment_date?(0,u.formatDate)(e.payment_date):"",mode_paiement:e?.payment_method||"",numero_facture:t?.invoice_number||"",date_jour:(0,u.formatDate)(r),date_emission:(0,u.formatDate)(r),date_generation:(0,u.formatDate)(r),numero_document:e?.payment_number||`DOC-${r.getTime()}`,numero_page:1,total_pages:1}}}if($&&J){let e=J.find(e=>e.id===$);if(e){let t;return r=e.formations,t=new Date,{ecole_nom:Y?.name||"",ecole_logo:Y?.logo_url||"",ecole_adresse:Y?.address||"",ecole_ville:Y?.city||"",ecole_telephone:Y?.phone||"",ecole_email:Y?.email||"",ecole_siret:Y?.siret||"",ecole_rcs:Y?.rcs||"",ecole_representant:Y?.representative_name||"",formation_nom:r?.name||"",formation_code:r?.code||"",formation_duree:r?.duration_hours?`${r.duration_hours} heures`:"",formation_prix:r?.price?`${r.price} ${r.currency||"EUR"}`:"",formation_description:r?.description||"",formation_objectifs:r?.objectives||"",session_nom:e?.name||"",session_debut:e?.start_date?(0,u.formatDate)(e.start_date):"",session_fin:e?.end_date?(0,u.formatDate)(e.end_date):"",session_lieu:e?.location||"",session_horaires:e?.start_time&&e?.end_time?`${e.start_time} - ${e.end_time}`:"",date_jour:(0,u.formatDate)(t),date_emission:(0,u.formatDate)(t),date_generation:(0,u.formatDate)(t),annee_actuelle:t.getFullYear().toString(),numero_document:`DOC-${t.getTime()}`,numero_page:1,total_pages:1}}}return Q&&Q.data&&Q.data.length>0?m(Q.data[0],Y):{ecole_nom:Y?.name||"",date_jour:new Date().toLocaleDateString("fr-FR"),date_emission:new Date().toLocaleDateString("fr-FR"),numero_document:"DOC_001",date_generation:new Date().toLocaleDateString("fr-FR"),numero_page:1,total_pages:1}})()).then(e=>{H(e)})},[M,B,k,F,q,$,Y,Q,K,Z,J]);let ee=async(e,r)=>{try{let t=await fetch("/api/documents/generate",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({template_id:e.id,format:"PDF",variables:r})});if(!t.ok){let e=await t.json().catch(()=>({})),r=e.error||`Erreur ${t.status}: ${t.statusText}`,a=e.stack;throw console.error("Erreur API:",{status:t.status,statusText:t.statusText,error:r,stack:a,fullError:e}),Error(r)}return(await t.json()).downloadUrl}catch(r){console.error("Erreur lors de la génération du preview:",r);let e=r instanceof Error?r.message:"Erreur inconnue";return alert(`Erreur lors de la g\xe9n\xe9ration: ${e}`),null}};return G||!M?(0,r.jsx)(N.SkeletonLoader,{}):(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("div",{className:"flex items-center gap-4",children:[(0,r.jsx)(I.default,{href:"/dashboard/settings/document-templates",children:(0,r.jsx)(h.Button,{variant:"outline",size:"icon",children:(0,r.jsx)(f.ArrowLeft,{className:"h-4 w-4"})})}),(0,r.jsxs)("div",{children:[(0,r.jsxs)("h1",{className:"text-2xl font-bold text-text-primary flex items-center gap-2",children:[(0,r.jsx)(j.icon,{className:"h-6 w-6",style:{color:j.color}}),"Prévisualisation - ",j.name]}),(0,r.jsx)("p",{className:"text-sm text-text-tertiary mt-1",children:"Aperçu du document avec données réelles ou fictives"})]})]}),(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)(I.default,{href:`/dashboard/settings/document-templates/${C}/edit`,children:(0,r.jsx)(h.Button,{variant:"outline",children:"Modifier"})}),O&&(0,r.jsx)("a",{href:O,download:`${j.name}_preview.pdf`,children:(0,r.jsxs)(h.Button,{variant:"default",children:[(0,r.jsx)(v.Download,{className:"h-4 w-4 mr-2"}),"Télécharger PDF"]})})]})]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-4 gap-6",children:[(0,r.jsx)("div",{className:"lg:col-span-1",children:(0,r.jsxs)(g.GlassCard,{variant:"premium",className:"p-6",children:[(0,r.jsx)("h3",{className:"font-semibold text-text-primary mb-4",children:"Source de données"}),(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)(p.Label,{children:"Type de données"}),(0,r.jsxs)("select",{value:B,onChange:e=>{L(e.target.value),P(""),z(""),U(""),V("")},className:"w-full mt-1 px-3 py-2 border rounded-lg",children:[(0,r.jsx)("option",{value:"real",children:"Données réelles"}),(0,r.jsx)("option",{value:"sample",children:"Données fictives"})]})]}),"real"===B&&(0,r.jsxs)(r.Fragment,{children:[["attestation_reussite","certificat_scolarite","releve_notes","attestation_entree","attestation_assiduite"].includes(C)&&(0,r.jsxs)("div",{children:[(0,r.jsxs)(p.Label,{htmlFor:"student",className:"flex items-center gap-2",children:[(0,r.jsx)(w.User,{className:"h-4 w-4"}),"Étudiant"]}),(0,r.jsxs)("select",{id:"student",value:k,onChange:e=>{P(e.target.value),z(""),U(""),V("")},className:"w-full mt-1 px-3 py-2 border rounded-lg",children:[(0,r.jsx)("option",{value:"",children:"Sélectionner un étudiant"}),Q?.data?.map(e=>(0,r.jsxs)("option",{value:e.id,children:[e.last_name," ",e.first_name," (",e.student_number,")"]},e.id))]})]}),"facture"===C&&(0,r.jsxs)("div",{children:[(0,r.jsxs)(p.Label,{htmlFor:"invoice",className:"flex items-center gap-2",children:[(0,r.jsx)(E.FileText,{className:"h-4 w-4"}),"Facture"]}),(0,r.jsxs)("select",{id:"invoice",value:F,onChange:e=>{z(e.target.value),P(""),U(""),V("")},className:"w-full mt-1 px-3 py-2 border rounded-lg",children:[(0,r.jsx)("option",{value:"",children:"Sélectionner une facture"}),K?.map(e=>(0,r.jsxs)("option",{value:e.id,children:[e.invoice_number," - ",e.students?.first_name," ",e.students?.last_name]},e.id))]})]}),"recu_paiement"===C&&(0,r.jsxs)("div",{children:[(0,r.jsxs)(p.Label,{htmlFor:"payment",className:"flex items-center gap-2",children:[(0,r.jsx)(b.CreditCard,{className:"h-4 w-4"}),"Paiement"]}),(0,r.jsxs)("select",{id:"payment",value:q,onChange:e=>{U(e.target.value),P(""),z(""),V("")},className:"w-full mt-1 px-3 py-2 border rounded-lg",children:[(0,r.jsx)("option",{value:"",children:"Sélectionner un paiement"}),Z?.map(e=>{let t=Array.isArray(e.students)?e.students[0]:e.students||e.student,a=t?`${t.first_name||""} ${t.last_name||""}`.trim():"N/A";return(0,r.jsxs)("option",{value:e.id,children:[e.payment_number||e.id," - ",a]},e.id)})]})]}),["certificat_scolarite"].includes(C)&&(0,r.jsxs)("div",{children:[(0,r.jsxs)(p.Label,{htmlFor:"session",className:"flex items-center gap-2",children:[(0,r.jsx)(x.Calendar,{className:"h-4 w-4"}),"Session"]}),(0,r.jsxs)("select",{id:"session",value:$,onChange:e=>{V(e.target.value),P(""),z(""),U("")},className:"w-full mt-1 px-3 py-2 border rounded-lg",children:[(0,r.jsx)("option",{value:"",children:"Sélectionner une session"}),J?.map(e=>(0,r.jsxs)("option",{value:e.id,children:[e.name," - ",e.formations?.name]},e.id))]})]})]})]})]})}),(0,r.jsx)("div",{className:"lg:col-span-3",children:(0,r.jsxs)(_.Card,{children:[(0,r.jsx)(_.CardHeader,{children:(0,r.jsx)(_.CardTitle,{children:"Aperçu du document"})}),(0,r.jsx)(_.CardContent,{className:"p-0",children:O?(0,r.jsx)("iframe",{src:O,className:"w-full h-[800px] border-0",title:"Prévisualisation du document"}):(0,r.jsx)("div",{className:"flex items-center justify-center h-96 text-text-tertiary",children:(0,r.jsxs)("div",{className:"text-center",children:[(0,r.jsx)(y.Eye,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),(0,r.jsx)("p",{children:"Génération de la prévisualisation..."})]})})})]})})]})]})}e.s(["default",()=>A],233802)}]);