(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,871689,e=>{"use strict";let t=(0,e.i(475254).default)("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]]);e.s(["ArrowLeft",()=>t],871689)},514764,e=>{"use strict";let t=(0,e.i(475254).default)("Send",[["path",{d:"m22 2-7 20-4-9-9-4Z",key:"1q3vgg"}],["path",{d:"M22 2 11 13",key:"nzbqef"}]]);e.s(["Send",()=>t],514764)},794008,e=>{"use strict";let t=(0,e.i(475254).default)("File",[["path",{d:"M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z",key:"1nnpy2"}],["polyline",{points:"14 2 14 8 20 8",key:"1ew0cm"}]]);e.s(["File",()=>t],794008)},318216,e=>{"use strict";let t=(0,e.i(475254).default)("MoreVertical",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"12",cy:"5",r:"1",key:"gxeob9"}],["circle",{cx:"12",cy:"19",r:"1",key:"lyex9k"}]]);e.s(["MoreVertical",()=>t],318216)},604667,e=>{"use strict";var t=e.i(920755);let s=new class{supabase;constructor(e){this.supabase=e||(0,t.createClient)()}async getConversations(e,t){let{data:s,error:a}=await this.supabase.from("conversation_participants").select("conversation_id").eq("user_id",e);if(a)throw a;if(!s||0===s.length)return[];let i=s.map(e=>e.conversation_id),{data:r,error:n}=await this.supabase.from("conversations").select("*").eq("organization_id",t).eq("is_archived",!1).in("id",i).order("last_message_at",{ascending:!1,nullsFirst:!1});if(n)throw n;if(!r||0===r.length)return[];let{data:l}=await this.supabase.from("conversation_participants").select("*").in("conversation_id",i),d=[...new Set((l||[]).filter(e=>e.user_id).map(e=>e.user_id))],o=[...new Set((l||[]).filter(e=>e.student_id).map(e=>e.student_id))],c={};if(d.length>0){let{data:e}=await this.supabase.from("users").select("id, full_name, email, avatar_url").in("id",d);e?.forEach(e=>{c[e.id]=e})}let u={};if(o.length>0){let{data:e}=await this.supabase.from("students").select("id, first_name, last_name, email, student_number").in("id",o);e?.forEach(e=>{u[e.id]=e})}let m=r.map(e=>this.supabase.from("messages").select("*").eq("conversation_id",e.id).eq("is_deleted",!1).order("created_at",{ascending:!1}).limit(1).maybeSingle()),p=await Promise.all(m),h=[...new Set(p.filter(e=>e.data?.sender_id).map(e=>e.data.sender_id))],f=[...new Set(p.filter(e=>e.data?.student_sender_id).map(e=>e.data.student_sender_id))];if(h.length>0){let{data:e}=await this.supabase.from("users").select("id, full_name, email").in("id",h.filter(e=>!c[e]));e?.forEach(e=>{c[e.id]=e})}if(f.length>0){let{data:e}=await this.supabase.from("students").select("id, first_name, last_name, email, student_number").in("id",f.filter(e=>!u[e]));e?.forEach(e=>{u[e.id]=e})}return r.map((e,t)=>{let s=(l||[]).filter(t=>t.conversation_id===e.id).map(e=>({...e,user:e.user_id&&c[e.user_id]||null,student:e.student_id&&u[e.student_id]||null})),a=p[t].data,i=null;return a&&(i={...a,sender:a.sender_id&&c[a.sender_id]||null,student_sender:a.student_sender_id&&u[a.student_sender_id]||null}),{...e,participants:s,last_message:i}})}async getConversationsByStudentId(e,t){let{data:s,error:a}=await this.supabase.from("conversation_participants").select("conversation_id").eq("student_id",e);if(a)throw a;if(!s||0===s.length)return[];let i=s.map(e=>e.conversation_id),{data:r,error:n}=await this.supabase.from("conversations").select("*").eq("organization_id",t).eq("is_archived",!1).in("id",i).order("last_message_at",{ascending:!1,nullsFirst:!1});if(n)throw n;return r&&0!==r.length?await Promise.all(r.map(async e=>{let{data:t}=await this.supabase.from("conversation_participants").select("*").eq("conversation_id",e.id),s=await Promise.all((t||[]).map(async e=>{let t=null,s=null;if(e.user_id){let{data:s}=await this.supabase.from("users").select("id, full_name, email, avatar_url").eq("id",e.user_id).maybeSingle();t=s}if(e.student_id){let{data:t}=await this.supabase.from("students").select("id, first_name, last_name, email, student_number").eq("id",e.student_id).maybeSingle();s=t}return{...e,user:t,student:s}})),{data:a}=await this.supabase.from("messages").select("*").eq("conversation_id",e.id).eq("is_deleted",!1).order("created_at",{ascending:!1}).limit(1),i=null;if(a&&a.length>0){let e=a[0],t=null;if(e.sender_id){let{data:s}=await this.supabase.from("users").select("id, full_name, email").eq("id",e.sender_id).maybeSingle();t=s}i={...e,sender:t}}return{...e,participants:s,last_message:i}})):[]}async getConversationById(e){let{data:t,error:s}=await this.supabase.from("conversations").select("id, organization_id, conversation_type, name, created_by, created_at, updated_at, is_archived, last_message_at").eq("id",e).maybeSingle();if(s)throw console.error("[MESSAGING] Erreur récupération conversation:",s),s;if(!t)return null;let{data:a,error:i}=await this.supabase.from("conversation_participants").select("*").eq("conversation_id",e);if(i)throw i;let r=await Promise.all((a||[]).map(async e=>{let t=null,s=null;if(e.user_id){let{data:s}=await this.supabase.from("users").select("id, full_name, email, avatar_url").eq("id",e.user_id).maybeSingle();t=s}if(e.student_id){let{data:t}=await this.supabase.from("students").select("id, first_name, last_name, email, student_number").eq("id",e.student_id).maybeSingle();s=t}return{...e,user:t,student:s}}));return{...t,participants:r}}async createDirectConversation(e,t,s,a){let{data:i,error:r}=await this.supabase.from("conversations").select("id").eq("conversation_type","direct").eq("organization_id",s);if(!r&&i&&i.length>0){let s=i.map(e=>e.id),{data:r,error:n}=await this.supabase.from("conversation_participants").select("conversation_id").eq("user_id",e).in("conversation_id",s);if(!n&&r&&r.length>0){let e=r.map(e=>e.conversation_id),s=this.supabase.from("conversation_participants").select("conversation_id").in("conversation_id",e);t?s=s.eq("user_id",t):a&&(s=s.eq("student_id",a));let{data:i}=await s.maybeSingle();if(i)return this.getConversationById(i.conversation_id)}}let{data:n,error:l}=await this.supabase.from("conversations").insert({organization_id:s,conversation_type:"direct",created_by:e}).select().single();if(l)throw l;return await this.addParticipant(n.id,e,"member"),await this.addParticipant(n.id,t,"member",a),this.getConversationById(n.id)}async createGroupConversation(e,t,s,a,i){let{data:r,error:n}=await this.supabase.from("conversations").insert({organization_id:s,conversation_type:"group",name:e,created_by:a}).select().single();if(n)throw n;for(let e of t)await this.addParticipant(r.id,e,e===a?"owner":"member");if(i&&i.length>0)for(let e of i)await this.addParticipant(r.id,null,"member",e);return this.getConversationById(r.id)}async updateConversation(e,t){let{data:s,error:a}=await this.supabase.from("conversations").update(t).eq("id",e).select().single();if(a)throw a;return s}async archiveConversation(e){return this.updateConversation(e,{is_archived:!0})}async deleteConversation(e){return this.updateConversation(e,{is_archived:!0})}async pinConversation(e,t){return this.updateConversation(e,{is_pinned:t})}async addParticipant(e,t,s="member",a){let i={conversation_id:e,role:s};if(t)i.user_id=t;else if(a)i.student_id=a;else throw Error("Either userId or studentId must be provided");let{data:r,error:n}=await this.supabase.from("conversation_participants").insert(i).select().single();if(n)throw n;return r}async removeParticipant(e,t){let{error:s}=await this.supabase.from("conversation_participants").delete().eq("conversation_id",e).eq("user_id",t);if(s)throw s}async updateParticipantRole(e,t,s){let{data:a,error:i}=await this.supabase.from("conversation_participants").update({role:s}).eq("conversation_id",e).eq("user_id",t).select().single();if(i)throw i;return a}async muteConversation(e,t,s){let{data:a,error:i}=await this.supabase.from("conversation_participants").update({is_muted:s}).eq("conversation_id",e).eq("user_id",t).select().single();if(i)throw i;return a}async markAsRead(e,t){let{error:s}=await this.supabase.from("conversation_participants").update({last_read_at:new Date().toISOString()}).eq("conversation_id",e).eq("user_id",t);if(s)throw s;let{data:a}=await this.supabase.from("messages").select("id").eq("conversation_id",e).not("sender_id","eq",t);if(a)for(let e of a)await this.supabase.from("message_reads").upsert({message_id:e.id,user_id:t,read_at:new Date().toISOString()})}async getMessages(e,t=50,s=0){let{data:a,error:i}=await this.supabase.from("messages").select("*").eq("conversation_id",e).eq("is_deleted",!1).order("created_at",{ascending:!1}).range(s,s+t-1);if(i)throw i;return a&&0!==a.length?(await Promise.all(a.map(async e=>{let t=null,s=null,a=null;if(e.sender_id){let{data:s}=await this.supabase.from("users").select("id, full_name, email, avatar_url").eq("id",e.sender_id).maybeSingle();t=s}if(e.student_sender_id){let{data:t}=await this.supabase.from("students").select("id, first_name, last_name, email, student_number").eq("id",e.student_sender_id).maybeSingle();s=t}if(e.reply_to_id){let{data:t}=await this.supabase.from("messages").select("*").eq("id",e.reply_to_id).maybeSingle();if(t){let e=null,s=null;if(t.sender_id){let{data:s}=await this.supabase.from("users").select("id, full_name").eq("id",t.sender_id).maybeSingle();e=s}if(t.student_sender_id){let{data:e}=await this.supabase.from("students").select("id, first_name, last_name, email, student_number").eq("id",t.student_sender_id).maybeSingle();s=e}a={...t,sender:e,student_sender:s}}}return{...e,sender:t,student_sender:s,reply_to:a}}))).reverse():[]}async uploadAttachment(e,t){let s=e.name.split(".").pop(),a=`${Date.now()}-${Math.random().toString(36).substring(7)}.${s}`,i=`${t}/${a}`,{data:r,error:n}=await this.supabase.storage.from("messages").upload(i,e,{cacheControl:"3600",upsert:!1});if(n)throw n;return i}async getAttachmentUrl(e){let{data:t,error:s}=await this.supabase.storage.from("messages").createSignedUrl(e,3600);if(s)throw s;return t.signedUrl}async sendMessage(e){let{data:t,error:s}=await this.supabase.from("messages").insert(e).select("*").single();if(s)throw s;let a=null,i=null;if(t.sender_id){let{data:e}=await this.supabase.from("users").select("id, full_name, email, avatar_url").eq("id",t.sender_id).maybeSingle();a=e}if(t.student_sender_id){let{data:e}=await this.supabase.from("students").select("id, first_name, last_name, email, student_number").eq("id",t.student_sender_id).maybeSingle();i=e}return{...t,sender:a,student_sender:i}}async updateMessage(e,t){let{data:s,error:a}=await this.supabase.from("messages").update({content:t,is_edited:!0}).eq("id",e).select().single();if(a)throw a;return s}async deleteMessage(e){let{data:t,error:s}=await this.supabase.from("messages").update({is_deleted:!0,deleted_at:new Date().toISOString(),content:"Message supprimé"}).eq("id",e).select().single();if(s)throw s;return t}async addReaction(e,t,s){let{data:a}=await this.supabase.from("messages").select("reactions").eq("id",e).single();if(!a)throw Error("Message non trouvé");let i=a.reactions||{};i[s]||(i[s]=[]),i[s].includes(t)||i[s].push(t);let{data:r,error:n}=await this.supabase.from("messages").update({reactions:i}).eq("id",e).select().single();if(n)throw n;return r}async removeReaction(e,t,s){let{data:a}=await this.supabase.from("messages").select("reactions").eq("id",e).single();if(!a)throw Error("Message non trouvé");let i=a.reactions||{};i[s]&&(i[s]=i[s].filter(e=>e!==t),0===i[s].length&&delete i[s]);let{data:r,error:n}=await this.supabase.from("messages").update({reactions:i}).eq("id",e).select().single();if(n)throw n;return r}async pinMessage(e,t,s){let{data:a,error:i}=await this.supabase.from("pinned_messages").insert({conversation_id:e,message_id:t,pinned_by:s}).select().single();if(i)throw i;return a}async unpinMessage(e,t){let{error:s}=await this.supabase.from("pinned_messages").delete().eq("conversation_id",e).eq("message_id",t);if(s)throw s}async getPinnedMessages(e){let{data:t,error:s}=await this.supabase.from("pinned_messages").select(`
        *,
        message:messages(*, sender:users(id, full_name, email)),
        pinned_by_user:users(id, full_name)
      `).eq("conversation_id",e).order("pinned_at",{ascending:!1});if(s)throw s;return t}async createCall(e){let{data:t,error:s}=await this.supabase.from("calls").insert(e).select().single();if(s)throw s;return t}async updateCallStatus(e,t,s){let a={status:t};"active"===t?a.started_at=new Date().toISOString():"ended"===t&&(a.ended_at=new Date().toISOString(),s&&(a.duration_seconds=s));let{data:i,error:r}=await this.supabase.from("calls").update(a).eq("id",e).select().single();if(r)throw r;return i}async addCallParticipant(e,t){let{data:s,error:a}=await this.supabase.from("call_participants").insert({call_id:e,user_id:t,status:"joined",joined_at:new Date().toISOString()}).select().single();if(a)throw a;return s}async getNotifications(e,t=!1){let s=this.supabase.from("message_notifications").select(`
        *,
        conversation:conversations(*),
        message:messages(*, sender:users(id, full_name, email))
      `).eq("user_id",e);t&&(s=s.eq("is_read",!1));let{data:a,error:i}=await s.order("created_at",{ascending:!1}).limit(50);if(i)throw i;return a}async markNotificationAsRead(e){let{data:t,error:s}=await this.supabase.from("message_notifications").update({is_read:!0,read_at:new Date().toISOString()}).eq("id",e).select().single();if(s)throw s;return t}async markAllNotificationsAsRead(e){let{error:t}=await this.supabase.from("message_notifications").update({is_read:!0,read_at:new Date().toISOString()}).eq("user_id",e).eq("is_read",!1);if(t)throw t}async searchMessages(e,t){let{data:s,error:a}=await this.supabase.from("messages").select(`
        *,
        sender:users(id, full_name, email, avatar_url)
      `).eq("conversation_id",e).eq("is_deleted",!1).ilike("content",`%${t}%`).order("created_at",{ascending:!1}).limit(50);if(a)throw a;return s}};e.s(["messagingService",0,s])},572997,e=>{"use strict";var t=e.i(843476),s=e.i(794008),a=e.i(473708),i=e.i(178583),r=e.i(440160),n=e.i(167881),l=e.i(647163),d=e.i(271645),o=e.i(920755);function c({attachments:e,className:c}){let[u,m]=(0,d.useState)({});return((0,d.useEffect)(()=>{let t=async()=>{let t=(0,o.createClient)(),s=e.map(async(e,s)=>{if(e.url)return{index:s,url:e.url};if(e.path)try{let{data:a,error:i}=await t.storage.from("messages").createSignedUrl(e.path,3600);if(i)return console.error("Erreur génération URL pièce jointe:",i),{index:s,url:null};return{index:s,url:a.signedUrl}}catch(e){console.error("Exception génération URL pièce jointe:",e)}return{index:s,url:null}}),a=await Promise.all(s),i={};a.forEach(({index:e,url:t})=>{t&&(i[e]=t)}),m(i)};e&&e.length>0&&t()},[e]),e&&0!==e.length)?(0,t.jsx)("div",{className:(0,l.cn)("space-y-2",c),children:e.map((e,l)=>{var d;return(0,t.jsxs)("div",{className:"flex items-center gap-3 p-3 border rounded-lg bg-background hover:bg-muted/50 transition-colors",children:[(0,t.jsx)("div",{className:"flex-shrink-0 w-10 h-10 rounded border flex items-center justify-center bg-muted",children:(d=e.type).startsWith("image/")?(0,t.jsx)(a.Image,{className:"h-4 w-4"}):"application/pdf"===d?(0,t.jsx)(i.FileText,{className:"h-4 w-4"}):(0,t.jsx)(s.File,{className:"h-4 w-4"})}),(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsx)("p",{className:"text-sm font-medium truncate",children:e.filename}),e.size&&(0,t.jsx)("p",{className:"text-xs text-muted-foreground",children:(e=>{if(!e)return"";if(0===e)return"0 Bytes";let t=Math.floor(Math.log(e)/Math.log(1024));return Math.round(e/Math.pow(1024,t)*100)/100+" "+["Bytes","KB","MB","GB"][t]})(e.size)})]}),(0,t.jsx)(n.Button,{variant:"ghost",size:"icon",className:"flex-shrink-0 h-8 w-8",onClick:()=>{let t;(t=u[l]||e.url)?window.open(t,"_blank"):console.error("URL non disponible pour la pièce jointe:",e)},title:"Télécharger",disabled:!u[l]&&!e.url,children:(0,t.jsx)(r.Download,{className:"h-4 w-4"})})]},l)})}):null}e.s(["MessageAttachmentViewer",()=>c])},991660,e=>{"use strict";var t=e.i(843476),s=e.i(618566),a=e.i(266027),i=e.i(954616),r=e.i(912598),n=e.i(325715),l=e.i(604667),d=e.i(167881),o=e.i(23750),c=e.i(970065),u=e.i(871689),m=e.i(514764),p=e.i(629377),h=e.i(761911),f=e.i(284614),g=e.i(686311),_=e.i(727612),x=e.i(318216),v=e.i(271645),w=e.i(647163),b=e.i(6799);let y=(0,e.i(475254).default)("Paperclip",[["path",{d:"m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.57a2 2 0 0 1-2.83-2.83l8.49-8.48",key:"1u3ebp"}]]);var j=e.i(37727),N=e.i(794008),q=e.i(473708),S=e.i(178583);function C({attachments:e,onAttachmentsChange:s,onRemove:a,disabled:i=!1}){let r=(0,v.useRef)(null),[n,l]=(0,v.useState)(!1),o=t=>{t&&s([...e,...Array.from(t).map(e=>{let t,s=Math.random().toString(36).substring(7);return e.type.startsWith("image/")&&(t=URL.createObjectURL(e)),{file:e,id:s,preview:t}})])};return(0,t.jsxs)("div",{className:"space-y-2",children:[0===e.length&&(0,t.jsxs)("div",{onDragOver:e=>{e.preventDefault(),l(!0)},onDragLeave:e=>{e.preventDefault(),l(!1)},onDrop:e=>{e.preventDefault(),l(!1),o(e.dataTransfer.files)},className:(0,w.cn)("border-2 border-dashed rounded-lg p-4 text-center transition-colors",n?"border-primary bg-primary/5":"border-muted-foreground/25",i&&"opacity-50 cursor-not-allowed"),children:[(0,t.jsx)("input",{ref:r,type:"file",multiple:!0,className:"hidden",onChange:e=>o(e.target.files),disabled:i,accept:"image/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.csv,.zip"}),(0,t.jsxs)(d.Button,{type:"button",variant:"ghost",size:"sm",onClick:()=>r.current?.click(),disabled:i,className:"mx-auto",children:[(0,t.jsx)(y,{className:"h-4 w-4 mr-2"}),"Joindre des fichiers"]}),(0,t.jsx)("p",{className:"text-xs text-muted-foreground mt-2",children:"Glissez-déposez des fichiers ici ou cliquez pour sélectionner"})]}),e.length>0&&(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("span",{className:"text-sm font-medium text-muted-foreground",children:[e.length," fichier",e.length>1?"s":""," attaché",e.length>1?"s":""]}),(0,t.jsxs)(d.Button,{type:"button",variant:"ghost",size:"sm",onClick:()=>r.current?.click(),disabled:i,children:[(0,t.jsx)(y,{className:"h-4 w-4 mr-2"}),"Ajouter"]})]}),(0,t.jsx)("input",{ref:r,type:"file",multiple:!0,className:"hidden",onChange:e=>o(e.target.files),disabled:i,accept:"image/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.csv,.zip"}),(0,t.jsx)("div",{className:"grid grid-cols-1 gap-2",children:e.map(e=>{var s;return(0,t.jsxs)("div",{className:"flex items-center gap-3 p-2 border rounded-lg bg-muted/50",children:[e.preview&&(0,t.jsx)("div",{className:"flex-shrink-0 w-12 h-12 rounded overflow-hidden border",children:(0,t.jsx)("img",{src:e.preview,alt:e.file.name,className:"w-full h-full object-cover"})}),!e.preview&&(0,t.jsx)("div",{className:"flex-shrink-0 w-12 h-12 rounded border flex items-center justify-center bg-background",children:(s=e.file).type.startsWith("image/")?(0,t.jsx)(q.Image,{className:"h-4 w-4"}):"application/pdf"===s.type?(0,t.jsx)(S.FileText,{className:"h-4 w-4"}):(0,t.jsx)(N.File,{className:"h-4 w-4"})}),(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsx)("p",{className:"text-sm font-medium truncate",children:e.file.name}),(0,t.jsx)("p",{className:"text-xs text-muted-foreground",children:(e=>{if(0===e)return"0 Bytes";let t=Math.floor(Math.log(e)/Math.log(1024));return Math.round(e/Math.pow(1024,t)*100)/100+" "+["Bytes","KB","MB","GB"][t]})(e.file.size)})]}),(0,t.jsx)(d.Button,{type:"button",variant:"ghost",size:"icon",className:"flex-shrink-0 h-8 w-8",onClick:()=>{e.preview&&URL.revokeObjectURL(e.preview),a(e.id)},disabled:i,children:(0,t.jsx)(j.X,{className:"h-4 w-4"})})]},e.id)})})]})]})}var M=e.i(572997),k=e.i(463415);function z(){let e=(0,s.useParams)(),y=(0,s.useRouter)(),{user:j}=(0,n.useAuth)(),N=(0,r.useQueryClient)(),{addToast:q}=(0,b.useToast)(),S=e.id,[z,P]=(0,v.useState)(""),[B,A]=(0,v.useState)(50),[E,I]=(0,v.useState)(0),R=(0,v.useRef)(null),D=(0,v.useRef)(null),[L,U]=(0,v.useState)(!0),[$,F]=(0,v.useState)([]),{data:O,isLoading:T,error:K}=(0,a.useQuery)({queryKey:["conversation",S],queryFn:()=>l.messagingService.getConversationById(S),enabled:!!S}),{data:V,isLoading:Q,refetch:G}=(0,a.useQuery)({queryKey:["messages",S,B],queryFn:async()=>{let e=await l.messagingService.getMessages(S,B,0);return U(e.length>=B),e},enabled:!!S,refetchInterval:5e3});(0,v.useEffect)(()=>{A(50),U(!0)},[S]);let W=(0,i.useMutation)({mutationFn:async e=>l.messagingService.deleteMessage(e),onSuccess:()=>{N.invalidateQueries({queryKey:["messages",S]}),N.invalidateQueries({queryKey:["conversations"]}),q({type:"success",title:"Message supprimé",description:"Le message a été supprimé avec succès."})},onError:e=>{q({type:"error",title:"Erreur",description:e instanceof Error?e.message:"Une erreur est survenue lors de la suppression du message."})}}),H=(0,i.useMutation)({mutationFn:async({content:e,files:t})=>{if(!j?.id||!S)throw Error("Utilisateur non authentifié");let s=null;if(t.length>0){let e=t.map(async e=>({url:await l.messagingService.uploadAttachment(e.file,S),filename:e.file.name,type:e.file.type,size:e.file.size}));s=await Promise.all(e)}return l.messagingService.sendMessage({conversation_id:S,sender_id:j.id,content:e.trim()||(s?"[Pièces jointes]":""),attachments:s,message_type:s&&s.some(e=>e.type.startsWith("image/"))?"image":"text",is_deleted:!1,is_edited:!1})},onSuccess:()=>{P(""),F([]),N.invalidateQueries({queryKey:["messages",S]}),N.invalidateQueries({queryKey:["conversations"]}),setTimeout(()=>{R.current?.scrollIntoView({behavior:"smooth"})},100)},onError:e=>{q({type:"error",title:"Erreur",description:e instanceof Error?e.message:"Une erreur est survenue lors de l'envoi du message."})}});(0,v.useEffect)(()=>{R.current?.scrollIntoView({behavior:"smooth"})},[V]);let J=e=>{let t=$.find(t=>t.id===e);t?.preview&&URL.revokeObjectURL(t.preview),F($.filter(t=>t.id!==e))},X=(()=>{if(!O?.participants)return null;let e=O.participants.find(e=>e.user_id!==j?.id&&e.student_id);if(e?.student)return{name:`${e.student.first_name||""} ${e.student.last_name||""}`.trim()||e.student.email||`Candidat ${e.student.student_number||""}`,type:"student",data:e.student};let t=O.participants.find(e=>e.user_id!==j?.id&&e.user);return t?.user?{name:t.user.full_name||t.user.email||"Utilisateur",type:"user",data:t.user}:null})();return T?(0,t.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,t.jsx)(p.Loader2,{className:"h-8 w-8 animate-spin text-muted-foreground"})}):K||!O?(0,t.jsxs)("div",{className:"container mx-auto py-8 px-4 max-w-7xl",children:[(0,t.jsxs)("div",{className:"flex items-center gap-4 mb-6",children:[(0,t.jsx)(d.Button,{variant:"ghost",size:"icon",onClick:()=>y.push("/dashboard/messages"),children:(0,t.jsx)(u.ArrowLeft,{className:"h-4 w-4"})}),(0,t.jsx)("h1",{className:"text-2xl font-bold",children:"Conversation introuvable"})]}),(0,t.jsx)(c.Card,{children:(0,t.jsx)(c.CardContent,{className:"py-8 text-center",children:(0,t.jsx)("p",{className:"text-muted-foreground",children:"Cette conversation n'existe pas ou vous n'avez pas la permission de la voir."})})})]}):(0,t.jsxs)("div",{className:"flex flex-col h-[calc(100vh-4rem)]",children:[(0,t.jsx)("div",{className:"border-b bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60",children:(0,t.jsx)("div",{className:"container mx-auto px-4 py-4 max-w-7xl",children:(0,t.jsxs)("div",{className:"flex items-center gap-4",children:[(0,t.jsx)(d.Button,{variant:"ghost",size:"icon",onClick:()=>y.push("/dashboard/messages"),children:(0,t.jsx)(u.ArrowLeft,{className:"h-4 w-4"})}),(0,t.jsxs)("div",{className:"flex items-center gap-3 flex-1",children:[X?.type==="student"?(0,t.jsx)("div",{className:"h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center",children:(0,t.jsx)(f.User,{className:"h-5 w-5 text-primary"})}):(0,t.jsx)("div",{className:"h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center",children:(0,t.jsx)(h.Users,{className:"h-5 w-5 text-primary"})}),(0,t.jsxs)("div",{children:[(0,t.jsx)("h1",{className:"text-lg font-semibold",children:X?.name||"Conversation"}),"group"===O.conversation_type&&O.name&&(0,t.jsx)("p",{className:"text-sm text-muted-foreground",children:O.name})]})]})]})})}),(0,t.jsx)("div",{ref:D,className:"flex-1 overflow-y-auto container mx-auto px-4 py-6 max-w-7xl",children:Q&&50===B?(0,t.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,t.jsx)(p.Loader2,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):V&&V.length>0?(0,t.jsxs)("div",{className:"space-y-4",children:[L&&V.length>0&&(0,t.jsx)("div",{className:"flex justify-center py-4",children:(0,t.jsx)(d.Button,{variant:"outline",onClick:()=>{A(e=>e+50)},disabled:Q,className:"flex items-center gap-2",children:Q?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(p.Loader2,{className:"h-4 w-4 animate-spin"}),"Chargement..."]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(u.ArrowLeft,{className:"h-4 w-4 rotate-90"}),"Charger plus de messages (",V.length," affichés)"]})})}),V.map(e=>{let s=e.sender_id===j?.id,a="Expéditeur inconnu";return e.sender?a=e.sender.full_name||e.sender.email||"Expéditeur inconnu":e.student_sender&&(a=`${e.student_sender.first_name||""} ${e.student_sender.last_name||""}`.trim()||e.student_sender.email||(e.student_sender.student_number?`Candidat ${e.student_sender.student_number}`:"Expéditeur inconnu")),(0,t.jsxs)("div",{className:`flex items-start gap-2 ${s?"justify-end":"justify-start"}`,children:[!s&&(0,t.jsx)("div",{className:"w-8"}),(0,t.jsxs)("div",{className:"group relative flex items-start gap-2",children:[(0,t.jsxs)("div",{className:`max-w-[70%] rounded-lg px-4 py-2 ${s?"bg-primary text-primary-foreground":"bg-muted"}`,children:[!s&&(0,t.jsx)("p",{className:"text-xs font-medium mb-1 opacity-80",children:a}),e.attachments&&Array.isArray(e.attachments)&&e.attachments.length>0&&(0,t.jsx)("div",{className:"mb-2",children:(0,t.jsx)(M.MessageAttachmentViewer,{attachments:e.attachments})}),(0,t.jsx)("p",{className:"text-sm whitespace-pre-wrap",children:e.content}),(0,t.jsx)("p",{className:`text-xs mt-1 ${s?"text-primary-foreground/70":"text-muted-foreground"}`,children:(0,w.formatRelativeTime)(e.created_at)})]}),s&&(0,t.jsxs)(k.DropdownMenu,{children:[(0,t.jsx)(k.DropdownMenuTrigger,{asChild:!0,children:(0,t.jsx)(d.Button,{variant:"ghost",size:"icon",className:"h-6 w-6 opacity-0 group-hover:opacity-100 transition-opacity",onClick:e=>e.stopPropagation(),children:(0,t.jsx)(x.MoreVertical,{className:"h-3 w-3"})})}),(0,t.jsx)(k.DropdownMenuContent,{align:"end",children:(0,t.jsxs)(k.DropdownMenuItem,{onClick:t=>{t.preventDefault(),t.stopPropagation(),confirm("Êtes-vous sûr de vouloir supprimer ce message ?")&&W.mutate(e.id)},disabled:W.isPending,className:"text-destructive focus:text-destructive",children:[(0,t.jsx)(_.Trash2,{className:"mr-2 h-4 w-4"}),"Supprimer"]})})]})]}),s&&(0,t.jsx)("div",{className:"w-8"})]},e.id)}),(0,t.jsx)("div",{ref:R})]}):(0,t.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)(g.MessageSquare,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),(0,t.jsx)("p",{className:"text-muted-foreground",children:"Aucun message pour le moment"}),(0,t.jsx)("p",{className:"text-sm text-muted-foreground mt-2",children:"Commencez la conversation en envoyant un message"})]})})}),(0,t.jsx)("div",{className:"border-t bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60",children:(0,t.jsxs)("div",{className:"container mx-auto px-4 py-4 max-w-7xl space-y-3",children:[$.length>0&&(0,t.jsx)("div",{className:"pb-2",children:(0,t.jsx)(C,{attachments:$,onAttachmentsChange:F,onRemove:J,disabled:H.isPending})}),(0,t.jsxs)("form",{onSubmit:e=>{e.preventDefault(),(z.trim()||0!==$.length)&&!H.isPending&&H.mutate({content:z.trim(),files:$})},className:"flex gap-2",children:[(0,t.jsx)(o.Input,{value:z,onChange:e=>P(e.target.value),placeholder:"Tapez votre message...",disabled:H.isPending,className:"flex-1"}),(0,t.jsx)(d.Button,{type:"submit",disabled:!z.trim()&&0===$.length||H.isPending,size:"icon",children:H.isPending?(0,t.jsx)(p.Loader2,{className:"h-4 w-4 animate-spin"}):(0,t.jsx)(m.Send,{className:"h-4 w-4"})})]}),0===$.length&&(0,t.jsx)("div",{className:"pt-2",children:(0,t.jsx)(C,{attachments:$,onAttachmentsChange:F,onRemove:J,disabled:H.isPending})})]})})]})}e.s(["default",()=>z],991660)}]);