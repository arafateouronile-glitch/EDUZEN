(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,871689,e=>{"use strict";let r=(0,e.i(475254).default)("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]]);e.s(["ArrowLeft",()=>r],871689)},263488,e=>{"use strict";let r=(0,e.i(475254).default)("Mail",[["rect",{width:"20",height:"16",x:"2",y:"4",rx:"2",key:"18n3k1"}],["path",{d:"m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7",key:"1ocrg3"}]]);e.s(["Mail",()=>r],263488)},436332,e=>{"use strict";let r=(0,e.i(475254).default)("PenSquare",[["path",{d:"M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1qinfi"}],["path",{d:"M18.5 2.5a2.12 2.12 0 0 1 3 3L12 15l-4 1 1-4Z",key:"w2jsv5"}]]);e.s(["Edit",()=>r],436332)},212426,e=>{"use strict";let r=(0,e.i(475254).default)("DollarSign",[["line",{x1:"12",x2:"12",y1:"2",y2:"22",key:"7eqyqh"}],["path",{d:"M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6",key:"1b0p4s"}]]);e.s(["DollarSign",()=>r],212426)},238491,e=>{"use strict";let r=(0,e.i(475254).default)("Phone",[["path",{d:"M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z",key:"foiqr5"}]]);e.s(["Phone",()=>r],238491)},221345,e=>{"use strict";let r=(0,e.i(475254).default)("Link",[["path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71",key:"1cjeqo"}],["path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71",key:"19qd67"}]]);e.s(["Link",()=>r],221345)},246704,779478,e=>{"use strict";var r,t,a=e.i(790224),s=((r={}).AUTH_REQUIRED="AUTH_1001",r.AUTH_INVALID_CREDENTIALS="AUTH_1002",r.AUTH_SESSION_EXPIRED="AUTH_1003",r.AUTH_INSUFFICIENT_PERMISSIONS="AUTH_1004",r.AUTH_2FA_REQUIRED="AUTH_1005",r.AUTH_2FA_INVALID="AUTH_1006",r.VALIDATION_ERROR="VALID_2001",r.VALIDATION_REQUIRED_FIELD="VALID_2002",r.VALIDATION_INVALID_FORMAT="VALID_2003",r.VALIDATION_UNIQUE_CONSTRAINT="VALID_2004",r.DB_CONNECTION_ERROR="DB_3001",r.DB_QUERY_ERROR="DB_3002",r.DB_NOT_FOUND="DB_3003",r.DB_CONSTRAINT_VIOLATION="DB_3004",r.DB_FOREIGN_KEY_CONSTRAINT="DB_3006",r.DB_RLS_POLICY_VIOLATION="DB_3005",r.NETWORK_ERROR="NET_4001",r.API_TIMEOUT="NET_4002",r.API_RATE_LIMIT="NET_4003",r.API_SERVER_ERROR="NET_4004",r.API_NOT_FOUND="NET_4005",r.API_BAD_REQUEST="NET_4006",r.BUSINESS_LOGIC_ERROR="BIZ_5001",r.RESOURCE_LOCKED="BIZ_5002",r.OPERATION_NOT_ALLOWED="BIZ_5003",r.QUOTA_EXCEEDED="BIZ_5004",r.INTERNAL_ERROR="SYS_6001",r.CONFIGURATION_ERROR="SYS_6002",r.SERVICE_UNAVAILABLE="SYS_6003",r);(t={}).LOW="low",t.MEDIUM="medium",t.HIGH="high",t.CRITICAL="critical";class i extends Error{code;severity;userMessage;retryable;context;originalError;constructor(e,r="SYS_6001",t="medium",a={},s){super(e),this.name="AppError",this.code=r,this.severity=t,this.userMessage=a.userMessage||this.getDefaultUserMessage(r),this.retryable=a.retryable??this.isRetryable(r),this.context={...a,code:r,severity:t,timestamp:new Date().toISOString()},this.originalError=s,Error.captureStackTrace&&Error.captureStackTrace(this,i)}getDefaultUserMessage(e){return({AUTH_1001:"Vous devez être connecté pour effectuer cette action.",AUTH_1002:"Email ou mot de passe incorrect.",AUTH_1003:"Votre session a expiré. Veuillez vous reconnecter.",AUTH_1004:"Vous n'avez pas les permissions nécessaires.",AUTH_1005:"Authentification à deux facteurs requise.",AUTH_1006:"Code d'authentification invalide.",VALID_2001:"Les données fournies ne sont pas valides.",VALID_2002:"Certains champs obligatoires sont manquants.",VALID_2003:"Le format des données est incorrect.",VALID_2004:"Cette valeur existe déjà.",DB_3001:"Impossible de se connecter à la base de données.",DB_3002:"Erreur lors de l'exécution de la requête.",DB_3003:"Ressource introuvable.",DB_3004:"Cette opération viole une contrainte de la base de données.",DB_3006:"Cette opération viole une contrainte de clé étrangère.",DB_3005:"Vous n'avez pas accès à cette ressource.",NET_4001:"Erreur de connexion réseau. Vérifiez votre connexion internet.",NET_4002:"La requête a pris trop de temps. Veuillez réessayer.",NET_4003:"Trop de requêtes. Veuillez patienter quelques instants.",NET_4004:"Erreur serveur. Veuillez réessayer plus tard.",NET_4005:"Ressource introuvable.",NET_4006:"Requête invalide.",BIZ_5001:"Cette opération n'est pas autorisée dans le contexte actuel.",BIZ_5002:"Cette ressource est actuellement verrouillée.",BIZ_5003:"Cette opération n'est pas autorisée.",BIZ_5004:"Vous avez atteint la limite autorisée.",SYS_6001:"Une erreur interne est survenue. Veuillez réessayer.",SYS_6002:"Erreur de configuration du système.",SYS_6003:"Service temporairement indisponible."})[e]||"Une erreur inattendue est survenue."}isRetryable(e){return["NET_4001","NET_4002","NET_4004","DB_3001","SYS_6003"].includes(e)}toJSON(){return{name:this.name,message:this.message,code:this.code,severity:this.severity,userMessage:this.userMessage,retryable:this.retryable,context:this.context,stack:this.stack,originalError:this.originalError instanceof Error?{name:this.originalError.name,message:this.originalError.message,stack:this.originalError.stack}:this.originalError}}}let n=new class{handleError(e,r={}){if(e instanceof i)return this.logError(e),e;if(e instanceof Error)return this.handleStandardError(e,r);if(this.isSupabaseError(e))return this.handleSupabaseError(e,r);let t=new i("Une erreur inattendue est survenue.","SYS_6001","high",r,e);return this.logError(t),t}handleStandardError(e,r){let t=e.message.toLowerCase(),a="SYS_6001",s="medium";t.includes("network")||t.includes("fetch")?(a="NET_4001",s="medium"):t.includes("timeout")?(a="NET_4002",s="medium"):t.includes("unauthorized")||t.includes("401")?(a="AUTH_1001",s="high"):t.includes("forbidden")||t.includes("403")?(a="AUTH_1004",s="high"):t.includes("not found")||t.includes("404")?(a="DB_3003",s="low"):(t.includes("validation")||t.includes("invalid"))&&(a="VALID_2001",s="low");let n=new i(e.message,a,s,r,e);return this.logError(n),n}handleSupabaseError(e,r){let t=e.code||e.status,a=e.message||"Erreur Supabase",s=r.code||"DB_3002",n="medium";if(!r.code)switch(t){case"PGRST116":case"42P01":s="DB_3003",n="low";break;case"42501":s="DB_3005",n="high";break;case"23505":s="VALID_2004",n="low";break;case"23503":s="DB_3004",n="medium";break;case"PGRST301":case"400":s="NET_4006",n="low";break;case"401":s="AUTH_1001",n="high";break;case"403":s="AUTH_1004",n="high";break;case"404":s="NET_4005",n="low";break;case"500":s="NET_4004",n="high"}"DB_3006"===s&&(n="medium");let o=new i(a,s,n,r,e);return this.logError(o),o}isSupabaseError(e){return e&&(e.code||e.status||e.message)&&("string"==typeof e.code||"number"==typeof e.status)}logError(e){let r={...e.context,code:e.code,severity:e.severity,retryable:e.retryable};switch(e.severity){case"critical":case"high":a.logger.error(e.message,e.originalError||e,r);break;case"medium":a.logger.warn(e.message,r);break;case"low":a.logger.info(`Error: ${e.message}`,r)}}createValidationError(e,r){return new i(e,"VALID_2001","low",{field:r,userMessage:e})}createAuthError(e,r){return new i(r||"Erreur d'authentification",e,"high")}createDatabaseError(e,r){return new i(e,"DB_3002","medium",{},r)}createNotFoundError(e,r){return new i(e,"DB_3003","low",r)}};e.s(["AppError",()=>i,"ErrorCode",()=>s,"errorHandler",0,n],779478),e.s([],246704)},627404,e=>{"use strict";e.i(246704);var r=e.i(779478);async function t(e,t,a,s){try{let i=e.from(t).select(s?.select||"*").eq("organization_id",a);s?.filters&&Object.entries(s.filters).forEach(([e,r])=>{null!=r&&(i=i.eq(e,r))}),s?.search&&(i=i.ilike(s.search.field,`%${s.search.value}%`)),i=s?.orderBy?i.order(s.orderBy.column,{ascending:s.orderBy.ascending??!1}):i.order("created_at",{ascending:!1});let{data:n,error:o}=await i;if(o)throw r.errorHandler.handleError(o,{organizationId:a,operation:"getAllByOrganization",table:t});return n||[]}catch(e){if(e instanceof r.AppError)throw e;throw r.errorHandler.handleError(e,{organizationId:a,operation:"getAllByOrganization",table:t})}}async function a(e,t,a,s){try{let{data:i,error:n}=await e.from(t).select(s||"*").eq("id",a).single();if(n){if("PGRST116"===n.code||"42P01"===n.code)throw r.errorHandler.handleError(n,{code:r.ErrorCode.DB_NOT_FOUND,operation:"getById",id:a,table:t});throw r.errorHandler.handleError(n,{operation:"getById",id:a,table:t})}if(!i)throw r.errorHandler.createDatabaseError(`Enregistrement avec l'ID ${a} introuvable dans ${t}`,{id:a,table:t});return i}catch(e){if(e instanceof r.AppError)throw e;throw r.errorHandler.handleError(e,{operation:"getById",id:a,table:t})}}e.s(["getAllByOrganization",()=>t,"getById",()=>a])},34458,e=>{"use strict";e.i(246704);var r=e.i(779478);function t(e,t){for(let a of t)if(!e[a])throw r.errorHandler.createValidationError(`Le champ ${String(a)} est obligatoire`,String(a))}e.s(["validateRequired",()=>t])},163454,e=>{"use strict";var r=e.i(920755);e.i(246704);var t=e.i(779478),a=e.i(790224),s=e.i(627404);async function i(e,r,a,s){try{let i=s.year||new Date().getFullYear().toString().slice(-2),n=s.padding||6,o=s.fieldName||"number",d=`${s.prefix}-${s.orgCode}-${i}-%`,{data:l,error:c}=await e.from(r).select(o).eq("organization_id",a).like(o,d).order(o,{ascending:!1}).limit(1).maybeSingle();if(c&&"PGRST116"!==c.code&&"42P01"!==c.code)throw t.errorHandler.handleError(c,{operation:"generateUniqueNumber",table:r,organizationId:a});let u=1;if(l&&l[o]){let e=String(l[o]).split("-");u=parseInt(e[e.length-1]||"0",10)+1}return`${s.prefix}-${s.orgCode}-${i}-${String(u).padStart(n,"0")}`}catch(e){throw t.errorHandler.handleError(e,{operation:"generateUniqueNumber",table:r,organizationId:a})}}var n=e.i(34458);let o=new class{supabase;constructor(e){this.supabase=e||(0,r.createClient)()}async getAll(e,r){try{let a=r?.page||1,s=r?.limit||50,i=(a-1)*s;if(r?.search){let n=this.supabase.from("students").select("*, classes(id, name, level)",{count:"exact"}).eq("organization_id",e).or(`first_name.ilike.%${r.search}%,last_name.ilike.%${r.search}%,student_number.ilike.%${r.search}%`);r?.classId&&(n=n.eq("class_id",r.classId)),r?.status&&(n=n.eq("status",r.status));let{data:o,error:d,count:l}=await n.order("last_name",{ascending:!0}).range(i,i+s-1);if(d)throw t.errorHandler.handleError(d,{organizationId:e,operation:"getAll",filters:r});return{data:o||[],total:l||0,page:a,limit:s,totalPages:Math.ceil((l||0)/s)}}let n=this.supabase.from("students").select("*, classes(id, name, level)",{count:"exact"}).eq("organization_id",e);r?.classId&&(n=n.eq("class_id",r.classId)),r?.status&&(n=n.eq("status",r.status));let{data:o,error:d,count:l}=await n.order("last_name",{ascending:!0}).range(i,i+s-1);if(d)throw t.errorHandler.handleError(d,{organizationId:e,operation:"getAll",filters:r});return{data:o||[],total:l||0,page:a,limit:s,totalPages:Math.ceil((l||0)/s)}}catch(r){if(r instanceof t.AppError)throw r;throw t.errorHandler.handleError(r,{organizationId:e,operation:"getAll"})}}async getById(e){try{return(0,s.getById)(this.supabase,"students",e,"*, classes(id, name, level)")}catch(r){if(r instanceof t.AppError)throw r;throw t.errorHandler.handleError(r,{operation:"getById",id:e})}}async getByNumber(e,r){try{let{data:a,error:s}=await this.supabase.from("students").select("*").eq("organization_id",e).eq("student_number",r).single();if(s){if("PGRST116"===s.code||"42P01"===s.code)throw t.errorHandler.handleError(s,{code:t.ErrorCode.DB_NOT_FOUND,operation:"getByNumber",organizationId:e,studentNumber:r});throw t.errorHandler.handleError(s,{operation:"getByNumber",organizationId:e,studentNumber:r})}return a}catch(a){if(a instanceof t.AppError)throw a;throw t.errorHandler.handleError(a,{operation:"getByNumber",organizationId:e,studentNumber:r})}}async create(e){try{(0,n.validateRequired)(e,["first_name","last_name","organization_id"]);let r=e.student_number;if(!r||""===r.trim()){let t=e.organization_id;if(!t)throw Error("organization_id is required");let{data:a}=await this.supabase.from("organizations").select("code").eq("id",t).single(),s=a?.code||"ORG",n=new Date().getFullYear().toString().slice(-2);r=await i(this.supabase,"students",t,{prefix:"EDU",orgCode:s,year:n,padding:6,fieldName:"student_number"})}let s={...e,student_number:r},{data:o,error:d}=await this.supabase.from("students").insert(s).select().single();if(d){if("23505"===d.code)throw t.errorHandler.handleError(d,{code:t.ErrorCode.VALIDATION_UNIQUE_CONSTRAINT,operation:"create",field:"student_number"});if("42501"===d.code)throw t.errorHandler.handleError(d,{code:t.ErrorCode.DB_RLS_POLICY_VIOLATION,operation:"create"});throw t.errorHandler.handleError(d,{operation:"create",student:e})}return a.logger.info("Étudiant créé avec succès",{id:o?.id,organizationId:e.organization_id||void 0,studentNumber:o?.student_number}),o}catch(r){if(r instanceof t.AppError)throw r;throw t.errorHandler.handleError(r,{operation:"create",student:e})}}async update(e,r){try{let s={...r};if("class_id"in s)if(""!==s.class_id&&s.class_id){let{data:e,error:r}=await this.supabase.from("classes").select("id").eq("id",s.class_id).maybeSingle();e||r||(s.class_id=null)}else s.class_id=null;let{data:i,error:n}=await this.supabase.from("students").update(s).eq("id",e).select().single();if(n){if("PGRST116"===n.code||"42P01"===n.code)throw t.errorHandler.handleError(n,{code:t.ErrorCode.DB_NOT_FOUND,operation:"update",id:e});if("42501"===n.code)throw t.errorHandler.handleError(n,{code:t.ErrorCode.DB_RLS_POLICY_VIOLATION,operation:"update",id:e});throw t.errorHandler.handleError(n,{operation:"update",id:e,updates:r})}if(!i)throw t.errorHandler.createDatabaseError(`\xc9tudiant avec l'ID ${e} introuvable pour la mise \xe0 jour`,{id:e});return a.logger.info("Étudiant mis à jour avec succès",{id:e,updates:r}),i}catch(a){if(a instanceof t.AppError)throw a;throw t.errorHandler.handleError(a,{operation:"update",id:e,updates:r})}}async delete(e){return this.update(e,{status:"inactive"})}async import(e,r){try{if(!r||0===r.length)throw t.errorHandler.createValidationError("Aucun étudiant à importer","students");let{data:s}=await this.supabase.from("organizations").select("code").eq("id",e).single(),n=s?.code||"ORG",o=new Date().getFullYear().toString().slice(-2),d=await Promise.all(r.map(async r=>{if(r.student_number&&""!==r.student_number.trim())return r;let t=await i(this.supabase,"students",e,{prefix:"EDU",orgCode:n,year:o,padding:6,fieldName:"student_number"});return{...r,student_number:t}})),{data:l,error:c}=await this.supabase.from("students").insert(d).select();if(c){if("23505"===c.code)throw t.errorHandler.handleError(c,{code:t.ErrorCode.VALIDATION_UNIQUE_CONSTRAINT,operation:"import",field:"student_number"});throw t.errorHandler.handleError(c,{operation:"import",organizationId:e,count:r.length})}return a.logger.info("Étudiants importés avec succès",{organizationId:e,count:l?.length||0}),l||[]}catch(r){if(r instanceof t.AppError)throw r;throw t.errorHandler.handleError(r,{operation:"import",organizationId:e})}}};e.s(["studentService",0,o],163454)},631259,e=>{"use strict";var r=e.i(920755);e.i(246704);var t=e.i(779478),a=e.i(790224),s=e.i(627404),i=e.i(34458);let n=new class{supabase;constructor(e){this.supabase=e||(0,r.createClient)()}async getAll(e,r){try{let t={};return r?.studentId&&(t.student_id=r.studentId),r?.status&&(t.status=r.status),r?.documentType&&(t.document_type=r.documentType),(0,s.getAllByOrganization)(this.supabase,"invoices",e,{select:"*, students(id, first_name, last_name, student_number), payments(id, amount, status, paid_at)",filters:t,search:r?.search?{field:"invoice_number",value:r.search}:void 0,orderBy:{column:"issue_date",ascending:!1}})}catch(r){if(r instanceof t.AppError)throw r;throw t.errorHandler.handleError(r,{organizationId:e,operation:"getAll"})}}async getById(e){try{return(0,s.getById)(this.supabase,"invoices",e,"*, students(*), enrollments(*), payments(*)")}catch(r){if(r instanceof t.AppError)throw r;throw t.errorHandler.handleError(r,{operation:"getById",id:e})}}async generateInvoiceNumber(e,r="invoice"){let t=new Date().getFullYear().toString(),{data:a}=await this.supabase.from("invoices").select("invoice_number").eq("organization_id",e).eq("document_type",r).like("invoice_number",`${t}-%`).order("invoice_number",{ascending:!1}).limit(1).maybeSingle(),s=1;if(a?.invoice_number){let e=a.invoice_number.split("-");e.length>=2&&e[0]===t&&(s=parseInt(e[1]||"0",10)+1)}return`${t}-${String(s).padStart(3,"0")}`}async create(e){try{(0,i.validateRequired)(e,["organization_id","student_id"]);let r=e.invoice_number;if(!r||""===r.trim()){let a=e.organization_id;if(!a)throw t.errorHandler.createValidationError("Organization ID is required to create an invoice.");r=await this.generateInvoiceNumber(a,e.document_type||"invoice")}let{data:s,error:n}=await this.supabase.from("invoices").insert({...e,invoice_number:r}).select().single();if(n){if("23505"===n.code)throw t.errorHandler.handleError(n,{code:t.ErrorCode.VALIDATION_UNIQUE_CONSTRAINT,operation:"create",field:"invoice_number"});if("42501"===n.code)throw t.errorHandler.handleError(n,{code:t.ErrorCode.DB_RLS_POLICY_VIOLATION,operation:"create"});throw t.errorHandler.handleError(n,{operation:"create",invoice:e})}return a.logger.info("Facture créée avec succès",{id:s?.id,organizationId:e.organization_id||void 0,invoiceNumber:s?.invoice_number}),s}catch(r){if(r instanceof t.AppError)throw r;throw t.errorHandler.handleError(r,{operation:"create",invoice:e})}}async update(e,r){try{let{data:s,error:i}=await this.supabase.from("invoices").update(r).eq("id",e).select().single();if(i){if("PGRST116"===i.code||"42P01"===i.code)throw t.errorHandler.handleError(i,{code:t.ErrorCode.DB_NOT_FOUND,operation:"update",id:e});if("42501"===i.code)throw t.errorHandler.handleError(i,{code:t.ErrorCode.DB_RLS_POLICY_VIOLATION,operation:"update",id:e});throw t.errorHandler.handleError(i,{operation:"update",id:e,updates:r})}if(!s)throw t.errorHandler.createDatabaseError(`Facture avec l'ID ${e} introuvable pour la mise \xe0 jour`,{id:e});return a.logger.info("Facture mise à jour avec succès",{id:e,updates:r}),s}catch(a){if(a instanceof t.AppError)throw a;throw t.errorHandler.handleError(a,{operation:"update",id:e,updates:r})}}async generateForClass(e,r,s,i,n,o="tuition"){let{data:d,error:l}=await this.supabase.from("students").select("id").eq("organization_id",e).eq("class_id",r).eq("status","active");if(l)throw t.errorHandler.handleError(l,{operation:"generateForClass",organizationId:e,classId:r,step:"fetchStudents"});if(!d||0===d.length)throw t.errorHandler.createValidationError("Aucun élève actif dans cette classe","classId");let{data:c}=await this.supabase.from("organizations").select("code").eq("id",e).single(),u=c?.code||"ORG",m=new Date().getFullYear().toString().slice(-2),{data:h}=await this.supabase.from("invoices").select("invoice_number").eq("organization_id",e).like("invoice_number",`FAC-${u}-${m}-%`).order("invoice_number",{ascending:!1}).limit(1).maybeSingle(),p=1;if(h?.invoice_number){let e=h.invoice_number.split("-");p=parseInt(e[e.length-1]||"0")+1}let g=d.map((r,t)=>({organization_id:e,student_id:r.id,invoice_number:`FAC-${u}-${m}-${String(p+t).padStart(6,"0")}`,type:o,document_type:"invoice",issue_date:new Date().toISOString().split("T")[0],due_date:n,amount:s,tax_amount:0,total_amount:s,currency:i,status:"draft",items:[]})),{data:f,error:_}=await this.supabase.from("invoices").insert(g).select();if(_)throw t.errorHandler.handleError(_,{operation:"generateForClass",organizationId:e,classId:r,count:g.length});return a.logger.info("Factures générées en masse avec succès",{organizationId:e,classId:r,count:f?.length||0}),f||[]}async getOverdue(e){let r=new Date().toISOString().split("T")[0];try{let{data:a,error:s}=await this.supabase.from("invoices").select("*, students(id, first_name, last_name, student_number)").eq("organization_id",e).eq("document_type","invoice").in("status",["sent","partial"]).lt("due_date",r).order("due_date",{ascending:!0});if(s)throw t.errorHandler.handleError(s,{operation:"getOverdue",organizationId:e});return a||[]}catch(r){if(r instanceof t.AppError)throw r;throw t.errorHandler.handleError(r,{operation:"getOverdue",organizationId:e})}}async convertQuoteToInvoice(e){try{let{data:r,error:s}=await this.supabase.from("invoices").select("*").eq("id",e).eq("document_type","quote").single();if(s){if("PGRST116"===s.code||"42P01"===s.code)throw t.errorHandler.handleError(s,{code:t.ErrorCode.DB_NOT_FOUND,operation:"convertQuoteToInvoice",quoteId:e});throw t.errorHandler.handleError(s,{operation:"convertQuoteToInvoice",quoteId:e,step:"fetchQuote"})}if(!r)throw t.errorHandler.createDatabaseError(`Devis avec l'ID ${e} introuvable`,{quoteId:e});let{data:i,error:n}=await this.supabase.from("invoices").update({document_type:"invoice",status:"draft",issue_date:r.issue_date||new Date().toISOString().split("T")[0]}).eq("id",e).select().single();if(n)throw t.errorHandler.handleError(n,{operation:"convertQuoteToInvoice",quoteId:e,step:"updateInvoice"});return a.logger.info("Devis converti en facture avec succès",{quoteId:e,invoiceId:i?.id}),i}catch(r){if(r instanceof t.AppError)throw r;throw t.errorHandler.handleError(r,{operation:"convertQuoteToInvoice",quoteId:e})}}};e.s(["invoiceService",0,n])},548347,e=>{"use strict";var r=e.i(920755);e.i(246704);var t=e.i(779478),a=e.i(790224),s=e.i(627404);let i=new class{supabase;constructor(e){this.supabase=e||(0,r.createClient)()}async getAll(e,r){try{let i={};r?.invoiceId&&(i.invoice_id=r.invoiceId),r?.studentId&&(i.student_id=r.studentId),r?.status&&(i.status=r.status);try{return await (0,s.getAllByOrganization)(this.supabase,"payments",e,{select:"*, invoices(*), students(id, first_name, last_name, student_number)",filters:i,orderBy:{column:"created_at",ascending:!1}})}catch(i){let r=i?.code||i?.originalError?.code,s=i?.message||String(i);if("PGRST116"===r||"42P01"===r||"PGRST200"===r||"PGRST301"===r||"400"===r||s?.includes("relation")||s?.includes("relationship")||s?.includes("does not exist")||s?.includes("schema cache"))return a.logger.warn("Payments table or relations not available, returning empty array",{organizationId:e,errorCode:r,errorMessage:s}),[];if(i instanceof t.AppError){let r=i.originalError;if(r){let t=r.code,s=r.message||"";if("PGRST116"===t||"42P01"===t||"PGRST200"===t||"PGRST301"===t||"400"===t||s.includes("relation")||s.includes("relationship")||s.includes("does not exist")||s.includes("schema cache"))return a.logger.warn("Payments table or relations not available (from AppError.originalError), returning empty array",{organizationId:e,errorCode:t,errorMessage:s}),[]}let t=i.context?.code;if("PGRST116"===t||"42P01"===t||"PGRST200"===t||"PGRST301"===t||"400"===t)return a.logger.warn("Payments table or relations not available (from AppError.context), returning empty array",{organizationId:e,errorCode:t}),[]}throw i}}catch(r){if(r instanceof t.AppError)throw r;throw t.errorHandler.handleError(r,{organizationId:e,operation:"getAll"})}}async getById(e){try{return(0,s.getById)(this.supabase,"payments",e,"*, invoices(*), students(*)")}catch(r){if(r instanceof t.AppError)throw r;throw t.errorHandler.handleError(r,{operation:"getById",id:e})}}async create(e){try{if(!e.amount||0>=Number(e.amount))throw t.errorHandler.createValidationError("Le montant doit être supérieur à 0","amount");if(!e.organization_id)throw t.errorHandler.createValidationError("L'organisation est obligatoire","organization_id");let{data:r,error:s}=await this.supabase.from("payments").insert(e).select().single();if(s){if("23505"===s.code)throw t.errorHandler.handleError(s,{code:t.ErrorCode.VALIDATION_UNIQUE_CONSTRAINT,operation:"create",field:"transaction_id"});if("42501"===s.code)throw t.errorHandler.handleError(s,{code:t.ErrorCode.DB_RLS_POLICY_VIOLATION,operation:"create"});throw t.errorHandler.handleError(s,{operation:"create",payment:e})}return e.invoice_id&&await this.updateInvoicePaymentStatus(e.invoice_id),a.logger.info("Paiement créé avec succès",{id:r?.id,organizationId:e.organization_id,amount:e.amount}),r}catch(r){if(r instanceof t.AppError)throw r;throw t.errorHandler.handleError(r,{operation:"create",payment:e})}}async update(e,r){try{let{data:s,error:i}=await this.supabase.from("payments").update(r).eq("id",e).select().single();if(i){if("PGRST116"===i.code||"42P01"===i.code)throw t.errorHandler.handleError(i,{code:t.ErrorCode.DB_NOT_FOUND,operation:"update",id:e});if("42501"===i.code)throw t.errorHandler.handleError(i,{code:t.ErrorCode.DB_RLS_POLICY_VIOLATION,operation:"update",id:e});throw t.errorHandler.handleError(i,{operation:"update",id:e,updates:r})}if(!s)throw t.errorHandler.createDatabaseError(`Paiement avec l'ID ${e} introuvable pour la mise \xe0 jour`,{id:e});if("completed"===r.status||"failed"===r.status){let r=await this.getById(e);if(r&&"object"==typeof r&&"invoice_id"in r){let e=r.invoice_id;e&&await this.updateInvoicePaymentStatus(e)}}return a.logger.info("Paiement mis à jour avec succès",{id:e,updates:r}),s}catch(a){if(a instanceof t.AppError)throw a;throw t.errorHandler.handleError(a,{operation:"update",id:e,updates:r})}}async updateInvoicePaymentStatus(e){try{let{data:r,error:a}=await this.supabase.from("payments").select("amount").eq("invoice_id",e).eq("status","completed");if(a)throw t.errorHandler.handleError(a,{operation:"updateInvoicePaymentStatus",invoiceId:e,step:"fetchPayments"});let s=r?.reduce((e,r)=>e+Number(r.amount),0)||0,{data:i,error:n}=await this.supabase.from("invoices").select("total_amount").eq("id",e).single();if(n)throw t.errorHandler.handleError(n,{operation:"updateInvoicePaymentStatus",invoiceId:e,step:"fetchInvoice"});if(!i)throw t.errorHandler.createDatabaseError(`Facture avec l'ID ${e} introuvable`,{invoiceId:e});let o="sent";s>=Number(i.total_amount)?o="paid":s>0&&(o="partial");let{data:d}=await this.supabase.from("invoices").select("due_date").eq("id",e).single();if(d){let e=new Date;new Date(d.due_date)<e&&"paid"!==o&&(o="overdue")}let{error:l}=await this.supabase.from("invoices").update({status:o}).eq("id",e);if(l)throw t.errorHandler.handleError(l,{operation:"updateInvoicePaymentStatus",invoiceId:e,step:"updateInvoice"})}catch(r){if(r instanceof t.AppError)throw r;throw t.errorHandler.handleError(r,{operation:"updateInvoicePaymentStatus",invoiceId:e})}}async recordMobileMoneyPayment(e,r,a,s,i,n){try{if(!i)throw t.errorHandler.createValidationError("L'ID de transaction est obligatoire","transactionId");let{data:o,error:d}=await this.supabase.from("invoices").select("organization_id, student_id").eq("id",e).single();if(d){if("PGRST116"===d.code||"42P01"===d.code)throw t.errorHandler.handleError(d,{code:t.ErrorCode.DB_NOT_FOUND,operation:"recordMobileMoneyPayment",invoiceId:e});throw t.errorHandler.handleError(d,{operation:"recordMobileMoneyPayment",invoiceId:e})}if(!o)throw t.errorHandler.createDatabaseError(`Facture avec l'ID ${e} introuvable`,{invoiceId:e});return this.create({organization_id:o.organization_id,invoice_id:e,student_id:o.student_id,amount:r,currency:a,payment_method:"mobile_money",payment_provider:s,transaction_id:i,status:"pending",metadata:{phone_number:n}})}catch(r){if(r instanceof t.AppError)throw r;throw t.errorHandler.handleError(r,{operation:"recordMobileMoneyPayment",invoiceId:e,provider:s})}}};e.s(["paymentService",0,i])},131401,e=>{"use strict";var r=e.i(843476),t=e.i(266027),a=e.i(618566),s=e.i(920755),i=e.i(163454),n=e.i(631259),o=e.i(548347),d=e.i(167881),l=e.i(970065),c=e.i(63270),u=e.i(871689),m=e.i(436332),h=e.i(263488),p=e.i(238491),g=e.i(346897),f=e.i(87316),_=e.i(761911),x=e.i(178583),y=e.i(212426),E=e.i(221345),v=e.i(643531),b=e.i(522016),w=e.i(647163),N=e.i(271645),I=e.i(6799);function A(){let e=(0,a.useParams)();(0,a.useRouter)();let A=e.id,j=(0,s.createClient)(),{addToast:T}=(0,I.useToast)(),[D,S]=(0,N.useState)(!1),{data:H,isLoading:C}=(0,t.useQuery)({queryKey:["student",A],queryFn:()=>i.studentService.getById(A)}),{data:O}=(0,t.useQuery)({queryKey:["student-guardians",A],queryFn:async()=>{let{data:e,error:r}=await j.from("student_guardians").select("*, guardians(*)").eq("student_id",A);if(r)throw r;return e?.map(e=>e.guardians).filter(Boolean)||[]},enabled:!!A}),{data:R}=(0,t.useQuery)({queryKey:["session",H?.class_id],queryFn:async()=>{if(!H?.class_id)return null;let{data:e,error:r}=await j.from("sessions").select("*, formations(*, programs(*))").eq("id",H.class_id).single();if(r)throw r;return e},enabled:!!H?.class_id}),{data:B}=(0,t.useQuery)({queryKey:["student-invoices",A],queryFn:async()=>H?.organization_id?n.invoiceService.getAll(H.organization_id,{studentId:A}):[],enabled:!!H?.organization_id&&!!A}),{data:P}=(0,t.useQuery)({queryKey:["student-payments",A],queryFn:async()=>H?.organization_id?o.paymentService.getAll(H.organization_id,{studentId:A}):[],enabled:!!H?.organization_id&&!!A});return C?(0,r.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,r.jsx)("div",{className:"text-center",children:(0,r.jsx)("div",{className:"text-muted-foreground",children:"Chargement..."})})}):H?(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,r.jsx)(b.default,{href:"/dashboard/students",children:(0,r.jsx)(d.Button,{variant:"ghost",size:"icon",children:(0,r.jsx)(u.ArrowLeft,{className:"h-4 w-4"})})}),(0,r.jsxs)("div",{children:[(0,r.jsxs)("h1",{className:"text-3xl font-bold text-gray-900",children:[H.first_name," ",H.last_name]}),(0,r.jsx)("p",{className:"mt-2 text-sm text-gray-600",children:H.student_number})]})]}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(d.Button,{variant:"outline",onClick:()=>{let e=`${window.location.origin}/learner/access/${A}`;navigator.clipboard.writeText(e).then(()=>{S(!0),T({title:"Lien copié",description:"Le lien d'accès a été copié dans le presse-papiers",type:"success"}),setTimeout(()=>S(!1),2e3)}).catch(()=>{T({title:"Erreur",description:"Impossible de copier le lien",type:"error"})})},children:D?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(v.Check,{className:"mr-2 h-4 w-4"}),"Lien copié"]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(E.Link,{className:"mr-2 h-4 w-4"}),"Copier le lien d'accès"]})}),(0,r.jsx)(b.default,{href:`/dashboard/students/${A}/edit`,children:(0,r.jsxs)(d.Button,{children:[(0,r.jsx)(m.Edit,{className:"mr-2 h-4 w-4"}),"Modifier"]})})]})]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[(0,r.jsxs)("div",{className:"lg:col-span-2 space-y-6",children:[(0,r.jsxs)(l.Card,{children:[(0,r.jsx)(l.CardHeader,{children:(0,r.jsx)(l.CardTitle,{children:"Informations personnelles"})}),(0,r.jsxs)(l.CardContent,{className:"space-y-4",children:[(0,r.jsxs)("div",{className:"flex items-center space-x-4",children:[H.photo_url?(0,r.jsx)(c.Avatar,{src:H.photo_url,alt:`${H.first_name} ${H.last_name}`,fallback:`${H.first_name||""} ${H.last_name||""}`,userId:H.id,size:"xl",variant:"auto",className:"shadow-xl"}):(0,r.jsx)(c.Avatar,{fallback:`${H.first_name||""} ${H.last_name||""}`,userId:H.id,size:"xl",variant:"auto",className:"shadow-xl"}),(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"text-sm text-muted-foreground",children:"Statut"}),(0,r.jsx)("p",{className:"font-medium",children:(0,r.jsx)("span",{className:`px-2 py-1 rounded text-xs ${"active"===H.status?"bg-brand-blue-ghost text-brand-blue":"inactive"===H.status?"bg-gray-100 text-gray-800":"bg-red-100 text-red-800"}`,children:"active"===H.status?"Actif":"inactive"===H.status?"Inactif":H.status})})]})]}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[H.date_of_birth&&(0,r.jsxs)("div",{children:[(0,r.jsxs)("p",{className:"text-sm text-muted-foreground flex items-center",children:[(0,r.jsx)(f.Calendar,{className:"mr-2 h-4 w-4"}),"Date de naissance"]}),(0,r.jsx)("p",{className:"font-medium",children:(0,w.formatDate)(H.date_of_birth)})]}),H.gender&&(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"text-sm text-muted-foreground",children:"Genre"}),(0,r.jsx)("p",{className:"font-medium",children:"male"===H.gender?"Masculin":"female"===H.gender?"Féminin":H.gender})]})]}),H.email&&(0,r.jsxs)("div",{children:[(0,r.jsxs)("p",{className:"text-sm text-muted-foreground flex items-center",children:[(0,r.jsx)(h.Mail,{className:"mr-2 h-4 w-4"}),"Email"]}),(0,r.jsx)("p",{className:"font-medium",children:H.email})]}),H.phone&&(0,r.jsxs)("div",{children:[(0,r.jsxs)("p",{className:"text-sm text-muted-foreground flex items-center",children:[(0,r.jsx)(p.Phone,{className:"mr-2 h-4 w-4"}),"Téléphone"]}),(0,r.jsx)("p",{className:"font-medium",children:H.phone})]}),H.address&&(0,r.jsxs)("div",{children:[(0,r.jsxs)("p",{className:"text-sm text-muted-foreground flex items-center",children:[(0,r.jsx)(g.MapPin,{className:"mr-2 h-4 w-4"}),"Adresse"]}),(0,r.jsxs)("p",{className:"font-medium",children:[H.address,H.city&&`, ${H.city}`]})]}),(0,r.jsxs)("div",{children:[(0,r.jsxs)("p",{className:"text-sm text-muted-foreground flex items-center",children:[(0,r.jsx)(f.Calendar,{className:"mr-2 h-4 w-4"}),"Date d'inscription"]}),(0,r.jsx)("p",{className:"font-medium",children:(0,w.formatDate)(H.enrollment_date||"")})]})]})]}),(0,r.jsxs)(l.Card,{children:[(0,r.jsx)(l.CardHeader,{children:(0,r.jsx)(l.CardTitle,{children:"Informations académiques"})}),(0,r.jsx)(l.CardContent,{children:R?(0,r.jsxs)("div",{children:[(0,r.jsxs)("p",{className:"text-sm text-muted-foreground flex items-center",children:[(0,r.jsx)(_.Users,{className:"mr-2 h-4 w-4"}),"Session"]}),(0,r.jsxs)("p",{className:"font-medium text-lg",children:[R.name," - ",R.formations?.name||"",R.formations?.programs&&` (${R.formations.programs.name})`]})]}):(0,r.jsx)("p",{className:"text-muted-foreground",children:"Aucune session assignée"})})]}),(0,r.jsxs)(l.Card,{children:[(0,r.jsxs)(l.CardHeader,{className:"flex flex-row items-center justify-between",children:[(0,r.jsxs)(l.CardTitle,{className:"flex items-center",children:[(0,r.jsx)(x.FileText,{className:"mr-2 h-5 w-5"}),"Devis et Factures"]}),(0,r.jsx)(b.default,{href:"/dashboard/payments/new",children:(0,r.jsx)(d.Button,{size:"sm",variant:"outline",children:"Nouveau devis / facture"})})]}),(0,r.jsx)(l.CardContent,{children:B&&B.length>0?(0,r.jsxs)("div",{className:"space-y-3",children:[B.slice(0,5).map(e=>(0,r.jsxs)("div",{className:"flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50 transition-colors",children:[(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,r.jsx)("h4",{className:"font-semibold",children:e.invoice_number}),(0,r.jsx)("span",{className:`px-2 py-0.5 rounded text-xs ${"quote"===e.document_type?"bg-blue-100 text-blue-800":"bg-brand-blue-ghost text-brand-blue"}`,children:"quote"===e.document_type?"Devis":"Facture"}),(0,r.jsx)("span",{className:`px-2 py-0.5 rounded text-xs ${"paid"===e.status?"bg-brand-blue-ghost text-brand-blue":"sent"===e.status?"bg-brand-blue-pale text-brand-blue":"partial"===e.status?"bg-brand-cyan-ghost text-brand-cyan":"overdue"===e.status?"bg-red-100 text-red-800":"bg-gray-100 text-gray-800"}`,children:"paid"===e.status?"Payée":"sent"===e.status?"Envoyée":"partial"===e.status?"Partielle":"overdue"===e.status?"En retard":"draft"===e.status?"Brouillon":e.status})]}),(0,r.jsxs)("p",{className:"text-sm text-muted-foreground mt-1",children:["Émission: ",(0,w.formatDate)(e.issue_date)," - Échéance: ",(0,w.formatDate)(e.due_date)]})]}),(0,r.jsxs)("div",{className:"text-right",children:[(0,r.jsx)("p",{className:"font-semibold",children:(0,w.formatCurrency)(Number(e.total_amount),e.currency)}),(0,r.jsx)(b.default,{href:`/dashboard/payments/${e.id}`,children:(0,r.jsx)(d.Button,{variant:"ghost",size:"sm",className:"mt-2",children:"Voir détails"})})]})]},e.id)),B.length>5&&(0,r.jsx)(b.default,{href:"/dashboard/payments",children:(0,r.jsxs)(d.Button,{variant:"outline",className:"w-full mt-2",children:["Voir tous les devis et factures (",B.length,")"]})})]}):(0,r.jsx)("p",{className:"text-muted-foreground",children:"Aucun devis ou facture"})})]}),(0,r.jsxs)(l.Card,{children:[(0,r.jsxs)(l.CardHeader,{className:"flex flex-row items-center justify-between",children:[(0,r.jsxs)(l.CardTitle,{className:"flex items-center",children:[(0,r.jsx)(y.DollarSign,{className:"mr-2 h-5 w-5"}),"Paiements"]}),(0,r.jsx)(b.default,{href:"/dashboard/payments/new",children:(0,r.jsx)(d.Button,{size:"sm",variant:"outline",children:"Nouveau paiement"})})]}),(0,r.jsx)(l.CardContent,{children:P&&P.length>0?(0,r.jsxs)("div",{className:"space-y-3",children:[P.slice(0,5).map(e=>(0,r.jsxs)("div",{className:"flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50 transition-colors",children:[(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsx)("p",{className:"font-semibold",children:(0,w.formatCurrency)(Number(e.amount),e.currency)}),(0,r.jsxs)("p",{className:"text-sm text-muted-foreground mt-1",children:["cash"===e.payment_method?"Espèces":"mobile_money"===e.payment_method?`Mobile Money (${e.payment_provider||"N/A"})`:"card"===e.payment_method?"Carte":"bank_transfer"===e.payment_method?"Virement":e.payment_method," - ",e.paid_at?(0,w.formatDate)(e.paid_at):"N/A"]}),e.invoices&&(0,r.jsxs)("p",{className:"text-xs text-muted-foreground mt-1",children:["Facture: ",e.invoices.invoice_number||"N/A"]})]}),(0,r.jsx)("span",{className:`px-2 py-1 rounded text-xs ${"completed"===e.status?"bg-success-bg text-success-primary":"pending"===e.status?"bg-warning-bg text-warning-primary":"bg-gray-100 text-gray-800"}`,children:"completed"===e.status?"Complété":"pending"===e.status?"En attente":e.status})]},e.id)),P.length>5&&(0,r.jsx)(b.default,{href:"/dashboard/payments",children:(0,r.jsxs)(d.Button,{variant:"outline",className:"w-full mt-2",children:["Voir tous les paiements (",P.length,")"]})})]}):(0,r.jsx)("p",{className:"text-muted-foreground",children:"Aucun paiement enregistré"})})]})]}),(0,r.jsx)("div",{className:"space-y-6",children:(0,r.jsxs)(l.Card,{children:[(0,r.jsx)(l.CardHeader,{children:(0,r.jsx)(l.CardTitle,{children:"Tuteurs / Parents"})}),(0,r.jsx)(l.CardContent,{children:O&&O.length>0?(0,r.jsx)("div",{className:"space-y-4",children:O.map(e=>(0,r.jsxs)("div",{className:"p-4 border rounded-lg",children:[(0,r.jsxs)("p",{className:"font-semibold",children:[e.first_name," ",e.last_name]}),(0,r.jsx)("p",{className:"text-sm text-muted-foreground capitalize",children:e.relationship}),e.phone_primary&&(0,r.jsxs)("p",{className:"text-sm mt-2 flex items-center",children:[(0,r.jsx)(p.Phone,{className:"mr-2 h-4 w-4"}),e.phone_primary]}),e.email&&(0,r.jsxs)("p",{className:"text-sm mt-1 flex items-center",children:[(0,r.jsx)(h.Mail,{className:"mr-2 h-4 w-4"}),e.email]})]},e.id))}):(0,r.jsx)("p",{className:"text-muted-foreground",children:"Aucun tuteur enregistré"})})]})})]})]}):(0,r.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,r.jsxs)("div",{className:"text-center",children:[(0,r.jsx)("div",{className:"text-muted-foreground",children:"Élève non trouvé"}),(0,r.jsx)(b.default,{href:"/dashboard/students",children:(0,r.jsx)(d.Button,{className:"mt-4",children:"Retour à la liste"})})]})})}e.s(["default",()=>A])}]);