(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,440160,e=>{"use strict";let t=(0,e.i(475254).default)("Download",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"7 10 12 15 17 10",key:"2ggqvy"}],["line",{x1:"12",x2:"12",y1:"15",y2:"3",key:"1vk2je"}]]);e.s(["Download",()=>t],440160)},286536,e=>{"use strict";let t=(0,e.i(475254).default)("Eye",[["path",{d:"M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z",key:"rwhkz3"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]]);e.s(["Eye",()=>t],286536)},970519,e=>{"use strict";var t=e.i(843476),r=e.i(266027),s=e.i(325715),n=e.i(920755),a=e.i(970065),o=e.i(167881),i=e.i(178583),l=e.i(440160),d=e.i(286536),c=e.i(87316),u=e.i(647163),m=e.i(271645),g=e.i(790224);function x(){let{user:e}=(0,s.useAuth)(),x=(0,n.createClient)(),[h,f]=(0,m.useState)(null),{data:j,isLoading:p}=(0,r.useQuery)({queryKey:["learner-documents",e?.id],queryFn:async()=>{if(!e?.id)return g.logger.info("Portal Documents - No user ID"),[];g.logger.info("Portal Documents - Fetching documents",{userId:(0,g.maskId)(e.id),role:e.role});let t=[];if(e?.role==="parent"){let{data:r}=await x.from("guardians").select("id").eq("user_id",e.id);if(!r||0===r.length)return g.logger.info("Portal Documents - No guardians found"),[];let{data:s}=await x.from("student_guardians").select("student_id").in("guardian_id",r.map(e=>e.id));if(!s||0===s.length)return g.logger.info("Portal Documents - No student guardians found"),[];t=s.map(e=>e.student_id).filter(e=>null!==e),g.logger.info("Portal Documents - Parent student IDs count",{count:t.length})}else e?.role==="student"&&(t=[e.id],g.logger.info("Portal Documents - Student access"));if(0===t.length)return g.logger.info("Portal Documents - No student IDs"),[];let r=x.from("learner_documents").select("*, students(first_name, last_name, student_number)").order("sent_at",{ascending:!1});e?.role==="parent"&&(r=r.in("student_id",t)),g.logger.info("Portal Documents - Querying learner_documents");let{data:s,error:n}=await r;if(n)throw g.logger.error("Portal Documents - Error fetching documents",n,{error:(0,g.sanitizeError)(n)}),n;return g.logger.info("Portal Documents - Documents found",{count:s?.length||0}),s||[]},enabled:!!e?.id}),w=async e=>{let{error:t}=await x.from("learner_documents").update({viewed_at:new Date().toISOString()}).eq("id",e);t&&g.logger.error("Portal Documents - Error marking as viewed",t,{documentId:(0,g.maskId)(e),error:(0,g.sanitizeError)(t)})},y=async e=>{let{error:t}=await x.from("learner_documents").update({downloaded_at:new Date().toISOString()}).eq("id",e);t&&g.logger.error("Portal Documents - Error marking as downloaded",t,{documentId:(0,g.maskId)(e),error:(0,g.sanitizeError)(t)})},N=async e=>{try{let t=await fetch(e.file_url),r=await t.blob(),s=window.URL.createObjectURL(r),n=document.createElement("a");n.href=s,n.download=e.title||"document.pdf",document.body.appendChild(n),n.click(),document.body.removeChild(n),window.URL.revokeObjectURL(s),await y(e.id)}catch(t){g.logger.error("Portal Documents - Error downloading document",t,{documentId:(0,g.maskId)(e.id),error:(0,g.sanitizeError)(t)}),alert("Erreur lors du téléchargement du document")}},v=async e=>{f(e.file_url),window.open(e.file_url,"_blank"),await w(e.id)};return p?(0,t.jsxs)("div",{className:"space-y-6",children:[(0,t.jsx)("div",{className:"flex items-center justify-between",children:(0,t.jsx)("h1",{className:"text-3xl font-bold",children:"Documents"})}),(0,t.jsx)(a.Card,{children:(0,t.jsx)(a.CardContent,{className:"p-6",children:(0,t.jsx)("p",{className:"text-center text-muted-foreground",children:"Chargement..."})})})]}):(0,t.jsxs)("div",{className:"space-y-6",children:[(0,t.jsx)("div",{className:"flex items-center justify-between",children:(0,t.jsx)("h1",{className:"text-3xl font-bold",children:"Documents"})}),j&&j.length>0?(0,t.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:j.map(e=>{var r;return(0,t.jsxs)(a.Card,{className:"hover:shadow-lg transition-shadow",children:[(0,t.jsx)(a.CardHeader,{children:(0,t.jsxs)("div",{className:"flex items-start justify-between",children:[(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsx)(a.CardTitle,{className:"text-lg mb-2",children:e.title}),(0,t.jsx)("p",{className:"text-sm text-muted-foreground",children:{convention:"Convention de formation",facture:"Facture",devis:"Devis",attestation:"Attestation",certificat:"Certificat",releve_notes:"Relevé de notes",autre:"Autre"}[(r=e.type)||"autre"]||r||"Document"})]}),(0,t.jsx)(i.FileText,{className:"h-5 w-5 text-primary flex-shrink-0 ml-2"})]})}),(0,t.jsx)(a.CardContent,{children:(0,t.jsxs)("div",{className:"space-y-3",children:[e.students&&(0,t.jsxs)("div",{className:"text-sm",children:[(0,t.jsx)("p",{className:"text-muted-foreground",children:"Apprenant"}),(0,t.jsxs)("p",{className:"font-medium",children:[e.students.first_name," ",e.students.last_name]})]}),(0,t.jsxs)("div",{className:"flex items-center text-sm text-muted-foreground",children:[(0,t.jsx)(c.Calendar,{className:"h-4 w-4 mr-2"}),(0,u.formatDate)(e.sent_at)]}),(0,t.jsxs)("div",{className:"flex gap-2 pt-2",children:[(0,t.jsxs)(o.Button,{variant:"outline",size:"sm",onClick:()=>v(e),className:"flex-1",children:[(0,t.jsx)(d.Eye,{className:"h-4 w-4 mr-2"}),"Voir"]}),(0,t.jsxs)(o.Button,{variant:"default",size:"sm",onClick:()=>N(e),className:"flex-1",children:[(0,t.jsx)(l.Download,{className:"h-4 w-4 mr-2"}),"Télécharger"]})]}),e.description&&(0,t.jsx)("p",{className:"text-sm text-muted-foreground mt-2",children:e.description})]})})]},e.id)})}):(0,t.jsx)(a.Card,{children:(0,t.jsxs)(a.CardContent,{className:"p-12 text-center",children:[(0,t.jsx)(i.FileText,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),(0,t.jsx)("h3",{className:"text-lg font-semibold mb-2",children:"Aucun document"}),(0,t.jsx)("p",{className:"text-muted-foreground",children:"Vous n'avez pas encore de documents disponibles."})]})})]})}e.s(["default",()=>x])}]);