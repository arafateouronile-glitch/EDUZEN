(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,871689,e=>{"use strict";let t=(0,e.i(475254).default)("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]]);e.s(["ArrowLeft",()=>t],871689)},503116,e=>{"use strict";let t=(0,e.i(475254).default)("Clock",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["polyline",{points:"12 6 12 12 16 14",key:"68esgv"}]]);e.s(["Clock",()=>t],503116)},605631,e=>{"use strict";let t=(0,e.i(475254).default)("CheckCircle",[["path",{d:"M22 11.08V12a10 10 0 1 1-5.93-9.14",key:"g774vq"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]]);e.s(["CheckCircle",()=>t],605631)},738308,e=>{"use strict";let t=(0,e.i(475254).default)("XCircle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]]);e.s(["XCircle",()=>t],738308)},870273,e=>{"use strict";let t=(0,e.i(475254).default)("Star",[["polygon",{points:"12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2",key:"8f66p6"}]]);e.s(["Star",()=>t],870273)},514764,e=>{"use strict";let t=(0,e.i(475254).default)("Send",[["path",{d:"m22 2-7 20-4-9-9-4Z",key:"1q3vgg"}],["path",{d:"M22 2 11 13",key:"nzbqef"}]]);e.s(["Send",()=>t],514764)},562369,e=>{"use strict";var t=e.i(920755);let s=new class{supabase;constructor(e){this.supabase=e||(0,t.createClient)()}async getCategories(e){let{data:t,error:s}=await this.supabase.from("support_categories").select("*").eq("organization_id",e).eq("is_active",!0).order("order_index",{ascending:!0});if(s){if("PGRST116"===s.code||"42P01"===s.code||"PGRST301"===s.code||404===s.status||"404"===s.code||s.message?.includes("relation")||s.message?.includes("relationship")||s.message?.includes("does not exist")||s.message?.includes("schema cache"))return console.warn("Table support_categories does not exist yet or invalid query:",s?.message),[];throw s}return t||[]}async createCategory(e){let{data:t,error:s}=await this.supabase.from("support_categories").insert(e).select().single();if(s)throw s;return t}async updateCategory(e,t){let{data:s,error:r}=await this.supabase.from("support_categories").update(t).eq("id",e).select().single();if(r)throw r;return s}async deleteCategory(e){let{error:t}=await this.supabase.from("support_categories").delete().eq("id",e);if(t)throw t}async getTickets(e,t){let s=this.supabase.from("support_tickets").select(`
        *,
        user:users(id, full_name, email),
        assigned_user:users!support_tickets_assigned_to_fkey(id, full_name, email),
        category:support_categories(*)
      `).eq("organization_id",e);t?.userId&&(s=s.eq("user_id",t.userId)),t?.status&&(s=s.eq("status",t.status)),t?.priority&&(s=s.eq("priority",t.priority)),t?.categoryId&&(s=s.eq("category_id",t.categoryId)),t?.assignedTo&&(s=s.eq("assigned_to",t.assignedTo));let{data:r,error:a}=await s.order("created_at",{ascending:!1});if(a){if("PGRST116"===a.code||"42P01"===a.code||"PGRST301"===a.code||404===a.status||400===a.status||"404"===a.code||"400"===a.code||a.message?.includes("relation")||a.message?.includes("relationship")||a.message?.includes("does not exist")||a.message?.includes("schema cache")||a.message?.includes("Could not find a relationship"))return[];throw a}return r||[]}async getTicketById(e){let{data:t,error:s}=await this.supabase.from("support_tickets").select(`
        *,
        user:users(id, full_name, email),
        assigned_user:users!support_tickets_assigned_to_fkey(id, full_name, email),
        category:support_categories(*)
      `).eq("id",e).single();if(s)throw s;return t}async createTicket(e){let{data:t,error:s}=await this.supabase.from("support_tickets").insert(e).select().single();if(s)throw s;return t}async updateTicket(e,t){let{data:s,error:r}=await this.supabase.from("support_tickets").update(t).eq("id",e).select().single();if(r)throw r;return s}async assignTicket(e,t){return this.updateTicket(e,{assigned_to:t,assigned_at:new Date().toISOString(),status:"in_progress"})}async resolveTicket(e){return this.updateTicket(e,{status:"resolved",resolved_at:new Date().toISOString()})}async closeTicket(e){return this.updateTicket(e,{status:"closed",closed_at:new Date().toISOString()})}async getTicketMessages(e){let{data:t,error:s}=await this.supabase.from("support_ticket_messages").select(`
        *,
        user:users(id, full_name, email)
      `).eq("ticket_id",e).order("created_at",{ascending:!0});if(s)throw s;return t}async createMessage(e){let{data:t,error:s}=await this.supabase.from("support_ticket_messages").insert(e).select(`
        *,
        user:users(id, full_name, email)
      `).single();if(s)throw s;return t}async markMessageAsRead(e){let{data:t,error:s}=await this.supabase.from("support_ticket_messages").update({is_read:!0,read_at:new Date().toISOString()}).eq("id",e).select().single();if(s)throw s;return t}async getTicketNotes(e){let{data:t,error:s}=await this.supabase.from("support_ticket_notes").select(`
        *,
        user:users(id, full_name, email)
      `).eq("ticket_id",e).order("created_at",{ascending:!1});if(s)throw s;return t}async createNote(e){let{data:t,error:s}=await this.supabase.from("support_ticket_notes").insert(e).select(`
        *,
        user:users(id, full_name, email)
      `).single();if(s)throw s;return t}async updateNote(e,t){let{data:s,error:r}=await this.supabase.from("support_ticket_notes").update(t).eq("id",e).select().single();if(r)throw r;return s}async deleteNote(e){let{error:t}=await this.supabase.from("support_ticket_notes").delete().eq("id",e);if(t)throw t}async createRating(e){let{data:t,error:s}=await this.supabase.from("support_ticket_ratings").insert(e).select().single();if(s)throw s;return t}async getTicketRating(e){let{data:t,error:s}=await this.supabase.from("support_ticket_ratings").select("*").eq("ticket_id",e).maybeSingle();if(s)throw s;return t}async getTemplates(e){let{data:t,error:s}=await this.supabase.from("support_response_templates").select("*").eq("organization_id",e).eq("is_active",!0).order("name",{ascending:!0});if(s)throw s;return t}async createTemplate(e){let{data:t,error:s}=await this.supabase.from("support_response_templates").insert(e).select().single();if(s)throw s;return t}async updateTemplate(e,t){let{data:s,error:r}=await this.supabase.from("support_response_templates").update(t).eq("id",e).select().single();if(r)throw r;return s}async deleteTemplate(e){let{error:t}=await this.supabase.from("support_response_templates").delete().eq("id",e);if(t)throw t}async getStatistics(e,t){let s=this.supabase.from("support_tickets").select("status, priority, created_at, resolved_at, first_response_at").eq("organization_id",e);t?.startDate&&(s=s.gte("created_at",t.startDate)),t?.endDate&&(s=s.lte("created_at",t.endDate));let{data:r,error:a}=await s;if(a)throw a;let i=r||[],n={total:i.length,byStatus:{open:0,in_progress:0,waiting_customer:0,resolved:0,closed:0},byPriority:{low:0,medium:0,high:0,urgent:0},averageResponseTime:0,averageResolutionTime:0,resolutionRate:0},l=0,c=0,o=0,d=0,u=0;return i.forEach(e=>{if(e.status&&e.status in n.byStatus&&n.byStatus[e.status]++,e.priority&&e.priority in n.byPriority&&n.byPriority[e.priority]++,e.first_response_at&&e.created_at){let t=new Date(e.first_response_at).getTime()-new Date(e.created_at).getTime();l+=t,c++}if(e.resolved_at&&e.created_at){let t=new Date(e.resolved_at).getTime()-new Date(e.created_at).getTime();o+=t,d++}("resolved"===e.status||"closed"===e.status)&&u++}),c>0&&(n.averageResponseTime=l/c/6e4),d>0&&(n.averageResolutionTime=o/d/36e5),r.length>0&&(n.resolutionRate=u/r.length*100),n}};e.s(["supportService",0,s])},361541,e=>{"use strict";var t=e.i(843476),s=e.i(271645),r=e.i(618566),a=e.i(266027),i=e.i(954616),n=e.i(912598),l=e.i(325715),c=e.i(562369),o=e.i(970065),d=e.i(167881),u=e.i(184762),m=e.i(10708),p=e.i(716158),h=e.i(871689),g=e.i(514764),x=e.i(605631),f=e.i(738308),y=e.i(503116),_=e.i(898791),j=e.i(284614),v=e.i(870273),w=e.i(522016),b=e.i(647163);function k(){let e=(0,r.useParams)();(0,r.useRouter)();let k=e.id,{user:N}=(0,l.useAuth)(),S=(0,n.useQueryClient)(),[C,T]=(0,s.useState)(""),q=(0,s.useRef)(null),{data:D}=(0,a.useQuery)({queryKey:["support-ticket",k],queryFn:()=>c.supportService.getTicketById(k),enabled:!!k}),{data:R}=(0,a.useQuery)({queryKey:["support-ticket-messages",k],queryFn:()=>c.supportService.getTicketMessages(k),enabled:!!k,refetchInterval:5e3}),{data:I}=(0,a.useQuery)({queryKey:["support-ticket-notes",k],queryFn:()=>c.supportService.getTicketNotes(k),enabled:!!k&&(N?.role==="admin"||N?.role==="super_admin"||N?.role==="support")}),{data:P}=(0,a.useQuery)({queryKey:["support-ticket-rating",k],queryFn:()=>c.supportService.getTicketRating(k),enabled:!!k&&D?.status==="resolved"}),F=(0,i.useMutation)({mutationFn:async e=>c.supportService.createMessage({ticket_id:k,user_id:N?.id||"",content:e,message_type:"text",is_internal:!1}),onSuccess:()=>{T(""),S.invalidateQueries({queryKey:["support-ticket-messages"]}),S.invalidateQueries({queryKey:["support-ticket"]})}}),K=(0,i.useMutation)({mutationFn:async e=>{let t={status:e};return"resolved"===e?t.resolved_at=new Date().toISOString():"closed"===e&&(t.closed_at=new Date().toISOString()),c.supportService.updateTicket(k,t)},onSuccess:()=>{S.invalidateQueries({queryKey:["support-ticket"]}),S.invalidateQueries({queryKey:["support-tickets"]})}});(0,i.useMutation)({mutationFn:async e=>c.supportService.assignTicket(k,e),onSuccess:()=>{S.invalidateQueries({queryKey:["support-ticket"]})}});let M=(0,i.useMutation)({mutationFn:async e=>c.supportService.createNote({ticket_id:k,user_id:N?.id||"",content:e,is_private:!0}),onSuccess:()=>{S.invalidateQueries({queryKey:["support-ticket-notes"]})}}),z=(0,i.useMutation)({mutationFn:async e=>c.supportService.createRating({ticket_id:k,user_id:N?.id||"",rating:e.rating,comment:e.comment}),onSuccess:()=>{S.invalidateQueries({queryKey:["support-ticket-rating"]})}}),A=N?.role==="admin"||N?.role==="super_admin"||N?.role==="support",Q=D?.user_id===N?.id;return((0,s.useEffect)(()=>{q.current?.scrollIntoView({behavior:"smooth"})},[R]),D)?(0,t.jsxs)("div",{className:"container mx-auto py-8 px-4 max-w-7xl",children:[(0,t.jsxs)("div",{className:"mb-6",children:[(0,t.jsx)(w.default,{href:"/dashboard/support",children:(0,t.jsxs)(d.Button,{variant:"ghost",size:"sm",className:"mb-4",children:[(0,t.jsx)(h.ArrowLeft,{className:"h-4 w-4 mr-2"}),"Retour aux tickets"]})}),(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("div",{children:[(0,t.jsxs)("div",{className:"flex items-center gap-3 mb-2",children:[(0,t.jsx)("span",{className:"font-mono text-sm text-muted-foreground",children:D.ticket_number}),(0,t.jsx)("h1",{className:"text-3xl font-bold",children:D.subject})]}),(0,t.jsxs)("div",{className:"flex items-center gap-4 text-sm text-muted-foreground",children:[(0,t.jsxs)("div",{className:"flex items-center gap-1",children:[(e=>{switch(e){case"open":return(0,t.jsx)(_.AlertCircle,{className:"h-4 w-4 text-blue-600"});case"in_progress":return(0,t.jsx)(y.Clock,{className:"h-4 w-4 text-yellow-600"});case"waiting_customer":return(0,t.jsx)(y.Clock,{className:"h-4 w-4 text-orange-600"});case"resolved":return(0,t.jsx)(x.CheckCircle,{className:"h-4 w-4 text-green-600"});case"closed":return(0,t.jsx)(f.XCircle,{className:"h-4 w-4 text-gray-600"});default:return null}})(D.status||""),(0,t.jsx)("span",{children:(e=>{switch(e){case"open":return"Ouvert";case"in_progress":return"En cours";case"waiting_customer":return"En attente client";case"resolved":return"Résolu";case"closed":return"Fermé";default:return e}})(D.status||"")})]}),(0,t.jsxs)("span",{children:["Créé le ",(0,b.formatDate)(D.created_at||"")]}),D.category&&(0,t.jsx)("span",{children:D.category.name})]})]}),A&&(0,t.jsx)("div",{className:"flex items-center gap-2",children:(0,t.jsxs)(p.Select,{value:D.status||"",onValueChange:e=>K.mutate(e),children:[(0,t.jsx)(p.SelectTrigger,{className:"w-40",children:(0,t.jsx)(p.SelectValue,{})}),(0,t.jsxs)(p.SelectContent,{children:[(0,t.jsx)(p.SelectItem,{value:"open",children:"Ouvert"}),(0,t.jsx)(p.SelectItem,{value:"in_progress",children:"En cours"}),(0,t.jsx)(p.SelectItem,{value:"waiting_customer",children:"En attente"}),(0,t.jsx)(p.SelectItem,{value:"resolved",children:"Résolu"}),(0,t.jsx)(p.SelectItem,{value:"closed",children:"Fermé"})]})]})})]})]}),(0,t.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[(0,t.jsx)("div",{className:"lg:col-span-2",children:(0,t.jsxs)(o.Card,{className:"h-[600px] flex flex-col",children:[(0,t.jsx)(o.CardHeader,{children:(0,t.jsx)(o.CardTitle,{children:"Conversation"})}),(0,t.jsxs)(o.CardContent,{className:"flex-1 flex flex-col overflow-hidden",children:[(0,t.jsxs)("div",{className:"flex-1 overflow-y-auto space-y-4 mb-4 pr-2",children:[R&&R.length>0?R.map(e=>{let s=e.user_id===N?.id,r=e.user?.role==="admin"||e.user?.role==="super_admin"||e.user?.role==="support";return(0,t.jsx)("div",{className:`flex ${s?"justify-end":"justify-start"}`,children:(0,t.jsxs)("div",{className:`max-w-[80%] rounded-lg p-3 ${s?"bg-primary text-white":r?"bg-blue-50 border border-blue-200":"bg-gray-100"}`,children:[(0,t.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,t.jsx)(j.User,{className:"h-4 w-4"}),(0,t.jsx)("span",{className:"text-sm font-medium",children:e.user?.full_name||e.user?.email||"Utilisateur"}),(0,t.jsx)("span",{className:"text-xs opacity-70",children:(0,b.formatDate)(e.created_at)})]}),(0,t.jsx)("p",{className:"text-sm whitespace-pre-wrap",children:e.content})]})},e.id)}):(0,t.jsx)("div",{className:"text-center text-muted-foreground py-8",children:"Aucun message pour le moment"}),(0,t.jsx)("div",{ref:q})]}),"closed"!==D.status&&(Q||A)&&(0,t.jsx)("form",{onSubmit:e=>{e.preventDefault(),C.trim()&&F.mutate(C)},className:"border-t pt-4",children:(0,t.jsxs)("div",{className:"flex gap-2",children:[(0,t.jsx)(u.Textarea,{value:C,onChange:e=>T(e.target.value),placeholder:"Tapez votre message...",rows:3,className:"flex-1"}),(0,t.jsx)(d.Button,{type:"submit",disabled:F.isPending||!C.trim(),children:(0,t.jsx)(g.Send,{className:"h-4 w-4"})})]})})]})]})}),(0,t.jsxs)("div",{className:"space-y-6",children:[(0,t.jsxs)(o.Card,{children:[(0,t.jsx)(o.CardHeader,{children:(0,t.jsx)(o.CardTitle,{children:"Informations"})}),(0,t.jsxs)(o.CardContent,{className:"space-y-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)(m.Label,{className:"text-xs text-muted-foreground",children:"Priorité"}),(0,t.jsx)("p",{className:"font-medium",children:D.priority})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)(m.Label,{className:"text-xs text-muted-foreground",children:"Créé par"}),(0,t.jsx)("p",{className:"font-medium",children:D.user?.full_name||D.user?.email||"Utilisateur"})]}),D.assigned_user&&(0,t.jsxs)("div",{children:[(0,t.jsx)(m.Label,{className:"text-xs text-muted-foreground",children:"Assigné à"}),(0,t.jsx)("p",{className:"font-medium",children:D.assigned_user?.full_name||D.assigned_user?.email})]}),D.first_response_at&&(0,t.jsxs)("div",{children:[(0,t.jsx)(m.Label,{className:"text-xs text-muted-foreground",children:"Première réponse"}),(0,t.jsx)("p",{className:"font-medium",children:(0,b.formatDate)(D.first_response_at)})]}),D.resolved_at&&(0,t.jsxs)("div",{children:[(0,t.jsx)(m.Label,{className:"text-xs text-muted-foreground",children:"Résolu le"}),(0,t.jsx)("p",{className:"font-medium",children:(0,b.formatDate)(D.resolved_at)})]})]})]}),(0,t.jsxs)(o.Card,{children:[(0,t.jsx)(o.CardHeader,{children:(0,t.jsx)(o.CardTitle,{children:"Description"})}),(0,t.jsx)(o.CardContent,{children:(0,t.jsx)("p",{className:"text-sm whitespace-pre-wrap",children:D.description})})]}),A&&(0,t.jsxs)(o.Card,{children:[(0,t.jsx)(o.CardHeader,{children:(0,t.jsx)(o.CardTitle,{children:"Notes internes"})}),(0,t.jsxs)(o.CardContent,{children:[I&&I.length>0?(0,t.jsx)("div",{className:"space-y-3 mb-4",children:I.map(e=>(0,t.jsxs)("div",{className:"p-3 bg-gray-50 rounded-lg",children:[(0,t.jsx)("p",{className:"text-sm whitespace-pre-wrap",children:e.content}),(0,t.jsxs)("p",{className:"text-xs text-muted-foreground mt-2",children:["Par ",e.user?.full_name||e.user?.email," le"," ",(0,b.formatDate)(e.created_at)]})]},e.id))}):null,(0,t.jsxs)("form",{onSubmit:e=>{e.preventDefault();let t=new FormData(e.currentTarget).get("note");t.trim()&&(M.mutate(t),e.currentTarget.reset())},children:[(0,t.jsx)(u.Textarea,{name:"note",placeholder:"Ajouter une note interne...",rows:3,className:"mb-2"}),(0,t.jsx)(d.Button,{type:"submit",size:"sm",disabled:M.isPending,children:"Ajouter"})]})]})]}),Q&&"resolved"===D.status&&!P&&(0,t.jsxs)(o.Card,{children:[(0,t.jsx)(o.CardHeader,{children:(0,t.jsx)(o.CardTitle,{children:"Évaluer le support"})}),(0,t.jsx)(o.CardContent,{children:(0,t.jsxs)("form",{onSubmit:e=>{e.preventDefault();let t=new FormData(e.currentTarget),s=parseInt(t.get("rating")),r=t.get("comment");z.mutate({rating:s,comment:r})},className:"space-y-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)(m.Label,{children:"Note"}),(0,t.jsxs)(p.Select,{children:[(0,t.jsx)(p.SelectTrigger,{children:(0,t.jsx)(p.SelectValue,{placeholder:"Sélectionner une note"})}),(0,t.jsx)(p.SelectContent,{children:[1,2,3,4,5].map(e=>(0,t.jsxs)(p.SelectItem,{value:e.toString(),children:[e," étoile",e>1?"s":""]},e))})]})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)(m.Label,{children:"Commentaire (optionnel)"}),(0,t.jsx)(u.Textarea,{name:"comment",rows:3})]}),(0,t.jsx)(d.Button,{type:"submit",disabled:z.isPending,children:"Envoyer l'évaluation"})]})})]}),P&&(0,t.jsxs)(o.Card,{children:[(0,t.jsx)(o.CardHeader,{children:(0,t.jsx)(o.CardTitle,{children:"Votre évaluation"})}),(0,t.jsxs)(o.CardContent,{children:[(0,t.jsxs)("div",{className:"flex items-center gap-2 mb-2",children:[(0,t.jsx)(v.Star,{className:"h-5 w-5 text-yellow-500 fill-yellow-500"}),(0,t.jsxs)("span",{className:"font-semibold",children:[P.rating," / 5"]})]}),P.comment&&(0,t.jsx)("p",{className:"text-sm text-muted-foreground",children:P.comment})]})]})]})]})]}):(0,t.jsx)("div",{className:"container mx-auto py-8 px-4 max-w-7xl",children:(0,t.jsx)("div",{className:"text-center py-12",children:"Chargement..."})})}e.s(["default",()=>k])}]);