(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,871689,e=>{"use strict";let t=(0,e.i(475254).default)("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]]);e.s(["ArrowLeft",()=>t],871689)},356909,e=>{"use strict";let t=(0,e.i(475254).default)("Save",[["path",{d:"M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z",key:"1owoqh"}],["polyline",{points:"17 21 17 13 7 13 7 21",key:"1md35c"}],["polyline",{points:"7 3 7 8 15 8",key:"8nz8an"}]]);e.s(["Save",()=>t],356909)},569074,e=>{"use strict";let t=(0,e.i(475254).default)("Upload",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"17 8 12 3 7 8",key:"t8dd8p"}],["line",{x1:"12",x2:"12",y1:"3",y2:"15",key:"widbto"}]]);e.s(["Upload",()=>t],569074)},319036,e=>{"use strict";var t=e.i(843476),s=e.i(271645),a=e.i(647163);let i=s.forwardRef(({checked:e,onCheckedChange:s,disabled:i,className:r,...n},l)=>(0,t.jsx)("button",{type:"button",role:"switch","aria-checked":e,ref:l,disabled:i,onClick:()=>s?.(!e),className:(0,a.cn)("peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50",e?"bg-brand-blue":"bg-input",r),...n,children:(0,t.jsx)("span",{className:(0,a.cn)("pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform",e?"translate-x-5":"translate-x-0")})}));i.displayName="Switch",e.s(["Switch",0,i])},870273,e=>{"use strict";let t=(0,e.i(475254).default)("Star",[["polygon",{points:"12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2",key:"8f66p6"}]]);e.s(["Star",()=>t],870273)},382023,e=>{"use strict";var t=e.i(843476),s=e.i(271645),a=e.i(618566),i=e.i(266027),r=e.i(954616),n=e.i(912598),l=e.i(325715),o=e.i(920755),d=e.i(970065),c=e.i(167881),u=e.i(23750),m=e.i(10708),x=e.i(184762),h=e.i(319036),p=e.i(994179),f=e.i(6799),g=e.i(871689),y=e.i(356909),j=e.i(465286),v=e.i(284614),b=e.i(87316),N=e.i(870273),_=e.i(178583),C=e.i(569074),w=e.i(522016);e.i(882205);var k=e.i(846932),S=e.i(647163);function $(){let e=(0,a.useParams)();(0,a.useRouter)();let{user:$}=(0,l.useAuth)(),q=(0,o.createClient)(),B=(0,n.useQueryClient)(),{addToast:L}=(0,f.useToast)(),E=e.id,[T,A]=(0,s.useState)({}),[I,P]=(0,s.useState)(""),[z,F]=(0,s.useState)(!1),[K,M]=(0,s.useState)(!1),{data:R,isLoading:U}=(0,i.useQuery)({queryKey:["portfolio",E],queryFn:async()=>{let{data:e,error:t}=await q.from("learning_portfolios").select(`
          *,
          template:learning_portfolio_templates(*),
          student:students(id, first_name, last_name, email, phone, photo_url),
          session:sessions(id, name, start_date, end_date, formations(id, name))
        `).eq("id",E).single();if(t)throw t;return e},enabled:!!E}),{data:H}=(0,i.useQuery)({queryKey:["portfolio-entries",E],queryFn:async()=>{let{data:e,error:t}=await q.from("learning_portfolio_entries").select("*").eq("portfolio_id",E);return t?(console.log("Erreur ou table inexistante:",t),[]):e||[]},enabled:!!E});(0,s.useEffect)(()=>{R&&(P(R.teacher_notes||""),F(R.is_visible_to_student||!1),R.content&&A(R.content))},[R]),(0,s.useEffect)(()=>{if(H&&H.length>0){let e={};H.forEach(t=>{let s=`${t.section_id}.${t.field_id}`;e[s]=t.value,t.teacher_comment&&(e[`${s}_comment`]=t.teacher_comment)}),A(t=>({...t,...e}))}},[H]);let O=(0,r.useMutation)({mutationFn:async e=>{let{error:t}=await q.from("learning_portfolios").update({content:e.content,status:e.status,teacher_notes:I,is_visible_to_student:z,last_modified_by:$?.id,..."completed"===e.status?{completed_at:new Date().toISOString()}:{}}).eq("id",E);if(t)throw t;let s=[],a=R?.template;if(a?.template_structure?.forEach(t=>{t.fields?.forEach(a=>{let i=`${t.id}.${a.id}`,r=e.content[i];void 0!==r&&s.push({portfolio_id:E,section_id:t.id,field_id:a.id,value:r,teacher_comment:e.content[`${i}_comment`]||null,evaluated_by:$?.id,evaluated_at:new Date().toISOString()})})}),s.length>0){let{error:e}=await q.from("learning_portfolio_entries").upsert(s,{onConflict:"portfolio_id,section_id,field_id"});e&&console.error("Erreur sauvegarde entrées:",e)}},onSuccess:()=>{B.invalidateQueries({queryKey:["portfolio",E]}),B.invalidateQueries({queryKey:["portfolio-entries",E]}),L({type:"success",title:"Livret sauvegardé",description:"Les modifications ont été enregistrées."})},onError:e=>{L({type:"error",title:"Erreur",description:e.message||"Impossible de sauvegarder."})}}),Q=(e="in_progress")=>{O.mutate({content:T,status:e})},V=()=>{confirm("Êtes-vous sûr de vouloir valider ce livret ? Il sera visible par l'apprenant.")&&(O.mutate({content:T,status:"validated"}),F(!0))},D=(e,t,s)=>{let a=`${e}.${t}`;A(e=>({...e,[a]:s}))};if(U)return(0,t.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,t.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-brand-blue"})});if(!R)return(0,t.jsx)("div",{className:"container mx-auto py-8 px-4",children:(0,t.jsx)(d.Card,{children:(0,t.jsxs)(d.CardContent,{className:"py-12 text-center",children:[(0,t.jsx)(_.FileText,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),(0,t.jsx)("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Livret non trouvé"}),(0,t.jsx)(w.default,{href:"/dashboard/evaluations/portfolios",children:(0,t.jsx)(c.Button,{children:"Retour à la liste"})})]})})});let W=R.template,G=R.student;return(0,t.jsxs)("div",{className:"container mx-auto py-8 px-4 max-w-5xl",children:[(0,t.jsx)(k.motion.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"mb-8",children:(0,t.jsxs)("div",{className:"flex items-center gap-4 mb-4",children:[(0,t.jsx)(w.default,{href:"/dashboard/evaluations/portfolios",children:(0,t.jsx)(c.Button,{variant:"ghost",size:"icon",children:(0,t.jsx)(g.ArrowLeft,{className:"h-5 w-5"})})}),(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsx)("h1",{className:"text-2xl font-bold text-gray-900 flex items-center gap-3",children:W?.name||"Livret d'apprentissage"}),(0,t.jsxs)("div",{className:"flex items-center gap-4 text-sm text-gray-600 mt-1",children:[(0,t.jsxs)("span",{className:"flex items-center gap-1",children:[(0,t.jsx)(v.User,{className:"h-4 w-4"}),G?.first_name," ",G?.last_name]}),R.session&&(0,t.jsxs)("span",{className:"flex items-center gap-1",children:[(0,t.jsx)(b.Calendar,{className:"h-4 w-4"}),R.session.name]}),(0,t.jsxs)(p.Badge,{variant:"validated"===R.status?"default":"secondary",children:["draft"===R.status&&"Brouillon","in_progress"===R.status&&"En cours","completed"===R.status&&"Terminé","validated"===R.status&&"Validé"]})]})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsxs)(c.Button,{variant:"outline",onClick:()=>Q("in_progress"),disabled:O.isPending,children:[(0,t.jsx)(y.Save,{className:"h-4 w-4 mr-2"}),"Sauvegarder"]}),(0,t.jsxs)(c.Button,{onClick:V,disabled:O.isPending,children:[(0,t.jsx)(j.CheckCircle2,{className:"h-4 w-4 mr-2"}),"Valider"]})]})]})}),(0,t.jsx)(d.Card,{className:"mb-6",style:{borderLeftColor:W?.primary_color,borderLeftWidth:4},children:(0,t.jsx)(d.CardContent,{className:"py-4",children:(0,t.jsxs)("div",{className:"flex items-center gap-4",children:[(0,t.jsx)("div",{className:"w-14 h-14 rounded-full flex items-center justify-center text-white text-lg font-medium",style:{backgroundColor:W?.primary_color||"#335ACF"},children:G?.photo_url?(0,t.jsx)("img",{src:G.photo_url,alt:"",className:"w-14 h-14 rounded-full object-cover"}):`${G?.first_name?.[0]}${G?.last_name?.[0]}`}),(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsxs)("h3",{className:"font-semibold text-gray-900",children:[G?.first_name," ",G?.last_name]}),(0,t.jsx)("p",{className:"text-sm text-gray-600",children:G?.email}),R.session?.formations&&(0,t.jsx)("p",{className:"text-sm text-gray-500",children:R.session.formations.name})]}),(0,t.jsxs)("div",{className:"text-right",children:[(0,t.jsx)("p",{className:"text-sm text-gray-600",children:"Progression"}),(0,t.jsxs)("p",{className:"text-2xl font-bold",style:{color:W?.primary_color},children:[Math.round(R.progress_percentage||0),"%"]})]})]})})}),(0,t.jsx)("div",{className:"space-y-6",children:W?.template_structure?.map((e,s)=>(0,t.jsx)(k.motion.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.1*s},children:(0,t.jsxs)(d.Card,{children:[(0,t.jsxs)(d.CardHeader,{style:{borderBottomColor:W?.primary_color,borderBottomWidth:2},children:[(0,t.jsxs)(d.CardTitle,{className:"flex items-center gap-2",children:[(0,t.jsx)("span",{className:"w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-medium",style:{backgroundColor:W?.primary_color},children:s+1}),e.title]}),e.description&&(0,t.jsx)(d.CardDescription,{children:e.description})]}),(0,t.jsx)(d.CardContent,{className:"pt-6",children:(0,t.jsx)("div",{className:"space-y-6",children:e.fields?.map(s=>(0,t.jsxs)("div",{children:[(0,t.jsxs)(m.Label,{className:"flex items-center gap-2 mb-2",children:[s.label,s.required&&(0,t.jsx)("span",{className:"text-red-500",children:"*"})]}),((e,s)=>{var a,i;let r=(a=e.id,i=s.id,T[`${a}.${i}`]);switch(e.id,s.id,s.type){case"text":return(0,t.jsx)(u.Input,{value:r||"",onChange:t=>D(e.id,s.id,t.target.value),placeholder:s.placeholder||""});case"textarea":return(0,t.jsx)(x.Textarea,{value:r||"",onChange:t=>D(e.id,s.id,t.target.value),placeholder:s.placeholder||"",rows:4});case"number":return(0,t.jsx)(u.Input,{type:"number",value:r||"",onChange:t=>D(e.id,s.id,parseFloat(t.target.value)),min:s.min,max:s.max});case"select":return(0,t.jsxs)("select",{value:r||"",onChange:t=>D(e.id,s.id,t.target.value),className:"w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-brand-blue",children:[(0,t.jsx)("option",{value:"",children:"Sélectionner..."}),s.options?.map(e=>(0,t.jsx)("option",{value:e,children:e},e))]});case"checkbox":return(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("input",{type:"checkbox",checked:r||!1,onChange:t=>D(e.id,s.id,t.target.checked),className:"rounded"}),(0,t.jsx)("span",{className:"text-sm text-gray-600",children:s.description||"Oui"})]});case"date":return(0,t.jsx)(u.Input,{type:"date",value:r||"",onChange:t=>D(e.id,s.id,t.target.value)});case"rating":let n=s.max||5,l=s.min||1;return(0,t.jsxs)("div",{className:"flex items-center gap-1",children:[Array.from({length:n-l+1},(e,t)=>t+l).map(a=>(0,t.jsx)("button",{type:"button",onClick:()=>D(e.id,s.id,a),className:(0,S.cn)("p-1 rounded transition-colors",(r||0)>=a?"text-yellow-500":"text-gray-300 hover:text-yellow-400"),children:(0,t.jsx)(N.Star,{className:"h-6 w-6 fill-current"})},a)),(0,t.jsx)("span",{className:"ml-2 text-sm text-gray-600",children:r?`${r}/${n}`:"Non noté"})]});case"competency":let o=s.competencyLevels||["Non acquis","En cours","Acquis","Maîtrisé"];return(0,t.jsx)("div",{className:"flex flex-wrap gap-2",children:o.map((a,i)=>(0,t.jsx)("button",{type:"button",onClick:()=>D(e.id,s.id,a),className:(0,S.cn)("px-3 py-1.5 rounded-full text-sm font-medium transition-all",r===a?"bg-brand-blue text-white":"bg-gray-100 text-gray-600 hover:bg-gray-200"),children:a},a))});case"file":return(0,t.jsxs)("div",{className:"border-2 border-dashed rounded-lg p-4 text-center",children:[(0,t.jsx)(C.Upload,{className:"h-8 w-8 mx-auto text-gray-400 mb-2"}),(0,t.jsx)("p",{className:"text-sm text-gray-600",children:"Glissez un fichier ici ou cliquez pour sélectionner"}),(0,t.jsx)("input",{type:"file",className:"hidden",onChange:t=>{let a=t.target.files?.[0];a&&D(e.id,s.id,{name:a.name,size:a.size})}})]});default:return(0,t.jsx)(u.Input,{value:r||"",onChange:t=>D(e.id,s.id,t.target.value)})}})(e,s),("competency"===s.type||"rating"===s.type)&&(0,t.jsx)("div",{className:"mt-2",children:(0,t.jsx)(u.Input,{placeholder:"Commentaire (optionnel)",value:T[`${e.id}.${s.id}_comment`]||"",onChange:t=>{let a=`${e.id}.${s.id}_comment`;A(e=>({...e,[a]:t.target.value}))},className:"text-sm"})})]},s.id))})})]})},e.id))}),(0,t.jsxs)(d.Card,{className:"mt-6",children:[(0,t.jsx)(d.CardHeader,{children:(0,t.jsx)(d.CardTitle,{children:"Notes et options"})}),(0,t.jsxs)(d.CardContent,{className:"space-y-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)(m.Label,{children:"Notes du formateur"}),(0,t.jsx)(x.Textarea,{value:I,onChange:e=>P(e.target.value),placeholder:"Notes internes (non visibles par l'apprenant)...",rows:4})]}),(0,t.jsxs)("div",{className:"flex items-center justify-between p-4 bg-gray-50 rounded-lg",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"font-medium text-gray-900",children:"Visibilité apprenant"}),(0,t.jsx)("p",{className:"text-sm text-gray-600",children:"Permettre à l'apprenant de consulter et télécharger son livret"})]}),(0,t.jsx)(h.Switch,{checked:z,onCheckedChange:F})]})]})]}),(0,t.jsxs)("div",{className:"mt-6 flex justify-between",children:[(0,t.jsx)(w.default,{href:"/dashboard/evaluations/portfolios",children:(0,t.jsxs)(c.Button,{variant:"outline",children:[(0,t.jsx)(g.ArrowLeft,{className:"h-4 w-4 mr-2"}),"Retour"]})}),(0,t.jsxs)("div",{className:"flex gap-3",children:[(0,t.jsxs)(c.Button,{variant:"outline",onClick:()=>Q("in_progress"),disabled:O.isPending,children:[(0,t.jsx)(y.Save,{className:"h-4 w-4 mr-2"}),"Sauvegarder"]}),(0,t.jsxs)(c.Button,{onClick:V,disabled:O.isPending,children:[(0,t.jsx)(j.CheckCircle2,{className:"h-4 w-4 mr-2"}),"Valider et rendre visible"]})]})]})]})}e.s(["default",()=>$])}]);