(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,871689,e=>{"use strict";let t=(0,e.i(475254).default)("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]]);e.s(["ArrowLeft",()=>t],871689)},761911,e=>{"use strict";let t=(0,e.i(475254).default)("Users",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["path",{d:"M22 21v-2a4 4 0 0 0-3-3.87",key:"kshegd"}],["path",{d:"M16 3.13a4 4 0 0 1 0 7.75",key:"1da9ce"}]]);e.s(["Users",()=>t],761911)},440160,e=>{"use strict";let t=(0,e.i(475254).default)("Download",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"7 10 12 15 17 10",key:"2ggqvy"}],["line",{x1:"12",x2:"12",y1:"15",y2:"3",key:"1vk2je"}]]);e.s(["Download",()=>t],440160)},727612,e=>{"use strict";let t=(0,e.i(475254).default)("Trash2",[["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6",key:"4alrt4"}],["path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",key:"v07s0e"}],["line",{x1:"10",x2:"10",y1:"11",y2:"17",key:"1uufr5"}],["line",{x1:"14",x2:"14",y1:"11",y2:"17",key:"xtxkd"}]]);e.s(["Trash2",()=>t],727612)},514764,e=>{"use strict";let t=(0,e.i(475254).default)("Send",[["path",{d:"m22 2-7 20-4-9-9-4Z",key:"1q3vgg"}],["path",{d:"M22 2 11 13",key:"nzbqef"}]]);e.s(["Send",()=>t],514764)},473708,e=>{"use strict";let t=(0,e.i(475254).default)("Image",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]]);e.s(["Image",()=>t],473708)},643531,e=>{"use strict";let t=(0,e.i(475254).default)("Check",[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]]);e.s(["Check",()=>t],643531)},463059,e=>{"use strict";let t=(0,e.i(475254).default)("ChevronRight",[["path",{d:"m9 18 6-6-6-6",key:"mthhwq"}]]);e.s(["ChevronRight",()=>t],463059)},114683,e=>{"use strict";let t=(0,e.i(475254).default)("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);e.s(["Circle",()=>t],114683)},794008,e=>{"use strict";let t=(0,e.i(475254).default)("File",[["path",{d:"M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z",key:"1nnpy2"}],["polyline",{points:"14 2 14 8 20 8",key:"1ew0cm"}]]);e.s(["File",()=>t],794008)},318216,e=>{"use strict";let t=(0,e.i(475254).default)("MoreVertical",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"12",cy:"5",r:"1",key:"gxeob9"}],["circle",{cx:"12",cy:"19",r:"1",key:"lyex9k"}]]);e.s(["MoreVertical",()=>t],318216)},604667,e=>{"use strict";var t=e.i(920755);let a=new class{supabase;constructor(e){this.supabase=e||(0,t.createClient)()}async getConversations(e,t){let{data:a,error:s}=await this.supabase.from("conversation_participants").select("conversation_id").eq("user_id",e);if(s)throw s;if(!a||0===a.length)return[];let i=a.map(e=>e.conversation_id),{data:r,error:n}=await this.supabase.from("conversations").select("*").eq("organization_id",t).eq("is_archived",!1).in("id",i).order("last_message_at",{ascending:!1,nullsFirst:!1});if(n)throw n;if(!r||0===r.length)return[];let{data:l}=await this.supabase.from("conversation_participants").select("*").in("conversation_id",i),d=[...new Set((l||[]).filter(e=>e.user_id).map(e=>e.user_id))],o=[...new Set((l||[]).filter(e=>e.student_id).map(e=>e.student_id))],u={};if(d.length>0){let{data:e}=await this.supabase.from("users").select("id, full_name, email, avatar_url").in("id",d);e?.forEach(e=>{u[e.id]=e})}let c={};if(o.length>0){let{data:e}=await this.supabase.from("students").select("id, first_name, last_name, email, student_number").in("id",o);e?.forEach(e=>{c[e.id]=e})}let m=r.map(e=>this.supabase.from("messages").select("*").eq("conversation_id",e.id).eq("is_deleted",!1).order("created_at",{ascending:!1}).limit(1).maybeSingle()),p=await Promise.all(m),_=[...new Set(p.filter(e=>e.data?.sender_id).map(e=>e.data.sender_id))],f=[...new Set(p.filter(e=>e.data?.student_sender_id).map(e=>e.data.student_sender_id))];if(_.length>0){let{data:e}=await this.supabase.from("users").select("id, full_name, email").in("id",_.filter(e=>!u[e]));e?.forEach(e=>{u[e.id]=e})}if(f.length>0){let{data:e}=await this.supabase.from("students").select("id, first_name, last_name, email, student_number").in("id",f.filter(e=>!c[e]));e?.forEach(e=>{c[e.id]=e})}return r.map((e,t)=>{let a=(l||[]).filter(t=>t.conversation_id===e.id).map(e=>({...e,user:e.user_id&&u[e.user_id]||null,student:e.student_id&&c[e.student_id]||null})),s=p[t].data,i=null;return s&&(i={...s,sender:s.sender_id&&u[s.sender_id]||null,student_sender:s.student_sender_id&&c[s.student_sender_id]||null}),{...e,participants:a,last_message:i}})}async getConversationsByStudentId(e,t){let{data:a,error:s}=await this.supabase.from("conversation_participants").select("conversation_id").eq("student_id",e);if(s)throw s;if(!a||0===a.length)return[];let i=a.map(e=>e.conversation_id),{data:r,error:n}=await this.supabase.from("conversations").select("*").eq("organization_id",t).eq("is_archived",!1).in("id",i).order("last_message_at",{ascending:!1,nullsFirst:!1});if(n)throw n;return r&&0!==r.length?await Promise.all(r.map(async e=>{let{data:t}=await this.supabase.from("conversation_participants").select("*").eq("conversation_id",e.id),a=await Promise.all((t||[]).map(async e=>{let t=null,a=null;if(e.user_id){let{data:a}=await this.supabase.from("users").select("id, full_name, email, avatar_url").eq("id",e.user_id).maybeSingle();t=a}if(e.student_id){let{data:t}=await this.supabase.from("students").select("id, first_name, last_name, email, student_number").eq("id",e.student_id).maybeSingle();a=t}return{...e,user:t,student:a}})),{data:s}=await this.supabase.from("messages").select("*").eq("conversation_id",e.id).eq("is_deleted",!1).order("created_at",{ascending:!1}).limit(1),i=null;if(s&&s.length>0){let e=s[0],t=null;if(e.sender_id){let{data:a}=await this.supabase.from("users").select("id, full_name, email").eq("id",e.sender_id).maybeSingle();t=a}i={...e,sender:t}}return{...e,participants:a,last_message:i}})):[]}async getConversationById(e){let{data:t,error:a}=await this.supabase.from("conversations").select("id, organization_id, conversation_type, name, created_by, created_at, updated_at, is_archived, last_message_at").eq("id",e).maybeSingle();if(a)throw console.error("[MESSAGING] Erreur récupération conversation:",a),a;if(!t)return null;let{data:s,error:i}=await this.supabase.from("conversation_participants").select("*").eq("conversation_id",e);if(i)throw i;let r=await Promise.all((s||[]).map(async e=>{let t=null,a=null;if(e.user_id){let{data:a}=await this.supabase.from("users").select("id, full_name, email, avatar_url").eq("id",e.user_id).maybeSingle();t=a}if(e.student_id){let{data:t}=await this.supabase.from("students").select("id, first_name, last_name, email, student_number").eq("id",e.student_id).maybeSingle();a=t}return{...e,user:t,student:a}}));return{...t,participants:r}}async createDirectConversation(e,t,a,s){let{data:i,error:r}=await this.supabase.from("conversations").select("id").eq("conversation_type","direct").eq("organization_id",a);if(!r&&i&&i.length>0){let a=i.map(e=>e.id),{data:r,error:n}=await this.supabase.from("conversation_participants").select("conversation_id").eq("user_id",e).in("conversation_id",a);if(!n&&r&&r.length>0){let e=r.map(e=>e.conversation_id),a=this.supabase.from("conversation_participants").select("conversation_id").in("conversation_id",e);t?a=a.eq("user_id",t):s&&(a=a.eq("student_id",s));let{data:i}=await a.maybeSingle();if(i)return this.getConversationById(i.conversation_id)}}let{data:n,error:l}=await this.supabase.from("conversations").insert({organization_id:a,conversation_type:"direct",created_by:e}).select().single();if(l)throw l;return await this.addParticipant(n.id,e,"member"),await this.addParticipant(n.id,t,"member",s),this.getConversationById(n.id)}async createGroupConversation(e,t,a,s,i){let{data:r,error:n}=await this.supabase.from("conversations").insert({organization_id:a,conversation_type:"group",name:e,created_by:s}).select().single();if(n)throw n;for(let e of t)await this.addParticipant(r.id,e,e===s?"owner":"member");if(i&&i.length>0)for(let e of i)await this.addParticipant(r.id,null,"member",e);return this.getConversationById(r.id)}async updateConversation(e,t){let{data:a,error:s}=await this.supabase.from("conversations").update(t).eq("id",e).select().single();if(s)throw s;return a}async archiveConversation(e){return this.updateConversation(e,{is_archived:!0})}async deleteConversation(e){return this.updateConversation(e,{is_archived:!0})}async pinConversation(e,t){return this.updateConversation(e,{is_pinned:t})}async addParticipant(e,t,a="member",s){let i={conversation_id:e,role:a};if(t)i.user_id=t;else if(s)i.student_id=s;else throw Error("Either userId or studentId must be provided");let{data:r,error:n}=await this.supabase.from("conversation_participants").insert(i).select().single();if(n)throw n;return r}async removeParticipant(e,t){let{error:a}=await this.supabase.from("conversation_participants").delete().eq("conversation_id",e).eq("user_id",t);if(a)throw a}async updateParticipantRole(e,t,a){let{data:s,error:i}=await this.supabase.from("conversation_participants").update({role:a}).eq("conversation_id",e).eq("user_id",t).select().single();if(i)throw i;return s}async muteConversation(e,t,a){let{data:s,error:i}=await this.supabase.from("conversation_participants").update({is_muted:a}).eq("conversation_id",e).eq("user_id",t).select().single();if(i)throw i;return s}async markAsRead(e,t){let{error:a}=await this.supabase.from("conversation_participants").update({last_read_at:new Date().toISOString()}).eq("conversation_id",e).eq("user_id",t);if(a)throw a;let{data:s}=await this.supabase.from("messages").select("id").eq("conversation_id",e).not("sender_id","eq",t);if(s)for(let e of s)await this.supabase.from("message_reads").upsert({message_id:e.id,user_id:t,read_at:new Date().toISOString()})}async getMessages(e,t=50,a=0){let{data:s,error:i}=await this.supabase.from("messages").select("*").eq("conversation_id",e).eq("is_deleted",!1).order("created_at",{ascending:!1}).range(a,a+t-1);if(i)throw i;return s&&0!==s.length?(await Promise.all(s.map(async e=>{let t=null,a=null,s=null;if(e.sender_id){let{data:a}=await this.supabase.from("users").select("id, full_name, email, avatar_url").eq("id",e.sender_id).maybeSingle();t=a}if(e.student_sender_id){let{data:t}=await this.supabase.from("students").select("id, first_name, last_name, email, student_number").eq("id",e.student_sender_id).maybeSingle();a=t}if(e.reply_to_id){let{data:t}=await this.supabase.from("messages").select("*").eq("id",e.reply_to_id).maybeSingle();if(t){let e=null,a=null;if(t.sender_id){let{data:a}=await this.supabase.from("users").select("id, full_name").eq("id",t.sender_id).maybeSingle();e=a}if(t.student_sender_id){let{data:e}=await this.supabase.from("students").select("id, first_name, last_name, email, student_number").eq("id",t.student_sender_id).maybeSingle();a=e}s={...t,sender:e,student_sender:a}}}return{...e,sender:t,student_sender:a,reply_to:s}}))).reverse():[]}async uploadAttachment(e,t){let a=e.name.split(".").pop(),s=`${Date.now()}-${Math.random().toString(36).substring(7)}.${a}`,i=`${t}/${s}`,{data:r,error:n}=await this.supabase.storage.from("messages").upload(i,e,{cacheControl:"3600",upsert:!1});if(n)throw n;return i}async getAttachmentUrl(e){let{data:t,error:a}=await this.supabase.storage.from("messages").createSignedUrl(e,3600);if(a)throw a;return t.signedUrl}async sendMessage(e){let{data:t,error:a}=await this.supabase.from("messages").insert(e).select("*").single();if(a)throw a;let s=null,i=null;if(t.sender_id){let{data:e}=await this.supabase.from("users").select("id, full_name, email, avatar_url").eq("id",t.sender_id).maybeSingle();s=e}if(t.student_sender_id){let{data:e}=await this.supabase.from("students").select("id, first_name, last_name, email, student_number").eq("id",t.student_sender_id).maybeSingle();i=e}return{...t,sender:s,student_sender:i}}async updateMessage(e,t){let{data:a,error:s}=await this.supabase.from("messages").update({content:t,is_edited:!0}).eq("id",e).select().single();if(s)throw s;return a}async deleteMessage(e){let{data:t,error:a}=await this.supabase.from("messages").update({is_deleted:!0,deleted_at:new Date().toISOString(),content:"Message supprimé"}).eq("id",e).select().single();if(a)throw a;return t}async addReaction(e,t,a){let{data:s}=await this.supabase.from("messages").select("reactions").eq("id",e).single();if(!s)throw Error("Message non trouvé");let i=s.reactions||{};i[a]||(i[a]=[]),i[a].includes(t)||i[a].push(t);let{data:r,error:n}=await this.supabase.from("messages").update({reactions:i}).eq("id",e).select().single();if(n)throw n;return r}async removeReaction(e,t,a){let{data:s}=await this.supabase.from("messages").select("reactions").eq("id",e).single();if(!s)throw Error("Message non trouvé");let i=s.reactions||{};i[a]&&(i[a]=i[a].filter(e=>e!==t),0===i[a].length&&delete i[a]);let{data:r,error:n}=await this.supabase.from("messages").update({reactions:i}).eq("id",e).select().single();if(n)throw n;return r}async pinMessage(e,t,a){let{data:s,error:i}=await this.supabase.from("pinned_messages").insert({conversation_id:e,message_id:t,pinned_by:a}).select().single();if(i)throw i;return s}async unpinMessage(e,t){let{error:a}=await this.supabase.from("pinned_messages").delete().eq("conversation_id",e).eq("message_id",t);if(a)throw a}async getPinnedMessages(e){let{data:t,error:a}=await this.supabase.from("pinned_messages").select(`
        *,
        message:messages(*, sender:users(id, full_name, email)),
        pinned_by_user:users(id, full_name)
      `).eq("conversation_id",e).order("pinned_at",{ascending:!1});if(a)throw a;return t}async createCall(e){let{data:t,error:a}=await this.supabase.from("calls").insert(e).select().single();if(a)throw a;return t}async updateCallStatus(e,t,a){let s={status:t};"active"===t?s.started_at=new Date().toISOString():"ended"===t&&(s.ended_at=new Date().toISOString(),a&&(s.duration_seconds=a));let{data:i,error:r}=await this.supabase.from("calls").update(s).eq("id",e).select().single();if(r)throw r;return i}async addCallParticipant(e,t){let{data:a,error:s}=await this.supabase.from("call_participants").insert({call_id:e,user_id:t,status:"joined",joined_at:new Date().toISOString()}).select().single();if(s)throw s;return a}async getNotifications(e,t=!1){let a=this.supabase.from("message_notifications").select(`
        *,
        conversation:conversations(*),
        message:messages(*, sender:users(id, full_name, email))
      `).eq("user_id",e);t&&(a=a.eq("is_read",!1));let{data:s,error:i}=await a.order("created_at",{ascending:!1}).limit(50);if(i)throw i;return s}async markNotificationAsRead(e){let{data:t,error:a}=await this.supabase.from("message_notifications").update({is_read:!0,read_at:new Date().toISOString()}).eq("id",e).select().single();if(a)throw a;return t}async markAllNotificationsAsRead(e){let{error:t}=await this.supabase.from("message_notifications").update({is_read:!0,read_at:new Date().toISOString()}).eq("user_id",e).eq("is_read",!1);if(t)throw t}async searchMessages(e,t){let{data:a,error:s}=await this.supabase.from("messages").select(`
        *,
        sender:users(id, full_name, email, avatar_url)
      `).eq("conversation_id",e).eq("is_deleted",!1).ilike("content",`%${t}%`).order("created_at",{ascending:!1}).limit(50);if(s)throw s;return a}};e.s(["messagingService",0,a])},572997,e=>{"use strict";var t=e.i(843476),a=e.i(794008),s=e.i(473708),i=e.i(178583),r=e.i(440160),n=e.i(167881),l=e.i(647163),d=e.i(271645),o=e.i(920755);function u({attachments:e,className:u}){let[c,m]=(0,d.useState)({});return((0,d.useEffect)(()=>{let t=async()=>{let t=(0,o.createClient)(),a=e.map(async(e,a)=>{if(e.url)return{index:a,url:e.url};if(e.path)try{let{data:s,error:i}=await t.storage.from("messages").createSignedUrl(e.path,3600);if(i)return console.error("Erreur génération URL pièce jointe:",i),{index:a,url:null};return{index:a,url:s.signedUrl}}catch(e){console.error("Exception génération URL pièce jointe:",e)}return{index:a,url:null}}),s=await Promise.all(a),i={};s.forEach(({index:e,url:t})=>{t&&(i[e]=t)}),m(i)};e&&e.length>0&&t()},[e]),e&&0!==e.length)?(0,t.jsx)("div",{className:(0,l.cn)("space-y-2",u),children:e.map((e,l)=>{var d;return(0,t.jsxs)("div",{className:"flex items-center gap-3 p-3 border rounded-lg bg-background hover:bg-muted/50 transition-colors",children:[(0,t.jsx)("div",{className:"flex-shrink-0 w-10 h-10 rounded border flex items-center justify-center bg-muted",children:(d=e.type).startsWith("image/")?(0,t.jsx)(s.Image,{className:"h-4 w-4"}):"application/pdf"===d?(0,t.jsx)(i.FileText,{className:"h-4 w-4"}):(0,t.jsx)(a.File,{className:"h-4 w-4"})}),(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsx)("p",{className:"text-sm font-medium truncate",children:e.filename}),e.size&&(0,t.jsx)("p",{className:"text-xs text-muted-foreground",children:(e=>{if(!e)return"";if(0===e)return"0 Bytes";let t=Math.floor(Math.log(e)/Math.log(1024));return Math.round(e/Math.pow(1024,t)*100)/100+" "+["Bytes","KB","MB","GB"][t]})(e.size)})]}),(0,t.jsx)(n.Button,{variant:"ghost",size:"icon",className:"flex-shrink-0 h-8 w-8",onClick:()=>{let t;(t=c[l]||e.url)?window.open(t,"_blank"):console.error("URL non disponible pour la pièce jointe:",e)},title:"Télécharger",disabled:!c[l]&&!e.url,children:(0,t.jsx)(r.Download,{className:"h-4 w-4"})})]},l)})}):null}e.s(["MessageAttachmentViewer",()=>u])},794384,e=>{"use strict";var t=e.i(843476),a=e.i(618566),s=e.i(266027),i=e.i(954616),r=e.i(912598),n=e.i(383801),l=e.i(604667),d=e.i(167881),o=e.i(23750),u=e.i(871689),c=e.i(514764),m=e.i(629377),p=e.i(761911),_=e.i(284614),f=e.i(686311),h=e.i(727612),g=e.i(318216),y=e.i(271645),v=e.i(647163),w=e.i(267824),b=e.i(572997),x=e.i(463415);function j(){let e=(0,a.useParams)(),j=(0,a.useRouter)(),q=(0,n.useLearnerContext)(),S=(0,r.useQueryClient)(),N=e.id,k=q.studentId||localStorage.getItem("learner_student_id")||void 0;q.organizationId;let[C,M]=(0,y.useState)(""),I=(0,y.useRef)(null),E=k?(0,w.createLearnerClient)(k):null,{data:P,isLoading:z,error:A}=(0,s.useQuery)({queryKey:["learner-conversation",N,k],queryFn:async()=>{if(!k||!N||!E)return null;let{data:e,error:t}=await E.from("conversations").select("*").eq("id",N).maybeSingle();if(t||!e)throw t||Error("Conversation introuvable");let{data:a}=await E.from("conversation_participants").select("*").eq("conversation_id",N),s=await Promise.all((a||[]).map(async e=>{let t=null,a=null;if(e.user_id)try{let{data:a,error:s}=await E.rpc("get_user_name",{p_user_id:e.user_id});if(!s&&a)t=a;else{let{data:a,error:s}=await E.from("users").select("id, full_name, email, avatar_url").eq("id",e.user_id).maybeSingle();t=!s&&a?a:{id:e.user_id,full_name:null,email:null,avatar_url:null}}}catch(a){t={id:e.user_id,full_name:null,email:null,avatar_url:null}}if(e.student_id)try{let{data:t,error:s}=await E.from("students").select("id, first_name, last_name, email, student_number").eq("id",e.student_id).maybeSingle();!s&&t&&(a=t)}catch(e){}return{...e,user:t,student:a}}));return{...e,participants:s}},enabled:!!N&&!!k}),{data:$,isLoading:D}=(0,s.useQuery)({queryKey:["learner-messages",N,k],queryFn:async()=>{if(!k||!N||!E)return[];let{data:e,error:t}=await E.from("messages").select("*").eq("conversation_id",N).eq("is_deleted",!1).order("created_at",{ascending:!1}).limit(50);if(t)throw t;return e&&0!==e.length?(await Promise.all(e.map(async e=>{let t=null,a=null;if(e.sender_id)try{let{data:a,error:s}=await E.rpc("get_user_name",{p_user_id:e.sender_id});if(!s&&a)t=a;else{let{data:a,error:s}=await E.from("users").select("id, full_name, email, avatar_url").eq("id",e.sender_id).maybeSingle();t=!s&&a?a:{id:e.sender_id,full_name:null,email:null,avatar_url:null}}}catch(a){t={id:e.sender_id,full_name:null,email:null,avatar_url:null}}if(e.student_sender_id)try{let{data:t,error:s}=await E.from("students").select("id, first_name, last_name, email, student_number").eq("id",e.student_sender_id).maybeSingle();!s&&t&&(a=t)}catch(e){}return{...e,sender:t,student_sender:a}}))).reverse():[]},enabled:!!N&&!!k,refetchInterval:5e3}),B=(0,i.useMutation)({mutationFn:async e=>{if(!E)throw Error("Client Supabase non disponible");return l.messagingService.deleteMessage(e)},onSuccess:()=>{S.invalidateQueries({queryKey:["learner-messages",N]}),S.invalidateQueries({queryKey:["learner-conversations"]})},onError:e=>{alert(e instanceof Error?e.message:"Impossible de supprimer le message.")}}),L=(0,i.useMutation)({mutationFn:async e=>{if(!k||!N||!E)throw Error("Étudiant non identifié");let{data:t}=await E.from("students").select("id, email").eq("id",k).maybeSingle();if(!t)throw Error("Étudiant non trouvé");let{data:a,error:s}=await E.rpc("insert_student_message",{p_conversation_id:N,p_student_id:k,p_content:e.trim()});if(s)throw Error(s.message||"Erreur lors de l'envoi du message");if(!a)throw Error("Le message n'a pas pu être créé");return a},onSuccess:()=>{M(""),S.invalidateQueries({queryKey:["learner-messages",N]}),S.invalidateQueries({queryKey:["learner-conversations"]}),setTimeout(()=>{I.current?.scrollIntoView({behavior:"smooth"})},100)},onError:e=>{alert(e instanceof Error?e.message:"Une erreur est survenue lors de l'envoi du message.")}});(0,y.useEffect)(()=>{I.current?.scrollIntoView({behavior:"smooth"})},[$]);let R=P?.participants?.find(e=>e.student_id===k),U=P?(()=>{if(!P?.participants||0===P.participants.length)return null;if("group"===P.conversation_type&&P.name)return{name:P.name,type:"group",data:null};let e=P.participants.find(e=>!(e.student_id===k||R?.user_id&&e.user_id===R.user_id));if(e||(e=P.participants.find(e=>e.student_id!==k)),!e)return null;if(e.user_id){if(e.user){let t=e.user.full_name||e.user.email;if(t)return{name:t,type:"admin",data:e.user}}return{name:`Administrateur ${e.user_id.substring(0,8)}`,type:"admin",data:{id:e.user_id,full_name:null,email:null}}}if(e.student_id){if(e.student){let t=`${e.student.first_name||""} ${e.student.last_name||""}`.trim()||e.student.email||(e.student.student_number?`Candidat ${e.student.student_number}`:null);if(t)return{name:t,type:"student",data:e.student}}return{name:`Candidat ${e.student_id.substring(0,8)}`,type:"student",data:{id:e.student_id,first_name:null,last_name:null,email:null}}}return null})():null,[T,F]=(0,y.useState)(U);(0,y.useEffect)(()=>{(async()=>{if(U&&"admin"===U.type&&U.data?.id&&(!U.name||U.name.startsWith("Administrateur ")||U.name.startsWith("Utilisateur ")))try{if(!E)return;let{data:e,error:t}=await E.rpc("get_user_name",{p_user_id:U.data.id});if(!t&&e){let t=e.full_name||e.email;t&&F({...U,name:t,type:"admin",data:e})}}catch(e){}})()},[U,E]);let O=T||U;return z?(0,t.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,t.jsx)(m.Loader2,{className:"h-8 w-8 animate-spin text-muted-foreground"})}):A||!P?(0,t.jsxs)("div",{className:"container mx-auto py-8 px-4 max-w-7xl",children:[(0,t.jsxs)("div",{className:"flex items-center gap-4 mb-6",children:[(0,t.jsx)(d.Button,{variant:"ghost",size:"icon",onClick:()=>j.push("/learner/messages"),children:(0,t.jsx)(u.ArrowLeft,{className:"h-4 w-4"})}),(0,t.jsx)("h1",{className:"text-2xl font-bold",children:"Conversation introuvable"})]}),(0,t.jsx)("div",{className:"text-center py-8",children:(0,t.jsx)("p",{className:"text-muted-foreground",children:"Cette conversation n'existe pas ou vous n'avez pas la permission de la voir."})})]}):(0,t.jsxs)("div",{className:"flex flex-col h-[calc(100vh-4rem)]",children:[(0,t.jsx)("div",{className:"border-b bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60",children:(0,t.jsx)("div",{className:"container mx-auto px-4 py-4 max-w-7xl",children:(0,t.jsxs)("div",{className:"flex items-center gap-4",children:[(0,t.jsx)(d.Button,{variant:"ghost",size:"icon",onClick:()=>j.push("/learner/messages"),children:(0,t.jsx)(u.ArrowLeft,{className:"h-4 w-4"})}),(0,t.jsxs)("div",{className:"flex items-center gap-3 flex-1",children:[U?.type==="student"?(0,t.jsx)("div",{className:"h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center",children:(0,t.jsx)(_.User,{className:"h-5 w-5 text-primary"})}):(0,t.jsx)("div",{className:"h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center",children:(0,t.jsx)(p.Users,{className:"h-5 w-5 text-primary"})}),(0,t.jsxs)("div",{children:[(0,t.jsx)("h1",{className:"text-lg font-semibold",children:O?.name||"group"===P.conversation_type&&P.name||"Conversation"}),"group"===P.conversation_type&&P.name&&O?.name!==P.name&&(0,t.jsx)("p",{className:"text-sm text-muted-foreground",children:P.name})]})]})]})})}),(0,t.jsx)("div",{className:"flex-1 overflow-y-auto container mx-auto px-4 py-6 max-w-7xl",children:D?(0,t.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,t.jsx)(m.Loader2,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):$&&$.length>0?(0,t.jsxs)("div",{className:"space-y-4",children:[$.map(e=>{let a=P.participants?.find(e=>e.student_id===k),s=a?.user_id===e.sender_id||e.student_sender_id===k,i=null;if(e.sender&&(i=e.sender.full_name||e.sender.email||null),!i&&e.student_sender&&(i=`${e.student_sender.first_name||""} ${e.student_sender.last_name||""}`.trim()||e.student_sender.email||(e.student_sender.student_number?`Candidat ${e.student_sender.student_number}`:null)),!i&&!s&&P.participants){if(e.sender_id){let t=P.participants.find(t=>t.user_id===e.sender_id);t?.user&&(i=t.user.full_name||t.user.email||null)}if(!i&&e.student_sender_id){let t=P.participants.find(t=>t.student_id===e.student_sender_id);t?.student&&(i=`${t.student.first_name||""} ${t.student.last_name||""}`.trim()||t.student.email||(t.student.student_number?`Candidat ${t.student.student_number}`:null))}}return!i&&!s&&O?.name&&(i=O.name),(0,t.jsxs)("div",{className:`flex items-start gap-2 ${s?"justify-end":"justify-start"}`,children:[!s&&(0,t.jsx)("div",{className:"w-8"}),(0,t.jsxs)("div",{className:"group relative flex items-start gap-2",children:[(0,t.jsxs)("div",{className:`max-w-[70%] rounded-lg px-4 py-2 ${s?"bg-primary text-primary-foreground":"bg-muted"}`,children:[!s&&i&&(0,t.jsx)("p",{className:"text-xs font-medium mb-1 opacity-80",children:i}),e.attachments&&Array.isArray(e.attachments)&&e.attachments.length>0&&(0,t.jsx)("div",{className:"mb-2",children:(0,t.jsx)(b.MessageAttachmentViewer,{attachments:e.attachments})}),(0,t.jsx)("p",{className:"text-sm whitespace-pre-wrap",children:e.content}),(0,t.jsx)("p",{className:`text-xs mt-1 ${s?"text-primary-foreground/70":"text-muted-foreground"}`,children:(0,v.formatRelativeTime)(e.created_at)})]}),s&&(0,t.jsxs)(x.DropdownMenu,{children:[(0,t.jsx)(x.DropdownMenuTrigger,{asChild:!0,children:(0,t.jsx)(d.Button,{variant:"ghost",size:"icon",className:"h-6 w-6 opacity-0 group-hover:opacity-100 transition-opacity",onClick:e=>e.stopPropagation(),children:(0,t.jsx)(g.MoreVertical,{className:"h-3 w-3"})})}),(0,t.jsx)(x.DropdownMenuContent,{align:"end",children:(0,t.jsxs)(x.DropdownMenuItem,{onClick:t=>{t.preventDefault(),t.stopPropagation(),confirm("Êtes-vous sûr de vouloir supprimer ce message ?")&&B.mutate(e.id)},disabled:B.isPending,className:"text-destructive focus:text-destructive",children:[(0,t.jsx)(h.Trash2,{className:"mr-2 h-4 w-4"}),"Supprimer"]})})]})]}),s&&(0,t.jsx)("div",{className:"w-8"})]},e.id)}),(0,t.jsx)("div",{ref:I})]}):(0,t.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)(f.MessageSquare,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),(0,t.jsx)("p",{className:"text-muted-foreground",children:"Aucun message pour le moment"}),(0,t.jsx)("p",{className:"text-sm text-muted-foreground mt-2",children:"Commencez la conversation en envoyant un message"})]})})}),(0,t.jsx)("div",{className:"border-t bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60",children:(0,t.jsx)("div",{className:"container mx-auto px-4 py-4 max-w-7xl",children:(0,t.jsxs)("form",{onSubmit:e=>{e.preventDefault(),C.trim()&&!L.isPending&&L.mutate(C.trim())},className:"flex gap-2",children:[(0,t.jsx)(o.Input,{value:C,onChange:e=>M(e.target.value),placeholder:"Tapez votre message...",disabled:L.isPending,className:"flex-1"}),(0,t.jsx)(d.Button,{type:"submit",disabled:!C.trim()||L.isPending,size:"icon",children:L.isPending?(0,t.jsx)(m.Loader2,{className:"h-4 w-4 animate-spin"}):(0,t.jsx)(c.Send,{className:"h-4 w-4"})})]})})})]})}e.s(["default",()=>j])}]);